<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="keywords" content="Hexo Theme Redefine">
    
    <meta name="author" content="MinGe">
    <!-- preconnect -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    
    <!--- Seo Part-->
    
    <link rel="canonical" href="http://example.com/2024/03/10/springcloud/"/>
    <meta name="robots" content="index,follow">
    <meta name="googlebot" content="index,follow">
    <meta name="revisit-after" content="1 days">
    
        <meta name="description" content="一、什么是微服务？1.1 系统架构的演变过程随着互联网的不断发展，网站应用的规模不断扩大，系统架构也因此也不断的演进、升级、迭代。从互联网早期到现在，系统架构大体经历了下面几个过程：  1）单体应用架构 2）垂直应用架构 3）分布式架构 4）SOA架构 5）微服务架构  1.1.1 单体应用架构单体应用架构也叫集中式架构，在单体应用架构中，系统将所有的功能包括前端、后端等全部打包在一起部署，所有的">
<meta property="og:type" content="article">
<meta property="og:title" content="SpringCloud">
<meta property="og:url" content="http://example.com/2024/03/10/SpringCloud/index.html">
<meta property="og:site_name" content="MinGe">
<meta property="og:description" content="一、什么是微服务？1.1 系统架构的演变过程随着互联网的不断发展，网站应用的规模不断扩大，系统架构也因此也不断的演进、升级、迭代。从互联网早期到现在，系统架构大体经历了下面几个过程：  1）单体应用架构 2）垂直应用架构 3）分布式架构 4）SOA架构 5）微服务架构  1.1.1 单体应用架构单体应用架构也叫集中式架构，在单体应用架构中，系统将所有的功能包括前端、后端等全部打包在一起部署，所有的">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://example.com/images/springcloud/200.png">
<meta property="og:image" content="http://example.com/images/springcloud/199.png">
<meta property="og:image" content="http://example.com/images/springcloud/198.png">
<meta property="og:image" content="http://example.com/images/springcloud/197.png">
<meta property="og:image" content="http://example.com/images/springcloud/196.png">
<meta property="og:image" content="http://example.com/images/springcloud/193.png">
<meta property="og:image" content="http://example.com/images/springcloud/192.png">
<meta property="og:image" content="http://example.com/images/springcloud/191.png">
<meta property="og:image" content="http://example.com/images/springcloud/190.png">
<meta property="og:image" content="http://example.com/images/springcloud/189.png">
<meta property="og:image" content="http://example.com/images/springcloud/195.png">
<meta property="og:image" content="http://example.com/images/springcloud/194.png">
<meta property="og:image" content="http://example.com/images/springcloud/188.png">
<meta property="og:image" content="http://example.com/images/springcloud/187.png">
<meta property="og:image" content="http://example.com/images/springcloud/186.png">
<meta property="og:image" content="http://example.com/images/springcloud/185.png">
<meta property="og:image" content="http://example.com/images/springcloud/184.png">
<meta property="og:image" content="http://example.com/images/springcloud/183.png">
<meta property="og:image" content="http://example.com/images/springcloud/182.png">
<meta property="og:image" content="http://example.com/images/springcloud/181.png">
<meta property="og:image" content="http://example.com/images/springcloud/180.png">
<meta property="og:image" content="http://example.com/images/springcloud/179.png">
<meta property="og:image" content="http://example.com/images/springcloud/178.png">
<meta property="og:image" content="http://example.com/images/springcloud/177.png">
<meta property="og:image" content="http://example.com/images/springcloud/176.png">
<meta property="og:image" content="http://example.com/images/springcloud/175.png">
<meta property="og:image" content="http://example.com/images/springcloud/174.png">
<meta property="og:image" content="http://example.com/images/springcloud/173.png">
<meta property="og:image" content="http://example.com/images/springcloud/172.png">
<meta property="og:image" content="http://example.com/images/springcloud/171.png">
<meta property="og:image" content="http://example.com/images/springcloud/170.png">
<meta property="og:image" content="http://example.com/images/springcloud/169.png">
<meta property="og:image" content="http://example.com/images/springcloud/168.png">
<meta property="og:image" content="http://example.com/images/springcloud/167.png">
<meta property="og:image" content="http://example.com/images/springcloud/166.png">
<meta property="og:image" content="http://example.com/images/springcloud/165.png">
<meta property="og:image" content="http://example.com/images/springcloud/164.png">
<meta property="og:image" content="http://example.com/images/springcloud/163.png">
<meta property="og:image" content="http://example.com/images/springcloud/134.png">
<meta property="og:image" content="http://example.com/images/springcloud/162.png">
<meta property="og:image" content="http://example.com/images/springcloud/161.png">
<meta property="og:image" content="http://example.com/images/springcloud/160.png">
<meta property="og:image" content="http://example.com/images/springcloud/157.png">
<meta property="og:image" content="http://example.com/images/springcloud/159.png">
<meta property="og:image" content="http://example.com/images/springcloud/158.png">
<meta property="og:image" content="http://example.com/images/springcloud/156.png">
<meta property="og:image" content="http://example.com/images/springcloud/155.png">
<meta property="og:image" content="http://example.com/images/springcloud/154.png">
<meta property="og:image" content="http://example.com/images/springcloud/153.png">
<meta property="og:image" content="http://example.com/images/springcloud/152.png">
<meta property="og:image" content="http://example.com/images/springcloud/151.png">
<meta property="og:image" content="http://example.com/images/springcloud/150.png">
<meta property="og:image" content="http://example.com/images/springcloud/149.png">
<meta property="og:image" content="http://example.com/images/springcloud/148.png">
<meta property="og:image" content="http://example.com/images/springcloud/147.png">
<meta property="og:image" content="http://example.com/images/springcloud/146.png">
<meta property="og:image" content="http://example.com/images/springcloud/145.png">
<meta property="og:image" content="http://example.com/images/springcloud/144.png">
<meta property="og:image" content="http://example.com/images/springcloud/135.png">
<meta property="og:image" content="http://example.com/images/springcloud/143.png">
<meta property="og:image" content="http://example.com/images/springcloud/142.png">
<meta property="og:image" content="http://example.com/images/springcloud/141.png">
<meta property="og:image" content="http://example.com/images/springcloud/136.png">
<meta property="og:image" content="http://example.com/images/springcloud/140.png">
<meta property="og:image" content="http://example.com/images/springcloud/139.png">
<meta property="og:image" content="http://example.com/images/springcloud/138.png">
<meta property="og:image" content="http://example.com/images/springcloud/133.png">
<meta property="og:image" content="http://example.com/images/springcloud/121.png">
<meta property="og:image" content="http://example.com/images/springcloud/120.png">
<meta property="og:image" content="http://example.com/images/springcloud/132.png">
<meta property="og:image" content="http://example.com/images/springcloud/131.png">
<meta property="og:image" content="http://example.com/images/springcloud/130.png">
<meta property="og:image" content="http://example.com/images/springcloud/128.png">
<meta property="og:image" content="http://example.com/images/springcloud/127.png">
<meta property="og:image" content="http://example.com/images/springcloud/129.png">
<meta property="og:image" content="http://example.com/images/springcloud/126.png">
<meta property="og:image" content="http://example.com/images/springcloud/125.png">
<meta property="og:image" content="http://example.com/images/springcloud/124.png">
<meta property="og:image" content="http://example.com/images/springcloud/123.png">
<meta property="og:image" content="http://example.com/images/springcloud/122.png">
<meta property="og:image" content="http://example.com/images/springcloud/119.png">
<meta property="article:published_time" content="2024-03-10T07:00:00.000Z">
<meta property="article:modified_time" content="2024-11-12T09:00:28.012Z">
<meta property="article:author" content="John Doe">
<meta property="article:tag" content="java">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/images/springcloud/200.png">
    
    
    <!--- Icon Part-->
    <link rel="icon" type="image/png" href="/images/redefine-favicon.svg" sizes="192x192">
    <link rel="apple-touch-icon" sizes="180x180" href="/images/redefine-favicon.svg">
    <meta name="theme-color" content="#A31F34">
    <link rel="shortcut icon" href="/images/redefine-favicon.svg">
    <!--- Page Info-->
    
    <title>
        
            SpringCloud -
        
        MinGe 博客
    </title>

    
<link rel="stylesheet" href="/fonts/Chillax/chillax.css">


    <!--- Inject Part-->
    

    
<link rel="stylesheet" href="/css/style.css">


    
        
<link rel="stylesheet" href="/assets/build/styles.css">

    

    
<link rel="stylesheet" href="/fonts/GeistMono/geist-mono.css">

    
<link rel="stylesheet" href="/fonts/Geist/geist.css">

    <!--- Font Part-->
    
    
    
    
    
    

    <script id="hexo-configurations">
    window.config = {"hostname":"example.com","root":"/","language":"en"};
    window.theme = {"articles":{"style":{"font_size":"16px","line_height":1.5,"image_border_radius":"14px","image_alignment":"center","image_caption":false,"link_icon":true,"title_alignment":"left","headings_top_spacing":{"h1":"3.2rem","h2":"2.4rem","h3":"1.9rem","h4":"1.6rem","h5":"1.4rem","h6":"1.3rem"}},"word_count":{"enable":true,"count":true,"min2read":true},"author_label":{"enable":true,"auto":false,"list":[]},"code_block":{"copy":true,"style":"mac","highlight_theme":{"light":"github","dark":"vs2015"},"font":{"enable":false,"family":null,"url":null}},"toc":{"enable":true,"max_depth":1,"number":false,"expand":false,"init_open":true},"copyright":{"enable":true,"default":"cc_by_nc_sa"},"lazyload":true,"recommendation":{"enable":false,"title":"推荐阅读","limit":3,"mobile_limit":2,"placeholder":"/images/wallhaven-wqery6-light.webp","skip_dirs":[]}},"colors":{"primary":"#A31F34","secondary":null,"default_mode":"dark"},"global":{"fonts":{"chinese":{"enable":false,"family":null,"url":null},"english":{"enable":false,"family":null,"url":null},"title":{"enable":false,"family":null,"url":null}},"content_max_width":"1000px","sidebar_width":"210px","hover":{"shadow":true,"scale":false},"scroll_progress":{"bar":false,"percentage":true},"website_counter":{"url":"https://cn.vercount.one/js","enable":false,"site_pv":true,"site_uv":true,"post_pv":true},"single_page":true,"preloader":{"enable":false,"custom_message":null},"open_graph":true,"google_analytics":{"enable":false,"id":null}},"home_banner":{"enable":true,"style":"fixed","image":{"light":"/images/wallhaven-wqery6-light.webp","dark":"/images/wallhaven-wqery6-dark.webp"},"title":"MinGe 博客","subtitle":{"text":[],"hitokoto":{"enable":false,"show_author":false,"api":"https://v1.hitokoto.cn"},"typing_speed":100,"backing_speed":80,"starting_delay":500,"backing_delay":1500,"loop":true,"smart_backspace":true},"text_color":{"light":"#fff","dark":"#d1d1b6"},"text_style":{"title_size":"2.8rem","subtitle_size":"1.5rem","line_height":1.2},"custom_font":{"enable":false,"family":null,"url":null},"social_links":{"enable":false,"style":"default","links":{"github":null,"instagram":null,"zhihu":null,"twitter":null,"email":null},"qrs":{"weixin":null}}},"plugins":{"feed":{"enable":false},"aplayer":{"enable":false,"type":"fixed","audios":[{"name":null,"artist":null,"url":null,"cover":null,"lrc":null}]},"mermaid":{"enable":false,"version":"9.3.0"}},"version":"2.7.1","navbar":{"auto_hide":false,"color":{"left":"#f78736","right":"#367df7","transparency":35},"width":{"home":"1200px","pages":"1000px"},"links":{"Home":{"path":"/","icon":"fa-regular fa-house"},"resume":{"path":"/2024/11/02/简历/","icon":"fa-regular fa-folder"}},"search":{"enable":false,"preload":true}},"page_templates":{"friends_column":2,"tags_style":"blur"},"home":{"sidebar":{"enable":true,"position":"left","first_item":"menu","announcement":null,"show_on_mobile":true,"links":{"Archives":{"path":"/archives","icon":"fa-regular fa-archive"},"Tags":{"path":"/tags","icon":"fa-regular fa-tags"},"Categories":{"path":"/categories","icon":"fa-regular fa-folder"}}},"article_date_format":"auto","excerpt_length":200,"categories":{"enable":true,"limit":3},"tags":{"enable":true,"limit":3}},"footerStart":"2022/09/25 08:00:00"};
    window.lang_ago = {"second":"%s seconds ago","minute":"%s minutes ago","hour":"%s hours ago","day":"%s days ago","week":"%s weeks ago","month":"%s months ago","year":"%s years ago"};
    window.data = {"masonry":false};
  </script>
    
    <!--- Fontawesome Part-->
    
<link rel="stylesheet" href="/fontawesome/fontawesome.min.css">

    
<link rel="stylesheet" href="/fontawesome/brands.min.css">

    
<link rel="stylesheet" href="/fontawesome/solid.min.css">

    
<link rel="stylesheet" href="/fontawesome/regular.min.css">

    
    
    
    
<meta name="generator" content="Hexo 7.3.0"></head>


<body>
<div class="progress-bar-container">
    

    
        <span class="pjax-progress-bar"></span>
<!--        <span class="swup-progress-icon">-->
<!--            <i class="fa-solid fa-circle-notch fa-spin"></i>-->
<!--        </span>-->
    
</div>



<main class="page-container" id="swup">

    

    <div class="main-content-container">


        <div class="main-content-header">
            <header class="navbar-container px-6 md:px-12">

    <div class="navbar-content ">
        <div class="left">
            
            <a class="logo-title" href="/">
                
                MinGe 博客
                
            </a>
        </div>

        <div class="right">
            <!-- PC -->
            <div class="desktop">
                <ul class="navbar-list">
                    
                        
                            

                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class=""
                                   href="/"
                                        >
                                    <i class="fa-regular fa-house fa-fw"></i>
                                    HOME
                                    
                                </a>

                                <!-- Submenu -->
                                
                            </li>
                    
                        
                            

                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class=""
                                   href="/2024/11/02/%E7%AE%80%E5%8E%86/"
                                        >
                                    <i class="fa-regular fa-folder fa-fw"></i>
                                    RESUME
                                    
                                </a>

                                <!-- Submenu -->
                                
                            </li>
                    
                    
                </ul>
            </div>
            <!-- Mobile -->
            <div class="mobile">
                
                <div class="icon-item navbar-bar">
                    <div class="navbar-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile sheet -->
    <div class="navbar-drawer h-screen w-full absolute top-0 left-0 bg-background-color flex flex-col justify-between">
        <ul class="drawer-navbar-list flex flex-col px-4 justify-center items-start">
            
                
                    

                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full "
                           href="/"
                        >
                            <span>
                                HOME
                            </span>
                            
                                <i class="fa-regular fa-house fa-sm fa-fw"></i>
                            
                        </a>
                        

                        
                    </li>
            
                
                    

                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full "
                           href="/2024/11/02/%E7%AE%80%E5%8E%86/"
                        >
                            <span>
                                RESUME
                            </span>
                            
                                <i class="fa-regular fa-folder fa-sm fa-fw"></i>
                            
                        </a>
                        

                        
                    </li>
            

            
            
                
                    
                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full active"
                           href="/archives"
                        >
                            <span>Archives</span>
                            <i class="fa-regular fa-archive fa-sm fa-fw"></i>
                        </a>
                    </li>
                
                    
                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full active"
                           href="/tags"
                        >
                            <span>Tags</span>
                            <i class="fa-regular fa-tags fa-sm fa-fw"></i>
                        </a>
                    </li>
                
                    
                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full active"
                           href="/categories"
                        >
                            <span>Categories</span>
                            <i class="fa-regular fa-folder fa-sm fa-fw"></i>
                        </a>
                    </li>
                
            
        </ul>

        <div class="statistics flex justify-around my-2.5">
    <a class="item tag-count-item flex flex-col justify-center items-center w-20" href="/tags">
        <div class="number text-2xl sm:text-xl text-second-text-color font-semibold">3</div>
        <div class="label text-third-text-color text-sm">Tags</div>
    </a>
    <a class="item tag-count-item flex flex-col justify-center items-center w-20" href="/categories">
        <div class="number text-2xl sm:text-xl text-second-text-color font-semibold">2</div>
        <div class="label text-third-text-color text-sm">Categories</div>
    </a>
    <a class="item tag-count-item flex flex-col justify-center items-center w-20" href="/archives">
        <div class="number text-2xl sm:text-xl text-second-text-color font-semibold">20</div>
        <div class="label text-third-text-color text-sm">Posts</div>
    </a>
</div>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="main-content-body">

            

            <div class="main-content">

                
                    <div class="post-page-container flex relative justify-between box-border w-full h-full">
    <div class="article-content-container">

        <div class="article-title relative w-full">
            
                <div class="w-full flex items-center pt-6 justify-start">
                    <h1 class="article-title-regular text-second-text-color tracking-tight text-4xl md:text-6xl font-semibold px-2 sm:px-6 md:px-8 py-3">SpringCloud</h1>
                </div>
            
            </div>

        
            <div class="article-header flex flex-row gap-2 items-center px-2 sm:px-6 md:px-8">
                <div class="avatar w-[46px] h-[46px] flex-shrink-0 rounded-medium border border-border-color p-[1px]">
                    <img src="/images/redefine-avatar.svg">
                </div>
                <div class="info flex flex-col justify-between">
                    <div class="author flex items-center">
                        <span class="name text-default-text-color text-lg font-semibold">MinGe</span>
                        
                            <span class="author-label ml-1.5 text-xs px-2 py-0.5 rounded-small text-third-text-color border border-shadow-color-1">Lv3</span>
                        
                    </div>
                    <div class="meta-info">
                        <div class="article-meta-info">
    <span class="article-date article-meta-item">
        <i class="fa-regular fa-pen-fancy"></i>&nbsp;
        <span class="desktop">2024-03-10 15:00</span>
        <span class="mobile">2024-03-10 15:00</span>
        <span class="hover-info">Created</span>
    </span>
    
        <span class="article-date article-meta-item">
            <i class="fa-regular fa-wrench"></i>&nbsp;
            <span class="desktop">2024-11-12 17:28</span>
            <span class="mobile">2024-11-12 17:28</span>
            <span class="hover-info">Updated</span>
        </span>
    

    
        <span class="article-categories article-meta-item">
            <i class="fa-regular fa-folders"></i>&nbsp;
            <ul>
                
                
                    
                        
                        <li>
                            <a href="/categories/%E6%8A%80%E6%9C%AF/">技术</a>&nbsp;
                        </li>
                    
                    
                
            </ul>
        </span>
    
    
        <span class="article-tags article-meta-item">
            <i class="fa-regular fa-tags"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/tags/java/">java</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    

    
    
    
    
</div>

                    </div>
                </div>
            </div>
        

        


        <div class="article-content markdown-body px-2 sm:px-6 md:px-8 pb-8">
            <h1 id="一、什么是微服务？"><a href="#一、什么是微服务？" class="headerlink" title="一、什么是微服务？"></a>一、什么是微服务？</h1><h2 id="1-1-系统架构的演变过程"><a href="#1-1-系统架构的演变过程" class="headerlink" title="1.1 系统架构的演变过程"></a>1.1 系统架构的演变过程</h2><p>随着互联网的不断发展，网站应用的规模不断扩大，系统架构也因此也不断的演进、升级、迭代。从互联网早期到现在，系统架构大体经历了下面几个过程：</p>
<ul>
<li><strong>1）单体应用架构</strong></li>
<li><strong>2）垂直应用架构</strong></li>
<li><strong>3）分布式架构</strong></li>
<li><strong>4）SOA架构</strong></li>
<li><strong>5）微服务架构</strong></li>
</ul>
<h3 id="1-1-1-单体应用架构"><a href="#1-1-1-单体应用架构" class="headerlink" title="1.1.1 单体应用架构"></a>1.1.1 单体应用架构</h3><p>单体应用架构也叫<strong>集中式架构</strong>，在单体应用架构中，系统将所有的功能包括前端、后端等全部打包在一起部署，所有的代码都写在一起，通常也是交由一个小的技术团队开发；</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/springcloud/200.png"
                      alt="img"
                ></p>
<p>优点：</p>
<ul>
<li>项目架构简单，开发成本低</li>
<li>项目部署在一个节点上， 维护方便</li>
</ul>
<p>缺点：</p>
<ul>
<li>代码耦合度太高，开发维护困难</li>
<li>无法针对不同模块进行针对性优化</li>
<li>系统容错率低，如果该系统一个模块出现不可用会导致整个系统无法使用。</li>
</ul>
<h3 id="1-1-2-垂直应用架构"><a href="#1-1-2-垂直应用架构" class="headerlink" title="1.1.2 垂直应用架构"></a>1.1.2 垂直应用架构</h3><p>当访问量逐渐增大，单一应用无法满足需求，我们就需要增加节点来提供系统的访问能力，<strong>但是并不是所有的模块都需要进行性能的提高</strong>，这时候单体应用架构无法满足我们的需求；</p>
<p>我们需要将系统里面的模块进行拆分，这样对于后面的水平扩容是非常友好的；</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/springcloud/199.png"
                      alt="img"
                ></p>
<p>优点：</p>
<ul>
<li>系统拆分实现了流量分担，提高了系统并发量</li>
<li>垂直架构中可以针对不同模块进行针对性优化</li>
<li>方便水平扩展，负载均衡，系统容错率提高</li>
</ul>
<p>缺点：</p>
<ul>
<li>系统间相互独立，会有很多重复开发工作，影响开发效率</li>
<li>系统间相互独立，无法进行系统数据共享（互相调用）</li>
</ul>
<h3 id="1-1-3-分布式架构"><a href="#1-1-3-分布式架构" class="headerlink" title="1.1.3 分布式架构"></a>1.1.3 分布式架构</h3><p>当垂直应用越来越多，重复的业务代码就会越来越多，并且在垂直架构中应用之间的交互不可避免，此时，为了解决基础代码重复太多、应用之间的调用等问题；我们将重复的代码抽取出来作为独立的服务，对外提供服务；</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/springcloud/198.png"
                      alt="img"
                ></p>
<p>优点：</p>
<ul>
<li>将基础服务进行了抽取，系统间相互调用，提高了代码复用和开发效率</li>
</ul>
<p>缺点：</p>
<ul>
<li>系统间耦合度变高，<strong>调用关系错综复杂</strong>，难以维护</li>
</ul>
<h3 id="1-1-4-SOA架构"><a href="#1-1-4-SOA架构" class="headerlink" title="1.1.4 SOA架构"></a>1.1.4 SOA架构</h3><p>在分布式架构下，当服务越来越多，容量的评估，小服务资源等浪费等问题逐渐显现，此时需增加一个调度中心对集群进行实时管理集群容量</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/springcloud/197.png"
                      alt="img"
                ></p>
<p>服务治理要做什么？（优点）</p>
<ul>
<li>服务注册中心，实现服务自动注册和发现，无需人为记录服务地址</li>
<li>动态监控服务状态监控报告，人为控制服务状态</li>
<li>服务负载均衡、服务熔断保护、服务健康检测、服务注册与发现、服务缓存等…..</li>
</ul>
<p>缺点：</p>
<ul>
<li>服务关系复杂，运维、测试部署困难</li>
</ul>
<h3 id="1-1-5-微服务架构"><a href="#1-1-5-微服务架构" class="headerlink" title="1.1.5 微服务架构"></a>1.1.5 微服务架构</h3><p>微服务架构模式是从SOA架构模式演变过来， 比SOA架构模式粒度更加精细，让专业的人去做专业的事情（专注），目的是提高效率，每个服务与服务之间互不影响，微服务架构中每个服务独立，互不影响；</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/springcloud/196.png"
                      alt="img"
                ></p>
<p>微服务的特点：</p>
<ul>
<li>&#x3D;&#x3D;<strong>单一职责</strong>&#x3D;&#x3D;：微服务中每一个服务都对应唯一的业务能力，做到单一职责</li>
<li>&#x3D;&#x3D;<strong>微</strong>&#x3D;&#x3D;：微服务的服务拆分粒度很小，例如一个用户管理就可以作为一个服务。每个服务虽小，但“五脏俱全”。</li>
<li>&#x3D;&#x3D;<strong>面向服务</strong>&#x3D;&#x3D;：面向服务是说每个服务都要对外暴露服务接口API。并不关心服务的技术实现，做到与平台和语言无关，也不限定用什么技术实现，只要提供Rest的接口即可。</li>
<li>&#x3D;&#x3D;<strong>自治</strong>&#x3D;&#x3D;：自治是说服务间互相独立，互不干扰<ul>
<li>团队独立：每个服务都是一个独立的开发团队。</li>
<li>技术独立：因为是面向服务，提供Rest接口，使用什么技术没有别人干涉</li>
<li>前后端分离：采用前后端分离开发，提供统一Rest接口，后端不用再为PC、移动段开发不同接口</li>
<li>数据库分离：每个服务都使用自己的数据源</li>
<li>部署独立，服务间虽然有调用，但要做到服务重启不影响其它服务。有利于持续集成和持续交付。每个服务都是独立的组件，可复用，可替换，降低耦合，易维护</li>
</ul>
</li>
</ul>
<h2 id="1-2-微服务架构设计原则"><a href="#1-2-微服务架构设计原则" class="headerlink" title="1.2 微服务架构设计原则"></a>1.2 微服务架构设计原则</h2><p>微服务是一种架构风格。一个大型的复杂软件应用，由一个或多个微服务组成。系统中的各个微服务可被独立部署，各个微服务之间是松耦合的。每个微服务仅关注于完成一件任务并很好的完成该任务。那么关于微服务的设计原则有哪些呢？</p>
<ul>
<li>AKF拆分原则</li>
<li>前后端分离原则</li>
<li>无状态服务</li>
<li>RestFul 的通信风格</li>
</ul>
<h3 id="1-2-1-AKF拆分原则"><a href="#1-2-1-AKF拆分原则" class="headerlink" title="1.2.1 AKF拆分原则"></a>1.2.1 AKF拆分原则</h3><p>随着互联网的高速发展，性能越来越成为我们瞩目的焦点，那么如何去提升我们服务器的性能呢？相信最简单和最直接的方法就是：加机器！如果一台不行就两台，两台不行就三台…..</p>
<p>如何加机器？加在什么地方最有效？怎样的软件架构加机器才最有效成为我们考虑的重点；</p>
<p>对此，《可扩展的艺术》一书提出了一个更加系统的可扩展模型—— AKF  可扩展立方（Scalability Cube）。这个立方体中沿着三个坐标轴设置分别为：X、Y、Z。</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/springcloud/193.png"
                      alt="img"
                ></p>
<blockquote>
<p>AKF公司的技术专家们从<code>X/Y/Z</code>三个维度来对应用进行扩展。理论上可以将一个单一系统进行无线的延伸扩展；</p>
</blockquote>
<h4 id="1-2-1-1-X轴扩展（水平复制）"><a href="#1-2-1-1-X轴扩展（水平复制）" class="headerlink" title="1.2.1.1 X轴扩展（水平复制）"></a>1.2.1.1 X轴扩展（水平复制）</h4><p>X轴扩展就是我们平时说的&#x3D;&#x3D;水平扩容&#x3D;&#x3D;，一台机器不行就两台，两台不行就三台…..简单来说就是搭建集群，使用Nginx等工具做到负载均衡，让多台机器一起工作来提升项目的整体性能；</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/springcloud/192.png"
                      alt="img"
                ></p>
<h4 id="1-2-1-2-Y轴扩展（模块拆分）"><a href="#1-2-1-2-Y轴扩展（模块拆分）" class="headerlink" title="1.2.1.2 Y轴扩展（模块拆分）"></a>1.2.1.2 Y轴扩展（模块拆分）</h4><p>Y轴扩展就是基于微服务架构的&#x3D;&#x3D;模块拆分&#x3D;&#x3D;，将一个庞大的项目拆分成若干个小模块，这些小模块分别独立部署在不同的机器，组成了一个完整的项目；</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/springcloud/191.png"
                      alt="img"
                ></p>
<h4 id="1-2-1-3-Z轴扩展（数据分区）"><a href="#1-2-1-3-Z轴扩展（数据分区）" class="headerlink" title="1.2.1.3 Z轴扩展（数据分区）"></a>1.2.1.3 Z轴扩展（数据分区）</h4><p>Z轴扩展是基于数据的分区，比如我们之前学的MySQL数据拆分，ES的shard分片等都是基于数据的拆分，这些不同的数据分区独立部署不同的机器中，以提升这部分数据访问的能力；一般数据划分的方式有：</p>
<ul>
<li>1）根据数据类型进行分区（根据不同的业务拆分不同的数据库）</li>
<li>2）根据数据的活跃程度进行分区（冷热分离）</li>
<li>3）根据时间段进行分区（日志时间段）</li>
<li>4）根据读写进行分区（读写分离）</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/springcloud/190.png"
                      alt="img"
                ></p>
<h3 id="1-2-2-前后端分离原则"><a href="#1-2-2-前后端分离原则" class="headerlink" title="1.2.2 前后端分离原则"></a>1.2.2 前后端分离原则</h3><p>前后端分离原则简单的来说就是：前端负责前端的事情，后端负责后端的业务模块，前后端不再耦合在一起，分工明确；</p>
<p>前后端分离带来的优点有：</p>
<ul>
<li>1）可以由各自的专家来对各自的领域进行优化</li>
<li>2）前后端交互界面更清晰，就剩下了接口模型，后端的接口简洁明了，更容易维护。</li>
<li>3）前后端采用统一的数据和模型，可以支持多个前端：例如：微信 h5 前端、PC 前端、安卓前端、IOS 前端。</li>
<li>4）职责更加清晰明确，前后端不再耦合，开发效率高；</li>
</ul>
<h3 id="1-2-3-无状态服务"><a href="#1-2-3-无状态服务" class="headerlink" title="1.2.3 无状态服务"></a>1.2.3 无状态服务</h3><p>无状态服务与有状态服务主要是根据：&#x3D;&#x3D;<strong>两个来自相同发起者的请求在服务器端是否具备上下文关系</strong>&#x3D;&#x3D;</p>
<h4 id="1-2-3-1-状态化请求"><a href="#1-2-3-1-状态化请求" class="headerlink" title="1.2.3.1 状态化请求"></a>1.2.3.1 状态化请求</h4><blockquote>
<p>服务器端一般都要保存请求的相关信息，才能分辨请求是否是同一个；</p>
</blockquote>
<p>例如Cookie认证操作，客户端请求来到后端时查询Session，如果保存了用户的信息那么就认证通过，如果没有保存用户的信息，那么就认证不通过，这就是一个典型的&#x3D;&#x3D;有状态服务&#x3D;&#x3D;；</p>
<h4 id="1-2-3-2-无状态请求"><a href="#1-2-3-2-无状态请求" class="headerlink" title="1.2.3.2 无状态请求"></a>1.2.3.2 无状态请求</h4><blockquote>
<p>服务器端所能够处理的过程必须全部来自于请求所携带的信息，以及其他服务器端自身所保存的、并且可以被所有请求所使用的公共信息；</p>
</blockquote>
<p>例如Token认证，客户端发送请求携带Token来到后端服务，后端服务通过前端携带的Token来进行认证，如果换了台服务器依旧可以进行认证操作，此时就是&#x3D;&#x3D;有状态服务&#x3D;&#x3D;；</p>
<h4 id="1-2-3-3-HTTP是无状态的"><a href="#1-2-3-3-HTTP是无状态的" class="headerlink" title="1.2.3.3 HTTP是无状态的"></a>1.2.3.3 HTTP是无状态的</h4><p>由于HTTP协议本身就是无状态的，所以为了实现有状态服务（例如上面的Cookie认证），就需要通过一些额外的方案。比如最常见的session，将用户登录的信息保存到session中，当进行认证的时候，再从session中取出用户信息，进行认证； </p>
<h4 id="1-2-3-4-无状态服务带来的好处"><a href="#1-2-3-4-无状态服务带来的好处" class="headerlink" title="1.2.3.4 无状态服务带来的好处"></a>1.2.3.4 无状态服务带来的好处</h4><blockquote>
<p>服务无状态，主要是提升服务的&#x3D;&#x3D;<strong>可扩展性</strong>&#x3D;&#x3D;；</p>
</blockquote>
<p>如果服务是无状态的，我们就可以将请求发送到任意一台服务器，然后通过负载均衡，将请求平均分布在不同的服务器中，非常方便的实现&#x3D;&#x3D;水平扩展&#x3D;&#x3D;；</p>
<p>如果服务是无状态的，就无法那么轻易的实现了，客户端需要始终将请求发送到同一台服务器才行，或者通过一些其他的手段达到目的，如分布式session共享、Redis单点登录等；</p>
<h3 id="1-2-4-Restful通信风格"><a href="#1-2-4-Restful通信风格" class="headerlink" title="1.2.4 Restful通信风格"></a>1.2.4 Restful通信风格</h3><p>Restful架构，就是目前最流行的一种互联网软件架构，它结构清晰、符合标准、易于理解、扩展方便，所以正得到越来越多网站的采用。设计一个微服务架构的项目时，应该尽量遵守Restful风格进行通信；Restful好处如下：</p>
<p>1）基于JSON进行数据交互，简单轻量，人机阅读方便；</p>
<p>2）对请求进行更好的规范，如GET&#x2F;POST&#x2F;PUT&#x2F;DELETE等都说明其用途，能更好的前后端对接；</p>
<p>3）Restful与编程语言无关，只要各个服务遵守Restful编写API，任何语言之间都可以进行通信（数据交互）；</p>
<h1 id="二、SpringCloud概述"><a href="#二、SpringCloud概述" class="headerlink" title="二、SpringCloud概述"></a>二、SpringCloud概述</h1><h2 id="1-1-什么是-SpringCloud"><a href="#1-1-什么是-SpringCloud" class="headerlink" title="1.1. 什么是 SpringCloud"></a>1.1. 什么是 SpringCloud</h2><p>SpringCloud是一个全局的微服务治理平台，与其他的一些微服务框架不同，SpringCloud关注的是全局的微服务治理，或者说SpringCloud是一个生态圈；例如服务发现与注册、服务熔断、负载均衡、分布式配置、服务网关、链路追踪、消息驱动…等等功能在SpringCloud中都有对应的解决方案（框架）；因而，<strong>SpringCloud并不是一个单独的框架，而是一系列框架的集合</strong>，是微服务一站式全套解决方案；</p>
<p>另外SpringCloud是基于SpringBoot之上做开发的，SpringCloud正是利用了SpringBoot开发的便捷性简化了微服务中基础配置开发，让我们能够快速的构建一个独立的微服务平台；总的来说，SpringBoot主要的目的是快速开发单个应用（微服务），Spring Cloud则关注的是全局的服务治理；包括了分布式的方方面面的管理；</p>
<p>总结：</p>
<ul>
<li>1）SpringCloud并不是一个框架，是一系列框架的集合</li>
<li>2）SpringCloud项目必须基于SpringBoot</li>
</ul>
<blockquote>
<p>Spring Cloud 项目的官方网址：<a class="link"   target="_blank" rel="noopener" href="https://spring.io/projects/spring-cloud" >https://spring.io/projects/spring-cloud <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
</blockquote>
<h2 id="1-2-SpringCloud-主要框架"><a href="#1-2-SpringCloud-主要框架" class="headerlink" title="1.2 SpringCloud 主要框架"></a>1.2 SpringCloud 主要框架</h2><p>前面说到，SpringCloud中整合了绝大多数市面上比较成熟的微服务框架，再利用SpringBoot的风格做到一键部署和启动；最终留给开发者一套强大而又方便的分布式开发工具包；SpringCloud中的框架大致分为3个系列：</p>
<ul>
<li>1）SpringCloud自家产品</li>
<li><strong>2）Netflix系列产品</strong></li>
<li>3）Alibaba系列产品</li>
</ul>
<h3 id="1-2-1-SpringCloud系列产品"><a href="#1-2-1-SpringCloud系列产品" class="headerlink" title="1.2.1 SpringCloud系列产品"></a>1.2.1 SpringCloud系列产品</h3><p>SpringCloud原生系列产品有：Consul、OpenFeign（整合Feign）、Gateway、Config、Bus、Sleuth、Stream等；</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/springcloud/189.png"
                      alt="img"
                ></p>
<ul>
<li><code>Spring Cloud Consul</code>：采用Go语言编写，实现分布式系统的服务发现与配置；</li>
<li><code>Spring Cloud OpenFeign</code>：基于Netlfix Feign，实现分布式系统中的远程调用，并支持负载均衡、熔断等功能；</li>
<li><code>Spring Cloud Gateway</code>：微服务网关，提供路由、过滤、限流、监控等功能；</li>
<li><strong><code>Spring Cloud Config</code>：分布式集中配置组件，用于管理分布式系统中的配置文件；</strong></li>
<li><strong><code>Spring Cloud Bus</code>：消息总线设置，刷新分布式环境下配置文件；</strong></li>
<li><code>Spring Cloud Sleuth</code>：微服务链路追踪，跟踪一个请求的过程，捕获这些跟踪数据，构建微服务的整个调用链的视图</li>
<li><code>Spring Cloud Stream</code>：消息驱动，实现应用程序与消息中间件细节之间的隔离</li>
</ul>
<h3 id="1-2-2-Netflix系列产品"><a href="#1-2-2-Netflix系列产品" class="headerlink" title="1.2.2 Netflix系列产品"></a>1.2.2 Netflix系列产品</h3><p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/springcloud/195.png"
                      alt="img"
                ></p>
<p>Netflix系列产品包括：Netflix Eureka、Netflix Feign、Netflix Hystrix、Netflix Ribbon、Netflix Zuul、Netflix Archaius等；</p>
<ul>
<li><code>Netflix Eureka</code>：服务注册中心</li>
<li><code>Netflix Feign</code>：服务调用</li>
<li><code>Netflix Hystrix</code>：服务熔断，自我保护</li>
<li><code>Netflix Ribbon</code>：服务调用负载均衡</li>
<li><code>Netflix Zuul</code>：微服务网关</li>
<li><code>Netflix Archaius</code>：分布式配置管理</li>
</ul>
<h3 id="1-2-3-Alibaba系列产品"><a href="#1-2-3-Alibaba系列产品" class="headerlink" title="1.2.3 Alibaba系列产品"></a>1.2.3 Alibaba系列产品</h3><p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/springcloud/194.png"
                      alt="img"
                ></p>
<p>Alibaba系列产品包括：Nacos、Dubbo、Sentinel、Cloud ACM、RocketMQ、SchedulerX、Seata</p>
<ul>
<li><code>Alibaba Nacos</code>：服务注册中心</li>
<li><code> Alibaba Dubbo</code>：服务治理（调用）</li>
<li><code>Alibaba Sentinel</code>：服务监控、熔断</li>
<li><code>Alibaba Cloud ACM</code>：分布式集中配置</li>
<li><code>Alibaba RocketMQ</code>：消息队列</li>
<li><code>Alibaba Cloud SchedulerX</code>：分布式任务调度</li>
<li><code>Alibaba Seata</code>：分布式事务解决方案</li>
</ul>
<h3 id="1-2-4-三大系列对比："><a href="#1-2-4-三大系列对比：" class="headerlink" title="1.2.4 三大系列对比："></a>1.2.4 三大系列对比：</h3><table>
<thead>
<tr>
<th>解决方案</th>
<th>Netflix系列</th>
<th>Alibaba系列</th>
<th>SpringCloud系列</th>
</tr>
</thead>
<tbody><tr>
<td>服务注册</td>
<td>Netflix Eureka</td>
<td>Alibaba Nacos</td>
<td>Spring Cloud Consul</td>
</tr>
<tr>
<td>服务调用</td>
<td>Netflix Feign（openFeign）</td>
<td>Alibaba Dubbo</td>
<td>Spring Cloud OpenFeign</td>
</tr>
<tr>
<td>负载均衡</td>
<td>Netflix Ribbon</td>
<td></td>
<td></td>
</tr>
<tr>
<td>服务熔断</td>
<td>Netflix Hystrix</td>
<td>Alibaba Sentinel</td>
<td></td>
</tr>
<tr>
<td>服务网关</td>
<td>Netflix Zuul</td>
<td></td>
<td>Spring Cloud Gateway</td>
</tr>
<tr>
<td>集中配置</td>
<td>Netflix Archaius</td>
<td>Alibaba Cloud ACM</td>
<td>Spring Cloud Config</td>
</tr>
<tr>
<td>消息总线</td>
<td></td>
<td></td>
<td>Spring Cloud Bus</td>
</tr>
<tr>
<td>链路追踪</td>
<td></td>
<td></td>
<td>Spring Cloud Sleuth</td>
</tr>
<tr>
<td>消息驱动</td>
<td></td>
<td>Alibaba RocketMQ</td>
<td>Spring Cloud Stream</td>
</tr>
<tr>
<td>任务调度</td>
<td></td>
<td>Alibaba Cloud SchedulerX</td>
<td>Spring Cloud Task</td>
</tr>
<tr>
<td>分布式事务</td>
<td></td>
<td>Alibaba Seata</td>
<td></td>
</tr>
</tbody></table>
<h2 id="1-3-SpringCloud-版本"><a href="#1-3-SpringCloud-版本" class="headerlink" title="1.3 SpringCloud 版本"></a>1.3 SpringCloud 版本</h2><p>我们刚刚说到SpringCloud是一系列框架的集合，避免总版本号与子项目的版本号产生混淆，采用伦敦地铁站的名称作为版本名，形式为版本+里程碑号；根据首字母排序，字母顺序靠后的版本号越大；</p>
<blockquote>
<p>SpringCloud版本查询：<a class="link"   target="_blank" rel="noopener" href="https://start.spring.io/actuator/info" >https://start.spring.io/actuator/info <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
</blockquote>
<h3 id="1-3-1-版本号对应"><a href="#1-3-1-版本号对应" class="headerlink" title="1.3.1 版本号对应"></a>1.3.1 版本号对应</h3><table>
<thead>
<tr>
<th>Spring Boot</th>
<th>Spring Cloud</th>
</tr>
</thead>
<tbody><tr>
<td>1.2.x</td>
<td>Angel 版本</td>
</tr>
<tr>
<td>1.3.x</td>
<td>Brixton 版本</td>
</tr>
<tr>
<td>1.4.x</td>
<td>Camden 版本</td>
</tr>
<tr>
<td>1.5.x</td>
<td>Dalston 版本、Edgware 版本</td>
</tr>
<tr>
<td>2.0.x</td>
<td>Finchley 版本</td>
</tr>
<tr>
<td>2.1.x</td>
<td>Greenwich 版本</td>
</tr>
<tr>
<td>2.2.x, 2.3.x</td>
<td>Hoxton 版本</td>
</tr>
</tbody></table>
<h3 id="1-3-2-版本号说明"><a href="#1-3-2-版本号说明" class="headerlink" title="1.3.2 版本号说明"></a>1.3.2 版本号说明</h3><table>
<thead>
<tr>
<th>版本号</th>
<th>版本</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>BUILD-XXX</td>
<td>开发版</td>
<td>开发团队内部使用，不是很稳定</td>
</tr>
<tr>
<td>GA</td>
<td>稳定版</td>
<td>相比于开发版，基本上可以使用了</td>
</tr>
<tr>
<td>PRE（M1、M2）</td>
<td>里程碑版</td>
<td>主要是修复了一些BUG的版本，一个GA后通常有多个里程碑版</td>
</tr>
<tr>
<td>RC</td>
<td>候选发布版</td>
<td>该阶段的软件类似于最终版的一个发行观察期，基本只修复比较严重的BUG</td>
</tr>
<tr>
<td>SNAPSHOT</td>
<td>快照版</td>
<td>可以稳定使用，且仍在继续改进版本。</td>
</tr>
<tr>
<td>SR</td>
<td>正式发布版</td>
<td>经过严格测试后可对外发行的版本</td>
</tr>
</tbody></table>
<h1 id="三、服务远程调用"><a href="#三、服务远程调用" class="headerlink" title="三、服务远程调用"></a>三、服务远程调用</h1><h2 id="3-1-工程准备"><a href="#3-1-工程准备" class="headerlink" title="3.1 工程准备"></a>3.1 工程准备</h2><h3 id="3-1-1-搭建父工程"><a href="#3-1-1-搭建父工程" class="headerlink" title="3.1.1 搭建父工程"></a>3.1.1 搭建父工程</h3><h4 id="3-1-1-1-maven依赖："><a href="#3-1-1-1-maven依赖：" class="headerlink" title="3.1.1.1 maven依赖："></a>3.1.1.1 maven依赖：</h4><div class="highlight-container" data-rel="Xml"><figure class="iseeu highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">packaging</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">packaging</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">modules</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">module</span>&gt;</span>order_server<span class="tag">&lt;/<span class="name">module</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">module</span>&gt;</span>store_server<span class="tag">&lt;/<span class="name">module</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">modules</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.3.8.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">relativePath</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">project.reporting.outputEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.reporting.outputEncoding</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-logging<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.18.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>provided<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>Hoxton.SR10<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure></div>



<h3 id="3-1-2-搭建商品微服务"><a href="#3-1-2-搭建商品微服务" class="headerlink" title="3.1.2 搭建商品微服务"></a>3.1.2 搭建商品微服务</h3><h4 id="3-1-2-1-maven依赖："><a href="#3-1-2-1-maven依赖：" class="headerlink" title="3.1.2.1 maven依赖："></a>3.1.2.1 maven依赖：</h4><div class="highlight-container" data-rel="Xml"><figure class="iseeu highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--继承父工程--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>01_SpringCloud_RestTemplate<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>item_server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure></div>

<h4 id="3-1-2-2-application-yml"><a href="#3-1-2-2-application-yml" class="headerlink" title="3.1.2.2 application.yml"></a>3.1.2.2 application.yml</h4><div class="highlight-container" data-rel="Yml"><figure class="iseeu highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">9000</span></span><br></pre></td></tr></table></figure></div>

<h4 id="3-1-2-3-ItemApplication"><a href="#3-1-2-3-ItemApplication" class="headerlink" title="3.1.2.3 ItemApplication"></a>3.1.2.3 ItemApplication</h4><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.cloud.item;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> lscl</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@intro</span>:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ItemApplication</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(ItemApplication.class);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h4 id="3-1-2-4-ItemController"><a href="#3-1-2-4-ItemController" class="headerlink" title="3.1.2.4 ItemController"></a>3.1.2.4 ItemController</h4><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.cloud.item.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> lscl</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@intro</span>:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/item&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ItemController</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h4 id="3-1-2-5-Order实体类"><a href="#3-1-2-5-Order实体类" class="headerlink" title="3.1.2.5 Order实体类"></a>3.1.2.5 Order实体类</h4><blockquote>
<p>实际开发应该搭建一个common公共模块，实体类编写在公共模块中，我们为了简单起见，在各个微服务中编写同样的实体类；</p>
</blockquote>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.cloud.item.entity;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Getter;</span><br><span class="line"><span class="keyword">import</span> lombok.Setter;</span><br><span class="line"><span class="keyword">import</span> lombok.ToString;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> lscl</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@intro</span>: 订单实体类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span>                   <span class="comment">// get/set/toString</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span>      <span class="comment">// 无参构造</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span>     <span class="comment">// 有参构造</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Order</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Integer id;</span><br><span class="line">    <span class="keyword">private</span> String itemName;</span><br><span class="line">    <span class="keyword">private</span> Double price;</span><br><span class="line">    <span class="keyword">private</span> Integer num;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>



<h3 id="3-1-3-搭建订单微服务"><a href="#3-1-3-搭建订单微服务" class="headerlink" title="3.1.3 搭建订单微服务"></a>3.1.3 搭建订单微服务</h3><h4 id="3-1-3-1-maven依赖"><a href="#3-1-3-1-maven依赖" class="headerlink" title="3.1.3.1 maven依赖"></a>3.1.3.1 maven依赖</h4><div class="highlight-container" data-rel="Xml"><figure class="iseeu highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--继承父工程--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>01_SpringCloud_RestTemplate<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>order_server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure></div>

<h4 id="3-1-3-2-application-yml"><a href="#3-1-3-2-application-yml" class="headerlink" title="3.1.3.2 application.yml"></a>3.1.3.2 application.yml</h4><div class="highlight-container" data-rel="Yml"><figure class="iseeu highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">9001</span></span><br></pre></td></tr></table></figure></div>

<h4 id="3-1-3-3-OrderApplication"><a href="#3-1-3-3-OrderApplication" class="headerlink" title="3.1.3.3 OrderApplication"></a>3.1.3.3 OrderApplication</h4><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.cloud.order;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> lscl</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@intro</span>:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderApplication</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(OrderApplication.class);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h4 id="3-1-3-4-Order实体类"><a href="#3-1-3-4-Order实体类" class="headerlink" title="3.1.3.4 Order实体类"></a>3.1.3.4 Order实体类</h4><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.cloud.order.entity;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Getter;</span><br><span class="line"><span class="keyword">import</span> lombok.Setter;</span><br><span class="line"><span class="keyword">import</span> lombok.ToString;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> lscl</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@intro</span>: 订单实体类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span>                   <span class="comment">// get/set/toString</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span>      <span class="comment">// 无参构造</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span>     <span class="comment">// 有参构造</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Order</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Integer id;</span><br><span class="line">    <span class="keyword">private</span> String itemName;</span><br><span class="line">    <span class="keyword">private</span> Double price;</span><br><span class="line">    <span class="keyword">private</span> Integer num;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h4 id="3-1-3-5-OrderController"><a href="#3-1-3-5-OrderController" class="headerlink" title="3.1.3.5 OrderController"></a>3.1.3.5 OrderController</h4><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.cloud.order.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.cloud.order.entity.Order;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> lscl</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@intro</span>:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/order&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 新增订单</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> order</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostMapping</span></span><br><span class="line">    <span class="keyword">public</span> Map <span class="title function_">save</span><span class="params">(<span class="meta">@RequestBody</span> Order order)</span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>()&#123;&#123;</span><br><span class="line">            put(<span class="string">&quot;flag&quot;</span>,<span class="literal">true</span>);</span><br><span class="line">            put(<span class="string">&quot;message&quot;</span>,<span class="string">&quot;新增成功&quot;</span>);</span><br><span class="line">            put(<span class="string">&quot;statusCode&quot;</span>,<span class="string">&quot;200&quot;</span>);</span><br><span class="line">            put(<span class="string">&quot;order&quot;</span>,order);</span><br><span class="line">        &#125;&#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 删除订单</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@DeleteMapping(&quot;&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Map <span class="title function_">delete</span><span class="params">(<span class="meta">@PathVariable</span> Integer id)</span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>()&#123;&#123;</span><br><span class="line">            put(<span class="string">&quot;flag&quot;</span>,<span class="literal">true</span>);</span><br><span class="line">            put(<span class="string">&quot;message&quot;</span>,<span class="string">&quot;删除成功&quot;</span>);</span><br><span class="line">            put(<span class="string">&quot;statusCode&quot;</span>,<span class="string">&quot;200&quot;</span>);</span><br><span class="line">            put(<span class="string">&quot;id&quot;</span>,id);</span><br><span class="line">        &#125;&#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> order</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PutMapping(&quot;&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Map <span class="title function_">update</span><span class="params">(<span class="meta">@PathVariable</span> Integer id,<span class="meta">@RequestBody</span> Order order)</span>&#123;</span><br><span class="line"></span><br><span class="line">        order.setId(id);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>()&#123;&#123;</span><br><span class="line">            put(<span class="string">&quot;flag&quot;</span>,<span class="literal">true</span>);</span><br><span class="line">            put(<span class="string">&quot;message&quot;</span>,<span class="string">&quot;修改&quot;</span>);</span><br><span class="line">            put(<span class="string">&quot;statusCode&quot;</span>,<span class="string">&quot;200&quot;</span>);</span><br><span class="line">            put(<span class="string">&quot;order&quot;</span>,order);</span><br><span class="line">        &#125;&#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Map <span class="title function_">findById</span><span class="params">(<span class="meta">@PathVariable</span> Integer id)</span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>()&#123;&#123;</span><br><span class="line">            put(<span class="string">&quot;flag&quot;</span>,<span class="literal">true</span>);</span><br><span class="line">            put(<span class="string">&quot;message&quot;</span>,<span class="string">&quot;查询成功&quot;</span>);</span><br><span class="line">            put(<span class="string">&quot;statusCode&quot;</span>,<span class="string">&quot;200&quot;</span>);</span><br><span class="line">            put(<span class="string">&quot;id&quot;</span>,id);</span><br><span class="line">        &#125;&#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>工程搭建如下：</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/springcloud/188.png"
                      alt="img"
                ></p>
<h2 id="3-2-RestTemplate"><a href="#3-2-RestTemplate" class="headerlink" title="3.2 RestTemplate"></a>3.2 RestTemplate</h2><p>RestTemplate 是从 Spring3.0 开始支持的一个 HTTP 请求工具，它提供了常见的REST请求方案的模版，例如 GET 请求、POST 请求、PUT 请求、DELETE 请求以及一些通用的请求执行方法 exchange 以及 execute。RestTemplate 继承自 InterceptingHttpAccessor 并且实现了 RestOperations 接口，其中 RestOperations 接口定义了基本的 RESTful 操作，这些操作在 RestTemplate 中都得到了实现。接下来我们就来看看这些操作方法的使用。</p>
<h3 id="3-2-1-RestTemplate方法介绍"><a href="#3-2-1-RestTemplate方法介绍" class="headerlink" title="3.2.1 RestTemplate方法介绍"></a>3.2.1 RestTemplate方法介绍</h3><table>
<thead>
<tr>
<th>请求方式</th>
<th>方法</th>
<th>返回值</th>
</tr>
</thead>
<tbody><tr>
<td>GET</td>
<td>getForObject(String,Class<T>,Object…)</td>
<td><T></td>
</tr>
<tr>
<td>GET</td>
<td>getForEntity(String,Class<T>,Object…)</td>
<td>ResponseEntity<T></td>
</tr>
<tr>
<td>POST</td>
<td>postForLocation(String,Object,Object…)</td>
<td>URI</td>
</tr>
<tr>
<td>POST</td>
<td>postForObject(String,Object,Class<T>,Object…)</td>
<td><T></td>
</tr>
<tr>
<td>POST</td>
<td>postForEntity(String,Class<T>,Object…)</td>
<td>ResponseEntity<T></td>
</tr>
<tr>
<td>PUT</td>
<td>put(String,Object,Object…)</td>
<td>void</td>
</tr>
<tr>
<td>DELETE</td>
<td>delete(String,Object…)</td>
<td>void</td>
</tr>
<tr>
<td>自定义</td>
<td>exchange(String,HttpMethod,HttpEntity<T>,Class<T>,Object…)</td>
<td>ResponseEntity<T></td>
</tr>
</tbody></table>
<h3 id="3-2-2-配置-RestTemplate"><a href="#3-2-2-配置-RestTemplate" class="headerlink" title="3.2.2 配置 RestTemplate"></a>3.2.2 配置 RestTemplate</h3><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.cloud.item;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.netflix.eureka.EnableEurekaClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.client.RestTemplate;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> lscl</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@intro</span>:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ItemApplication</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(ItemApplication.class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RestTemplate <span class="title function_">restTemplate</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RestTemplate</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>



<h3 id="3-2-3-测试类"><a href="#3-2-3-测试类" class="headerlink" title="3.2.3 测试类"></a>3.2.3 测试类</h3><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.cloud.demo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.cloud.item.ItemApplication;</span><br><span class="line"><span class="keyword">import</span> com.cloud.item.entity.Order;</span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"><span class="keyword">import</span> org.junit.runner.RunWith;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.HttpEntity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.HttpMethod;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.ResponseEntity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.test.context.junit4.SpringRunner;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.client.RestTemplate;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> lscl</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@intro</span>:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@SpringBootTest(classes = ItemApplication.class)</span></span><br><span class="line"><span class="meta">@RunWith(SpringRunner.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Demo01</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RestTemplate restTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * get请求</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test1</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 直接获取响应体</span></span><br><span class="line"><span class="comment">//        Map resultMap = restTemplate.getForObject(&quot;http://localhost:9001/order/1&quot;, Map.class);</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取响应实体</span></span><br><span class="line">        ResponseEntity&lt;Map&gt; entity = restTemplate.getForEntity(<span class="string">&quot;http://localhost:9001/order/1&quot;</span>, Map.class);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 响应码</span></span><br><span class="line">        System.out.println(entity.getStatusCodeValue());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 响应头</span></span><br><span class="line">        System.out.println(entity.getHeaders());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 响应体</span></span><br><span class="line">        <span class="type">Map</span> <span class="variable">resultMap</span> <span class="operator">=</span> entity.getBody();</span><br><span class="line">        System.out.println(resultMap);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * post请求</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test2</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Map</span> <span class="variable">resultMap</span> <span class="operator">=</span> restTemplate.postForObject(</span><br><span class="line">                <span class="string">&quot;http://localhost:9001/order&quot;</span>,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">Order</span>(<span class="number">1</span>, <span class="string">&quot;赣南脐橙&quot;</span>, <span class="number">48.8</span>, <span class="number">10</span>),</span><br><span class="line">                Map.class);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 响应码</span></span><br><span class="line">        System.out.println(resultMap);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * put请求</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test3</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 可以发送put请求,但是没有返回值</span></span><br><span class="line">        restTemplate.put(</span><br><span class="line">                <span class="string">&quot;http://localhost:9001/order/11&quot;</span>,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">Order</span>(<span class="literal">null</span>, <span class="string">&quot;赣南脐橙&quot;</span>, <span class="number">48.8</span>, <span class="number">10</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 封装一个请求对象</span></span><br><span class="line">        HttpEntity&lt;Order&gt; httpEntity=<span class="keyword">new</span> <span class="title class_">HttpEntity</span>(<span class="keyword">new</span> <span class="title class_">Order</span>(<span class="literal">null</span>, <span class="string">&quot;赣南脐橙&quot;</span>, <span class="number">48.8</span>, <span class="number">10</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 发送PUT请求</span></span><br><span class="line">        ResponseEntity&lt;Map&gt; responseEntity = restTemplate.exchange(</span><br><span class="line">                <span class="string">&quot;http://localhost:9001/order/110&quot;</span>,</span><br><span class="line">                HttpMethod.PUT,</span><br><span class="line">                httpEntity,</span><br><span class="line">                Map.class</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="type">Map</span> <span class="variable">resultMap</span> <span class="operator">=</span> responseEntity.getBody();</span><br><span class="line">        System.out.println(resultMap);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * delete请求</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test4</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 可以发送put请求,但是没有返回值</span></span><br><span class="line"><span class="comment">//        restTemplate.delete(&quot;http://localhost:9001/order/110&quot;);</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 发送PUT请求</span></span><br><span class="line">        ResponseEntity&lt;Map&gt; responseEntity = restTemplate.exchange(</span><br><span class="line">                <span class="string">&quot;http://localhost:9001/order/110&quot;</span>,</span><br><span class="line">                HttpMethod.DELETE,</span><br><span class="line">                <span class="literal">null</span>,</span><br><span class="line">                Map.class</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="type">Map</span> <span class="variable">resultMap</span> <span class="operator">=</span> responseEntity.getBody();</span><br><span class="line">        System.out.println(resultMap);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h1 id="四、Netflix-Eureka-注册中心"><a href="#四、Netflix-Eureka-注册中心" class="headerlink" title="四、Netflix Eureka 注册中心"></a>四、Netflix Eureka 注册中心</h1><h2 id="4-1-注册中心概述"><a href="#4-1-注册中心概述" class="headerlink" title="4.1 注册中心概述"></a>4.1 注册中心概述</h2><p>注册中心主要涉及到三大角色：</p>
<ol>
<li>服务提供者</li>
<li>服务消费者</li>
<li>注册中心</li>
</ol>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/springcloud/187.png"
                      alt="img"
                ></p>
<p>它们之间的关系大致如下：</p>
<ol>
<li>各个微服务在启动时，将自己的网络地址等信息注册到注册中心，注册中心存储这些数据。</li>
<li>服务消费者从注册中心查询服务提供者的地址，并通过该地址调用服务提供者的接口。</li>
<li>各个微服务与注册中心使用一定机制（例如心跳）通信。如果注册中心与某微服务长时间无法通信，就会注销该实例。</li>
<li>微服务网络地址发送变化（例如实例增加或IP变动等）时，会重新注册到注册中心。这样，服务消费者就无需人工修改提供者的网络地址了。</li>
</ol>
<h2 id="4-2-Netlfix-Eureka-概述"><a href="#4-2-Netlfix-Eureka-概述" class="headerlink" title="4.2 Netlfix Eureka 概述"></a>4.2 Netlfix Eureka 概述</h2><p>Eureka 是 Netflix 开发的服务注册框架，SpringCloud 将它集成在自己的子项目spring-cloud-netflix 中，实现 SpringCloud 的服务发现功能。Eureka包含两个组件： <code>Eureka Server</code> 和 <code>Eureka Client</code>。</p>
<p>Eureka Server 提供服务注册服务，各个节点启动后，会在 Eureka Server 中进行注册，这样 Eureka Server中的服务注册表中将会存储所有可用服务节点的信息，服务节点的信息可以在界面中直观的看到。</p>
<p>Eureka Client 是一个 java 客户端，用于简化与 Eureka Server的交互，客户端中有一个内置的、使用轮询(round-robin)负载算法的负载均衡器。</p>
<h3 id="4-2-1-Eureka-提供的功能"><a href="#4-2-1-Eureka-提供的功能" class="headerlink" title="4.2.1 Eureka 提供的功能"></a>4.2.1 Eureka 提供的功能</h3><p>Eureka提供的最主要的功能就是服务注册于发现功能了，除本身核心功能外，Eureka还提供了许多其他的功能；</p>
<h4 id="4-2-1-1-心跳检查"><a href="#4-2-1-1-心跳检查" class="headerlink" title="4.2.1.1 心跳检查"></a>4.2.1.1 心跳检查</h4><p>在应用启动后，将会向Eureka Server 发送心跳,默认周期为 30 秒，如果 Eureka Server在多个心跳周期内没有接收到某个节点的心跳，Eureka Server 将会从服务注册表中把这个服务节点移除(默认 90 秒)。</p>
<h4 id="4-2-1-2-同步复制"><a href="#4-2-1-2-同步复制" class="headerlink" title="4.2.1.2 同步复制"></a>4.2.1.2 同步复制</h4><p>在Eureka集群环境时，每个Eureka Server同时也是Eureka Client，多个Eureka Server之间通过复制的方式完成服务注册表的同步；</p>
<h4 id="4-2-1-3-缓存机制"><a href="#4-2-1-3-缓存机制" class="headerlink" title="4.2.1.3 缓存机制"></a>4.2.1.3 缓存机制</h4><p>Eureka提供了客户端缓存机制，即使所有的 Eureka Server都挂掉，客户端依然可以利用缓存中的信息消费其他服务的 API。</p>
<blockquote>
<p>综上，Eureka通过心跳检查、复制同步、客户端缓存等机制，确保了系统的高可用性、灵活性和可伸缩性。</p>
</blockquote>
<h2 id="4-3-Eureka-快速入门"><a href="#4-3-Eureka-快速入门" class="headerlink" title="4.3 Eureka 快速入门"></a>4.3 Eureka 快速入门</h2><h3 id="4-3-1-搭建Eureka-Server"><a href="#4-3-1-搭建Eureka-Server" class="headerlink" title="4.3.1 搭建Eureka Server"></a>4.3.1 搭建Eureka Server</h3><p>1）创建eureka_server模块</p>
<p>2）引入依赖</p>
<div class="highlight-container" data-rel="Xml"><figure class="iseeu highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>eureka_server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--eureka服务器端依赖--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure></div>

<p>3）编写 application.yml </p>
<div class="highlight-container" data-rel="Yml"><figure class="iseeu highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">10101</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">eureka-server</span>    			<span class="comment"># 微服名称</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">false</span>   	<span class="comment"># 是否将该服务注册到eureka服务端</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">false</span>        	<span class="comment"># 是否从eureka服务端获取其他服务实例</span></span><br><span class="line">    <span class="attr">service-url:</span>                    <span class="comment"># eureka的注册地址</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://$&#123;eureka.instance.hostname&#125;:$&#123;server.port&#125;/eureka</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">localhost</span>				<span class="comment"># 主机名</span></span><br></pre></td></tr></table></figure></div>

<blockquote>
<ul>
<li><code>register-with-eureka</code>：是否将该服务注册到eureka服务端，默认为true，集群环境下使用</li>
<li><code>fetch-registry</code>：是否从eureka服务端获取其他服务实例，默认为true，集群环境下使用</li>
</ul>
</blockquote>
<p>4）编写启动类</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.cloud.eureka;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.netflix.eureka.server.EnableEurekaServer;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> lscl</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@intro</span>:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableEurekaServer</span>                 <span class="comment">//开启Eureka服务器端</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EurekaApplication</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line"></span><br><span class="line">        SpringApplication.run(EurekaApplication.class);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>5）访问：<a class="link"   target="_blank" rel="noopener" href="http://localhost:10101/" >http://localhost:10101 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/springcloud/186.png"
                      alt="img"
                ></p>
<h3 id="4-3-2-搭建Eureka-Client"><a href="#4-3-2-搭建Eureka-Client" class="headerlink" title="4.3.2 搭建Eureka Client"></a>4.3.2 搭建Eureka Client</h3><h4 id="4-3-2-1-注册Item服务"><a href="#4-3-2-1-注册Item服务" class="headerlink" title="4.3.2.1 注册Item服务"></a>4.3.2.1 注册Item服务</h4><p>1）引入Eureka Client依赖</p>
<div class="highlight-container" data-rel="Xml"><figure class="iseeu highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--引入eureka客户端依赖--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></div>

<p>2）编写application.yml</p>
<div class="highlight-container" data-rel="Yml"><figure class="iseeu highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">9000</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">item-service</span>           <span class="comment"># 微服务名称</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://127.0.0.1:10101/eureka</span>    <span class="comment"># 注册到Eureka</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">prefer-ip-address:</span> <span class="literal">true</span>         <span class="comment"># 使用ip地址注册服务(默认情况下是以主机名注册)</span></span><br><span class="line">    <span class="attr">instance-id:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:$&#123;server.port&#125;</span>   <span class="comment"># 实例id</span></span><br></pre></td></tr></table></figure></div>

<blockquote>
<p>prefer-ip-address：以ip地址注册服务</p>
<p>instance-id：实例名称（id），名字随意；一般情况下是ip+端口；</p>
</blockquote>
<p>3）修改引导类</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.cloud.item;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.client.discovery.EnableDiscoveryClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.netflix.eureka.EnableEurekaClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.client.RestTemplate;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> lscl</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@intro</span>:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span>      <span class="comment">// 开启服务发现功能</span></span><br><span class="line"><span class="meta">@EnableEurekaClient</span>         <span class="comment">// 开启Eureka客户端</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ItemApplication</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(ItemApplication.class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RestTemplate <span class="title function_">restTemplate</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RestTemplate</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<blockquote>
<p>从<code>Spring Cloud Edgware</code>版本之后（包括Edgware版本）， 加上EurekaClient相关依赖之后，并进行相应配置，即可将微服务注册到服务发现组件上。@EnableDiscoveryClient和@EnableEurekaClient可不加；</p>
</blockquote>
<h4 id="4-3-2-2-注册Order服务"><a href="#4-3-2-2-注册Order服务" class="headerlink" title="4.3.2.2 注册Order服务"></a>4.3.2.2 注册Order服务</h4><p>参考Item服务注册步骤；</p>
<h3 id="4-3-4-服务消费"><a href="#4-3-4-服务消费" class="headerlink" title="4.3.4 服务消费"></a>4.3.4 服务消费</h3><h4 id="4-3-4-1-DisconverClient"><a href="#4-3-4-1-DisconverClient" class="headerlink" title="4.3.4.1 DisconverClient"></a>4.3.4.1 DisconverClient</h4><p>DiscoveryClient可以用来获取服务的一些注册信息；如实例id、服务名称、主机名、端口、状态、ip地址等信息</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.cloud.demo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.cloud.item.ItemApplication;</span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"><span class="keyword">import</span> org.junit.runner.RunWith;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.client.ServiceInstance;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.client.discovery.DiscoveryClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.client.loadbalancer.LoadBalancerClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.test.context.junit4.SpringRunner;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.client.RestTemplate;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> lscl</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@intro</span>:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@SpringBootTest(classes = ItemApplication.class)</span></span><br><span class="line"><span class="meta">@RunWith(SpringRunner.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Demo02_DiscoveryClient</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RestTemplate restTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DiscoveryClient discoveryClient;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 根据服务名获取实例</span></span><br><span class="line">        List&lt;ServiceInstance&gt; instances = discoveryClient.getInstances(<span class="string">&quot;order-service&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">ServiceInstance</span> <span class="variable">instance</span> <span class="operator">=</span> instances.get(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;服务实例id: &quot;</span>+instance.getInstanceId());</span><br><span class="line">        System.out.println(<span class="string">&quot;服务名称: &quot;</span>+instance.getServiceId());</span><br><span class="line">        System.out.println(<span class="string">&quot;主机ip: &quot;</span>+instance.getHost());</span><br><span class="line">        System.out.println(<span class="string">&quot;端口: &quot;</span>+instance.getPort());</span><br><span class="line">        System.out.println(<span class="string">&quot;协议: &quot;</span>+instance.getScheme());</span><br><span class="line">        </span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        [</span></span><br><span class="line"><span class="comment">        	EurekaDiscoveryClient.EurekaServiceInstance@630febd7 instance = InstanceInfo </span></span><br><span class="line"><span class="comment">        	[</span></span><br><span class="line"><span class="comment">        	instanceId = 192.168.18.1:9001, </span></span><br><span class="line"><span class="comment">        	appName = ORDER-SERVICE, </span></span><br><span class="line"><span class="comment">        	hostName = 192.168.18.1, </span></span><br><span class="line"><span class="comment">        	status = UP, </span></span><br><span class="line"><span class="comment">        	ipAddr = 192.168.18.1, </span></span><br><span class="line"><span class="comment">        	port = 9001, </span></span><br><span class="line"><span class="comment">        	securePort = 443, </span></span><br><span class="line"><span class="comment">        	dataCenterInfo = com.netflix.appinfo.MyDataCenterInfo@45c2c396</span></span><br><span class="line"><span class="comment">        	]</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        System.out.println(instance);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test1</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 根据服务名获取实例</span></span><br><span class="line">        List&lt;ServiceInstance&gt; instances = discoveryClient.getInstances(<span class="string">&quot;order-service&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">ServiceInstance</span> <span class="variable">instance</span> <span class="operator">=</span> instances.get(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        System.out.println(instance);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 使用discoveryClient获取服务元数据进行服务消费(解耦)</span></span><br><span class="line">        <span class="type">Map</span> <span class="variable">resultMap</span> <span class="operator">=</span> restTemplate.getForObject(<span class="string">&quot;http://&quot;</span> + instance.getHost() + <span class="string">&quot;:&quot;</span> + instance.getPort() + <span class="string">&quot;/order/110&quot;</span>, Map.class);</span><br><span class="line"></span><br><span class="line">        System.out.println(resultMap);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h4 id="4-3-4-2-LoadBalancerClient"><a href="#4-3-4-2-LoadBalancerClient" class="headerlink" title="4.3.4.2 LoadBalancerClient"></a>4.3.4.2 LoadBalancerClient</h4><p>LoadBalancerClient和DisconverClient一样，都是用来获取服务的元数据的；</p>
<ul>
<li>测试类：</li>
</ul>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> LoadBalancerClient loadBalancerClient;          </span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test2</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 根据id获取服务实例(当有多个重名服务时采用轮询的负载均衡策略)</span></span><br><span class="line">    <span class="type">ServiceInstance</span> <span class="variable">instance</span> <span class="operator">=</span> loadBalancerClient.choose(<span class="string">&quot;order-service&quot;</span>);</span><br><span class="line"></span><br><span class="line">    System.out.println(instance);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">        <span class="type">Map</span> <span class="variable">resultMap</span> <span class="operator">=</span> restTemplate.getForObject(<span class="string">&quot;http://&quot;</span> + instance.getHost() + <span class="string">&quot;:&quot;</span> + instance.getPort() + <span class="string">&quot;/order/110&quot;</span>, Map.class);</span><br><span class="line"></span><br><span class="line">        System.out.println(resultMap);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h4 id="4-3-4-3-服务负载均衡"><a href="#4-3-4-3-服务负载均衡" class="headerlink" title="4.3.4.3 服务负载均衡"></a>4.3.4.3 服务负载均衡</h4><p>1）修改引导类的RestTemplate：</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="meta">@LoadBalanced</span>           <span class="comment">// 负载均衡</span></span><br><span class="line"><span class="keyword">public</span> RestTemplate <span class="title function_">restTemplate</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RestTemplate</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>2）测试</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test3</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 根据服务名获取实例</span></span><br><span class="line">    List&lt;ServiceInstance&gt; instances = discoveryClient.getInstances(<span class="string">&quot;order-service&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">ServiceInstance</span> <span class="variable">instance</span> <span class="operator">=</span> instances.get(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    System.out.println(instance);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 循环调用接口十次</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 使用服务名调用接口</span></span><br><span class="line">        <span class="type">Map</span> <span class="variable">resultMap</span> <span class="operator">=</span> restTemplate.getForObject(<span class="string">&quot;http://&quot;</span> + instance.getServiceId() + <span class="string">&quot;/order/110&quot;</span>, Map.class);</span><br><span class="line"></span><br><span class="line">        System.out.println(resultMap);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test4</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取服务实例</span></span><br><span class="line">    <span class="type">ServiceInstance</span> <span class="variable">instance</span> <span class="operator">=</span> loadBalancerClient.choose(<span class="string">&quot;order-service&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 循环调用接口十次</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">        <span class="comment">// 使用服务名调用接口</span></span><br><span class="line">        <span class="type">Map</span> <span class="variable">resultMap</span> <span class="operator">=</span> restTemplate.getForObject(<span class="string">&quot;http://&quot;</span> + instance.getServiceId() + <span class="string">&quot;/order/110&quot;</span>, Map.class);</span><br><span class="line"></span><br><span class="line">        System.out.println(resultMap);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<blockquote>
<p>&#x3D;&#x3D;<strong>注意：当添加@LoadBalanced注解后，只能通过服务名来调用接口，不能使用主机+端口的方式调用；</strong>&#x3D;&#x3D;</p>
</blockquote>
<h2 id="4-4-Eureka自我保护"><a href="#4-4-Eureka自我保护" class="headerlink" title="4.4 Eureka自我保护"></a>4.4 Eureka自我保护</h2><h3 id="4-4-1-自我保护"><a href="#4-4-1-自我保护" class="headerlink" title="4.4.1 自我保护"></a>4.4.1 自我保护</h3><p>如果在 Eureka Server 的首页看到以下这段提示，则说明 Eureka已经进入了保护模式：</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/springcloud/185.png"
                      alt="img"
                ></p>
<p>默认情况下，如果Eureka Server在一定时间内没有接收到某个Eureka Client的心跳，Eureka Server将会注销该实例（默认90秒）。但是当网络故障发生时，Eureka Client与Eureka Server之间无法正常通信，这就可能变得非常危险了，因为微服务本身是健康的，此时本不应该注销这个微服务。</p>
<p>Eureka Server通过“自我保护模式”来解决这个问题：当Eureka Server节点在短时间内丢失过多客户端时（可能发生了网络分区故障），那么这个节点就会进入自我保护模式。一旦进入该模式，Eureka Server就会保护服务注册表中的信息，不再删除服务注册表中的数据（也就是不会注销任何微服务）。当网络故障恢复后，该Eureka Server节点会自动退出自我保护模式。</p>
<p>自我保护模式是一种对网络异常的安全保护措施。使用自我保护模式，让Eureka集群更加的健壮、稳定。</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/springcloud/184.png"
                      alt="img"
                ></p>
<blockquote>
<p>Eureka Server在运行期间，会统计心跳失败的比例在15分钟之内是否低于85%；如果出现低于的情况下，Eureka Server会将当前的实例注册信息保护起来，同时提示这个警告。</p>
</blockquote>
<h3 id="4-4-2-错误信息呈现"><a href="#4-4-2-错误信息呈现" class="headerlink" title="4.4.2 错误信息呈现"></a>4.4.2 错误信息呈现</h3><p>默认情况下，Eureka符合自我保护条件时，并不会将信息呈现到web页面，而是默认等待5分钟之后再将自我保护信息呈现到web页面，因为服务刚开始启动时必定是符合自我保护条件的，即心跳肯定是低于85%；</p>
<p>我们可以通过如下参数调整呈现信息的时间：</p>
<div class="highlight-container" data-rel="Yml"><figure class="iseeu highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">server:</span></span><br><span class="line">    <span class="attr">wait-time-in-ms-when-sync-empty:</span> <span class="number">1</span>			</span><br></pre></td></tr></table></figure></div>

<blockquote>
<p>wait-time-in-ms-when-sync-empty：当有服务还未注册时，等待的时长；默认5分钟，单位秒；</p>
</blockquote>
<h3 id="4-4-3-关闭自我保护"><a href="#4-4-3-关闭自我保护" class="headerlink" title="4.4.3 关闭自我保护"></a>4.4.3 关闭自我保护</h3><p>我们前面提到过，Eureka的自我保护机制可以保证在网络出现故障时，暂时无法发送心跳的Eureka Client不会被剔除，保护了Eureka Client；使我们的Eureka集群更加的健壮、稳定。</p>
<p>但是，需要注意的是，我们肯定希望被保护的Eureka Client是&#x3D;&#x3D;<strong>正常的</strong>&#x3D;&#x3D;，万一在保护期间某个Eureka Client下线了呢？（非正常下线）Eureka Server的保护机制也会将其”保护”起来，那么此时服务消费者就将消费一个无效的服务；</p>
<p>对于这个问题在Spring Cloud中也有对应解决方案，如服务熔断、重试、降级等等。我们也可以选择将自我保护关闭；</p>
<p>关闭Eureka Server的自我保护：</p>
<div class="highlight-container" data-rel="Yml"><figure class="iseeu highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">server:</span></span><br><span class="line">    <span class="attr">enable-self-preservation:</span> <span class="literal">false</span>       <span class="comment"># 关闭自我保护机制</span></span><br></pre></td></tr></table></figure></div>

<blockquote>
<p>Eureka Client正常下线会给Eureka Server发送一个Cancel请求，告诉Eureka Server，我正常下线了，我们主要讨论的是非正常情况下线；</p>
<p>如：程序崩溃、端口被删除、服务器宕机、断电等；</p>
</blockquote>
<h2 id="4-7-搭建-Eureka-集群"><a href="#4-7-搭建-Eureka-集群" class="headerlink" title="4.7 搭建 Eureka 集群"></a>4.7 搭建 Eureka 集群</h2><h3 id="4-7-1-Eureka-集群概述"><a href="#4-7-1-Eureka-集群概述" class="headerlink" title="4.7.1 Eureka 集群概述"></a>4.7.1 Eureka 集群概述</h3><p>我们刚刚使用的是Eureka单机版，如果Eureka Server宕机，就可能会影响到微服务的调用，甚至影响到整个应用系统的高可用。因此，在生成环境中，通常会部署一个高可用的Eureka Server集群。</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/springcloud/183.png"
                      alt="img"
                ></p>
<blockquote>
<p>在Eureka集群环境中，多个Server相互注册进行数据的同步</p>
</blockquote>
<h3 id="4-7-2-搭建Eureka-集群"><a href="#4-7-2-搭建Eureka-集群" class="headerlink" title="4.7.2 搭建Eureka 集群"></a>4.7.2 搭建Eureka 集群</h3><p>1）准备两个工程</p>
<p>2）Eureka01-application.yml</p>
<div class="highlight-container" data-rel="Yml"><figure class="iseeu highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">10101</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">eureka-server</span>    <span class="comment">#微服名称</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">true</span>   <span class="comment"># 是否将该服务注册到eureka服务端</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">true</span>         <span class="comment"># 是否从eureka服务端获取其他服务实例</span></span><br><span class="line">    <span class="attr">service-url:</span>                  <span class="comment"># eureka的注册地址</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://$&#123;spring.cloud.client.ip-address&#125;:10102/eureka</span>   <span class="comment"># 暴露的注册地址</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">localhost</span>          <span class="comment"># 主机名</span></span><br><span class="line">    <span class="attr">prefer-ip-address:</span> <span class="literal">true</span>     <span class="comment"># 使用ip地址注册</span></span><br><span class="line">    <span class="attr">instance-id:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:10101</span>  <span class="comment"># 实例id(默认的实例名是微服务名称)</span></span><br></pre></td></tr></table></figure></div>

<p>3）Eureka02-application.yml</p>
<div class="highlight-container" data-rel="Yml"><figure class="iseeu highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">10102</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">eureka02-server</span>    <span class="comment">#微服名称</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">true</span>   <span class="comment"># 是否将该服务注册到eureka服务端</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">true</span>         <span class="comment"># 是否从eureka服务端获取其他服务实例</span></span><br><span class="line">    <span class="attr">service-url:</span>                  <span class="comment"># eureka的注册地址</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://$&#123;spring.cloud.client.ip-address&#125;:10101/eureka</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">localhost</span></span><br><span class="line">    <span class="attr">prefer-ip-address:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">instance-id:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:10102</span></span><br></pre></td></tr></table></figure></div>

<p>4）同时启动两台Eureka Server</p>
<p>访问：<a class="link"   target="_blank" rel="noopener" href="http://localhost:10101/" >http://localhost:10101 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<p>访问：<a class="link"   target="_blank" rel="noopener" href="http://localhost:10102/" >http://localhost:10102 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<h3 id="4-7-3-注册服务到Eureka集群"><a href="#4-7-3-注册服务到Eureka集群" class="headerlink" title="4.7.3 注册服务到Eureka集群"></a>4.7.3 注册服务到Eureka集群</h3><p>1）修改item工程的application.yml：</p>
<div class="highlight-container" data-rel="Yml"><figure class="iseeu highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">9000</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">item-service</span>           <span class="comment"># 微服务名称</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://127.0.0.1:10101/eureka,http://127.0.0.1:10102/eureka</span>    <span class="comment"># 注册到Eureka</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">prefer-ip-address:</span> <span class="literal">true</span>         <span class="comment"># 使用ip地址注册服务(默认情况下是以主机注册)</span></span><br><span class="line">    <span class="attr">instance-id:</span> <span class="string">$&#123;spring.cloud.client.ip-address&#125;:$&#123;server.port&#125;</span>   <span class="comment"># 实例id</span></span><br></pre></td></tr></table></figure></div>

<p>2）修改order工程的application.yml：</p>
<div class="highlight-container" data-rel="Yml"><figure class="iseeu highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">9001</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">order-service</span>      <span class="comment"># 微服务名称</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://127.0.0.1:10101/eureka,http://127.0.0.1:10102/eureka</span>    <span class="comment"># 注册到Eureka</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">prefer-ip-address:</span> <span class="literal">true</span>         <span class="comment"># 使用ip地址注册服务(默认情况下是以主机注册)</span></span><br><span class="line">    <span class="attr">instance-id:</span> <span class="string">$&#123;spring.cloud.client.ip-address&#125;:$&#123;server.port&#125;</span>   <span class="comment"># 实例id</span></span><br></pre></td></tr></table></figure></div>



<blockquote>
<p>尝试关闭一台Eureka Server，在item服务发起远程调用，发现依旧可以调用成功，提高了Eureka的高可用；</p>
</blockquote>
<h2 id="4-8-Eureka-CAP-策略"><a href="#4-8-Eureka-CAP-策略" class="headerlink" title="4.8 Eureka CAP 策略"></a>4.8 Eureka CAP 策略</h2><p>CAP：即Consistency（一致性）、Availability（可用性）、Partition tolerance（分区容错性）；在一个分布式系统中，最多只能满足两个，我们在选择上必定有所舍取；</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/springcloud/182.png"
                      alt="img"
                ></p>
<p><strong>Eureka正是采用AP策略</strong>，即保证服务的可用性以及分区容错性，降低了服务的一致性；</p>
<p>Eureka Server 各个节点都是平等的，几个节点挂掉不会影响正常节点的工作，剩余的节点依然可以提供注册和查询服务，而 Eureka Client 在向某个 Eureka 注册时，如果发现连接失败，则会自动切换至其它节点。只要有一台 Eureka Server 还在，就能保证注册服务可用(保证可用性)，只不过查到的信息可能不是最新的（不保证强一致性）。</p>
<h2 id="4-9-Eureka-生命周期"><a href="#4-9-Eureka-生命周期" class="headerlink" title="4.9 Eureka 生命周期"></a>4.9 Eureka 生命周期</h2><h3 id="4-9-1-Eureka-注册-调用过程"><a href="#4-9-1-Eureka-注册-调用过程" class="headerlink" title="4.9.1 Eureka 注册&#x2F;调用过程"></a>4.9.1 Eureka 注册&#x2F;调用过程</h3><p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/springcloud/181.png"
                      alt="img"
                ></p>
<p>搭建完Eureka集群后，Eureka Server之间做复制（<code>Replicate</code>）操作同步数据；当有Eureka Client启动时，注册（<code>Register</code>）到Eureka Server中，期间不断向Eureka Server发送心跳进行续约（<code>renew</code>）操作，Eureka Server将Client的信息维护在自身的注册表中，供Client间的抓取（<code>Get Registry</code>）与调用（<code>Make Remote Call</code>），当Client正常下线时，会向Server发送一个剔除指令（<code>Cancel</code>），Eureka Server接收到后将服务从注册表中剔除；</p>
<ul>
<li><code>Register</code>：EurekaClient注册（Http请求）到EurekaServer，EurekaClient会发送自己元数据(ip,port,主页等)，EurekaServer会将其添加到服务注册列表里（Map集合）</li>
<li><code>Renew</code>：EurekaClient默认每30秒发送心跳（timer定时任务，发送Http请求）到EurekaServer续约，向EurekaServer证明其活性，EurekaServer将EurekaClient心跳中的时间戳参数与已有服务列表中对应的该服务的时间戳进行比较，不相等就更新对应的服务列表；如果EurekaServer 90秒都没收到某个EurekaClient的续约，并且没有进入保护模式，就会将该服务从服务列表将其剔除（Eviction）</li>
<li><code>Get Registry</code>：Eureka Client默认每30秒从Eureka Server获取服务注册列表，<strong>并且会与自身本地已经缓存过的服务列表进行比较合并</strong></li>
<li><code>Cancel</code>：当EurekaClient正常下线时，向EurekaServer发送Cancel，EurekaServer将其从服务列表中剔除</li>
<li><code>Make Remote Call</code>：EurekaClient服务间进行远程调用，比如通过RestTemplate+Ribbon或Fegin</li>
<li><code>Replicate</code>：EurekaServer集群节点之间数据（主要是服务注册列表信息）同步</li>
</ul>
<p>我们可以启动一台Eureka Client观察Server端控制台日志：</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/springcloud/180.png"
                      alt="img"
                ></p>
<h3 id="4-9-2-Actuator-监控"><a href="#4-9-2-Actuator-监控" class="headerlink" title="4.9.2 Actuator 监控"></a>4.9.2 Actuator 监控</h3><p>我们可以使用Spring Boot Actuator来帮我们管理Eureka Client的下线操作； </p>
<p>引入Actuator依赖：</p>
<div class="highlight-container" data-rel="Xml"><figure class="iseeu highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--actuator依赖--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></div>

<p>开放所有端点：</p>
<div class="highlight-container" data-rel="Yml"><figure class="iseeu highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">management:</span></span><br><span class="line">  <span class="attr">endpoints:</span></span><br><span class="line">    <span class="attr">web:</span></span><br><span class="line">      <span class="attr">exposure:</span></span><br><span class="line">        <span class="attr">include:</span> <span class="string">&#x27;*&#x27;</span>      <span class="comment"># 开放所有端点</span></span><br></pre></td></tr></table></figure></div>

<p>启动Order服务，访问：<a class="link"   target="_blank" rel="noopener" href="http://localhost:9001/actuator%EF%BC%9A" >http://localhost:9001/actuator： <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/springcloud/179.png"
                      alt="img"
                ></p>
<p>强制开放shutdown端点，实现手动停机：</p>
<div class="highlight-container" data-rel="Yml"><figure class="iseeu highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">management:</span></span><br><span class="line">  <span class="attr">endpoints:</span></span><br><span class="line">    <span class="attr">web:</span></span><br><span class="line">      <span class="attr">exposure:</span></span><br><span class="line">        <span class="attr">include:</span> <span class="string">&#x27;*&#x27;</span>   <span class="comment"># 开放所有端点</span></span><br><span class="line">  <span class="attr">endpoint:</span></span><br><span class="line">    <span class="attr">shutdown:</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">true</span>     <span class="comment"># 开启shutdown 实现手动停机</span></span><br></pre></td></tr></table></figure></div>

<p>重启Order服务，访问：<a class="link"   target="_blank" rel="noopener" href="http://localhost:9001/actuator%EF%BC%9A" >http://localhost:9001/actuator： <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/springcloud/178.png"
                      alt="img"
                ></p>
<p>打开Postman使用Post请求发送：<a class="link"   target="_blank" rel="noopener" href="http://localhost:9001/actuator/shutdown" >http://localhost:9001/actuator/shutdown <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/springcloud/177.png"
                      alt="img"
                ></p>
<h2 id="4-10-Eureka-安全认证"><a href="#4-10-Eureka-安全认证" class="headerlink" title="4.10 Eureka 安全认证"></a>4.10 Eureka 安全认证</h2><p>在通常情况下我们的Eureka是不能运行任意的人来访问的，也不能运行任意的访问进行注册，我们必须提供一系列的认证，Eureka 与Spring Security进行了无缝集成，可以很方便的帮助我们对Eureka的连接进行认证；</p>
<h3 id="4-10-1-配置Eureka-Server认证"><a href="#4-10-1-配置Eureka-Server认证" class="headerlink" title="4.10.1 配置Eureka Server认证"></a>4.10.1 配置Eureka Server认证</h3><p>引入Security启动器：</p>
<div class="highlight-container" data-rel="Xml"><figure class="iseeu highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--security依赖--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-security<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></div>

<p>在两台Eureka Server添加认证配置：</p>
<div class="highlight-container" data-rel="Yml"><figure class="iseeu highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">security:</span></span><br><span class="line">    <span class="attr">user:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">root</span>          <span class="comment"># 配置用户名</span></span><br><span class="line">      <span class="attr">password:</span> <span class="string">admin</span>     <span class="comment"># 配置密码</span></span><br></pre></td></tr></table></figure></div>

<p>拷贝课件提供的<code>WebSecurityConfig.java</code>类，对EurekaClient发送的注册请求进行放行；</p>
<p>启动Eureka Server，访问：<a class="link"   target="_blank" rel="noopener" href="http://localhost:10101/" >http://localhost:10101 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a>和<a class="link"   target="_blank" rel="noopener" href="http://localhost:10102/" >http://localhost:10102 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/springcloud/176.png"
                      alt="img"
                ></p>
<h3 id="4-10-2-配置Eureka-Client认证"><a href="#4-10-2-配置Eureka-Client认证" class="headerlink" title="4.10.2 配置Eureka Client认证"></a>4.10.2 配置Eureka Client认证</h3><p>Eureka Server都配置了用户名和密码，Eureka Client在注册时应该指定Server端的用户名和密码，修改Eureka Server：</p>
<div class="highlight-container" data-rel="Yml"><figure class="iseeu highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">true</span>   <span class="comment"># 是否将该服务注册到eureka服务端</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">true</span>         <span class="comment"># 是否从eureka服务端获取其他服务实例</span></span><br><span class="line">    <span class="attr">service-url:</span>                  <span class="comment"># eureka的注册地址</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://root:admin@127.0.0.1:10101/eureka</span>			<span class="comment"># 配置用户名和密码</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">prefer-ip-address:</span> <span class="literal">true</span>     <span class="comment"># 使用ip地址注册</span></span><br><span class="line">    <span class="attr">instance-id:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:10102</span></span><br></pre></td></tr></table></figure></div>

<p>修改Eureka Client：</p>
<div class="highlight-container" data-rel="Yml"><figure class="iseeu highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">9000</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">item-service</span>           <span class="comment"># 微服务名称</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://root:admin@127.0.0.1:10101/eureka,http://root:admin@127.0.0.1:10102/eureka</span>    <span class="comment"># 注册到Eureka</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">prefer-ip-address:</span> <span class="literal">true</span>         <span class="comment"># 使用ip地址注册服务(默认情况下是以主机注册)</span></span><br><span class="line">    <span class="attr">instance-id:</span> <span class="string">$&#123;spring.cloud.client.ip-address&#125;:$&#123;server.port&#125;</span>   <span class="comment"># 实例id</span></span><br></pre></td></tr></table></figure></div>

<blockquote>
<p>Order服务的注册中心配置和Item服务一致</p>
</blockquote>
<p>分别访问两台Eureka Server查看访问是否注册成为成功：</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/springcloud/175.png"
                      alt="img"
                ></p>
<h1 id="五、Netflix-Ribbon-负载均衡"><a href="#五、Netflix-Ribbon-负载均衡" class="headerlink" title="五、Netflix Ribbon 负载均衡"></a>五、Netflix Ribbon 负载均衡</h1><h2 id="5-1-Ribbon-简介"><a href="#5-1-Ribbon-简介" class="headerlink" title="5.1 Ribbon 简介"></a>5.1 Ribbon 简介</h2><p>Netflix Ribbon是一个基于HTTP和TCP的客户端<strong>负载均衡工具</strong>，通过Spring Cloud的封装，可以让我们轻松地将面向服务的REST请求自动转换成客户端负载均衡的服务调用。微服务间的调用，API网关的请求转发等内容，实际上都是通过Ribbon来实现的；</p>
<p>Ribbon的主要作用就是两个：</p>
<p>1）服务之间调用</p>
<p>2）服务调用时的负载均衡</p>
<h2 id="5-2-Ribbon-快速入门"><a href="#5-2-Ribbon-快速入门" class="headerlink" title="5.2 Ribbon 快速入门"></a>5.2 Ribbon 快速入门</h2><h3 id="5-2-1-Ribbon-服务负载均衡"><a href="#5-2-1-Ribbon-服务负载均衡" class="headerlink" title="5.2.1 Ribbon 服务负载均衡"></a>5.2.1 Ribbon 服务负载均衡</h3><p>Ribbon已经被被集成到Eureka中，我们之前在学习Eureka时就已经用过了Ribbon了；</p>
<p>在RestTemplate上添加@LoadBalanced注解之后，调用接口便自动继承了负载均衡的能力；</p>
<ul>
<li>ItemApplication：</li>
</ul>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.cloud.item;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.client.discovery.EnableDiscoveryClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.client.loadbalancer.LoadBalanced;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.netflix.eureka.EnableEurekaClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.client.RestTemplate;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> lscl</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@intro</span>:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span>      <span class="comment">// 开启服务发现功能</span></span><br><span class="line"><span class="meta">@EnableEurekaClient</span>         <span class="comment">// 开启Eureka客户端</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ItemApplication</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(ItemApplication.class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@LoadBalanced</span>           <span class="comment">// 负载均衡</span></span><br><span class="line">    <span class="keyword">public</span> RestTemplate <span class="title function_">restTemplate</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RestTemplate</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<ul>
<li>ItemController：</li>
</ul>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.cloud.item.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PathVariable;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.client.RestTemplate;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> lscl</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@intro</span>:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/item&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ItemController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RestTemplate restTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/findOrderById/&#123;orderId&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Map <span class="title function_">findOrderById</span><span class="params">(<span class="meta">@PathVariable</span> Integer orderId)</span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 使用RestTemplate进行远程调用</span></span><br><span class="line">        <span class="type">Map</span> <span class="variable">resultMap</span> <span class="operator">=</span> restTemplate.getForObject(<span class="string">&quot;http://order-service/order/&quot;</span> + orderId, Map.class);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> resultMap;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>



<ul>
<li>OrderController：</li>
</ul>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> lscl</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@intro</span>:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/order&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;spring.cloud.client.ip-address&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String ip;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;server.port&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String port;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Map <span class="title function_">findById</span><span class="params">(<span class="meta">@PathVariable</span> Integer id)</span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>()&#123;&#123;</span><br><span class="line">            put(<span class="string">&quot;flag&quot;</span>,<span class="literal">true</span>);</span><br><span class="line">            put(<span class="string">&quot;message&quot;</span>,<span class="string">&quot;查询成功&quot;</span>+ip+<span class="string">&quot;:&quot;</span>+port);</span><br><span class="line">            put(<span class="string">&quot;statusCode&quot;</span>,<span class="string">&quot;200&quot;</span>);</span><br><span class="line">            put(<span class="string">&quot;id&quot;</span>,id);</span><br><span class="line">        &#125;&#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>启动两个Order服务，访问：<a class="link"   target="_blank" rel="noopener" href="http://localhost:9001/item/findOrderById/1" >http://localhost:9001/item/findOrderById/1 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/springcloud/174.png"
                      alt="img"
                ></p>
<blockquote>
<p>多次访问，查看是否有轮询效果；</p>
</blockquote>
<h3 id="5-2-2-自定义服务列表"><a href="#5-2-2-自定义服务列表" class="headerlink" title="5.2.2 自定义服务列表"></a>5.2.2 自定义服务列表</h3><p>当我们在 <code>RestTemplate</code>上添加 <code>@LoadBalanced</code> 注解后，就可以用服务名称来调用接口了，当有多个服务的时候，还能做负载均衡。这是因为 Eureka 中的服务信息已经被拉取到了客户端本地，关系如下：</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/springcloud/173.png"
                      alt="img"
                ></p>
<p>有的时候我们希望Ribbon可以跳过Eureka，直接使用IP+端口的方式调用服务，这样的我们就不需要借助Eureka提供的服务名来远程调用了（测试环境用），我们可以自定义服务列表来实现负载均衡；</p>
<p>关闭Ribbon与Eureka的集成：</p>
<div class="highlight-container" data-rel="Yml"><figure class="iseeu highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">ribbon:</span></span><br><span class="line">  <span class="attr">eureka:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">false</span>                <span class="comment"># 关闭与Eureka的集成</span></span><br><span class="line"><span class="attr">ribbon-order-service:</span>             <span class="comment"># 自定义服务名称</span></span><br><span class="line">  <span class="attr">ribbon:</span></span><br><span class="line">    <span class="attr">listOfServers:</span> <span class="string">localhost:9001,localhost:9002</span>      <span class="comment"># 服务的主机列表</span></span><br></pre></td></tr></table></figure></div>

<blockquote>
<p>注意：默认情况下Ribbon与Eureka的集成为开启状态，在<strong>开启状态下，只能使用服务名调用</strong>；而在<strong>关闭状态下，只能使用IP+端口来调用</strong>，如果指定IP+端口的方式来调用，那么必定不能提供负载均衡的功能；<strong>如果想使用负载均衡功能，那么必须自定义服务名称，并为该服务配置主机列表；</strong></p>
</blockquote>
<ul>
<li>ItemController：</li>
</ul>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/findOrderById/&#123;orderId&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Map <span class="title function_">findOrderById</span><span class="params">(<span class="meta">@PathVariable</span> Integer orderId)</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 使用自定义的服务名称</span></span><br><span class="line">    <span class="type">Map</span> <span class="variable">resultMap</span> <span class="operator">=</span> restTemplate.getForObject(<span class="string">&quot;http://ribbon-order-service/order/&quot;</span> + orderId, Map.class);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> resultMap;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<ul>
<li>OrderController：</li>
</ul>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.cloud.order.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.cloud.order.entity.Order;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> lscl</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@intro</span>:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/order&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;spring.cloud.client.ip-address&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String ip;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;server.port&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String port;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Map <span class="title function_">findById</span><span class="params">(<span class="meta">@PathVariable</span> Integer id)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>() &#123;&#123;</span><br><span class="line">            put(<span class="string">&quot;flag&quot;</span>, <span class="literal">true</span>);</span><br><span class="line">            put(<span class="string">&quot;message&quot;</span>, <span class="string">&quot;查询成功&quot;</span> + ip + <span class="string">&quot;:&quot;</span> + port);</span><br><span class="line">            put(<span class="string">&quot;statusCode&quot;</span>, <span class="string">&quot;200&quot;</span>);</span><br><span class="line">            put(<span class="string">&quot;id&quot;</span>, id);</span><br><span class="line">        &#125;&#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>



<h2 id="5-3-Ribbon的配置"><a href="#5-3-Ribbon的配置" class="headerlink" title="5.3 Ribbon的配置"></a>5.3 Ribbon的配置</h2><h3 id="5-3-1-Ribbon-的属性配置"><a href="#5-3-1-Ribbon-的属性配置" class="headerlink" title="5.3.1 Ribbon 的属性配置"></a>5.3.1 Ribbon 的属性配置</h3><p>Ribbon的所有的默认配置可以去<code>com.netflix.client.config.DefaultClientConfigImpl</code>类下找：</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/springcloud/172.png"
                      alt="img"
                ></p>
<p>关于Ribbon的所有配置在<code>com.netflix.client.config.CommonClientConfigKey</code>中定义：</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/springcloud/171.png"
                      alt="img"
                ></p>
<h3 id="5-3-2-Ribbon常用配置"><a href="#5-3-2-Ribbon常用配置" class="headerlink" title="5.3.2 Ribbon常用配置"></a>5.3.2 Ribbon常用配置</h3><h4 id="5-3-2-1-连接配置"><a href="#5-3-2-1-连接配置" class="headerlink" title="5.3.2.1 连接配置"></a>5.3.2.1 连接配置</h4><div class="highlight-container" data-rel="Yml"><figure class="iseeu highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">ribbon:</span></span><br><span class="line">  <span class="attr">ConnectTimeout:</span> <span class="number">2000</span>           <span class="comment"># 请求连接的超时时间</span></span><br><span class="line">  <span class="attr">ReadTimeout:</span> <span class="number">5000</span>               <span class="comment"># 请求处理的超时时间</span></span><br></pre></td></tr></table></figure></div>

<blockquote>
<ul>
<li>ConnectTimeout：是指请求发送到服务，两端连接所需要的时间</li>
<li>ReadTimeout：是指建立连接后从服务端读取到可用资源所用的时间</li>
</ul>
</blockquote>
<h4 id="5-3-2-2-懒加载配置"><a href="#5-3-2-2-懒加载配置" class="headerlink" title="5.3.2.2 懒加载配置"></a>5.3.2.2 懒加载配置</h4><p>Ribbon进行客户端负载均衡的Client并不是在服务启动的时候就初始化好的，而是在调用的时候才会去创建相应的Client，所以第一次调用的耗时不仅仅包含发送HTTP请求的时间，还包含了创建RibbonClient的时间，这样一来如果创建时间速度较慢，同时设置的超时时间又比较短的话，很容易出现第一次调用超时，之后就调用正常的现象；</p>
<div class="highlight-container" data-rel="Yml"><figure class="iseeu highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">ribbon:</span></span><br><span class="line">  <span class="attr">eager-load:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span>                               			<span class="comment"># 开启立即加载客户端</span></span><br><span class="line">    <span class="attr">clients:</span> <span class="string">ribbon-order-service,ribbon02-order-service</span> 	<span class="comment"># 选择指定的服务开启立即加载</span></span><br></pre></td></tr></table></figure></div>

<h4 id="5-3-2-3-并发调整"><a href="#5-3-2-3-并发调整" class="headerlink" title="5.3.2.3 并发调整"></a>5.3.2.3 并发调整</h4><div class="highlight-container" data-rel="Yml"><figure class="iseeu highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">ribbon:</span></span><br><span class="line">  <span class="attr">MaxTotalConnections:</span> <span class="number">500</span>        <span class="comment"># 最大连接数</span></span><br><span class="line">  <span class="attr">MaxConnectionsPerHost:</span> <span class="number">100</span>      <span class="comment"># 每个host最大连接数</span></span><br></pre></td></tr></table></figure></div>



<h3 id="5-3-3-Ribbon-配置策略"><a href="#5-3-3-Ribbon-配置策略" class="headerlink" title="5.3.3 Ribbon 配置策略"></a>5.3.3 Ribbon 配置策略</h3><p>Ribbon的配置分为全局配置和指定客户端配置，两种配置格式不同；</p>
<p>全局配置针对于所有的服务，客户端配置只针对于具体服务使用；</p>
<ul>
<li>全局配置：</li>
</ul>
<div class="highlight-container" data-rel="Yml"><figure class="iseeu highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">ribbon:</span></span><br><span class="line">  <span class="attr">ConnectTimeout:</span> <span class="number">20000</span>           <span class="comment"># 请求连接的超时时间</span></span><br><span class="line">  <span class="attr">ReadTimeout:</span> <span class="number">5000</span>               <span class="comment"># 请求处理的超时时间</span></span><br></pre></td></tr></table></figure></div>

<ul>
<li>客户端配置：</li>
</ul>
<div class="highlight-container" data-rel="Yml"><figure class="iseeu highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">ribbon-order-service:</span>             					  <span class="comment"># 自定义服务名称</span></span><br><span class="line">  <span class="attr">ribbon:</span></span><br><span class="line">    <span class="attr">listOfServers:</span> <span class="string">localhost:9001,localhost:9002</span>      <span class="comment"># 服务的主机列表</span></span><br><span class="line">    <span class="attr">ConnectTimeout:</span> <span class="number">20000</span></span><br><span class="line">    <span class="attr">ReadTimeout:</span> <span class="number">5000</span></span><br></pre></td></tr></table></figure></div>

<blockquote>
<p>Tips：全局配置只针对集成Eureka时的调用，不能作用于自定义微服务名称调用；</p>
</blockquote>
<h2 id="5-4-Ribbon的负载均衡策略"><a href="#5-4-Ribbon的负载均衡策略" class="headerlink" title="5.4 Ribbon的负载均衡策略"></a>5.4 Ribbon的负载均衡策略</h2><h3 id="5-4-1-Ribbon负载均衡策略"><a href="#5-4-1-Ribbon负载均衡策略" class="headerlink" title="5.4.1 Ribbon负载均衡策略"></a>5.4.1 Ribbon负载均衡策略</h3><p>不难发现，我们之前使用Ribbon的负载均衡策略都是轮询；在Ribbon中，除了轮询策略外，还提供有其他几种策略，内部负责负载均衡的顶级接口为<code>com.netflix.loadbalancer.IRule</code>：</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/springcloud/170.png"
                      alt="img"
                ></p>
<ul>
<li><code>com.netflix.loadbalancer.RoundRobinRule</code> ：<ul>
<li><strong>轮询策略；</strong>以轮询的方式进行负载均衡。</li>
</ul>
</li>
<li><code>com.netflix.loadbalancer.WeightedResponseTimeRule</code>：<ul>
<li><strong>权重策略；</strong>会计算每个服务的权重，响应速度越快的实例选择权重越大，越高的被调用的可能性越大。</li>
</ul>
</li>
<li><code>com.netflix.loadbalancer.ResponseTimeWeightedRule</code>：<ul>
<li><strong>权重策略；</strong>作用和WeightedResponseTimeRule一致，后来改名为 WeightedResponseTimeRule</li>
</ul>
</li>
<li><code>com.netflix.loadbalancer.BestAvailableRule</code>：<ul>
<li><strong>最佳策略；</strong>首先过滤掉故障实例，在没有故障的实例中，选择一个压力最小（并发量）的服务</li>
</ul>
</li>
<li><code>com.netflix.loadbalancer.ZoneAvoidanceRule</code>：<ul>
<li><strong>回避策略；</strong>使用 ZoneAvoidancePredicate 和 AvailabilityPredicate 来判断是否选择某个 Server，前一个判断判定一个 Zone 的运行性能是否可用，剔除不可用的 的所有 Server，AvailabilityPredicate 用于过滤掉连接数过多的 Server。</li>
</ul>
</li>
<li><code>com.netflix.loadbalancer.AvailabilityFilteringRule </code>：<ul>
<li><strong>过滤策略；</strong>过滤掉故障和请求数超过阈值的服务实例，再从剩下的实例中轮询调用。</li>
</ul>
</li>
<li><code>com.netflix.loadbalancer.RandomRule</code> ：<ul>
<li><strong>随机策略；</strong>在服务列表中随机选择一个服务调用；</li>
</ul>
</li>
<li><code>com.netflix.loadbalancer.RetryRule</code>：<ul>
<li><strong>重试策略；</strong>在RoundRobinRule的基础上添加重试机制，即在指定的重试时间内服务未响应，则继续使用轮询方式访问其他服务；</li>
</ul>
</li>
</ul>
<h3 id="5-4-1-修改Ribbon负载均衡策略"><a href="#5-4-1-修改Ribbon负载均衡策略" class="headerlink" title="5.4.1 修改Ribbon负载均衡策略"></a>5.4.1 修改Ribbon负载均衡策略</h3><ul>
<li>配置文件方式修改负载均衡策略：基于自定义服务名调用</li>
</ul>
<div class="highlight-container" data-rel="Yml"><figure class="iseeu highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">ribbon:</span></span><br><span class="line">  <span class="attr">eureka:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">false</span>                <span class="comment"># 关闭与Eureka的集成</span></span><br><span class="line"><span class="attr">ribbon-order-service:</span>     		<span class="comment"># 只修改ribbon-order-service这个服务的负载均衡策略</span></span><br><span class="line">  <span class="attr">ribbon:</span></span><br><span class="line">    <span class="attr">NFLoadBalancerRuleClassName:</span> <span class="string">com.netflix.loadbalancer.RandomRule</span>			<span class="comment"># 随机策略</span></span><br><span class="line">    <span class="attr">listOfServers:</span> <span class="string">localhost:9001,localhost:9002,localhost:9003</span>      <span class="comment"># 服务的主机列表</span></span><br></pre></td></tr></table></figure></div>



<ul>
<li>基于Eureka服务名调用：</li>
</ul>
<div class="highlight-container" data-rel="Yml"><figure class="iseeu highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">ribbon:</span></span><br><span class="line">  <span class="attr">NFLoadBalancerRuleClassName:</span> <span class="string">com.netflix.loadbalancer.RandomRule</span></span><br></pre></td></tr></table></figure></div>



<ul>
<li>配置类方式修改负载均衡策略：</li>
</ul>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 随机策略</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> RandomRule <span class="title function_">randomRule</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RandomRule</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<blockquote>
<p>tips：同时指定了配置文件和类的方式时，<strong>以加载的负载均衡类为准；</strong></p>
</blockquote>
<h1 id="六、Netflix-Feign-服务调用"><a href="#六、Netflix-Feign-服务调用" class="headerlink" title="六、Netflix Feign 服务调用"></a>六、Netflix Feign 服务调用</h1><h2 id="6-1-Feign-简介"><a href="#6-1-Feign-简介" class="headerlink" title="6.1 Feign 简介"></a>6.1 Feign 简介</h2><p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/springcloud/169.png"
                      alt="img"
                ></p>
<p>我们在Java使用接口调用时，可以借助HttpClient、OkHttp、HttpURLConnection以及我们之前一直在使用的RestTemplate等工具来完成接口调用的功能；我们接下来要学习的Feign也是来帮我们做接口调用的；在SpringCloud中，使用Feign非常简单创建一个接口，并在接口上添加一些注解，就可以实现远程调用，在Feign中我们只需要像调用方法一样调用它就可以完成服务请求及相关处理；</p>
<blockquote>
<p>Feign 可以与 Eureka 和 Ribbon 组合使用以支持负载均衡</p>
</blockquote>
<ul>
<li><p>Feign和Ribbon的关系：</p>
<ul>
<li><strong>Ribbon</strong>是一个基于 HTTP和TCP客户端的负载均衡的工具。它可以在客户端配置服务端列表（listOfServers），使用RestTemplate、HttpClient等模拟http请求；使用步骤相对繁琐</li>
<li><strong>Feign</strong> 是在 Ribbon的基础上进行了一次改进，是一个使用起来更加方便的 HTTP 客户端。采用接口+方法的方式， 只需要创建一个接口，然后在上面添加注解，提供对应的方法即可；这个过程不需要自己构建http请求。就像是调用自身工程的方法调用，而感觉不到是调用远程方法，使得编写客户端变得非常容易</li>
</ul>
</li>
</ul>
<h2 id="6-2-Feign-快速入门"><a href="#6-2-Feign-快速入门" class="headerlink" title="6.2 Feign 快速入门"></a>6.2 Feign 快速入门</h2><p>1）引入Spring Cloud OpenFeign依赖：</p>
<div class="highlight-container" data-rel="Xml"><figure class="iseeu highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--Feign依赖--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></div>

<p>2）在启动类上标注注解：</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableFeignClients</span>			<span class="comment">// 开启Feign客户端</span></span><br></pre></td></tr></table></figure></div>

<p>3）建立接口：</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.cloud.item.client;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.openfeign.FeignClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PathVariable;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> lscl</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@intro</span>:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@FeignClient(&quot;order-service&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">OrderClient</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/order/&#123;id&#125;&quot;)</span></span><br><span class="line">    Map <span class="title function_">findById</span><span class="params">(<span class="meta">@PathVariable</span> Integer id)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h2 id="6-3-Feign的负载均衡"><a href="#6-3-Feign的负载均衡" class="headerlink" title="6.3 Feign的负载均衡"></a>6.3 Feign的负载均衡</h2><p>Feign集成了Ribbon，大多数和Ribbon有关的配置都是一样的配置方法；</p>
<ul>
<li>全局：</li>
</ul>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 配置负载均衡器</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> RandomRule <span class="title function_">randomRule</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RandomRule</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>



<ul>
<li>针对某个微服务：</li>
</ul>
<div class="highlight-container" data-rel="Yml"><figure class="iseeu highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">order-service:</span>                      <span class="comment"># 微服务名称</span></span><br><span class="line">  <span class="attr">ribbon:</span>     </span><br><span class="line">    <span class="attr">NFLoadBalancerRuleClassName:</span> <span class="string">com.netflix.loadbalancer.RandomRule</span></span><br></pre></td></tr></table></figure></div>

<h2 id="6-4-请求压缩"><a href="#6-4-请求压缩" class="headerlink" title="6.4 请求压缩"></a>6.4 请求压缩</h2><h3 id="6-4-1-Gzip-压缩简介"><a href="#6-4-1-Gzip-压缩简介" class="headerlink" title="6.4.1 Gzip 压缩简介"></a>6.4.1 Gzip 压缩简介</h3><p>Gzip是一种压缩过后的文件，采用deflate压缩算法，Gzip主要用来压缩html,css,javascript,等静态文本文件，也支持对动态生成的，包括CGI、PHP、JSP、ASP、Servlet、SHTML等输出的网页也能进行压缩。Gzip压缩的比率通常在3~10倍之间，这样可以大大节省服务器的网络带宽，大大提升浏览器的浏览速度。</p>
<ul>
<li>HTTP对Gzip的支持：</li>
</ul>
<p><strong>HTTP 协议支持Gzip压缩机制，也称协议压缩。HTTP Gzip压缩是由WEB服务器和浏览器共同遵守的协议，也就是说WEB服务器和浏览器都必须遵守。目前主流的服务器和浏览器都支持GZIP压缩技术。包括 Chrome、IE、FireFox、Opera 等；服务器有Tomcat、Apache 和 IIS 等。</strong></p>
<blockquote>
<p>我们一般发送请求都是使用浏览器，遵循HTTP协议，HTTP对Gzip压缩有非常好的支持；但是如果我的的客户端改为了HttpClient、RestTemplate等其他组件，那么就不支持Gzip压缩了；</p>
</blockquote>
<h3 id="6-4-2-如何使用Gzip压缩"><a href="#6-4-2-如何使用Gzip压缩" class="headerlink" title="6.4.2 如何使用Gzip压缩"></a>6.4.2 如何使用Gzip压缩</h3><p>目前主流的浏览器和服务器都支持Gzip压缩，我们要做的只是开启Gzip压缩；</p>
<p>1）客户端发送http请求，如果请求头中携带<code>Accept-Encoding: gzip,deflate</code> ，表示告诉服务器需要进行Gzip压缩；</p>
<p>2）服务器在接收请求头上携带有<code>Accept-Encoding: gzip,deflate</code>的请求时，会对响应内容进行压缩，并在响应头中添加<code>Content-Encoding: gzip</code>；表示响应的内容是经过压缩的；如果不符合，那么将不压缩，直接返回。</p>
<p>3）客户端接收到响应后，如果响应头中包含<code>Content-Encoding: gzip</code>那么浏览器会自动将响应内容进行Gzip解压缩，然后再呈现在页面上。如果不包含，那么将直接呈现在页面上。</p>
<blockquote>
<p>Tips：Gzip压缩需要客户端（浏览器）与服务器端（Tomcat）双方的支持；</p>
</blockquote>
<p>我们打开浏览器，访问<a class="link"   target="_blank" rel="noopener" href="http://www.baidu.com/" >http://www.baidu.com <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a>；打开抓包工具，查看请求头是否有携带<code>Accept-Encoding: gzip,deflate</code></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/springcloud/168.png"
                      alt="img"
                ></p>
<blockquote>
<p>Tips：百度首页的请求已经告诉服务器，需要进行Gzip压缩；</p>
</blockquote>
<p>查看响应头是否有携带<code>Content-Encoding: gzip</code></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/springcloud/167.png"
                      alt="img"
                ></p>
<h3 id="6-4-3-Tomcat-Gzip压缩配置"><a href="#6-4-3-Tomcat-Gzip压缩配置" class="headerlink" title="6.4.3 Tomcat Gzip压缩配置"></a>6.4.3 Tomcat Gzip压缩配置</h3><p>在Tomcat&#x2F;conf&#x2F;server.xml下配置：</p>
<div class="highlight-container" data-rel="Xml"><figure class="iseeu highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Connector</span> <span class="attr">port</span>=<span class="string">&quot;8080&quot;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">protocol</span>=<span class="string">&quot;HTTP/1.1&quot;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">connectionTimeout</span>=<span class="string">&quot;20000&quot;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">redirectPort</span>=<span class="string">&quot;8443&quot;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">compression</span>=<span class="string">&quot;on&quot;</span>					</span></span><br><span class="line"><span class="tag">  <span class="attr">compressionMinSize</span>=<span class="string">&quot;2048&quot;</span>			</span></span><br><span class="line"><span class="tag">  <span class="attr">noCompressionUserAgents</span>=<span class="string">&quot;firefox&quot;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">compressableMimeType</span>=<span class="string">&quot;text/html,text/xml,text/javascript,</span></span></span><br><span class="line"><span class="string"><span class="tag">application/javascript,text/css,text/plain,text/json&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure></div>

<ul>
<li><code>compression</code>：是否开启Gzip压缩，on：开启压缩，off：关闭压缩，force：任何情况下都开启压缩；</li>
<li><code>compressionMinSize</code>：最小的压缩大小，如果文件小于这个大小则不进行压缩；单位B，默认为2048B；</li>
<li><code>noCompressionUserAgents</code>：设置指定的浏览器不压缩；默认所有的浏览器都压缩；多个浏览器使用逗号隔开</li>
<li><code>compressableMimeType</code>：指定会被压缩的MIME类型列表，多个使用逗号隔开；</li>
</ul>
<h3 id="6-4-4-Feign对Gzip的支持"><a href="#6-4-4-Feign对Gzip的支持" class="headerlink" title="6.4.4 Feign对Gzip的支持"></a>6.4.4 Feign对Gzip的支持</h3><p>我们前面说到HTTP协议对Gzip有很好的支持，但是如果我们的客户端换成了HttpClient或者其他，那么就不再支持Gzip压缩了；好在Feign对Gzip有很好的支持，我们在使用Feign对其调用时，也可以使用Gzip压缩；</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/springcloud/166.png"
                      alt="img"
                ></p>
<p>Feign开启Gzip压缩：</p>
<div class="highlight-container" data-rel="Yml"><figure class="iseeu highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">feign:</span></span><br><span class="line">  <span class="attr">compression:</span></span><br><span class="line">    <span class="attr">request:</span></span><br><span class="line">      <span class="attr">mime-types:</span> <span class="string">text/html,application/json</span>      <span class="comment"># 配置指定的MIME类型才压缩</span></span><br><span class="line">      <span class="attr">min-request-size:</span> <span class="number">100</span>                        <span class="comment"># 配置最小的压缩大小(小于此大小的文件不压缩)</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">true</span>         <span class="comment"># 开启请求Gzip压缩</span></span><br><span class="line">    <span class="attr">response:</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">true</span>         <span class="comment"># 开启响应Gzip压缩</span></span><br></pre></td></tr></table></figure></div>

<blockquote>
<p>Tips：开启Feign的压缩之后，使用Feign进行远程调用时，就进行请求的压缩；</p>
</blockquote>
<p>开启Item服务器的Gzip压缩：</p>
<div class="highlight-container" data-rel="Yml"><figure class="iseeu highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">9000</span></span><br><span class="line">  <span class="attr">compression:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span>     <span class="comment"># 开启服务器的Gzip压缩</span></span><br></pre></td></tr></table></figure></div>

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/springcloud/165.png"
                      alt="img"
                ></p>
<blockquote>
<p>Tips：我们进行浏览器抓包只是能看到Item服务器对浏览器响应的请求结果做了压缩，并不能看到Feign的Gzip压缩，我们可以配置Feign的日志来观察；</p>
</blockquote>
<h2 id="6-5-Feign的日志支持"><a href="#6-5-Feign的日志支持" class="headerlink" title="6.5 Feign的日志支持"></a>6.5 Feign的日志支持</h2><p>在开发或者运行阶段往往希望看到Feign请求过程的日志记录，默认情况下Feign的日志是没有开启的。我们可以通过配置文件或者配置类的方式来配置Feign在调用时的日志输出；</p>
<ul>
<li>Feign日志级别有4种：<ul>
<li><code>NONE</code>：不记录任何日志（默认值）</li>
<li><code>BASIC</code>：仅记录请求方法、URL、响应状态代码以及执行时间</li>
<li><code>HEADERS</code>：记录BASIC级别的基础上，记录请求和响应的头信息。</li>
<li><code>FULL</code>：记录请求和响应的header、body，一般用于测试环境</li>
</ul>
</li>
<li>1）配置文件方式，修改<code>application.yml</code>配置文件：</li>
</ul>
<div class="highlight-container" data-rel="Yml"><figure class="iseeu highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">feign:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">      <span class="attr">order-service:</span>        <span class="comment"># 调用哪个服务需要开启日志</span></span><br><span class="line">        <span class="attr">loggerLevel:</span> <span class="string">FULL</span>   <span class="comment"># 日志的级别</span></span><br><span class="line"><span class="attr">logging:</span>                    <span class="comment"># logging配置配置</span></span><br><span class="line">  <span class="attr">level:</span></span><br><span class="line">    <span class="attr">com.cloud.item.client.OrderClient:</span> <span class="string">debug</span>      <span class="comment"># 开启debug日志</span></span><br></pre></td></tr></table></figure></div>

<p>访问<a class="link"   target="_blank" rel="noopener" href="http://localhost:9000/item/findOrderById/1%EF%BC%8C%E8%A7%82%E5%AF%9Fitem%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%9A%84%E6%8E%A7%E5%88%B6%E5%8F%B0%EF%BC%9A" >http://localhost:9000/item/findOrderById/1，观察item服务器的控制台： <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/springcloud/164.png"
                      alt="img"
                ></p>
<ul>
<li>2）配置类的方式：</li>
</ul>
<p>编写配置类：</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.cloud.item;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> feign.Logger;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> lscl</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@intro</span>: Feign的配置</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FeignClientConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    Logger.Level <span class="title function_">feignLoggerLevel</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Logger.Level.FULL;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>配置类：</p>
<div class="highlight-container" data-rel="Yml"><figure class="iseeu highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">logging:</span>                    <span class="comment"># logging配置配置</span></span><br><span class="line">  <span class="attr">level:</span></span><br><span class="line">    <span class="attr">com.cloud.item.client.OrderClient:</span> <span class="string">debug</span>      <span class="comment"># debug级别</span></span><br></pre></td></tr></table></figure></div>

<p>FeignClient：</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.cloud.item.client;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.cloud.item.FeignClientConfig;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.openfeign.FeignClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.openfeign.FeignClientProperties;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PathVariable;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> lscl</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@intro</span>:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@FeignClient(value = &quot;order-service&quot;,configuration = FeignClientConfig.class)</span>           <span class="comment">// 指定配置类</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">OrderClient</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/order/&#123;id&#125;&quot;)</span></span><br><span class="line">    Map <span class="title function_">findById</span><span class="params">(<span class="meta">@PathVariable</span> Integer id)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<blockquote>
<p>重启服务器，访问<a class="link"   target="_blank" rel="noopener" href="http://localhost:9000/item/findOrderById/1%EF%BC%8C%E8%A7%82%E5%AF%9F%E6%8E%A7%E5%88%B6%E5%8F%B0" >http://localhost:9000/item/findOrderById/1，观察控制台 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
</blockquote>
<h1 id="七、Netflix-Hystrix-服务熔断"><a href="#七、Netflix-Hystrix-服务熔断" class="headerlink" title="七、Netflix Hystrix 服务熔断"></a>七、Netflix Hystrix 服务熔断</h1><h2 id="7-1-Hystrix-简介"><a href="#7-1-Hystrix-简介" class="headerlink" title="7.1 Hystrix 简介"></a>7.1 Hystrix 简介</h2><h3 id="7-1-1-雪崩效应"><a href="#7-1-1-雪崩效应" class="headerlink" title="7.1.1 雪崩效应"></a>7.1.1 雪崩效应</h3><p>在微服务架构中通常会有多个服务级联的调用，在级联调用过程中，某个下游服务如果出现故障或阻塞，很可能造成服务的消费者也处于阻塞状态，造成线程资源占用，如果此时有大量请求访问，线程资源很容易被销毁完毕，导致整个系统的瘫痪；这种现象被称为服务<strong>雪崩效应</strong>。服务雪崩效应是一种因“服务提供者”的不可用导致“服务消费者”的不可用，并将不可用逐渐放大的过程。</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/springcloud/163.png"
                      alt="img"
                ></p>
<p>如果上图所示：积分服务的不可用导致了订单服务的不可用，订单服务的不可用导致了商品服务的不可用；最终就跟滚雪球一样越放越大，造成雪崩效应；</p>
<h3 id="7-1-2-Hystrix-简介"><a href="#7-1-2-Hystrix-简介" class="headerlink" title="7.1.2 Hystrix 简介"></a>7.1.2 Hystrix 简介</h3><p>Hystrix的中文含义是豪猪，因其背上长满了刺，而拥有自我保护能力。</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/springcloud/134.png"
                      alt="img"
                ></p>
<p>在微服务架构下，很多服务都相互依赖，如果不能对依赖的服务进行隔离，那么服务本身也有可能发生故障，Hystrix 通过 HystrixCommand 对调用进行隔离，这样可以阻止故障的连锁效应，能够让接口调用快速失败并迅速恢复正常，或者回退并优雅降级。</p>
<p>Hystrix 是 Netflix 针对微服务分布式系统采用的熔断保护中间件，用于防止服务的&#x3D;&#x3D;雪崩效应；&#x3D;&#x3D;</p>
<p>Hystrix提供的功能：</p>
<ul>
<li>1）对远程调用产生的延迟和故障进行控制和保护</li>
<li>2）防止系统的服务级联瘫痪</li>
<li>3）提供回退、限流、降级等操作保护下游微服务</li>
<li>4）提供服务监控、警报等操作</li>
</ul>
<h2 id="7-2-Hystrix-快速入门"><a href="#7-2-Hystrix-快速入门" class="headerlink" title="7.2 Hystrix 快速入门"></a>7.2 Hystrix 快速入门</h2><h3 id="7-2-1-测试方法降级"><a href="#7-2-1-测试方法降级" class="headerlink" title="7.2.1 测试方法降级"></a>7.2.1 测试方法降级</h3><p>1）在服务提供者提供接口（Order服务）：</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.cloud.order.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.cloud.order.entity.Order;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> lscl</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@intro</span>:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/order&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 测试hystrix远程调用</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> flag</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/testHystrix/&#123;flag&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Map <span class="title function_">testHystrix</span><span class="params">(<span class="meta">@PathVariable</span> String flag)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&quot;0&quot;</span>.equals(flag)) &#123;</span><br><span class="line">            <span class="comment">// 模拟异常</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span> / <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&quot;1&quot;</span>.equals(flag)) &#123;</span><br><span class="line">            <span class="comment">// 模拟阻塞</span></span><br><span class="line">            Thread.sleep(<span class="number">1500</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>() &#123;&#123;</span><br><span class="line">            put(<span class="string">&quot;flag&quot;</span>, <span class="literal">true</span>);</span><br><span class="line">            put(<span class="string">&quot;message&quot;</span>, <span class="string">&quot;请求成功&quot;</span>);</span><br><span class="line">            put(<span class="string">&quot;statusCode&quot;</span>, <span class="string">&quot;200&quot;</span>);</span><br><span class="line">        &#125;&#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>2）在<strong>服务消费者</strong>（Item服务）引入Hystrix相关依赖：</p>
<div class="highlight-container" data-rel="Xml"><figure class="iseeu highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--hystrix依赖--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-hystrix<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></div>

<p>3）在引导类中开启Hystrix：</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableCircuitBreaker</span>       <span class="comment">// 开启微服务熔断</span></span><br></pre></td></tr></table></figure></div>

<p>4）在服务消费者提供降级方法：</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.cloud.item.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.netflix.hystrix.contrib.javanica.annotation.HystrixCommand;</span><br><span class="line"><span class="keyword">import</span> com.netflix.ribbon.proxy.annotation.Hystrix;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.netflix.hystrix.EnableHystrix;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PathVariable;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.client.RestTemplate;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> lscl</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@intro</span>:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/item&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ItemController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RestTemplate restTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 测试Hystrix接口</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> flag</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@HystrixCommand(fallbackMethod = &quot;fallBack&quot;)</span>            <span class="comment">// 降级方法</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/testHystrix/&#123;flag&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Map <span class="title function_">findOrderById</span><span class="params">(<span class="meta">@PathVariable</span> String flag)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">Map</span> <span class="variable">resultMap</span> <span class="operator">=</span> restTemplate.getForObject(<span class="string">&quot;http://order-service/order/testHystrix/&quot;</span> + flag, Map.class);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> resultMap;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 降级方法</span></span><br><span class="line">    <span class="keyword">public</span> Map <span class="title function_">fallBack</span><span class="params">(String flag)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">Map</span> <span class="variable">fallBackMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>() &#123;&#123;</span><br><span class="line">            put(<span class="string">&quot;flag&quot;</span>, <span class="literal">true</span>);</span><br><span class="line">            put(<span class="string">&quot;message&quot;</span>, <span class="string">&quot;触发降级方法！&quot;</span>);</span><br><span class="line">            put(<span class="string">&quot;statusCode&quot;</span>, <span class="string">&quot;400&quot;</span>);</span><br><span class="line">            put(<span class="string">&quot;flag&quot;</span>, flag);</span><br><span class="line">        &#125;&#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> fallBackMap;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>访问：<a class="link"   target="_blank" rel="noopener" href="http://localhost:9000/item/testHystrix/0%E3%80%81http://localhost:9000/item/testHystrix/1" >http://localhost:9000/item/testHystrix/0、http://localhost:9000/item/testHystrix/1 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/springcloud/162.png"
                      alt="img"
                ></p>
<blockquote>
<p>&#x3D;&#x3D;注意：降级方法的<strong>参数列表、返回值</strong>等必须和业务方法保持一致；&#x3D;&#x3D;</p>
</blockquote>
<h3 id="7-2-2-超时降级"><a href="#7-2-2-超时降级" class="headerlink" title="7.2.2 超时降级"></a>7.2.2 超时降级</h3><p>我们在配置方法降级后，不仅是Order服务出现异常之后会触发降级方法，如果Order服务出现超时响应Feign也会触发降级方法；默认情况下，使用Feign在远程调用时，<strong>默认1秒钟</strong>，如果访问未响应则触发降级方法，在实际开发中，我们可以针对于不同的情况酌情调整；</p>
<p>修改Feign的超时时间：</p>
<div class="highlight-container" data-rel="Yml"><figure class="iseeu highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">hystrix:</span></span><br><span class="line">  <span class="attr">command:</span></span><br><span class="line">    <span class="attr">default:</span></span><br><span class="line">      <span class="attr">execution:</span></span><br><span class="line">        <span class="attr">isolation:</span></span><br><span class="line">          <span class="attr">thread:</span></span><br><span class="line">            <span class="attr">timeoutInMilliseconds:</span> <span class="number">2000</span>       <span class="comment"># 修改超时时间为2s</span></span><br></pre></td></tr></table></figure></div>

<p>再次访问：<a class="link"   target="_blank" rel="noopener" href="http://localhost:9000/item/testHystrix/1" >http://localhost:9000/item/testHystrix/1 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<p>发现请求能够正常响应；</p>
<h2 id="7-3-Hystrix处理高并发策略"><a href="#7-3-Hystrix处理高并发策略" class="headerlink" title="7.3 Hystrix处理高并发策略"></a>7.3 Hystrix处理高并发策略</h2><h3 id="7-3-1-准备测试环境"><a href="#7-3-1-准备测试环境" class="headerlink" title="7.3.1 准备测试环境"></a>7.3.1 准备测试环境</h3><ul>
<li>1）修改OrderController：</li>
</ul>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.cloud.order.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.cloud.order.entity.Order;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> lscl</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@intro</span>:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/order&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;spring.cloud.client.ip-address&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String ip;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;server.port&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String port;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据id查询</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Map <span class="title function_">findById</span><span class="params">(<span class="meta">@PathVariable</span> Integer id)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>() &#123;&#123;</span><br><span class="line">            put(<span class="string">&quot;flag&quot;</span>, <span class="literal">true</span>);</span><br><span class="line">            put(<span class="string">&quot;message&quot;</span>, <span class="string">&quot;查询成功&quot;</span> + ip + <span class="string">&quot;:&quot;</span> + port);</span><br><span class="line">            put(<span class="string">&quot;statusCode&quot;</span>, <span class="string">&quot;200&quot;</span>);</span><br><span class="line">            put(<span class="string">&quot;id&quot;</span>, id);</span><br><span class="line">        &#125;&#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询全部</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping</span></span><br><span class="line">    <span class="keyword">public</span> Map <span class="title function_">findAll</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 模拟线程阻塞</span></span><br><span class="line">        Thread.sleep(<span class="number">3000</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>() &#123;&#123;</span><br><span class="line">            put(<span class="string">&quot;flag&quot;</span>, <span class="literal">true</span>);</span><br><span class="line">            put(<span class="string">&quot;message&quot;</span>, <span class="string">&quot;查询成功全部成功;&quot;</span> + ip + <span class="string">&quot;:&quot;</span> + port);</span><br><span class="line">            put(<span class="string">&quot;statusCode&quot;</span>, <span class="string">&quot;200&quot;</span>);</span><br><span class="line">        &#125;&#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<ul>
<li>2）修改ItemController：</li>
</ul>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/item&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ItemController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RestTemplate restTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/findOrderById/&#123;orderId&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Map <span class="title function_">findOrderById</span><span class="params">(<span class="meta">@PathVariable</span> Integer orderId)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">Map</span> <span class="variable">resultMap</span> <span class="operator">=</span> restTemplate.getForObject(<span class="string">&quot;http://order-service/order/&quot;</span> + orderId, Map.class);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> resultMap;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/findOrderAll&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Map <span class="title function_">findOrderAll</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">Map</span> <span class="variable">resultMap</span> <span class="operator">=</span> restTemplate.getForObject(<span class="string">&quot;http://order-service/order/&quot;</span>, Map.class);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> resultMap;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="7-3-2-JMeter测试工具"><a href="#7-3-2-JMeter测试工具" class="headerlink" title="7.3.2 JMeter测试工具"></a>7.3.2 JMeter测试工具</h3><h4 id="7-3-2-1-JMeter简介"><a href="#7-3-2-1-JMeter简介" class="headerlink" title="7.3.2.1 JMeter简介"></a>7.3.2.1 JMeter简介</h4><p>Apache JMeter是Apache组织开发的基于Java的压力测试工具。用于对软件做压力测试， 它可以用于测试静态和动态资源，例如静态文件、Java <a class="link"   target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E5%B0%8F%E6%9C%8D%E5%8A%A1%E7%A8%8B%E5%BA%8F/4148836" >小服务程序 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a>、CGI 脚本、Java 对象、数据库、<a class="link"   target="_blank" rel="noopener" href="https://baike.baidu.com/item/FTP/13839" >FTP <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a> 服务器， 等等。JMeter 可以用于对服务器、网络或对象模拟巨大的负载，来自不同压力类别下测试它们的强度和分析整体性能。</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/springcloud/161.png"
                      alt="img"
                ></p>
<blockquote>
<p>JMeter官网：<a class="link"   target="_blank" rel="noopener" href="https://jmeter.apache.org/" >https://jmeter.apache.org/ <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
</blockquote>
<h4 id="7-3-2-2-JMeter的使用"><a href="#7-3-2-2-JMeter的使用" class="headerlink" title="7.3.2.2 JMeter的使用"></a>7.3.2.2 JMeter的使用</h4><p>1）添加线程组</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/springcloud/160.png"
                      alt="img"
                ></p>
<p>2）配置并发参数：</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/springcloud/157.png"
                      alt="img"
                ></p>
<p>3）添加HTTP请求：</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/springcloud/159.png"
                      alt="img"
                ></p>
<p>4）配置HTTP请求参数：</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/springcloud/158.png"
                      alt="img"
                ></p>
<p>5）配置结果取样器：</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/springcloud/156.png"
                      alt="img"
                ></p>
<p>6）启动并发请求：</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/springcloud/155.png"
                      alt="img"
                ></p>
<p>与此同时，在浏览器发送一个<a class="link"   target="_blank" rel="noopener" href="http://localhsot:9000/item/findOrderById/1%E7%9A%84%E8%AF%B7%E6%B1%82%EF%BC%88%E6%AD%A3%E5%B8%B8%E8%AF%B7%E6%B1%82%EF%BC%89%EF%BC%8C%E6%89%93%E5%BC%80F12%EF%BC%8C%E6%9F%A5%E7%9C%8B%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%9A%84%E5%93%8D%E5%BA%94%E6%97%B6%E9%97%B4%EF%BC%9A" >http://localhsot:9000/item/findOrderById/1的请求（正常请求），打开F12，查看服务器的响应时间： <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/springcloud/154.png"
                      alt="img"
                ></p>
<p>我们发现在高并发情况下，如果有太多的连接被其他不可用（超时）的服务占用会导致正常的服务访问也有会有问题；</p>
<h2 id="7-4-服务隔离"><a href="#7-4-服务隔离" class="headerlink" title="7.4 服务隔离"></a>7.4 服务隔离</h2><p>我们刚刚使用JMeter演示了高并发场景下的雪崩效应；当有某个微服务不能够立即响应时，那么会占用当前连接资源，总的线程连接资源是有限的，如果在微服务调用链路中，有非常多的超时连接无法立即响应时，那么势必会造成其他正常服务的调用超时（因为连接都被超时调用的服务占用）；为此Hystrix提供有两种的服务隔离策略，分别为<strong>线程池隔离</strong>和<strong>信号量隔离</strong>；</p>
<h3 id="7-4-1-线程池隔离"><a href="#7-4-1-线程池隔离" class="headerlink" title="7.4.1 线程池隔离"></a>7.4.1 线程池隔离</h3><p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/springcloud/153.png"
                      alt="img"
                ></p>
<p>没有进行线程池隔离前，项目的所有接口都运行在一个线程池中，当某个接口压力过大时容易耗尽整个线程池中的所有线程，如果这个接口出现超时或故障时，那么其他正常的接口将会一直处于等待状态；</p>
<p><strong>线程池隔离将某几个接口（访问量大的）分配一个独立的线程池</strong>，如果系统流量大时，那么最多只会耗尽该线程池中的资源，对整体的项目不会有很大的影响；</p>
<ul>
<li>修改ItemController：</li>
</ul>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.cloud.item.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.netflix.hystrix.contrib.javanica.annotation.HystrixCollapser;</span><br><span class="line"><span class="keyword">import</span> com.netflix.hystrix.contrib.javanica.annotation.HystrixCommand;</span><br><span class="line"><span class="keyword">import</span> com.netflix.hystrix.contrib.javanica.annotation.HystrixProperty;</span><br><span class="line"><span class="keyword">import</span> com.netflix.ribbon.proxy.annotation.Hystrix;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.netflix.hystrix.EnableHystrix;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.*;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.client.RestTemplate;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> lscl</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@intro</span>:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/item&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ItemController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RestTemplate restTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@HystrixCommand(</span></span><br><span class="line"><span class="meta">            // 服务组名称,用于一个服务组保护多个接口(多个接口使用的服务组名称一致即可)</span></span><br><span class="line"><span class="meta">            groupKey = &quot;item-orderService&quot;,</span></span><br><span class="line"><span class="meta">            // 接口名称,默认为方法名(名称任意)</span></span><br><span class="line"><span class="meta">            commandKey = &quot;abc-findOrderById&quot;,</span></span><br><span class="line"><span class="meta">            // 线程池名称</span></span><br><span class="line"><span class="meta">            threadPoolKey = &quot;item-orderService-findOrderByIdPool&quot;,</span></span><br><span class="line"><span class="meta">            commandProperties = &#123;</span></span><br><span class="line"><span class="meta">                    @HystrixProperty(</span></span><br><span class="line"><span class="meta">                            // 超时时间,默认为1000ms</span></span><br><span class="line"><span class="meta">                            name = &quot;execution.isolation.thread.timeoutInMilliseconds&quot;,</span></span><br><span class="line"><span class="meta">                            value = &quot;10000&quot;</span></span><br><span class="line"><span class="meta">                    ),</span></span><br><span class="line"><span class="meta">                    // 线程池隔离策略(默认值)</span></span><br><span class="line"><span class="meta">                    @HystrixProperty(name = HystrixPropertiesManager.EXECUTION_ISOLATION_STRATEGY, value = &quot;THREAD&quot;),</span></span><br><span class="line"><span class="meta">            &#125;,</span></span><br><span class="line"><span class="meta">            threadPoolProperties = &#123;</span></span><br><span class="line"><span class="meta">                    // 线程池大小</span></span><br><span class="line"><span class="meta">                    @HystrixProperty(name = &quot;coreSize&quot;, value = &quot;2&quot;),</span></span><br><span class="line"><span class="meta">                    // 队列等待阈值</span></span><br><span class="line"><span class="meta">                    @HystrixProperty(name = &quot;maxQueueSize&quot;, value = &quot;2&quot;),</span></span><br><span class="line"><span class="meta">            &#125;,</span></span><br><span class="line"><span class="meta">            fallbackMethod = &quot;findOrderByIdFallBack&quot;            // 降级方法</span></span><br><span class="line"><span class="meta">    )</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/findOrderById/&#123;orderId&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Map <span class="title function_">findOrderById</span><span class="params">(<span class="meta">@PathVariable</span> Integer orderId)</span> &#123;</span><br><span class="line"></span><br><span class="line">        System.out.println(Thread.currentThread().getName());</span><br><span class="line">        <span class="type">Map</span> <span class="variable">resultMap</span> <span class="operator">=</span> restTemplate.getForObject(<span class="string">&quot;http://order-service/order/&quot;</span> + orderId, Map.class);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> resultMap;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * findOrderById降级方法</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> flag</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> Map <span class="title function_">findOrderByIdFallBack</span><span class="params">(Integer flag)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">Map</span> <span class="variable">fallBackMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>() &#123;&#123;</span><br><span class="line">            put(<span class="string">&quot;flag&quot;</span>, <span class="literal">true</span>);</span><br><span class="line">            put(<span class="string">&quot;message&quot;</span>, <span class="string">&quot;触发降级方法！&quot;</span>);</span><br><span class="line">            put(<span class="string">&quot;statusCode&quot;</span>, <span class="string">&quot;400&quot;</span>);</span><br><span class="line">            put(<span class="string">&quot;flag&quot;</span>, flag);</span><br><span class="line">        &#125;&#125;;</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;触发降级方法....findOrderByIdFallBack&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> fallBackMap;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@HystrixCommand(</span></span><br><span class="line"><span class="meta">            // 服务组名称(名称任意)</span></span><br><span class="line"><span class="meta">            groupKey = &quot;item-orderService&quot;,</span></span><br><span class="line"><span class="meta">            // 接口名称,默认为方法名(名称任意)</span></span><br><span class="line"><span class="meta">            commandKey = &quot;abc-findOrderAll&quot;,</span></span><br><span class="line"><span class="meta">            // 线程池名称</span></span><br><span class="line"><span class="meta">            threadPoolKey = &quot;item-orderService-findAllPool&quot;,</span></span><br><span class="line"><span class="meta">            commandProperties = &#123;</span></span><br><span class="line"><span class="meta">                    @HystrixProperty(</span></span><br><span class="line"><span class="meta">                            // 超时时间,默认为1000ms</span></span><br><span class="line"><span class="meta">                            name = &quot;execution.isolation.thread.timeoutInMilliseconds&quot;,</span></span><br><span class="line"><span class="meta">                            value = &quot;10000&quot;</span></span><br><span class="line"><span class="meta">                    ),</span></span><br><span class="line"><span class="meta">                    // 线程池隔离策略(默认值)</span></span><br><span class="line"><span class="meta">                    @HystrixProperty(name = HystrixPropertiesManager.EXECUTION_ISOLATION_STRATEGY, value = &quot;THREAD&quot;),</span></span><br><span class="line"><span class="meta">            &#125;,</span></span><br><span class="line"><span class="meta">            threadPoolProperties = &#123;</span></span><br><span class="line"><span class="meta">                    // 线程池大小</span></span><br><span class="line"><span class="meta">                    @HystrixProperty(name = &quot;coreSize&quot;, value = &quot;3&quot;),</span></span><br><span class="line"><span class="meta">                    // 队列等待阈值</span></span><br><span class="line"><span class="meta">                    @HystrixProperty(name = &quot;maxQueueSize&quot;, value = &quot;1&quot;),</span></span><br><span class="line"><span class="meta">            &#125;,</span></span><br><span class="line"><span class="meta">            fallbackMethod = &quot;findOrderAllFallBack&quot;     // 降级方法</span></span><br><span class="line"><span class="meta">    )</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/findOrderAll&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Map <span class="title function_">findOrderAll</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">        System.out.println(Thread.currentThread().getName());</span><br><span class="line">        <span class="type">Map</span> <span class="variable">resultMap</span> <span class="operator">=</span> restTemplate.getForObject(<span class="string">&quot;http://order-service/order/&quot;</span>, Map.class);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> resultMap;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * findOrderAll 降级方法</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> Map <span class="title function_">findOrderAllFallBack</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;触发降级方法....findOrderAllFallBack&quot;</span>);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">fallBackMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>() &#123;&#123;</span><br><span class="line">            put(<span class="string">&quot;flag&quot;</span>, <span class="literal">true</span>);</span><br><span class="line">            put(<span class="string">&quot;message&quot;</span>, <span class="string">&quot;触发降级方法！&quot;</span>);</span><br><span class="line">            put(<span class="string">&quot;statusCode&quot;</span>, <span class="string">&quot;400&quot;</span>);</span><br><span class="line">        &#125;&#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> fallBackMap;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>coreSize为3代表最多只能处理三个并发，maxQueueSize为1，代表请求队列中最多只能等待1个请求，也就是说这个接口最多能够处理4个并发，如果第5个并发请求来了，那么会直接触发降级方法，立即响应释放连接资源；</p>
<p>使用JMeter发起高并发请求findOrderAll接口，在浏览器访问findOrderById接口，查看是否快速响应；</p>
<h3 id="7-4-2-信号量隔离"><a href="#7-4-2-信号量隔离" class="headerlink" title="7.4.2 信号量隔离"></a>7.4.2 信号量隔离</h3><p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/springcloud/152.png"
                      alt="img"
                ></p>
<p>信号量隔离为某个接口分配具体的并发量，超出了则触发降级立即响应；</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.cloud.item.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.netflix.hystrix.contrib.javanica.annotation.HystrixCollapser;</span><br><span class="line"><span class="keyword">import</span> com.netflix.hystrix.contrib.javanica.annotation.HystrixCommand;</span><br><span class="line"><span class="keyword">import</span> com.netflix.hystrix.contrib.javanica.annotation.HystrixProperty;</span><br><span class="line"><span class="keyword">import</span> com.netflix.hystrix.contrib.javanica.conf.HystrixPropertiesManager;</span><br><span class="line"><span class="keyword">import</span> com.netflix.ribbon.proxy.annotation.Hystrix;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.netflix.hystrix.EnableHystrix;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.netflix.hystrix.HystrixProperties;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.*;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.client.RestTemplate;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> lscl</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@intro</span>:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/item&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ItemController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RestTemplate restTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@HystrixCommand(</span></span><br><span class="line"><span class="meta">            commandProperties = &#123;</span></span><br><span class="line"><span class="meta">                    @HystrixProperty(</span></span><br><span class="line"><span class="meta">                            // 超时时间,默认为1000ms</span></span><br><span class="line"><span class="meta">                            name = &quot;execution.isolation.thread.timeoutInMilliseconds&quot;,</span></span><br><span class="line"><span class="meta">                            value = &quot;10000&quot;</span></span><br><span class="line"><span class="meta">                    ),</span></span><br><span class="line"><span class="meta">                    // 隔离策略 默认为Thread(线程池隔离) SEMAPHORE:信号量隔离</span></span><br><span class="line"><span class="meta">                    @HystrixProperty(name = HystrixPropertiesManager.EXECUTION_ISOLATION_STRATEGY, value = &quot;SEMAPHORE&quot;),</span></span><br><span class="line"><span class="meta">                    // 信号量最大并发</span></span><br><span class="line"><span class="meta">                    @HystrixProperty(name = HystrixPropertiesManager.EXECUTION_ISOLATION_SEMAPHORE_MAX_CONCURRENT_REQUESTS, value = &quot;5&quot;),</span></span><br><span class="line"><span class="meta">            &#125;,</span></span><br><span class="line"><span class="meta">            fallbackMethod = &quot;findOrderByIdFallBack&quot;             // 降级方法</span></span><br><span class="line"><span class="meta">    )</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/findOrderById/&#123;orderId&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Map <span class="title function_">findOrderById</span><span class="params">(<span class="meta">@PathVariable</span> Integer orderId)</span> &#123;</span><br><span class="line"></span><br><span class="line">        System.out.println(Thread.currentThread().getName());</span><br><span class="line">        <span class="type">Map</span> <span class="variable">resultMap</span> <span class="operator">=</span> restTemplate.getForObject(<span class="string">&quot;http://order-service/order/&quot;</span> + orderId, Map.class);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> resultMap;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * findOrderById降级方法</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> flag</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> Map <span class="title function_">findOrderByIdFallBack</span><span class="params">(Integer flag)</span> &#123;</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;触发降级方法....findOrderByIdFallBack&quot;</span>);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">fallBackMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>() &#123;&#123;</span><br><span class="line">            put(<span class="string">&quot;flag&quot;</span>, <span class="literal">true</span>);</span><br><span class="line">            put(<span class="string">&quot;message&quot;</span>, <span class="string">&quot;触发降级方法！&quot;</span>);</span><br><span class="line">            put(<span class="string">&quot;statusCode&quot;</span>, <span class="string">&quot;400&quot;</span>);</span><br><span class="line">            put(<span class="string">&quot;flag&quot;</span>, flag);</span><br><span class="line">        &#125;&#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> fallBackMap;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@HystrixCommand(</span></span><br><span class="line"><span class="meta">            commandProperties = &#123;</span></span><br><span class="line"><span class="meta">                    @HystrixProperty(</span></span><br><span class="line"><span class="meta">                            // 超时时间,默认为1000ms</span></span><br><span class="line"><span class="meta">                            name = &quot;execution.isolation.thread.timeoutInMilliseconds&quot;,</span></span><br><span class="line"><span class="meta">                            value = &quot;10000&quot;</span></span><br><span class="line"><span class="meta">                    ),</span></span><br><span class="line"><span class="meta">                    // 隔离策略 默认为Thread(线程池隔离) SEMAPHORE:信号量隔离</span></span><br><span class="line"><span class="meta">                    @HystrixProperty(name = HystrixPropertiesManager.EXECUTION_ISOLATION_STRATEGY, value = &quot;SEMAPHORE&quot;),</span></span><br><span class="line"><span class="meta">                    // 信号量最大并发</span></span><br><span class="line"><span class="meta">                    @HystrixProperty(name = HystrixPropertiesManager.EXECUTION_ISOLATION_SEMAPHORE_MAX_CONCURRENT_REQUESTS, value = &quot;5&quot;),</span></span><br><span class="line"><span class="meta">            &#125;,</span></span><br><span class="line"><span class="meta">            fallbackMethod = &quot;findOrderAllFallBack&quot;             // 降级方法</span></span><br><span class="line"><span class="meta">    )</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/findOrderAll&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Map <span class="title function_">findOrderAll</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">        System.out.println(Thread.currentThread().getName());</span><br><span class="line">        <span class="type">Map</span> <span class="variable">resultMap</span> <span class="operator">=</span> restTemplate.getForObject(<span class="string">&quot;http://order-service/order/&quot;</span>, Map.class);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> resultMap;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * findOrderAll 降级方法</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> Map <span class="title function_">findOrderAllFallBack</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;触发降级方法....findOrderAllFallBack&quot;</span>);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">fallBackMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>() &#123;&#123;</span><br><span class="line">            put(<span class="string">&quot;flag&quot;</span>, <span class="literal">true</span>);</span><br><span class="line">            put(<span class="string">&quot;message&quot;</span>, <span class="string">&quot;触发降级方法！&quot;</span>);</span><br><span class="line">            put(<span class="string">&quot;statusCode&quot;</span>, <span class="string">&quot;400&quot;</span>);</span><br><span class="line">        &#125;&#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> fallBackMap;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="7-4-3-小结"><a href="#7-4-3-小结" class="headerlink" title="7.4.3 小结"></a>7.4.3 小结</h3><ul>
<li>线程池隔离：<ul>
<li>请求线程和调用线程Provider不是同一条线程；（消耗资源）</li>
<li>支持熔断，当线程池到达最大线程并且阈值已经满了时，在请求触发<code>fallback</code>降级方法；</li>
<li>采用单独的线程池进行隔离</li>
<li>支持同步和异步两种方式;</li>
<li>资源消耗大，大量的线程进行上下文切换、排队、调度等</li>
<li>无法传递Http Header信息</li>
</ul>
</li>
<li>信号量隔离：<ul>
<li>请求线程和调用Provider线程是同一条线程</li>
<li>支持熔断，信号量达到<code>maxConcurrentRequests</code>后再请求触发<code>fallback</code>降级方法；</li>
<li>采用信号量令牌进行隔离</li>
<li>同步调用，不支持异步调用</li>
<li>资源消耗小</li>
<li>可以传递Http Header</li>
</ul>
</li>
<li><strong>何时采用线程池隔离？</strong></li>
</ul>
<p>请求并发量大，并且&#x3D;&#x3D;<strong>调用服务耗时长</strong>&#x3D;&#x3D;，可采用线程池隔离，保证大量容器的线程处于可用状态，不会由于服务本身原因一直处于等待或阻塞状态，快速失败返回；</p>
<ul>
<li><strong>何时采用信号量隔离？</strong></li>
</ul>
<p>请求并发量大，并且&#x3D;&#x3D;<strong>调用服务耗时短</strong>&#x3D;&#x3D;（通常是命中缓存等情况），可采用信号量隔离，这类服务的调用通常返回都较快，不会占用容器线程太长时间，而且也减少了线程切换的开销；</p>
<h2 id="7-5-Hystrix-Dashboard"><a href="#7-5-Hystrix-Dashboard" class="headerlink" title="7.5 Hystrix Dashboard"></a>7.5 Hystrix Dashboard</h2><p>Hystrix 仪表盘（Hystrix Dashboard），Hystrix 仪表盘主要用来监控Hystrix 的实时运行状态，通过它我们可以看到 Hystrix 的各项指标信息，如每秒请求数量，成功&#x2F;失败&#x2F;熔断次数等，Hystrix 仪表盘通过很好的可视化工具帮我们展示这些指标，从而快速发现系统中存在的问题进而解决它。</p>
<h3 id="7-5-1-搭建Hystrix-DashBoard"><a href="#7-5-1-搭建Hystrix-DashBoard" class="headerlink" title="7.5.1 搭建Hystrix DashBoard"></a>7.5.1 搭建Hystrix DashBoard</h3><p>1）引入依赖</p>
<div class="highlight-container" data-rel="Xml"><figure class="iseeu highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--dashboard监控依赖--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-hystrix-dashboard<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure></div>

<p>2）编写配置</p>
<div class="highlight-container" data-rel="Yml"><figure class="iseeu highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">10102</span></span><br><span class="line"><span class="attr">hystrix:</span></span><br><span class="line">  <span class="attr">dashboard:</span></span><br><span class="line">    <span class="attr">proxy-stream-allow-list:</span> <span class="string">&quot;localhost&quot;</span>        <span class="comment"># 允许本机访问</span></span><br></pre></td></tr></table></figure></div>

<p>3）启动类</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.cloud.dashboard;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.netflix.hystrix.dashboard.EnableHystrixDashboard;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> lscl</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@intro</span>:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@EnableHystrixDashboard</span>         <span class="comment">// 开启Hystrix仪表盘</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DashBoardApplication</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(DashBoardApplication.class);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>访问<a class="link"   target="_blank" rel="noopener" href="http://localhost:10102/hystrix" >http://localhost:10102/hystrix <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/springcloud/151.png"
                      alt="img"
                ></p>
<h3 id="7-5-2-配置Hystrix监控"><a href="#7-5-2-配置Hystrix监控" class="headerlink" title="7.5.2 配置Hystrix监控"></a>7.5.2 配置Hystrix监控</h3><p>1）在服务消费者引入依赖：</p>
<div class="highlight-container" data-rel="Xml"><figure class="iseeu highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--hystrix依赖--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-hystrix<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--SpringBoot监控依赖--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></div>

<p>2）编写配置</p>
<div class="highlight-container" data-rel="Yml"><figure class="iseeu highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">management:</span></span><br><span class="line">  <span class="attr">endpoints:</span></span><br><span class="line">    <span class="attr">web:</span></span><br><span class="line">      <span class="attr">exposure:</span></span><br><span class="line">        <span class="attr">include:</span> <span class="string">&#x27;*&#x27;</span>      <span class="comment"># 开放所有监控端点</span></span><br></pre></td></tr></table></figure></div>

<p>访问<a class="link"   target="_blank" rel="noopener" href="http://localhost:9000/actuator/hystrix.stream%EF%BC%88%E9%9C%80%E8%A6%81%E5%BC%80%E5%90%AF@EnableCircuitBreaker%E5%B9%B6%E6%8F%90%E4%BE%9B%E9%99%8D%E7%BA%A7%E6%96%B9%E6%B3%95%EF%BC%89" >http://localhost:9000/actuator/hystrix.stream（需要开启@EnableCircuitBreaker并提供降级方法） <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/springcloud/150.png"
                      alt="img"
                ></p>
<p>我们需要访问服务下的任意一个接口之后才可以获取具体的ping信息：<a class="link"   target="_blank" rel="noopener" href="http://localhost:9000/item/findOrderById/1" >http://localhost:9000/item/findOrderById/1 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/springcloud/149.png"
                      alt="img"
                ></p>
<h3 id="7-5-3-使用DashBoard监控"><a href="#7-5-3-使用DashBoard监控" class="headerlink" title="7.5.3 使用DashBoard监控"></a>7.5.3 使用DashBoard监控</h3><p>访问<a class="link"   target="_blank" rel="noopener" href="http://localhost:10102/hystrix" >http://localhost:10102/hystrix <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/springcloud/148.png"
                      alt="img"
                ></p>
<p>监控面板：</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/springcloud/147.png"
                      alt="img"
                ></p>
<p>修改ItemController：</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.cloud.item.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.netflix.hystrix.contrib.javanica.annotation.HystrixCommand;</span><br><span class="line"><span class="keyword">import</span> com.netflix.hystrix.contrib.javanica.annotation.HystrixProperty;</span><br><span class="line"><span class="keyword">import</span> com.netflix.hystrix.contrib.javanica.conf.HystrixPropertiesManager;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PathVariable;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.client.RestTemplate;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> lscl</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@intro</span>:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/item&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ItemController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RestTemplate restTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 测试Hystrix接口</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> flag</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@HystrixCommand(fallbackMethod = &quot;fallBack&quot;)</span>            <span class="comment">// 降级方法</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/testHystrix/&#123;flag&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Map <span class="title function_">findOrderById</span><span class="params">(<span class="meta">@PathVariable</span> String flag)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">Map</span> <span class="variable">resultMap</span> <span class="operator">=</span> restTemplate.getForObject(<span class="string">&quot;http://order-service/order/testHystrix/&quot;</span> + flag, Map.class);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> resultMap;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 降级方法</span></span><br><span class="line">    <span class="keyword">public</span> Map <span class="title function_">fallBack</span><span class="params">(String flag)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">Map</span> <span class="variable">fallBackMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>() &#123;&#123;</span><br><span class="line">            put(<span class="string">&quot;flag&quot;</span>, <span class="literal">true</span>);</span><br><span class="line">            put(<span class="string">&quot;message&quot;</span>, <span class="string">&quot;触发降级方法！&quot;</span>);</span><br><span class="line">            put(<span class="string">&quot;statusCode&quot;</span>, <span class="string">&quot;400&quot;</span>);</span><br><span class="line">            put(<span class="string">&quot;flag&quot;</span>, flag);</span><br><span class="line">        &#125;&#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> fallBackMap;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line">    <span class="meta">@HystrixCommand(fallbackMethod = &quot;findOrderByIdFallBack&quot;)</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/findOrderById/&#123;orderId&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Map <span class="title function_">findOrderById</span><span class="params">(<span class="meta">@PathVariable</span> Integer orderId)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">Map</span> <span class="variable">resultMap</span> <span class="operator">=</span> restTemplate.getForObject(<span class="string">&quot;http://order-service/order/&quot;</span> + orderId, Map.class);</span><br><span class="line">        <span class="keyword">return</span> resultMap;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * findOrderById降级方法</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> flag</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> Map <span class="title function_">findOrderByIdFallBack</span><span class="params">(Integer flag)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">Map</span> <span class="variable">fallBackMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>() &#123;&#123;</span><br><span class="line">            put(<span class="string">&quot;flag&quot;</span>, <span class="literal">true</span>);</span><br><span class="line">            put(<span class="string">&quot;message&quot;</span>, <span class="string">&quot;触发降级方法！&quot;</span>);</span><br><span class="line">            put(<span class="string">&quot;statusCode&quot;</span>, <span class="string">&quot;400&quot;</span>);</span><br><span class="line">            put(<span class="string">&quot;flag&quot;</span>, flag);</span><br><span class="line">        &#125;&#125;;</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;触发降级方法....findOrderByIdFallBack&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> fallBackMap;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@HystrixCommand(fallbackMethod = &quot;findOrderAllFallBack&quot;)</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/findOrderAll&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Map <span class="title function_">findOrderAll</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">Map</span> <span class="variable">resultMap</span> <span class="operator">=</span> restTemplate.getForObject(<span class="string">&quot;http://order-service/order/&quot;</span>, Map.class);</span><br><span class="line">        <span class="keyword">return</span> resultMap;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * findOrderAll 降级方法</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> Map <span class="title function_">findOrderAllFallBack</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;触发降级方法....findOrderAllFallBack&quot;</span>);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">fallBackMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>() &#123;&#123;</span><br><span class="line">            put(<span class="string">&quot;flag&quot;</span>, <span class="literal">true</span>);</span><br><span class="line">            put(<span class="string">&quot;message&quot;</span>, <span class="string">&quot;触发降级方法！&quot;</span>);</span><br><span class="line">            put(<span class="string">&quot;statusCode&quot;</span>, <span class="string">&quot;400&quot;</span>);</span><br><span class="line">        &#125;&#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> fallBackMap;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>



<h3 id="7-5-4-DashBoard面板参数"><a href="#7-5-4-DashBoard面板参数" class="headerlink" title="7.5.4 DashBoard面板参数"></a>7.5.4 DashBoard面板参数</h3><p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/springcloud/146.png"
                      alt="img"
                ></p>
<h2 id="7-7-Hystrix断路器"><a href="#7-7-Hystrix断路器" class="headerlink" title="7.7 Hystrix断路器"></a>7.7 Hystrix断路器</h2><h3 id="7-7-1-断路器的工作原理"><a href="#7-7-1-断路器的工作原理" class="headerlink" title="7.7.1 断路器的工作原理"></a>7.7.1 断路器的工作原理</h3><p>Hystrix 能使你的系统在出现依赖服务失效的时候，通过隔离系统所依赖的服务，防止服务级联失败，同时提供失败回退机制，更优雅地应对失效，并使你的系统能更快地从异常中恢复。了解熔断器模式请看下图：</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/springcloud/145.png"
                      alt="img"
                ></p>
<p>熔断器有三个状态 <code>CLOSED </code>、 <code>OPEN </code>、 <code>HALF_OPEN </code>熔断器默认关闭状态，当触发熔断后状态变更为<code>OPEN</code>，在等待到指定的时间，Hystrix会放请求检测服务是否开启，这期间熔断器会变为 <code>HALF_OPEN </code>半开启状态，熔断探测服务可用则继续变更为 <code>CLOSED </code>关闭熔断器。</p>
<ul>
<li>1）<code>Closed</code>：断路器处于关闭状态，closed是断路器的默认状态，，表示当前所有的请求都可以正常访问；</li>
<li>2）<code>Open</code>：断路器属于打开状态，当失败请求百分比达到50%，并且请求次数不小于20次，则触发熔断，断路器会开启。</li>
<li>3）<code>Half Open</code>：断路器属于半开状态，当断路器属于open状态时会进入休眠（默认5s），<strong>之后断路器进入半开状态</strong>。此时若请求成功1次，则断路器自动关闭，否则断路器再次进入打开状态，再次进行5s的休眠；</li>
</ul>
<p>我们发送请求：<a class="link"   target="_blank" rel="noopener" href="http://localhost:9000/item/testHystrix/0" >http://localhost:9000/item/testHystrix/0 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a> 20次触发熔断器</p>
<p>在5s内（Open状态）发送<a class="link"   target="_blank" rel="noopener" href="http://localhost:9000/item/testHystrix/1" >http://localhost:9000/item/testHystrix/1 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a> 请求，发现依旧被降级；</p>
<h3 id="7-7-2-断路器相关参数"><a href="#7-7-2-断路器相关参数" class="headerlink" title="7.7.2 断路器相关参数"></a>7.7.2 断路器相关参数</h3><p>断路器开启添加默认为请求失败比率为50%，并且需要20次请求，当断路器打开时休眠5s后进入半开状态；我们可以通过一系列参数来修改断路器的配置；</p>
<p>关于断路器的配置有全局配置和方法配置两种，全局配置针对于所有的服务调用，方法配置只针对于本方法的配置，两种都配置了采取就近原则（方法配置）</p>
<p>全局配置：在服务消费者（Item服务）中配置：</p>
<div class="highlight-container" data-rel="Yml"><figure class="iseeu highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">hystrix:</span></span><br><span class="line">  <span class="attr">command:</span></span><br><span class="line">    <span class="attr">default:</span></span><br><span class="line">      <span class="attr">circuitBreaker:</span></span><br><span class="line">        <span class="attr">requestVolumeThreshold:</span> <span class="number">5</span>             <span class="comment"># 熔断触发的错误次数的阈值</span></span><br><span class="line">        <span class="attr">sleepWindowInMilliseconds:</span> <span class="number">10000</span>      <span class="comment"># 断路器开启后多少毫秒进入半开状态</span></span><br><span class="line">        <span class="attr">errorThresholdPercentage:</span> <span class="number">50</span>          <span class="comment"># 断路器统计的请求失败比率阈值</span></span><br></pre></td></tr></table></figure></div>

<p>方法配置：修改testHystrix接口：</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 测试Hystrix接口</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> flag</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@HystrixCommand(</span></span><br><span class="line"><span class="meta">        // 降级方法</span></span><br><span class="line"><span class="meta">        fallbackMethod = &quot;fallBack&quot;,</span></span><br><span class="line"><span class="meta">        commandProperties = &#123;</span></span><br><span class="line"><span class="meta">                @HystrixProperty(</span></span><br><span class="line"><span class="meta">                        // 超时时间,默认为1000ms</span></span><br><span class="line"><span class="meta">                        name = HystrixPropertiesManager.EXECUTION_ISOLATION_THREAD_TIMEOUT_IN_MILLISECONDS,</span></span><br><span class="line"><span class="meta">                        value = &quot;10000&quot;</span></span><br><span class="line"><span class="meta">                ),</span></span><br><span class="line"><span class="meta">                // 熔断触发的错误次数的阈值为5次</span></span><br><span class="line"><span class="meta">                @HystrixProperty(</span></span><br><span class="line"><span class="meta">                        name = HystrixPropertiesManager.CIRCUIT_BREAKER_REQUEST_VOLUME_THRESHOLD, </span></span><br><span class="line"><span class="meta">                        value = &quot;5&quot;</span></span><br><span class="line"><span class="meta">                ),</span></span><br><span class="line"><span class="meta">                // 断路器开启后3s进入半开状态</span></span><br><span class="line"><span class="meta">                @HystrixProperty(</span></span><br><span class="line"><span class="meta">                        name = HystrixPropertiesManager.CIRCUIT_BREAKER_SLEEP_WINDOW_IN_MILLISECONDS, </span></span><br><span class="line"><span class="meta">                        value = &quot;3000&quot;</span></span><br><span class="line"><span class="meta">                ),</span></span><br><span class="line"><span class="meta">                // 断路器统计的请求失败比率阈值为50</span></span><br><span class="line"><span class="meta">                @HystrixProperty(</span></span><br><span class="line"><span class="meta">                        name = HystrixPropertiesManager.CIRCUIT_BREAKER_ERROR_THRESHOLD_PERCENTAGE, </span></span><br><span class="line"><span class="meta">                        value = &quot;100&quot;</span></span><br><span class="line"><span class="meta">                )</span></span><br><span class="line"><span class="meta">        &#125;)</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/testHystrix/&#123;flag&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Map <span class="title function_">testHystrix</span><span class="params">(<span class="meta">@PathVariable</span> String flag)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">Map</span> <span class="variable">resultMap</span> <span class="operator">=</span> restTemplate.getForObject(<span class="string">&quot;http://order-service/order/testHystrix/&quot;</span> + flag, Map.class);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> resultMap;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<blockquote>
<p>注意：断路器除了达到上面的条件会开启时，线程池隔离和信号量隔离时也会触发断路器</p>
<p>1）线程池隔离：超出了等待线程也会触发断路器，当线程队列中的线程正常消费完毕时，断路器关闭；</p>
<p>2）信号量隔离：信号量令牌全部耗尽时，如果还有新的请求来临，那么触发断路器，当请求归还信号量令牌并且令牌能完全分配给请求线程时，断路器关闭；</p>
</blockquote>
<h2 id="7-8-Feign-集成-Hystrix"><a href="#7-8-Feign-集成-Hystrix" class="headerlink" title="7.8 Feign 集成 Hystrix"></a>7.8 Feign 集成 Hystrix</h2><h3 id="7-8-1-Feign-降级"><a href="#7-8-1-Feign-降级" class="headerlink" title="7.8.1 Feign 降级"></a>7.8.1 Feign 降级</h3><p>Spring Cloud Fegin中默认已为Feign整合了hystrix，所以添加Feign依赖后就不用在添加hystrix，Feign与Hystrix集成也非常的方便，我们只需要在配置文件中激活Feign即可：</p>
<ul>
<li>引入feign依赖：</li>
</ul>
<div class="highlight-container" data-rel="Xml"><figure class="iseeu highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--Feign依赖--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></div>

<ul>
<li>开启feign支持：</li>
</ul>
<div class="highlight-container" data-rel="Yml"><figure class="iseeu highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">feign:</span></span><br><span class="line">  <span class="attr">hystrix:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span>         <span class="comment"># 开启hystrix熔断</span></span><br></pre></td></tr></table></figure></div>

<p>编写远程调用接口：</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.cloud.item.client;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.cloud.item.client.fallback.OrderClientFallBack;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.openfeign.FeignClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PathVariable;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 远程调用接口</span></span><br><span class="line"><span class="comment"> * name: 服务名</span></span><br><span class="line"><span class="comment"> * fallback: 降级处理类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@FeignClient(name = &quot;order-service&quot;, fallback = OrderClientFallBack.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">OrderClient</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 测试hystrix远程调用</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> flag</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/order/testHystrix/&#123;flag&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Map <span class="title function_">testHystrix</span><span class="params">(<span class="meta">@PathVariable(&quot;flag&quot;)</span> String flag)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据id查询</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/order/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Map <span class="title function_">findById</span><span class="params">(<span class="meta">@PathVariable</span> Integer id)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询全部</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/order/&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Map <span class="title function_">findAll</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>编写降级类：</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.cloud.item.client.fallback;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.cloud.item.client.OrderClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> lscl</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@intro</span>: Order服务远程调用失败的降级处理</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderClientFallBack</span> <span class="keyword">implements</span> <span class="title class_">OrderClient</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Map <span class="title function_">testHystrix</span><span class="params">(String flag)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>() &#123;&#123;</span><br><span class="line">            put(<span class="string">&quot;flag&quot;</span>, <span class="literal">true</span>);</span><br><span class="line">            put(<span class="string">&quot;message&quot;</span>, <span class="string">&quot;触发testHystrix降级方法！&quot;</span>);</span><br><span class="line">            put(<span class="string">&quot;statusCode&quot;</span>, <span class="string">&quot;400&quot;</span>);</span><br><span class="line">            put(<span class="string">&quot;flag&quot;</span>, flag);</span><br><span class="line">        &#125;&#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Map <span class="title function_">findById</span><span class="params">(Integer id)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>() &#123;&#123;</span><br><span class="line">            put(<span class="string">&quot;flag&quot;</span>, <span class="literal">true</span>);</span><br><span class="line">            put(<span class="string">&quot;message&quot;</span>, <span class="string">&quot;触发findById降级方法！&quot;</span>);</span><br><span class="line">            put(<span class="string">&quot;statusCode&quot;</span>, <span class="string">&quot;400&quot;</span>);</span><br><span class="line">            put(<span class="string">&quot;id&quot;</span>, id);</span><br><span class="line">        &#125;&#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Map <span class="title function_">findAll</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>() &#123;&#123;</span><br><span class="line">            put(<span class="string">&quot;flag&quot;</span>, <span class="literal">true</span>);</span><br><span class="line">            put(<span class="string">&quot;message&quot;</span>, <span class="string">&quot;触发findAll降级方法！&quot;</span>);</span><br><span class="line">            put(<span class="string">&quot;statusCode&quot;</span>, <span class="string">&quot;400&quot;</span>);</span><br><span class="line">        &#125;&#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<ul>
<li>编写ItemController：</li>
</ul>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.cloud.item.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.cloud.item.client.OrderClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PathVariable;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> lscl</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@intro</span>:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/item&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ItemController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> OrderClient orderClient;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 测试Hystrix接口</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> flag</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/testHystrix/&#123;flag&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Map <span class="title function_">testHystrix</span><span class="params">(<span class="meta">@PathVariable</span> String flag)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">Map</span> <span class="variable">resultMap</span> <span class="operator">=</span> orderClient.testHystrix(flag);</span><br><span class="line">        <span class="keyword">return</span> resultMap;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/findOrderById/&#123;orderId&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Map <span class="title function_">findOrderById</span><span class="params">(<span class="meta">@PathVariable</span> Integer orderId)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">Map</span> <span class="variable">resultMap</span> <span class="operator">=</span> orderClient.findById(orderId);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> resultMap;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/findOrderAll&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Map <span class="title function_">findOrderAll</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">Map</span> <span class="variable">resultMap</span> <span class="operator">=</span> orderClient.findAll();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> resultMap;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>



<p>访问：<a class="link"   target="_blank" rel="noopener" href="http://localhost:9000/demo/testHystrix/2" >http://localhost:9000/demo/testHystrix/2 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<h3 id="7-8-2-Feign的超时配置"><a href="#7-8-2-Feign的超时配置" class="headerlink" title="7.8.2 Feign的超时配置"></a>7.8.2 Feign的超时配置</h3><p>Feign集成了Ribbon，Feign的降级超时由Ribbon的超时时间与Hystrix的超时时间一起控制，&#x3D;&#x3D;<strong>取时间短的为准；</strong>&#x3D;&#x3D;</p>
<div class="highlight-container" data-rel="Yml"><figure class="iseeu highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">hystrix:</span></span><br><span class="line">  <span class="attr">command:</span></span><br><span class="line">    <span class="attr">default:</span></span><br><span class="line">      <span class="attr">execution:</span></span><br><span class="line">        <span class="attr">isolation:</span></span><br><span class="line">          <span class="attr">thread:</span></span><br><span class="line">            <span class="attr">timeoutInMilliseconds:</span> <span class="number">3000</span>       <span class="comment"># 修改超时时间为2s</span></span><br><span class="line"><span class="attr">ribbon:</span></span><br><span class="line">  <span class="attr">ReadTimeout:</span> <span class="number">1500</span>               <span class="comment"># 请求处理的超时时间为1.5s</span></span><br></pre></td></tr></table></figure></div>

<blockquote>
<p>Tips：两个需要一起配置，根据取时间短的为准原则，服务调用的超时时间为：1.5s</p>
</blockquote>
<h3 id="7-8-3-Feign配置线程池隔离"><a href="#7-8-3-Feign配置线程池隔离" class="headerlink" title="7.8.3 Feign配置线程池隔离"></a>7.8.3 Feign配置线程池隔离</h3><p>1）修改OrderClient，配置降级属性</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient(</span></span><br><span class="line"><span class="meta">    name = &quot;order-service&quot;, </span></span><br><span class="line"><span class="meta">    fallback = OrderClientFallBack.class,</span></span><br><span class="line"><span class="meta">    fallbackFactory = OrderThreadIsolationConfig.class			// 降级配置</span></span><br><span class="line"><span class="meta">)</span></span><br></pre></td></tr></table></figure></div>



<p>2）编写降级配置类</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.cloud.item.client.isolation;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.netflix.hystrix.*;</span><br><span class="line"><span class="keyword">import</span> feign.Feign;</span><br><span class="line"><span class="keyword">import</span> feign.Target;</span><br><span class="line"><span class="keyword">import</span> feign.hystrix.SetterFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> lscl</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@intro</span>: 调用Order服务的线程池隔离配置</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderThreadIsolationConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> SetterFactory <span class="title function_">setterFactory</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">SetterFactory</span> <span class="variable">setterFactory</span> <span class="operator">=</span><span class="keyword">new</span> <span class="title class_">SetterFactory</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> HystrixCommand.Setter <span class="title function_">create</span><span class="params">(Target&lt;?&gt; target, Method method)</span> &#123;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 服务分组名称</span></span><br><span class="line">                <span class="type">String</span> <span class="variable">groupKey</span> <span class="operator">=</span> target.name();</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 接口名称</span></span><br><span class="line">                <span class="type">String</span> <span class="variable">commandKey</span> <span class="operator">=</span> Feign.configKey(target.type(), method);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Hystrix配置</span></span><br><span class="line">                HystrixCommandProperties.<span class="type">Setter</span> <span class="variable">commandProp</span> <span class="operator">=</span> HystrixCommandProperties.Setter()</span><br><span class="line">                        <span class="comment">// 设置线程隔离</span></span><br><span class="line">                        .withExecutionIsolationStrategy(HystrixCommandProperties.ExecutionIsolationStrategy.THREAD);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 线程池配置</span></span><br><span class="line">                HystrixThreadPoolProperties.<span class="type">Setter</span> <span class="variable">threadPoolProp</span> <span class="operator">=</span> HystrixThreadPoolProperties.Setter()</span><br><span class="line">                        <span class="comment">// 线程池大小</span></span><br><span class="line">                        .withCoreSize(<span class="number">3</span>)</span><br><span class="line">                        <span class="comment">// 线程池最大等待阈值</span></span><br><span class="line">                        .withMaxQueueSize(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> HystrixCommand.Setter</span><br><span class="line">                        .withGroupKey(HystrixCommandGroupKey.Factory.asKey(groupKey))</span><br><span class="line">                        .andCommandKey(HystrixCommandKey.Factory.asKey(commandKey))</span><br><span class="line">                        .andCommandPropertiesDefaults(commandProp).</span><br><span class="line">                                andThreadPoolPropertiesDefaults(threadPoolProp);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">return</span> setterFactory;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="7-8-4-Feign配置信号量隔离"><a href="#7-8-4-Feign配置信号量隔离" class="headerlink" title="7.8.4 Feign配置信号量隔离"></a>7.8.4 Feign配置信号量隔离</h3><p>1）修改OrderClient降级处理配置类</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient(</span></span><br><span class="line"><span class="meta">    name = &quot;order-service&quot;, </span></span><br><span class="line"><span class="meta">    fallback = OrderClientFallBack.class,</span></span><br><span class="line"><span class="meta">    fallbackFactory = OrderSemaphoreIsolationConfig.class			// 降级配置</span></span><br><span class="line"><span class="meta">)</span></span><br></pre></td></tr></table></figure></div>

<p>2）编写信号量配置：</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.cloud.item.client.isolation;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.netflix.hystrix.*;</span><br><span class="line"><span class="keyword">import</span> feign.Feign;</span><br><span class="line"><span class="keyword">import</span> feign.Target;</span><br><span class="line"><span class="keyword">import</span> feign.hystrix.SetterFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> lscl</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@intro</span>: 调用Order服务的线程池隔离配置</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderSemaphoreIsolationConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> SetterFactory <span class="title function_">setterFactory</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">SetterFactory</span> <span class="variable">setterFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SetterFactory</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> HystrixCommand.Setter <span class="title function_">create</span><span class="params">(Target&lt;?&gt; target, Method method)</span> &#123;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 服务分组名称</span></span><br><span class="line">                <span class="type">String</span> <span class="variable">groupKey</span> <span class="operator">=</span> target.name();</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 接口名称</span></span><br><span class="line">                <span class="type">String</span> <span class="variable">commandKey</span> <span class="operator">=</span> Feign.configKey(target.type(), method);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Hystrix配置</span></span><br><span class="line">                HystrixCommandProperties.<span class="type">Setter</span> <span class="variable">commandProp</span> <span class="operator">=</span> HystrixCommandProperties.Setter()</span><br><span class="line">                        <span class="comment">// 设置信号量隔离</span></span><br><span class="line">                        .withExecutionIsolationStrategy(HystrixCommandProperties.ExecutionIsolationStrategy.SEMAPHORE)</span><br><span class="line">                    <span class="comment">// 信号量令牌个数</span></span><br><span class="line">                        .withExecutionIsolationSemaphoreMaxConcurrentRequests(<span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> HystrixCommand.Setter</span><br><span class="line">                        .withGroupKey(HystrixCommandGroupKey.Factory.asKey(groupKey))</span><br><span class="line">                        .andCommandKey(HystrixCommandKey.Factory.asKey(commandKey))</span><br><span class="line">                        .andCommandPropertiesDefaults(commandProp);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">return</span> setterFactory;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h1 id="八、Netflix-Zuul-服务网关"><a href="#八、Netflix-Zuul-服务网关" class="headerlink" title="八、Netflix Zuul 服务网关"></a>八、Netflix Zuul 服务网关</h1><h2 id="8-1-Zuul-网关简介"><a href="#8-1-Zuul-网关简介" class="headerlink" title="8.1 Zuul 网关简介"></a>8.1 Zuul 网关简介</h2><h3 id="8-1-1-什么是网关"><a href="#8-1-1-什么是网关" class="headerlink" title="8.1.1 什么是网关"></a>8.1.1 什么是网关</h3><p>在我们的微服务架构中，调用链路错综复杂，我们来简单看一些服务中的调用：</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/springcloud/144.png"
                      alt="img"
                ></p>
<p>在分布式环境下，由于项目都被拆分成了若干的微服务，造成用户原本只需要请求一次就可以完成的业务，现在需要请求多个微服务来完成业务功能，如果客户端直接和微服务进行通信，会存在以下问题：</p>
<ul>
<li>客户端会多次请求不同微服务，增加客户端的复杂性</li>
<li>存在跨域请求，在一定场景下处理相对复杂</li>
<li>认证复杂，每一个服务都需要独立认证</li>
<li>难以重构，随着项目的迭代，可能需要重新划分微服务，如果客户端直接和微服务通信，那么重构会难以实施</li>
</ul>
<blockquote>
<p>上述问题，都可以借助微服务网关解决。微服务网关是介于客户端和服务器端之间的中间层，所有的外部请求都会先经过微服务网关。</p>
</blockquote>
<h3 id="8-1-2-什么是Zuul"><a href="#8-1-2-什么是Zuul" class="headerlink" title="8.1.2 什么是Zuul"></a>8.1.2 什么是Zuul</h3><p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/springcloud/135.png"
                      alt="img"
                ></p>
<p>Zuul 是 Netflix 开源的微服务网关，他可以和 Eureka,Ribbon,Hystrix等组件配合使用。Zuul组件的核心是一系列的过滤器，这些过滤器可以完成以下功能：</p>
<ul>
<li>单点入口</li>
<li>动态路由</li>
<li>限流熔断</li>
<li>统一认证</li>
<li>日志监控</li>
</ul>
<p>Spring Cloud 对 Zuul 进行了整合和增强。</p>
<p>引入了 Zuul网关 后，架构图演变为以下形式：</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/springcloud/143.png"
                      alt="img"
                ></p>
<blockquote>
<p>Github官网：<a class="link"   target="_blank" rel="noopener" href="https://github.com/Netflix/Zuul" >https://github.com/Netflix/Zuul <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
</blockquote>
<h2 id="8-2-Zuul-快速入门"><a href="#8-2-Zuul-快速入门" class="headerlink" title="8.2 Zuul 快速入门"></a>8.2 Zuul 快速入门</h2><h3 id="8-2-1-搭建Zuul网关工程"><a href="#8-2-1-搭建Zuul网关工程" class="headerlink" title="8.2.1 搭建Zuul网关工程"></a>8.2.1 搭建Zuul网关工程</h3><p>1）引入依赖：</p>
<div class="highlight-container" data-rel="Xml"><figure class="iseeu highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--zuul网关依赖--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-zuul<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></div>

<p>2）编写application.yml：</p>
<div class="highlight-container" data-rel="Yml"><figure class="iseeu highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">10102</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">zuul-server</span></span><br></pre></td></tr></table></figure></div>

<p>3）启动类：</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.cloud.zuul;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.netflix.zuul.EnableZuulProxy;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> lscl</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@intro</span>:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@EnableZuulProxy</span>                <span class="comment">// 开启Zuul网关代理</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ZuulApplication</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(ZuulApplication.class);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="8-2-2-Zuul网关路由规则"><a href="#8-2-2-Zuul网关路由规则" class="headerlink" title="8.2.2 Zuul网关路由规则"></a>8.2.2 Zuul网关路由规则</h3><h4 id="1）URL地址路由"><a href="#1）URL地址路由" class="headerlink" title="1）URL地址路由"></a>1）URL地址路由</h4><div class="highlight-container" data-rel="Yml"><figure class="iseeu highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">zuul:</span></span><br><span class="line">  <span class="attr">routes:</span></span><br><span class="line">    <span class="attr">item-service:</span>                   <span class="comment"># 路由Id,名称任意</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">/item-service/**</span>        <span class="comment"># 这里是映射路径</span></span><br><span class="line">      <span class="attr">url:</span> <span class="string">http://localhost:9000</span>    <span class="comment"># 映射路径对应的实际url地址</span></span><br></pre></td></tr></table></figure></div>

<ul>
<li>通配符匹配规则：</li>
</ul>
<table>
<thead>
<tr>
<th>通配符</th>
<th>说明</th>
<th>举例</th>
<th>示例</th>
</tr>
</thead>
<tbody><tr>
<td>?</td>
<td>匹配任意单个字符</td>
<td>&#x2F;item-service&#x2F;?</td>
<td>&#x2F;item-service&#x2F;a</td>
</tr>
<tr>
<td>*</td>
<td>匹配任意数量字符但不包含子路径</td>
<td>&#x2F;item-service&#x2F;*</td>
<td>&#x2F;item-service&#x2F;abc</td>
</tr>
<tr>
<td>**</td>
<td>匹配任意数量的字符包括下属的所有路径</td>
<td>&#x2F;item-service&#x2F;**</td>
<td>&#x2F;item-service&#x2F;abc&#x2F;abc</td>
</tr>
</tbody></table>
<p>访问：<a class="link"   target="_blank" rel="noopener" href="http://localhost:10102/item-service/item/findOrderById/1" >http://localhost:10102/item-service/item/findOrderById/1 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/springcloud/142.png"
                      alt="img"
                ></p>
<h4 id="2）服务名称路由"><a href="#2）服务名称路由" class="headerlink" title="2）服务名称路由"></a>2）服务名称路由</h4><p>微服务一般是由几十、上百个服务组成，对于一个URL请求，最终会确认一个服务实例进行处理。如果对每个服务实例手动指定一个唯一访问地址，然后根据URL去手动实现请求匹配，这样做显然就不合理。</p>
<p>Zuul支持与Eureka整合开发，根据ServiceID自动的从注册中心中获取服务地址并转发请求，这样做的好处不仅可以通过单个端点来访问应用的所有服务，而且在添加或移除服务实例的时候不用修改Zuul的路由配置。</p>
<p>1）添加Eureka的依赖：</p>
<div class="highlight-container" data-rel="Xml"><figure class="iseeu highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--引入eureka客户端依赖--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></div>

<p>2）在ZuulApplication引导类上添加注解：</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableEurekaClient</span></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br></pre></td></tr></table></figure></div>

<p>3）修改application.yml：</p>
<div class="highlight-container" data-rel="Yml"><figure class="iseeu highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">10102</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">zuul-server</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://127.0.0.1:10101/eureka</span>    <span class="comment"># 注册到Eureka</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">prefer-ip-address:</span> <span class="literal">true</span>         <span class="comment"># 使用ip地址注册服务(默认情况下是以主机注册)</span></span><br><span class="line">    <span class="attr">instance-id:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:$&#123;server.port&#125;</span>   <span class="comment"># 实例id</span></span><br><span class="line"><span class="attr">zuul:</span></span><br><span class="line">  <span class="attr">routes:</span></span><br><span class="line">    <span class="attr">item-service:</span>                           <span class="comment"># 路由Id,名称任意</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">/item-service/**</span>              	<span class="comment"># 这里是映射路径</span></span><br><span class="line">      <span class="attr">serviceId:</span> <span class="string">item-service</span>               <span class="comment"># 将拦截到的请求转发到当前微服务</span></span><br></pre></td></tr></table></figure></div>

<p>再次访问：<a class="link"   target="_blank" rel="noopener" href="http://localhost:10102/item-service/item/findOrderById/1" >http://localhost:10102/item-service/item/findOrderById/1 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<blockquote>
<p>tips：服务名称路由的前提条件是服务必须首先注册到Eureka注册中心，然后根据服务名路由，URL路由则可以跳转到任意网站；</p>
</blockquote>
<h4 id="3）简化路由配置"><a href="#3）简化路由配置" class="headerlink" title="3）简化路由配置"></a>3）简化路由配置</h4><p>当路由id与微服务名称一致时，我们可以不写serviceId，默认取路由id为微服务名称</p>
<div class="highlight-container" data-rel="Yml"><figure class="iseeu highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">zuul:</span></span><br><span class="line">  <span class="attr">routes:</span></span><br><span class="line">    <span class="attr">item-service:</span>                           <span class="comment"># 路由Id,名称任意</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">/abc/**</span>              	<span class="comment"># 这里是映射路径</span></span><br></pre></td></tr></table></figure></div>

<p>再次访问：<a class="link"   target="_blank" rel="noopener" href="http://localhost:10102/abc/item/findOrderById/1" >http://localhost:10102/abc/item/findOrderById/1 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/springcloud/141.png"
                      alt="img"
                ></p>
<h4 id="4）默认路由配置"><a href="#4）默认路由配置" class="headerlink" title="4）默认路由配置"></a>4）默认路由配置</h4><p>如果路由id与path路径与微服务名称三者一致时，那么zuul网关的路由配置可以省略，三者默认都为微服务名称，把zuul路由的配置去掉：</p>
<div class="highlight-container" data-rel="Yml"><figure class="iseeu highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#zuul:</span></span><br><span class="line"><span class="comment">#  routes:</span></span><br><span class="line"><span class="comment">#    item-service:                           # 路由Id,名称任意</span></span><br><span class="line"><span class="comment">#      path: /item-service/**              	# 这里是映射路径</span></span><br><span class="line"><span class="comment">#      serviceId: item-service               # 将拦截到的请求转发到当前微服务</span></span><br></pre></td></tr></table></figure></div>

<p>访问：<a class="link"   target="_blank" rel="noopener" href="http://localhost:10102/item-service/item/findOrderById/1%EF%BC%8Chttp://localhost:10102/order-service/order/1" >http://localhost:10102/item-service/item/findOrderById/1，http://localhost:10102/order-service/order/1 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<h4 id="5）路由前缀"><a href="#5）路由前缀" class="headerlink" title="5）路由前缀"></a>5）路由前缀</h4><div class="highlight-container" data-rel="Yml"><figure class="iseeu highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">zuul:</span></span><br><span class="line">  <span class="attr">routes:</span></span><br><span class="line">    <span class="attr">item-service:</span>                           <span class="comment"># 路由Id,名称任意</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">/item-service/**</span>              	<span class="comment"># 这里是映射路径</span></span><br><span class="line">      <span class="attr">serviceId:</span> <span class="string">item-service</span>               <span class="comment"># 将拦截到的请求转发到当前微服务</span></span><br><span class="line">  <span class="attr">prefix:</span> <span class="string">/api</span></span><br></pre></td></tr></table></figure></div>

<p><a class="link"   target="_blank" rel="noopener" href="http://localhost:10102/api/item-service/item/findOrderById/1" >http://localhost:10102/api/item-service/item/findOrderById/1 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/springcloud/136.png"
                      alt="img"
                ></p>
<h3 id="8-2-3-路由排除"><a href="#8-2-3-路由排除" class="headerlink" title="8.2.3 路由排除"></a>8.2.3 路由排除</h3><h4 id="1）URL地址排除"><a href="#1）URL地址排除" class="headerlink" title="1）URL地址排除"></a>1）URL地址排除</h4><div class="highlight-container" data-rel="Yml"><figure class="iseeu highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">zuul:</span></span><br><span class="line">  <span class="attr">ignored-patterns:</span> <span class="string">/**/item/findOrderById/**,/**/order/**</span>      <span class="comment"># 忽略这两个路径 多个路径用,隔开</span></span><br><span class="line">  <span class="attr">routes:</span></span><br><span class="line">    <span class="attr">item-service:</span>                           <span class="comment"># 路由Id,名称任意</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">/item-service/**</span>              	<span class="comment"># 这里是映射路径</span></span><br><span class="line">      <span class="attr">serviceId:</span> <span class="string">item-service</span>               <span class="comment"># 将拦截到的请求转发到当前微服务</span></span><br></pre></td></tr></table></figure></div>

<h4 id="2）服务名排除"><a href="#2）服务名排除" class="headerlink" title="2）服务名排除"></a>2）服务名排除</h4><p>根据服务名指定该服务不进行路由转发（只能忽略默认路由配置）</p>
<div class="highlight-container" data-rel="Yml"><figure class="iseeu highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">zuul:</span></span><br><span class="line">  <span class="attr">ignored-services:</span> <span class="string">order-service</span>           <span class="comment"># order-service的服务请求不进行路由,多个服务用,隔开</span></span><br></pre></td></tr></table></figure></div>

<h4 id="3）请求头排除"><a href="#3）请求头排除" class="headerlink" title="3）请求头排除"></a>3）请求头排除</h4><p>关于请求头排除的配置有<code>ignored-headers</code>、<code>sensitiveHeaders</code></p>
<ul>
<li><code>ignored-headers</code>：<strong>默认情况下，请求头都会被传递到下游服务</strong>，通过<code>ignored-headers</code>参数可以过滤掉一些不需要传递的请求头；</li>
</ul>
<p>配置方式：</p>
<div class="highlight-container" data-rel="Yml"><figure class="iseeu highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">zuul:</span></span><br><span class="line">	<span class="attr">ignored-headers:</span> <span class="string">flag_a</span>			<span class="comment"># 忽略flag_a请求头,flag_a请求头将不会被传递到下游服务</span></span><br></pre></td></tr></table></figure></div>

<ul>
<li><code>sensitiveHeaders</code>：和<code>ignored-headers</code>作用一致，配置拦截下来的请求头，默认情况下<code>Cookie</code>、<code>Set-Cookie</code>、<code>Authorization</code>请求头将被拦截；</li>
</ul>
<p>配置方式：</p>
<div class="highlight-container" data-rel="Yml"><figure class="iseeu highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">zuul:</span></span><br><span class="line">  <span class="attr">routes:</span></span><br><span class="line">    <span class="attr">item-service:</span>                           <span class="comment"># 路由Id,名称任意</span></span><br><span class="line">      <span class="attr">sensitiveHeaders:</span> []					<span class="comment"># 针对某个微服务配置,放行Cookie、Set-Cookie、Authorization等请求头</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">/item-service/**</span>              	<span class="comment"># 这里是映射路径</span></span><br><span class="line">      <span class="attr">serviceId:</span> <span class="string">item-service</span>               <span class="comment"># 将拦截到的请求转发到当前微服务</span></span><br><span class="line">  <span class="attr">sensitiveHeaders:</span> []						<span class="comment"># 全局配置</span></span><br></pre></td></tr></table></figure></div>

<blockquote>
<p><code>ignored-headers</code>只能全局配置，不能局部配置，<code>sensitiveHeaders</code>可以全局配置和局部配置；</p>
</blockquote>
<ul>
<li>测试请求头传递，扩展ItemController：</li>
</ul>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 测试zuul传递请求头和Cookie</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> request</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@PostMapping(&quot;/testHeader&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Map <span class="title function_">testHeader</span><span class="params">(HttpServletRequest request)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>() &#123;&#123;</span><br><span class="line">        put(<span class="string">&quot;flag_a&quot;</span>, request.getHeader(<span class="string">&quot;flag_a&quot;</span>));</span><br><span class="line">        put(<span class="string">&quot;flag_b&quot;</span>, request.getHeader(<span class="string">&quot;flag_b&quot;</span>));</span><br><span class="line">        put(<span class="string">&quot;cookie&quot;</span>, Arrays.asList(request.getCookies() == <span class="literal">null</span> ? <span class="string">&quot;null&quot;</span> : request.getCookies()));</span><br><span class="line">    &#125;&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>使用Postman发送请求：<a class="link"   target="_blank" rel="noopener" href="http://localhost:10102/item-service/item/testHeader" >http://localhost:10102/item-service/item/testHeader <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/springcloud/140.png"
                      alt="img"
                ></p>
<blockquote>
<p>tips：此时zuul并没有配置任何的请求头过滤；</p>
</blockquote>
<ul>
<li>配置zuul请求头过滤：</li>
</ul>
<div class="highlight-container" data-rel="Yml"><figure class="iseeu highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">zuul:</span></span><br><span class="line">  <span class="attr">routes:</span></span><br><span class="line">    <span class="attr">item-service:</span>                           <span class="comment"># 路由Id,名称任意</span></span><br><span class="line">      <span class="attr">ignored-headers:</span> <span class="string">flag_a</span>				<span class="comment"># ignored-headers局部过滤是不生效的</span></span><br><span class="line">      <span class="attr">sensitiveHeaders:</span> []					<span class="comment"># 将这里设为空,放行Cookie、Set-Cookie、Authorization等请求头</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">/item-service/**</span>              	<span class="comment"># 这里是映射路径</span></span><br><span class="line">      <span class="attr">serviceId:</span> <span class="string">item-service</span>               <span class="comment"># 将拦截到的请求转发到当前微服务</span></span><br></pre></td></tr></table></figure></div>

<p>再次访问：<a class="link"   target="_blank" rel="noopener" href="http://localhost:10102/item-service/item/testHeader" >http://localhost:10102/item-service/item/testHeader <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/springcloud/139.png"
                      alt="img"
                ></p>
<p>配置全局忽略：</p>
<div class="highlight-container" data-rel="Yml"><figure class="iseeu highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">zuul:</span></span><br><span class="line">  <span class="attr">routes:</span></span><br><span class="line">    <span class="attr">item-service:</span>                           <span class="comment"># 路由Id,名称任意</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">/item-service/**</span>              	<span class="comment"># 这里是映射路径</span></span><br><span class="line">      <span class="attr">serviceId:</span> <span class="string">item-service</span>               <span class="comment"># 将拦截到的请求转发到当前微服务</span></span><br><span class="line">  <span class="attr">ignored-headers:</span> <span class="string">flag_a</span></span><br><span class="line">  <span class="attr">sensitiveHeaders:</span> []</span><br></pre></td></tr></table></figure></div>

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/springcloud/138.png"
                      alt="img"
                ></p>
<h2 id="8-3-Zuul-的过滤器"><a href="#8-3-Zuul-的过滤器" class="headerlink" title="8.3 Zuul 的过滤器"></a>8.3 Zuul 的过滤器</h2><p>在Zuul包含有两大核心功能，第一个是路由，另一个就是过滤器了，路由可以对客户端访问的URL进行跳转，过滤器则是对整个请求的一些拦截操作；在Zuul中提供有一系列内置的过滤器，也可以让用户自定义编写过滤器来实现自身业务的功能；</p>
<h3 id="8-3-1-过滤器的执行流程"><a href="#8-3-1-过滤器的执行流程" class="headerlink" title="8.3.1 过滤器的执行流程"></a>8.3.1 过滤器的执行流程</h3><p>在Zuul中提供有4种过滤器，分别为<code>pre</code>、<code>route</code>、<code>post</code>、<code>error</code></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/springcloud/133.png"
                      alt="img"
                ></p>
<ul>
<li><code>pre</code>：在请求被路由之前调用；</li>
<li><code>route</code>：将要进行路由时调用（路由之前调用，只不过比<code>pre</code>过滤器后执行）</li>
<li><code>post</code>：路由调用完毕或<code>error</code>过滤器之后执行</li>
<li><code>error</code>：在其他过滤器出现异常时执行；</li>
</ul>
<h3 id="8-3-2-自定义过滤器"><a href="#8-3-2-自定义过滤器" class="headerlink" title="8.3.2 自定义过滤器"></a>8.3.2 自定义过滤器</h3><p>如果我们想要自定义一个过滤器可以继承ZuulFilter抽象类：</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.cloud.zuul.filter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.netflix.zuul.ZuulFilter;</span><br><span class="line"><span class="keyword">import</span> com.netflix.zuul.exception.ZuulException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> lscl</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@intro</span>:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PreFilter</span> <span class="keyword">extends</span> <span class="title class_">ZuulFilter</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 执行时机</span></span><br><span class="line"><span class="comment">     * pre:     在进入微服网关之间执行</span></span><br><span class="line"><span class="comment">     * route:   在执行微服务网关之前执行(在pre过滤器之后)执行</span></span><br><span class="line"><span class="comment">     * post:    在执行微服务网关之后执行</span></span><br><span class="line"><span class="comment">     * error:   在执行其他过滤器出错时执行</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">filterType</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;pre&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 执行顺序</span></span><br><span class="line"><span class="comment">     * 数字越大,优先级越低</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">filterOrder</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 是否执行该过滤器</span></span><br><span class="line"><span class="comment">     * true:执行</span></span><br><span class="line"><span class="comment">     * false:不执行</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">shouldFilter</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 过滤器执行逻辑</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 返回null代表放行, 访问对应的微服务</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> ZuulException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">run</span><span class="params">()</span> <span class="keyword">throws</span> ZuulException &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;PreFilter....&quot;</span> + System.currentTimeMillis());</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>定义四个过滤器，类型分别为pre、route、post、error，发送请求查看执行顺序</p>
<h3 id="8-3-3-Zuul的异常处理"><a href="#8-3-3-Zuul的异常处理" class="headerlink" title="8.3.3 Zuul的异常处理"></a>8.3.3 Zuul的异常处理</h3><p>在Zuul网关的众多过滤器中，如果有某个过滤器出现了异常，虽然会执行我们自定义的Error过滤器，但是错误响应信息却不能被我自定义，我们需要禁用Zuul网关提供的错误过滤器，如果出现了异常，则使用我们自己的过滤器，定制错误响应信息：</p>
<p>编写一个Error类型的过滤器：</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.cloud.zuul.filter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.core.JsonProcessingException;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;</span><br><span class="line"><span class="keyword">import</span> com.netflix.zuul.ZuulFilter;</span><br><span class="line"><span class="keyword">import</span> com.netflix.zuul.context.RequestContext;</span><br><span class="line"><span class="keyword">import</span> com.netflix.zuul.exception.ZuulException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.HttpStatus;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> lscl</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@intro</span>:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ErrorFilter</span> <span class="keyword">extends</span> <span class="title class_">ZuulFilter</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">filterType</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;error&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">filterOrder</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">shouldFilter</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">run</span><span class="params">()</span> <span class="keyword">throws</span> ZuulException &#123;</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;error...&quot;</span>);</span><br><span class="line">        <span class="comment">// Zuul网关提供的上下文对象</span></span><br><span class="line">        <span class="type">RequestContext</span> <span class="variable">context</span> <span class="operator">=</span> RequestContext.getCurrentContext();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 终止请求往下执行</span></span><br><span class="line">        context.setSendZuulResponse(<span class="literal">false</span>);</span><br><span class="line">        <span class="comment">// 状态码</span></span><br><span class="line">        context.setResponseStatusCode(HttpStatus.INTERNAL_SERVER_ERROR.value());</span><br><span class="line"></span><br><span class="line">        <span class="type">HttpServletResponse</span> <span class="variable">response</span> <span class="operator">=</span> context.getResponse();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 自定义响应内容</span></span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">jsonMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>() &#123;&#123;</span><br><span class="line">            put(<span class="string">&quot;flag&quot;</span>, <span class="literal">true</span>);</span><br><span class="line">            put(<span class="string">&quot;statusCode&quot;</span>, <span class="string">&quot;500&quot;</span>);</span><br><span class="line">            put(<span class="string">&quot;message&quot;</span>, HttpStatus.INTERNAL_SERVER_ERROR.getReasonPhrase());</span><br><span class="line">        &#125;&#125;;</span><br><span class="line">        response.setContentType(<span class="string">&quot;application/json;charset=utf8&quot;</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            response.getWriter().write(<span class="keyword">new</span> <span class="title class_">ObjectMapper</span>().writeValueAsString(jsonMap));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>



<p>在Pre过滤器中触发异常：</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.cloud.zuul.filter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.core.JsonProcessingException;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;</span><br><span class="line"><span class="keyword">import</span> com.netflix.zuul.ZuulFilter;</span><br><span class="line"><span class="keyword">import</span> com.netflix.zuul.context.RequestContext;</span><br><span class="line"><span class="keyword">import</span> com.netflix.zuul.exception.ZuulException;</span><br><span class="line"><span class="keyword">import</span> org.bouncycastle.asn1.ocsp.ResponseData;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> lscl</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@intro</span>:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PreFilter</span> <span class="keyword">extends</span> <span class="title class_">ZuulFilter</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 执行时机</span></span><br><span class="line"><span class="comment">     * pre:     在进入微服网关之间执行</span></span><br><span class="line"><span class="comment">     * route:   在执行微服务网关时执行</span></span><br><span class="line"><span class="comment">     * post:    在执行微服务网关之后执行</span></span><br><span class="line"><span class="comment">     * error:   在执行微服务出错执行</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">filterType</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;pre&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 执行顺序</span></span><br><span class="line"><span class="comment">     * 数字越大,优先级越低</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">filterOrder</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 是否执行该过滤器</span></span><br><span class="line"><span class="comment">     * true:执行</span></span><br><span class="line"><span class="comment">     * false:不执行</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">shouldFilter</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 过滤器执行逻辑</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 访问对应的微服务</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> ZuulException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">run</span><span class="params">()</span> <span class="keyword">throws</span> ZuulException &#123;</span><br><span class="line">        </span><br><span class="line">        System.out.println(<span class="string">&quot;PreFilter....&quot;</span> + System.currentTimeMillis());</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 触发异常</span></span><br><span class="line">        <span class="type">int</span> i=<span class="number">1</span>/<span class="number">0</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/springcloud/121.png"
                      alt="img"
                ></p>
<blockquote>
<p>发现错误信息不是我们自定义的错误响应；</p>
</blockquote>
<ul>
<li>禁用Zuul默认的Error过滤器：</li>
</ul>
<div class="highlight-container" data-rel="Yml"><figure class="iseeu highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">zuul:</span></span><br><span class="line">  <span class="attr">SendErrorFilter:</span></span><br><span class="line">    <span class="attr">error:</span></span><br><span class="line">        <span class="attr">disable:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure></div>

<p>重启Zuul网关，重新访问：</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/springcloud/120.png"
                      alt="img"
                ></p>
<h3 id="8-3-4-Zuul统一鉴权"><a href="#8-3-4-Zuul统一鉴权" class="headerlink" title="8.3.4 Zuul统一鉴权"></a>8.3.4 Zuul统一鉴权</h3><p>设计一个微服务网关，前端传递token&#x3D;1，否则进行拦截：</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.cloud.zuul.filter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.core.JsonProcessingException;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;</span><br><span class="line"><span class="keyword">import</span> com.netflix.zuul.ZuulFilter;</span><br><span class="line"><span class="keyword">import</span> com.netflix.zuul.context.RequestContext;</span><br><span class="line"><span class="keyword">import</span> com.netflix.zuul.exception.ZuulException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> lscl</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@intro</span>:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PreFilter</span> <span class="keyword">extends</span> <span class="title class_">ZuulFilter</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 执行时机</span></span><br><span class="line"><span class="comment">     * pre:     在进入微服网关之间执行</span></span><br><span class="line"><span class="comment">     * route:   在执行微服务网关时执行</span></span><br><span class="line"><span class="comment">     * post:    在执行微服务网关之后执行</span></span><br><span class="line"><span class="comment">     * error:   在执行微服务出错执行</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">filterType</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;pre&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 执行顺序</span></span><br><span class="line"><span class="comment">     * 数字越大,优先级越低</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">filterOrder</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 是否执行该过滤器</span></span><br><span class="line"><span class="comment">     * true:执行</span></span><br><span class="line"><span class="comment">     * false:不执行</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">shouldFilter</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 过滤器执行逻辑</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 访问对应的微服务</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> ZuulException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">run</span><span class="params">()</span> <span class="keyword">throws</span> ZuulException &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;PreFilter....&quot;</span> + System.currentTimeMillis());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Zuul网关提供的上下文对象</span></span><br><span class="line">        <span class="type">RequestContext</span> <span class="variable">context</span> <span class="operator">=</span> RequestContext.getCurrentContext();</span><br><span class="line"></span><br><span class="line">        <span class="type">HttpServletRequest</span> <span class="variable">request</span> <span class="operator">=</span> context.getRequest();</span><br><span class="line"></span><br><span class="line">        <span class="type">HttpServletResponse</span> <span class="variable">response</span> <span class="operator">=</span> context.getResponse();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取提交的token</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> request.getParameter(<span class="string">&quot;token&quot;</span>);</span><br><span class="line"></span><br><span class="line">        response.setContentType(<span class="string">&quot;application/json;charset=utf8&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span>(!<span class="string">&quot;1&quot;</span>.equals(token))&#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 终止请求</span></span><br><span class="line">            context.setSendZuulResponse(<span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">            <span class="type">HashMap</span> <span class="variable">jsonMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>() &#123;&#123;</span><br><span class="line">                put(<span class="string">&quot;flag&quot;</span>, <span class="literal">true</span>);</span><br><span class="line">                put(<span class="string">&quot;statusCode&quot;</span>, <span class="string">&quot;500&quot;</span>);</span><br><span class="line">                put(<span class="string">&quot;message&quot;</span>,<span class="string">&quot;权限不足&quot;</span>);</span><br><span class="line">            &#125;&#125;;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 设置响应体</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                context.setResponseBody(<span class="keyword">new</span> <span class="title class_">ObjectMapper</span>().writeValueAsString(jsonMap));</span><br><span class="line">            &#125; <span class="keyword">catch</span> (JsonProcessingException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// return方法,为了防止代码往下执行,返回值随意</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>访问：<a class="link"   target="_blank" rel="noopener" href="http://localhost:10102/item-service/item/findOrderById/1" >http://localhost:10102/item-service/item/findOrderById/1 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/springcloud/132.png"
                      alt="img"
                ></p>
<h2 id="8-4-Zuul-实现服务降级"><a href="#8-4-Zuul-实现服务降级" class="headerlink" title="8.4 Zuul 实现服务降级"></a>8.4 Zuul 实现服务降级</h2><p>在Zuul中提供了<code>FallbackProvider</code>接口，来帮助我们实现Zuul在路由时进行服务降级，需要注意的是，<strong>Zuul提供的服务降级只针对于timeout超时情况的降级</strong>，如果路由到的具体下游服务出现异常，那么不会触发Zuul的降级处理，应该由具体微服务来提供降级处理；</p>
<blockquote>
<p>Tips：在Edgware版本之前（不含），Zuul降级接口为<code>ZuulFallbackProvider</code>，从Edgware后（含），Zuul提供<code>FallbackProvider</code>来提供降级处理；</p>
</blockquote>
<p>修改ItemController：</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/findOrderAll&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Map <span class="title function_">findOrderAll</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 模拟线程阻塞</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Thread.sleep(<span class="number">3000</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">Map</span> <span class="variable">resultMap</span> <span class="operator">=</span> restTemplate.getForObject(<span class="string">&quot;http://order-service/order/&quot;</span>, Map.class);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> resultMap;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h4 id="1）降级处理类"><a href="#1）降级处理类" class="headerlink" title="1）降级处理类"></a>1）降级处理类</h4><ul>
<li>在Zuul网关服务编写降级类：</li>
</ul>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.cloud.zuul.fallback;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.netflix.zuul.filters.route.FallbackProvider;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.HttpHeaders;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.HttpStatus;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.MediaType;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.client.ClientHttpResponse;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.nio.charset.Charset;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> lscl</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@intro</span>:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ItemFallBack</span> <span class="keyword">implements</span> <span class="title class_">FallbackProvider</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 需要降级的服务名称 &#x27;*&#x27;表示为所有服务提供降级</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getRoute</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;item-service&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> ClientHttpResponse <span class="title function_">fallbackResponse</span><span class="params">(String route, Throwable cause)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ClientHttpResponse</span>() &#123;</span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * ClientHttpResponse 的 fallback 的状态码 返回HttpStatus</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> HttpStatus <span class="title function_">getStatusCode</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">                <span class="keyword">return</span> HttpStatus.OK;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * ClientHttpResponse 的 fallback 的状态码 返回 int</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getRawStatusCode</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">                <span class="keyword">return</span> getStatusCode().value();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * ClientHttpResponse 的 fallback 的状态码 返回 String</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> String <span class="title function_">getStatusText</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">                <span class="keyword">return</span> getStatusCode().getReasonPhrase();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 设置响应体</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> InputStream <span class="title function_">getBody</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">                <span class="type">HashMap</span> <span class="variable">jsonMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>() &#123;&#123;</span><br><span class="line">                    put(<span class="string">&quot;flag&quot;</span>, <span class="literal">true</span>);</span><br><span class="line">                    put(<span class="string">&quot;statusCode&quot;</span>, <span class="string">&quot;500&quot;</span>);</span><br><span class="line">                    put(<span class="string">&quot;message&quot;</span>, <span class="string">&quot;服务器忙，请稍后重试！&quot;</span>);</span><br><span class="line">                &#125;&#125;;</span><br><span class="line">                <span class="type">String</span> <span class="variable">jsonResult</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>().writeValueAsString(jsonMap);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(jsonResult.getBytes());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 设置响应的头信息</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> HttpHeaders <span class="title function_">getHeaders</span><span class="params">()</span> &#123;</span><br><span class="line">                <span class="type">HttpHeaders</span> <span class="variable">httpHeaders</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HttpHeaders</span>();</span><br><span class="line">                <span class="type">MediaType</span> <span class="variable">mediaType</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MediaType</span>(<span class="string">&quot;application&quot;</span>, <span class="string">&quot;json&quot;</span>, Charset.forName(<span class="string">&quot;utf-8&quot;</span>));</span><br><span class="line">                httpHeaders.setContentType(mediaType);</span><br><span class="line">                <span class="keyword">return</span> httpHeaders;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">close</span><span class="params">()</span> &#123;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>访问：<a class="link"   target="_blank" rel="noopener" href="http://localhost:10102/item-service/item/findOrderAll" >http://localhost:10102/item-service/item/findOrderAll <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/springcloud/131.png"
                      alt="img"
                ></p>
<h4 id="2）修改超时设置"><a href="#2）修改超时设置" class="headerlink" title="2）修改超时设置"></a>2）修改超时设置</h4><p>Zuul的路由转发是通过Ribbon来转发实现的，因此超时设置是通过Ribbon的超时设置来控制的：</p>
<ul>
<li>在ZuulServer中的application.yml配置：</li>
</ul>
<div class="highlight-container" data-rel="Yml"><figure class="iseeu highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">ribbon:</span></span><br><span class="line">  <span class="attr">ReadTimeout:</span> <span class="number">4000</span>       <span class="comment"># zuul路由到具体微服务,微服务响应的时间</span></span><br><span class="line">  <span class="attr">ConnectTimeout:</span> <span class="number">4000</span>    <span class="comment"># zuul路由到具体微服务的连接时间</span></span><br></pre></td></tr></table></figure></div>

<blockquote>
<p>Tips：默认情况下，如果没有配置降级，超时则执行Error类型的Filter来处理；</p>
</blockquote>
<h2 id="8-5-Zuul-整合Hystrix-DashBoard"><a href="#8-5-Zuul-整合Hystrix-DashBoard" class="headerlink" title="8.5 Zuul 整合Hystrix DashBoard"></a>8.5 Zuul 整合Hystrix DashBoard</h2><p>我们搭建微服务网关后，由于网关提供了下游服务的统一路口，请求都是由网关统一路由到下游服务，我们可以通过之前学习过的Hystrix仪表盘来监控网关达到监控各个微服务的调用情况；</p>
<h3 id="8-5-1-搭建DashBoard工程"><a href="#8-5-1-搭建DashBoard工程" class="headerlink" title="8.5.1 搭建DashBoard工程"></a>8.5.1 搭建DashBoard工程</h3><p>1）引入Dash Board依赖：</p>
<div class="highlight-container" data-rel="Xml"><figure class="iseeu highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--dashboard监控依赖--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-hystrix-dashboard<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></div>

<p>2）编写配置：</p>
<div class="highlight-container" data-rel="Yml"><figure class="iseeu highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8888</span></span><br><span class="line"><span class="attr">hystrix:</span></span><br><span class="line">  <span class="attr">dashboard:</span></span><br><span class="line">    <span class="attr">proxy-stream-allow-list:</span> <span class="string">&quot;localhost&quot;</span>        <span class="comment"># 允许本机访问</span></span><br></pre></td></tr></table></figure></div>

<p>3）启动类：</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.cloud.dashboard;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.netflix.hystrix.dashboard.EnableHystrixDashboard;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> lscl</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@intro</span>:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@EnableHystrixDashboard</span>         <span class="comment">// 开启DashBoard仪表盘</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DashBoardApplication</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(DashBoardApplication.class);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="8-5-2-修改Zuul网关工程"><a href="#8-5-2-修改Zuul网关工程" class="headerlink" title="8.5.2 修改Zuul网关工程"></a>8.5.2 修改Zuul网关工程</h3><p>1）引入actuator依赖：</p>
<div class="highlight-container" data-rel="Xml"><figure class="iseeu highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--SpringBoot监控依赖--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></div>

<p>2）开放端点：</p>
<div class="highlight-container" data-rel="Yml"><figure class="iseeu highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">management:</span></span><br><span class="line">  <span class="attr">endpoints:</span></span><br><span class="line">    <span class="attr">web:</span></span><br><span class="line">      <span class="attr">exposure:</span></span><br><span class="line">        <span class="attr">include:</span> <span class="string">&#x27;*&#x27;</span>      <span class="comment"># 开放所有监控端点</span></span><br></pre></td></tr></table></figure></div>



<h3 id="8-5-3-测试"><a href="#8-5-3-测试" class="headerlink" title="8.5.3 测试"></a>8.5.3 测试</h3><p>访问DashBoard工程：<a class="link"   target="_blank" rel="noopener" href="http://locahost:8888/hystrix" >http://locahost:8888/hystrix <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/springcloud/130.png"
                      alt="img"
                ></p>
<p>访问：<a class="link"   target="_blank" rel="noopener" href="http://localhost:10102/actuator/hystrix.stream" >http://localhost:10102/actuator/hystrix.stream <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/springcloud/128.png"
                      alt="img"
                ></p>
<p>访问任意接口：<a class="link"   target="_blank" rel="noopener" href="http://localhost:10102/item-service/item/findOrderById/1?token=1" >http://localhost:10102/item-service/item/findOrderById/1?token=1 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/springcloud/127.png"
                      alt="img"
                ></p>
<p>查看Hystrix DashBoard：</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/springcloud/129.png"
                      alt="img"
                ></p>
<h2 id="8-6-Zuul-服务限流"><a href="#8-6-Zuul-服务限流" class="headerlink" title="8.6 Zuul 服务限流"></a>8.6 Zuul 服务限流</h2><p>我们都知道Zuul是所有服务的入口，Zuul提供了一套完善的服务限流机制，在访问量过大时，我们可以通过Zuul提供的限流机制来对大流量进行限流处理，保护下游服务；</p>
<p>任何的服务都应该流量限制功能，在防止流量异常激增导致下游服务出现雪崩等情况，如：</p>
<ul>
<li>双十一、618等</li>
<li>微博热搜</li>
<li>秒杀活动</li>
<li>恶意请求等</li>
</ul>
<p>上述情况都属于未知场景，超出的流量远远大于微服务所能承受的最大极限，我们希望在到达服务流量极限时，我们可以对客户端进行限流处理，防止服务瘫痪、溢出等严重情况的发生；</p>
<p>通常的限流算法有：计数器算法（Counter）、漏桶算法（Leaky Bucket）、令牌通算法（Token Bucket）等；</p>
<h3 id="8-6-1-计数器算法"><a href="#8-6-1-计数器算法" class="headerlink" title="8.6.1 计数器算法"></a>8.6.1 计数器算法</h3><h4 id="1）算法原理"><a href="#1）算法原理" class="headerlink" title="1）算法原理"></a>1）算法原理</h4><p>计数器算法是限流算法里最简单也是最容易实现的一种算法。比如我们限制一个接口每分钟调用不能超过100次，我们可以这样设计，定义2个变量，一个是访问次数，一个是记录访问次数计算的开始时间，如果记录时间和当前时间比较大于1分钟，则重新计时，如果在一分钟以内，我们把访问次数加一。</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/springcloud/126.png"
                      alt="img"
                ></p>
<h4 id="2）临界值问题："><a href="#2）临界值问题：" class="headerlink" title="2）临界值问题："></a>2）临界值问题：</h4><p>计数器算法（Connter）实现起来非常简单，但却有个非常大的弊端，那就是临界值问题；</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/springcloud/125.png"
                      alt="img"
                ></p>
<p>我们知道计数器算法等到指定的时间（我们上面是1分钟）结束后会清空Counter，在下一分钟后会重新累计阈值100，那么如果在第1分钟的59s发送了100个请求，紧接着第2分钟的1s发送了100个请求呢？此时后端的访问便在1秒钟接受到了200个请求；我们设定的阈值是100&#x2F;min，平均约为1.7&#x2F;s个请求，而临界值在1s钟发送了200个请求！</p>
<h4 id="3）性能浪费"><a href="#3）性能浪费" class="headerlink" title="3）性能浪费"></a>3）性能浪费</h4><p>我们规定1min之内可以接受100个请求，我们预期的想法是希望100个请求能够平均分散在这1min，如果在30s时请求满了100个时，那么接下来的30s内访问便处于空闲状态；</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/springcloud/124.png"
                      alt="img"
                ></p>
<h3 id="8-6-2-漏桶算法"><a href="#8-6-2-漏桶算法" class="headerlink" title="8.6.2 漏桶算法"></a>8.6.2 漏桶算法</h3><h4 id="1）算法原理-1"><a href="#1）算法原理-1" class="headerlink" title="1）算法原理"></a>1）算法原理</h4><p>漏桶（Leaky Bucket）算法思路也很简单，水（请求）先进入到储蓄桶中，储蓄桶有一定的水流频率（接口的响应速率），当水流入速度过大会直接溢出（访问频率超过接口响应速率），然后就拒绝请求，可以看出漏桶算法能强行限制数据的传输速率；</p>
<p>示意图如下:</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/springcloud/123.png"
                      alt="img"
                ></p>
<p>我们之前所学的RabbitMQ限流其实就是一种漏桶算法，可以接受大量的Message（水），存储到Queue中（储蓄桶），但是消费频率低（水流频率）</p>
<h4 id="2）弊端"><a href="#2）弊端" class="headerlink" title="2）弊端"></a>2）弊端</h4><ul>
<li>1、漏桶算法的实现思路是一种”牺牲自己，保护他人”的理念，假设次数请求很多，而响应速率比较慢，则大量的请求挤压在网关中</li>
<li>2、漏桶算法无法应对突发情况的大流量调用，不管网关接受多少请求，响应速率始终一成不变，容易导致网关请求挤压过多；</li>
</ul>
<h3 id="8-6-3-令牌桶算法"><a href="#8-6-3-令牌桶算法" class="headerlink" title="8.6.3 令牌桶算法"></a>8.6.3 令牌桶算法</h3><p>令牌桶算法是基于漏桶算法的一种改进，令牌桶算法能应对一些突发情况的大流量调用。在令牌桶算法中，以一定速率往桶中放令牌，桶中存储了大量的令牌（Token），每次处理请求前需要先获取令牌才可以执行，否则处于等待令牌状态或直接拒绝。如果桶中的令牌达到上限，就丢弃令牌；</p>
<p>算法示意图：</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/springcloud/122.png"
                      alt="img"
                ></p>
<h3 id="8-6-4-Zuul网关实现流量限流"><a href="#8-6-4-Zuul网关实现流量限流" class="headerlink" title="8.6.4 Zuul网关实现流量限流"></a>8.6.4 Zuul网关实现流量限流</h3><p>基于Zuul的filter开发的限流功能，可以结合本地缓存、redis、consul、mysql等做数据存储。</p>
<p>引入限流相关依赖：</p>
<div class="highlight-container" data-rel="Xml"><figure class="iseeu highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--Zuul限流的相关依赖--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.marcosbarbero.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-zuul-ratelimit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.5.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--Redis依赖--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></div>



<h4 id="1）全局网关限流"><a href="#1）全局网关限流" class="headerlink" title="1）全局网关限流"></a>1）全局网关限流</h4><p>Zuul的全局限流针对于所有的服务</p>
<div class="highlight-container" data-rel="Yml"><figure class="iseeu highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">zuul:</span></span><br><span class="line">  <span class="attr">ratelimit:</span></span><br><span class="line">    <span class="attr">key-prefix:</span> <span class="string">zuul_limit</span>            <span class="comment"># 缓存key的名称定义前缀。</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span>                     <span class="comment"># 开启Zuul网关限流</span></span><br><span class="line">    <span class="attr">repository:</span> <span class="string">REDIS</span>                 <span class="comment"># 采用Redis方案</span></span><br><span class="line">    <span class="attr">default-policy-list:</span>              <span class="comment"># 默认的全局配置，如果根据规则查询不到配置则应用这个定义的配置</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">limit:</span> <span class="number">3</span>                      <span class="comment"># 令牌的个数</span></span><br><span class="line">        <span class="attr">refresh-interval:</span> <span class="number">10</span>          <span class="comment"># 刷新令牌的时间(单位:秒)</span></span><br><span class="line">        <span class="attr">type:</span>                         <span class="comment"># 限流类型</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">origin</span>	                  <span class="comment"># 根据客户端ip地址进行区分</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">url</span>                       <span class="comment"># 根据请求URL进行区分</span></span><br></pre></td></tr></table></figure></div>

<p>访问Item-servier、order-service，10s内生成3个令牌；10s内访问了第4次则触发限流；</p>
<p>查看Redis：</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/springcloud/119.png"
                      alt="img"
                ></p>
<h4 id="2）根据服务限流"><a href="#2）根据服务限流" class="headerlink" title="2）根据服务限流"></a>2）根据服务限流</h4><div class="highlight-container" data-rel="Yml"><figure class="iseeu highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">zuul:</span></span><br><span class="line">  <span class="attr">ratelimit:</span></span><br><span class="line">    <span class="attr">key-prefix:</span> <span class="string">zuul_limit</span>            <span class="comment"># 缓存key的名称定义前缀。</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span>                     <span class="comment"># 开启Zuul网关限流</span></span><br><span class="line">    <span class="attr">repository:</span> <span class="string">REDIS</span>                 <span class="comment"># 采用Redis方案</span></span><br><span class="line">    <span class="attr">policy-list:</span>              <span class="comment"># 默认的全局配置，如果根据规则查询不到配置则应用这个定义的配置</span></span><br><span class="line">      <span class="attr">item-service:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">limit:</span> <span class="number">3</span>                      <span class="comment"># 时间窗口内最多访问次数</span></span><br><span class="line">          <span class="attr">quota:</span> <span class="number">5</span>                      <span class="comment"># 时间窗口单位是秒</span></span><br><span class="line">          <span class="attr">refresh-interval:</span> <span class="number">20</span>          <span class="comment"># 默认的刷新时间窗口的间隔。</span></span><br><span class="line">          <span class="attr">type:</span>                         <span class="comment"># 限流类型</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">origin</span>	                  <span class="comment"># 根据客户端ip地址进行区分</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">url</span>                       <span class="comment"># 根据请求URL进行区分</span></span><br></pre></td></tr></table></figure></div>


        </div>

        
            <div class="post-copyright-info w-full my-8 px-2 sm:px-6 md:px-8">
                <div class="article-copyright-info-container">
    <ul>
        <li><strong>Title:</strong> SpringCloud</li>
        <li><strong>Author:</strong> MinGe</li>
        <li><strong>Created at
                :</strong> 2024-03-10 15:00:00</li>
        
            <li>
                <strong>Updated at
                    :</strong> 2024-11-12 17:00:28
            </li>
        
        <li>
            <strong>Link:</strong> https://redefine.ohevan.com/2024/03/10/SpringCloud/
        </li>
        <li>
            <strong>
                License:
            </strong>
            

            
                This work is licensed under <a class="license" target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0">CC BY-NC-SA 4.0</a>.
            
        </li>
    </ul>
</div>

            </div>
        

        
            <ul class="post-tags-box text-lg mt-1.5 flex-wrap justify-center flex md:hidden">
                
                    <li class="tag-item mx-0.5">
                        <a href="/tags/java/">#java</a>&nbsp;
                    </li>
                
            </ul>
        

        

        
            <div class="article-nav my-8 flex justify-between items-center px-2 sm:px-6 md:px-8">
                
                    <div class="article-prev border-border-color shadow-redefine-flat shadow-shadow-color-2 rounded-medium px-4 py-2 hover:shadow-redefine-flat-hover hover:shadow-shadow-color-2">
                        <a class="prev"
                        rel="prev"
                        href="/2024/03/23/Dubbo/"
                        >
                            <span class="left arrow-icon flex justify-center items-center">
                                <i class="fa-solid fa-chevron-left"></i>
                            </span>
                            <span class="title flex justify-center items-center">
                                <span class="post-nav-title-item">Dubbo</span>
                                <span class="post-nav-item">Prev posts</span>
                            </span>
                        </a>
                    </div>
                
                
                    <div class="article-next border-border-color shadow-redefine-flat shadow-shadow-color-2 rounded-medium px-4 py-2 hover:shadow-redefine-flat-hover hover:shadow-shadow-color-2">
                        <a class="next"
                        rel="next"
                        href="/2023/12/31/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"
                        >
                            <span class="title flex justify-center items-center">
                                <span class="post-nav-title-item">设计模式</span>
                                <span class="post-nav-item">Next posts</span>
                            </span>
                            <span class="right arrow-icon flex justify-center items-center">
                                <i class="fa-solid fa-chevron-right"></i>
                            </span>
                        </a>
                    </div>
                
            </div>
        


        
    </div>

    
        <div class="toc-content-container">
            <div class="post-toc-wrap">
    <div class="post-toc">
        <div class="toc-title">On this page</div>
        <div class="page-title">SpringCloud</div>
        <ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B8%80%E3%80%81%E4%BB%80%E4%B9%88%E6%98%AF%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9F"><span class="nav-text">一、什么是微服务？</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BA%8C%E3%80%81SpringCloud%E6%A6%82%E8%BF%B0"><span class="nav-text">二、SpringCloud概述</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B8%89%E3%80%81%E6%9C%8D%E5%8A%A1%E8%BF%9C%E7%A8%8B%E8%B0%83%E7%94%A8"><span class="nav-text">三、服务远程调用</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%9B%9B%E3%80%81Netflix-Eureka-%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83"><span class="nav-text">四、Netflix Eureka 注册中心</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BA%94%E3%80%81Netflix-Ribbon-%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="nav-text">五、Netflix Ribbon 负载均衡</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%85%AD%E3%80%81Netflix-Feign-%E6%9C%8D%E5%8A%A1%E8%B0%83%E7%94%A8"><span class="nav-text">六、Netflix Feign 服务调用</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B8%83%E3%80%81Netflix-Hystrix-%E6%9C%8D%E5%8A%A1%E7%86%94%E6%96%AD"><span class="nav-text">七、Netflix Hystrix 服务熔断</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%85%AB%E3%80%81Netflix-Zuul-%E6%9C%8D%E5%8A%A1%E7%BD%91%E5%85%B3"><span class="nav-text">八、Netflix Zuul 服务网关</span></a></li></ol>

    </div>
</div>
        </div>
    
</div>



                

            </div>

            

        </div>

        <div class="main-content-footer">
            <footer class="footer mt-5 py-5 h-auto text-base text-third-text-color relative border-t-2 border-t-border-color">
    <div class="info-container py-3 text-center">
        
        <div class="text-center">
            &copy;
            
              <span>2022</span>
              -
            
            2024&nbsp;&nbsp;<i class="fa-solid fa-heart fa-beat" style="--fa-animation-duration: 0.5s; color: #f54545"></i>&nbsp;&nbsp;<a href="/">MinGe</a>
            
                
                <p class="post-count space-x-0.5">
                    <span>
                        20 posts in total
                    </span>
                    
                </p>
            
        </div>
        
        <div class="relative text-center lg:absolute lg:left-[20px] lg:top-1/2 lg:-translate-y-1/2 lg:text-left">
            <span class="lg:block text-sm">POWERED BY <?xml version="1.0" encoding="utf-8"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"><svg class="relative top-[2px] inline-block align-baseline" version="1.1" id="圖層_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="1rem" height="1rem" viewBox="0 0 512 512" enable-background="new 0 0 512 512" xml:space="preserve"><path fill="#0E83CD" d="M256.4,25.8l-200,115.5L56,371.5l199.6,114.7l200-115.5l0.4-230.2L256.4,25.8z M349,354.6l-18.4,10.7l-18.6-11V275H200v79.6l-18.4,10.7l-18.6-11v-197l18.5-10.6l18.5,10.8V237h112v-79.6l18.5-10.6l18.5,10.8V354.6z"/></svg><a target="_blank" class="text-base" href="https://hexo.io">Hexo</a></span>
            <span class="text-sm lg:block">THEME&nbsp;<a class="text-base" target="_blank" href="https://github.com/EvanNotFound/hexo-theme-redefine">Redefine v2.7.1</a></span>
        </div>
        
        
            <div>
                Blog up for <span class="odometer" id="runtime_days" ></span> days <span class="odometer" id="runtime_hours"></span> hrs <span class="odometer" id="runtime_minutes"></span> Min <span class="odometer" id="runtime_seconds"></span> Sec
            </div>
        
        
            <script data-swup-reload-script>
                try {
                    function odometer_init() {
                    const elements = document.querySelectorAll('.odometer');
                    elements.forEach(el => {
                        new Odometer({
                            el,
                            format: '( ddd).dd',
                            duration: 200
                        });
                    });
                    }
                    odometer_init();
                } catch (error) {}
            </script>
        
        
        
    </div>  
</footer>
        </div>
    </div>

    
        <div class="post-tools">
            <div class="post-tools-container">
    <ul class="article-tools-list">
        <!-- TOC aside toggle -->
        
            <li class="right-bottom-tools page-aside-toggle">
                <i class="fa-regular fa-outdent"></i>
            </li>
        

        <!-- go comment -->
        
    </ul>
</div>

        </div>
    

    <div class="right-side-tools-container">
        <div class="side-tools-container">
    <ul class="hidden-tools-list">
        <li class="right-bottom-tools tool-font-adjust-plus flex justify-center items-center">
            <i class="fa-regular fa-magnifying-glass-plus"></i>
        </li>

        <li class="right-bottom-tools tool-font-adjust-minus flex justify-center items-center">
            <i class="fa-regular fa-magnifying-glass-minus"></i>
        </li>

        <li class="right-bottom-tools tool-dark-light-toggle flex justify-center items-center">
            <i class="fa-regular fa-moon"></i>
        </li>

        <!-- rss -->
        

        

        <li class="right-bottom-tools tool-scroll-to-bottom flex justify-center items-center">
            <i class="fa-regular fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="visible-tools-list">
        <li class="right-bottom-tools toggle-tools-list flex justify-center items-center">
            <i class="fa-regular fa-cog fa-spin"></i>
        </li>
        
            <li class="right-bottom-tools tool-scroll-to-top flex justify-center items-center">
                <i class="arrow-up fas fa-arrow-up"></i>
                <span class="percent"></span>
            </li>
        
        
    </ul>
</div>

    </div>

    <div class="image-viewer-container">
    <img src="">
</div>


    

</main>


    
<script src="/js/libs/Swup.min.js"></script>

<script src="/js/libs/SwupSlideTheme.min.js"></script>

<script src="/js/libs/SwupScriptsPlugin.min.js"></script>

<script src="/js/libs/SwupProgressPlugin.min.js"></script>

<script src="/js/libs/SwupScrollPlugin.min.js"></script>

<script src="/js/libs/SwupPreloadPlugin.min.js"></script>

<script>
    const swup = new Swup({
        plugins: [
            new SwupScriptsPlugin({
                optin: true,
            }),
            new SwupProgressPlugin(),
            new SwupScrollPlugin({
                offset: 80,
            }),
            new SwupSlideTheme({
                mainElement: ".main-content-body",
            }),
            new SwupPreloadPlugin(),
        ],
        containers: ["#swup"],
    });
</script>







<script src="/js/tools/imageViewer.js" type="module"></script>

<script src="/js/utils.js" type="module"></script>

<script src="/js/main.js" type="module"></script>

<script src="/js/layouts/navbarShrink.js" type="module"></script>

<script src="/js/tools/scrollTopBottom.js" type="module"></script>

<script src="/js/tools/lightDarkSwitch.js" type="module"></script>

<script src="/js/layouts/categoryList.js" type="module"></script>





    
<script src="/js/tools/codeBlock.js" type="module"></script>




    
<script src="/js/layouts/lazyload.js" type="module"></script>




    
<script src="/js/tools/runtime.js"></script>

    
<script src="/js/libs/odometer.min.js"></script>

    
<link rel="stylesheet" href="/assets/odometer-theme-minimal.css">




  
<script src="/js/libs/Typed.min.js"></script>

  
<script src="/js/plugins/typed.js" type="module"></script>








    
<script src="/js/libs/anime.min.js"></script>



<div class="post-scripts" data-swup-reload-script>
    
        
<script src="/js/tools/tocToggle.js" type="module"></script>

<script src="/js/layouts/toc.js" type="module"></script>

<script src="/js/plugins/tabs.js" type="module"></script>

    
</div>


</body>
</html>
