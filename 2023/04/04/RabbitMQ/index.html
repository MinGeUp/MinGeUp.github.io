<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="keywords" content="Hexo Theme Redefine">
    
    <meta name="author" content="MinGe">
    <!-- preconnect -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    
    <!--- Seo Part-->
    
    <link rel="canonical" href="http://example.com/2023/04/04/rabbitmq/"/>
    <meta name="robots" content="index,follow">
    <meta name="googlebot" content="index,follow">
    <meta name="revisit-after" content="1 days">
    
        <meta name="description" content="一、消息中间件简介1.1 概述MQ全称为Message Queue，消息队列是消息在传递过程中的容器，消息队列常用于分布式系统之间的通信 消息队列中间件是分布式系统中重要的组件，主要解决应用耦合，异步消息，流量削锋等问题实现高性能，高可用，可伸缩和最终一致性架构；使用较多的消息队列有ActiveMQ，RabbitMQ，ZeroMQ，Kafka，MetaMQ，RocketMQ以下介绍消息队列在实际应">
<meta property="og:type" content="article">
<meta property="og:title" content="RabbitMQ">
<meta property="og:url" content="http://example.com/2023/04/04/RabbitMQ/index.html">
<meta property="og:site_name" content="MinGe">
<meta property="og:description" content="一、消息中间件简介1.1 概述MQ全称为Message Queue，消息队列是消息在传递过程中的容器，消息队列常用于分布式系统之间的通信 消息队列中间件是分布式系统中重要的组件，主要解决应用耦合，异步消息，流量削锋等问题实现高性能，高可用，可伸缩和最终一致性架构；使用较多的消息队列有ActiveMQ，RabbitMQ，ZeroMQ，Kafka，MetaMQ，RocketMQ以下介绍消息队列在实际应">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://example.com/images/rabbit1/100.png">
<meta property="og:image" content="http://example.com/images/rabbit1/99.png">
<meta property="og:image" content="http://example.com/images/rabbit1/98.png">
<meta property="og:image" content="http://example.com/images/rabbit1/97.png">
<meta property="og:image" content="http://example.com/images/rabbit1/96.png">
<meta property="og:image" content="http://example.com/images/rabbit1/95.png">
<meta property="og:image" content="http://example.com/images/rabbit1/94.png">
<meta property="og:image" content="http://example.com/images/rabbit1/93.png">
<meta property="og:image" content="http://example.com/images/rabbit1/92.png">
<meta property="og:image" content="http://example.com/images/rabbit1/91.png">
<meta property="og:image" content="http://example.com/images/rabbit1/90.png">
<meta property="og:image" content="http://example.com/images/rabbit1/89.png">
<meta property="og:image" content="http://example.com/images/rabbit1/87.png">
<meta property="og:image" content="http://example.com/images/rabbit1/88.png">
<meta property="og:image" content="http://example.com/images/rabbit1/86.png">
<meta property="og:image" content="http://example.com/images/rabbit1/85.png">
<meta property="og:image" content="http://example.com/images/rabbit1/84.png">
<meta property="og:image" content="http://example.com/images/rabbit1/83.png">
<meta property="og:image" content="http://example.com/images/rabbit1/60.png">
<meta property="og:image" content="http://example.com/images/rabbit1/82.png">
<meta property="og:image" content="http://example.com/images/rabbit1/81.png">
<meta property="og:image" content="http://example.com/images/rabbit1/80.png">
<meta property="og:image" content="http://example.com/images/rabbit1/79.png">
<meta property="og:image" content="http://example.com/images/rabbit1/78.png">
<meta property="og:image" content="http://example.com/images/rabbit1/77.png">
<meta property="og:image" content="http://example.com/images/rabbit1/76.png">
<meta property="og:image" content="http://example.com/images/rabbit1/75.png">
<meta property="og:image" content="http://example.com/images/rabbit1/74.png">
<meta property="og:image" content="http://example.com/images/rabbit1/73.png">
<meta property="og:image" content="http://example.com/images/rabbit1/61.png">
<meta property="og:image" content="http://example.com/images/rabbit1/72.png">
<meta property="og:image" content="http://example.com/images/rabbit1/71.png">
<meta property="og:image" content="http://example.com/images/rabbit1/70.png">
<meta property="og:image" content="http://example.com/images/rabbit1/70.png">
<meta property="og:image" content="http://example.com/images/rabbit1/69.png">
<meta property="og:image" content="http://example.com/images/rabbit2/68.png">
<meta property="og:image" content="http://example.com/images/rabbit2/67.png">
<meta property="og:image" content="http://example.com/images/rabbit2/66.png">
<meta property="og:image" content="http://example.com/images/rabbit2/65.png">
<meta property="og:image" content="http://example.com/images/rabbit2/64.png">
<meta property="og:image" content="http://example.com/images/rabbit2/94.png">
<meta property="og:image" content="http://example.com/images/rabbit2/63.png">
<meta property="article:published_time" content="2023-04-04T07:04:00.000Z">
<meta property="article:modified_time" content="2024-11-12T08:22:52.006Z">
<meta property="article:author" content="John Doe">
<meta property="article:tag" content="java">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/images/rabbit1/100.png">
    
    
    <!--- Icon Part-->
    <link rel="icon" type="image/png" href="/images/redefine-favicon.svg" sizes="192x192">
    <link rel="apple-touch-icon" sizes="180x180" href="/images/redefine-favicon.svg">
    <meta name="theme-color" content="#A31F34">
    <link rel="shortcut icon" href="/images/redefine-favicon.svg">
    <!--- Page Info-->
    
    <title>
        
            RabbitMQ -
        
        MinGe 博客
    </title>

    
<link rel="stylesheet" href="/fonts/Chillax/chillax.css">


    <!--- Inject Part-->
    

    
<link rel="stylesheet" href="/css/style.css">


    
        
<link rel="stylesheet" href="/assets/build/styles.css">

    

    
<link rel="stylesheet" href="/fonts/GeistMono/geist-mono.css">

    
<link rel="stylesheet" href="/fonts/Geist/geist.css">

    <!--- Font Part-->
    
    
    
    
    
    

    <script id="hexo-configurations">
    window.config = {"hostname":"example.com","root":"/","language":"en"};
    window.theme = {"articles":{"style":{"font_size":"16px","line_height":1.5,"image_border_radius":"14px","image_alignment":"center","image_caption":false,"link_icon":true,"title_alignment":"left","headings_top_spacing":{"h1":"3.2rem","h2":"2.4rem","h3":"1.9rem","h4":"1.6rem","h5":"1.4rem","h6":"1.3rem"}},"word_count":{"enable":true,"count":true,"min2read":true},"author_label":{"enable":true,"auto":false,"list":[]},"code_block":{"copy":true,"style":"mac","highlight_theme":{"light":"github","dark":"vs2015"},"font":{"enable":false,"family":null,"url":null}},"toc":{"enable":true,"max_depth":1,"number":false,"expand":false,"init_open":true},"copyright":{"enable":true,"default":"cc_by_nc_sa"},"lazyload":true,"recommendation":{"enable":false,"title":"推荐阅读","limit":3,"mobile_limit":2,"placeholder":"/images/wallhaven-wqery6-light.webp","skip_dirs":[]}},"colors":{"primary":"#A31F34","secondary":null,"default_mode":"dark"},"global":{"fonts":{"chinese":{"enable":false,"family":null,"url":null},"english":{"enable":false,"family":null,"url":null},"title":{"enable":false,"family":null,"url":null}},"content_max_width":"1000px","sidebar_width":"210px","hover":{"shadow":true,"scale":false},"scroll_progress":{"bar":false,"percentage":true},"website_counter":{"url":"https://cn.vercount.one/js","enable":false,"site_pv":true,"site_uv":true,"post_pv":true},"single_page":true,"preloader":{"enable":false,"custom_message":null},"open_graph":true,"google_analytics":{"enable":false,"id":null}},"home_banner":{"enable":true,"style":"fixed","image":{"light":"/images/wallhaven-wqery6-light.webp","dark":"/images/wallhaven-wqery6-dark.webp"},"title":"MinGe 博客","subtitle":{"text":[],"hitokoto":{"enable":false,"show_author":false,"api":"https://v1.hitokoto.cn"},"typing_speed":100,"backing_speed":80,"starting_delay":500,"backing_delay":1500,"loop":true,"smart_backspace":true},"text_color":{"light":"#fff","dark":"#d1d1b6"},"text_style":{"title_size":"2.8rem","subtitle_size":"1.5rem","line_height":1.2},"custom_font":{"enable":false,"family":null,"url":null},"social_links":{"enable":false,"style":"default","links":{"github":null,"instagram":null,"zhihu":null,"twitter":null,"email":null},"qrs":{"weixin":null}}},"plugins":{"feed":{"enable":false},"aplayer":{"enable":false,"type":"fixed","audios":[{"name":null,"artist":null,"url":null,"cover":null,"lrc":null}]},"mermaid":{"enable":false,"version":"9.3.0"}},"version":"2.7.1","navbar":{"auto_hide":false,"color":{"left":"#f78736","right":"#367df7","transparency":35},"width":{"home":"1200px","pages":"1000px"},"links":{"Home":{"path":"/","icon":"fa-regular fa-house"},"resume":{"path":"/2024/11/02/简历/","icon":"fa-regular fa-folder"}},"search":{"enable":false,"preload":true}},"page_templates":{"friends_column":2,"tags_style":"blur"},"home":{"sidebar":{"enable":true,"position":"left","first_item":"menu","announcement":null,"show_on_mobile":true,"links":{"Archives":{"path":"/archives","icon":"fa-regular fa-archive"},"Tags":{"path":"/tags","icon":"fa-regular fa-tags"},"Categories":{"path":"/categories","icon":"fa-regular fa-folder"}}},"article_date_format":"auto","excerpt_length":200,"categories":{"enable":true,"limit":3},"tags":{"enable":true,"limit":3}},"footerStart":"2022/09/25 08:00:00"};
    window.lang_ago = {"second":"%s seconds ago","minute":"%s minutes ago","hour":"%s hours ago","day":"%s days ago","week":"%s weeks ago","month":"%s months ago","year":"%s years ago"};
    window.data = {"masonry":false};
  </script>
    
    <!--- Fontawesome Part-->
    
<link rel="stylesheet" href="/fontawesome/fontawesome.min.css">

    
<link rel="stylesheet" href="/fontawesome/brands.min.css">

    
<link rel="stylesheet" href="/fontawesome/solid.min.css">

    
<link rel="stylesheet" href="/fontawesome/regular.min.css">

    
    
    
    
<meta name="generator" content="Hexo 7.3.0"></head>


<body>
<div class="progress-bar-container">
    

    
        <span class="pjax-progress-bar"></span>
<!--        <span class="swup-progress-icon">-->
<!--            <i class="fa-solid fa-circle-notch fa-spin"></i>-->
<!--        </span>-->
    
</div>



<main class="page-container" id="swup">

    

    <div class="main-content-container">


        <div class="main-content-header">
            <header class="navbar-container px-6 md:px-12">

    <div class="navbar-content ">
        <div class="left">
            
            <a class="logo-title" href="/">
                
                MinGe 博客
                
            </a>
        </div>

        <div class="right">
            <!-- PC -->
            <div class="desktop">
                <ul class="navbar-list">
                    
                        
                            

                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class=""
                                   href="/"
                                        >
                                    <i class="fa-regular fa-house fa-fw"></i>
                                    HOME
                                    
                                </a>

                                <!-- Submenu -->
                                
                            </li>
                    
                        
                            

                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class=""
                                   href="/2024/11/02/%E7%AE%80%E5%8E%86/"
                                        >
                                    <i class="fa-regular fa-folder fa-fw"></i>
                                    RESUME
                                    
                                </a>

                                <!-- Submenu -->
                                
                            </li>
                    
                    
                </ul>
            </div>
            <!-- Mobile -->
            <div class="mobile">
                
                <div class="icon-item navbar-bar">
                    <div class="navbar-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile sheet -->
    <div class="navbar-drawer h-screen w-full absolute top-0 left-0 bg-background-color flex flex-col justify-between">
        <ul class="drawer-navbar-list flex flex-col px-4 justify-center items-start">
            
                
                    

                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full "
                           href="/"
                        >
                            <span>
                                HOME
                            </span>
                            
                                <i class="fa-regular fa-house fa-sm fa-fw"></i>
                            
                        </a>
                        

                        
                    </li>
            
                
                    

                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full "
                           href="/2024/11/02/%E7%AE%80%E5%8E%86/"
                        >
                            <span>
                                RESUME
                            </span>
                            
                                <i class="fa-regular fa-folder fa-sm fa-fw"></i>
                            
                        </a>
                        

                        
                    </li>
            

            
            
                
                    
                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full active"
                           href="/archives"
                        >
                            <span>Archives</span>
                            <i class="fa-regular fa-archive fa-sm fa-fw"></i>
                        </a>
                    </li>
                
                    
                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full active"
                           href="/tags"
                        >
                            <span>Tags</span>
                            <i class="fa-regular fa-tags fa-sm fa-fw"></i>
                        </a>
                    </li>
                
                    
                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full active"
                           href="/categories"
                        >
                            <span>Categories</span>
                            <i class="fa-regular fa-folder fa-sm fa-fw"></i>
                        </a>
                    </li>
                
            
        </ul>

        <div class="statistics flex justify-around my-2.5">
    <a class="item tag-count-item flex flex-col justify-center items-center w-20" href="/tags">
        <div class="number text-2xl sm:text-xl text-second-text-color font-semibold">3</div>
        <div class="label text-third-text-color text-sm">Tags</div>
    </a>
    <a class="item tag-count-item flex flex-col justify-center items-center w-20" href="/categories">
        <div class="number text-2xl sm:text-xl text-second-text-color font-semibold">2</div>
        <div class="label text-third-text-color text-sm">Categories</div>
    </a>
    <a class="item tag-count-item flex flex-col justify-center items-center w-20" href="/archives">
        <div class="number text-2xl sm:text-xl text-second-text-color font-semibold">20</div>
        <div class="label text-third-text-color text-sm">Posts</div>
    </a>
</div>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="main-content-body">

            

            <div class="main-content">

                
                    <div class="post-page-container flex relative justify-between box-border w-full h-full">
    <div class="article-content-container">

        <div class="article-title relative w-full">
            
                <div class="w-full flex items-center pt-6 justify-start">
                    <h1 class="article-title-regular text-second-text-color tracking-tight text-4xl md:text-6xl font-semibold px-2 sm:px-6 md:px-8 py-3">RabbitMQ</h1>
                </div>
            
            </div>

        
            <div class="article-header flex flex-row gap-2 items-center px-2 sm:px-6 md:px-8">
                <div class="avatar w-[46px] h-[46px] flex-shrink-0 rounded-medium border border-border-color p-[1px]">
                    <img src="/images/redefine-avatar.svg">
                </div>
                <div class="info flex flex-col justify-between">
                    <div class="author flex items-center">
                        <span class="name text-default-text-color text-lg font-semibold">MinGe</span>
                        
                            <span class="author-label ml-1.5 text-xs px-2 py-0.5 rounded-small text-third-text-color border border-shadow-color-1">Lv3</span>
                        
                    </div>
                    <div class="meta-info">
                        <div class="article-meta-info">
    <span class="article-date article-meta-item">
        <i class="fa-regular fa-pen-fancy"></i>&nbsp;
        <span class="desktop">2023-04-04 15:04</span>
        <span class="mobile">2023-04-04 15:04</span>
        <span class="hover-info">Created</span>
    </span>
    
        <span class="article-date article-meta-item">
            <i class="fa-regular fa-wrench"></i>&nbsp;
            <span class="desktop">2024-11-12 16:22:52</span>
            <span class="mobile">2024-11-12 16:22:52</span>
            <span class="hover-info">Updated</span>
        </span>
    

    
        <span class="article-categories article-meta-item">
            <i class="fa-regular fa-folders"></i>&nbsp;
            <ul>
                
                
                    
                        
                        <li>
                            <a href="/categories/%E6%8A%80%E6%9C%AF/">技术</a>&nbsp;
                        </li>
                    
                    
                
            </ul>
        </span>
    
    
        <span class="article-tags article-meta-item">
            <i class="fa-regular fa-tags"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/tags/java/">java</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    

    
    
    
    
</div>

                    </div>
                </div>
            </div>
        

        


        <div class="article-content markdown-body px-2 sm:px-6 md:px-8 pb-8">
            <h1 id="一、消息中间件简介"><a href="#一、消息中间件简介" class="headerlink" title="一、消息中间件简介"></a>一、消息中间件简介</h1><h2 id="1-1-概述"><a href="#1-1-概述" class="headerlink" title="1.1 概述"></a>1.1 概述</h2><p>MQ全称为Message Queue，消息队列是消息在传递过程中的容器，消息队列常用于分布式系统之间的通信</p>
<p>消息队列中间件是分布式系统中重要的组件，主要解决<strong>应用耦合，异步消息，流量削锋</strong>等问题实现<strong>高性能</strong>，高可用，可伸缩和最终一致性架构；使用较多的消息队列有ActiveMQ，RabbitMQ，ZeroMQ，Kafka，MetaMQ，RocketMQ以下介绍消息队列在实际应用中常用的使用场景：异步处理，应用解耦，流量削锋和消息通讯四个场景</p>
<h2 id="1-2-消息中间件的好处"><a href="#1-2-消息中间件的好处" class="headerlink" title="1.2 消息中间件的好处"></a>1.2 消息中间件的好处</h2><p>在项目中，可将一些<strong>无需即时返回且耗时的操作提取出来</strong>，进行<strong>异步处理</strong>，而这种异步处理的方式大大的节省了服务器的请求响应时间，从而<strong>提高</strong>了<strong>系统</strong>的<strong>吞吐量</strong>。</p>
<h3 id="1-2-1-应用解耦"><a href="#1-2-1-应用解耦" class="headerlink" title="1.2.1 应用解耦"></a>1.2.1 应用解耦</h3><p>在我们的应用中，下订单同时需要调用库存系统、支付系统等业务；</p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/rabbit1/100.png"
                      style="zoom: 67%;" 
                >

<p>随着业务升级，需要更改业务需求，在下订单的同时需要对接积分系统进行加积分操作，因此结果变为如下：</p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/rabbit1/99.png"
                      style="zoom:67%;" 
                >

<p>从上图的演变我们可以知道，随着业务的不断升级，业务的不多增加，我们可能需要频繁的修改订单系统的代码，现在我们的订单系统严重和其他系统<strong>耦合</strong>在一起了，<strong>可维护差</strong>；不仅如此，当订单系统调用库存系统时，如果库存系统不能够及时响应，那么必定会造成订单系统的延迟，或者库存系统出现错误，那么也很有可能导致订单系统出现故障，<strong>系统的容错性非常低</strong>；</p>
<p>为了解决上述问题，我们引入了消息中间件（MQ）：</p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/rabbit1/98.png"
                      style="zoom: 67%;" 
                >

<p>当订单系统需要对接其他系统时，只需要发消息给MQ，由MQ来通知其他系统进行业务操作，订单系统只与MQ进行对接，从而解决我们上面的几个问题；</p>
<ul>
<li><p>1、业务耦合 </p>
</li>
<li><p>2、系统延迟 </p>
</li>
<li><p>3、容错性低</p>
</li>
</ul>
<h3 id="1-2-2-异步处理"><a href="#1-2-2-异步处理" class="headerlink" title="1.2.2 异步处理"></a>1.2.2 异步处理</h3><p>在我们没有引入MQ之前的老系统中，调用订单系统，等待订单系统处理完业务逻辑之后响应客户端大概需要时间：<code>200ms+200ms+200ms=600ms</code></p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/rabbit1/97.png"
                      style="zoom:67%;" 
                >

<p>引入了MQ队列之后只需要5ms！</p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/rabbit1/96.png"
                      style="zoom:67%;" 
                >

<blockquote>
<p>这里说明一点：我们之前讲MQ概述时已经讲过，MQ适用于<strong>一些无需即时返回且耗时的操作</strong>，假设在上述架构中，订单系统需要库存系统返回某值后才能进行下一步操作则不适用于MQ；</p>
</blockquote>
<h3 id="1-2-3-流量削峰"><a href="#1-2-3-流量削峰" class="headerlink" title="1.2.3 流量削峰"></a>1.2.3 流量削峰</h3><p>流量削峰指的是在应用服务器面对大流量访问时，MQ可以帮助我们进行流量的限流操作，削弱流量，保证服务器的正常运行；</p>
<p>假设现在某电商网站搞促销活动，导致流量迅速激增，已经远远超过应用服务器的压力承受范围，此时如果不进行流量（QPS）的控制，那么应用服务器很有可能会出现故障：</p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/rabbit1/95.png"
                      style="zoom:67%;" 
                >

<p>为了防止过度的流量同时进入我们的应用服务器，导致应用服务器最终宕机，我们可以进行限流手段，即每秒从MQ中拉取1000个请求进行处理：</p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/rabbit1/94.png"
                      style="zoom:67%;" 
                >

<blockquote>
<p>由于高并发的访问，消息会被挤压在MQ中，在高峰期过后，仍有一段时间内消息消费的速度维护在1000&#x2F;s，直到积压的消息全部被消费完毕；</p>
</blockquote>
<h2 id="1-3-消息中间件带来的问题"><a href="#1-3-消息中间件带来的问题" class="headerlink" title="1.3 消息中间件带来的问题"></a>1.3 消息中间件带来的问题</h2><h3 id="1-3-1-消息一致性"><a href="#1-3-1-消息一致性" class="headerlink" title="1.3.1 消息一致性"></a>1.3.1 消息一致性</h3><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/rabbit1/93.png"
                      style="zoom:67%;" 
                >

<p>如上图，如果订单系统给其他系统发送完毕消息后，某个系统处理失败，该如何保证数据的一致性？</p>
<h3 id="1-3-2-消息重复消费（消息幂等性）"><a href="#1-3-2-消息重复消费（消息幂等性）" class="headerlink" title="1.3.2 消息重复消费（消息幂等性）"></a>1.3.2 消息重复消费（消息幂等性）</h3><p>当我们一个接口多次消费一个消息时，我们需要保证这个操作无论被操作多少次其结果是一样的，这个时候我们就需要保证接口的幂等性；</p>
<p>幂等：一个操作任意执行多次与执行一次的结果是相同的</p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/rabbit1/92.png"
                      style="zoom:67%;" 
                >

<p>在上述系统中，如果执行库存系统出现问题，那么订单系统会重发消息，但是支付和积分系统是没有任何问题的，但由于消息的重发，导致支付和积分系统再次消费一次消息；</p>
<h3 id="1-3-3-成本问题"><a href="#1-3-3-成本问题" class="headerlink" title="1.3.3 成本问题"></a>1.3.3 成本问题</h3><ul>
<li><strong>系统可用性降低</strong></li>
</ul>
<p>系统引入的外部依赖越多，系统稳定性越差。一旦 MQ 宕机，就会对业务造成影响。如何保证MQ的高可用？</p>
<ul>
<li><strong>系统复杂度提高</strong></li>
</ul>
<p>MQ 的加入大大增加了系统的复杂度，以前系统间是同步的远程调用，现在是通过 MQ 进行异步调用。需要保证MQ带来的一系列问题</p>
<h2 id="1-3-常见MQ性能对比"><a href="#1-3-常见MQ性能对比" class="headerlink" title="1.3 常见MQ性能对比"></a>1.3 常见MQ性能对比</h2><table>
<thead>
<tr>
<th></th>
<th><strong>RabbitMQ</strong></th>
<th><strong>ActiveMQ</strong></th>
<th><strong>RocketMQ</strong></th>
<th><strong>Kafka</strong></th>
</tr>
</thead>
<tbody><tr>
<td>公司&#x2F;社区</td>
<td>Rabbit</td>
<td>Apache</td>
<td>阿里</td>
<td>Apache</td>
</tr>
<tr>
<td>开发语言</td>
<td>Erlang</td>
<td>Java</td>
<td>Java</td>
<td>Scala&amp;Java</td>
</tr>
<tr>
<td>协议支持</td>
<td>AMQP，XMPP，SMTP，STOMP</td>
<td>OpenWire,STOMP，REST,XMPP,AMQP</td>
<td>自定义</td>
<td>自定义协议，社区封装了http协议支持</td>
</tr>
<tr>
<td>客户端支持语言</td>
<td>官方支持Erlang，Java，Ruby等,社区产出多种API，几乎支持所有语言</td>
<td>Java，C，C++，Python，PHP，Perl，.net等</td>
<td>Java，C++（不成熟）</td>
<td>官方支持Java,社区产出多种API，如PHP，Python等</td>
</tr>
<tr>
<td>单机吞吐量</td>
<td>万级（其次）</td>
<td>万级（最差）</td>
<td>十万级（最好）</td>
<td>十万级（次之）</td>
</tr>
<tr>
<td>消息延迟</td>
<td><strong>微秒级</strong></td>
<td>毫秒级</td>
<td>毫秒级</td>
<td>毫秒以内</td>
</tr>
<tr>
<td>功能特性</td>
<td>并发能力强，性能极其好，延时低，社区活跃，管理界面丰富</td>
<td>老牌产品，成熟度高，文档较多</td>
<td>MQ功能比较完备，扩展性佳</td>
<td>只支持主要的MQ功能，毕竟是为大数据领域准备的。</td>
</tr>
</tbody></table>
<h2 id="1-4-AMQP和JMS"><a href="#1-4-AMQP和JMS" class="headerlink" title="1.4 AMQP和JMS"></a>1.4 AMQP和JMS</h2><ul>
<li>AMQP：即Advanced Message Queuing Protocol，一个提供统一消息服务的应用层标准高级消息队列协议，进程间传递<strong>异步消息</strong>的<strong>网络协议</strong>。为面向消息的中间件设计。基于此协议的客户端与消息中间件可传递消息，并不受客户端中间件不同产品的限制，不同的开发语言等条件的限制。Erlang中的实现有RabbitMQ等。</li>
</ul>
<hr>


<ul>
<li>JMS：JMS即Java消息服务（Java Message Service）应用程序接口，是一个Java平台中关于面向消息中间件（MOM）的API，用于在两个应用程序之间，或分布式系统中发送消息，进行异步通信。Java消息服务是一个与具体平台无关的API，绝大多数消息中间件提供商都对JMS提供支持。</li>
</ul>
<blockquote>
<p>AMQP是基于消息传输的一个<strong>应用层协议</strong>，JMS准确的来说是Java操作MQ的一套<strong>API</strong>，类似于JDBC，第三方厂商（MySQL厂商、MQ厂商）进行功能的实现，Java则使用JMS对厂商进行规范；</p>
</blockquote>
<h1 id="二、RabbitMQ简介"><a href="#二、RabbitMQ简介" class="headerlink" title="二、RabbitMQ简介"></a>二、RabbitMQ简介</h1><p>RabbitMQ 是一个由 Erlang 语言开发的 AMQP 的开源实现。AMQP ：Advanced Message Queue Potocal，高级消息队列协议。它是应用层协议的一个开放标准，为面向消息的中间件设计，基于此协议的客户端与消息中间件可传递消息，并不受产品、开发语言等条件的限制。RabbitMQ最初起源于金融系统，用于在分布式系统中存储转发消息，在易用性、扩展性、高可用性等方面表现不俗。</p>
<h2 id="2-1-RabbitMQ架构"><a href="#2-1-RabbitMQ架构" class="headerlink" title="2.1 RabbitMQ架构"></a>2.1 RabbitMQ架构</h2><p>RabbitMQ内部架构图：</p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/rabbit1/91.png"
                       
                >

<ul>
<li><p><code>Producer</code>（生产者）： 消息的生产者，数据的发送方。消息生产者连接RabbitMQ服务器然后将消息投递到Exchange。</p>
</li>
<li><p><code>Broker</code>（服务器）：即RabbitMQ Server，也叫Broker server，接收和分发消息的应用，保证数据能够按照指定的方式进行传输。</p>
</li>
<li><p><code>Connection</code>（连接）：Producer／Consumer 和 broker 之间的 TCP 连接，在消息发送时必须要先建立与RabbitMQ服务器的连接（Connection）</p>
</li>
<li><p><code>Channel</code>（信道）：建立在Connection中，消息是基于Channel传递的，Channel之间是完全隔离的。Channel 作为轻量级的 Connection 极大减少了操作系统建立 TCP connection 的开销；如果每一次访问RabbitMQ 都建立一个 Connection，在消息量大的时候建立 TCP Connection的开销将是巨大的，效率也较低。</p>
</li>
<li><p><code>VirtualHost</code>（虚拟主机）：exchange&#x2F;queue是属于某个VirtualHost的，VirtualHost属于某个用户的；VirtualHost可以分配用户在创建交换机或队列时可以指定其属于哪个虚拟主机，方便用户管理交换机和队列，</p>
</li>
<li><p><code>Exchange</code>（交换机）：生产者将消息发送到 Exchange（交换器），由 Exchange将消息路由到一个或多Queue 中（或者丢弃）。Exchange 并不存储消息。RabbitMQ 中的 Exchange 有direct、fanout、topic、headers 四种类型，每种类型对应不同的路由规则。</p>
</li>
<li><p><code>Queue</code>（队列）：是RabbitMQ的内部对象，用于存储消息。消息消费者就是通过订阅队列来获取消息；RabbitMQ 中的消息都只能存储在Queue中，生产者生产消息并最终投递到Queue 中，消费者可以从 Queue 中获取消息并消费。多个消费者可以订阅同一个Queue，这时 Queue中的消息会被平均分摊给多个消费者进行处理，<strong>而不是每个消费者都收到所有的消息并处理</strong>。</p>
</li>
</ul>
<h2 id="2-2-RabbitMQ安装"><a href="#2-2-RabbitMQ安装" class="headerlink" title="2.2 RabbitMQ安装"></a>2.2 RabbitMQ安装</h2><p>RabbitMQ是Erlang语言基于AMQP协议开发的，因此我们必须首先安装Erlang的运行环境</p>
<p>RabbitMQ官网：<a class="link"   target="_blank" rel="noopener" href="https://www.rabbitmq.com/" >https://www.rabbitmq.com/ <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<p>1）在线安装依赖指令：</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y gcc gcc-c++ wget</span><br></pre></td></tr></table></figure></div>

<p>2）安装</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">rpm -ivh socat-1.7.3.2-1.1.el7.x86_64.rpm --force --nodeps</span><br><span class="line"></span><br><span class="line">rpm -ivh erlang-18.3-1.el7.centos.x86_64.rpm</span><br><span class="line"></span><br><span class="line">rpm -ivh rabbitmq-server-3.6.5-1.noarch.rpm</span><br></pre></td></tr></table></figure></div>

<p>3）开启管理界面</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">开启管理界面</span></span><br><span class="line">rabbitmq-plugins enable rabbitmq_management</span><br></pre></td></tr></table></figure></div>

<p>4）修改guest用户</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">修改默认配置信息loopback_users 中的 &lt;&lt;<span class="string">&quot;guest&quot;</span>&gt;&gt;,只保留guest</span></span><br><span class="line">vi /usr/lib/rabbitmq/lib/rabbitmq_server-3.6.5/ebin/rabbit.app </span><br></pre></td></tr></table></figure></div>

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/rabbit1/90.png"
                     
                ></p>
<p>5）重启RabbitMQ服务：</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart rabbitmq-server</span><br></pre></td></tr></table></figure></div>

<p>6）访问RabbitMQ服务：<a class="link"   target="_blank" rel="noopener" href="http://192.168.40.132:15672/" >http://192.168.40.132:15672 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/rabbit1/89.png"
                      style="zoom:67%;" 
                >

<blockquote>
<p>默认的用户名和密码都是<code>guest</code></p>
</blockquote>
<h2 id="2-3-创建用户"><a href="#2-3-创建用户" class="headerlink" title="2.3 创建用户"></a>2.3 创建用户</h2><p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/rabbit1/87.png"
                     
                ></p>
<p>角色说明：</p>
<ul>
<li><p><strong>Admin</strong>：包含Monitoring和Policymaker所拥有的权限，另外可以创建和删除<code>virtual hosts</code>、查看、创建和删除users、查看创建和删除permissions、关闭其他用户的connections</p>
</li>
<li><p><strong>Monitoring</strong>：包含management所拥有的权限，另外可以列出所有virtual hosts，包括他们不能登录的virtual hosts、查看其他用户的connections和channels</p>
</li>
<li><p><strong>Policymaker</strong>：包含management锁拥有的权限，另外可以查看、创建和删除自己的virtual hosts所属的policies和parameters</p>
</li>
<li><p><strong>Management</strong>：可以使用AMQP做任何的事，另外可以查看自己的virtual hosts中的queues, exchanges 和 bindings，查看和关闭自己的channels 和 connections</p>
</li>
<li><p><strong>None</strong>：不能访问 management plugin</p>
</li>
</ul>
<h2 id="2-3-配置虚拟主机"><a href="#2-3-配置虚拟主机" class="headerlink" title="2.3 配置虚拟主机"></a>2.3 配置虚拟主机</h2><h3 id="2-3-1-创建虚拟主机"><a href="#2-3-1-创建虚拟主机" class="headerlink" title="2.3.1 创建虚拟主机"></a>2.3.1 创建虚拟主机</h3><p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/rabbit1/88.png"
                     
                ></p>
<h3 id="2-3-2-配置权限"><a href="#2-3-2-配置权限" class="headerlink" title="2.3.2 配置权限"></a>2.3.2 配置权限</h3><p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/rabbit1/86.png"
                     
                ></p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/rabbit1/85.png"
                      style="zoom:67%;" 
                >



<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/rabbit1/84.png"
                      style="zoom:67%;" 
                >

<h1 id="三、RabbitMQ快速入门"><a href="#三、RabbitMQ快速入门" class="headerlink" title="三、RabbitMQ快速入门"></a>三、RabbitMQ快速入门</h1><h2 id="3-1-消息生产者"><a href="#3-1-消息生产者" class="headerlink" title="3.1 消息生产者"></a>3.1 消息生产者</h2><h3 id="3-1-1-pom-xml："><a href="#3-1-1-pom-xml：" class="headerlink" title="3.1.1 pom.xml："></a>3.1.1 pom.xml：</h3><div class="highlight-container" data-rel="Xml"><figure class="iseeu highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.minge<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>01_rabbitm1_producer<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--rabbitmq依赖--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.rabbitmq<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>amqp-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.6.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!--测试单元--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.12<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure></div>

<h3 id="3-1-2-生产者类："><a href="#3-1-2-生产者类：" class="headerlink" title="3.1.2 生产者类："></a>3.1.2 生产者类：</h3><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.minge.rabbitmq;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Connection;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.ConnectionFactory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Producer01_Hello</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 1. 创建连接工厂</span></span><br><span class="line">        <span class="type">ConnectionFactory</span> <span class="variable">factory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConnectionFactory</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. 设置连接参数</span></span><br><span class="line">        factory.setHost(<span class="string">&quot;192.168.133.147&quot;</span>);</span><br><span class="line">        factory.setPort(<span class="number">5672</span>);</span><br><span class="line">        factory.setVirtualHost(<span class="string">&quot;/&quot;</span>);</span><br><span class="line">        factory.setUsername(<span class="string">&quot;guest&quot;</span>);</span><br><span class="line">        factory.setPassword(<span class="string">&quot;guest&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3. 获取连接对象</span></span><br><span class="line">        <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> factory.newConnection();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4. 通过connection获取Channel</span></span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> connection.createChannel();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 5. 定义一个队列</span></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">            参数1(queue): 队列名称</span></span><br><span class="line"><span class="comment">            参数2(durable): 是否要持久化队列(mq重启之后还在)</span></span><br><span class="line"><span class="comment">            参数3(exclusive): 是否是独占队列(只能有一个消费者监听此队列,没有也不行)</span></span><br><span class="line"><span class="comment">            参数4(autoDelete): 是否自动删除(当没有Consumer时,队列自动删除)</span></span><br><span class="line"><span class="comment">            参数5(arguments): 队列的其他参数(过期时间、最大消息容量等)</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        channel.queueDeclare(<span class="string">&quot;hello_world&quot;</span>,<span class="literal">true</span>,<span class="literal">false</span>,<span class="literal">false</span>,<span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">        String body=<span class="string">&quot;hello world&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 6.发送消息</span></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">            参数1(exchange): 交换机的名称,简单模式下交换机会使用默认的交换机&quot;&quot;</span></span><br><span class="line"><span class="comment">            参数2(routingKey): routingKey,路由名称,在简单模式下,routingKey就是队列名称</span></span><br><span class="line"><span class="comment">            参数3(props): 消息的一些配置信息</span></span><br><span class="line"><span class="comment">            参数4(body): 发送的消息(字节)</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        channel.basicPublish(<span class="string">&quot;&quot;</span>,<span class="string">&quot;hello_world&quot;</span>,<span class="literal">null</span>,body.getBytes());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 7. 释放资源</span></span><br><span class="line">        channel.close();</span><br><span class="line">        connection.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>查看RabbitMQ面板：</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/rabbit1/83.png"
                     
                ></p>
<h3 id="3-1-3-RabbitMQ面板参数说明"><a href="#3-1-3-RabbitMQ面板参数说明" class="headerlink" title="3.1.3 RabbitMQ面板参数说明"></a>3.1.3 RabbitMQ面板参数说明</h3><ul>
<li><code>Virtual host</code>：该队列所在的虚拟主机</li>
<li><code>Name</code>：队列名称</li>
<li><code>Features</code>：队列的特性，如是否持久化、是否是过期队列等</li>
<li><code>State</code>：此队列工作状态<ul>
<li><code>running</code>：队列处于运行状态（正在创建队列、接受消息、消费消息等）</li>
<li><code>idle</code>：队列处于空闲状态</li>
</ul>
</li>
<li><code>Ready</code>：已经准备好的消息（还未被消费）</li>
<li><code>Unacked</code>：未处理的消息（被拒绝签收）</li>
<li><code>Total</code>：总的消息数量</li>
<li><code>incoming</code>：消息的每秒接收个数</li>
<li><code>deliver / get</code>：消息的每秒消费个数</li>
<li><code>ack</code>：每秒手动签收消息个数</li>
</ul>
<h2 id="3-2-消息消费者"><a href="#3-2-消息消费者" class="headerlink" title="3.2 消息消费者"></a>3.2 消息消费者</h2><h3 id="3-2-1-引入依赖："><a href="#3-2-1-引入依赖：" class="headerlink" title="3.2.1 引入依赖："></a>3.2.1 引入依赖：</h3><p>和消息生产的依赖一致</p>
<h3 id="3-2-2-消费者类："><a href="#3-2-2-消费者类：" class="headerlink" title="3.2.2 消费者类："></a>3.2.2 消费者类：</h3><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.minge.rabbitmq;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.*;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Consumer01_Hello</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="comment">// 创建连接工厂,用于获取频道channel</span></span><br><span class="line">        <span class="type">ConnectionFactory</span> <span class="variable">factory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConnectionFactory</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 设置连接参数</span></span><br><span class="line">        factory.setHost(<span class="string">&quot;192.168.40.132&quot;</span>);</span><br><span class="line">        factory.setPort(<span class="number">5672</span>);</span><br><span class="line">        factory.setUsername(<span class="string">&quot;guest&quot;</span>);</span><br><span class="line">        factory.setPassword(<span class="string">&quot;guest&quot;</span>);</span><br><span class="line">        factory.setVirtualHost(<span class="string">&quot;/&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2.创建连接</span></span><br><span class="line">        <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> factory.newConnection();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3.创建频道</span></span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> connection.createChannel();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4.创建队列</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">        定义队列,如果没有此队列则创建,如果有则不创建</span></span><br><span class="line"><span class="comment">        queueDeclare(String queue, boolean durable, boolean exclusive, boolean autoDelete, Map&lt;String, Object&gt; arguments)</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">        queue:      队列的名称</span></span><br><span class="line"><span class="comment">        durable:    是否持久化队列(mq重启之后还在)</span></span><br><span class="line"><span class="comment">        exclusive:  是否独占(只能有一个消费者监听此队列)</span></span><br><span class="line"><span class="comment">        autoDelete: 是否自动删除(队列中的消息消费完后,没有Consumer时,自动删除掉)</span></span><br><span class="line"><span class="comment">        arguments:  其他参数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">        channel.queueDeclare(<span class="string">&quot;hello_world&quot;</span>, <span class="literal">true</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 5. 接收消息</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">        basicConsume(String queue, boolean autoAck, Consumer callback)</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">        queue:      队列名称</span></span><br><span class="line"><span class="comment">        autoAck:    是否开启自动确认</span></span><br><span class="line"><span class="comment">        callback:   回调对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">        channel.basicConsume(<span class="string">&quot;hello_world&quot;</span>, <span class="literal">true</span>, <span class="keyword">new</span> <span class="title class_">DefaultConsumer</span>(channel) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 回调方法,当收到消息之后,会自动执行该方法</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleDelivery</span><span class="params">(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, <span class="type">byte</span>[] body)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">                1. consumerTag：标识</span></span><br><span class="line"><span class="comment">                2. envelope：获取一些信息，交换机，路由key...</span></span><br><span class="line"><span class="comment">                3. properties:配置信息</span></span><br><span class="line"><span class="comment">                4. body：数据</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">                System.out.println(<span class="string">&quot;consumerTag：&quot;</span> + consumerTag);</span><br><span class="line">                System.out.println(<span class="string">&quot;Exchange：&quot;</span> + envelope.getExchange());</span><br><span class="line">                System.out.println(<span class="string">&quot;RoutingKey：&quot;</span> + envelope.getRoutingKey());</span><br><span class="line">                System.out.println(<span class="string">&quot;properties：&quot;</span> + properties);</span><br><span class="line">                System.out.println(<span class="string">&quot;body：&quot;</span> + <span class="keyword">new</span> <span class="title class_">String</span>(body));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="comment">// 不释放资源,让rabbitmq一直监听</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h1 id="四、RabbitMQ工作模式"><a href="#四、RabbitMQ工作模式" class="headerlink" title="四、RabbitMQ工作模式"></a>四、RabbitMQ工作模式</h1><p>在RabbitMQ中共提供有7种工作模式，分别为<code>Simple</code>、<code>work</code>、<code>Pub/Sub</code>、<code>Routing</code>、<code>Topics</code>、<code>RPC</code>、<code>Publisher Confirms</code>，不同的工作模式具有不同的消息分发规则；</p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/rabbit1/60.png"
                      style="zoom: 67%;" 
                >

<blockquote>
<p>RabbitMQ官网：<a class="link"   target="_blank" rel="noopener" href="https://www.rabbitmq.com/getstarted.html" >https://www.rabbitmq.com/getstarted.html <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
</blockquote>
<h2 id="4-1-Simple模式"><a href="#4-1-Simple模式" class="headerlink" title="4.1 Simple模式"></a>4.1 Simple模式</h2><p>simple模式就是我们上面快速入门的案例</p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/rabbit1/82.png"
                      style="zoom:67%;" 
                >

<p>简单模式中表现为一个生产者对应一个消费者，生产者（Producer）生产消息发送到队列，消费者（Consumer）监听此队列，进行消息的消费；案例代码参考RabbitMQ快速入门；</p>
<blockquote>
<p>Simple模式官网介绍：<a class="link"   target="_blank" rel="noopener" href="https://www.rabbitmq.com/tutorials/tutorial-one-java.html" >https://www.rabbitmq.com/tutorials/tutorial-one-java.html <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
</blockquote>
<h2 id="4-2-Work模式"><a href="#4-2-Work模式" class="headerlink" title="4.2 Work模式"></a>4.2 Work模式</h2><h3 id="4-2-1-简介"><a href="#4-2-1-简介" class="headerlink" title="4.2.1 简介"></a>4.2.1 简介</h3><p><strong>Work模式与Simple模式是一模一样的，只不过我们在只有一个Producer和一个Consumer时习惯把这种模式成为Simple模式，而当一个Producer有多个Consumer时我们把这样的模式成为Work模式，因此Work模式和Simple模式的代码是一模一样的，只不过是多个Consumer监听同一个队列而已；</strong></p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/rabbit1/81.png"
                      style="zoom:67%;" 
                >

<blockquote>
<p>Work模式官网介绍：<a class="link"   target="_blank" rel="noopener" href="https://www.rabbitmq.com/tutorials/tutorial-two-java.html" >https://www.rabbitmq.com/tutorials/tutorial-two-java.html <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
</blockquote>
<h3 id="4-2-2-生产者"><a href="#4-2-2-生产者" class="headerlink" title="4.2.2 生产者"></a>4.2.2 生产者</h3><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.minge.rabbitmq;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Connection;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.ConnectionFactory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Producer02_WorkQueues</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 创建连接工厂,用于获取频道channel</span></span><br><span class="line">        <span class="type">ConnectionFactory</span> <span class="variable">factory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConnectionFactory</span>();</span><br><span class="line"></span><br><span class="line">        factory.setHost(<span class="string">&quot;192.168.40.132&quot;</span>);</span><br><span class="line">        factory.setPort(<span class="number">5672</span>);</span><br><span class="line">        factory.setUsername(<span class="string">&quot;lscl&quot;</span>);</span><br><span class="line">        factory.setPassword(<span class="string">&quot;admin&quot;</span>);</span><br><span class="line">        factory.setVirtualHost(<span class="string">&quot;/lscl&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2.创建连接</span></span><br><span class="line">        <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> factory.newConnection();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3.创建频道</span></span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> connection.createChannel();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4.创建队列</span></span><br><span class="line">        channel.queueDeclare(<span class="string">&quot;work_queues&quot;</span>, <span class="literal">true</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//5. 循环发送10条消息到work_queues队列</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt;= <span class="number">10</span>; i++) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">body</span> <span class="operator">=</span> <span class="string">&quot;hello&quot;</span> + i;</span><br><span class="line">            channel.basicPublish(<span class="string">&quot;&quot;</span>, <span class="string">&quot;work_queues&quot;</span>, <span class="literal">null</span>, body.getBytes());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//6.释放资源</span></span><br><span class="line">        channel.close();</span><br><span class="line">        connection.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/rabbit1/80.png"
                     
                ></p>
<h3 id="4-2-3-消费者1"><a href="#4-2-3-消费者1" class="headerlink" title="4.2.3 消费者1"></a>4.2.3 消费者1</h3><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.minge.rabbitmq;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.*;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Consumer02_WorkQueues</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="comment">// 创建连接工厂,用于获取频道channel</span></span><br><span class="line">        ConnectionFactory factory=<span class="keyword">new</span> <span class="title class_">ConnectionFactory</span>();</span><br><span class="line"></span><br><span class="line">        factory.setHost(<span class="string">&quot;192.168.40.132&quot;</span>);</span><br><span class="line">        factory.setPort(<span class="number">5672</span>);</span><br><span class="line">        factory.setUsername(<span class="string">&quot;lscl&quot;</span>);</span><br><span class="line">        factory.setPassword(<span class="string">&quot;admin&quot;</span>);</span><br><span class="line">        factory.setVirtualHost(<span class="string">&quot;/lscl&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2.创建连接</span></span><br><span class="line">        <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> factory.newConnection();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3.创建频道</span></span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> connection.createChannel();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4.创建队列</span></span><br><span class="line">        channel.queueDeclare(<span class="string">&quot;work_queues&quot;</span>,<span class="literal">true</span>,<span class="literal">false</span>,<span class="literal">false</span>,<span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 5. 接收消息</span></span><br><span class="line">        channel.basicConsume(<span class="string">&quot;work_queues&quot;</span>, <span class="literal">true</span>, <span class="keyword">new</span> <span class="title class_">DefaultConsumer</span>(channel)&#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 回调方法,当收到消息之后,会自动执行该方法</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleDelivery</span><span class="params">(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, <span class="type">byte</span>[] body)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line"></span><br><span class="line">                System.out.println(<span class="string">&quot;body：&quot;</span>+<span class="keyword">new</span> <span class="title class_">String</span>(body));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="comment">// 不释放资源,让rabbitmq一直监听</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="4-2-4-消费者2"><a href="#4-2-4-消费者2" class="headerlink" title="4.2.4 消费者2"></a>4.2.4 消费者2</h3><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/rabbit1/79.png"
                       
                >

<p>运行后在控制台可以看到多个窗口</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/rabbit1/78.png"
                     
                ></p>
<h3 id="4-2-5-rabbitmq负载均衡"><a href="#4-2-5-rabbitmq负载均衡" class="headerlink" title="4.2.5 rabbitmq负载均衡"></a>4.2.5 rabbitmq负载均衡</h3><p>当rabbitmq存在有多个Consumer时，会自动采用轮询方式实现消息的负载均衡，将消息分担到不同的Consumer进行消费</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/rabbit1/77.png"
                     
                ></p>
<h2 id="4-3-Pub-Sub发布订阅模式（Fanout）"><a href="#4-3-Pub-Sub发布订阅模式（Fanout）" class="headerlink" title="4.3 Pub&#x2F;Sub发布订阅模式（Fanout）"></a>4.3 Pub&#x2F;Sub发布订阅模式（Fanout）</h2><h3 id="4-3-1-简介"><a href="#4-3-1-简介" class="headerlink" title="4.3.1 简介"></a>4.3.1 简介</h3><p>在发布订阅模式中，Producer发送消息到指定的交换机（Exchange）中，由Exchange绑定不同的Queues，消费者依旧监听这些队列进行消费（work模式使用的是默认的交换机）</p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/rabbit1/76.png"
                      style="zoom:67%;" 
                >

<blockquote>
<p>tips：<strong>交换机（Exchange）只负责将消息转发到绑定的队列（Queues）中，不会存储消息，如果Exchange没有绑定Queues或者Exchange不能将消息路由到指定的Queues中时，此消息将会丢失</strong>；</p>
</blockquote>
<p>一个Exchange可以有<code>direct</code>、<code>topic</code>、<code>headers</code>、<code>fanout</code>四种类型，不同类型的Exchange具备不同的消息路由功能，&#x3D;&#x3D;<strong>Pub&#x2F;Sub模式则重点强调的是fanout类型的Exchange交换模式，Pub&#x2F;Sub模式也叫分列模式；</strong>&#x3D;&#x3D;</p>
<blockquote>
<p>Pub&#x2F;Sub模式官网介绍：<a class="link"   target="_blank" rel="noopener" href="https://www.rabbitmq.com/tutorials/tutorial-three-java.html" >https://www.rabbitmq.com/tutorials/tutorial-three-java.html <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
</blockquote>
<h3 id="4-3-2-生产者"><a href="#4-3-2-生产者" class="headerlink" title="4.3.2 生产者"></a>4.3.2 生产者</h3><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.minge.rabbitmq;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.BuiltinExchangeType;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Connection;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.ConnectionFactory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Producer03_PubSub</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 创建连接工厂,用于获取频道channel</span></span><br><span class="line">        <span class="type">ConnectionFactory</span> <span class="variable">factory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConnectionFactory</span>();</span><br><span class="line"></span><br><span class="line">        factory.setHost(<span class="string">&quot;192.168.40.132&quot;</span>);</span><br><span class="line">        factory.setPort(<span class="number">5672</span>);</span><br><span class="line">        factory.setUsername(<span class="string">&quot;lscl&quot;</span>);</span><br><span class="line">        factory.setPassword(<span class="string">&quot;admin&quot;</span>);</span><br><span class="line">        factory.setVirtualHost(<span class="string">&quot;/lscl&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2.创建连接</span></span><br><span class="line">        <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> factory.newConnection();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3.创建频道</span></span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> connection.createChannel();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4.交换机名称</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">exchangeName</span> <span class="operator">=</span> <span class="string">&quot;test_fanout&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//5. 创建交换机</span></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">           exchangeDeclare(String exchange, BuiltinExchangeType type, boolean durable, boolean autoDelete, boolean internal, Map&lt;String, Object&gt; arguments)</span></span><br><span class="line"><span class="comment">           1. exchange:交换机名称</span></span><br><span class="line"><span class="comment">           2. type:交换机类型</span></span><br><span class="line"><span class="comment">               DIRECT(&quot;direct&quot;),：定向</span></span><br><span class="line"><span class="comment">               FANOUT(&quot;fanout&quot;),：扇形（广播），发送消息到每一个与之绑定队列。</span></span><br><span class="line"><span class="comment">               TOPIC(&quot;topic&quot;),通配符的方式</span></span><br><span class="line"><span class="comment">               HEADERS(&quot;headers&quot;);参数匹配</span></span><br><span class="line"><span class="comment">           3. durable:是否持久化 默认值false</span></span><br><span class="line"><span class="comment">           4. autoDelete:自动删除 默认值false</span></span><br><span class="line"><span class="comment">           5. internal：内部使用。 一般false,默认值false</span></span><br><span class="line"><span class="comment">           6. arguments：参数</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        <span class="comment">// channel.exchangeDeclare(exchangeName, BuiltinExchangeType.FANOUT,true,false,false,null);</span></span><br><span class="line"></span><br><span class="line">        channel.exchangeDeclare(exchangeName, BuiltinExchangeType.FANOUT,<span class="literal">true</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//6. 创建队列</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">queue1Name</span> <span class="operator">=</span> <span class="string">&quot;test_fanout_queue1&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">queue2Name</span> <span class="operator">=</span> <span class="string">&quot;test_fanout_queue2&quot;</span>;</span><br><span class="line"></span><br><span class="line">        channel.queueDeclare(queue1Name,<span class="literal">true</span>,<span class="literal">false</span>,<span class="literal">false</span>,<span class="literal">null</span>);</span><br><span class="line">        channel.queueDeclare(queue2Name,<span class="literal">true</span>,<span class="literal">false</span>,<span class="literal">false</span>,<span class="literal">null</span>);</span><br><span class="line">        <span class="comment">//7. 绑定队列和交换机</span></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        queueBind(String queue, String exchange, String routingKey)</span></span><br><span class="line"><span class="comment">        参数：</span></span><br><span class="line"><span class="comment">            1. queue：队列名称</span></span><br><span class="line"><span class="comment">            2. exchange：交换机名称</span></span><br><span class="line"><span class="comment">            3. routingKey：路由键，绑定规则</span></span><br><span class="line"><span class="comment">                如果交换机的类型为fanout ，routingKey设置为&quot;&quot;</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        channel.queueBind(queue1Name,exchangeName,<span class="string">&quot;&quot;</span>);</span><br><span class="line">        channel.queueBind(queue2Name,exchangeName,<span class="string">&quot;&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">body</span> <span class="operator">=</span> <span class="string">&quot;呼叫各位&quot;</span>;</span><br><span class="line">        <span class="comment">//8. 发送消息</span></span><br><span class="line">        channel.basicPublish(exchangeName,<span class="string">&quot;&quot;</span>,<span class="literal">null</span>,body.getBytes());</span><br><span class="line"></span><br><span class="line">        <span class="comment">//9. 释放资源</span></span><br><span class="line">        channel.close();</span><br><span class="line">        connection.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>运行完毕之后，查看RabbitMQ UI面板，发现多了一个Exchange（test_fanout）和两个Queues（<code>test_fanout_queue1</code>、<code>test_fanout_queue2</code>）</p>
<h3 id="4-3-3-消费者1"><a href="#4-3-3-消费者1" class="headerlink" title="4.3.3 消费者1"></a>4.3.3 消费者1</h3><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.minge.rabbitmq;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Consumer03_PubSub</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 创建连接工厂,用于获取频道channel</span></span><br><span class="line">        <span class="type">ConnectionFactory</span> <span class="variable">factory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConnectionFactory</span>();</span><br><span class="line"></span><br><span class="line">        factory.setHost(<span class="string">&quot;192.168.40.132&quot;</span>);</span><br><span class="line">        factory.setPort(<span class="number">5672</span>);</span><br><span class="line">        factory.setUsername(<span class="string">&quot;lscl&quot;</span>);</span><br><span class="line">        factory.setPassword(<span class="string">&quot;admin&quot;</span>);</span><br><span class="line">        factory.setVirtualHost(<span class="string">&quot;/lscl&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2.创建连接</span></span><br><span class="line">        <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> factory.newConnection();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3.创建频道</span></span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> connection.createChannel();</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">queueName</span> <span class="operator">=</span> <span class="string">&quot;test_fanout_queue1&quot;</span>;</span><br><span class="line">        channel.queueDeclare(queueName, <span class="literal">true</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 接收消息</span></span><br><span class="line">        <span class="type">Consumer</span> <span class="variable">consumer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultConsumer</span>(channel) &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleDelivery</span><span class="params">(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, <span class="type">byte</span>[] body)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;consumer-1 body：&quot;</span> + <span class="keyword">new</span> <span class="title class_">String</span>(body));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        channel.basicConsume(queueName, <span class="literal">true</span>, consumer);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 不释放资源,让rabbitmq一直监听</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="4-3-4-消费者2"><a href="#4-3-4-消费者2" class="headerlink" title="4.3.4 消费者2"></a>4.3.4 消费者2</h3><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.minge.rabbitmq;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Consumer04_PubSub</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 创建连接工厂,用于获取频道channel</span></span><br><span class="line">        <span class="type">ConnectionFactory</span> <span class="variable">factory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConnectionFactory</span>();</span><br><span class="line"></span><br><span class="line">        factory.setHost(<span class="string">&quot;192.168.40.130&quot;</span>);</span><br><span class="line">        factory.setPort(<span class="number">5672</span>);</span><br><span class="line">        factory.setUsername(<span class="string">&quot;lscl&quot;</span>);</span><br><span class="line">        factory.setPassword(<span class="string">&quot;admin&quot;</span>);</span><br><span class="line">        factory.setVirtualHost(<span class="string">&quot;/lscl&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2.创建连接</span></span><br><span class="line">        <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> factory.newConnection();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3.创建频道</span></span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> connection.createChannel();</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">queueName</span> <span class="operator">=</span> <span class="string">&quot;test_fanout_queue2&quot;</span>;</span><br><span class="line">        channel.queueDeclare(queueName, <span class="literal">true</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4.接收消息</span></span><br><span class="line">        <span class="type">Consumer</span> <span class="variable">consumer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultConsumer</span>(channel) &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleDelivery</span><span class="params">(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, <span class="type">byte</span>[] body)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;consumer-2 body：&quot;</span> + <span class="keyword">new</span> <span class="title class_">String</span>(body));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        channel.basicConsume(queueName, <span class="literal">true</span>, consumer);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 不释放资源,让rabbitmq一直监听</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="4-3-5-Pub-Sub模式小结"><a href="#4-3-5-Pub-Sub模式小结" class="headerlink" title="4.3.5 Pub&#x2F;Sub模式小结"></a>4.3.5 Pub&#x2F;Sub模式小结</h3><p>在Pub&#x2F;Sub模式下（Exchange类型为Fanout，也叫分列模式），消息首先被发送到Exchange，由Exchange路由到绑定的Queues中，类似于我们微信群，有什么事在群里面发送一下，群里面的人都能看得到；这样就不需要每个人单独发送消息了；</p>
<blockquote>
<p><strong>需要注意的两点：</strong></p>
<p>&#x3D;&#x3D;<strong>1、work、simple也会有交换机，他们使用的是默认的交换机</strong>&#x3D;&#x3D;</p>
<p>&#x3D;&#x3D;<strong>2、Exchange还可以绑定到另一个Exchange上</strong>&#x3D;&#x3D;</p>
</blockquote>
<h2 id="4-4-Routing路由模式（Direct）"><a href="#4-4-Routing路由模式（Direct）" class="headerlink" title="4.4 Routing路由模式（Direct）"></a>4.4 Routing路由模式（Direct）</h2><h3 id="4-4-1-简介"><a href="#4-4-1-简介" class="headerlink" title="4.4.1 简介"></a>4.4.1 简介</h3><p>刚刚我们说的Pub&#x2F;Sub订阅模式中介绍了Exchange，Exchange有四种类型（<code>direct</code>、<code>topic</code>、<code>headers</code>、<code>fanout</code>），Pub&#x2F;Sub订阅强调的是Fanout类型的Exchange，&#x3D;&#x3D;<strong>Routing模式则强调的是Exchange的direct模式，Routing模式也叫直连模式；</strong>&#x3D;&#x3D;</p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/rabbit1/75.png"
                      style="zoom:67%;" 
                >

<blockquote>
<p>Routing模式官网介绍：<a class="link"   target="_blank" rel="noopener" href="https://www.rabbitmq.com/tutorials/tutorial-four-java.html" >https://www.rabbitmq.com/tutorials/tutorial-four-java.html <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
</blockquote>
<h3 id="4-4-2-生产者"><a href="#4-4-2-生产者" class="headerlink" title="4.4.2 生产者"></a>4.4.2 生产者</h3><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.minge.rabbitmq;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.BuiltinExchangeType;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Connection;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.ConnectionFactory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Producer04_Routing</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 创建连接工厂,用于获取频道channel</span></span><br><span class="line">        <span class="type">ConnectionFactory</span> <span class="variable">factory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConnectionFactory</span>();</span><br><span class="line"></span><br><span class="line">        factory.setHost(<span class="string">&quot;192.168.40.132&quot;</span>);</span><br><span class="line">        factory.setPort(<span class="number">5672</span>);</span><br><span class="line">        factory.setUsername(<span class="string">&quot;lscl&quot;</span>);</span><br><span class="line">        factory.setPassword(<span class="string">&quot;admin&quot;</span>);</span><br><span class="line">        factory.setVirtualHost(<span class="string">&quot;/lscl&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2.创建连接</span></span><br><span class="line">        <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> factory.newConnection();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3.创建频道</span></span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> connection.createChannel();</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">exchangeName</span> <span class="operator">=</span> <span class="string">&quot;test_direct&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//5. 创建交换机(routing模式)</span></span><br><span class="line">        <span class="comment">// channel.exchangeDeclare(exchangeName, BuiltinExchangeType.DIRECT,true,false,false,null);</span></span><br><span class="line">        channel.exchangeDeclare(exchangeName, BuiltinExchangeType.DIRECT, <span class="literal">true</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//6. 创建队列</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">queue1Name</span> <span class="operator">=</span> <span class="string">&quot;test_direct_queue1&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">queue2Name</span> <span class="operator">=</span> <span class="string">&quot;test_direct_queue2&quot;</span>;</span><br><span class="line"></span><br><span class="line">        channel.queueDeclare(queue1Name,<span class="literal">true</span>,<span class="literal">false</span>,<span class="literal">false</span>,<span class="literal">null</span>);</span><br><span class="line">        channel.queueDeclare(queue2Name,<span class="literal">true</span>,<span class="literal">false</span>,<span class="literal">false</span>,<span class="literal">null</span>);</span><br><span class="line">        <span class="comment">//7. 绑定队列和交换机</span></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        queueBind(String queue, String exchange, String routingKey)</span></span><br><span class="line"><span class="comment">        参数：</span></span><br><span class="line"><span class="comment">            1. queue：队列名称</span></span><br><span class="line"><span class="comment">            2. exchange：交换机名称</span></span><br><span class="line"><span class="comment">            3. routingKey：路由键，绑定规则</span></span><br><span class="line"><span class="comment">                如果交换机的类型为fanout ，routingKey设置为&quot;&quot;</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="comment">//队列1绑定 red,green</span></span><br><span class="line">        channel.queueBind(queue1Name,exchangeName,<span class="string">&quot;red&quot;</span>);</span><br><span class="line">        channel.queueBind(queue1Name,exchangeName,<span class="string">&quot;green&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//队列2绑定 red,blue</span></span><br><span class="line">        channel.queueBind(queue2Name,exchangeName,<span class="string">&quot;red&quot;</span>);</span><br><span class="line">        channel.queueBind(queue2Name,exchangeName,<span class="string">&quot;blue&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">body</span> <span class="operator">=</span> <span class="string">&quot;routing....&quot;</span>;</span><br><span class="line">        <span class="comment">//8. 发送消息(路由规则为red,很明显两个队列都能接受到消息)</span></span><br><span class="line">        channel.basicPublish(exchangeName,<span class="string">&quot;red&quot;</span>,<span class="literal">null</span>,body.getBytes());</span><br><span class="line"></span><br><span class="line">        <span class="comment">//9. 释放资源</span></span><br><span class="line">        channel.close();</span><br><span class="line">        connection.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>运行完毕之后，查看RabbitMQ UI面板，发现多了一个Exchange（test_direct）和两个Queues（<code>test_direct_queue1</code>、<code>test_direct_queue2</code>）</p>
<h3 id="4-4-3-消费者-1"><a href="#4-4-3-消费者-1" class="headerlink" title="4.4.3 消费者-1"></a>4.4.3 消费者-1</h3><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.minge.rabbitmq;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Consumer05_Routing</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="comment">// 创建连接工厂,用于获取频道channel</span></span><br><span class="line">        ConnectionFactory factory=<span class="keyword">new</span> <span class="title class_">ConnectionFactory</span>();</span><br><span class="line"></span><br><span class="line">        factory.setHost(<span class="string">&quot;192.168.40.132&quot;</span>);</span><br><span class="line">        factory.setPort(<span class="number">5672</span>);</span><br><span class="line">        factory.setUsername(<span class="string">&quot;lscl&quot;</span>);</span><br><span class="line">        factory.setPassword(<span class="string">&quot;admin&quot;</span>);</span><br><span class="line">        factory.setVirtualHost(<span class="string">&quot;/lscl&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2.创建连接</span></span><br><span class="line">        <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> factory.newConnection();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3.创建频道</span></span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> connection.createChannel();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 定义队列</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">queueName</span> <span class="operator">=</span> <span class="string">&quot;test_direct_queue1&quot;</span>;</span><br><span class="line">        channel.queueDeclare(queueName,<span class="literal">true</span>,<span class="literal">false</span>,<span class="literal">false</span>,<span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 接收消息</span></span><br><span class="line">        <span class="type">Consumer</span> <span class="variable">consumer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultConsumer</span>(channel)&#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleDelivery</span><span class="params">(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, <span class="type">byte</span>[] body)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line"></span><br><span class="line">                System.out.println(<span class="string">&quot;body：&quot;</span>+<span class="keyword">new</span> <span class="title class_">String</span>(body));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 接受queue1的消息</span></span><br><span class="line">        channel.basicConsume(queueName,<span class="literal">true</span>,consumer);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 不释放资源,让rabbitmq一直监听</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="4-4-4-消费者-2"><a href="#4-4-4-消费者-2" class="headerlink" title="4.4.4 消费者-2"></a>4.4.4 消费者-2</h3><p>和消费者-1代码一样，只是队列名换了</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">queueName</span> <span class="operator">=</span> <span class="string">&quot;test_direct_queue2&quot;</span>;</span><br></pre></td></tr></table></figure></div>

<h3 id="4-4-5-Routing模式小结"><a href="#4-4-5-Routing模式小结" class="headerlink" title="4.4.5 Routing模式小结"></a>4.4.5 Routing模式小结</h3><p>在Routing模式下（Exchange类型为direct，也叫直连模式）消息的发送会指定一个routing key，Exchange会根据此Routing Key来路由到指定的Queues，类似于拉了100人进微信群，但是你只想让这100人里面是部门主管的人接受到你的消息（微信暂时还没有这个功能）</p>
<p>Routing模式也可有不同的范围，感兴趣的同学可以自己测试：</p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/rabbit1/74.png"
                      style="zoom:67%;" 
                >

<blockquote>
<p>多个队列绑定相同的routing key：当发送的routing key为black时，那么Q1和Q2都能够接收到消息</p>
</blockquote>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/rabbit1/73.png"
                      style="zoom:67%;" 
                >

<blockquote>
<p>当发送的routing key为error时，C1和C2都能够消费消息，当发送的routing key为info、warning时，只有C2能够消费消息</p>
</blockquote>
<h2 id="4-5-Topics主题模式（Topic）"><a href="#4-5-Topics主题模式（Topic）" class="headerlink" title="4.5 Topics主题模式（Topic）"></a>4.5 Topics主题模式（Topic）</h2><h3 id="4-5-1-简介"><a href="#4-5-1-简介" class="headerlink" title="4.5.1 简介"></a>4.5.1 简介</h3><p>在Routing模式下，一个Exchange绑定Queues时可以指定Routing Key，但Routing Key都是固定的值，如果想要通配符的匹配（类似于模糊匹配）我们就得使用Topics模式了，例如red开头的routing key我都进行消息路由，以green结尾的routing key的我都进行消息路由等；</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/rabbit1/61.png"
                     
                ></p>
<p>&#x3D;&#x3D;<strong>Topics模式强调的是topic模式的Exchange，Topics模式也叫主题模式；</strong>&#x3D;&#x3D;该模式下的Exchange在绑定Queues时可以指定的一定的通配符，这些通配符指定了路由的规则；</p>
<p>Topics模式下有两个符号：</p>
<ul>
<li><p>符号 # 匹配零个或多个词。（0个或多个）</p>
</li>
<li><p>符号 * 匹配不多不少一个词。（必须是一个，0个不行）</p>
</li>
</ul>
<p>因此 red.# 能够匹配到 red.green.xxx，但是 red.*只会匹配到 red.xxx。</p>
<p>小练习：</p>
<div class="highlight-container" data-rel="Txt"><figure class="iseeu highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">red.green.green			1/2/3/4</span><br><span class="line">green.green				3/4	</span><br><span class="line">green.red.blue</span><br><span class="line">green.green.green		3/4		</span><br><span class="line">green.red.green			3</span><br><span class="line"></span><br><span class="line">red.#.green		</span><br><span class="line">red.green.*			</span><br><span class="line">#.green	</span><br><span class="line">*.green.#</span><br></pre></td></tr></table></figure></div>

<blockquote>
<p>Topics模式官网介绍：<a class="link"   target="_blank" rel="noopener" href="https://www.rabbitmq.com/tutorials/tutorial-five-java.html" >https://www.rabbitmq.com/tutorials/tutorial-five-java.html <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
</blockquote>
<h3 id="4-5-2-生产者"><a href="#4-5-2-生产者" class="headerlink" title="4.5.2 生产者"></a>4.5.2 生产者</h3><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.minge.rabbitmq;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.BuiltinExchangeType;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Connection;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.ConnectionFactory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Producer05_Topic</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 创建连接工厂,用于获取频道channel</span></span><br><span class="line">        <span class="type">ConnectionFactory</span> <span class="variable">factory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConnectionFactory</span>();</span><br><span class="line"></span><br><span class="line">        factory.setHost(<span class="string">&quot;192.168.40.132&quot;</span>);</span><br><span class="line">        factory.setPort(<span class="number">5672</span>);</span><br><span class="line">        factory.setUsername(<span class="string">&quot;lscl&quot;</span>);</span><br><span class="line">        factory.setPassword(<span class="string">&quot;admin&quot;</span>);</span><br><span class="line">        factory.setVirtualHost(<span class="string">&quot;/lscl&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2.创建连接</span></span><br><span class="line">        <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> factory.newConnection();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3.创建频道</span></span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> connection.createChannel();</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">exchangeName</span> <span class="operator">=</span> <span class="string">&quot;test_topic&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//5. 创建交换机</span></span><br><span class="line">        channel.exchangeDeclare(exchangeName, BuiltinExchangeType.TOPIC,<span class="literal">true</span>,<span class="literal">false</span>,<span class="literal">false</span>,<span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//6. 创建队列</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">queue1Name</span> <span class="operator">=</span> <span class="string">&quot;test_topic_queue1&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">queue2Name</span> <span class="operator">=</span> <span class="string">&quot;test_topic_queue2&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">queue3Name</span> <span class="operator">=</span> <span class="string">&quot;test_topic_queue3&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">queue4Name</span> <span class="operator">=</span> <span class="string">&quot;test_topic_queue4&quot;</span>;</span><br><span class="line"></span><br><span class="line">        channel.queueDeclare(queue1Name,<span class="literal">true</span>,<span class="literal">false</span>,<span class="literal">false</span>,<span class="literal">null</span>);</span><br><span class="line">        channel.queueDeclare(queue2Name,<span class="literal">true</span>,<span class="literal">false</span>,<span class="literal">false</span>,<span class="literal">null</span>);</span><br><span class="line">        channel.queueDeclare(queue3Name,<span class="literal">true</span>,<span class="literal">false</span>,<span class="literal">false</span>,<span class="literal">null</span>);</span><br><span class="line">        channel.queueDeclare(queue4Name,<span class="literal">true</span>,<span class="literal">false</span>,<span class="literal">false</span>,<span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//7. 绑定队列和交换机</span></span><br><span class="line">        channel.queueBind(queue1Name,exchangeName,<span class="string">&quot;red.#.green&quot;</span>);</span><br><span class="line">        channel.queueBind(queue2Name,exchangeName,<span class="string">&quot;red.green.*&quot;</span>);</span><br><span class="line">        channel.queueBind(queue3Name,exchangeName,<span class="string">&quot;#.green&quot;</span>);</span><br><span class="line">        channel.queueBind(queue4Name,exchangeName,<span class="string">&quot;*.green.#&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">body</span> <span class="operator">=</span> <span class="string">&quot;topic....&quot;</span>;</span><br><span class="line">        <span class="comment">//8. 发送消息</span></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">            red.green.green			1/2/3/4</span></span><br><span class="line"><span class="comment">            green.green				3/4</span></span><br><span class="line"><span class="comment">            green.red.blue</span></span><br><span class="line"><span class="comment">            green.green.green		3/4</span></span><br><span class="line"><span class="comment">            green.red.green			3</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">            red.#.green</span></span><br><span class="line"><span class="comment">            red.green.*</span></span><br><span class="line"><span class="comment">            #.green</span></span><br><span class="line"><span class="comment">            *.green.#</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line"><span class="comment">//        channel.basicPublish(exchangeName,&quot;red.green.green&quot;,null,body.getBytes());</span></span><br><span class="line"><span class="comment">//        channel.basicPublish(exchangeName,&quot;green.green&quot;,null,body.getBytes());</span></span><br><span class="line"><span class="comment">//        channel.basicPublish(exchangeName,&quot;green.red.blue&quot;,null,body.getBytes());</span></span><br><span class="line"><span class="comment">//        channel.basicPublish(exchangeName,&quot;green.green.green&quot;,null,body.getBytes());</span></span><br><span class="line">        channel.basicPublish(exchangeName,<span class="string">&quot;green.red.green&quot;</span>,<span class="literal">null</span>,body.getBytes());</span><br><span class="line"></span><br><span class="line">        <span class="comment">//9. 释放资源</span></span><br><span class="line">        channel.close();</span><br><span class="line">        connection.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="4-5-3-消费者-1"><a href="#4-5-3-消费者-1" class="headerlink" title="4.5.3 消费者-1"></a>4.5.3 消费者-1</h3><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.minge.rabbitmq;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Consumer07_Topic_01</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="comment">// 创建连接工厂,用于获取频道channel</span></span><br><span class="line">        ConnectionFactory factory=<span class="keyword">new</span> <span class="title class_">ConnectionFactory</span>();</span><br><span class="line"></span><br><span class="line">        factory.setHost(<span class="string">&quot;192.168.40.132&quot;</span>);</span><br><span class="line">        factory.setPort(<span class="number">5672</span>);</span><br><span class="line">        factory.setUsername(<span class="string">&quot;lscl&quot;</span>);</span><br><span class="line">        factory.setPassword(<span class="string">&quot;admin&quot;</span>);</span><br><span class="line">        factory.setVirtualHost(<span class="string">&quot;/lscl&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2.创建连接</span></span><br><span class="line">        <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> factory.newConnection();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3.创建频道</span></span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> connection.createChannel();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 定义队列</span></span><br><span class="line">        String queueName=<span class="string">&quot;test_topic_queue1&quot;</span>;</span><br><span class="line">        channel.queueDeclare(queueName,<span class="literal">true</span>,<span class="literal">false</span>,<span class="literal">false</span>,<span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Consumer</span> <span class="variable">consumer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultConsumer</span>(channel)&#123;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleDelivery</span><span class="params">(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, <span class="type">byte</span>[] body)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line"></span><br><span class="line">                System.out.println(<span class="string">&quot;body：&quot;</span>+<span class="keyword">new</span> <span class="title class_">String</span>(body));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 接受queue的消息</span></span><br><span class="line">        channel.basicConsume(queueName,<span class="literal">true</span>,consumer);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 不释放资源,让rabbitmq一直监听</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>



<h3 id="4-5-4-消费者-2"><a href="#4-5-4-消费者-2" class="headerlink" title="4.5.4 消费者-2"></a>4.5.4 消费者-2</h3><p>和消费者-1代码一样，只是队列名换了</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">String queueName=<span class="string">&quot;test_topic_queue2&quot;</span>;</span><br></pre></td></tr></table></figure></div>

<h3 id="4-5-5-消费者-3"><a href="#4-5-5-消费者-3" class="headerlink" title="4.5.5 消费者-3"></a>4.5.5 消费者-3</h3><p>和消费者-1代码一样，只是队列名换了</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">String queueName=<span class="string">&quot;test_topic_queue3&quot;</span>;</span><br></pre></td></tr></table></figure></div>

<h3 id="4-5-6-消费者-4"><a href="#4-5-6-消费者-4" class="headerlink" title="4.5.6 消费者-4"></a>4.5.6 消费者-4</h3><p>和消费者-1代码一样，只是队列名换了</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">String queueName=<span class="string">&quot;test_topic_queue4&quot;</span>;</span><br></pre></td></tr></table></figure></div>

<h3 id="4-5-7-Topics模式小结"><a href="#4-5-7-Topics模式小结" class="headerlink" title="4.5.7 Topics模式小结"></a>4.5.7 Topics模式小结</h3><p>在Topics下（Exchange类型为topic，也叫主题模式），Routing Key的用法更加丰富，主要有<code>#</code>、<code>*</code>两个符号，<code>#</code>号可以匹配0个或多个词，<code>*</code>不多少刚好是一个</p>
<h2 id="4-6-RPC-模式"><a href="#4-6-RPC-模式" class="headerlink" title="4.6 RPC 模式"></a>4.6 RPC 模式</h2><h3 id="4-6-1-简介"><a href="#4-6-1-简介" class="headerlink" title="4.6.1 简介"></a>4.6.1 简介</h3><p>前面几种模式的通信都是基于Producer发送消息到Consumer，然后Consumer进行消费，假设我们需要Consumer操作完毕之后返回给Producer一个回调呢？前面几种模式就行不通了；</p>
<p>例如我们要做一个远程调用加钱操作，客户端远程调用服务端进行加钱操作，操作完毕之后服务端将用户最新的余额返回给客户端；客户端进行后续操作，例如更新到数据库等；</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/rabbit1/72.png"
                     
                ></p>
<p>在RPC模式中，客户端和服务器都是Producer也都是Consumer；</p>
<blockquote>
<p>RPC模式官网介绍：<a class="link"   target="_blank" rel="noopener" href="https://www.rabbitmq.com/tutorials/tutorial-five-java.html" >https://www.rabbitmq.com/tutorials/tutorial-five-java.html <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
</blockquote>
<h3 id="4-6-2-客户端"><a href="#4-6-2-客户端" class="headerlink" title="4.6.2 客户端"></a>4.6.2 客户端</h3><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.minge.rabbitmq;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.UUID;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ArrayBlockingQueue;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.BlockingQueue;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeoutException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RPCClient</span> <span class="keyword">implements</span> <span class="title class_">AutoCloseable</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Connection connection;</span><br><span class="line">    <span class="keyword">public</span> Channel channel;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">RPC_QUEUE_NAME</span> <span class="operator">=</span> <span class="string">&quot;rpc_queue&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">RPCClient</span><span class="params">()</span> <span class="keyword">throws</span> IOException, TimeoutException &#123;</span><br><span class="line">        <span class="type">ConnectionFactory</span> <span class="variable">factory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConnectionFactory</span>();</span><br><span class="line">        factory.setHost(<span class="string">&quot;192.168.40.132&quot;</span>);</span><br><span class="line">        factory.setPort(<span class="number">5672</span>);</span><br><span class="line">        factory.setUsername(<span class="string">&quot;lscl&quot;</span>);</span><br><span class="line">        factory.setPassword(<span class="string">&quot;admin&quot;</span>);</span><br><span class="line">        factory.setVirtualHost(<span class="string">&quot;/lscl&quot;</span>);</span><br><span class="line"></span><br><span class="line">        connection = factory.newConnection();</span><br><span class="line">        channel = connection.createChannel();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] argv)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 初始化信息</span></span><br><span class="line">        <span class="type">RPCClient</span> <span class="variable">rpcClient</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RPCClient</span>();</span><br><span class="line">        <span class="comment">// 发起远程调用</span></span><br><span class="line">        <span class="type">Integer</span> <span class="variable">response</span> <span class="operator">=</span> rpcClient.call(<span class="number">20</span>);</span><br><span class="line"></span><br><span class="line">        System.out.println(response);</span><br><span class="line"></span><br><span class="line">        rpcClient.channel.close();</span><br><span class="line">        rpcClient.connection.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Integer <span class="title function_">call</span><span class="params">(Integer money)</span> <span class="keyword">throws</span> IOException, InterruptedException &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 随机生成一个correlationId</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">String</span> <span class="variable">corrId</span> <span class="operator">=</span> UUID.randomUUID().toString();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 后期服务端回调给客户端的队列名(随机生成)</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">replyQueueName</span> <span class="operator">=</span> channel.queueDeclare().getQueue();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 设置发送消息的一些参数</span></span><br><span class="line">        AMQP.<span class="type">BasicProperties</span> <span class="variable">props</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AMQP</span>.BasicProperties</span><br><span class="line">                .Builder()</span><br><span class="line">                .correlationId(corrId)</span><br><span class="line">                .replyTo(replyQueueName)</span><br><span class="line">                .build();</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 采用Simple模式发送给Server端</span></span><br><span class="line">        channel.basicPublish(<span class="string">&quot;&quot;</span>, RPC_QUEUE_NAME, props, (money + <span class="string">&quot;&quot;</span>).getBytes(<span class="string">&quot;UTF-8&quot;</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 定义延迟队列</span></span><br><span class="line">        <span class="keyword">final</span> BlockingQueue&lt;Integer&gt; response = <span class="keyword">new</span> <span class="title class_">ArrayBlockingQueue</span>&lt;&gt;(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        channel.basicConsume(replyQueueName, <span class="literal">true</span>, <span class="keyword">new</span> <span class="title class_">DefaultConsumer</span>(channel) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 回调方法,当收到消息之后,会自动执行该方法</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleDelivery</span><span class="params">(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, <span class="type">byte</span>[] body)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (properties.getCorrelationId().equals(corrId)) &#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;响应的消息：&quot;</span> + <span class="keyword">new</span> <span class="title class_">String</span>(body));</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 往延迟队列中添加信息(服务端响应的最新余额)</span></span><br><span class="line">                    response.offer(Integer.parseInt(<span class="keyword">new</span> <span class="title class_">String</span>(body, <span class="string">&quot;UTF-8&quot;</span>)));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取延迟队列中的信息(如果没有信息将一直阻塞)</span></span><br><span class="line">        <span class="keyword">return</span> response.take();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">close</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        connection.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="4-6-2-服务端"><a href="#4-6-2-服务端" class="headerlink" title="4.6.2 服务端"></a>4.6.2 服务端</h3><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.minge.rabbitmq;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RPCServer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">RPC_QUEUE_NAME</span> <span class="operator">=</span> <span class="string">&quot;rpc_queue&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 总金额</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">Integer</span> <span class="variable">money</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 加钱方法</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> n</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Integer <span class="title function_">addMoney</span><span class="params">(<span class="type">int</span> n)</span> &#123;</span><br><span class="line">        money += n;</span><br><span class="line">        <span class="keyword">return</span> money;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] argv)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ConnectionFactory</span> <span class="variable">factory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConnectionFactory</span>();</span><br><span class="line">        factory.setHost(<span class="string">&quot;192.168.40.132&quot;</span>);</span><br><span class="line">        factory.setPort(<span class="number">5672</span>);</span><br><span class="line">        factory.setUsername(<span class="string">&quot;lscl&quot;</span>);</span><br><span class="line">        factory.setPassword(<span class="string">&quot;admin&quot;</span>);</span><br><span class="line">        factory.setVirtualHost(<span class="string">&quot;/lscl&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> (</span><br><span class="line">                <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> factory.newConnection();</span><br><span class="line">                <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> connection.createChannel()</span><br><span class="line">        ) &#123;</span><br><span class="line"></span><br><span class="line">            channel.queueDeclare(RPC_QUEUE_NAME, <span class="literal">true</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">            System.out.println(<span class="string">&quot;等待客户端请求.....&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 接受到客户端的请求(消息)</span></span><br><span class="line">                channel.basicConsume(RPC_QUEUE_NAME, <span class="literal">true</span>, <span class="keyword">new</span> <span class="title class_">DefaultConsumer</span>(channel) &#123;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 回调方法,当收到消息之后,会自动执行该方法</span></span><br><span class="line">                    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleDelivery</span><span class="params">(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, <span class="type">byte</span>[] body)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">                        AMQP.<span class="type">BasicProperties</span> <span class="variable">replyProps</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AMQP</span>.BasicProperties</span><br><span class="line">                                .Builder()</span><br><span class="line">                                .correlationId(properties.getCorrelationId())</span><br><span class="line">                                .build();</span><br><span class="line"></span><br><span class="line">                        System.out.println(<span class="string">&quot;客户端的消息: &quot;</span>+<span class="keyword">new</span> <span class="title class_">String</span>(body,<span class="string">&quot;UTF-8&quot;</span>));</span><br><span class="line">                        <span class="type">String</span> <span class="variable">response</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(body, <span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line"></span><br><span class="line">                            <span class="comment">// 调用加钱方法</span></span><br><span class="line">                            response = addMoney(Integer.parseInt(message)) + <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">                        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line"></span><br><span class="line">                            <span class="comment">// 发送一个消息给客户端</span></span><br><span class="line">                            <span class="comment">/*</span></span><br><span class="line"><span class="comment">                            properties.getReplyTo(): Client端设置的回调队列名</span></span><br><span class="line"><span class="comment">                            replyProps:封装的参数(主要是CorrelationId)</span></span><br><span class="line"><span class="comment">                             */</span></span><br><span class="line">                            channel.basicPublish(<span class="string">&quot;&quot;</span>, properties.getReplyTo(), replyProps, response.getBytes(<span class="string">&quot;UTF-8&quot;</span>));</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="4-6-3-RPC模式小结"><a href="#4-6-3-RPC模式小结" class="headerlink" title="4.6.3 RPC模式小结"></a>4.6.3 RPC模式小结</h3><p>严格意义上来说RPC并不是一种新的交换模式，他其实还是借助原有的模式（上述案例是采用Simple模式）来达到一些不同的功能，在RPC模式中只有客户端和服务端，并且客户端和服务端都既是Producer也是Consumer；</p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/rabbit1/71.png"
                      style="zoom:67%;" 
                >

<blockquote>
<p>Tips：RPC模式已经违背了消息队列设计的初衷了；即一些无需及时返回且耗时的操作；</p>
</blockquote>
<h2 id="4-7-Publisher-Confirms-模式"><a href="#4-7-Publisher-Confirms-模式" class="headerlink" title="4.7 Publisher Confirms 模式"></a>4.7 Publisher Confirms 模式</h2><p>Publisher Confirms（发布者确认）模式是一个RabbitMQ扩展，用于实现可靠发布。当在某个Channel上开启发布确认后，客户端发布的消息会被MQ服务器（broker）异步的确认；</p>
<blockquote>
<p>消息的确认机制我们明天重点讲解；</p>
</blockquote>
<h2 id="4-8-Header类型交换机补充"><a href="#4-8-Header类型交换机补充" class="headerlink" title="4.8 Header类型交换机补充"></a>4.8 Header类型交换机补充</h2><h3 id="4-8-1-简介"><a href="#4-8-1-简介" class="headerlink" title="4.8.1 简介"></a>4.8.1 简介</h3><p>关于RabbitMQ官网提供的所有交换模式我们都已经介绍完毕了，唯独还有一个header类型的交换机没有介绍，那header类型的交换机又有什么作用呢？</p>
<p>header类型的Exchange与Routing有点类似，不同的是，header类型的Exchange取消了Routing Key，使用key&#x2F;value来匹配队列</p>
<p>header的匹配有两种方式，一种是<code>all</code>另一种是<code>any</code>。这两种方式是在接收端必须要用键值<code>x-match</code>来定义。</p>
<ul>
<li><p><code>all</code>：代表必须匹配Consumer端的所有键值对</p>
</li>
<li><p><code>any</code>：代表只要匹配Consumer端的任意一个键值对即可</p>
</li>
</ul>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/rabbit1/70.png"
                      style="zoom: 67%;" 
                >

<h3 id="4-8-2-生产者"><a href="#4-8-2-生产者" class="headerlink" title="4.8.2 生产者"></a>4.8.2 生产者</h3><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.minge.rabbitmq;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.*;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.AMQP.BasicProperties.Builder;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Producer06_Header</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 创建连接和频道</span></span><br><span class="line">        <span class="type">ConnectionFactory</span> <span class="variable">factory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConnectionFactory</span>();</span><br><span class="line">        factory.setHost(<span class="string">&quot;127.0.0.1&quot;</span>);</span><br><span class="line">        factory.setPort(<span class="number">5672</span>);</span><br><span class="line">        factory.setUsername(<span class="string">&quot;lscl&quot;</span>);</span><br><span class="line">        factory.setPassword(<span class="string">&quot;admin&quot;</span>);</span><br><span class="line">        factory.setVirtualHost(<span class="string">&quot;/lscl&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> factory.newConnection();</span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> connection.createChannel();</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">            定义一个交换机为header类型</span></span><br><span class="line"><span class="comment">            true:代表持久化</span></span><br><span class="line"><span class="comment">            true:代自动删除(没有consumer时自动销毁)</span></span><br><span class="line"><span class="comment">            false:代表不是内部使用的交换机</span></span><br><span class="line"><span class="comment">            null:传递的参数为null</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">exchangeName</span> <span class="operator">=</span> <span class="string">&quot;test_header&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 声明交换机和类型headers</span></span><br><span class="line">        channel.exchangeDeclare(exchangeName, BuiltinExchangeType.HEADERS, <span class="literal">true</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">queue</span> <span class="operator">=</span> <span class="string">&quot;test_header_queue&quot;</span>;</span><br><span class="line">        <span class="comment">// 定义队列</span></span><br><span class="line">        channel.queueDeclare(queue, <span class="literal">true</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        Map&lt;String, Object&gt; bindingHeaders = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">            all:代表发送消息时必须匹配header中的所有key/val对</span></span><br><span class="line"><span class="comment">            any:代表发送消息时只需要匹配header中的任意一个key/val对</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        bindingHeaders.put(<span class="string">&quot;x-match&quot;</span>, <span class="string">&quot;all&quot;</span>);</span><br><span class="line">        bindingHeaders.put(<span class="string">&quot;key1&quot;</span>, <span class="string">&quot;147&quot;</span>);</span><br><span class="line">        bindingHeaders.put(<span class="string">&quot;key2&quot;</span>, <span class="string">&quot;258&quot;</span>);</span><br><span class="line">        bindingHeaders.put(<span class="string">&quot;key3&quot;</span>, <span class="string">&quot;369&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 将交换机绑定到队列,并指定header信息</span></span><br><span class="line">        channel.queueBind(queue, exchangeName, <span class="string">&quot;&quot;</span>, bindingHeaders);</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">body</span> <span class="operator">=</span> <span class="string">&quot;header....&quot;</span>;</span><br><span class="line"></span><br><span class="line">        Map&lt;String, Object&gt; requestHeader = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        requestHeader.put(<span class="string">&quot;key1&quot;</span>, <span class="string">&quot;147&quot;</span>);</span><br><span class="line"><span class="comment">//        requestHeader.put(&quot;key2&quot;, &quot;258&quot;);</span></span><br><span class="line"><span class="comment">//        requestHeader.put(&quot;key3&quot;, &quot;369&quot;);</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 消息配置对象</span></span><br><span class="line">        <span class="type">Builder</span> <span class="variable">properties</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AMQP</span>.BasicProperties.Builder();</span><br><span class="line">        properties.headers(requestHeader);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 将消息直接发送给交换机(携带指定的参数header),让交换机自己根据header条件去转发到指定queue</span></span><br><span class="line">        channel.basicPublish(exchangeName, <span class="string">&quot;&quot;</span>, properties.build(), body.getBytes());</span><br><span class="line"></span><br><span class="line">        channel.close();</span><br><span class="line">        connection.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="4-8-3-消费者"><a href="#4-8-3-消费者" class="headerlink" title="4.8.3 消费者"></a>4.8.3 消费者</h3><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.minge.rabbitmq;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Consumer11_Header</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 创建连接和频道</span></span><br><span class="line">        <span class="type">ConnectionFactory</span> <span class="variable">factory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConnectionFactory</span>();</span><br><span class="line">        factory.setHost(<span class="string">&quot;192.168.40.141&quot;</span>);</span><br><span class="line">        factory.setPort(<span class="number">5672</span>);</span><br><span class="line">        factory.setUsername(<span class="string">&quot;lscl&quot;</span>);</span><br><span class="line">        factory.setPassword(<span class="string">&quot;admin&quot;</span>);</span><br><span class="line">        factory.setVirtualHost(<span class="string">&quot;/lscl&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> factory.newConnection();</span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> connection.createChannel();</span><br><span class="line"></span><br><span class="line">        channel.basicConsume(<span class="string">&quot;test_header_queue&quot;</span>, <span class="literal">true</span>, <span class="keyword">new</span> <span class="title class_">DefaultConsumer</span>(channel) &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleDelivery</span><span class="params">(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, <span class="type">byte</span>[] body)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line"></span><br><span class="line">                System.out.println(<span class="string">&quot;body：&quot;</span> + <span class="keyword">new</span> <span class="title class_">String</span>(body));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="4-8-4-header类型交换机小结"><a href="#4-8-4-header类型交换机小结" class="headerlink" title="4.8.4 header类型交换机小结"></a>4.8.4 header类型交换机小结</h3><p>在<code>header</code>类型交换机中，放弃了<code>routing key</code>，取而代之的是<code>key/value</code>键值对，在Producer绑定队列时指定<code>key/value</code>键值对，当Producer发送消息时也会指定一个<code>key/value</code>键值对，如果此时的<code>key/value</code>键值对符合当初绑定队列的键值对，那么消息就可以路由到此队列，反之消息则丢失；</p>
<ul>
<li><code>header</code>类型交换机工作原理图：</li>
</ul>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/rabbit1/70.png"
                      alt="在这里插入图片描述" style="zoom:67%;" 
                >

<h1 id="五、Spring整合RabbitMQ"><a href="#五、Spring整合RabbitMQ" class="headerlink" title="五、Spring整合RabbitMQ"></a>五、Spring整合RabbitMQ</h1><h2 id="5-1-搭建消息生产者"><a href="#5-1-搭建消息生产者" class="headerlink" title="5.1 搭建消息生产者"></a>5.1 搭建消息生产者</h2><h3 id="5-1-1-pom-xml："><a href="#5-1-1-pom-xml：" class="headerlink" title="5.1.1 pom.xml："></a>5.1.1 pom.xml：</h3><div class="highlight-container" data-rel="Xml"><figure class="iseeu highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.minge<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>03_spring_rabbitmq_producer<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--spring核心依赖--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-context<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.1.7.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!--spring整合rabbitmq依赖--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.amqp<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-rabbit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.8.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!--测试单元--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.12<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!--spring整合测试单元--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.1.7.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure></div>

<h3 id="5-1-2-rabbitmq-properties："><a href="#5-1-2-rabbitmq-properties：" class="headerlink" title="5.1.2 rabbitmq.properties："></a>5.1.2 rabbitmq.properties：</h3><div class="highlight-container" data-rel="Properties"><figure class="iseeu highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">rabbitmq.host</span>=<span class="string">192.168.40.139</span></span><br><span class="line"><span class="attr">rabbitmq.port</span>=<span class="string">5672</span></span><br><span class="line"><span class="attr">rabbitmq.username</span>=<span class="string">lscl</span></span><br><span class="line"><span class="attr">rabbitmq.password</span>=<span class="string">admin</span></span><br><span class="line"><span class="attr">rabbitmq.virtual-host</span>=<span class="string">/lscl</span></span><br></pre></td></tr></table></figure></div>

<h3 id="5-1-3-spring-xml："><a href="#5-1-3-spring-xml：" class="headerlink" title="5.1.3 spring.xml："></a>5.1.3 spring.xml：</h3><div class="highlight-container" data-rel="Xml"><figure class="iseeu highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:context</span>=<span class="string">&quot;http://www.springframework.org/schema/context&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:rabbit</span>=<span class="string">&quot;http://www.springframework.org/schema/rabbit&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="string"><span class="tag">       http://www.springframework.org/schema/beans/spring-beans.xsd</span></span></span><br><span class="line"><span class="string"><span class="tag">       http://www.springframework.org/schema/context</span></span></span><br><span class="line"><span class="string"><span class="tag">       https://www.springframework.org/schema/context/spring-context.xsd</span></span></span><br><span class="line"><span class="string"><span class="tag">       http://www.springframework.org/schema/rabbit</span></span></span><br><span class="line"><span class="string"><span class="tag">       http://www.springframework.org/schema/rabbit/spring-rabbit.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--加载配置文件--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">context:property-placeholder</span> <span class="attr">location</span>=<span class="string">&quot;classpath:rabbitmq.properties&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 定义rabbitmq connectionFactory --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">rabbit:connection-factory</span> <span class="attr">id</span>=<span class="string">&quot;connectionFactory&quot;</span> <span class="attr">host</span>=<span class="string">&quot;$&#123;rabbitmq.host&#125;&quot;</span></span></span><br><span class="line"><span class="tag">                               <span class="attr">port</span>=<span class="string">&quot;$&#123;rabbitmq.port&#125;&quot;</span></span></span><br><span class="line"><span class="tag">                               <span class="attr">username</span>=<span class="string">&quot;$&#123;rabbitmq.username&#125;&quot;</span></span></span><br><span class="line"><span class="tag">                               <span class="attr">password</span>=<span class="string">&quot;$&#123;rabbitmq.password&#125;&quot;</span></span></span><br><span class="line"><span class="tag">                               <span class="attr">virtual-host</span>=<span class="string">&quot;$&#123;rabbitmq.virtual-host&#125;&quot;</span>/&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--定义管理交换机、队列--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">rabbit:admin</span> <span class="attr">connection-factory</span>=<span class="string">&quot;connectionFactory&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">        定义一个队列</span></span><br><span class="line"><span class="comment">        name: 队列的名称</span></span><br><span class="line"><span class="comment">        durable: 是否持久化(默认true)</span></span><br><span class="line"><span class="comment">        auto-delete: 是否自动删除(默认false)</span></span><br><span class="line"><span class="comment">        exclusive: 是否独占(默认false)</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">	如果队列不存在则自动创建；不绑定到交换机则绑定到默认交换机</span></span><br><span class="line"><span class="comment">    默认交换机类型为direct，名字为: &quot;&quot;，路由键为队列的名称</span></span><br><span class="line"><span class="comment">    --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">rabbit:queue</span> <span class="attr">id</span>=<span class="string">&quot;spring_work_queue&quot;</span> <span class="attr">name</span>=<span class="string">&quot;spring_work_queue&quot;</span> <span class="attr">auto-delete</span>=<span class="string">&quot;false&quot;</span></span></span><br><span class="line"><span class="tag">                  <span class="attr">exclusive</span>=<span class="string">&quot;false&quot;</span> <span class="attr">durable</span>=<span class="string">&quot;true&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--定义rabbitTemplate对象操作可以在代码中方便发送消息--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">rabbit:template</span> <span class="attr">id</span>=<span class="string">&quot;rabbitTemplate&quot;</span> <span class="attr">connection-factory</span>=<span class="string">&quot;connectionFactory&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure></div>

<h3 id="5-1-4-消息生产者测试类："><a href="#5-1-4-消息生产者测试类：" class="headerlink" title="5.1.4 消息生产者测试类："></a>5.1.4 消息生产者测试类：</h3><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.minge.rabbitmq;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"><span class="keyword">import</span> org.junit.runner.RunWith;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.core.RabbitTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.test.context.ContextConfiguration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.test.context.junit4.SpringRunner;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RunWith(SpringRunner.class)</span></span><br><span class="line"><span class="meta">@ContextConfiguration(locations = &quot;classpath:spring.xml&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ProducerTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//1.注入 RabbitTemplate</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RabbitTemplate rabbitTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * work模式</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testHelloWorld</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="comment">//2.发送消息</span></span><br><span class="line">        rabbitTemplate.convertAndSend(<span class="string">&quot;spring_work_queue&quot;</span>,<span class="string">&quot;spring work....&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h2 id="5-2-搭建消息消费者"><a href="#5-2-搭建消息消费者" class="headerlink" title="5.2 搭建消息消费者"></a>5.2 搭建消息消费者</h2><h3 id="5-2-1-pom-xml："><a href="#5-2-1-pom-xml：" class="headerlink" title="5.2.1 pom.xml："></a>5.2.1 pom.xml：</h3><p>和生产者一致</p>
<h3 id="5-2-2-rabbitmq-properties："><a href="#5-2-2-rabbitmq-properties：" class="headerlink" title="5.2.2 rabbitmq.properties："></a>5.2.2 rabbitmq.properties：</h3><p>和生产者一致</p>
<h3 id="5-2-3-监听器类："><a href="#5-2-3-监听器类：" class="headerlink" title="5.2.3 监听器类："></a>5.2.3 监听器类：</h3><p>需要实现MessageListener接口，重写onMessage方法</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.minge.rabbitmq;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.Message;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.MessageListener;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpringWorkListener</span> <span class="keyword">implements</span> <span class="title class_">MessageListener</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onMessage</span><span class="params">(Message message)</span> &#123;</span><br><span class="line">        <span class="comment">//打印消息</span></span><br><span class="line">        System.out.println(<span class="string">&quot;work:&quot;</span> + <span class="keyword">new</span> <span class="title class_">String</span>(message.getBody()));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="5-2-4-spring-xml："><a href="#5-2-4-spring-xml：" class="headerlink" title="5.2.4 spring.xml："></a>5.2.4 spring.xml：</h3><div class="highlight-container" data-rel="Xml"><figure class="iseeu highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:context</span>=<span class="string">&quot;http://www.springframework.org/schema/context&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:rabbit</span>=<span class="string">&quot;http://www.springframework.org/schema/rabbit&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="string"><span class="tag">       http://www.springframework.org/schema/beans/spring-beans.xsd</span></span></span><br><span class="line"><span class="string"><span class="tag">       http://www.springframework.org/schema/context</span></span></span><br><span class="line"><span class="string"><span class="tag">       https://www.springframework.org/schema/context/spring-context.xsd</span></span></span><br><span class="line"><span class="string"><span class="tag">       http://www.springframework.org/schema/rabbit</span></span></span><br><span class="line"><span class="string"><span class="tag">       http://www.springframework.org/schema/rabbit/spring-rabbit.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--加载配置文件--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">context:property-placeholder</span> <span class="attr">location</span>=<span class="string">&quot;classpath:rabbitmq.properties&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 定义rabbitmq connectionFactory --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">rabbit:connection-factory</span> <span class="attr">id</span>=<span class="string">&quot;connectionFactory&quot;</span> <span class="attr">host</span>=<span class="string">&quot;$&#123;rabbitmq.host&#125;&quot;</span></span></span><br><span class="line"><span class="tag">                               <span class="attr">port</span>=<span class="string">&quot;$&#123;rabbitmq.port&#125;&quot;</span></span></span><br><span class="line"><span class="tag">                               <span class="attr">username</span>=<span class="string">&quot;$&#123;rabbitmq.username&#125;&quot;</span></span></span><br><span class="line"><span class="tag">                               <span class="attr">password</span>=<span class="string">&quot;$&#123;rabbitmq.password&#125;&quot;</span></span></span><br><span class="line"><span class="tag">                               <span class="attr">virtual-host</span>=<span class="string">&quot;$&#123;rabbitmq.virtual-host&#125;&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 注册监听器 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;springWorkListener&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.minge.rabbitmq.SpringWorkListener&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 绑定到监听器容器 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">rabbit:listener-container</span> <span class="attr">connection-factory</span>=<span class="string">&quot;connectionFactory&quot;</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 引用监听器并指定监听的队列,监听多个队列以逗号分隔 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">rabbit:listener</span> <span class="attr">ref</span>=<span class="string">&quot;springWorkListener&quot;</span> <span class="attr">queue-names</span>=<span class="string">&quot;spring_work_queue&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">rabbit:listener-container</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure></div>

<h3 id="5-2-5-消息消费者测试类："><a href="#5-2-5-消息消费者测试类：" class="headerlink" title="5.2.5 消息消费者测试类："></a>5.2.5 消息消费者测试类：</h3><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.minge.rabbitmq;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"><span class="keyword">import</span> org.junit.runner.RunWith;</span><br><span class="line"><span class="keyword">import</span> org.springframework.test.context.ContextConfiguration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.test.context.junit4.SpringRunner;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RunWith(SpringRunner.class)</span></span><br><span class="line"><span class="meta">@ContextConfiguration(locations = &quot;classpath:spring.xml&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConsumerTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test1</span><span class="params">()</span>&#123;</span><br><span class="line">       </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h2 id="5-3-测试其他类型队列"><a href="#5-3-测试其他类型队列" class="headerlink" title="5.3 测试其他类型队列"></a>5.3 测试其他类型队列</h2><h3 id="5-3-1-Pub-Sub模式"><a href="#5-3-1-Pub-Sub模式" class="headerlink" title="5.3.1 Pub&#x2F;Sub模式"></a>5.3.1 Pub&#x2F;Sub模式</h3><p><strong>强调fanout类型的交换机，也叫分列模式</strong></p>
<h4 id="5-3-1-1-生产者"><a href="#5-3-1-1-生产者" class="headerlink" title="5.3.1.1 生产者"></a>5.3.1.1 生产者</h4><p>在spring.xml扩展：</p>
<p>定义一个交换机和两个队列，并且把队列绑定到交换机</p>
<div class="highlight-container" data-rel="Xml"><figure class="iseeu highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">    定义持久化队列，</span></span><br><span class="line"><span class="comment">--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">rabbit:queue</span> <span class="attr">id</span>=<span class="string">&quot;spring_fanout_queue1&quot;</span> <span class="attr">name</span>=<span class="string">&quot;spring_fanout_queue1&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">rabbit:queue</span> <span class="attr">id</span>=<span class="string">&quot;spring_fanout_queue2&quot;</span> <span class="attr">name</span>=<span class="string">&quot;spring_fanout_queue2&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- fanout工作模式的交换机 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">rabbit:fanout-exchange</span> <span class="attr">id</span>=<span class="string">&quot;spring_fanout_exchange&quot;</span> <span class="attr">name</span>=<span class="string">&quot;spring_fanout_exchange&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--绑定queue--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">rabbit:bindings</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">rabbit:binding</span> <span class="attr">queue</span>=<span class="string">&quot;spring_fanout_queue1&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">rabbit:binding</span> <span class="attr">queue</span>=<span class="string">&quot;spring_fanout_queue2&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">rabbit:bindings</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">rabbit:fanout-exchange</span>&gt;</span></span><br></pre></td></tr></table></figure></div>

<p>编写测试类：</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Pub/sub模式(fanout模式)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testFanout</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="comment">//2.发送消息</span></span><br><span class="line"></span><br><span class="line">    rabbitTemplate.convertAndSend(<span class="string">&quot;spring_fanout_exchange&quot;</span>,<span class="string">&quot;&quot;</span>,<span class="string">&quot;spring fanout....&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h4 id="5-3-1-2-消费者"><a href="#5-3-1-2-消费者" class="headerlink" title="5.3.1.2 消费者"></a>5.3.1.2 消费者</h4><p>编写两个监听器：</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.minge.rabbitmq;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.Message;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.MessageListener;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpringFanoutListener1</span> <span class="keyword">implements</span> <span class="title class_">MessageListener</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onMessage</span><span class="params">(Message message)</span> &#123;</span><br><span class="line">        <span class="comment">//打印消息</span></span><br><span class="line">        System.out.println(<span class="string">&quot;fanout1:&quot;</span> + <span class="keyword">new</span> <span class="title class_">String</span>(message.getBody()));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">------------------------------------------------------------------</span><br><span class="line"><span class="keyword">package</span> com.minge.rabbitmq;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.Message;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.MessageListener;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpringFanoutListener2</span> <span class="keyword">implements</span> <span class="title class_">MessageListener</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onMessage</span><span class="params">(Message message)</span> &#123;</span><br><span class="line">        <span class="comment">//打印消息</span></span><br><span class="line">        System.out.println(<span class="string">&quot;fanout2:&quot;</span> + <span class="keyword">new</span> <span class="title class_">String</span>(message.getBody()));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>



<p>在spring.xml中注册两个监听器：</p>
<div class="highlight-container" data-rel="Xml"><figure class="iseeu highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;springFanoutListener1&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.minge.rabbitmq.SpringFanoutListener1&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;springFanoutListener2&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.minge.rabbitmq.SpringFanoutListener2&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 绑定到监听器容器 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">rabbit:listener-container</span> <span class="attr">connection-factory</span>=<span class="string">&quot;connectionFactory&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">rabbit:listener</span> <span class="attr">ref</span>=<span class="string">&quot;springFanoutListener1&quot;</span> <span class="attr">queue-names</span>=<span class="string">&quot;spring_fanout_queue1&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">rabbit:listener</span> <span class="attr">ref</span>=<span class="string">&quot;springFanoutListener2&quot;</span> <span class="attr">queue-names</span>=<span class="string">&quot;spring_fanout_queue2&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">rabbit:listener-container</span>&gt;</span></span><br></pre></td></tr></table></figure></div>



<h3 id="5-3-2-Routing模式"><a href="#5-3-2-Routing模式" class="headerlink" title="5.3.2 Routing模式"></a>5.3.2 Routing模式</h3><p><strong>强调direct类型的交换机，也叫直连模式；</strong></p>
<h4 id="5-3-2-1-生产者"><a href="#5-3-2-1-生产者" class="headerlink" title="5.3.2.1 生产者"></a>5.3.2.1 生产者</h4><p>扩展spring.xml：</p>
<div class="highlight-container" data-rel="Xml"><figure class="iseeu highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 定义两个队列 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">rabbit:queue</span> <span class="attr">id</span>=<span class="string">&quot;spring_direct_queue1&quot;</span> <span class="attr">name</span>=<span class="string">&quot;spring_direct_queue1&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">rabbit:queue</span> <span class="attr">id</span>=<span class="string">&quot;spring_direct_queue2&quot;</span> <span class="attr">name</span>=<span class="string">&quot;spring_direct_queue2&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- routing工作模式 将队列绑定到交换机 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">rabbit:direct-exchange</span> <span class="attr">id</span>=<span class="string">&quot;spring_direct_exchange&quot;</span> <span class="attr">name</span>=<span class="string">&quot;spring_direct_exchange&quot;</span> &gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">rabbit:bindings</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--绑定queue指定routing key--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">rabbit:binding</span> <span class="attr">queue</span>=<span class="string">&quot;spring_direct_queue1&quot;</span> <span class="attr">key</span>=<span class="string">&quot;red&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">rabbit:binding</span> <span class="attr">queue</span>=<span class="string">&quot;spring_direct_queue2&quot;</span> <span class="attr">key</span>=<span class="string">&quot;green&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">rabbit:bindings</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">rabbit:direct-exchange</span>&gt;</span></span><br></pre></td></tr></table></figure></div>

<p>编写测试类：</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * routing模式(direct模式)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testRouting</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="comment">//2.发送消息</span></span><br><span class="line"></span><br><span class="line">    rabbitTemplate.convertAndSend(<span class="string">&quot;spring_direct_exchange&quot;</span>,<span class="string">&quot;red&quot;</span>,<span class="string">&quot;spring routing red....&quot;</span>);</span><br><span class="line">    rabbitTemplate.convertAndSend(<span class="string">&quot;spring_direct_exchange&quot;</span>,<span class="string">&quot;green&quot;</span>,<span class="string">&quot;spring routing green....&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>



<h4 id="5-3-2-2-消费者"><a href="#5-3-2-2-消费者" class="headerlink" title="5.3.2.2 消费者"></a>5.3.2.2 消费者</h4><p>编写两个监听器：</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.minge.rabbitmq;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.Message;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.MessageListener;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpringDirectListener1</span> <span class="keyword">implements</span> <span class="title class_">MessageListener</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onMessage</span><span class="params">(Message message)</span> &#123;</span><br><span class="line">        <span class="comment">//打印消息</span></span><br><span class="line">        System.out.println(<span class="string">&quot;direct1:&quot;</span> + <span class="keyword">new</span> <span class="title class_">String</span>(message.getBody()));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">---------------------------------------------------------------------------------------</span><br><span class="line"><span class="keyword">package</span> com.minge.rabbitmq;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.Message;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.MessageListener;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpringDirectListener2</span> <span class="keyword">implements</span> <span class="title class_">MessageListener</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onMessage</span><span class="params">(Message message)</span> &#123;</span><br><span class="line">        <span class="comment">//打印消息</span></span><br><span class="line">        System.out.println(<span class="string">&quot;direct2:&quot;</span> + <span class="keyword">new</span> <span class="title class_">String</span>(message.getBody()));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>在spring.xml中注册监听器：</p>
<div class="highlight-container" data-rel="Xml"><figure class="iseeu highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;directListener1&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.minge.rabbitmq.SpringDirectListener1&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;directListener2&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.minge.rabbitmq.SpringDirectListener2&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 绑定到监听器容器 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">rabbit:listener-container</span> <span class="attr">connection-factory</span>=<span class="string">&quot;connectionFactory&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">rabbit:listener</span> <span class="attr">ref</span>=<span class="string">&quot;directListener1&quot;</span> <span class="attr">queue-names</span>=<span class="string">&quot;spring_direct_queue1&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">rabbit:listener</span> <span class="attr">ref</span>=<span class="string">&quot;directListener2&quot;</span> <span class="attr">queue-names</span>=<span class="string">&quot;spring_direct_queue2&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">rabbit:listener-container</span>&gt;</span></span><br></pre></td></tr></table></figure></div>



<h3 id="5-3-3-Topics模式"><a href="#5-3-3-Topics模式" class="headerlink" title="5.3.3 Topics模式"></a>5.3.3 Topics模式</h3><h4 id="5-3-3-1-生产者"><a href="#5-3-3-1-生产者" class="headerlink" title="5.3.3.1 生产者"></a>5.3.3.1 生产者</h4><p>在spring.xml中定义交换机以及队列：</p>
<div class="highlight-container" data-rel="Xml"><figure class="iseeu highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 定义4个队列 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">rabbit:queue</span> <span class="attr">id</span>=<span class="string">&quot;spring_topic_queue1&quot;</span> <span class="attr">name</span>=<span class="string">&quot;spring_topic_queue1&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">rabbit:queue</span> <span class="attr">id</span>=<span class="string">&quot;spring_topic_queue2&quot;</span> <span class="attr">name</span>=<span class="string">&quot;spring_topic_queue2&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">rabbit:queue</span> <span class="attr">id</span>=<span class="string">&quot;spring_topic_queue3&quot;</span> <span class="attr">name</span>=<span class="string">&quot;spring_topic_queue3&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">rabbit:queue</span> <span class="attr">id</span>=<span class="string">&quot;spring_topic_queue4&quot;</span> <span class="attr">name</span>=<span class="string">&quot;spring_topic_queue4&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- topic工作模式,将队列绑定到交换机 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">rabbit:topic-exchange</span> <span class="attr">id</span>=<span class="string">&quot;spring_topic_exchange&quot;</span> <span class="attr">name</span>=<span class="string">&quot;spring_topic_exchange&quot;</span> &gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">rabbit:bindings</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">rabbit:binding</span> <span class="attr">pattern</span>=<span class="string">&quot;red.#.green&quot;</span> <span class="attr">queue</span>=<span class="string">&quot;spring_topic_queue1&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">rabbit:binding</span> <span class="attr">pattern</span>=<span class="string">&quot;red.green.*&quot;</span> <span class="attr">queue</span>=<span class="string">&quot;spring_topic_queue2&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">rabbit:binding</span> <span class="attr">pattern</span>=<span class="string">&quot;#.green&quot;</span> <span class="attr">queue</span>=<span class="string">&quot;spring_topic_queue3&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">rabbit:binding</span> <span class="attr">pattern</span>=<span class="string">&quot;*.green.#&quot;</span> <span class="attr">queue</span>=<span class="string">&quot;spring_topic_queue4&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">rabbit:bindings</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">rabbit:topic-exchange</span>&gt;</span></span><br></pre></td></tr></table></figure></div>

<p>编写测试方法：</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * topic模式</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testTopics</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">//2.发送消息</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 命中: q1、q2、q3、q4</span></span><br><span class="line">    rabbitTemplate.convertAndSend(<span class="string">&quot;spring_topic_exchange&quot;</span>, <span class="string">&quot;red.green.green&quot;</span>, <span class="string">&quot;spring topic....&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 命中: q3、q4</span></span><br><span class="line"><span class="comment">//        rabbitTemplate.convertAndSend(&quot;spring_topic_exchange&quot;,&quot;green.green&quot;,&quot;spring topic....&quot;);</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 命中: 没有一个命中</span></span><br><span class="line"><span class="comment">//        rabbitTemplate.convertAndSend(&quot;spring_topic_exchange&quot;,&quot;green.red.blue&quot;,&quot;spring topic....&quot;);</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 命中: q3、q4</span></span><br><span class="line"><span class="comment">//        rabbitTemplate.convertAndSend(&quot;spring_topic_exchange&quot;,&quot;green.green.green&quot;,&quot;spring topic....&quot;);</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 命中: q3</span></span><br><span class="line"><span class="comment">//        rabbitTemplate.convertAndSend(&quot;spring_topic_exchange&quot;,&quot;green.red.green&quot;,&quot;spring topic....&quot;);</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></div>

<h4 id="5-3-3-2-消费者"><a href="#5-3-3-2-消费者" class="headerlink" title="5.3.3.2 消费者"></a>5.3.3.2 消费者</h4><p>编写4个监听器：</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.minge.rabbitmq;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.Message;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.MessageListener;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpringTopicListener1</span> <span class="keyword">implements</span> <span class="title class_">MessageListener</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onMessage</span><span class="params">(Message message)</span> &#123;</span><br><span class="line">        <span class="comment">//打印消息</span></span><br><span class="line">        System.out.println(<span class="string">&quot;topic1:&quot;</span> + <span class="keyword">new</span> <span class="title class_">String</span>(message.getBody()));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<blockquote>
<p>其余三个代码一模一样</p>
</blockquote>
<p>在spring.xml中注册监听器：</p>
<div class="highlight-container" data-rel="Xml"><figure class="iseeu highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;topicListener1&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.minge.rabbitmq.SpringTopicListener1&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;topicListener2&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.minge.rabbitmq.SpringTopicListener2&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;topicListener3&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.minge.rabbitmq.SpringTopicListener3&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;topicListener4&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.minge.rabbitmq.SpringTopicListener4&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 绑定到监听器容器 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">rabbit:listener-container</span> <span class="attr">connection-factory</span>=<span class="string">&quot;connectionFactory&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">rabbit:listener</span> <span class="attr">ref</span>=<span class="string">&quot;topicListener1&quot;</span> <span class="attr">queue-names</span>=<span class="string">&quot;spring_topic_queue1&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">rabbit:listener</span> <span class="attr">ref</span>=<span class="string">&quot;topicListener2&quot;</span> <span class="attr">queue-names</span>=<span class="string">&quot;spring_topic_queue2&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">rabbit:listener</span> <span class="attr">ref</span>=<span class="string">&quot;topicListener3&quot;</span> <span class="attr">queue-names</span>=<span class="string">&quot;spring_topic_queue3&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">rabbit:listener</span> <span class="attr">ref</span>=<span class="string">&quot;topicListener4&quot;</span> <span class="attr">queue-names</span>=<span class="string">&quot;spring_topic_queue4&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">rabbit:listener-container</span>&gt;</span></span><br></pre></td></tr></table></figure></div>

<h3 id="5-3-4-Header类型交换机"><a href="#5-3-4-Header类型交换机" class="headerlink" title="5.3.4 Header类型交换机"></a>5.3.4 Header类型交换机</h3><h4 id="5-3-4-1-生产者"><a href="#5-3-4-1-生产者" class="headerlink" title="5.3.4.1 生产者"></a>5.3.4.1 生产者</h4><p>在spring.xml中编写：</p>
<div class="highlight-container" data-rel="Xml"><figure class="iseeu highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">rabbit:queue</span> <span class="attr">id</span>=<span class="string">&quot;spring_header_queue&quot;</span> <span class="attr">name</span>=<span class="string">&quot;spring_header_queue&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- header模式,将队列绑定到交换机 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">rabbit:headers-exchange</span> <span class="attr">id</span>=<span class="string">&quot;spring_header_exchange&quot;</span> <span class="attr">name</span>=<span class="string">&quot;spring_header_exchange&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">rabbit:bindings</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">rabbit:binding</span> <span class="attr">queue</span>=<span class="string">&quot;spring_header_queue&quot;</span> <span class="attr">key</span>=<span class="string">&quot;key1&quot;</span> <span class="attr">value</span>=<span class="string">&quot;147&quot;</span>/&gt;</span></span><br><span class="line"><span class="comment">&lt;!--            &lt;rabbit:binding queue=&quot;spring_header_queue&quot; key=&quot;key2&quot; value=&quot;258&quot;/&gt;--&gt;</span></span><br><span class="line"><span class="comment">&lt;!--            &lt;rabbit:binding queue=&quot;spring_header_queue&quot; key=&quot;key3&quot; value=&quot;369&quot;/&gt;--&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">rabbit:bindings</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">rabbit:headers-exchange</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--定义rabbitTemplate对象操作可以在代码中方便发送消息--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">rabbit:template</span> <span class="attr">id</span>=<span class="string">&quot;rabbitTemplate&quot;</span> <span class="attr">connection-factory</span>=<span class="string">&quot;connectionFactory&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;rabbitMessagingTemplate&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.amqp.rabbit.core.RabbitMessagingTemplate&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;rabbitTemplate&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;rabbitTemplate&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure></div>

<p>发送消息：</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> RabbitMessagingTemplate rabbitMessagingTemplate;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * header模式</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">tesHeader</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 准备header参数</span></span><br><span class="line">    Map&lt;String, Object&gt; headers = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line"><span class="comment">//        headers.put(&quot;key1&quot;, &quot;147&quot;);</span></span><br><span class="line">    headers.put(<span class="string">&quot;key2&quot;</span>, <span class="string">&quot;258&quot;</span>);</span><br><span class="line"><span class="comment">//        headers.put(&quot;key3&quot;, &quot;369&quot;);</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 使用的是rabbitMessagingTemplate 而不是 rabbitTemplate</span></span><br><span class="line">    rabbitMessagingTemplate.convertAndSend(<span class="string">&quot;spring_header_exchange&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="string">&quot;boot header....&quot;</span>, headers);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>



<h4 id="5-3-4-2-消费者："><a href="#5-3-4-2-消费者：" class="headerlink" title="5.3.4.2 消费者："></a>5.3.4.2 消费者：</h4><p>编写spring_header_queue队列的监听器：</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.minge.rabbitmq;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.Message;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.MessageListener;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpringHeaderListener</span> <span class="keyword">implements</span> <span class="title class_">MessageListener</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onMessage</span><span class="params">(Message message)</span> &#123;</span><br><span class="line">        <span class="comment">//打印消息</span></span><br><span class="line">        System.out.println(<span class="string">&quot;header:&quot;</span> + <span class="keyword">new</span> <span class="title class_">String</span>(message.getBody()));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>



<p>在spring.xml中注册监听器：</p>
<div class="highlight-container" data-rel="Xml"><figure class="iseeu highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;headerListener&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.minge.rabbitmq.SpringHeaderListener&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 绑定到监听器容器 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">rabbit:listener-container</span> <span class="attr">connection-factory</span>=<span class="string">&quot;connectionFactory&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 引用监听器并指定监听的队列,监听多个队列以逗号分隔 --&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">rabbit:listener</span> <span class="attr">ref</span>=<span class="string">&quot;headerListener&quot;</span> <span class="attr">queue-names</span>=<span class="string">&quot;spring_header_queue&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">rabbit:listener-container</span>&gt;</span></span><br></pre></td></tr></table></figure></div>



<h1 id="六、SpringBoot整合RabbitMQ"><a href="#六、SpringBoot整合RabbitMQ" class="headerlink" title="六、SpringBoot整合RabbitMQ"></a>六、SpringBoot整合RabbitMQ</h1><h2 id="6-1-搭建消息生产者"><a href="#6-1-搭建消息生产者" class="headerlink" title="6.1 搭建消息生产者"></a>6.1 搭建消息生产者</h2><h3 id="6-1-1-pom-xml："><a href="#6-1-1-pom-xml：" class="headerlink" title="6.1.1 pom.xml："></a>6.1.1 pom.xml：</h3><div class="highlight-container" data-rel="Xml"><figure class="iseeu highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.minge<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>05_springboot_rabbitmq_producer<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">&lt;!-- springboot 工程--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.0.1.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- rabbitmq场景启动器 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-amqp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 测试环境场景启动器 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure></div>

<h3 id="6-1-2-application-yml："><a href="#6-1-2-application-yml：" class="headerlink" title="6.1.2 application.yml："></a>6.1.2 application.yml：</h3><div class="highlight-container" data-rel="Yml"><figure class="iseeu highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="number">192.168</span><span class="number">.40</span><span class="number">.139</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">5672</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">lscl</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">admin</span></span><br><span class="line">    <span class="attr">virtual-host:</span> <span class="string">/lscl</span></span><br></pre></td></tr></table></figure></div>

<h3 id="6-1-3-引导类："><a href="#6-1-3-引导类：" class="headerlink" title="6.1.3 引导类："></a>6.1.3 引导类：</h3><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.minge.rabbitmq;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ProducerApplication</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(ProducerApplication.class);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="6-1-4-配置消息队列："><a href="#6-1-4-配置消息队列：" class="headerlink" title="6.1.4 配置消息队列："></a>6.1.4 配置消息队列：</h3><h4 id="6-1-4-1-Work模式："><a href="#6-1-4-1-Work模式：" class="headerlink" title="6.1.4.1 Work模式："></a>6.1.4.1 Work模式：</h4><p>SpringBoot中提供有两种构建Queue的方式，一种是通过new Queue()的方式，另一种采用QueueBuilder构建器构建一个Queue；</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.minge.rabbitmq.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.Queue;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Config_01_Work</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 定义一个队列</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean(&quot;bootWorkQueue&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">bootWorkQueue</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">            第一种方式:</span></span><br><span class="line"><span class="comment">                durable():代表需要持久化</span></span><br><span class="line"><span class="comment">                exclusive(): 代表该队列独占(只允许有一个consumer监听)</span></span><br><span class="line"><span class="comment">                autoDelete(): 代表需要自动删除(没有consumer自动删除)</span></span><br><span class="line"><span class="comment">                withArgument(): 队列的其他参数</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line"><span class="comment">//        return QueueBuilder.durable(&quot;boot_work_queue&quot;).exclusive().autoDelete().withArgument(&quot;key&quot;, &quot;val&quot;).build();</span></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">            第二种方式:</span></span><br><span class="line"><span class="comment">                通过new Queue对象来创建队列</span></span><br><span class="line"><span class="comment">                参数1: 队列名称</span></span><br><span class="line"><span class="comment">                参数2: 是否持久化(默认:true)</span></span><br><span class="line"><span class="comment">                参数3: 是否独占(默认:false)</span></span><br><span class="line"><span class="comment">                参数4: 是否自动删除(默认:false)</span></span><br><span class="line"><span class="comment">                参数5: 队列的其他参数</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Queue</span>(<span class="string">&quot;boot_work_queue&quot;</span>, <span class="literal">true</span>, <span class="literal">false</span>, <span class="literal">false</span>,<span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h4 id="6-1-4-2-Pub-Sub模式："><a href="#6-1-4-2-Pub-Sub模式：" class="headerlink" title="6.1.4.2 Pub&#x2F;Sub模式："></a>6.1.4.2 Pub&#x2F;Sub模式：</h4><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.minge.rabbitmq.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.*;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Pub/Sub模式(交换机类型为Fanout)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Config_03_Fanout</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(&quot;bootFanoutQueue1&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">bootFanoutQueue1</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> QueueBuilder.durable(<span class="string">&quot;boot_fanout_queue1&quot;</span>).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(&quot;bootFanoutQueue2&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">bootFanoutQueue2</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> QueueBuilder.durable(<span class="string">&quot;boot_fanout_queue2&quot;</span>).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// fanout类型交换机</span></span><br><span class="line">    <span class="meta">@Bean(&quot;bootFanoutExchange&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Exchange <span class="title function_">bootFanoutExchange</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ExchangeBuilder.fanoutExchange(<span class="string">&quot;boot_fanout_exchange&quot;</span>).durable(<span class="literal">true</span>).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 交换机与队列进行绑定</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">bindFanout1</span><span class="params">()</span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">Queue</span> <span class="variable">bootFanoutQueue1</span> <span class="operator">=</span> bootFanoutQueue1();</span><br><span class="line">        <span class="type">Exchange</span> <span class="variable">bootFanoutExchange</span> <span class="operator">=</span> bootFanoutExchange();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// fanout类型交换机routing key为 &quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(bootFanoutQueue1).to(bootFanoutExchange).with(<span class="string">&quot;&quot;</span>).noargs();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 交换机与队列进行绑定</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">bindFanout2</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">Queue</span> <span class="variable">bootFanoutQueue2</span> <span class="operator">=</span> bootFanoutQueue2();</span><br><span class="line">        <span class="type">Exchange</span> <span class="variable">bootFanoutExchange</span> <span class="operator">=</span> bootFanoutExchange();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(bootFanoutQueue2).to(bootFanoutExchange).with(<span class="string">&quot;&quot;</span>).noargs();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h4 id="6-1-4-3-Routing模式："><a href="#6-1-4-3-Routing模式：" class="headerlink" title="6.1.4.3 Routing模式："></a>6.1.4.3 Routing模式：</h4><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.minge.rabbitmq.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.*;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * routing模式(交换机类型为Direct)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Config_02_Direct</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 准备两个队列boot_direct_queue1、boot_direct_queue2</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean(&quot;bootDirectQueue1&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">bootDirectQueue1</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> QueueBuilder.durable(<span class="string">&quot;boot_direct_queue1&quot;</span>).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(&quot;bootDirectQueue2&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">bootDirectQueue2</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> QueueBuilder.durable(<span class="string">&quot;boot_direct_queue2&quot;</span>).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// direct类型交换机</span></span><br><span class="line">    <span class="meta">@Bean(&quot;bootDirectExchange&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Exchange <span class="title function_">bootDirectExchange</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">            第一种方式: 通过ExchangeBuilder构建交换机</span></span><br><span class="line"><span class="comment">                durable: 是否持久化</span></span><br><span class="line"><span class="comment">                autoDelete: 是否自动删除</span></span><br><span class="line"><span class="comment">                withArgument: 交换机其他参数</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line"><span class="comment">//        return ExchangeBuilder.directExchange(&quot;boot_direct_exchange&quot;).durable(true).autoDelete().withArgument(&quot;key&quot;,&quot;val&quot;).build();</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">            第二种方式:</span></span><br><span class="line"><span class="comment">                参数1: 是否持久化(默认false)</span></span><br><span class="line"><span class="comment">                参数2: 是否自动删除(默认false)</span></span><br><span class="line"><span class="comment">                参数3: 其他参数</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DirectExchange</span>(<span class="string">&quot;boot_direct_exchange&quot;</span>,<span class="literal">true</span>,<span class="literal">false</span>,<span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 交换机与队列进行绑定</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">bindDirect1</span><span class="params">()</span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">Queue</span> <span class="variable">bootDirectQueue1</span> <span class="operator">=</span> bootDirectQueue1();</span><br><span class="line">        <span class="type">Exchange</span> <span class="variable">bootDirectExchange</span> <span class="operator">=</span> bootDirectExchange();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">            第一种方式:</span></span><br><span class="line"><span class="comment">                bind(Queue): 需要绑定的queue</span></span><br><span class="line"><span class="comment">                to(Exchange): 需要绑定到哪个交换机</span></span><br><span class="line"><span class="comment">                with(String): routing key</span></span><br><span class="line"><span class="comment">                noargs(): 进行构建</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line"><span class="comment">//        return BindingBuilder.bind(bootDirectQueue1).to(bootDirectExchange).with(&quot;article&quot;).noargs();</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">            第一种方式:</span></span><br><span class="line"><span class="comment">                参数1: 绑定的队列</span></span><br><span class="line"><span class="comment">                参数2: 绑定的类型 Binding.DestinationType.QUEUE: 绑定的类型为queue(交换机不仅可以绑定queue还可以绑定exchange)</span></span><br><span class="line"><span class="comment">                参数3: 哪个交换机需要绑定</span></span><br><span class="line"><span class="comment">                参数4: routing key</span></span><br><span class="line"><span class="comment">                参数5: 其他参数</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">         <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Binding</span>(<span class="string">&quot;boot_direct_queue1&quot;</span>, Binding.DestinationType.QUEUE,<span class="string">&quot;boot_direct_exchange&quot;</span>,<span class="string">&quot;red&quot;</span>,<span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 交换机与队列进行绑定</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">bindDirect2</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">Queue</span> <span class="variable">bootDirectQueue2</span> <span class="operator">=</span> bootDirectQueue2();</span><br><span class="line">        <span class="type">Exchange</span> <span class="variable">bootDirectExchange</span> <span class="operator">=</span> bootDirectExchange();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(bootDirectQueue2).to(bootDirectExchange).with(<span class="string">&quot;green&quot;</span>).noargs();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h4 id="6-1-4-4-Topics模式"><a href="#6-1-4-4-Topics模式" class="headerlink" title="6.1.4.4 Topics模式"></a>6.1.4.4 Topics模式</h4><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.minge.rabbitmq.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.*;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Topics模式(交换机类型为Topic)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Config_04_Topic</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(&quot;bootTopicQueue1&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">bootTopicQueue1</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> QueueBuilder.durable(<span class="string">&quot;boot_topic_queue1&quot;</span>).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(&quot;bootTopicQueue2&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">bootTopicQueue2</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> QueueBuilder.durable(<span class="string">&quot;boot_topic_queue2&quot;</span>).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// topic类型交换机</span></span><br><span class="line">    <span class="meta">@Bean(&quot;bootTopicExchange&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Exchange <span class="title function_">bootTopicExchange</span><span class="params">()</span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> ExchangeBuilder.topicExchange(<span class="string">&quot;boot_topic_exchange&quot;</span>).durable(<span class="literal">true</span>).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 交换机与队列进行绑定</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">bindTopic1</span><span class="params">()</span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">Queue</span> <span class="variable">bootTopicQueue1</span> <span class="operator">=</span> bootTopicQueue1();</span><br><span class="line">        <span class="type">Exchange</span> <span class="variable">bootTopicExchange</span> <span class="operator">=</span> bootTopicExchange();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(bootTopicQueue1).to(bootTopicExchange).with(<span class="string">&quot;red.#&quot;</span>).noargs();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 交换机与队列进行绑定</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">bindTopic2</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">Queue</span> <span class="variable">bootTopicQueue2</span> <span class="operator">=</span> bootTopicQueue2();</span><br><span class="line">        <span class="type">Exchange</span> <span class="variable">bootTopicExchange</span> <span class="operator">=</span> bootTopicExchange();</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(bootTopicQueue2).to(bootTopicExchange).with(<span class="string">&quot;green.*&quot;</span>).noargs();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="6-1-5-测试类："><a href="#6-1-5-测试类：" class="headerlink" title="6.1.5 测试类："></a>6.1.5 测试类：</h3><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.minge.rabbitmq;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"><span class="keyword">import</span> org.junit.runner.RunWith;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.core.RabbitTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.test.context.junit4.SpringRunner;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootTest(classes = ProducerApplication.class)</span></span><br><span class="line"><span class="meta">@RunWith(SpringRunner.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ProducerTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RabbitTemplate rabbitTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *  work 模式</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testWork</span><span class="params">()</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        rabbitTemplate.convertAndSend(<span class="string">&quot;boot_work_queue&quot;</span>,<span class="string">&quot;boot work...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Routing 模式(交换机类型为Direct)</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testDirect</span><span class="params">()</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        rabbitTemplate.convertAndSend(<span class="string">&quot;boot_direct_exchange&quot;</span>,<span class="string">&quot;red&quot;</span>,<span class="string">&quot;boot direct red...&quot;</span>);</span><br><span class="line">        rabbitTemplate.convertAndSend(<span class="string">&quot;boot_direct_exchange&quot;</span>,<span class="string">&quot;green&quot;</span>,<span class="string">&quot;boot direct green...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Pub/Sub 模式(交换机类型为Fanout)</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testFanout</span><span class="params">()</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        rabbitTemplate.convertAndSend(<span class="string">&quot;boot_fanout_exchange&quot;</span>,<span class="string">&quot;&quot;</span>,<span class="string">&quot;boot fanout....&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Topics模式(交换机类型为Topic)</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">tesTopic</span><span class="params">()</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        rabbitTemplate.convertAndSend(<span class="string">&quot;boot_topic_exchange&quot;</span>,<span class="string">&quot;red.xxx.xxx&quot;</span>,<span class="string">&quot;boot topic red.# ...&quot;</span>);</span><br><span class="line">        rabbitTemplate.convertAndSend(<span class="string">&quot;boot_topic_exchange&quot;</span>,<span class="string">&quot;green.xxx&quot;</span>,<span class="string">&quot;boot topic green.* ....&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>



<h2 id="6-2-搭建消息消费者"><a href="#6-2-搭建消息消费者" class="headerlink" title="6.2 搭建消息消费者"></a>6.2 搭建消息消费者</h2><h3 id="6-2-1-pom-xml："><a href="#6-2-1-pom-xml：" class="headerlink" title="6.2.1 pom.xml："></a>6.2.1 pom.xml：</h3><p>和生产者依赖一致</p>
<h3 id="6-2-2-application-yml："><a href="#6-2-2-application-yml：" class="headerlink" title="6.2.2 application.yml："></a>6.2.2 application.yml：</h3><p>和生产者一致</p>
<h3 id="6-2-3-引导类："><a href="#6-2-3-引导类：" class="headerlink" title="6.2.3 引导类："></a>6.2.3 引导类：</h3><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.minge.rabbitmq;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConsumerApplication</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(ConsumerApplication.class);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="6-2-4-监听器："><a href="#6-2-4-监听器：" class="headerlink" title="6.2.4 监听器："></a>6.2.4 监听器：</h3><h4 id="6-2-4-1-Work-监听："><a href="#6-2-4-1-Work-监听：" class="headerlink" title="6.2.4.1 Work 监听："></a>6.2.4.1 Work 监听：</h4><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.minge.rabbitmq.listener;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.Message;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.annotation.RabbitListener;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Listener_01_Work</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 监听boot_work_queue队列的消息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> message</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RabbitListener(queues = &quot;boot_work_queue&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">receive</span><span class="params">(Message message)</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;boot_work_queue: &quot;</span>+<span class="keyword">new</span> <span class="title class_">String</span>(message.getBody()));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h4 id="6-2-4-2-Direct-监听："><a href="#6-2-4-2-Direct-监听：" class="headerlink" title="6.2.4.2 Direct 监听："></a>6.2.4.2 Direct 监听：</h4><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.minge.rabbitmq.listener;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.Message;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.annotation.RabbitListener;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Listener_02_Direct</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RabbitListener(queues = &quot;boot_direct_queue1&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">boot_direct_queue1</span><span class="params">(Message message)</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;boot_direct_queue1: &quot;</span>+<span class="keyword">new</span> <span class="title class_">String</span>(message.getBody()));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RabbitListener(queues = &quot;boot_direct_queue2&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">boot_direct_queue2</span><span class="params">(Message message)</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;boot_direct_queue2: &quot;</span>+<span class="keyword">new</span> <span class="title class_">String</span>(message.getBody()));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h4 id="6-2-4-3-其他监听"><a href="#6-2-4-3-其他监听" class="headerlink" title="6.2.4.3 其他监听"></a>6.2.4.3 其他监听</h4><p>其他几个监听对象的代码都是一致的，只要把监听的队列名换了即可</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/rabbit1/69.png"
                     
                ></p>
<h2 id="6-3-配置Header类型"><a href="#6-3-配置Header类型" class="headerlink" title="6.3 配置Header类型"></a>6.3 配置Header类型</h2><h3 id="6-3-1-生产者"><a href="#6-3-1-生产者" class="headerlink" title="6.3.1 生产者"></a>6.3.1 生产者</h3><h4 id="6-3-1-1-声明交换机绑定Queue"><a href="#6-3-1-1-声明交换机绑定Queue" class="headerlink" title="6.3.1.1 声明交换机绑定Queue"></a>6.3.1.1 声明交换机绑定Queue</h4><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.minge.rabbitmq.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.*;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * header模式</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Config_05_Header</span> &#123;</span><br><span class="line">    <span class="comment">// 声明一个queue</span></span><br><span class="line">    <span class="meta">@Bean(&quot;bootHeaderQueue&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">bootHeaderQueue</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> QueueBuilder.durable(<span class="string">&quot;boot_header_queue&quot;</span>).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// header类型交换机</span></span><br><span class="line">    <span class="meta">@Bean(&quot;bootHeaderExchange&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Exchange <span class="title function_">bootHeaderExchange</span><span class="params">()</span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> ExchangeBuilder.headersExchange(<span class="string">&quot;boot_header_exchange&quot;</span>).durable(<span class="literal">true</span>).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将exchange和queue进行绑定</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">bindHeader</span><span class="params">()</span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">Queue</span> <span class="variable">queue</span> <span class="operator">=</span> bootHeaderQueue();</span><br><span class="line">        <span class="type">Exchange</span> <span class="variable">exchange</span> <span class="operator">=</span> bootHeaderExchange();</span><br><span class="line"></span><br><span class="line">        Map&lt;String, Object&gt; headers = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">            all:Producer必须匹配所有的键值对</span></span><br><span class="line"><span class="comment">            any:只要Producer匹配任意一个键值对即可</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">            headers.put(<span class="string">&quot;x-match&quot;</span>, <span class="string">&quot;any&quot;</span>);</span><br><span class="line">            headers.put(<span class="string">&quot;key1&quot;</span>, <span class="string">&quot;147&quot;</span>);</span><br><span class="line">            headers.put(<span class="string">&quot;key2&quot;</span>, <span class="string">&quot;258&quot;</span>);</span><br><span class="line">            headers.put(<span class="string">&quot;key3&quot;</span>, <span class="string">&quot;369&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// routing key 为空</span></span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(queue).to(exchange).with(<span class="string">&quot;&quot;</span>).and(headers);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h4 id="6-3-1-2-测试类："><a href="#6-3-1-2-测试类：" class="headerlink" title="6.3.1.2 测试类："></a>6.3.1.2 测试类：</h4><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> RabbitMessagingTemplate rabbitMessagingTemplate;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * header模式</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">tesHeader</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 准备header参数</span></span><br><span class="line">    Map&lt;String, Object&gt; headers = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    headers.put(<span class="string">&quot;key1&quot;</span>, <span class="string">&quot;147&quot;</span>);</span><br><span class="line">    headers.put(<span class="string">&quot;key2&quot;</span>, <span class="string">&quot;258&quot;</span>);</span><br><span class="line">    headers.put(<span class="string">&quot;key3&quot;</span>, <span class="string">&quot;369&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 使用的是rabbitMessagingTemplate 而不是 rabbitTemplate</span></span><br><span class="line">    rabbitMessagingTemplate.convertAndSend(<span class="string">&quot;boot_header_exchange&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="string">&quot;boot header....&quot;</span>, headers);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="6-3-2-消费者"><a href="#6-3-2-消费者" class="headerlink" title="6.3.2 消费者"></a>6.3.2 消费者</h3><h4 id="6-3-2-1-监听器"><a href="#6-3-2-1-监听器" class="headerlink" title="6.3.2.1 监听器"></a>6.3.2.1 监听器</h4><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.minge.rabbitmq.listener;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.Message;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.annotation.RabbitListener;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Listener_05_Header</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RabbitListener(queues = &quot;boot_header_queue&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">boot_topic_queue1</span><span class="params">(Message message)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;boot_header_queue: &quot;</span> + <span class="keyword">new</span> <span class="title class_">String</span>(message.getBody()));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h1 id="七、RabbitMQ高级特性"><a href="#七、RabbitMQ高级特性" class="headerlink" title="七、RabbitMQ高级特性"></a>七、RabbitMQ高级特性</h1><h2 id="7-1-消息确认机制"><a href="#7-1-消息确认机制" class="headerlink" title="7.1 消息确认机制"></a>7.1 消息确认机制</h2><p>我们知道MQ中存在Producer（生产者）和Consumer（消费者），正常情况下Producer发送的消息Consumer都能够接受的到，但是可能由于某种原因导致Producer发送的消息Consumer并没有接收到，那么此时对于消息投递的可靠性是我们需要保障的；在RabbitMQ中提供有四种模式来保障我们消息的可靠传递：<strong>确认模式、回退模式、事务处理模式、ACK确认机制</strong></p>
<h3 id="7-1-1-确认模式"><a href="#7-1-1-确认模式" class="headerlink" title="7.1.1 确认模式"></a>7.1.1 确认模式</h3><p>在确认模式中，当Producer发送消息之后，<strong>不管是否到达队列（交换机）</strong>都会触发Producer端的一个回调函数，在回调函数参数中能够判断此次消息是否发送成功，我们可以根据反馈的信息来做相应的处理；</p>
<p>搭建消息生产者；采用RabbitMQ整合Spring环境（参考前面工程）</p>
<h4 id="7-1-1-1-编写spring-xml配置文件："><a href="#7-1-1-1-编写spring-xml配置文件：" class="headerlink" title="7.1.1.1 编写spring.xml配置文件："></a>7.1.1.1 编写spring.xml配置文件：</h4><p><strong>开启确认模式</strong>：在connectionFactory中开启确认模式<code>publisher-confirms=&quot;true&quot;</code></p>
<div class="highlight-container" data-rel="Xml"><figure class="iseeu highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:context</span>=<span class="string">&quot;http://www.springframework.org/schema/context&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:rabbit</span>=<span class="string">&quot;http://www.springframework.org/schema/rabbit&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="string"><span class="tag">       http://www.springframework.org/schema/beans/spring-beans.xsd</span></span></span><br><span class="line"><span class="string"><span class="tag">       http://www.springframework.org/schema/context</span></span></span><br><span class="line"><span class="string"><span class="tag">       https://www.springframework.org/schema/context/spring-context.xsd</span></span></span><br><span class="line"><span class="string"><span class="tag">       http://www.springframework.org/schema/rabbit</span></span></span><br><span class="line"><span class="string"><span class="tag">       http://www.springframework.org/schema/rabbit/spring-rabbit.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--加载配置文件--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">context:property-placeholder</span> <span class="attr">location</span>=<span class="string">&quot;classpath:rabbitmq.properties&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">        定义rabbitmq connectionFactory</span></span><br><span class="line"><span class="comment">            publisher-confirms=&quot;true&quot;:  开启确认模式</span></span><br><span class="line"><span class="comment">    --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">rabbit:connection-factory</span> <span class="attr">id</span>=<span class="string">&quot;connectionFactory&quot;</span> <span class="attr">host</span>=<span class="string">&quot;$&#123;rabbitmq.host&#125;&quot;</span></span></span><br><span class="line"><span class="tag">                               <span class="attr">port</span>=<span class="string">&quot;$&#123;rabbitmq.port&#125;&quot;</span></span></span><br><span class="line"><span class="tag">                               <span class="attr">username</span>=<span class="string">&quot;$&#123;rabbitmq.username&#125;&quot;</span></span></span><br><span class="line"><span class="tag">                               <span class="attr">password</span>=<span class="string">&quot;$&#123;rabbitmq.password&#125;&quot;</span></span></span><br><span class="line"><span class="tag">                               <span class="attr">virtual-host</span>=<span class="string">&quot;$&#123;rabbitmq.virtual-host&#125;&quot;</span></span></span><br><span class="line"><span class="tag">                               <span class="attr">publisher-confirms</span>=<span class="string">&quot;true&quot;</span></span></span><br><span class="line"><span class="tag">    /&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--定义管理交换机、队列--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">rabbit:admin</span> <span class="attr">connection-factory</span>=<span class="string">&quot;connectionFactory&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--定义rabbitTemplate对象操作可以在代码中方便发送消息--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">rabbit:template</span> <span class="attr">id</span>=<span class="string">&quot;rabbitTemplate&quot;</span> <span class="attr">connection-factory</span>=<span class="string">&quot;connectionFactory&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--消息可靠性投递（生产端）--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">rabbit:queue</span> <span class="attr">id</span>=<span class="string">&quot;test_queue_confirm&quot;</span> <span class="attr">name</span>=<span class="string">&quot;test_queue_confirm&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">rabbit:queue</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">rabbit:direct-exchange</span> <span class="attr">name</span>=<span class="string">&quot;test_exchange_confirm&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">rabbit:bindings</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">rabbit:binding</span> <span class="attr">queue</span>=<span class="string">&quot;test_queue_confirm&quot;</span> <span class="attr">key</span>=<span class="string">&quot;confirm&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">rabbit:binding</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">rabbit:bindings</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">rabbit:direct-exchange</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure></div>

<h4 id="7-1-1-2-测试代码："><a href="#7-1-1-2-测试代码：" class="headerlink" title="7.1.1.2 测试代码："></a>7.1.1.2 测试代码：</h4><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.minge.rabbitmq;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"><span class="keyword">import</span> org.junit.runner.RunWith;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.Message;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.connection.CorrelationData;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.core.RabbitTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.test.context.ContextConfiguration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.test.context.junit4.SpringRunner;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RunWith(SpringRunner.class)</span></span><br><span class="line"><span class="meta">@ContextConfiguration(locations = &quot;classpath:spring.xml&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ProducerTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RabbitTemplate rabbitTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 确认模式：</span></span><br><span class="line"><span class="comment">     * 步骤：</span></span><br><span class="line"><span class="comment">     * 1. 确认模式开启：ConnectionFactory中开启publisher-confirms=&quot;true&quot;</span></span><br><span class="line"><span class="comment">     * 2. 在rabbitTemplate定义ConfirmCallBack回调函数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testConfirm</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//2. 定义回调</span></span><br><span class="line">        rabbitTemplate.setConfirmCallback(<span class="keyword">new</span> <span class="title class_">RabbitTemplate</span>.ConfirmCallback() &#123;</span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             *</span></span><br><span class="line"><span class="comment">             * <span class="doctag">@param</span> correlationData 相关配置信息</span></span><br><span class="line"><span class="comment">             * <span class="doctag">@param</span> ack   exchange交换机 是否成功收到了消息; true:成功 false:失败</span></span><br><span class="line"><span class="comment">             * <span class="doctag">@param</span> cause 失败原因</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">confirm</span><span class="params">(CorrelationData correlationData, <span class="type">boolean</span> ack, String cause)</span> &#123;</span><br><span class="line"></span><br><span class="line">                System.out.println(<span class="string">&quot;confirm方法被执行了....&quot;</span>);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (ack) &#123;</span><br><span class="line">                    <span class="comment">//接收成功</span></span><br><span class="line">                    System.out.println(<span class="string">&quot;接收成功消息&quot;</span> + cause);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">//接收失败</span></span><br><span class="line">                    System.out.println(<span class="string">&quot;接收失败消息&quot;</span> + cause);</span><br><span class="line">                    <span class="comment">//做一些处理，让消息再次发送。</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//3. 发送消息</span></span><br><span class="line">        rabbitTemplate.convertAndSend(<span class="string">&quot;test_exchange_confirm&quot;</span>, <span class="string">&quot;confirm&quot;</span>, <span class="string">&quot;message confirm....&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>当消息无法发送出去时，ack为false，消息正常发送时，ack为true</p>
<blockquote>
<p>&#x3D;&#x3D;<strong>需要注意一点：在上述案例中，消息是发送给<code>test_exchange_confirm</code>交换机的，如果消息不能发送给该交换机（例如名字写错）那么ack为false，如果能发送给交换机ack为true，即使消息没有路由到Queue上（例如Routing Key写错）</strong>&#x3D;&#x3D;</p>
</blockquote>
<h3 id="7-1-2-回退模式"><a href="#7-1-2-回退模式" class="headerlink" title="7.1.2 回退模式"></a>7.1.2 回退模式</h3><p>在回退模式中，当Producer发送消息之后，<strong>队列无法接受到消息时，触发回调函数</strong></p>
<h4 id="7-1-2-1-配置spring-xml"><a href="#7-1-2-1-配置spring-xml" class="headerlink" title="7.1.2.1 配置spring.xml"></a>7.1.2.1 配置spring.xml</h4><p>开启回退模式：在connectionFactory中开启确认模式<code>publisher-returns=&quot;true&quot;</code></p>
<div class="highlight-container" data-rel="Xml"><figure class="iseeu highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">    定义rabbitmq connectionFactory</span></span><br><span class="line"><span class="comment">        publisher-confirms=&quot;true&quot;:  开启确认模式</span></span><br><span class="line"><span class="comment">        publisher-returns=&quot;true&quot;:   开启回退模式</span></span><br><span class="line"><span class="comment">--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">rabbit:connection-factory</span> <span class="attr">id</span>=<span class="string">&quot;connectionFactory&quot;</span> <span class="attr">host</span>=<span class="string">&quot;$&#123;rabbitmq.host&#125;&quot;</span></span></span><br><span class="line"><span class="tag">                           <span class="attr">port</span>=<span class="string">&quot;$&#123;rabbitmq.port&#125;&quot;</span></span></span><br><span class="line"><span class="tag">                           <span class="attr">username</span>=<span class="string">&quot;$&#123;rabbitmq.username&#125;&quot;</span></span></span><br><span class="line"><span class="tag">                           <span class="attr">password</span>=<span class="string">&quot;$&#123;rabbitmq.password&#125;&quot;</span></span></span><br><span class="line"><span class="tag">                           <span class="attr">virtual-host</span>=<span class="string">&quot;$&#123;rabbitmq.virtual-host&#125;&quot;</span></span></span><br><span class="line"><span class="tag">                           <span class="attr">publisher-confirms</span>=<span class="string">&quot;true&quot;</span></span></span><br><span class="line"><span class="tag">                           <span class="attr">publisher-returns</span>=<span class="string">&quot;true&quot;</span></span></span><br><span class="line"><span class="tag">/&gt;</span></span><br></pre></td></tr></table></figure></div>

<h4 id="7-1-2-2-编写测试类："><a href="#7-1-2-2-编写测试类：" class="headerlink" title="7.1.2.2 编写测试类："></a>7.1.2.2 编写测试类：</h4><p>设置Exchange处理消息的模式：<code>rabbitTemplate.setMandatory(true);</code>，当消息没有路由到Queue，则触发回调函数</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 回退模式： 当消息发送给Exchange后，Exchange路由到Queue失败时 才会执行 ReturnCallBack</span></span><br><span class="line"><span class="comment"> * 步骤：</span></span><br><span class="line"><span class="comment"> * 1. 开启回退模式:publisher-returns=&quot;true&quot;</span></span><br><span class="line"><span class="comment"> * 2. 设置ReturnCallBack</span></span><br><span class="line"><span class="comment"> * 3. 设置Exchange处理消息的模式：</span></span><br><span class="line"><span class="comment"> *      1. 如果消息没有路由到Queue，则丢弃消息（默认）</span></span><br><span class="line"><span class="comment"> *      2. 如果消息没有路由到Queue，返回给消息发送方ReturnCallBack</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testReturn</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 开启强制回退</span></span><br><span class="line">    rabbitTemplate.setMandatory(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2.设置ReturnCallBack</span></span><br><span class="line">    rabbitTemplate.setReturnCallback(<span class="keyword">new</span> <span class="title class_">RabbitTemplate</span>.ReturnCallback() &#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> message   消息对象</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> replyCode 错误码</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> replyText 错误信息</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> exchange  交换机</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> routingKey 路由键</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">returnedMessage</span><span class="params">(Message message, <span class="type">int</span> replyCode, String replyText, String exchange, String routingKey)</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;return 执行了....&quot;</span>);</span><br><span class="line"></span><br><span class="line">            System.out.println(<span class="string">&quot;message: &quot;</span> + message);</span><br><span class="line">            System.out.println(<span class="string">&quot;replyCode: &quot;</span> + replyCode);</span><br><span class="line">            System.out.println(<span class="string">&quot;replyText: &quot;</span> + replyText);</span><br><span class="line">            System.out.println(<span class="string">&quot;exchange: &quot;</span> + exchange);</span><br><span class="line">            System.out.println(<span class="string">&quot;routingKey: &quot;</span> + routingKey);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//处理</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//3. 发送消息</span></span><br><span class="line">    rabbitTemplate.convertAndSend(<span class="string">&quot;test_exchange_confirm&quot;</span>, <span class="string">&quot;confirm&quot;</span>, <span class="string">&quot;message confirm....&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<blockquote>
<p>&#x3D;&#x3D;<strong>在上述案例中，消息没有路由到Queue上则触发回调，如果消息连交换机都没有到，那么则不会触发回调</strong>&#x3D;&#x3D;</p>
</blockquote>
<h3 id="7-1-3-事务处理模式"><a href="#7-1-3-事务处理模式" class="headerlink" title="7.1.3 事务处理模式"></a>7.1.3 事务处理模式</h3><p>RabbitMQ提供有事务处理机制，在一个事务中，多条消息要么全部发送成功，要么全部发送失败</p>
<p>编写spring.xml配置文件：</p>
<p>在spring配置文件中配置事务管理器</p>
<div class="highlight-container" data-rel="Xml"><figure class="iseeu highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--平台事务管理器--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;transactionManager&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.amqp.rabbit.transaction.RabbitTransactionManager&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;connectionFactory&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;connectionFactory&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure></div>

<blockquote>
<p>注意：&#x3D;&#x3D;<strong>事务模式不能与confirms、returns并存,需要去spring配置文件中删除publisher-confirms&#x3D;”true”和publisher-returns&#x3D;”true”配置</strong>&#x3D;&#x3D;</p>
</blockquote>
<h4 id="7-1-3-1-测试代码："><a href="#7-1-3-1-测试代码：" class="headerlink" title="7.1.3.1 测试代码："></a>7.1.3.1 测试代码：</h4><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * rabbitmq事务处理模式</span></span><br><span class="line"><span class="comment"> *      事务模式不能与confirms、returns并存,需要去spring配置文件中删除publisher-confirms=&quot;true&quot;和publisher-returns=&quot;true&quot;配置</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="meta">@Rollback(false)</span>        <span class="comment">// 是否自动回滚(false:代表不是自动回滚),如果关闭了出现异常也不会回滚(测试异常的时候改为true)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testTx</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 开启rabbitmq对事物的支持</span></span><br><span class="line">    rabbitTemplate.setChannelTransacted(<span class="literal">true</span>);</span><br><span class="line">	</span><br><span class="line">    <span class="comment">// 开启强制回退</span></span><br><span class="line">    rabbitTemplate.setMandatory(<span class="literal">true</span>);</span><br><span class="line">    <span class="comment">// 3. 发送消息</span></span><br><span class="line">    rabbitTemplate.convertAndSend(<span class="string">&quot;test_exchange_confirm&quot;</span>, <span class="string">&quot;confirm&quot;</span>, <span class="string">&quot;message confirm1...&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span> / <span class="number">0</span>;          <span class="comment">// 模拟异常</span></span><br><span class="line"></span><br><span class="line">    rabbitTemplate.convertAndSend(<span class="string">&quot;test_exchange_confirm&quot;</span>, <span class="string">&quot;confirm&quot;</span>, <span class="string">&quot;message confirm2...&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="7-1-4-Consumer-Ack"><a href="#7-1-4-Consumer-Ack" class="headerlink" title="7.1.4 Consumer Ack"></a>7.1.4 Consumer Ack</h3><p>当Consumer端接受到一个消息进行消费时，如果消费失败了我们希望此次消息就应该定义为”消费失败”，也就是这条消息我们希望拒绝签收，Consumer的Ack机制可以根据Consumer的消费情况来决定此次消息时签收还是拒绝签收；</p>
<p>RabbitMQ中提供有3种消息签收方式：</p>
<ul>
<li><p>1）none：自动签收（消息被消费就自动签收）</p>
</li>
<li><p>2）manual：手动签收（需要调用<code>basicNack</code>或<code>basicReject</code>方法手动签收）</p>
</li>
<li><p>3）auto：由rabbitmq来决定是否签收（根据异常进行处理）</p>
</li>
</ul>
<p>搭建消息消费者；采用RabbitMQ整合Spring环境（参考前面工程）</p>
<h4 id="7-1-4-1-spring-xml配置："><a href="#7-1-4-1-spring-xml配置：" class="headerlink" title="7.1.4.1 spring.xml配置："></a>7.1.4.1 spring.xml配置：</h4><div class="highlight-container" data-rel="Xml"><figure class="iseeu highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:context</span>=<span class="string">&quot;http://www.springframework.org/schema/context&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:rabbit</span>=<span class="string">&quot;http://www.springframework.org/schema/rabbit&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="string"><span class="tag">       http://www.springframework.org/schema/beans/spring-beans.xsd</span></span></span><br><span class="line"><span class="string"><span class="tag">       http://www.springframework.org/schema/context</span></span></span><br><span class="line"><span class="string"><span class="tag">       https://www.springframework.org/schema/context/spring-context.xsd</span></span></span><br><span class="line"><span class="string"><span class="tag">       http://www.springframework.org/schema/rabbit</span></span></span><br><span class="line"><span class="string"><span class="tag">       http://www.springframework.org/schema/rabbit/spring-rabbit.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--加载配置文件--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">context:property-placeholder</span> <span class="attr">location</span>=<span class="string">&quot;classpath:rabbitmq.properties&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 扫描包 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">&quot;com.lscl&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 定义rabbitmq connectionFactory --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">rabbit:connection-factory</span> <span class="attr">id</span>=<span class="string">&quot;connectionFactory&quot;</span> <span class="attr">host</span>=<span class="string">&quot;$&#123;rabbitmq.host&#125;&quot;</span></span></span><br><span class="line"><span class="tag">                               <span class="attr">port</span>=<span class="string">&quot;$&#123;rabbitmq.port&#125;&quot;</span></span></span><br><span class="line"><span class="tag">                               <span class="attr">username</span>=<span class="string">&quot;$&#123;rabbitmq.username&#125;&quot;</span></span></span><br><span class="line"><span class="tag">                               <span class="attr">password</span>=<span class="string">&quot;$&#123;rabbitmq.password&#125;&quot;</span></span></span><br><span class="line"><span class="tag">                               <span class="attr">virtual-host</span>=<span class="string">&quot;$&#123;rabbitmq.virtual-host&#125;&quot;</span></span></span><br><span class="line"><span class="tag">    /&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--定义管理交换机、队列--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">rabbit:admin</span> <span class="attr">connection-factory</span>=<span class="string">&quot;connectionFactory&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--定义rabbitTemplate对象操作可以在代码中方便发送消息--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">rabbit:template</span> <span class="attr">id</span>=<span class="string">&quot;rabbitTemplate&quot;</span> <span class="attr">connection-factory</span>=<span class="string">&quot;connectionFactory&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">        定义监听器容器</span></span><br><span class="line"><span class="comment">        &lt;rabbit:listener-container connection-factory=&quot;connectionFactory&quot; acknowledge=&quot;manual&quot;&gt;</span></span><br><span class="line"><span class="comment">            acknowledge:消息签收方式</span></span><br><span class="line"><span class="comment">                none:   自动签收(消息被消费就自动签收)</span></span><br><span class="line"><span class="comment">                manual: 手动签收(需要调用basicNack或 basicReject方法手动签收)</span></span><br><span class="line"><span class="comment">                auto:   由rabbitmq来决定是否签收(根据异常进行处理)</span></span><br><span class="line"><span class="comment">    --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">rabbit:listener-container</span> <span class="attr">connection-factory</span>=<span class="string">&quot;connectionFactory&quot;</span> <span class="attr">acknowledge</span>=<span class="string">&quot;manual&quot;</span> &gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">rabbit:listener</span> <span class="attr">ref</span>=<span class="string">&quot;ackListener&quot;</span> <span class="attr">queue-names</span>=<span class="string">&quot;test_queue_confirm&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">rabbit:listener</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">rabbit:listener-container</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure></div>

<h4 id="7-1-4-2-监听器："><a href="#7-1-4-2-监听器：" class="headerlink" title="7.1.4.2 监听器："></a>7.1.4.2 监听器：</h4><p>我们之前实现的是<code>MessageListener</code>，该接口的抽象方法只有一个Message参数，我们待会拒绝签收消息需要借助channel对象，因此我们实现<code>ChannelAwareMessageListener</code>接口</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.minge.rabbitmq.listener;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.Message;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.listener.api.ChannelAwareMessageListener;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 实现ChannelAwareMessageListener接口</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AckListener</span> <span class="keyword">implements</span> <span class="title class_">ChannelAwareMessageListener</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onMessage</span><span class="params">(Message message, Channel channel)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 接受消息的标签</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">deliveryTag</span> <span class="operator">=</span> message.getMessageProperties().getDeliveryTag();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//1.接收转换消息</span></span><br><span class="line">            System.out.println(<span class="keyword">new</span> <span class="title class_">String</span>(message.getBody()));</span><br><span class="line"></span><br><span class="line">            <span class="comment">//2. 处理业务逻辑</span></span><br><span class="line">            System.out.println(<span class="string">&quot;处理业务逻辑...&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">3</span> / <span class="number">0</span>;<span class="comment">//出现错误</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">//3. 手动签收</span></span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">                参数1：接受消息的标签</span></span><br><span class="line"><span class="comment">                参数2：允许多条消息同时被处理</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            channel.basicAck(deliveryTag, <span class="literal">true</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="comment">//e.printStackTrace();</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">//4.拒绝签收</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">                参数1：接受消息的标签</span></span><br><span class="line"><span class="comment">                参数2：允许多条消息同时被处理</span></span><br><span class="line"><span class="comment">                参数3：重回队列,如果设置为true，则消息重新回到queue，broker会重新发送该消息给消费端</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            channel.basicNack(deliveryTag, <span class="literal">true</span>, <span class="literal">true</span>);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 也可以拒绝签收 参数二: 是否重回队列</span></span><br><span class="line"><span class="comment">//            channel.basicReject(deliveryTag, true);</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h2 id="7-2-TTL队列"><a href="#7-2-TTL队列" class="headerlink" title="7.2 TTL队列"></a>7.2 TTL队列</h2><p>TTL：全称Time To Live，表示过期时间、存活时间，TTL队列顾名思义就是带有存活时间的队列，在RabbitMQ中，可以对<strong>队列</strong>或者<strong>消息</strong>设置过期时间；设置了TTL的Queue中的消息到达TTL时间之前没有被消费将自动删除；在发布消息的时候也可以针对这条消息设置TTL，<strong>当队列和消息都设置了TTL时，以时间短的为准；</strong></p>
<h3 id="7-2-1-给队列设置TTL"><a href="#7-2-1-给队列设置TTL" class="headerlink" title="7.2.1 给队列设置TTL"></a>7.2.1 给队列设置TTL</h3><p>配置spring.xml：</p>
<div class="highlight-container" data-rel="Xml"><figure class="iseeu highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--声明一个队列--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">rabbit:queue</span> <span class="attr">name</span>=<span class="string">&quot;test_queue_ttl&quot;</span> <span class="attr">id</span>=<span class="string">&quot;test_queue_ttl&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--设置queue的参数--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">rabbit:queue-arguments</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--x-message-ttl指队列的过期时间 单位:毫秒--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">&quot;x-message-ttl&quot;</span> <span class="attr">value</span>=<span class="string">&quot;2000&quot;</span> <span class="attr">value-type</span>=<span class="string">&quot;java.lang.Integer&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">entry</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">rabbit:queue-arguments</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">rabbit:queue</span>&gt;</span></span><br></pre></td></tr></table></figure></div>

<p>测试代码：</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * TTL:过期时间</span></span><br><span class="line"><span class="comment"> * 		队列统一过期(在创建队列时统一设置过期时间,队列中的消息到达此时间没有被消费自动过期)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testTtl</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">    rabbitTemplate.convertAndSend(<span class="string">&quot;test_queue_ttl&quot;</span>,<span class="string">&quot;ttl....&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/rabbit2/68.png"
                     
                ></p>
<blockquote>
<p><strong>发现当消息在队列中2秒中没有被消费将自动清除；</strong></p>
</blockquote>
<h3 id="7-2-2-给消息设置TTL"><a href="#7-2-2-给消息设置TTL" class="headerlink" title="7.2.2 给消息设置TTL"></a>7.2.2 给消息设置TTL</h3><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * TTL:过期时间</span></span><br><span class="line"><span class="comment"> * 2. 消息单独过期</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * 如果设置了消息的过期时间，也设置了队列的过期时间，它以时间短的为准。</span></span><br><span class="line"><span class="comment"> * 队列过期后，会将队列所有消息全部移除。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testTtl2</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 消息配置类</span></span><br><span class="line">    <span class="type">MessageProperties</span> <span class="variable">messageProperties</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MessageProperties</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//设置消息的过期时间: 2秒</span></span><br><span class="line">    messageProperties.setExpiration(<span class="string">&quot;2000&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 封装一条消息</span></span><br><span class="line">    <span class="type">Message</span> <span class="variable">message</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Message</span>(<span class="string">&quot;ttl....&quot;</span>.getBytes(), messageProperties);</span><br><span class="line"></span><br><span class="line">    rabbitTemplate.convertAndSend(<span class="string">&quot;test_queue_ttl&quot;</span>, message);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<blockquote>
<p>在使用TTL队列时注意以下几点：</p>
<ul>
<li><p>1、&#x3D;&#x3D;当队列和消息都设置了TTL以时间短的为准&#x3D;&#x3D;</p>
</li>
<li><p>2、&#x3D;&#x3D;<strong>消息到达过期时间后，只有消息在队列顶端才会被移除掉，而消息只有在要消费的时候才会在队列顶端；</strong>&#x3D;&#x3D;</p>
</li>
</ul>
</blockquote>
<h3 id="7-2-3-RabbitMQ是如何判断消息过期的？"><a href="#7-2-3-RabbitMQ是如何判断消息过期的？" class="headerlink" title="7.2.3 RabbitMQ是如何判断消息过期的？"></a>7.2.3 RabbitMQ是如何判断消息过期的？</h3><p>我们知道一个队列里面是可以存储非常多的消息的，这些消息中有的设置了TTL，有的则没有，那RabbitMQ是如何判断哪些消息是过期了的并且删除该消息的呢？最简单的方法就是轮询了，周期性轮询抽查队列中的所有消息，发现过期了的就进行删除，很显然，这种方法效率太低，RabbitMQ并没有采用这种策略，那RabbitMQ内部是如何进行过期消息的删除呢？</p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/rabbit2/67.png"
                      style="zoom:67%;" 
                >

<p>我们都知道Queue是一个队列，队列是先进先出的，即先到达队列的消息最先消费，假设上图的Message-02消息设置了TTL，并且时间已经到达，<strong>但是由于Message-02并不是在队列顶端，因此还会存在队列中</strong>；</p>
<p>我们做个小测试：（此时队列没有设置过期时间）</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testTtl2</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt;= <span class="number">4</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (i == <span class="number">2</span>) &#123;</span><br><span class="line">            <span class="comment">// i等于2的时候发送一条带有过期时间的消息</span></span><br><span class="line">            <span class="type">Message</span> <span class="variable">message</span> <span class="operator">=</span> MessageBuilder.withBody(<span class="string">&quot;ttl...&quot;</span>.getBytes()).setExpiration(<span class="string">&quot;3000&quot;</span>).build();</span><br><span class="line">            rabbitTemplate.convertAndSend(<span class="string">&quot;test_queue_ttl&quot;</span>,message);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            rabbitTemplate.convertAndSend(<span class="string">&quot;test_queue_ttl&quot;</span>, <span class="string">&quot;no ttl...&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><strong>发现等了很久之后Queue中的消息依旧是4条</strong></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/rabbit2/66.png"
                     
                ></p>
<h3 id="7-2-4-TTL队列小结"><a href="#7-2-4-TTL队列小结" class="headerlink" title="7.2.4 TTL队列小结"></a>7.2.4 TTL队列小结</h3><ul>
<li>1）<code>TTL</code>：全称<code>Time To Live</code>，表示设置了过期时间的队列</li>
<li>2）在<code>RabbitMQ</code>中给除了可以给队列设置过期时间还可以给单独的消息设置过期时间；<ul>
<li>给<code>Queue</code>设置TTL：设置<code>x-message-ttl</code>参数，单位：毫秒</li>
<li>给<code>Message</code>设置TTL：通过<code>MessageProperties</code>对象或者<code>MessageBuilder</code>对象构建消息</li>
</ul>
<p>	 	</p>
</li>
<li>3）当<code>Queue</code>和<code>Message</code>都设置了过期时间时以时间短的为准</li>
<li>4）&#x3D;&#x3D;<strong>消息到达过期时间并不会立即移除队列，而是要等消息到达<code>Queue</code>顶部<code>RabbitMQ</code>才会移除</strong>&#x3D;&#x3D;</li>
<li>5）<code>Message</code>到达了过期时间就不会被再次消费了，即使<code>Message</code>还未到达<code>Queue</code>的顶端；</li>
</ul>
<h2 id="7-3-死信队列"><a href="#7-3-死信队列" class="headerlink" title="7.3 死信队列"></a>7.3 死信队列</h2><h3 id="7-3-1-简介"><a href="#7-3-1-简介" class="headerlink" title="7.3.1 简介"></a>7.3.1 简介</h3><p>死信：<code>Dead Letter</code>，缩写DL；当一条正常的消息变成为”死信”时，会被RabbitMQ进行特殊处理，如果配置了死信队列信息，那么该消息将会被丢进死信队列中，如果没有配置，则该消息将会被丢弃。</p>
<p>消息什么情况下会变为死信？</p>
<ul>
<li>1）当使用 <code>channel.basicNack</code> 或 <code>channel.basicReject</code> 拒绝签收消息，并且此时<code>requeue</code> 属性被设置为<code>false</code>时；</li>
<li>2）当消息设置了TTL，并且已经到达时间时；</li>
<li>3）消息队列中的消息数量已经到达上限时，其余的消息将成为死信；</li>
</ul>
<p>当消息成为死信时，我们将其转发到一个专门处理死信的交换机上，这个交换机也称为<strong>死信交换机</strong>DLX（Dead Letter Exchange），死信被死信交换机重新转发到死信队列中，供消费者进行消费；</p>
<h4 id="7-3-1-1-死信队列工作流程图："><a href="#7-3-1-1-死信队列工作流程图：" class="headerlink" title="7.3.1.1 死信队列工作流程图："></a>7.3.1.1 死信队列工作流程图：</h4><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/rabbit2/65.png"
                      style="zoom:67%;" 
                >

<h3 id="7-3-2-案例测试"><a href="#7-3-2-案例测试" class="headerlink" title="7.3.2 案例测试"></a>7.3.2 案例测试</h3><p>根据上述图我们应该配置业务交换机、死信交换机、业务队列、死信队列；</p>
<h4 id="7-3-2-1-配置spring-xml："><a href="#7-3-2-1-配置spring-xml：" class="headerlink" title="7.3.2.1 配置spring.xml："></a>7.3.2.1 配置spring.xml：</h4><div class="highlight-container" data-rel="Xml"><figure class="iseeu highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">   死信队列：</span></span><br><span class="line"><span class="comment">       1. 声明正常的队列(test_queue_dlx)和交换机(test_exchange_dlx)</span></span><br><span class="line"><span class="comment">       2. 声明死信队列(queue_dlx)和死信交换机(exchange_dlx)</span></span><br><span class="line"><span class="comment">       3. 正常队列绑定死信交换机</span></span><br><span class="line"><span class="comment">           设置两个参数：</span></span><br><span class="line"><span class="comment">               * x-dead-letter-exchange：死信交换机名称</span></span><br><span class="line"><span class="comment">               * x-dead-letter-routing-key：发送给死信交换机的routingkey</span></span><br><span class="line"><span class="comment">--&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 1. 声明正常的队列(test_queue_dlx)和交换机(test_exchange_dlx) --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">rabbit:queue</span> <span class="attr">name</span>=<span class="string">&quot;test_queue_dlx&quot;</span> <span class="attr">id</span>=<span class="string">&quot;test_queue_dlx&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--3. 正常队列绑定死信交换机--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">rabbit:queue-arguments</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--3.1 x-dead-letter-exchange：死信交换机名称--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">&quot;x-dead-letter-exchange&quot;</span> <span class="attr">value</span>=<span class="string">&quot;exchange_dlx&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!--3.2 x-dead-letter-routing-key：发送给死信交换机的routingKey--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">&quot;x-dead-letter-routing-key&quot;</span> <span class="attr">value</span>=<span class="string">&quot;dlx.abc&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!--4.1 设置队列的过期时间 ttl--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">&quot;x-message-ttl&quot;</span> <span class="attr">value</span>=<span class="string">&quot;3000&quot;</span> <span class="attr">value-type</span>=<span class="string">&quot;java.lang.Integer&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!--4.2 设置队列的长度限制 max-length --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">&quot;x-max-length&quot;</span> <span class="attr">value</span>=<span class="string">&quot;10&quot;</span> <span class="attr">value-type</span>=<span class="string">&quot;java.lang.Integer&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">rabbit:queue-arguments</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">rabbit:queue</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 正常的交换机 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">rabbit:direct-exchange</span> <span class="attr">name</span>=<span class="string">&quot;test_exchange_dlx&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">rabbit:bindings</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">rabbit:binding</span> <span class="attr">queue</span>=<span class="string">&quot;test_queue_dlx&quot;</span> <span class="attr">key</span>=<span class="string">&quot;test_dlx&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">rabbit:binding</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">rabbit:bindings</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">rabbit:direct-exchange</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 2. 声明死信队列(queue_dlx)和死信交换机(exchange_dlx) --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">rabbit:queue</span> <span class="attr">name</span>=<span class="string">&quot;queue_dlx&quot;</span> <span class="attr">id</span>=<span class="string">&quot;queue_dlx&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">rabbit:queue</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 死信交换机 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">rabbit:topic-exchange</span> <span class="attr">name</span>=<span class="string">&quot;exchange_dlx&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">rabbit:bindings</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">rabbit:binding</span> <span class="attr">queue</span>=<span class="string">&quot;queue_dlx&quot;</span> <span class="attr">pattern</span>=<span class="string">&quot;dlx.*&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">rabbit:binding</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">rabbit:bindings</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">rabbit:topic-exchange</span>&gt;</span></span><br></pre></td></tr></table></figure></div>

<h4 id="7-3-2-2-测试代码："><a href="#7-3-2-2-测试代码：" class="headerlink" title="7.3.2.2 测试代码："></a>7.3.2.2 测试代码：</h4><p>生产者：</p>
<p>分别测试过期时间到期、长度超限、消息拒收，查看消息是否变化为死信；</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 发送测试死信消息：</span></span><br><span class="line"><span class="comment"> * 1. 过期时间</span></span><br><span class="line"><span class="comment"> * 2. 长度限制</span></span><br><span class="line"><span class="comment"> * 3. 消息拒收</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testDlx</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">//1. 测试过期时间，死信消息</span></span><br><span class="line"><span class="comment">//        rabbitTemplate.convertAndSend(&quot;test_exchange_dlx&quot;,&quot;test_dlx&quot;,&quot;dlx.....&quot;);</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//2. 测试长度限制后，消息死信</span></span><br><span class="line">   <span class="comment">/* for (int i = 0; i &lt; 20; i++) &#123;</span></span><br><span class="line"><span class="comment">        rabbitTemplate.convertAndSend(&quot;test_exchange_dlx&quot;,&quot;test_dlx&quot;,&quot;dlx.....&quot;+i);</span></span><br><span class="line"><span class="comment">    &#125;*/</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//3. 测试消息拒收</span></span><br><span class="line">    rabbitTemplate.convertAndSend(<span class="string">&quot;test_exchange_dlx&quot;</span>, <span class="string">&quot;test_dlx&quot;</span>, <span class="string">&quot;dlx...&quot;</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>消费者拒收：</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.minge.rabbitmq.listener;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.Message;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.listener.api.ChannelAwareMessageListener;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DlxListener</span> <span class="keyword">implements</span> <span class="title class_">ChannelAwareMessageListener</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onMessage</span><span class="params">(Message message, Channel channel)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">deliveryTag</span> <span class="operator">=</span> message.getMessageProperties().getDeliveryTag();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//1.接收转换消息</span></span><br><span class="line">            System.out.println(<span class="keyword">new</span> <span class="title class_">String</span>(message.getBody()));</span><br><span class="line"></span><br><span class="line">            <span class="comment">//2. 处理业务逻辑</span></span><br><span class="line">            System.out.println(<span class="string">&quot;处理业务逻辑...&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">3</span>/<span class="number">0</span>;<span class="comment">//出现错误</span></span><br><span class="line">            <span class="comment">//3. 手动签收</span></span><br><span class="line">            channel.basicAck(deliveryTag,<span class="literal">true</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="comment">//e.printStackTrace();</span></span><br><span class="line">            System.out.println(<span class="string">&quot;出现异常，拒绝接受&quot;</span>);</span><br><span class="line">            <span class="comment">//4.拒绝签收，不重回队列 requeue=false</span></span><br><span class="line">            channel.basicNack(deliveryTag,<span class="literal">true</span>,<span class="literal">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>注册监听：</p>
<div class="highlight-container" data-rel="Xml"><figure class="iseeu highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">rabbit:listener-container</span> <span class="attr">connection-factory</span>=<span class="string">&quot;connectionFactory&quot;</span> &gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">rabbit:listener</span> <span class="attr">ref</span>=<span class="string">&quot;dlxListener&quot;</span> <span class="attr">queue-names</span>=<span class="string">&quot;test_queue_dlx&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">rabbit:listener</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">rabbit:listener-container</span>&gt;</span></span><br></pre></td></tr></table></figure></div>

<h2 id="7-4-延时队列"><a href="#7-4-延时队列" class="headerlink" title="7.4 延时队列"></a>7.4 延时队列</h2><h3 id="7-4-1-简介"><a href="#7-4-1-简介" class="headerlink" title="7.4.1 简介"></a>7.4.1 简介</h3><p>有时候我们希望消息到达之后不会被立即消费，而是等到指定的时间进行消费，这个时候我们就可以利用延时队列来完成我们的功能</p>
<p>延时队列的应用场景：</p>
<ul>
<li><p>1）下一个订单，如果10分钟后还未支付，那么修改其订单状态</p>
</li>
<li><p>2）当用户3天未登录，进行登录提醒、礼包赠送等</p>
</li>
<li><p>3）开启一个会议后，会议达到开始时间时自动更改状态</p>
</li>
</ul>
<blockquote>
<p>在RabbitMQ中，我们可以借助<strong>TTL+死信队列</strong>来完成延时队列的效果</p>
</blockquote>
<p>延时队列很大程度上解决了我们以前定时器的功能，定时器通常采用每秒、每分钟轮询方式进行，这样不仅效率低，对数据库压力也非常大，代码不够严谨美观；</p>
<h4 id="7-4-1-1-延时队列工作流程图："><a href="#7-4-1-1-延时队列工作流程图：" class="headerlink" title="7.4.1.1 延时队列工作流程图："></a>7.4.1.1 延时队列工作流程图：</h4><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/rabbit2/64.png"
                      style="zoom: 80%;" 
                >

<p>当一个Producer发送出一个消息之后，设置过期时间并推送到指定的业务队列中（或业务交换机），超过指定的时间不消费，该消息自动成为死信，并交由死信交换机分发给死信队列，消费者只要监听死信队列中的消息即可；</p>
<blockquote>
<p><strong>上述案例中Producer直接将消息发送给Queue，也可以发送给业务交换机，然后由业务交换机转发给Queue</strong></p>
</blockquote>
<h3 id="7-4-2-案例测试"><a href="#7-4-2-案例测试" class="headerlink" title="7.4.2 案例测试"></a>7.4.2 案例测试</h3><h4 id="7-4-2-1-配置spring-xml："><a href="#7-4-2-1-配置spring-xml：" class="headerlink" title="7.4.2.1 配置spring.xml："></a>7.4.2.1 配置spring.xml：</h4><div class="highlight-container" data-rel="Xml"><figure class="iseeu highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--配置业务队列--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">rabbit:queue</span> <span class="attr">name</span>=<span class="string">&quot;test_queue_dlx2&quot;</span> <span class="attr">id</span>=<span class="string">&quot;test_queue_dlx2&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">rabbit:queue-arguments</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--3.1 x-dead-letter-exchange：死信交换机名称--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">&quot;x-dead-letter-exchange&quot;</span> <span class="attr">value</span>=<span class="string">&quot;exchange_dlx&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!--3.2 x-dead-letter-routing-key：发送给死信交换机的routingKey--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">&quot;x-dead-letter-routing-key&quot;</span> <span class="attr">value</span>=<span class="string">&quot;dlx.abc&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">rabbit:queue-arguments</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">rabbit:queue</span>&gt;</span></span><br></pre></td></tr></table></figure></div>

<h4 id="7-4-2-2-测试类："><a href="#7-4-2-2-测试类：" class="headerlink" title="7.4.2.2 测试类："></a>7.4.2.2 测试类：</h4><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 延迟队列</span></span><br><span class="line"><span class="comment"> * TTL+死信队列</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testDelay</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">//1. 测试过期时间，死信消息</span></span><br><span class="line">    <span class="type">MessageProperties</span> <span class="variable">prop</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MessageProperties</span>();</span><br><span class="line">    <span class="comment">// 5s不消费消息将成为死信</span></span><br><span class="line">    prop.setExpiration(<span class="string">&quot;5000&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">Message</span> <span class="variable">message</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Message</span>(<span class="string">&quot;delay=ttl+dl&quot;</span>.getBytes(), prop);</span><br><span class="line"></span><br><span class="line">    rabbitTemplate.convertAndSend(<span class="string">&quot;test_queue_dlx2&quot;</span>, message);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<blockquote>
<p>测试观察，发送消息到test_queue_dlx2（正常的队列）中，5s没有消费该消息自动到死信队列中；</p>
</blockquote>
<h2 id="7-5-队列限流"><a href="#7-5-队列限流" class="headerlink" title="7.5 队列限流"></a>7.5 队列限流</h2><p>我们在之前讲MQ好处的时候就说过MQ可以做流量削峰，当网站承受的压力已经到达极限时，我们可以采用MQ来进行限流操作</p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/rabbit2/94.png"
                      style="zoom:67%;" 
                >

<h3 id="7-5-1-案例测试"><a href="#7-5-1-案例测试" class="headerlink" title="7.5.1 案例测试"></a>7.5.1 案例测试</h3><h4 id="7-5-1-1-配置spring-xml："><a href="#7-5-1-1-配置spring-xml：" class="headerlink" title="7.5.1.1 配置spring.xml："></a>7.5.1.1 配置spring.xml：</h4><p>一般情况下，队列限流设置为手动签收（不是强制）</p>
<div class="highlight-container" data-rel="Xml"><figure class="iseeu highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">    定义监听器容器</span></span><br><span class="line"><span class="comment">    &lt;rabbit:listener-container connection-factory=&quot;connectionFactory&quot; acknowledge=&quot;none&quot; prefetch=&quot;1&quot; &gt;</span></span><br><span class="line"><span class="comment">        acknowledge:消息签收方式</span></span><br><span class="line"><span class="comment">            none:   自动签收(消息被消费就自动签收)</span></span><br><span class="line"><span class="comment">            manual: 手动签收(需要调用basicNack或basicReject方法手动签收)</span></span><br><span class="line"><span class="comment">            auto:   由rabbitmq来决定是否签收(根据异常进行处理)</span></span><br><span class="line"><span class="comment">        prefetch: 当多条消费者接受到多条消息一次性处理几条</span></span><br><span class="line"><span class="comment">--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">rabbit:listener-container</span> <span class="attr">connection-factory</span>=<span class="string">&quot;connectionFactory&quot;</span> <span class="attr">acknowledge</span>=<span class="string">&quot;manual&quot;</span> <span class="attr">prefetch</span>=<span class="string">&quot;1&quot;</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">rabbit:listener</span> <span class="attr">ref</span>=<span class="string">&quot;qosListener&quot;</span> <span class="attr">queue-names</span>=<span class="string">&quot;test_queue_confirm&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">rabbit:listener</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">rabbit:listener-container</span>&gt;</span></span><br></pre></td></tr></table></figure></div>

<h4 id="7-5-1-2-监听器"><a href="#7-5-1-2-监听器" class="headerlink" title="7.5.1.2 监听器"></a>7.5.1.2 监听器</h4><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.minge.rabbitmq.listener;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.Message;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.listener.api.ChannelAwareMessageListener;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Consumer 限流机制</span></span><br><span class="line"><span class="comment"> *  listener-container配置属性</span></span><br><span class="line"><span class="comment"> *      perfetch = 1,表示消费端每次从mq拉去一条消息来消费，直到手动确认消费完毕后，才会继续拉去下一条消息。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">QosListener</span> <span class="keyword">implements</span> <span class="title class_">ChannelAwareMessageListener</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onMessage</span><span class="params">(Message message, Channel channel)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">        <span class="comment">//1.获取消息</span></span><br><span class="line">        System.out.println(<span class="keyword">new</span> <span class="title class_">String</span>(message.getBody()));</span><br><span class="line"></span><br><span class="line">        <span class="comment">//2. 处理业务逻辑</span></span><br><span class="line">        System.out.println(<span class="string">&quot;处理业务逻辑...&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//3. 签收</span></span><br><span class="line">        channel.basicAck(message.getMessageProperties().getDeliveryTag(),<span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h4 id="7-5-1-3-消息生产者发送消息"><a href="#7-5-1-3-消息生产者发送消息" class="headerlink" title="7.5.1.3 消息生产者发送消息"></a>7.5.1.3 消息生产者发送消息</h4><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testSend</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt;= <span class="number">10</span>; i++) &#123;</span><br><span class="line">        rabbitTemplate.convertAndSend(<span class="string">&quot;test_exchange_confirm&quot;</span>, <span class="string">&quot;confirm&quot;</span>, <span class="string">&quot;这是第&quot;</span> + i + <span class="string">&quot;条消息&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h1 id="八、SpringBoot整合高级特性"><a href="#八、SpringBoot整合高级特性" class="headerlink" title="八、SpringBoot整合高级特性"></a>八、SpringBoot整合高级特性</h1><p>我们在实际开发中，一般使用的是SpringBoot来开发，因此这一章我们主要采用SpringBoot来实现RabbitMQ的高级特性，顺便回顾一下刚刚学的知识；</p>
<p>首先先准备一个SpringBoot整合RabbitMQ的环境（参考上述案例）</p>
<h2 id="8-1-消息确认机制"><a href="#8-1-消息确认机制" class="headerlink" title="8.1 消息确认机制"></a>8.1 消息确认机制</h2><h3 id="8-1-1-确认模式"><a href="#8-1-1-确认模式" class="headerlink" title="8.1.1 确认模式"></a>8.1.1 确认模式</h3><p><strong>概念：当消息发送后，不管发送成功与否都会进入Producer端的一个回调，回调中的参数说明了此次消息发送成功与否，如果消息成功投递那么ack为true，如果投递失败ack为false</strong></p>
<p>回顾Spring环境下如何开启确认模式：</p>
<p>1、在ConnectionFactory中开启确认模式<code>publisher-confirms=&quot;true&quot;</code></p>
<p>2、确认模式在<code>RabbitTemplate</code>对象的<code>setConfirmCallback</code>方法中设置一个回调函数</p>
<h4 id="8-1-1-1-application-yml："><a href="#8-1-1-1-application-yml：" class="headerlink" title="8.1.1.1 application.yml："></a>8.1.1.1 application.yml：</h4><div class="highlight-container" data-rel="Yml"><figure class="iseeu highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="number">192.168</span><span class="number">.40</span><span class="number">.141</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">5672</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">lscl</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">admin</span></span><br><span class="line">    <span class="attr">virtual-host:</span> <span class="string">/lscl</span></span><br><span class="line">    <span class="attr">publisher-confirms:</span> <span class="literal">true</span>    <span class="comment"># 开启消息确认模式</span></span><br></pre></td></tr></table></figure></div>

<h4 id="8-1-1-2-定义队列和交换机："><a href="#8-1-1-2-定义队列和交换机：" class="headerlink" title="8.1.1.2 定义队列和交换机："></a>8.1.1.2 定义队列和交换机：</h4><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.minge.rabbitmq.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.*;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RabbitConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 定义direct交换机</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Exchange <span class="title function_">testExchangeConfirm</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ExchangeBuilder.directExchange(<span class="string">&quot;test_exchange_confirm&quot;</span>).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 定义一个队列</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">testQueueConfirm</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> QueueBuilder.durable(<span class="string">&quot;test_queue_confirm&quot;</span>).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Queue和Exchange进行绑定</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">testBindingConfirm</span><span class="params">()</span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">Queue</span> <span class="variable">queue</span> <span class="operator">=</span> testQueueConfirm();</span><br><span class="line">        <span class="type">Exchange</span> <span class="variable">exchange</span> <span class="operator">=</span> testExchangeConfirm();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(queue).to(exchange).with(<span class="string">&quot;confirm&quot;</span>).noargs();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h4 id="8-1-1-3-配置类："><a href="#8-1-1-3-配置类：" class="headerlink" title="8.1.1.3 配置类："></a>8.1.1.3 配置类：</h4><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.minge.rabbitmq.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.ConnectionFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.core.RabbitTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.support.CorrelationData;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.PostConstruct;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 测试消息确认机制中的确认模式</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Config_01_ConfirmCallback</span> <span class="keyword">implements</span> <span class="title class_">RabbitTemplate</span>.ConfirmCallback &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RabbitTemplate rabbitTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span> &#123;</span><br><span class="line">        rabbitTemplate.setConfirmCallback(<span class="built_in">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> correlationData: 配置相关信息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> ack:             交换机是否成功收到消息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> cause:           失败原因</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">confirm</span><span class="params">(CorrelationData correlationData, <span class="type">boolean</span> ack, String cause)</span> &#123;</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;confirm executed...&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ack) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;success: &quot;</span> + cause);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;error: &quot;</span> + cause);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h4 id="8-1-1-4-测试代码："><a href="#8-1-1-4-测试代码：" class="headerlink" title="8.1.1.4 测试代码："></a>8.1.1.4 测试代码：</h4><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.minge.rabbitmq;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"><span class="keyword">import</span> org.junit.runner.RunWith;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.AmqpException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.Message;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.MessagePostProcessor;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.core.RabbitTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.support.CorrelationData;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.test.context.junit4.SpringRunner;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.Transactional;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RunWith(SpringRunner.class)</span></span><br><span class="line"><span class="meta">@SpringBootTest(classes = ProducerApplication.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ProducerTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RabbitTemplate rabbitTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 确认模式：</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testConfirm</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 发送消息</span></span><br><span class="line">        rabbitTemplate.convertAndSend(<span class="string">&quot;test_exchange_confirm2&quot;</span>, <span class="string">&quot;confirm&quot;</span>, <span class="string">&quot;message confirm....&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="8-1-2-回退模式"><a href="#8-1-2-回退模式" class="headerlink" title="8.1.2 回退模式"></a>8.1.2 回退模式</h3><p><strong>概念：当Producer发送消息之后，在交换机投递给队列时， 队列无法接受到消息时，触发回调函数</strong></p>
<blockquote>
<p>注意：&#x3D;&#x3D;<strong>首先得保证消息可以投递给交换机（确认模式）</strong>&#x3D;&#x3D;</p>
</blockquote>
<p>回顾Spring环境下如何开启回退模式：</p>
<p>1、在ConnectionFactory中开启回退模式<code>publisher-returns=&quot;true&quot;</code></p>
<p>2、开启消息回退（设置rabbitTempalte中的<code>setMandatory(true)</code>）</p>
<p>2、确认模式在<code>RabbitTemplate</code>对象的<code>setConfirmCallback</code>方法中设置一个回调函数</p>
<h4 id="8-1-2-1-application-yml："><a href="#8-1-2-1-application-yml：" class="headerlink" title="8.1.2.1 application.yml："></a>8.1.2.1 application.yml：</h4><div class="highlight-container" data-rel="Yml"><figure class="iseeu highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">publisher-returns:</span> <span class="literal">true</span>     <span class="comment"># 开启回退模式</span></span><br></pre></td></tr></table></figure></div>

<h4 id="8-1-2-2-配置类："><a href="#8-1-2-2-配置类：" class="headerlink" title="8.1.2.2 配置类："></a>8.1.2.2 配置类：</h4><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.minge.rabbitmq.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.Message;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.core.RabbitTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.PostConstruct;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 测试消息确认机制中的确认模式</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Config_02_ReturnCallback</span> <span class="keyword">implements</span> <span class="title class_">RabbitTemplate</span>.ReturnCallback &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RabbitTemplate rabbitTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 开启消息回退</span></span><br><span class="line">        rabbitTemplate.setMandatory(<span class="literal">true</span>);</span><br><span class="line">        rabbitTemplate.setReturnCallback(<span class="built_in">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> message    消息对象</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> replyCode  错误码</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> replyText  错误信息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> exchange   交换机</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> routingKey 路由键</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">returnedMessage</span><span class="params">(Message message, <span class="type">int</span> replyCode, String replyText, String exchange, String routingKey)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;return executed....&quot;</span>);</span><br><span class="line"></span><br><span class="line">        System.out.println(message);</span><br><span class="line">        System.out.println(replyCode);</span><br><span class="line">        System.out.println(replyText);</span><br><span class="line">        System.out.println(exchange);</span><br><span class="line">        System.out.println(routingKey);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h4 id="8-1-2-3-测试类："><a href="#8-1-2-3-测试类：" class="headerlink" title="8.1.2.3 测试类："></a>8.1.2.3 测试类：</h4><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 回退模式： 当消息发送给Exchange后，Exchange路由到Queue失败时 才会执行 ReturnCallBack</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testReturn</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 发送消息</span></span><br><span class="line">    rabbitTemplate.convertAndSend(<span class="string">&quot;test_exchange_confirm&quot;</span>, <span class="string">&quot;confirm&quot;</span>, <span class="string">&quot;message confirm....&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="8-1-3-事务模式"><a href="#8-1-3-事务模式" class="headerlink" title="8.1.3 事务模式"></a>8.1.3 事务模式</h3><p>回顾Spring环境下如何开启事务模式：</p>
<p>1、事务模式不能与确认模式和回退模式共存（删除确认模式和回退模式的配置）</p>
<p>2、开启rabbitmq对事务的支持<code>setChannelTransacted(true)</code>、开启消息回退<code>setMandatory(true)</code></p>
<p>3、注入<code>RabbitTransactionManager</code>事务管理器</p>
<h4 id="8-1-3-1-application-yml："><a href="#8-1-3-1-application-yml：" class="headerlink" title="8.1.3.1 application.yml："></a>8.1.3.1 application.yml：</h4><p>删除如下配置：</p>
<div class="highlight-container" data-rel="Yml"><figure class="iseeu highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="comment">#publisher-confirms: true    # 开启消息确认模式</span></span><br><span class="line">    <span class="comment">#publisher-returns: true     # 开启回退模式</span></span><br></pre></td></tr></table></figure></div>

<h4 id="8-1-3-2-配置类："><a href="#8-1-3-2-配置类：" class="headerlink" title="8.1.3.2 配置类："></a>8.1.3.2 配置类：</h4><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.minge.rabbitmq.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.connection.ConnectionFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.core.RabbitTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.transaction.RabbitTransactionManager;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.PostConstruct;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 测试消息确认机制中的事务</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Config_03_Transaction</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RabbitTemplate rabbitTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 开启rabbitmq对事物的支持</span></span><br><span class="line">        rabbitTemplate.setChannelTransacted(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 开启消息回退</span></span><br><span class="line">        rabbitTemplate.setMandatory(<span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 配置RabbitMQ事务管理器</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RabbitTransactionManager <span class="title function_">rabbitTransactionManager</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">RabbitTransactionManager</span> <span class="variable">manager</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RabbitTransactionManager</span>();</span><br><span class="line">        <span class="type">ConnectionFactory</span> <span class="variable">factory</span> <span class="operator">=</span> rabbitTemplate.getConnectionFactory();</span><br><span class="line">        manager.setConnectionFactory(factory);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> manager;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h4 id="8-1-3-3-测试代码："><a href="#8-1-3-3-测试代码：" class="headerlink" title="8.1.3.3 测试代码："></a>8.1.3.3 测试代码：</h4><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.minge.rabbitmq.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.core.RabbitTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.Transactional;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PathVariable;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RabbitTemplate rabbitTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/hello/&#123;flag&#125;&quot;)</span></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">hello</span><span class="params">(<span class="meta">@PathVariable</span> Integer flag)</span> &#123;</span><br><span class="line">        rabbitTemplate.convertAndSend(<span class="string">&quot;test_exchange_confirm&quot;</span>, <span class="string">&quot;confirm&quot;</span>, <span class="string">&quot;message confirm.....&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (flag == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span> / <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        rabbitTemplate.convertAndSend(<span class="string">&quot;test_exchange_confirm&quot;</span>, <span class="string">&quot;confirm&quot;</span>, <span class="string">&quot;message confirm.....&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;ok&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="8-1-4-Conusmer-Ack"><a href="#8-1-4-Conusmer-Ack" class="headerlink" title="8.1.4 Conusmer Ack"></a>8.1.4 Conusmer Ack</h3><p>回顾Spring环境下如何开启Ack模式：</p>
<ul>
<li>在监听容器中指定acknowledge参数，none（自动签收）、manual（手动签收）、auto（rabbitmq来决定签收）</li>
</ul>
<p>搭建Consumer端工程：参考前面的SpringBoot整合RabbitMQ</p>
<h4 id="8-1-4-1-application-yml："><a href="#8-1-4-1-application-yml：" class="headerlink" title="8.1.4.1 application.yml："></a>8.1.4.1 application.yml：</h4><div class="highlight-container" data-rel="Yml"><figure class="iseeu highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">listener:</span></span><br><span class="line">      <span class="attr">simple:</span></span><br><span class="line">        <span class="attr">acknowledge-mode:</span> <span class="string">manual</span>    <span class="comment"># 手动签收</span></span><br></pre></td></tr></table></figure></div>

<h4 id="8-1-4-2-配置类："><a href="#8-1-4-2-配置类：" class="headerlink" title="8.1.4.2 配置类："></a>8.1.4.2 配置类：</h4><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.minge.rabbitmq;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.AcknowledgeMode;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.config.ListenerContainerFactoryBean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.connection.ConnectionFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConsumerApplication</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(ConsumerApplication.class);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h4 id="8-1-4-3-监听类："><a href="#8-1-4-3-监听类：" class="headerlink" title="8.1.4.3 监听类："></a>8.1.4.3 监听类：</h4><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.minge.rabbitmq.listener;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.Message;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.annotation.RabbitListener;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AckListener</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RabbitListener(queues = &quot;test_queue_confirm&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test_queue_confirm</span><span class="params">(Message message, Channel channel)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//1.获取消息</span></span><br><span class="line">            System.out.println(<span class="keyword">new</span> <span class="title class_">String</span>(message.getBody()));</span><br><span class="line"></span><br><span class="line">            <span class="comment">//2. 处理业务逻辑</span></span><br><span class="line">            System.out.println(<span class="string">&quot;处理业务逻辑...&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span> / <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 签收消息</span></span><br><span class="line">            channel.basicAck(message.getMessageProperties().getDeliveryTag(), <span class="literal">true</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 拒绝签收</span></span><br><span class="line">            channel.basicNack(message.getMessageProperties().getDeliveryTag(), <span class="literal">true</span>, <span class="literal">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>





<h2 id="8-2-TTL队列"><a href="#8-2-TTL队列" class="headerlink" title="8.2 TTL队列"></a>8.2 TTL队列</h2><p>什么是TTL队列？</p>
<ul>
<li>带有过期时间的队列，当过期时间到达后消息如果没有被消费，那么自动丢弃</li>
<li>当队列和消息同时设置有过期时间时，以最先过期的单位时间为准</li>
<li>在RabbitMQ中并不是轮询方式去判断消息是否过期，而是只判断在最顶部的消息，因此消息如果不是在最顶部技术到达了过期时间也不会被移除队列；</li>
</ul>
<p>回顾Spring环境下如何配置TTL队列：</p>
<ul>
<li>1）设置队列的<code>x-message-ttl</code>参数，单位：毫秒</li>
</ul>
<h3 id="8-2-1-配置类："><a href="#8-2-1-配置类：" class="headerlink" title="8.2.1 配置类："></a>8.2.1 配置类：</h3><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.minge.rabbitmq.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.Queue;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.QueueBuilder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 测试TTL</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Config_04_TTL</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean(&quot;testQueueTtl&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">testQueueTtl</span><span class="params">()</span> &#123;</span><br><span class="line">        Map&lt;String, Object&gt; param = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        param.put(<span class="string">&quot;x-message-ttl&quot;</span>, <span class="number">5000</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> QueueBuilder.durable(<span class="string">&quot;test_queue_ttl&quot;</span>).withArguments(param).build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="8-2-2-测试类："><a href="#8-2-2-测试类：" class="headerlink" title="8.2.2 测试类："></a>8.2.2 测试类：</h3><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * TTL:过期时间</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testTtl</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">//        rabbitTemplate.convertAndSend(&quot;test_queue_ttl&quot;, &quot;ttl 队列统一过期....&quot;);</span></span><br><span class="line"></span><br><span class="line">    MessageProperties properties=<span class="keyword">new</span> <span class="title class_">MessageProperties</span>();</span><br><span class="line">    properties.setExpiration(<span class="string">&quot;2000&quot;</span>);</span><br><span class="line">    Message message=<span class="keyword">new</span> <span class="title class_">Message</span>(<span class="string">&quot;ttl 单独消息过期&quot;</span>.getBytes(),properties);</span><br><span class="line"></span><br><span class="line">    rabbitTemplate.convertAndSend(<span class="string">&quot;test_queue_ttl&quot;</span>, message);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h2 id="8-3-死信队列"><a href="#8-3-死信队列" class="headerlink" title="8.3 死信队列"></a>8.3 死信队列</h2><p>回顾什么是死信队列？</p>
<ul>
<li>1）消息被拒绝签收（<code>channel.basicNack()、channel.basicReject()</code>）</li>
<li>2）消息达到过期时间没有被消费</li>
<li>3）消息超过了队列的最大长度</li>
</ul>
<p>Spring环境下如何配置死信队列？</p>
<ul>
<li>1）声明正常的队列，并且在队列参数中设置死信交换机（消息成为死信后再次被利用起来只能绑定交换机，不能直接绑定Queue）</li>
<li>2）声明死信交换机</li>
<li>3）声明死信队列</li>
<li>4）死信队列绑定死信交换机</li>
</ul>
<h3 id="8-3-1-配置类"><a href="#8-3-1-配置类" class="headerlink" title="8.3.1 配置类"></a>8.3.1 配置类</h3><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.minge.rabbitmq.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.*;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 测试死信队列</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Config_05_Dlx</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 声明正常的队列,设置死信交换机参数</span></span><br><span class="line">    <span class="meta">@Bean(&quot;testQueueDlx&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">testQueueDlx</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">        Map&lt;String,Object&gt; params=<span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        <span class="comment">// 设置死信交换机</span></span><br><span class="line">        params.put(<span class="string">&quot;x-dead-letter-exchange&quot;</span>,<span class="string">&quot;exchange_dlx&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 转发给死信交换机的routingKey</span></span><br><span class="line">        params.put(<span class="string">&quot;x-dead-letter-routing-key&quot;</span>,<span class="string">&quot;dlx&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 队列的过期时间</span></span><br><span class="line"><span class="comment">//        params.put(&quot;x-message-ttl&quot;,5000);</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 设置队列的最大长度限制</span></span><br><span class="line"><span class="comment">//        params.put(&quot;x-max-length&quot;,10);</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> QueueBuilder.durable(<span class="string">&quot;test_queue_dlx&quot;</span>).withArguments(params).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 声明死信队列</span></span><br><span class="line">    <span class="meta">@Bean(&quot;queue_dlx&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">queueDlx</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> QueueBuilder.durable(<span class="string">&quot;queue_dlx&quot;</span>).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 声明死信交换机</span></span><br><span class="line">    <span class="meta">@Bean(&quot;test_exchange_dlx&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Exchange <span class="title function_">testExchangeDlx</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> ExchangeBuilder.directExchange(<span class="string">&quot;exchange_dlx&quot;</span>).durable(<span class="literal">true</span>).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 死信交换机绑定死信队列</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">binding</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">Queue</span> <span class="variable">queue</span> <span class="operator">=</span> queueDlx();</span><br><span class="line">        <span class="type">Exchange</span> <span class="variable">exchange</span> <span class="operator">=</span> testExchangeDlx();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(queue).to(exchange).with(<span class="string">&quot;dlx&quot;</span>).noargs();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="8-3-2-测试类："><a href="#8-3-2-测试类：" class="headerlink" title="8.3.2 测试类："></a>8.3.2 测试类：</h3><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 发送测试死信消息：</span></span><br><span class="line"><span class="comment"> * 1. 过期时间</span></span><br><span class="line"><span class="comment"> * 2. 长度限制</span></span><br><span class="line"><span class="comment"> * 3. 消息拒收</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testDlx</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">MessageProperties</span> <span class="variable">properties</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MessageProperties</span>();</span><br><span class="line">    properties.setExpiration(<span class="string">&quot;5000&quot;</span>);</span><br><span class="line">    <span class="type">Message</span> <span class="variable">message</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Message</span>(<span class="string">&quot;我是死信队列哦...&quot;</span>.getBytes(), properties);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//1. 测试过期时间，死信消息</span></span><br><span class="line">    rabbitTemplate.convertAndSend(<span class="string">&quot;test_queue_dlx&quot;</span>, message);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2. 测试长度限制后，消息死信</span></span><br><span class="line">   <span class="comment">/* for (int i = 0; i &lt; 20; i++) &#123;</span></span><br><span class="line"><span class="comment">        rabbitTemplate.convertAndSend(&quot;test_queue_dlx&quot;,&quot;我是死信队列哦...&quot;+i);</span></span><br><span class="line"><span class="comment">    &#125;*/</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//3. 测试消息拒收</span></span><br><span class="line"><span class="comment">//        rabbitTemplate.convertAndSend(&quot;test_queue_dlx&quot;,&quot;我是死信队列哦...&quot;+i);</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>



<h2 id="8-4-延时队列"><a href="#8-4-延时队列" class="headerlink" title="8.4 延时队列"></a>8.4 延时队列</h2><h3 id="8-4-1-回顾"><a href="#8-4-1-回顾" class="headerlink" title="8.4.1 回顾"></a>8.4.1 回顾</h3><p>什么是延时队列？</p>
<ul>
<li>Producer发送消息后，消息不会立即消费，而是等待指定的时间后消费</li>
</ul>
<p>如何实现？</p>
<ul>
<li>发送一条消息并设置过期时间，当消息到达时间没有被消费，推送给死信交换机，死信交换机退给死信队列，我们最终监听死信队列的消息即可达到延迟队列的效果；即：<strong>TTL+死信队列</strong>完成延迟队列的功能；</li>
</ul>
<p>Spring环境下如何配置死信队列？</p>
<ul>
<li>1）声明正常的队列，并且在队列参数中设置死信交换机（消息成为死信后再次被利用起来只能绑定交换机，不能直接绑定Queue）</li>
<li>2）声明死信交换机</li>
<li>3）声明死信队列</li>
<li>4）死信队列绑定死信交换机</li>
</ul>
<blockquote>
<p>延迟队列就是TTL+死信队列，只不过死信队列中消息有三种方法都会成为死信，而延时队列只强调消息达到过期时间的这一种；因此我们还原死信队列的配置即可，</p>
</blockquote>
<h3 id="配置类："><a href="#配置类：" class="headerlink" title="配置类："></a>配置类：</h3><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.minge.rabbitmq.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.*;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 测试死信队列</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Config_06_Delay</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 声明正常的队列,设置死信交换机参数</span></span><br><span class="line">    <span class="meta">@Bean(&quot;testQueueDlx&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">testQueueDlx</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">        Map&lt;String, Object&gt; params = <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        <span class="comment">// 设置死信交换机</span></span><br><span class="line">        params.put(<span class="string">&quot;x-dead-letter-exchange&quot;</span>, <span class="string">&quot;exchange_dlx&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 转发给死信交换机的routingKey</span></span><br><span class="line">        params.put(<span class="string">&quot;x-dead-letter-routing-key&quot;</span>, <span class="string">&quot;dlx&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 队列的过期时间</span></span><br><span class="line"><span class="comment">//        params.put(&quot;x-message-ttl&quot;,5000);</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 设置队列的最大长度限制</span></span><br><span class="line"><span class="comment">//        params.put(&quot;x-max-length&quot;,10);</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> QueueBuilder.durable(<span class="string">&quot;test_queue_dlx&quot;</span>).withArguments(params).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 声明死信队列</span></span><br><span class="line">    <span class="meta">@Bean(&quot;queue_dlx&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">queueDlx</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> QueueBuilder.durable(<span class="string">&quot;queue_dlx&quot;</span>).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 声明死信交换机</span></span><br><span class="line">    <span class="meta">@Bean(&quot;test_exchange_dlx&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Exchange <span class="title function_">testExchangeDlx</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> ExchangeBuilder.directExchange(<span class="string">&quot;exchange_dlx&quot;</span>).durable(<span class="literal">true</span>).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 死信交换机绑定死信队列</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">binding</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Queue</span> <span class="variable">queue</span> <span class="operator">=</span> queueDlx();</span><br><span class="line">        <span class="type">Exchange</span> <span class="variable">exchange</span> <span class="operator">=</span> testExchangeDlx();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(queue).to(exchange).with(<span class="string">&quot;dlx&quot;</span>).noargs();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<blockquote>
<p>和死信队列的一模一样</p>
</blockquote>
<h3 id="测试类："><a href="#测试类：" class="headerlink" title="测试类："></a>测试类：</h3><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 延迟队列</span></span><br><span class="line"><span class="comment"> * TTL+死信队列</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testDelay</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">MessageProperties</span> <span class="variable">properties</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MessageProperties</span>();</span><br><span class="line">    properties.setExpiration(<span class="string">&quot;5000&quot;</span>);</span><br><span class="line">    <span class="type">Message</span> <span class="variable">message</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Message</span>(<span class="string">&quot;我要测试延迟队列.....是5s后执行吗？？？&quot;</span>.getBytes(), properties);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//1. 测试过期时间，死信消息</span></span><br><span class="line">    rabbitTemplate.convertAndSend(<span class="string">&quot;test_queue_dlx&quot;</span>, message);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/rabbit2/63.png"
                     
                ></p>
<blockquote>
<p>观察test_queue_dlx队列中的消息是否5s后到达queue_dlx队列</p>
</blockquote>
<h2 id="8-5-队列限流"><a href="#8-5-队列限流" class="headerlink" title="8.5 队列限流"></a>8.5 队列限流</h2><h3 id="8-5-1-回顾"><a href="#8-5-1-回顾" class="headerlink" title="8.5.1 回顾"></a>8.5.1 回顾</h3><p>什么是队列限流？</p>
<ul>
<li>当RabbitMQ有大流量的消息来到队列时，我们希望消息可以在Consumer的承受范围内进行逐个消费，例如每次消费100条、1000条</li>
</ul>
<p>Spring环境下如何配置队列限流？</p>
<ul>
<li>在Conusmer端的监听容器中设置<code>prefetch</code>参数，代表Conusmer一次性去队列中最大能拉取多少条消息消费；</li>
</ul>
<h3 id="8-5-2-application-yml："><a href="#8-5-2-application-yml：" class="headerlink" title="8.5.2 application.yml："></a>8.5.2 application.yml：</h3><div class="highlight-container" data-rel="Yml"><figure class="iseeu highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">listener:</span></span><br><span class="line">      <span class="attr">simple:</span></span><br><span class="line">        <span class="attr">prefetch:</span> <span class="number">1</span>       <span class="comment"># 每次从队列中拉取一条消息进行消费</span></span><br></pre></td></tr></table></figure></div>



<h3 id="8-5-3-启动类："><a href="#8-5-3-启动类：" class="headerlink" title="8.5.3 启动类："></a>8.5.3 启动类：</h3><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.minge.rabbitmq;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.config.ListenerContainerFactoryBean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.connection.ConnectionFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConsumerApplication</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(ConsumerApplication.class);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="8-5-4-监听类："><a href="#8-5-4-监听类：" class="headerlink" title="8.5.4 监听类："></a>8.5.4 监听类：</h3><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.minge.rabbitmq.listener;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.Message;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.annotation.RabbitListener;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Consumer 限流机制</span></span><br><span class="line"><span class="comment"> *  perfetch = 1,表示消费端每次从mq拉去一条消息来消费，直到手动确认消费完毕后，才会继续拉去下一条消息。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">QosListener</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RabbitListener(queues = &quot;test_queue_confirm&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test_queue_confirm</span><span class="params">(Message message)</span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">            <span class="comment">//1.获取消息</span></span><br><span class="line">            System.out.println(<span class="keyword">new</span> <span class="title class_">String</span>(message.getBody()));</span><br><span class="line"></span><br><span class="line">            <span class="comment">//2. 处理业务逻辑</span></span><br><span class="line">            System.out.println(<span class="string">&quot;处理业务逻辑...&quot;</span>);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h1 id="九、消息的幂等性"><a href="#九、消息的幂等性" class="headerlink" title="九、消息的幂等性"></a>九、消息的幂等性</h1><h2 id="9-1-幂等简介"><a href="#9-1-幂等简介" class="headerlink" title="9.1 幂等简介"></a>9.1 幂等简介</h2><p>幂等性：用户对于同一操作发起的一次请求或者多次请求的结果是一致的，不会因为多次点击而产生了副作用，例如用户在下订单时，由于网络卡顿等原因多次点击下单按钮，但最终订单只生成了一个，并不会多次下订单；</p>
<p>消息幂等性：即消息无论被发送多少次，最终只会消费一次。保证消息不会重复被消费多次；</p>
<h3 id="9-1-1-方案"><a href="#9-1-1-方案" class="headerlink" title="9.1.1 方案"></a>9.1.1 方案</h3><p>实现消息的幂等性通常有两种方案来解决：全局消息ID、Redis标识，两种方案从原理上讲都是一样的；</p>
<ul>
<li>全局消息ID：发送消息时给消息分配一个全局ID，每次消费消息时判断该ID是否存在过，如果存在过则已经消费过，如果不存在则说明是第一次消费；</li>
<li>Redis标识：发送消息时，给消息分配一个全局的唯一ID，消费消息时，将id与消息以K-V的形式写入Redis<code>&lt;id,meessage&gt;</code>，如果能写入成功代表第一次消费消息，如果写入不成功代表消费已经被消费过了</li>
</ul>
<h3 id="9-1-2-解决消息幂等性"><a href="#9-1-2-解决消息幂等性" class="headerlink" title="9.1.2 解决消息幂等性"></a>9.1.2 解决消息幂等性</h3><p>搭建SpringBoot整合RabbitMQ工程</p>
<blockquote>
<p><strong>我们采用的是Redis的setnx命令来解决消息幂等性问题；</strong></p>
</blockquote>
<h4 id="9-1-2-1-application-yml："><a href="#9-1-2-1-application-yml：" class="headerlink" title="9.1.2.1 application.yml："></a>9.1.2.1 application.yml：</h4><div class="highlight-container" data-rel="Yml"><figure class="iseeu highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="number">192.168</span><span class="number">.133</span><span class="number">.151</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">5672</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">guest</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">guest</span></span><br><span class="line">    <span class="attr">virtual-host:</span> <span class="string">/</span></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br></pre></td></tr></table></figure></div>

<h4 id="9-1-2-2-启动类："><a href="#9-1-2-2-启动类：" class="headerlink" title="9.1.2.2 启动类："></a>9.1.2.2 启动类：</h4><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.minge.rabbitmq;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.Queue;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.QueueBuilder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.RedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.serializer.GenericJackson2JsonRedisSerializer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.serializer.StringRedisSerializer;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Application</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(Application.class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RedisTemplate <span class="title function_">redisTemplate</span><span class="params">(RedisTemplate redisTemplate)</span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// value可见</span></span><br><span class="line">        redisTemplate.setValueSerializer(<span class="keyword">new</span> <span class="title class_">GenericJackson2JsonRedisSerializer</span>());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// key可见</span></span><br><span class="line">        redisTemplate.setKeySerializer(<span class="keyword">new</span> <span class="title class_">StringRedisSerializer</span>());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> redisTemplate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 定义测试队列</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">testQueue</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> QueueBuilder.durable(<span class="string">&quot;test_queue&quot;</span>).build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h4 id="9-1-2-3-监听器："><a href="#9-1-2-3-监听器：" class="headerlink" title="9.1.2.3 监听器："></a>9.1.2.3 监听器：</h4><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.minge.rabbitmq.listener;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.Message;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.annotation.RabbitListener;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.RedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestListener</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RabbitListener(queues = &quot;test_queue&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test_queue_confirm</span><span class="params">(Message message)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">messageId</span> <span class="operator">=</span> message.getMessageProperties().getMessageId();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> == messageId) &#123;</span><br><span class="line"></span><br><span class="line">            System.out.println(<span class="string">&quot;消息id为null!&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (redisTemplate.opsForValue().setIfAbsent(messageId, <span class="keyword">new</span> <span class="title class_">String</span>(message.getBody()))) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 代表第一次消费消息</span></span><br><span class="line">            System.out.println(<span class="string">&quot;消息消费成功: &quot;</span> + <span class="keyword">new</span> <span class="title class_">String</span>(message.getBody()));</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;消息已经被消费过了!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h4 id="9-1-2-4-消息发送端："><a href="#9-1-2-4-消息发送端：" class="headerlink" title="9.1.2.4 消息发送端："></a>9.1.2.4 消息发送端：</h4><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.minge.rabbitmq.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.Message;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.MessageProperties;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.core.RabbitTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.RedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PathVariable;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RabbitTemplate rabbitTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/send/&#123;messageId&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">addOrders</span><span class="params">(<span class="meta">@PathVariable</span> String messageId)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">MessageProperties</span> <span class="variable">prop</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MessageProperties</span>();</span><br><span class="line">        prop.setMessageId(messageId);</span><br><span class="line">        <span class="type">Message</span> <span class="variable">message</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Message</span>(<span class="string">&quot;测试幂等性&quot;</span>.getBytes(), prop);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 发送消息</span></span><br><span class="line">        rabbitTemplate.convertAndSend(<span class="string">&quot;test_queue&quot;</span>, message);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> messageId;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

        </div>

        
            <div class="post-copyright-info w-full my-8 px-2 sm:px-6 md:px-8">
                <div class="article-copyright-info-container">
    <ul>
        <li><strong>Title:</strong> RabbitMQ</li>
        <li><strong>Author:</strong> MinGe</li>
        <li><strong>Created at
                :</strong> 2023-04-04 15:04:00</li>
        
            <li>
                <strong>Updated at
                    :</strong> 2024-11-12 16:22:52
            </li>
        
        <li>
            <strong>Link:</strong> https://redefine.ohevan.com/2023/04/04/RabbitMQ/
        </li>
        <li>
            <strong>
                License:
            </strong>
            

            
                This work is licensed under <a class="license" target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0">CC BY-NC-SA 4.0</a>.
            
        </li>
    </ul>
</div>

            </div>
        

        
            <ul class="post-tags-box text-lg mt-1.5 flex-wrap justify-center flex md:hidden">
                
                    <li class="tag-item mx-0.5">
                        <a href="/tags/java/">#java</a>&nbsp;
                    </li>
                
            </ul>
        

        

        
            <div class="article-nav my-8 flex justify-between items-center px-2 sm:px-6 md:px-8">
                
                    <div class="article-prev border-border-color shadow-redefine-flat shadow-shadow-color-2 rounded-medium px-4 py-2 hover:shadow-redefine-flat-hover hover:shadow-shadow-color-2">
                        <a class="prev"
                        rel="prev"
                        href="/2023/06/10/SQL%E8%AF%AD%E5%8F%A5/"
                        >
                            <span class="left arrow-icon flex justify-center items-center">
                                <i class="fa-solid fa-chevron-left"></i>
                            </span>
                            <span class="title flex justify-center items-center">
                                <span class="post-nav-title-item">SQL语句简介</span>
                                <span class="post-nav-item">Prev posts</span>
                            </span>
                        </a>
                    </div>
                
                
                    <div class="article-next border-border-color shadow-redefine-flat shadow-shadow-color-2 rounded-medium px-4 py-2 hover:shadow-redefine-flat-hover hover:shadow-shadow-color-2">
                        <a class="next"
                        rel="next"
                        href="/2023/02/05/Redis/"
                        >
                            <span class="title flex justify-center items-center">
                                <span class="post-nav-title-item">Redis</span>
                                <span class="post-nav-item">Next posts</span>
                            </span>
                            <span class="right arrow-icon flex justify-center items-center">
                                <i class="fa-solid fa-chevron-right"></i>
                            </span>
                        </a>
                    </div>
                
            </div>
        


        
    </div>

    
        <div class="toc-content-container">
            <div class="post-toc-wrap">
    <div class="post-toc">
        <div class="toc-title">On this page</div>
        <div class="page-title">RabbitMQ</div>
        <ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B8%80%E3%80%81%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6%E7%AE%80%E4%BB%8B"><span class="nav-text">一、消息中间件简介</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BA%8C%E3%80%81RabbitMQ%E7%AE%80%E4%BB%8B"><span class="nav-text">二、RabbitMQ简介</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B8%89%E3%80%81RabbitMQ%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8"><span class="nav-text">三、RabbitMQ快速入门</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%9B%9B%E3%80%81RabbitMQ%E5%B7%A5%E4%BD%9C%E6%A8%A1%E5%BC%8F"><span class="nav-text">四、RabbitMQ工作模式</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BA%94%E3%80%81Spring%E6%95%B4%E5%90%88RabbitMQ"><span class="nav-text">五、Spring整合RabbitMQ</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%85%AD%E3%80%81SpringBoot%E6%95%B4%E5%90%88RabbitMQ"><span class="nav-text">六、SpringBoot整合RabbitMQ</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B8%83%E3%80%81RabbitMQ%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7"><span class="nav-text">七、RabbitMQ高级特性</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%85%AB%E3%80%81SpringBoot%E6%95%B4%E5%90%88%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7"><span class="nav-text">八、SpringBoot整合高级特性</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B9%9D%E3%80%81%E6%B6%88%E6%81%AF%E7%9A%84%E5%B9%82%E7%AD%89%E6%80%A7"><span class="nav-text">九、消息的幂等性</span></a></li></ol>

    </div>
</div>
        </div>
    
</div>



                

            </div>

            

        </div>

        <div class="main-content-footer">
            <footer class="footer mt-5 py-5 h-auto text-base text-third-text-color relative border-t-2 border-t-border-color">
    <div class="info-container py-3 text-center">
        
        <div class="text-center">
            &copy;
            
              <span>2022</span>
              -
            
            2024&nbsp;&nbsp;<i class="fa-solid fa-heart fa-beat" style="--fa-animation-duration: 0.5s; color: #f54545"></i>&nbsp;&nbsp;<a href="/">MinGe</a>
            
                
                <p class="post-count space-x-0.5">
                    <span>
                        20 posts in total
                    </span>
                    
                </p>
            
        </div>
        
        <div class="relative text-center lg:absolute lg:left-[20px] lg:top-1/2 lg:-translate-y-1/2 lg:text-left">
            <span class="lg:block text-sm">POWERED BY <?xml version="1.0" encoding="utf-8"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"><svg class="relative top-[2px] inline-block align-baseline" version="1.1" id="圖層_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="1rem" height="1rem" viewBox="0 0 512 512" enable-background="new 0 0 512 512" xml:space="preserve"><path fill="#0E83CD" d="M256.4,25.8l-200,115.5L56,371.5l199.6,114.7l200-115.5l0.4-230.2L256.4,25.8z M349,354.6l-18.4,10.7l-18.6-11V275H200v79.6l-18.4,10.7l-18.6-11v-197l18.5-10.6l18.5,10.8V237h112v-79.6l18.5-10.6l18.5,10.8V354.6z"/></svg><a target="_blank" class="text-base" href="https://hexo.io">Hexo</a></span>
            <span class="text-sm lg:block">THEME&nbsp;<a class="text-base" target="_blank" href="https://github.com/EvanNotFound/hexo-theme-redefine">Redefine v2.7.1</a></span>
        </div>
        
        
            <div>
                Blog up for <span class="odometer" id="runtime_days" ></span> days <span class="odometer" id="runtime_hours"></span> hrs <span class="odometer" id="runtime_minutes"></span> Min <span class="odometer" id="runtime_seconds"></span> Sec
            </div>
        
        
            <script data-swup-reload-script>
                try {
                    function odometer_init() {
                    const elements = document.querySelectorAll('.odometer');
                    elements.forEach(el => {
                        new Odometer({
                            el,
                            format: '( ddd).dd',
                            duration: 200
                        });
                    });
                    }
                    odometer_init();
                } catch (error) {}
            </script>
        
        
        
    </div>  
</footer>
        </div>
    </div>

    
        <div class="post-tools">
            <div class="post-tools-container">
    <ul class="article-tools-list">
        <!-- TOC aside toggle -->
        
            <li class="right-bottom-tools page-aside-toggle">
                <i class="fa-regular fa-outdent"></i>
            </li>
        

        <!-- go comment -->
        
    </ul>
</div>

        </div>
    

    <div class="right-side-tools-container">
        <div class="side-tools-container">
    <ul class="hidden-tools-list">
        <li class="right-bottom-tools tool-font-adjust-plus flex justify-center items-center">
            <i class="fa-regular fa-magnifying-glass-plus"></i>
        </li>

        <li class="right-bottom-tools tool-font-adjust-minus flex justify-center items-center">
            <i class="fa-regular fa-magnifying-glass-minus"></i>
        </li>

        <li class="right-bottom-tools tool-dark-light-toggle flex justify-center items-center">
            <i class="fa-regular fa-moon"></i>
        </li>

        <!-- rss -->
        

        

        <li class="right-bottom-tools tool-scroll-to-bottom flex justify-center items-center">
            <i class="fa-regular fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="visible-tools-list">
        <li class="right-bottom-tools toggle-tools-list flex justify-center items-center">
            <i class="fa-regular fa-cog fa-spin"></i>
        </li>
        
            <li class="right-bottom-tools tool-scroll-to-top flex justify-center items-center">
                <i class="arrow-up fas fa-arrow-up"></i>
                <span class="percent"></span>
            </li>
        
        
    </ul>
</div>

    </div>

    <div class="image-viewer-container">
    <img src="">
</div>


    

</main>


    
<script src="/js/libs/Swup.min.js"></script>

<script src="/js/libs/SwupSlideTheme.min.js"></script>

<script src="/js/libs/SwupScriptsPlugin.min.js"></script>

<script src="/js/libs/SwupProgressPlugin.min.js"></script>

<script src="/js/libs/SwupScrollPlugin.min.js"></script>

<script src="/js/libs/SwupPreloadPlugin.min.js"></script>

<script>
    const swup = new Swup({
        plugins: [
            new SwupScriptsPlugin({
                optin: true,
            }),
            new SwupProgressPlugin(),
            new SwupScrollPlugin({
                offset: 80,
            }),
            new SwupSlideTheme({
                mainElement: ".main-content-body",
            }),
            new SwupPreloadPlugin(),
        ],
        containers: ["#swup"],
    });
</script>







<script src="/js/tools/imageViewer.js" type="module"></script>

<script src="/js/utils.js" type="module"></script>

<script src="/js/main.js" type="module"></script>

<script src="/js/layouts/navbarShrink.js" type="module"></script>

<script src="/js/tools/scrollTopBottom.js" type="module"></script>

<script src="/js/tools/lightDarkSwitch.js" type="module"></script>

<script src="/js/layouts/categoryList.js" type="module"></script>





    
<script src="/js/tools/codeBlock.js" type="module"></script>




    
<script src="/js/layouts/lazyload.js" type="module"></script>




    
<script src="/js/tools/runtime.js"></script>

    
<script src="/js/libs/odometer.min.js"></script>

    
<link rel="stylesheet" href="/assets/odometer-theme-minimal.css">




  
<script src="/js/libs/Typed.min.js"></script>

  
<script src="/js/plugins/typed.js" type="module"></script>








    
<script src="/js/libs/anime.min.js"></script>



<div class="post-scripts" data-swup-reload-script>
    
        
<script src="/js/tools/tocToggle.js" type="module"></script>

<script src="/js/layouts/toc.js" type="module"></script>

<script src="/js/plugins/tabs.js" type="module"></script>

    
</div>


</body>
</html>
