<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="keywords" content="Hexo Theme Redefine">
    
    <meta name="author" content="MinGe">
    <!-- preconnect -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    
    <!--- Seo Part-->
    
    <link rel="canonical" href="http://example.com/2023/10/03/elasticsearch/"/>
    <meta name="robots" content="index,follow">
    <meta name="googlebot" content="index,follow">
    <meta name="revisit-after" content="1 days">
    
        <meta name="description" content="一、ElasticSearch 简介 1.1. 什么是 ElasticSearchElasticsearch是一个近实时的分布式搜索和分析引擎。它可以帮助你用前所未有的速度去处理大规模数据。ElasticSearch 是一个基于 Lucene的搜索服务器。它提供了一个分布式多用户能力的全文搜索引擎，基于 RESTful web 接口。Elasticsearch 是用 Java开发的，并作为 Apa">
<meta property="og:type" content="article">
<meta property="og:title" content="Elasticsearch">
<meta property="og:url" content="http://example.com/2023/10/03/Elasticsearch/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="一、ElasticSearch 简介 1.1. 什么是 ElasticSearchElasticsearch是一个近实时的分布式搜索和分析引擎。它可以帮助你用前所未有的速度去处理大规模数据。ElasticSearch 是一个基于 Lucene的搜索服务器。它提供了一个分布式多用户能力的全文搜索引擎，基于 RESTful web 接口。Elasticsearch 是用 Java开发的，并作为 Apa">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://example.com/images/ElasticSearch1/1.png">
<meta property="og:image" content="http://example.com/images/ElasticSearch1/2.png">
<meta property="og:image" content="http://example.com/images/ElasticSearch1/3.png">
<meta property="og:image" content="http://example.com/images/ElasticSearch1/104.png">
<meta property="og:image" content="http://example.com/images/ElasticSearch1/5.png">
<meta property="og:image" content="http://example.com/images/ElasticSearch1/6.png">
<meta property="og:image" content="http://example.com/images/ElasticSearch1/7.png">
<meta property="og:image" content="http://example.com/images/ElasticSearch1/8.png">
<meta property="og:image" content="http://example.com/images/ElasticSearch1/9.png">
<meta property="og:image" content="http://example.com/images/ElasticSearch1/10.png">
<meta property="og:image" content="http://example.com/images/ElasticSearch1/11.png">
<meta property="og:image" content="http://example.com/images/ElasticSearch1/120.png">
<meta property="og:image" content="http://example.com/images/ElasticSearch1/100.png">
<meta property="og:image" content="http://example.com/images/ElasticSearch1/99.png">
<meta property="og:image" content="http://example.com/images/ElasticSearch1/108.png">
<meta property="og:image" content="http://example.com/images/ElasticSearch1/109.png">
<meta property="og:image" content="http://example.com/images/ElasticSearch1/200.png">
<meta property="og:image" content="http://example.com/images/ElasticSearch1/34.png">
<meta property="og:image" content="http://example.com/images/ElasticSearch1/30.png">
<meta property="og:image" content="http://example.com/images/ElasticSearch1/31.png">
<meta property="og:image" content="http://example.com/images/ElasticSearch1/32.png">
<meta property="og:image" content="http://example.com/images/ElasticSearch1/33.png">
<meta property="og:image" content="http://example.com/images/ElasticSearch1/35.png">
<meta property="og:image" content="http://example.com/images/ElasticSearch1/36.png">
<meta property="og:image" content="http://example.com/images/ElasticSearch1/29.png">
<meta property="og:image" content="http://example.com/images/ElasticSearch1/37.png">
<meta property="og:image" content="http://example.com/images/ElasticSearch1/38.png">
<meta property="og:image" content="http://example.com/images/ElasticSearch1/102.png">
<meta property="og:image" content="http://example.com/images/ElasticSearch1/103.png">
<meta property="og:image" content="http://example.com/%5Cimages%5CElasticSearch2%5C101.png">
<meta property="og:image" content="http://example.com/%5Cimages%5CElasticSearch2%5C3.png">
<meta property="og:image" content="http://example.com/%5Cimages%5CElasticSearch2%5C11.png">
<meta property="og:image" content="http://example.com/%5Cimages%5CElasticSearch2%5C12.png">
<meta property="og:image" content="http://example.com/%5Cimages%5CElasticSearch2%5C13.png">
<meta property="og:image" content="http://example.com/%5Cimages%5CElasticSearch2%5C14.png">
<meta property="og:image" content="http://example.com/%5Cimages%5CElasticSearch2%5C15.png">
<meta property="og:image" content="http://example.com/%5Cimages%5CElasticSearch2%5C16.png">
<meta property="og:image" content="http://example.com/%5Cimages%5CElasticSearch2%5C18.png">
<meta property="og:image" content="http://example.com/%5Cimages%5CElasticSearch2%5C19.png">
<meta property="og:image" content="http://example.com/%5Cimages%5CElasticSearch2%5C20.png">
<meta property="og:image" content="http://example.com/%5Cimages%5CElasticSearch2%5C22.png">
<meta property="og:image" content="http://example.com/%5Cimages%5CElasticSearch2%5C23.png">
<meta property="og:image" content="http://example.com/%5Cimages%5CElasticSearch2%5C24.png">
<meta property="og:image" content="http://example.com/%5Cimages%5CElasticSearch2%5C28.png">
<meta property="og:image" content="http://example.com/%5Cimages%5CElasticSearch2%5C29.png">
<meta property="og:image" content="http://example.com/%5Cimages%5CElasticSearch2%5C12.png">
<meta property="og:image" content="http://example.com/%5Cimages%5CElasticSearch2%5C30.png">
<meta property="og:image" content="http://example.com/%5Cimages%5CElasticSearch2%5C32.png">
<meta property="og:image" content="http://example.com/%5Cimages%5CElasticSearch2%5C33.png">
<meta property="og:image" content="http://example.com/%5Cimages%5CElasticSearch2%5C25.png">
<meta property="og:image" content="http://example.com/%5Cimages%5CElasticSearch2%5C26.png">
<meta property="og:image" content="http://example.com/%5Cimages%5CElasticSearch2%5C27.png">
<meta property="og:image" content="http://example.com/images/ElasticSearch3/100.png">
<meta property="og:image" content="http://example.com/images/ElasticSearch3/99.png">
<meta property="og:image" content="http://example.com/images/ElasticSearch3/98.png">
<meta property="og:image" content="http://example.com/images/ElasticSearch3/97.png">
<meta property="og:image" content="http://example.com/images/ElasticSearch3/96.png">
<meta property="og:image" content="http://example.com/images/ElasticSearch3/92.png">
<meta property="og:image" content="http://example.com/images/ElasticSearch3/91.png">
<meta property="og:image" content="http://example.com/images/ElasticSearch3/95.png">
<meta property="og:image" content="http://example.com/images/ElasticSearch3/94.png">
<meta property="og:image" content="http://example.com/images/ElasticSearch3/93.png">
<meta property="og:image" content="http://example.com/images/ElasticSearch3/83.png">
<meta property="og:image" content="http://example.com/images/ElasticSearch3/82.png">
<meta property="og:image" content="http://example.com/images/ElasticSearch3/81.png">
<meta property="og:image" content="http://example.com/images/ElasticSearch3/80.png">
<meta property="og:image" content="http://example.com/images/ElasticSearch3/79.png">
<meta property="og:image" content="http://example.com/images/ElasticSearch3/78.png">
<meta property="og:image" content="http://example.com/images/ElasticSearch3/77.png">
<meta property="og:image" content="http://example.com/images/ElasticSearch3/8.png">
<meta property="og:image" content="http://example.com/images/ElasticSearch3/40.png">
<meta property="og:image" content="http://example.com/images/ElasticSearch3/41.png">
<meta property="og:image" content="http://example.com/images/ElasticSearch3/42.png">
<meta property="og:image" content="http://example.com/images/ElasticSearch3/9.png">
<meta property="og:image" content="http://example.com/images/ElasticSearch3/43.png">
<meta property="article:published_time" content="2023-10-03T12:25:00.000Z">
<meta property="article:modified_time" content="2024-11-12T08:45:19.038Z">
<meta property="article:author" content="John Doe">
<meta property="article:tag" content="java">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/images/ElasticSearch1/1.png">
    
    
    <!--- Icon Part-->
    <link rel="icon" type="image/png" href="/images/redefine-favicon.svg" sizes="192x192">
    <link rel="apple-touch-icon" sizes="180x180" href="/images/redefine-favicon.svg">
    <meta name="theme-color" content="#A31F34">
    <link rel="shortcut icon" href="/images/redefine-favicon.svg">
    <!--- Page Info-->
    
    <title>
        
            Elasticsearch -
        
        MinGe 博客
    </title>

    
<link rel="stylesheet" href="/fonts/Chillax/chillax.css">


    <!--- Inject Part-->
    

    
<link rel="stylesheet" href="/css/style.css">


    
        
<link rel="stylesheet" href="/assets/build/styles.css">

    

    
<link rel="stylesheet" href="/fonts/GeistMono/geist-mono.css">

    
<link rel="stylesheet" href="/fonts/Geist/geist.css">

    <!--- Font Part-->
    
    
    
    
    
    

    <script id="hexo-configurations">
    window.config = {"hostname":"example.com","root":"/","language":"en"};
    window.theme = {"articles":{"style":{"font_size":"16px","line_height":1.5,"image_border_radius":"14px","image_alignment":"center","image_caption":false,"link_icon":true,"title_alignment":"left","headings_top_spacing":{"h1":"3.2rem","h2":"2.4rem","h3":"1.9rem","h4":"1.6rem","h5":"1.4rem","h6":"1.3rem"}},"word_count":{"enable":true,"count":true,"min2read":true},"author_label":{"enable":true,"auto":false,"list":[]},"code_block":{"copy":true,"style":"mac","highlight_theme":{"light":"github","dark":"vs2015"},"font":{"enable":false,"family":null,"url":null}},"toc":{"enable":true,"max_depth":3,"number":false,"expand":true,"init_open":true},"copyright":{"enable":true,"default":"cc_by_nc_sa"},"lazyload":true,"recommendation":{"enable":false,"title":"推荐阅读","limit":3,"mobile_limit":2,"placeholder":"/images/wallhaven-wqery6-light.webp","skip_dirs":[]}},"colors":{"primary":"#A31F34","secondary":null,"default_mode":"dark"},"global":{"fonts":{"chinese":{"enable":false,"family":null,"url":null},"english":{"enable":false,"family":null,"url":null},"title":{"enable":false,"family":null,"url":null}},"content_max_width":"1000px","sidebar_width":"210px","hover":{"shadow":true,"scale":false},"scroll_progress":{"bar":false,"percentage":true},"website_counter":{"url":"https://cn.vercount.one/js","enable":false,"site_pv":true,"site_uv":true,"post_pv":true},"single_page":true,"preloader":{"enable":false,"custom_message":null},"open_graph":true,"google_analytics":{"enable":false,"id":null}},"home_banner":{"enable":true,"style":"fixed","image":{"light":"/images/wallhaven-wqery6-light.webp","dark":"/images/wallhaven-wqery6-dark.webp"},"title":"MinGe 博客","subtitle":{"text":[],"hitokoto":{"enable":false,"show_author":false,"api":"https://v1.hitokoto.cn"},"typing_speed":100,"backing_speed":80,"starting_delay":500,"backing_delay":1500,"loop":true,"smart_backspace":true},"text_color":{"light":"#fff","dark":"#d1d1b6"},"text_style":{"title_size":"2.8rem","subtitle_size":"1.5rem","line_height":1.2},"custom_font":{"enable":false,"family":null,"url":null},"social_links":{"enable":false,"style":"default","links":{"github":null,"instagram":null,"zhihu":null,"twitter":null,"email":null},"qrs":{"weixin":null}}},"plugins":{"feed":{"enable":false},"aplayer":{"enable":false,"type":"fixed","audios":[{"name":null,"artist":null,"url":null,"cover":null,"lrc":null}]},"mermaid":{"enable":false,"version":"9.3.0"}},"version":"2.7.1","navbar":{"auto_hide":false,"color":{"left":"#f78736","right":"#367df7","transparency":35},"width":{"home":"1200px","pages":"1000px"},"links":{"Home":{"path":"/","icon":"fa-regular fa-house"},"resume":{"path":"/2024/10/01/minge/","icon":"fa-regular"}},"search":{"enable":false,"preload":true}},"page_templates":{"friends_column":2,"tags_style":"blur"},"home":{"sidebar":{"enable":true,"position":"left","first_item":"menu","announcement":null,"show_on_mobile":true,"links":{"Archives":{"path":"/archives","icon":"fa-regular fa-archive"},"Tags":{"path":"/tags","icon":"fa-regular fa-tags"},"Categories":{"path":"/categories","icon":"fa-regular fa-folder"}}},"article_date_format":"auto","excerpt_length":200,"categories":{"enable":true,"limit":3},"tags":{"enable":true,"limit":3}},"footerStart":"2022/09/25 08:00:00"};
    window.lang_ago = {"second":"%s seconds ago","minute":"%s minutes ago","hour":"%s hours ago","day":"%s days ago","week":"%s weeks ago","month":"%s months ago","year":"%s years ago"};
    window.data = {"masonry":false};
  </script>
    
    <!--- Fontawesome Part-->
    
<link rel="stylesheet" href="/fontawesome/fontawesome.min.css">

    
<link rel="stylesheet" href="/fontawesome/brands.min.css">

    
<link rel="stylesheet" href="/fontawesome/solid.min.css">

    
<link rel="stylesheet" href="/fontawesome/regular.min.css">

    
    
    
    
<meta name="generator" content="Hexo 7.3.0"></head>


<body>
<div class="progress-bar-container">
    

    
        <span class="pjax-progress-bar"></span>
<!--        <span class="swup-progress-icon">-->
<!--            <i class="fa-solid fa-circle-notch fa-spin"></i>-->
<!--        </span>-->
    
</div>



<main class="page-container" id="swup">

    

    <div class="main-content-container">


        <div class="main-content-header">
            <header class="navbar-container px-6 md:px-12">

    <div class="navbar-content ">
        <div class="left">
            
            <a class="logo-title" href="/">
                
                MinGe 博客
                
            </a>
        </div>

        <div class="right">
            <!-- PC -->
            <div class="desktop">
                <ul class="navbar-list">
                    
                        
                            

                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class=""
                                   href="/"
                                        >
                                    <i class="fa-regular fa-house fa-fw"></i>
                                    HOME
                                    
                                </a>

                                <!-- Submenu -->
                                
                            </li>
                    
                        
                            

                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class=""
                                   href="/2024/10/01/minge/"
                                        >
                                    <i class="fa-regular fa-fw"></i>
                                    RESUME
                                    
                                </a>

                                <!-- Submenu -->
                                
                            </li>
                    
                    
                </ul>
            </div>
            <!-- Mobile -->
            <div class="mobile">
                
                <div class="icon-item navbar-bar">
                    <div class="navbar-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile sheet -->
    <div class="navbar-drawer h-screen w-full absolute top-0 left-0 bg-background-color flex flex-col justify-between">
        <ul class="drawer-navbar-list flex flex-col px-4 justify-center items-start">
            
                
                    

                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full "
                           href="/"
                        >
                            <span>
                                HOME
                            </span>
                            
                                <i class="fa-regular fa-house fa-sm fa-fw"></i>
                            
                        </a>
                        

                        
                    </li>
            
                
                    

                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full "
                           href="/2024/10/01/minge/"
                        >
                            <span>
                                RESUME
                            </span>
                            
                                <i class="fa-regular fa-sm fa-fw"></i>
                            
                        </a>
                        

                        
                    </li>
            

            
            
                
                    
                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full active"
                           href="/archives"
                        >
                            <span>Archives</span>
                            <i class="fa-regular fa-archive fa-sm fa-fw"></i>
                        </a>
                    </li>
                
                    
                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full active"
                           href="/tags"
                        >
                            <span>Tags</span>
                            <i class="fa-regular fa-tags fa-sm fa-fw"></i>
                        </a>
                    </li>
                
                    
                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full active"
                           href="/categories"
                        >
                            <span>Categories</span>
                            <i class="fa-regular fa-folder fa-sm fa-fw"></i>
                        </a>
                    </li>
                
            
        </ul>

        <div class="statistics flex justify-around my-2.5">
    <a class="item tag-count-item flex flex-col justify-center items-center w-20" href="/tags">
        <div class="number text-2xl sm:text-xl text-second-text-color font-semibold">3</div>
        <div class="label text-third-text-color text-sm">Tags</div>
    </a>
    <a class="item tag-count-item flex flex-col justify-center items-center w-20" href="/categories">
        <div class="number text-2xl sm:text-xl text-second-text-color font-semibold">2</div>
        <div class="label text-third-text-color text-sm">Categories</div>
    </a>
    <a class="item tag-count-item flex flex-col justify-center items-center w-20" href="/archives">
        <div class="number text-2xl sm:text-xl text-second-text-color font-semibold">20</div>
        <div class="label text-third-text-color text-sm">Posts</div>
    </a>
</div>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="main-content-body">

            

            <div class="main-content">

                
                    <div class="post-page-container flex relative justify-between box-border w-full h-full">
    <div class="article-content-container">

        <div class="article-title relative w-full">
            
                <div class="w-full flex items-center pt-6 justify-start">
                    <h1 class="article-title-regular text-second-text-color tracking-tight text-4xl md:text-6xl font-semibold px-2 sm:px-6 md:px-8 py-3">Elasticsearch</h1>
                </div>
            
            </div>

        
            <div class="article-header flex flex-row gap-2 items-center px-2 sm:px-6 md:px-8">
                <div class="avatar w-[46px] h-[46px] flex-shrink-0 rounded-medium border border-border-color p-[1px]">
                    <img src="/images/redefine-avatar.svg">
                </div>
                <div class="info flex flex-col justify-between">
                    <div class="author flex items-center">
                        <span class="name text-default-text-color text-lg font-semibold">MinGe</span>
                        
                            <span class="author-label ml-1.5 text-xs px-2 py-0.5 rounded-small text-third-text-color border border-shadow-color-1">Lv3</span>
                        
                    </div>
                    <div class="meta-info">
                        <div class="article-meta-info">
    <span class="article-date article-meta-item">
        <i class="fa-regular fa-pen-fancy"></i>&nbsp;
        <span class="desktop">2023-10-03 20:25</span>
        <span class="mobile">2023-10-03 20:25</span>
        <span class="hover-info">Created</span>
    </span>
    
        <span class="article-date article-meta-item">
            <i class="fa-regular fa-wrench"></i>&nbsp;
            <span class="desktop">2024-11-12 16:45:19</span>
            <span class="mobile">2024-11-12 16:45:19</span>
            <span class="hover-info">Updated</span>
        </span>
    

    
        <span class="article-categories article-meta-item">
            <i class="fa-regular fa-folders"></i>&nbsp;
            <ul>
                
                
                    
                        
                        <li>
                            <a href="/categories/%E6%8A%80%E6%9C%AF/">技术</a>&nbsp;
                        </li>
                    
                    
                
            </ul>
        </span>
    
    
        <span class="article-tags article-meta-item">
            <i class="fa-regular fa-tags"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/tags/java/">java</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    

    
    
    
    
</div>

                    </div>
                </div>
            </div>
        

        


        <div class="article-content markdown-body px-2 sm:px-6 md:px-8 pb-8">
            <h1 id="一、ElasticSearch-简介"><a href="#一、ElasticSearch-简介" class="headerlink" title="一、ElasticSearch 简介 "></a>一、ElasticSearch 简介 </h1><h2 id="1-1-什么是-ElasticSearch"><a href="#1-1-什么是-ElasticSearch" class="headerlink" title="1.1. 什么是 ElasticSearch"></a>1.1. 什么是 ElasticSearch</h2><p>Elasticsearch是一个<strong>近实时</strong>的<strong>分布式</strong>搜索和分析引擎。它可以帮助你用前所未有的速度去处理大规模数据。ElasticSearch 是一个基于 Lucene的搜索服务器。它提供了一个分布式多用户能力的全文搜索引擎，基于 RESTful web 接口。Elasticsearch 是用 Java开发的，并作为 Apache许可条款下的开放源码发布，是当前流行的企业级搜索引擎。设计用于云计算中，能够达到实时搜索，稳定，可靠，快速，安装使用方便。</p>
<h2 id="1-2-ElasticSearch-特点"><a href="#1-2-ElasticSearch-特点" class="headerlink" title="1.2. ElasticSearch 特点"></a>1.2. ElasticSearch 特点</h2><p>（1）可以作为一个大型分布式集群（数百台服务器）技术，处理PB级数据，服务大公司；也可以运行在单机上</p>
<p>（2）将全文检索、数据分析以及分布式技术，合并在了一起，才形成了独一无二的ES；</p>
<p>（3）开箱即用的，部署简单</p>
<p>（4）全文检索，同义词处理，相关度排名，复杂数据分析，海量数据的近实时处理</p>
<h2 id="1-3-ElasticSearch-体系结构"><a href="#1-3-ElasticSearch-体系结构" class="headerlink" title="1.3. ElasticSearch 体系结构"></a>1.3. ElasticSearch 体系结构</h2><p>下表是 Elasticsearch 与 MySQL 数据库逻辑结构概念的对比</p>
<table>
<thead>
<tr>
<th>Elasticsearch</th>
<th>关系型数据库 MySQL</th>
</tr>
</thead>
<tbody><tr>
<td>索引(index)</td>
<td>数据库(databases)</td>
</tr>
<tr>
<td>类型(type)</td>
<td>表(table)</td>
</tr>
<tr>
<td>文档(document)</td>
<td>行(row)</td>
</tr>
</tbody></table>
<h2 id="1-4-ElasticSearch-与-Solr-对比"><a href="#1-4-ElasticSearch-与-Solr-对比" class="headerlink" title="1.4 ElasticSearch 与 Solr 对比"></a>1.4 ElasticSearch 与 Solr 对比</h2><ul>
<li>Solr 利用 Zookeeper 进行分布式管理，而 <strong>Elasticsearch 自身带有分布式协调管理功能</strong>;</li>
<li>Solr 支持更多格式的数据，而 Elasticsearch 仅支持json文件格式；</li>
<li>Solr 官方提供的功能更多，而 Elasticsearch 本身更注重于核心功能，高级功能多有第三方插件提供；</li>
<li>Solr 在传统的搜索应用中表现好于 Elasticsearch，但在处理实时搜索应用时效率明显低于 Elasticsearch</li>
<li>Solr 是传统搜索应用的有力解决方案，但 Elasticsearch 更适用于新兴的实时搜索应用。</li>
</ul>
<h1 id="二、部署ElasticSearch"><a href="#二、部署ElasticSearch" class="headerlink" title="二、部署ElasticSearch"></a>二、部署ElasticSearch</h1><h2 id="2-1-部署ES"><a href="#2-1-部署ES" class="headerlink" title="2.1 部署ES"></a>2.1 部署ES</h2><p>解压ES之后，进入bin目录，执行脚本</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/ElasticSearch1/1.png"
                     
                ></p>
<p>即可启动。我们打开浏览器，在地址栏输入 <a class="link"   target="_blank" rel="noopener" href="http://127.0.0.1:9200/" >http://127.0.0.1:9200 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a> 即可看到输出结果</p>
<div class="highlight-container" data-rel="Txt"><figure class="iseeu highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;name&quot; : &quot;DESKTOP-DAT3C0S&quot;,</span><br><span class="line">  &quot;cluster_name&quot; : &quot;elasticsearch&quot;,</span><br><span class="line">  &quot;cluster_uuid&quot; : &quot;MvTkTMswQOWrqRV5IOGaPg&quot;,</span><br><span class="line">  &quot;version&quot; : &#123;</span><br><span class="line">    &quot;number&quot; : &quot;7.3.2&quot;,</span><br><span class="line">    &quot;build_flavor&quot; : &quot;default&quot;,</span><br><span class="line">    &quot;build_type&quot; : &quot;zip&quot;,</span><br><span class="line">    &quot;build_hash&quot; : &quot;1c1faf1&quot;,</span><br><span class="line">    &quot;build_date&quot; : &quot;2019-09-06T14:40:30.409026Z&quot;,</span><br><span class="line">    &quot;build_snapshot&quot; : false,</span><br><span class="line">    &quot;lucene_version&quot; : &quot;8.1.0&quot;,</span><br><span class="line">    &quot;minimum_wire_compatibility_version&quot; : &quot;6.8.0&quot;,</span><br><span class="line">    &quot;minimum_index_compatibility_version&quot; : &quot;6.0.0-beta1&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;tagline&quot; : &quot;You Know, for Search&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h2 id="2-2-部署Kibana"><a href="#2-2-部署Kibana" class="headerlink" title="2.2 部署Kibana"></a>2.2 部署Kibana</h2><p>解压kibana后进入bin目录</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/ElasticSearch1/2.png"
                     
                ></p>
<p>双击启动Kibana，Kibana默认连接的是ES的9200断开，Kibana的断开默认是5601</p>
<p>我们打开浏览器，访问<a class="link"   target="_blank" rel="noopener" href="http://localhost:5601/" >http://localhost:5601 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/ElasticSearch1/3.png"
                     
                ></p>
<p>我们进入<code>Dev Tools</code>面板：</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/ElasticSearch1/104.png"
                     
                ></p>
<h2 id="2-3-部署head插件"><a href="#2-3-部署head插件" class="headerlink" title="2.3 部署head插件"></a>2.3 部署head插件</h2><p><strong>步骤 1：</strong></p>
<p>下载 head插件：<a class="link"   target="_blank" rel="noopener" href="https://github.com/mobz/elasticsearch-head" >https://github.com/mobz/elasticsearch-head <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a> 配套资料中已提供。</p>
<p>elasticsearch-head-master.zip</p>
<p><strong>步骤 2：</strong></p>
<p>解压到任意目录，但是要和 elasticsearch 的安装目录区别开。</p>
<p><strong>步骤 3：</strong></p>
<p>安装 node js ,安装 cnpm</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install -g cnpm --registry=https://registry.npm.taobao.org</span><br></pre></td></tr></table></figure></div>

<p><strong>步骤 4：</strong></p>
<p>grunt 安装为全局命令 。Grunt 是基于 Node.js的项目构建工具。它可以自动运行你所设定的任务</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cnpm install -g grunt-cli</span><br></pre></td></tr></table></figure></div>

<p><strong>步骤 5：安装依赖</strong></p>
<p>进入 head 目录执行安装命令，在命令提示符下输入命令</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cnpm install</span><br></pre></td></tr></table></figure></div>

<p><strong>步骤 6：</strong></p>
<p>进入 head 目录启动 head，在命令提示符下输入命令</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grunt server</span><br></pre></td></tr></table></figure></div>

<p><strong>步骤 7：</strong></p>
<p>打开浏览器，输入 <a class="link"   target="_blank" rel="noopener" href="http://localhost:9100/" >http://localhost:9100 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<p><strong>步骤 8：</strong></p>
<p>点击连接按钮没有任何相应，按 F12 发现有如下错误</p>
<p>No ‘Access-Control-Allow-Origin’ header is present on the requested resource</p>
<p>这个错误是由于 elasticsearch 默认不允许跨域调用，而 elasticsearch-head是属于前端工程，所以报错。</p>
<p>我们这时需要修改 elasticsearch 的配置，让其允许跨域访问。修改 elasticsearch 配置文件：elasticsearch.yml，增加以下两句命令：</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">http.cors.enabled: true</span><br><span class="line"></span><br><span class="line">http.cors.allow-origin: &quot;*&quot;</span><br></pre></td></tr></table></figure></div>

<p>此步为允许 elasticsearch 跨越访问 点击连接即可看到相关信息</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/ElasticSearch1/5.png"
                     
                ></p>
<h1 id="三、ElasticSearch基本语法"><a href="#三、ElasticSearch基本语法" class="headerlink" title="三、ElasticSearch基本语法"></a>三、ElasticSearch基本语法</h1><h2 id="3-1-CURL语法"><a href="#3-1-CURL语法" class="headerlink" title="3.1 CURL语法"></a>3.1 CURL语法</h2><p>所有其他语言可以使用 RESTful API 通过端口 9200 和 Elasticsearch 进行通信，你可以用你最喜爱的 web 客户端访问 Elasticsearch 。事实上，正如你所看到的，你甚至可以使用 <code>curl</code> 命令来和 Elasticsearch 交互。</p>
<p>一个 Elasticsearch 请求和任何 HTTP 请求一样由若干相同的部件组成：</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -X&lt;VERB&gt; &#x27;&lt;PROTOCOL&gt;://&lt;HOST&gt;:&lt;PORT&gt;/&lt;PATH&gt;?&lt;QUERY_STRING&gt;&#x27; -d &#x27;&lt;BODY&gt;&#x27;</span><br></pre></td></tr></table></figure></div>

<table>
<thead>
<tr>
<th><code>VERB</code></th>
<th>适当的 HTTP 方法 : <code>GET</code>、 <code>POST</code>、 <code>PUT</code>、 <code>HEAD</code> 或者 <code>DELETE</code>。</th>
</tr>
</thead>
<tbody><tr>
<td><strong><code>PROTOCOL</code></strong></td>
<td><strong><code>http</code> 或者 <code>https</code>（如果你在 Elasticsearch 前面有一个 <code>https</code> 代理）</strong></td>
</tr>
<tr>
<td><strong><code>HOST</code></strong></td>
<td><strong>Elasticsearch 集群中任意节点的主机名，或者用 <code>localhost</code> 代表本地机器上的节点。</strong></td>
</tr>
<tr>
<td><strong><code>PORT</code></strong></td>
<td><strong>运行 Elasticsearch HTTP 服务的端口号，默认是 <code>9200</code> 。</strong></td>
</tr>
<tr>
<td><strong><code>PATH</code></strong></td>
<td><strong>API 的终端路径（例如 <code>_count</code> 将返回集群中文档数量）。Path 可能包含多个组件，例如：<code>_cluster/stats</code> 和 <code>_nodes/stats/jvm</code> 。</strong></td>
</tr>
<tr>
<td><strong><code>QUERY_STRING</code></strong></td>
<td><strong>任意可选的查询字符串参数 (例如 <code>?pretty</code> 将格式化地输出 JSON 返回值，使其更容易阅读)</strong></td>
</tr>
<tr>
<td><strong><code>BODY</code></strong></td>
<td><strong>一个 JSON 格式的请求体 (如果请求需要的话)</strong></td>
</tr>
</tbody></table>
<h3 id="3-1-1-使用curl访问ES："><a href="#3-1-1-使用curl访问ES：" class="headerlink" title="3.1.1 使用curl访问ES："></a>3.1.1 使用curl访问ES：</h3><div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http://localhost:9200/</span><br></pre></td></tr></table></figure></div>

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/ElasticSearch1/6.png"
                     
                ></p>
<h3 id="3-1-2-查看集群的健康状态："><a href="#3-1-2-查看集群的健康状态：" class="headerlink" title="3.1.2 查看集群的健康状态："></a>3.1.2 查看集群的健康状态：</h3><div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl localhost:9200/_cat/health?v</span><br></pre></td></tr></table></figure></div>

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/ElasticSearch1/7.png"
                     
                ></p>
<blockquote>
<p><code>http:</code>可以省略</p>
</blockquote>
<h3 id="3-1-3-查看集群节点列表："><a href="#3-1-3-查看集群节点列表：" class="headerlink" title="3.1.3 查看集群节点列表："></a>3.1.3 查看集群节点列表：</h3><div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl localhost:9200/_cat/nodes?v</span><br></pre></td></tr></table></figure></div>

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/ElasticSearch1/8.png"
                     
                ></p>
<h3 id="3-1-4-查看所有的索引："><a href="#3-1-4-查看所有的索引：" class="headerlink" title="3.1.4 查看所有的索引："></a>3.1.4 查看所有的索引：</h3><div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl localhost:9200/_cat/indices?v</span><br></pre></td></tr></table></figure></div>

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/ElasticSearch1/9.png"
                     
                ></p>
<h3 id="3-1-5-创建索引："><a href="#3-1-5-创建索引：" class="headerlink" title="3.1.5 创建索引："></a>3.1.5 创建索引：</h3><div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">curl -XPUT localhost:9200/articleindex?pretty</span><br><span class="line">&#123;</span><br><span class="line">  &quot;acknowledged&quot; : true,</span><br><span class="line">  &quot;shards_acknowledged&quot; : true</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<blockquote>
<p>参数pretty代表格式化返回结果</p>
</blockquote>
<h3 id="3-1-6-添加文档："><a href="#3-1-6-添加文档：" class="headerlink" title="3.1.6 添加文档："></a>3.1.6 添加文档：</h3><p>POST和PUT方式都可以创建文档</p>
<ul>
<li>POST方式：</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">curl -XPOST localhost:9200/articleindex/article/1?pretty -H &quot;Content-Type:application/json&quot; -d &quot;&#123;\&quot;title\&quot;:\&quot;es\&quot;,\&quot;content\&quot;:\&quot;es is very goods\&quot;&#125;&quot;</span><br><span class="line">&#123;</span><br><span class="line">  &quot;_index&quot; : &quot;articleindex&quot;,</span><br><span class="line">  &quot;_type&quot; : &quot;article&quot;,</span><br><span class="line">  &quot;_id&quot; : &quot;1&quot;,</span><br><span class="line">  &quot;_version&quot; : 1,</span><br><span class="line">  &quot;result&quot; : &quot;created&quot;,</span><br><span class="line">  &quot;_shards&quot; : &#123;</span><br><span class="line">    &quot;total&quot; : 2,</span><br><span class="line">    &quot;successful&quot; : 1,</span><br><span class="line">    &quot;failed&quot; : 0</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;created&quot; : true</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<ul>
<li>PUT方式：</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">curl -XPUT localhost:9200/articleindex/article/2?pretty -H &quot;Content-Type:application/json&quot; -d &quot;&#123;\&quot;title\&quot;:\&quot;solr\&quot;,\&quot;content\&quot;:\&quot;what is solr\&quot;&#125;&quot;</span><br><span class="line">&#123;</span><br><span class="line">  &quot;_index&quot; : &quot;articleindex&quot;,</span><br><span class="line">  &quot;_type&quot; : &quot;article&quot;,</span><br><span class="line">  &quot;_id&quot; : &quot;2&quot;,</span><br><span class="line">  &quot;_version&quot; : 1,</span><br><span class="line">  &quot;result&quot; : &quot;created&quot;,</span><br><span class="line">  &quot;_shards&quot; : &#123;</span><br><span class="line">    &quot;total&quot; : 2,</span><br><span class="line">    &quot;successful&quot; : 1,</span><br><span class="line">    &quot;failed&quot; : 0</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;created&quot; : true</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="3-1-7-查询文档："><a href="#3-1-7-查询文档：" class="headerlink" title="3.1.7 查询文档："></a>3.1.7 查询文档：</h3><div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET localhost:9200/articleindex/article/1?pretty</span><br><span class="line">&#123;</span><br><span class="line">  &quot;_index&quot; : &quot;articleindex&quot;,</span><br><span class="line">  &quot;_type&quot; : &quot;article&quot;,</span><br><span class="line">  &quot;_id&quot; : &quot;1&quot;,</span><br><span class="line">  &quot;_version&quot; : 1,</span><br><span class="line">  &quot;found&quot; : true,</span><br><span class="line">  &quot;_source&quot; : &#123;</span><br><span class="line">    &quot;title&quot; : &quot;solr&quot;,</span><br><span class="line">    &quot;content&quot; : &quot;what is solr&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="3-1-8-修改文档："><a href="#3-1-8-修改文档：" class="headerlink" title="3.1.8 修改文档："></a>3.1.8 修改文档：</h3><div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">curl -XPUT localhost:9200/articleindex/article/2?pretty -H &quot;Content-Type:application/json&quot; -d &quot;&#123;\&quot;title\&quot;:\&quot;solr\&quot;,\&quot;content\&quot;:\&quot;solr is very good\&quot;&#125;&quot;</span><br><span class="line">&#123;</span><br><span class="line">  &quot;_index&quot; : &quot;articleindex&quot;,</span><br><span class="line">  &quot;_type&quot; : &quot;article&quot;,</span><br><span class="line">  &quot;_id&quot; : &quot;2&quot;,</span><br><span class="line">  &quot;_version&quot; : 2,</span><br><span class="line">  &quot;result&quot; : &quot;updated&quot;,</span><br><span class="line">  &quot;_shards&quot; : &#123;</span><br><span class="line">    &quot;total&quot; : 2,</span><br><span class="line">    &quot;successful&quot; : 1,</span><br><span class="line">    &quot;failed&quot; : 0</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;created&quot; : false</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="3-1-9-删除文档："><a href="#3-1-9-删除文档：" class="headerlink" title="3.1.9 删除文档："></a>3.1.9 删除文档：</h3><div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">curl -XDELETE localhost:9200/articleindex/article/1/?pretty</span><br><span class="line">&#123;</span><br><span class="line">  &quot;found&quot; : true,</span><br><span class="line">  &quot;_index&quot; : &quot;articleindex&quot;,</span><br><span class="line">  &quot;_type&quot; : &quot;article&quot;,</span><br><span class="line">  &quot;_id&quot; : &quot;1&quot;,</span><br><span class="line">  &quot;_version&quot; : 2,</span><br><span class="line">  &quot;result&quot; : &quot;deleted&quot;,</span><br><span class="line">  &quot;_shards&quot; : &#123;</span><br><span class="line">    &quot;total&quot; : 2,</span><br><span class="line">    &quot;successful&quot; : 1,</span><br><span class="line">    &quot;failed&quot; : 0</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="3-1-10-删除索引："><a href="#3-1-10-删除索引：" class="headerlink" title="3.1.10 删除索引："></a>3.1.10 删除索引：</h3><div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">curl -XDELETE localhost:9200/articleindex?pretty</span><br><span class="line">&#123;</span><br><span class="line">  &quot;acknowledged&quot; : true</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h2 id="3-2-使用Kibana完成增删改查"><a href="#3-2-使用Kibana完成增删改查" class="headerlink" title="3.2 使用Kibana完成增删改查"></a>3.2 使用Kibana完成增删改查</h2><ul>
<li>查看集群监控值：</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /_cat/nodes?v</span><br></pre></td></tr></table></figure></div>

<blockquote>
<p>Kibana不需要写完整的curl 语法</p>
</blockquote>
<ul>
<li>查看集群节点列表：</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /_cat/nodes?v</span><br></pre></td></tr></table></figure></div>

<ul>
<li>查看所有的索引：</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /_cat/indices?v</span><br></pre></td></tr></table></figure></div>

<ul>
<li>创建索引：</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PUT articleindex</span><br></pre></td></tr></table></figure></div>

<ul>
<li>POST添加文档：</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">POST articleindex/article</span><br><span class="line">&#123;</span><br><span class="line">  &quot;title&quot;:&quot;solr&quot;,</span><br><span class="line">  &quot;content&quot;:&quot;what is solr?&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<ul>
<li>PUT添加文档</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">PUT articleindex/article/2</span><br><span class="line">&#123;</span><br><span class="line">  &quot;title&quot;:&quot;es&quot;,</span><br><span class="line">  &quot;content&quot;:&quot;es is very good&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<ul>
<li>查询文档：</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET articleindex/article/2</span><br></pre></td></tr></table></figure></div>

<ul>
<li>修改文档：</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">PUT articleindex/article/2</span><br><span class="line">&#123;</span><br><span class="line">  &quot;title&quot;:&quot;es&quot;,</span><br><span class="line">  &quot;content&quot;:&quot;what is es?&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<ul>
<li>删除文档：</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DELETE articleindex/article/2</span><br></pre></td></tr></table></figure></div>

<ul>
<li>删除索引：</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DELETE articleindex</span><br></pre></td></tr></table></figure></div>

<h1 id="四、ElasticSearch-查询API"><a href="#四、ElasticSearch-查询API" class="headerlink" title="四、ElasticSearch 查询API"></a>四、ElasticSearch 查询API</h1><p>准备测试数据：</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">POST /goodsindex/goods/1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;name&quot;:&quot;huawei shouji&quot;,</span><br><span class="line">  &quot;title&quot;:&quot;huawei 4G quanmianping youxi shouji&quot;,</span><br><span class="line">  &quot;price&quot;:4899,</span><br><span class="line">  &quot;category&quot;:[&quot;youxi&quot;,&quot;4G&quot;,&quot;quanmianping&quot;]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST /goodsindex/goods/2</span><br><span class="line">&#123;</span><br><span class="line">  &quot;name&quot;:&quot;vivo shouji&quot;,</span><br><span class="line">  &quot;title&quot;:&quot;vivo 5G paizhao shouji&quot;,</span><br><span class="line">  &quot;price&quot;:2899,</span><br><span class="line">  &quot;category&quot;:[&quot;5G&quot;,&quot;paizhao&quot;]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST /goodsindex/goods/3</span><br><span class="line">&#123;</span><br><span class="line">  &quot;name&quot;:&quot;oppo shouji&quot;,</span><br><span class="line">  &quot;title&quot;:&quot;oppo 5G paizhao shouji&quot;,</span><br><span class="line">  &quot;price&quot;:1899,</span><br><span class="line">  &quot;category&quot;:[&quot;5G&quot;,&quot;paizhao&quot;]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST /goodsindex/goods/4</span><br><span class="line">&#123;</span><br><span class="line">  &quot;name&quot;:&quot;huawei shouji&quot;,</span><br><span class="line">  &quot;title&quot;:&quot;huawei 5G youxi shouji&quot;,</span><br><span class="line">  &quot;price&quot;:3899,</span><br><span class="line">  &quot;category&quot;:[&quot;5G&quot;,&quot;youxi&quot;]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST /goodsindex/goods/5</span><br><span class="line">&#123;</span><br><span class="line">  &quot;name&quot;:&quot;xiaomi shouji&quot;,</span><br><span class="line">  &quot;title&quot;:&quot;xiaomi 4G youxi shouji&quot;,</span><br><span class="line">  &quot;price&quot;:988,</span><br><span class="line">  &quot;category&quot;:[&quot;youxi&quot;,&quot;4G&quot;]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST /goodsindex/goods/6</span><br><span class="line">&#123;</span><br><span class="line">  &quot;name&quot;:&quot;xiaomi shouji&quot;,</span><br><span class="line">  &quot;title&quot;:&quot;xiaomi 5G youxi qumianping shouji&quot;,</span><br><span class="line">  &quot;price&quot;:1899,</span><br><span class="line">  &quot;category&quot;:[&quot;youxi&quot;,&quot;5G&quot;,&quot;qumianping&quot;]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST /goodsindex/goods/7</span><br><span class="line">&#123;</span><br><span class="line">  &quot;name&quot;:&quot;xiaomi shouji&quot;,</span><br><span class="line">  &quot;title&quot;:&quot;xiaomi 5G youxi shouji&quot;,</span><br><span class="line">  &quot;price&quot;:1299,</span><br><span class="line">  &quot;category&quot;:[&quot;youxi&quot;,&quot;5G&quot;]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST /goodsindex/goods/8</span><br><span class="line">&#123;</span><br><span class="line">  &quot;name&quot;:&quot;xiaomi shouji&quot;,</span><br><span class="line">  &quot;title&quot;:&quot;xiaomi 4G shouji&quot;,</span><br><span class="line">  &quot;price&quot;:869,</span><br><span class="line">  &quot;category&quot;:[&quot;4G&quot;]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST /goodsindex/goods/9</span><br><span class="line">&#123;</span><br><span class="line">  &quot;name&quot;:&quot;huawei shouji&quot;,</span><br><span class="line">  &quot;title&quot;:&quot;huawei 5G zhineng qumianping shouji&quot;,</span><br><span class="line">  &quot;price&quot;:2899,</span><br><span class="line">  &quot;category&quot;:[&quot;zhineng&quot;,&quot;5G&quot;,&quot;qumianping&quot;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h2 id="4-1-string-search"><a href="#4-1-string-search" class="headerlink" title="4.1 string search"></a>4.1 string search</h2><ul>
<li>查询全部：</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET goodsindex/goods/_search</span><br></pre></td></tr></table></figure></div>

<p>拿出部分数据分析：</p>
<div class="highlight-container" data-rel="Json"><figure class="iseeu highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">#! Deprecation<span class="punctuation">:</span> <span class="punctuation">[</span>types removal<span class="punctuation">]</span> Specifying types in search requests is deprecated.</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;took&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;timed_out&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_shards&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;total&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;successful&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;skipped&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;failed&quot;</span> <span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;hits&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;total&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;value&quot;</span> <span class="punctuation">:</span> <span class="number">9</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;relation&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;eq&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;max_score&quot;</span> <span class="punctuation">:</span> <span class="number">1.0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;hits&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;_index&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;goodsindex&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;goods&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_score&quot;</span> <span class="punctuation">:</span> <span class="number">1.0</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_source&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;name&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;huawei shouji&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;title&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;huawei 4G quanmianping youxi shouji&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;price&quot;</span> <span class="punctuation">:</span> <span class="number">4899</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;category&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="string">&quot;youxi&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;4G&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;quanmianping&quot;</span></span><br><span class="line">          <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        ......</span><br></pre></td></tr></table></figure></div>

<ul>
<li><code>took</code>：响应的时间（单位毫秒）</li>
<li><code>timed_out</code>：响应是否超时</li>
<li><code>_shards</code>：该索引的分片情况，分成了1个shard（在ES7.0之前，所有的索引默认是分配10个shard，每一个Primry shard 都分配一个replica shrad）</li>
<li><code>hits.total</code>：共查询到了几个文档</li>
<li><code>hits.max_score</code>：查询到的文档中，分值最高的值。</li>
<li><code>hits.hits</code>：文档的详细数据</li>
</ul>
<p>查询手机标题中包含有”huawei”的数据：</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET goodsindex/goods/_search?q=title:huawei</span><br></pre></td></tr></table></figure></div>

<p>查询手机标题中包含”4G”并且按价格降序排序：</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET goodsindex/goods/_search?q=title:4G&amp;sort=price:desc</span><br></pre></td></tr></table></figure></div>

<p>查询手机标题中包含”shouji”并且按价格降序排序并且分页：</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET goodsindex/goods/_search?q=title:shouji&amp;sort=price:desc&amp;from=1&amp;size=2</span><br></pre></td></tr></table></figure></div>

<ul>
<li>from：跳过前面几条数据</li>
<li>size：查询几条数据（页大小）</li>
</ul>
<h2 id="4-2-query-DSL"><a href="#4-2-query-DSL" class="headerlink" title="4.2 query DSL"></a>4.2 query DSL</h2><p>DSL：Domain Specified Language，领域特定语言</p>
<ul>
<li>查询所有商品：</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">GET goodsindex/goods/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match_all&quot;: &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<ul>
<li>查询商品标题中包含有”youxi”的所有商品，并且按照价格降序排序。</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">GET goodsindex/goods/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match&quot;: &#123;</span><br><span class="line">      &quot;title&quot;: &quot;shouji&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;sort&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;price&quot;: &#123;</span><br><span class="line">        &quot;order&quot;: &quot;desc&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<ul>
<li>分页查询：</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET goodsindex/goods/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match_all&quot;: &#123;&#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;from&quot;: 0,</span><br><span class="line">  &quot;size&quot;: 2</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<ul>
<li>执行查询title和price字段：</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">GET goodsindex/goods/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match_all&quot;: &#123;&#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;_source&quot;: [&quot;title&quot;,&quot;price&quot;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h2 id="4-3-query-filter"><a href="#4-3-query-filter" class="headerlink" title="4.3 query filter"></a>4.3 query filter</h2><ul>
<li>1）查询title包含”huawei”但不包含”youxi”的手机</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">GET goodsindex/goods/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;bool&quot;: &#123;</span><br><span class="line">      &quot;must&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;match&quot;: &#123;</span><br><span class="line">            &quot;title&quot;: &quot;huawei&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br><span class="line">      &quot;must_not&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;match&quot;: &#123;</span><br><span class="line">            &quot;title&quot;: &quot;youxi&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>



<blockquote>
<p>Tips：query filter包含must、filter、should、must_not等查询条件</p>
</blockquote>
<ul>
<li>2）查询title包含”shouji”但不包含”youxi”的手机，在结果中筛选出”vivo”的手机</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">GET goodsindex/goods/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;:&#123;</span><br><span class="line">    &quot;bool&quot;: &#123;</span><br><span class="line">      &quot;must&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;match&quot;: &#123;</span><br><span class="line">            &quot;title&quot;: &quot;shouji&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br><span class="line">      &quot;must_not&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;match&quot;: &#123;</span><br><span class="line">            &quot;title&quot;: &quot;youxi&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br><span class="line">      &quot;filter&quot;: &#123;</span><br><span class="line">        &quot;term&quot;: &#123;</span><br><span class="line">          &quot;title&quot;: &quot;vivo&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h2 id="4-4-phrase-search"><a href="#4-4-phrase-search" class="headerlink" title="4.4 phrase search"></a>4.4 phrase search</h2><p><code>phrase search</code>：也叫短语搜索，需要结果中包含搜索条件<strong>所有的分词，而且顺序要求一样。</strong></p>
<p>以<code>huawei 5G</code>为例，要求结果中必须包含<code>huawei</code>和<code>5G</code>，而且还要求他们是连着的，顺序也是固定的，<code>huawei youxi 5G</code>不满足，<code>5G huawei</code>也不满足条件。</p>
<p>查询商品中标题包含”huawei 5G”的商品</p>
<ul>
<li>使用string search查询：</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET goodsindex/goods/_search?q=title:huawei 5G</span><br></pre></td></tr></table></figure></div>

<ul>
<li>使用DSL查询：</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET goodsindex/goods/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match&quot;: &#123;</span><br><span class="line">      &quot;title&quot;: &quot;huawei 5G&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<ul>
<li>使用filter查询：</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">GET goodsindex/goods/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;bool&quot;: &#123;</span><br><span class="line">      &quot;must&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;match&quot;: &#123;</span><br><span class="line">            &quot;title&quot;: &quot;huawei 5G&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<ul>
<li>使用phrase search：</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET goodsindex/goods/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match_phrase&quot;: &#123;</span><br><span class="line">      &quot;title&quot;: &quot;huawei 5G&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>查询结果：</p>
<div class="highlight-container" data-rel="Json"><figure class="iseeu highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">#! Deprecation<span class="punctuation">:</span> <span class="punctuation">[</span>types removal<span class="punctuation">]</span> Specifying types in search requests is deprecated.</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;took&quot;</span> <span class="punctuation">:</span> <span class="number">10</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;timed_out&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_shards&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;total&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;successful&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;skipped&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;failed&quot;</span> <span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;hits&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;total&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;value&quot;</span> <span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;relation&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;eq&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;max_score&quot;</span> <span class="punctuation">:</span> <span class="number">1.5131856</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;hits&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;_index&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;goodsindex&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;goods&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;4&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_score&quot;</span> <span class="punctuation">:</span> <span class="number">1.5131856</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_source&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;name&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;huawei shouji&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;title&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;huawei 5G youxi shouji&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;price&quot;</span> <span class="punctuation">:</span> <span class="number">3899</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;category&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="string">&quot;5G&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;youxi&quot;</span></span><br><span class="line">          <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;_index&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;goodsindex&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;goods&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;9&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_score&quot;</span> <span class="punctuation">:</span> <span class="number">1.3768474</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_source&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;name&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;huawei shouji&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;title&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;huawei 5G zhineng qumianping shouji&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;price&quot;</span> <span class="punctuation">:</span> <span class="number">2899</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;category&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="string">&quot;zhineng&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;5G&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;qumianping&quot;</span></span><br><span class="line">          <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></div>

<h2 id="4-5-term-query"><a href="#4-5-term-query" class="headerlink" title="4.5 term query"></a>4.5 term query</h2><p>term查询属于精确查询，不会对查询的条件进行分词，<strong>但在查询单个词的时候与match查询是等价的。</strong></p>
<p>例如在查询<code>huawei</code>这个词的时候，那么term查询与match查询是一样的结果，但是如果查询<code>huawei 5G</code>，结果完全不同，因为term查询不会对<code>huawei 5G</code>这个词进行分词，而是查询词库是否有<code>huawei 5G</code>这个词，match查询则会把<code>huawei 5G</code>拆分成<code>huawei</code>和<code>5G</code>分别在词库中查询</p>
<ul>
<li>查询条件为<code>huawei</code></li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">GET goodsindex/goods/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;term&quot;: &#123;</span><br><span class="line">      &quot;title&quot;:&quot;huawei&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GET goodsindex/goods/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match&quot;: &#123;</span><br><span class="line">      &quot;title&quot;:&quot;huawei&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<blockquote>
<p>查询结果发现他们是等价的</p>
</blockquote>
<ul>
<li>查询条件为<code>huawei 5G</code></li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">GET goodsindex/goods/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;term&quot;: &#123;</span><br><span class="line">      &quot;title&quot;:&quot;huawei 5G&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GET goodsindex/goods/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match&quot;: &#123;</span><br><span class="line">      &quot;title&quot;:&quot;huawei 5G&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<blockquote>
<p>term查询没有记录，match查询不仅huawei 5G出来了，xiaomi 5G也会查询出来</p>
</blockquote>
<h2 id="4-6-query-string"><a href="#4-6-query-string" class="headerlink" title="4.6 query string"></a>4.6 query string</h2><p><code>query_string</code>：和match查询类似，都会对搜索条件进行分词，不同的是match需要指定字段名，query string 可以选择多个字段进行查询，范围更广泛。</p>
<ul>
<li><code>default_field	</code>：默认查询的字段</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">GET goodsindex/goods/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;query_string&quot;: &#123;</span><br><span class="line">      &quot;default_field&quot;: &quot;title&quot;,</span><br><span class="line">      &quot;query&quot;: &quot;huawei&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<hr>


<ul>
<li><code>fields</code>：查询的多个字段</li>
</ul>
<p>添加一篇文档：</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">POST /goodsindex/goods/10</span><br><span class="line">&#123;</span><br><span class="line">  &quot;name&quot;:&quot;youxi shouji&quot;,</span><br><span class="line">  &quot;title&quot;:&quot;xiaomi 5G shouji&quot;,</span><br><span class="line">  &quot;price&quot;:2899,</span><br><span class="line">  &quot;category&quot;:[&quot;youxi&quot;,&quot;5G&quot;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>执行查询：</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">GET goodsindex/goods/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;query_string&quot;: &#123;</span><br><span class="line">      &quot;fields&quot;: [&quot;name&quot;,&quot;title&quot;],</span><br><span class="line">      &quot;query&quot;: &quot;youxi 5G&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<blockquote>
<p>查询name或者title域中有youxi或者5G的商品</p>
</blockquote>
<ul>
<li><code>default_operator</code>：默认运算符，取值为AND、OR；默认为OR</li>
</ul>
<p>AND代表文档字段必须包含<code>youxi</code>和<code>5G</code>两个词，OR代表只需包含<code>youxi</code>或<code>5G</code>其中一个词即可</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">GET goodsindex/goods/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;query_string&quot;: &#123;</span><br><span class="line">      &quot;fields&quot;: [&quot;title&quot;],</span><br><span class="line">      &quot;query&quot;: &quot;youxi 5G&quot;,</span><br><span class="line">      &quot;default_operator&quot;: &quot;AND&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<hr>


<ul>
<li><code>minimum_should_match</code>：最少匹配词条</li>
</ul>
<p>搜索<code>huawei youxi qumianping</code>，如果<code>minimum_should_match</code>为2，那么代表必须匹配查询条件中的其中两个词</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">GET goodsindex/goods/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;query_string&quot;: &#123;</span><br><span class="line">      &quot;fields&quot;: [&quot;title&quot;],</span><br><span class="line">      &quot;query&quot;: &quot;huawei youxi 4G&quot;,</span><br><span class="line">      &quot;minimum_should_match&quot;: 2</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<hr>


<ul>
<li>模糊查询</li>
</ul>
<p>query string 也支持模糊查询</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET goodsindex/goods/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;query_string&quot;: &#123;</span><br><span class="line">      &quot;query&quot;: &quot;title:huawkk~&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>query string的模糊查询并不是与MySQL中的like模糊一样，<code>query string</code>允许可以在~后面加个数字来指定允许错误几个字母。<strong>最大和默认模糊字符为2</strong></p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET goodsindex/goods/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;query_string&quot;: &#123;</span><br><span class="line">      &quot;query&quot;: &quot;title:huawek~1&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<hr>


<ul>
<li>range范围查询</li>
</ul>
<p>范围查询包含：</p>
<p>日期：date:[2018-10-10 TO 2020-10-10]：查询date为2018-10-10（包含） 到 2020-10-10（包含）之间的数据</p>
<p>数值：count:[1 TO 5}： 查询count为1（包含）到5（不含）之间的数据</p>
<p>数值：count:[10 TO *]：出现啊count为10（包含）到无穷大的数据</p>
<p>数值：age:&gt;10：查询age大于10的数据</p>
<p>数值：age:&lt;&#x3D;10：查询age小于等于10的数据</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">GET goodsindex/goods/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;query_string&quot;: &#123;</span><br><span class="line">      &quot;query&quot;: &quot;price:&gt;3000&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GET goodsindex/goods/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;query_string&quot;: &#123;</span><br><span class="line">      &quot;query&quot;: &quot;price[2000 TO 3000]&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<hr>


<ul>
<li>运算符操作：</li>
</ul>
<p><code>+</code>：代表一定要出现：类似must。</p>
<p><code>-</code>：代表一定不能包含：类似must_not</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">GET goodsindex/goods/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;query_string&quot;: &#123;</span><br><span class="line">      &quot;query&quot;: &quot;-vivo -youxi +5G&quot;,</span><br><span class="line">      &quot;fields&quot;: [&quot;title&quot;]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>含义：查询title字段中，不能有vivo分词、youxi分词，必须包含5G分词</p>
<h2 id="4-7-highlight-search"><a href="#4-7-highlight-search" class="headerlink" title="4.7 highlight search"></a>4.7 highlight search</h2><p>highlight search也叫高亮搜索，把一些关键词进行高亮。</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">GET goodsindex/goods/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match&quot;: &#123;</span><br><span class="line">      &quot;title&quot;: &quot;huawei&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;highlight&quot;: &#123;</span><br><span class="line">    &quot;fields&quot;: &#123;</span><br><span class="line">      &quot;title&quot;: &#123;&#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;pre_tags&quot;: &quot;&lt;font&gt;&quot;,</span><br><span class="line">    &quot;post_tags&quot;: &quot;&lt;/font&gt;&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<ul>
<li>highlight：设置高亮字段</li>
<li>pre_tags：高亮前缀</li>
<li>post_tags：高亮后缀</li>
</ul>
<p>多字段高亮：</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">GET goodsindex/goods/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;query_string&quot;: &#123;						# 使用query_string进行多字段查询</span><br><span class="line">      &quot;fields&quot;: [&quot;name&quot;,&quot;title&quot;],</span><br><span class="line">      &quot;query&quot;: &quot;shouji&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;highlight&quot;: &#123;</span><br><span class="line">    &quot;fields&quot;: &#123;</span><br><span class="line">      &quot;title&quot;: &#123;&#125;,</span><br><span class="line">      &quot;name&quot;:&#123;&#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;pre_tags&quot;: &quot;&lt;font&gt;&quot;,</span><br><span class="line">    &quot;post_tags&quot;: &quot;&lt;/font&gt;&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure></div>

<h2 id="4-8-聚合搜索"><a href="#4-8-聚合搜索" class="headerlink" title="4.8 聚合搜索"></a>4.8 聚合搜索</h2><p>在ES中，在查询text类型的字段使用一种叫fieldata的内存数据结构存储，当字段被排序，聚合或者通过脚本访问时这种数据结构会被创建。它是通过从磁盘读取每个段的整个反向索引来构建的，然后存存储在java的堆内存中。</p>
<p>我们在做聚合操作时，需要开启fileddata</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">PUT /goodsindex/_mapping/goods?include_type_name=true</span><br><span class="line">&#123;</span><br><span class="line">  &quot;properties&quot;: &#123;</span><br><span class="line">    &quot;category&quot;: &#123;</span><br><span class="line">      &quot;type&quot;: &quot;text&quot;,</span><br><span class="line">      &quot;fielddata&quot;: true</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>需求一：计算每个分类下的商品数量</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">GET goodsindex/goods/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;size&quot;: 0, </span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;group_by_category&quot;: &#123;</span><br><span class="line">      &quot;terms&quot;: &#123;</span><br><span class="line">        &quot;field&quot;: &quot;category&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<ul>
<li>size代表取原始数据的条数，0代表不要原始数据</li>
</ul>
<p>需求二：先分组，再算每组的平均值，计算每个category下的商品的平均价格</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">GET /goodsindex/goods/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;size&quot;: 0, </span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;group_by_category&quot;: &#123;</span><br><span class="line">      &quot;terms&quot;: &#123;</span><br><span class="line">        &quot;field&quot;: &quot;category&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;aggs&quot;: &#123;</span><br><span class="line">        &quot;avg_price&quot;: &#123;</span><br><span class="line">          &quot;avg&quot;: &#123;</span><br><span class="line">            &quot;field&quot;: &quot;price&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>



<p>需求三：计算每个category下的商品的平均价格，并且按照平均价格降序排序</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">GET /goodsindex/goods/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;size&quot;: 0, </span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;group_by_category&quot;: &#123;</span><br><span class="line">      &quot;terms&quot;: &#123;</span><br><span class="line">        &quot;field&quot;: &quot;category&quot;,</span><br><span class="line">        &quot;order&quot;: &#123;</span><br><span class="line">          &quot;avg_price&quot;: &quot;desc&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;aggs&quot;: &#123;</span><br><span class="line">        &quot;avg_price&quot;: &#123;</span><br><span class="line">          &quot;avg&quot;: &#123;</span><br><span class="line">            &quot;field&quot;: &quot;price&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>



<p>需求四：按照指定的价格范围区间进行分组，然后在每组内再按照category进行分组，最后再计算每组的平均价格</p>
<p>1000-2000块一组、2000-3000块一组、3000-5000块一组</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">GET /goodsindex/goods/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;size&quot;: 0,</span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;group_by_prce&quot;: &#123;</span><br><span class="line">      &quot;range&quot;: &#123;</span><br><span class="line">        &quot;field&quot;: &quot;price&quot;,</span><br><span class="line">        &quot;ranges&quot;: [</span><br><span class="line">          &#123;</span><br><span class="line">            &quot;from&quot;: 1000,</span><br><span class="line">            &quot;to&quot;: 2000</span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            &quot;from&quot;: 2000,</span><br><span class="line">            &quot;to&quot;: 3000</span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            &quot;from&quot;: 3000,</span><br><span class="line">            &quot;to&quot;: 5000</span><br><span class="line">          &#125;</span><br><span class="line">        ]</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;aggs&quot;: &#123;</span><br><span class="line">        &quot;avg_price&quot;: &#123;</span><br><span class="line">          &quot;avg&quot;: &#123;</span><br><span class="line">            &quot;field&quot;: &quot;price&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h2 id="4-9-搜索API"><a href="#4-9-搜索API" class="headerlink" title="4.9 搜索API"></a>4.9 搜索API</h2><table>
<thead>
<tr>
<th>参数</th>
<th>解释</th>
</tr>
</thead>
<tbody><tr>
<td>q</td>
<td>查询字符串，例如：q&#x3D;syslog</td>
</tr>
<tr>
<td>df</td>
<td>当查询中没有定义前缀的时候默认使用的字段。</td>
</tr>
<tr>
<td>analyzer</td>
<td>当分析查询字符串的时候使用的分词器</td>
</tr>
<tr>
<td>lowercase_expanded_terms</td>
<td>搜索的时候忽略大小写标志，默认为true</td>
</tr>
<tr>
<td>analyze_wildcard</td>
<td>通配符或者前缀查询是否被分析，默认false</td>
</tr>
<tr>
<td>default_operator</td>
<td>默认多个条件的关系，AND或者OR，默认OR</td>
</tr>
<tr>
<td>lenient</td>
<td>如果设置为true，字段类型转换失败的时候将被忽略，默认为false</td>
</tr>
<tr>
<td>explain</td>
<td>在每个返回结果中，将包含评分机制的解释</td>
</tr>
<tr>
<td>_source</td>
<td>是否包含元数据，同时支持_source_include 和_source_exclude</td>
</tr>
<tr>
<td>fields</td>
<td>只放回索引中指定的列，多个列中间用逗号分开</td>
</tr>
<tr>
<td>sort</td>
<td>排序，例如fieldName:asc或者fieldName:desc</td>
</tr>
<tr>
<td>track_scores</td>
<td>评分轨迹，当排序的时候，设置为true的时候返回评分的信息</td>
</tr>
<tr>
<td>timeout</td>
<td>超时的时间设置</td>
</tr>
<tr>
<td>terminate_after</td>
<td>在每个分片中查询的最大条数，如果设置返回结果中会有一个terminated_early字段</td>
</tr>
<tr>
<td>from</td>
<td>开始的记录数</td>
</tr>
<tr>
<td>size</td>
<td>搜索结果中的条数</td>
</tr>
<tr>
<td>search_type</td>
<td>搜索的类型，可以是dfs_query_then_fetch，query_then_fetch，默认query_then_fetch</td>
</tr>
</tbody></table>
<h1 id="五、Mapping-映射"><a href="#五、Mapping-映射" class="headerlink" title="五、Mapping 映射"></a>五、Mapping 映射</h1><h2 id="5-1-Mapping-简介"><a href="#5-1-Mapping-简介" class="headerlink" title="5.1 Mapping 简介"></a>5.1 Mapping 简介</h2><p>mapping映射是定义一个文档中的字段是采用什么类型存储、采用什么分词器进行分词，ES在创建一篇文档的时候，已经默认建立好了文档的mapping映射，我们可以通过命令查看：</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET goodsindex/goods/_mapping?include_type_name=true</span><br></pre></td></tr></table></figure></div>

<p>映射信息如下：</p>
<div class="highlight-container" data-rel="Json"><figure class="iseeu highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">#! Deprecation<span class="punctuation">:</span> <span class="punctuation">[</span>types removal<span class="punctuation">]</span> Using include_type_name in get mapping requests is deprecated. The parameter will be removed in the next major version.</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;goodsindex&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;mappings&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;goods&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;properties&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;category&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;text&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;fields&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span>					# 代表text字段中还有一个字段叫keyword</span><br><span class="line">              <span class="attr">&quot;keyword&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;ignore_above&quot;</span> <span class="punctuation">:</span> <span class="number">256</span></span><br><span class="line">              <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;fielddata&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;name&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;text&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;fields&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;keyword&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;ignore_above&quot;</span> <span class="punctuation">:</span> <span class="number">256</span></span><br><span class="line">              <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;price&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;long&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;title&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;text&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;fields&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;keyword&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;ignore_above&quot;</span> <span class="punctuation">:</span> <span class="number">256</span></span><br><span class="line">              <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure></div>

<blockquote>
<p>ES文档的text类型字段默认采用的分词器都是standard，keyword类型的字段采用的是keyword类型</p>
</blockquote>
<h3 id="5-1-1-动态映射"><a href="#5-1-1-动态映射" class="headerlink" title="5.1.1 动态映射"></a>5.1.1 动态映射</h3><p>ES会根据我们插入的字段数据来确定该字段使用的数据类型</p>
<ul>
<li>ES类型推测规则：</li>
</ul>
<p>true || false   –&gt; boolean</p>
<p>100     –&gt; long</p>
<p>100.45 –&gt; double</p>
<p>2019-11-11  –&gt; date</p>
<p>“hello world”   –&gt; text</p>
<h2 id="5-2-手动建立Mapping映射"><a href="#5-2-手动建立Mapping映射" class="headerlink" title="5.2 手动建立Mapping映射"></a>5.2 手动建立Mapping映射</h2><h3 id="5-2-1-查看索引的mapping映射"><a href="#5-2-1-查看索引的mapping映射" class="headerlink" title="5.2.1 查看索引的mapping映射"></a>5.2.1 查看索引的mapping映射</h3><p>我们可以通过kibnana查看索引的mapping映射</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET goodsindex/_mapping</span><br></pre></td></tr></table></figure></div>

<p>也可以在head插件中查看mapping映射</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/ElasticSearch1/10.png"
                     
                ></p>
<p>查看索引信息：</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/ElasticSearch1/11.png"
                     
                ></p>
<h3 id="5-2-2-手动建立mapping映射"><a href="#5-2-2-手动建立mapping映射" class="headerlink" title="5.2.2 手动建立mapping映射"></a>5.2.2 手动建立mapping映射</h3><p>mapping映射必须在创建文档之前建立好文档的mapping映射，mapping映射创建好后不可以修改</p>
<ul>
<li>删除goodsindex索引：</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DELETE goodsindex</span><br></pre></td></tr></table></figure></div>

<ul>
<li>创建mapping映射：</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">PUT goodsindex?include_type_name=true</span><br><span class="line">&#123;</span><br><span class="line">  &quot;mappings&quot;: &#123;</span><br><span class="line">    &quot;goods&quot;: &#123;</span><br><span class="line">      &quot;properties&quot;: &#123;</span><br><span class="line">        &quot;id&quot;:&#123;</span><br><span class="line">          &quot;type&quot;: &quot;text&quot;,</span><br><span class="line">          &quot;store&quot;: true,</span><br><span class="line">          &quot;index&quot;: true</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;name&quot;:&#123;</span><br><span class="line">          &quot;type&quot;: &quot;text&quot;,</span><br><span class="line">          &quot;store&quot;: true,</span><br><span class="line">          &quot;index&quot;: true,</span><br><span class="line">          &quot;analyzer&quot;: &quot;standard&quot;,</span><br><span class="line">          &quot;search_analyzer&quot;: &quot;standard&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;title&quot;:&#123;</span><br><span class="line">          &quot;type&quot;: &quot;text&quot;,</span><br><span class="line">          &quot;store&quot;: true,</span><br><span class="line">          &quot;index&quot;: true,</span><br><span class="line">          &quot;analyzer&quot;: &quot;standard&quot;,</span><br><span class="line">          &quot;search_analyzer&quot;: &quot;standard&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;price&quot;:&#123;</span><br><span class="line">          &quot;type&quot;: &quot;long&quot;,</span><br><span class="line">          &quot;store&quot;: true,</span><br><span class="line">          &quot;index&quot;: true</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;catetory&quot;:&#123;</span><br><span class="line">          &quot;fielddata&quot;: true, </span><br><span class="line">          &quot;type&quot;: &quot;text&quot;,</span><br><span class="line">          &quot;store&quot;: true,</span><br><span class="line">          &quot;index&quot;: true</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<ul>
<li>查看mapping映射：</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/ElasticSearch1/120.png"
                     
                ></p>
<h4 id="1）Text-文本类型"><a href="#1）Text-文本类型" class="headerlink" title="1）Text 文本类型"></a>1）Text 文本类型</h4><ul>
<li>1）analyzer</li>
</ul>
<p>通过analyzer属性指定分词器。</p>
<p>上边指定了analyzer是指在索引和搜索都使用standard，如果单独想定义搜索时使用的分词器则可以通过search_analyzer属性。</p>
<ul>
<li>2）index</li>
</ul>
<p>index属性指定是否索引。</p>
<p>默认为index&#x3D;true，即要进行索引，&#x3D;&#x3D;<strong>只有进行索引才可以从索引库搜索到</strong>&#x3D;&#x3D;，除非不采用分词搜索。</p>
<p>但是也有一些内容不需要索引，比如：商品图片地址只被用来展示图片，不进行搜索图片，此时可以将index设置为false。</p>
<p>删除索引，重新创建映射，将pic的index设置为false，尝试根据pic去搜索，结果搜索不到数据。</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;properties&quot;: &#123;</span><br><span class="line">        &quot;title&quot;:&#123;</span><br><span class="line">            &quot;type&quot;: &quot;text&quot;,</span><br><span class="line">            &quot;store&quot;: true,</span><br><span class="line">            &quot;index&quot;: false</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST /goodsindex/goods/1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;name&quot;:&quot;huawei shouji&quot;,</span><br><span class="line">  &quot;title&quot;:&quot;huawei 4G quanmianping youxi shouji&quot;,</span><br><span class="line">  &quot;price&quot;:4899,</span><br><span class="line">  &quot;category&quot;:[&quot;youxi&quot;,&quot;4G&quot;,&quot;quanmianping&quot;]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GET goodsindex/goods/_search?q=title:huawei			# 搜索不到</span><br><span class="line"></span><br><span class="line">GET goodsindex/goods/_search?q=_id:1				# 通过id精准查询(可以搜索到)</span><br></pre></td></tr></table></figure></div>

<blockquote>
<p>Tips：不建立索引通过全文检索的方式是搜索不到的</p>
</blockquote>
<ul>
<li>3）store</li>
</ul>
<p>是否在source之外存储，默认值为false，每个文档索引后会在 ES中保存一份原始文档，存放在<code>_source</code>中，一般情况下不需要设置store为true，因为在_source中已经有一份原始文档了。</p>
<h4 id="2）keyword类型"><a href="#2）keyword类型" class="headerlink" title="2）keyword类型"></a>2）keyword类型</h4><p>keyword类型就类似与Text类型加上了”index”: false，通常搜索keyword是按照整体搜索，所以创建keyword字段的索引时是不进行分词的，比如：手机号码、身份证号等。当然是用Text类型加上”index”: false也是可以达到同样的效果；</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">PUT goodsindex?include_type_name=true</span><br><span class="line">&#123;</span><br><span class="line">  &quot;mappings&quot;: &#123;</span><br><span class="line">    &quot;goods&quot;: &#123;</span><br><span class="line">      &quot;properties&quot;: &#123;</span><br><span class="line">        &quot;id&quot;:&#123;</span><br><span class="line">          &quot;type&quot;: &quot;keyword&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        ....</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<blockquote>
<p>keyword 类型的字段是不会建立索引的，另外搜索keyword类型的字段时，不会对搜索条件进行分词</p>
</blockquote>
<h4 id="3）date日期类型"><a href="#3）date日期类型" class="headerlink" title="3）date日期类型"></a>3）date日期类型</h4><p>日期类型不用设置分词器。通常日期类型的字段用于排序。</p>
<ul>
<li>属性：<ul>
<li>通过format设置日期格式</li>
</ul>
</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;publish_date&quot;: &#123;</span><br><span class="line">        &quot;type&quot;:   &quot;date&quot;,</span><br><span class="line">        &quot;format&quot;: &quot;yyyy-MM-dd HH:mm:ss||yyyy-MM-dd&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<ul>
<li>插入文档：</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">PUT /goodsindex/goods/1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;name&quot;:&quot;oppo shouji&quot;,</span><br><span class="line">  &quot;title&quot;:&quot;oppo 5G paizhao shouji&quot;,</span><br><span class="line">  &quot;price&quot;:2899,</span><br><span class="line">  &quot;category&quot;:[&quot;paizhao&quot;,&quot;5G&quot;],</span><br><span class="line">  &quot;publish_date&quot;:&quot;2020-10-10 10:30:21&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<blockquote>
<p>插入的日期格式必须符合：<code>yyyy-MM-dd HH:mm:ss</code>或者<code>yyyy-MM-dd</code></p>
</blockquote>
<p>复杂数据类型分为，数组、对象、对象数组等</p>
<ul>
<li>示例：</li>
</ul>
<p>添加一篇文档：</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">POST /test/test</span><br><span class="line">&#123;</span><br><span class="line">	&quot;address&quot;: &#123;</span><br><span class="line">		&quot;country&quot;: &quot;China&quot;,</span><br><span class="line">		&quot;province&quot;: &quot;JiangXi&quot;,</span><br><span class="line">		&quot;city&quot;: &quot;NanChang&quot;</span><br><span class="line">	&#125;,</span><br><span class="line">	&quot;name&quot;: &quot;xiaoming&quot;,</span><br><span class="line">	&quot;age&quot;: 23,</span><br><span class="line">	&quot;authors&quot;: [&#123;</span><br><span class="line">			&quot;age&quot;: 26,</span><br><span class="line">			&quot;name&quot;: &quot;xiaogang&quot;</span><br><span class="line">		&#125;,</span><br><span class="line">		&#123;</span><br><span class="line">			&quot;age&quot;: 25,</span><br><span class="line">			&quot;name&quot;: &quot;xiaohong&quot;</span><br><span class="line">		&#125;,</span><br><span class="line">		&#123;</span><br><span class="line">			&quot;age&quot;: 28,</span><br><span class="line">			&quot;name&quot;: &quot;xiaojun&quot;</span><br><span class="line">		&#125;</span><br><span class="line">	],</span><br><span class="line">	&quot;spouse&quot;:null,</span><br><span class="line">	&quot;friends&quot;:[&quot;xiaojun&quot;,&quot;xiangang&quot;,&quot;xiaohong&quot;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<ul>
<li>查看文档映射：</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line">GET test/_mapping</span><br><span class="line">&#123;</span><br><span class="line">  &quot;test&quot;: &#123;</span><br><span class="line">    &quot;mappings&quot;: &#123;</span><br><span class="line">      &quot;test&quot;: &#123;</span><br><span class="line">        &quot;properties&quot;: &#123;</span><br><span class="line">          &quot;address&quot;: &#123;</span><br><span class="line">            &quot;properties&quot;: &#123;</span><br><span class="line">              &quot;city&quot;: &#123;</span><br><span class="line">                &quot;type&quot;: &quot;text&quot;,</span><br><span class="line">                &quot;fields&quot;: &#123;</span><br><span class="line">                  &quot;keyword&quot;: &#123;</span><br><span class="line">                    &quot;type&quot;: &quot;keyword&quot;,</span><br><span class="line">                    &quot;ignore_above&quot;: 256</span><br><span class="line">                  &#125;</span><br><span class="line">                &#125;</span><br><span class="line">              &#125;,</span><br><span class="line">              &quot;country&quot;: &#123;</span><br><span class="line">                &quot;type&quot;: &quot;text&quot;,</span><br><span class="line">                &quot;fields&quot;: &#123;</span><br><span class="line">                  &quot;keyword&quot;: &#123;</span><br><span class="line">                    &quot;type&quot;: &quot;keyword&quot;,</span><br><span class="line">                    &quot;ignore_above&quot;: 256</span><br><span class="line">                  &#125;</span><br><span class="line">                &#125;</span><br><span class="line">              &#125;,</span><br><span class="line">              &quot;province&quot;: &#123;</span><br><span class="line">                &quot;type&quot;: &quot;text&quot;,</span><br><span class="line">                &quot;fields&quot;: &#123;</span><br><span class="line">                  &quot;keyword&quot;: &#123;</span><br><span class="line">                    &quot;type&quot;: &quot;keyword&quot;,</span><br><span class="line">                    &quot;ignore_above&quot;: 256</span><br><span class="line">                  &#125;</span><br><span class="line">                &#125;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;age&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;long&quot;</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;authors&quot;: &#123;</span><br><span class="line">            &quot;properties&quot;: &#123;</span><br><span class="line">              &quot;age&quot;: &#123;</span><br><span class="line">                &quot;type&quot;: &quot;long&quot;</span><br><span class="line">              &#125;,</span><br><span class="line">              &quot;name&quot;: &#123;</span><br><span class="line">                &quot;type&quot;: &quot;text&quot;,</span><br><span class="line">                &quot;fields&quot;: &#123;</span><br><span class="line">                  &quot;keyword&quot;: &#123;</span><br><span class="line">                    &quot;type&quot;: &quot;keyword&quot;,</span><br><span class="line">                    &quot;ignore_above&quot;: 256</span><br><span class="line">                  &#125;</span><br><span class="line">                &#125;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;friends&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;text&quot;,</span><br><span class="line">            &quot;fields&quot;: &#123;</span><br><span class="line">              &quot;keyword&quot;: &#123;</span><br><span class="line">                &quot;type&quot;: &quot;keyword&quot;,</span><br><span class="line">                &quot;ignore_above&quot;: 256</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;name&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;text&quot;,</span><br><span class="line">            &quot;fields&quot;: &#123;</span><br><span class="line">              &quot;keyword&quot;: &#123;</span><br><span class="line">                &quot;type&quot;: &quot;keyword&quot;,</span><br><span class="line">                &quot;ignore_above&quot;: 256</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="5-2-3-Text字段排序问题"><a href="#5-2-3-Text字段排序问题" class="headerlink" title="5.2.3 Text字段排序问题"></a>5.2.3 Text字段排序问题</h3><p>如果对一个text field进行排序，结果往往不准确，因为分词后是多个单词，再排序就不是我们想要的结果了。</p>
<p>通常解决方案是，将一个text field建立两次索引，一个分词，用来进行搜索；一个不分词，用来进行排序。</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">DELETE goodsindex</span><br><span class="line"></span><br><span class="line">PUT goodsindex?include_type_name=true</span><br><span class="line">&#123;</span><br><span class="line">	&quot;mappings&quot;: &#123;</span><br><span class="line">		&quot;goods&quot;: &#123;</span><br><span class="line">			&quot;properties&quot;: &#123;</span><br><span class="line">				&quot;name&quot;: &#123;</span><br><span class="line">					&quot;type&quot;: &quot;text&quot;,</span><br><span class="line">					&quot;fielddata&quot;: true			# text字段排序必须要开启fielddata</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST /goodsindex/goods/1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;name&quot;:&quot;bce cde zzz&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST /goodsindex/goods/2</span><br><span class="line">&#123;</span><br><span class="line">  &quot;name&quot;:&quot;ace def eee&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST /goodsindex/goods/3</span><br><span class="line">&#123;</span><br><span class="line">  &quot;name&quot;:&quot;bad fff abc&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">GET /goodsindex/goods/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match_all&quot;: &#123;&#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;sort&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;name&quot;: &#123;</span><br><span class="line">        &quot;order&quot;: &quot;asc&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>排序结果：</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/ElasticSearch1/100.png"
                     
                ></p>
<ul>
<li>建立mapping映射</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">DELETE goodsindex</span><br><span class="line"></span><br><span class="line">PUT /goodsindex?include_type_name=true</span><br><span class="line">&#123;</span><br><span class="line">	&quot;mappings&quot;: &#123;</span><br><span class="line">		&quot;goods&quot;: &#123;</span><br><span class="line">			&quot;properties&quot;: &#123;</span><br><span class="line">				&quot;name&quot;: &#123;</span><br><span class="line">					&quot;type&quot;: &quot;text&quot;,</span><br><span class="line">					&quot;fields&quot;: &#123;</span><br><span class="line">					  &quot;keyword&quot;:&#123;</span><br><span class="line">					    &quot;type&quot;: &quot;keyword&quot;</span><br><span class="line">					  &#125;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<ul>
<li>插入数据：</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">POST /goodsindex/goods/1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;name&quot;:&quot;bce cde zzz&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST /goodsindex/goods/2</span><br><span class="line">&#123;</span><br><span class="line">  &quot;name&quot;:&quot;ace def eee&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST /goodsindex/goods/3</span><br><span class="line">&#123;</span><br><span class="line">  &quot;name&quot;:&quot;bad fff abc&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<ul>
<li>执行排序：</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">GET /goodsindex/goods/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match_all&quot;: &#123;&#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;sort&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;name.keyword&quot;: &#123;</span><br><span class="line">        &quot;order&quot;: &quot;asc&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>排序结果：</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/ElasticSearch1/99.png"
                     
                ></p>
<h2 id="5-3-type底层结构"><a href="#5-3-type底层结构" class="headerlink" title="5.3 type底层结构"></a>5.3 type底层结构</h2><p>前面我们提到过ES的体系结构，将type归类于MySQL中的表，前期只是方便我们理解，其实严格来说不能这样进行对比，因为在ES中，关于type有着其他的定义；</p>
<p>lucenen在底层建立索引的时候，全部是<code>opaque bytes</code>类型，不区分类型的。Lucene是没有type的概念的，在document中，<strong>实际上将type作为一个document的field来存储，即<code>_type</code>，es通过<code>_type</code>来进行type的过滤和筛选。</strong></p>
<p>我们在实际开发中，一个索引通常只会设置一个type，如果需要多个type，那么就建立多个索引，在ES7.0以上版本后，一个索引只能有一个type，默认的type为<code>_doc</code>，通过<code>include_type_name</code>参数设置是否允许取别的type名称，在7.0版本以前默认为true，7.0版本之后默认为false </p>
<blockquote>
<p>ES对<code>include_type_name</code>参数的改动：<a class="link"   target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/breaking-changes-7.0.html#breaking_70_mappings_changes" >https://www.elastic.co/guide/en/elasticsearch/reference/current/breaking-changes-7.0.html#breaking_70_mappings_changes <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
</blockquote>
<h3 id="5-3-1-索引底层如何存储type"><a href="#5-3-1-索引底层如何存储type" class="headerlink" title="5.3.1 索引底层如何存储type"></a>5.3.1 索引底层如何存储type</h3><p>一个index中的多个type，实际上是放在一起存储的，因此一个index下，不能有多个type重名，而类型或者其他设置不同的，因为那样是无法处理的</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">PUT test_index</span><br><span class="line">&#123;</span><br><span class="line">	&quot;mappings&quot;: &#123;</span><br><span class="line">		&quot;article&quot;: &#123;</span><br><span class="line">			&quot;properties&quot;: &#123;</span><br><span class="line">				&quot;title&quot;: &#123;</span><br><span class="line">					&quot;type&quot;: &quot;text&quot;</span><br><span class="line">				&#125;,</span><br><span class="line">				&quot;content&quot;: &#123;</span><br><span class="line">					&quot;type&quot;: &quot;text&quot;</span><br><span class="line">				&#125;,</span><br><span class="line">				&quot;publish_date&quot;: &#123;</span><br><span class="line">					&quot;type&quot;: &quot;date&quot;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;,</span><br><span class="line">		&quot;meeting&quot;: &#123;</span><br><span class="line">			&quot;properties&quot;: &#123;</span><br><span class="line">				&quot;title&quot;: &#123;</span><br><span class="line">					&quot;type&quot;: &quot;string&quot;</span><br><span class="line">				&#125;,</span><br><span class="line">				&quot;content&quot;: &#123;</span><br><span class="line">					&quot;type&quot;: &quot;double&quot;</span><br><span class="line">				&#125;,</span><br><span class="line">				&quot;start_date&quot;: &#123;</span><br><span class="line">					&quot;type&quot;: &quot;date&quot;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></div>

<ul>
<li>添加数据：</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">PUT /test_index/article/1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;title&quot;: &quot;如何学习Java&quot;,</span><br><span class="line">  &quot;content&quot;: &quot;这样学习Java&quot;,</span><br><span class="line">  &quot;publish_date&quot;: &quot;2020-10-24&quot;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT /test_index/meeting/1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;title&quot;: &quot;关于Java研发组提薪问题&quot;,</span><br><span class="line">  &quot;content&quot;: &quot;Java研发组全部提薪2000元&quot;,</span><br><span class="line">  &quot;start_date&quot;: &quot;2020-10-24 18:30:00&quot;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<blockquote>
<p> 在ES7版本之前，上述代码是可以执行成功的，ES7之后，一个索引中只能有一个Type，不能存在多个Type</p>
</blockquote>
<p>ES文档在底层的存储的样子：</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&quot;mappings&quot;: &#123;</span><br><span class="line">	&quot;_type&quot;: &#123;</span><br><span class="line">		&quot;type&quot;: &quot;text&quot;,</span><br><span class="line">		&quot;index&quot;: &quot;false&quot;</span><br><span class="line">	&#125;,</span><br><span class="line">	&quot;title&quot;: &#123;</span><br><span class="line">		&quot;type&quot;: &quot;text&quot;</span><br><span class="line">	&#125;,</span><br><span class="line">	&quot;content&quot;: &#123;</span><br><span class="line">		&quot;type&quot;: &quot;text&quot;</span><br><span class="line">	&#125;,</span><br><span class="line">	&quot;publish_date&quot;: &#123;</span><br><span class="line">		&quot;type&quot;: &quot;date&quot;</span><br><span class="line">	&#125;,</span><br><span class="line">	&quot;start_date&quot;: &#123;</span><br><span class="line">		&quot;type&quot;: &quot;date&quot;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><strong>type弃用的原因：</strong>同一索引下，不同type的数据存储其他type的field 大量空值，造成资源浪费。所以，不同类型数据，要放到不同的索引中。在ES7.0版本之后，一个索引中只能有一个type，不能存在多个type，ES9中，将会彻底删除type。</p>
<h3 id="5-3-2-新版本如何使用type"><a href="#5-3-2-新版本如何使用type" class="headerlink" title="5.3.2 新版本如何使用type"></a>5.3.2 新版本如何使用type</h3><p>我们在前面提过，在7.0版本之后的ES，默认的type名为<code>_doc</code>，我们可以创建一个索引，使用默认的type：</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">PUT goodsindex</span><br><span class="line">&#123;</span><br><span class="line">	&quot;mappings&quot;: &#123;</span><br><span class="line">		&quot;properties&quot;: &#123;</span><br><span class="line">			&quot;id&quot;: &#123;</span><br><span class="line">				&quot;type&quot;: &quot;text&quot;,</span><br><span class="line">				&quot;store&quot;: true,</span><br><span class="line">				&quot;index&quot;: true</span><br><span class="line">			&#125;,</span><br><span class="line">			&quot;name&quot;: &#123;</span><br><span class="line">				&quot;type&quot;: &quot;text&quot;,</span><br><span class="line">				&quot;store&quot;: true,</span><br><span class="line">				&quot;index&quot;: true</span><br><span class="line">			&#125;,</span><br><span class="line">			&quot;title&quot;: &#123;</span><br><span class="line">				&quot;type&quot;: &quot;text&quot;,</span><br><span class="line">				&quot;store&quot;: true,</span><br><span class="line">				&quot;index&quot;: true</span><br><span class="line">			&#125;,</span><br><span class="line">			&quot;price&quot;: &#123;</span><br><span class="line">				&quot;type&quot;: &quot;long&quot;,</span><br><span class="line">				&quot;store&quot;: true,</span><br><span class="line">				&quot;index&quot;: true</span><br><span class="line">			&#125;,</span><br><span class="line">			&quot;catetory&quot;: &#123;</span><br><span class="line">				&quot;fielddata&quot;: true,</span><br><span class="line">				&quot;type&quot;: &quot;text&quot;,</span><br><span class="line">				&quot;store&quot;: true,</span><br><span class="line">				&quot;index&quot;: true</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/ElasticSearch1/108.png"
                     
                ></p>
<p>我们再次查看映射：</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET goodsindex/_mapping</span><br></pre></td></tr></table></figure></div>



<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/ElasticSearch1/109.png"
                     
                ></p>
<blockquote>
<p>发现type不见了，type默认为<code>_doc</code></p>
</blockquote>
<p>新增文档：</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">POST /goodsindex/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;name&quot;:&quot;huawei shouji&quot;,</span><br><span class="line">  &quot;title&quot;:&quot;1&quot;,</span><br><span class="line">  &quot;price&quot;:4899,</span><br><span class="line">  &quot;category&quot;:[&quot;youxi&quot;,&quot;4G&quot;,&quot;quanmianping&quot;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/ElasticSearch1/200.png"
                     
                ></p>
<ul>
<li>查询：</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /goodsindex/_doc/1</span><br></pre></td></tr></table></figure></div>

<ul>
<li>修改：</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">PUT /goodsindex/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;name&quot;:&quot;vivo shouji&quot;,</span><br><span class="line">  &quot;title&quot;:&quot;vivo shouji&quot;,</span><br><span class="line">  &quot;price&quot;:1899,</span><br><span class="line">  &quot;category&quot;:[&quot;4G&quot;,&quot;quanmianping&quot;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<ul>
<li>删除：</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DELETE goodsindex/_doc/1</span><br></pre></td></tr></table></figure></div>



<h2 id="5-3-别名配置"><a href="#5-3-别名配置" class="headerlink" title="5.3 别名配置"></a>5.3 别名配置</h2><p>Elasticsearch中的API在针对特定索引时接受索引名，在适用时接受多个索引。index aliases API允许使用名称对索引进行别名，所有API都会自动将别名转换为实际的索引名。别名也可以映射到多个索引，并且在指定别名时，别名将自动展开到别名索引。别名还可以与筛选器相关联，筛选器在搜索和路由值时将自动应用。别名不能具有与索引相同的名称。</p>
<ul>
<li>添加别名：</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">POST _aliases</span><br><span class="line">&#123;</span><br><span class="line">  &quot;actions&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;add&quot;: &#123;</span><br><span class="line">        &quot;index&quot;: &quot;goodsindex&quot;,</span><br><span class="line">        &quot;alias&quot;: &quot;a&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<ul>
<li>使用别名操作：</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">GET a/_doc/1									# 根据id查询</span><br><span class="line">GET a/_doc/_search								# 查询全部</span><br><span class="line">PUT a/_doc/1									# 修改</span><br><span class="line">&#123;</span><br><span class="line">	&quot;title&quot;:&quot;oppo 4G shouji&quot;</span><br><span class="line">&#125;</span><br><span class="line">DELETE a/_doc/1			# 删除</span><br></pre></td></tr></table></figure></div>



<ul>
<li>删除别名：</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">POST _aliases</span><br><span class="line">&#123;</span><br><span class="line">  &quot;actions&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;remove&quot;: &#123;</span><br><span class="line">        &quot;index&quot;:&quot;goodsindex&quot;,</span><br><span class="line">        &quot;alias&quot;: &quot;a&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<ul>
<li>别名批量操作：</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">分别给索引 test1,test2 添加别名a1,a2</span></span><br><span class="line">POST _aliases</span><br><span class="line">&#123;</span><br><span class="line">	&quot;actions&quot;: [</span><br><span class="line">	  &#123;</span><br><span class="line">			&quot;add&quot;: &#123;</span><br><span class="line">				&quot;index&quot;: &quot;test1&quot;,</span><br><span class="line">				&quot;alias&quot;: &quot;a1&quot;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;,</span><br><span class="line">		&#123;</span><br><span class="line">			&quot;add&quot;: &#123;</span><br><span class="line">				&quot;index&quot;: &quot;test2&quot;,</span><br><span class="line">				&quot;alias&quot;: &quot;a2&quot;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	]</span><br><span class="line">&#125;		</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">批量移除别名</span></span><br><span class="line">POST _aliases</span><br><span class="line">&#123;</span><br><span class="line">	&quot;actions&quot;: [</span><br><span class="line">	  &#123;</span><br><span class="line">  		&quot;remove&quot;: &#123;</span><br><span class="line">  			&quot;index&quot;:&quot;test1&quot;,</span><br><span class="line">  			&quot;alias&quot;: &quot;a1&quot;</span><br><span class="line">  		&#125;</span><br><span class="line">	  &#125;,</span><br><span class="line">	  &#123;</span><br><span class="line">  		&quot;remove&quot;: &#123;</span><br><span class="line">  			&quot;index&quot;:&quot;test2&quot;,</span><br><span class="line">  			&quot;alias&quot;: &quot;a2&quot;</span><br><span class="line">  		&#125;</span><br><span class="line">	  &#125;</span><br><span class="line">	]</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">分别给tset1,<span class="built_in">test</span> 添加别名a1</span></span><br><span class="line">POST _aliases</span><br><span class="line">&#123;</span><br><span class="line">	&quot;actions&quot;: [</span><br><span class="line">	  &#123;</span><br><span class="line">  		&quot;add&quot;: &#123;</span><br><span class="line">  			&quot;indices&quot;: [&quot;test1&quot;, &quot;test2&quot;],</span><br><span class="line">  			&quot;alias&quot;: &quot;a1&quot;</span><br><span class="line">  		&#125;</span><br><span class="line">	  &#125;</span><br><span class="line">	]</span><br><span class="line">&#125;	</span><br></pre></td></tr></table></figure></div>



<h2 id="5-4-多别名配置"><a href="#5-4-多别名配置" class="headerlink" title="5.4 多别名配置"></a>5.4 多别名配置</h2><p>在ES中，运行多个索引使用同一个别名：</p>
<ul>
<li>创建两个索引：</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">DELETE goodsindex   </span><br><span class="line"></span><br><span class="line">POST /goodsindex1/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;name&quot;:&quot;huawei shouji&quot;,</span><br><span class="line">  &quot;title&quot;:&quot;huawei 4G quanmianping youxi shouji&quot;,</span><br><span class="line">  &quot;price&quot;:4899,</span><br><span class="line">  &quot;category&quot;:[&quot;youxi&quot;,&quot;4G&quot;,&quot;quanmianping&quot;]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST /goodsindex2/_doc/2</span><br><span class="line">&#123;</span><br><span class="line">  &quot;name&quot;:&quot;vivo shouji&quot;,</span><br><span class="line">  &quot;title&quot;:&quot;vivo 5G paizhao shouji&quot;,</span><br><span class="line">  &quot;price&quot;:2899,</span><br><span class="line">  &quot;category&quot;:[&quot;5G&quot;,&quot;paizhao&quot;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<ul>
<li>设置同一个别名：</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">POST _aliases</span><br><span class="line">&#123;</span><br><span class="line">  &quot;actions&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;add&quot;: &#123;</span><br><span class="line">        &quot;index&quot;: &quot;goodsindex1&quot;,</span><br><span class="line">        &quot;alias&quot;: &quot;a1&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;add&quot;: &#123;</span><br><span class="line">        &quot;index&quot;: &quot;goodsindex2&quot;,</span><br><span class="line">        &quot;alias&quot;: &quot;a1&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>



<p>此时根据别名查询是从两个索引中查询出来的数据：</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET a1/_doc/_search</span><br></pre></td></tr></table></figure></div>

<p>结果：</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">! Deprecation: [types removal] Specifying types <span class="keyword">in</span> search requests is deprecated.</span></span><br><span class="line">&#123;</span><br><span class="line">  &quot;took&quot; : 0,</span><br><span class="line">  &quot;timed_out&quot; : false,</span><br><span class="line">  &quot;_shards&quot; : &#123;</span><br><span class="line">    &quot;total&quot; : 2,</span><br><span class="line">    &quot;successful&quot; : 2,</span><br><span class="line">    &quot;skipped&quot; : 0,</span><br><span class="line">    &quot;failed&quot; : 0</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;hits&quot; : &#123;</span><br><span class="line">    &quot;total&quot; : &#123;</span><br><span class="line">      &quot;value&quot; : 2,</span><br><span class="line">      &quot;relation&quot; : &quot;eq&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;max_score&quot; : 1.0,</span><br><span class="line">    &quot;hits&quot; : [</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;_index&quot; : &quot;goodsindex1&quot;,</span><br><span class="line">        &quot;_type&quot; : &quot;_doc&quot;,</span><br><span class="line">        &quot;_id&quot; : &quot;1&quot;,</span><br><span class="line">        &quot;_score&quot; : 1.0,</span><br><span class="line">        &quot;_source&quot; : &#123;</span><br><span class="line">          &quot;name&quot; : &quot;huawei shouji&quot;,</span><br><span class="line">          &quot;title&quot; : &quot;huawei 4G quanmianping youxi shouji&quot;,</span><br><span class="line">          &quot;price&quot; : 4899,</span><br><span class="line">          &quot;category&quot; : [</span><br><span class="line">            &quot;youxi&quot;,</span><br><span class="line">            &quot;4G&quot;,</span><br><span class="line">            &quot;quanmianping&quot;</span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;_index&quot; : &quot;goodsindex2&quot;,</span><br><span class="line">        &quot;_type&quot; : &quot;_doc&quot;,</span><br><span class="line">        &quot;_id&quot; : &quot;2&quot;,</span><br><span class="line">        &quot;_score&quot; : 1.0,</span><br><span class="line">        &quot;_source&quot; : &#123;</span><br><span class="line">          &quot;name&quot; : &quot;vivo shouji&quot;,</span><br><span class="line">          &quot;title&quot; : &quot;vivo 5G paizhao shouji&quot;,</span><br><span class="line">          &quot;price&quot; : 2899,</span><br><span class="line">          &quot;category&quot; : [</span><br><span class="line">            &quot;5G&quot;,</span><br><span class="line">            &quot;paizhao&quot;</span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>



<p>多个索引设置同一个别名时不能对谋篇文档进行id查询、删除、修改等：</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET a1/goods/1</span><br></pre></td></tr></table></figure></div>

<blockquote>
<p>此时报错</p>
</blockquote>
<h1 id="五、分析器"><a href="#五、分析器" class="headerlink" title="五、分析器"></a>五、分析器</h1><h2 id="5-1-分析器概念"><a href="#5-1-分析器概念" class="headerlink" title="5.1 分析器概念"></a>5.1 分析器概念</h2><h3 id="5-1-1-分析器简介"><a href="#5-1-1-分析器简介" class="headerlink" title="5.1.1 分析器简介"></a>5.1.1 分析器简介</h3><p>分词器，是将用户输入的一段文本，分析成符合逻辑的一种工具。到目前为止呢，分词器没有办法做到完全的符合人们的要求。和我们有关的分词器有英文的和中文的；英文的分词器过程：输入文本-关键词切分-去停用词-形态还原-转为小写。</p>
<p><code>Analysis</code>： 文本分析是把文本转换一系列单词的过程，也叫分词。<strong>Analysis是通过Analyzer来实现的</strong>。当一个文档被索引时，每个Field都可能会创建一个倒排索引（Mapping可以设置不索引该Field）。</p>
<p><strong>倒排索引的过程就是将文档通过Analyzer分成一个一个的Term,每一个Term都指向包含这个Term的文档集合。</strong>当执行查询时，ES会根据搜索类型决定是否对query进行analyze（分词），然后和倒排索引中的term进行相关性查询，匹配相应的文档。</p>
<h3 id="5-1-2-分析器原理图"><a href="#5-1-2-分析器原理图" class="headerlink" title="5.1.2 分析器原理图"></a>5.1.2 分析器原理图</h3><p>在ES内部，每个shard都维护着一个索引区与元数据区，元数据区负责存储原始数据（doc），索引区是通过分词器将原始数据根据一系列规则拆分后得到的一个倒排索引，这些索引根据域（Field）来区分，每个域对象会根据该域的分词情况与元数据建立关系；<code>词【文档id，出现次数】</code></p>
<ul>
<li>倒排索引原理图：</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/ElasticSearch1/34.png"
                     
                ></p>
<h2 id="5-1-ES内置分析器"><a href="#5-1-ES内置分析器" class="headerlink" title="5.1 ES内置分析器"></a>5.1 ES内置分析器</h2><p>Elasticsearch内置的分析器有：standard，simple，stop，whitespace，keyword，pattern，customer等。</p>
<table>
<thead>
<tr>
<th>analyzer</th>
<th>Tokenizer</th>
<th>Token Filters</th>
<th>Configuration</th>
<th>desc</th>
</tr>
</thead>
<tbody><tr>
<td>standard</td>
<td>Standard</td>
<td>Lower case Stop</td>
<td>max_token_length stopwords stopwords_path</td>
<td>基于语法的分词</td>
</tr>
<tr>
<td>Simple</td>
<td>Simple</td>
<td>Lower case</td>
<td></td>
<td>非字母的分词</td>
</tr>
<tr>
<td>Whitespace</td>
<td>Whitespace</td>
<td></td>
<td></td>
<td>空格分词</td>
</tr>
<tr>
<td>Stop</td>
<td>Lower case</td>
<td>Stop</td>
<td>stopwords stopwords_path</td>
<td>类似simple</td>
</tr>
<tr>
<td>Keyword</td>
<td>Keyword</td>
<td></td>
<td></td>
<td>不分词</td>
</tr>
<tr>
<td>Pattern</td>
<td>Pattern</td>
<td>Lower Case Stop</td>
<td>pattern flags lowercase stopwords stopwords_path</td>
<td>按表达式分词</td>
</tr>
<tr>
<td>Language</td>
<td>Language</td>
<td>keyword marker</td>
<td></td>
<td>其他语言分词</td>
</tr>
<tr>
<td>Fingerprint</td>
<td>Standard</td>
<td>lower case ASCII folding Stop Fingerprint</td>
<td>separator max_output_size stopwords stopwords_path</td>
<td>检查重</td>
</tr>
</tbody></table>
<h3 id="5-1-1-standard-分析器"><a href="#5-1-1-standard-分析器" class="headerlink" title="5.1.1 standard 分析器"></a>5.1.1 standard 分析器</h3><p>standard分析器是ES默认采用的分析器（Text），区分中英文，&#x3D;&#x3D;<strong>英文按照空格拆分单词，并且把大写转换为小写，中文按照单个字拆分，会过滤特殊字符</strong>&#x3D;&#x3D;</p>
<ul>
<li>测试中文分词：</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">POST _analyze</span><br><span class="line">&#123;</span><br><span class="line">  &quot;analyzer&quot;: &quot;standard&quot;,</span><br><span class="line">  &quot;text&quot;: &quot;我是 中 国人&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/ElasticSearch1/30.png"
                     
                ></p>
<ul>
<li>测试英文分词：</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">POST _analyze</span><br><span class="line">&#123;</span><br><span class="line">  &quot;analyzer&quot;: &quot;standard&quot;,</span><br><span class="line">  &quot;text&quot;: &quot;I am chin ses&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/ElasticSearch1/31.png"
                     
                ></p>
<ul>
<li>测试特殊字符：</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">POST _analyze</span><br><span class="line">&#123;</span><br><span class="line">  &quot;analyzer&quot;: &quot;standard&quot;,</span><br><span class="line">  &quot;text&quot;: &quot;中国人 &amp;*&amp; *=&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/ElasticSearch1/32.png"
                       
                >



<h3 id="5-1-2-simple-分析器"><a href="#5-1-2-simple-分析器" class="headerlink" title="5.1.2 simple 分析器"></a>5.1.2 simple 分析器</h3><p>simple分词器的拆分规则：&#x3D;&#x3D;<strong>按空格进行分词，并且会将大写转换为小写，中文遇到空格分词，会过滤特殊字符；</strong>&#x3D;&#x3D;</p>
<p>与standard的区别：<strong>中文遇到空格拆分</strong></p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">POST _analyze</span><br><span class="line">&#123;</span><br><span class="line">  &quot;analyzer&quot;: &quot;simple&quot;,</span><br><span class="line">  &quot;text&quot;: &quot;I am chin ese 中国 人 * _ &amp; &quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/ElasticSearch1/33.png"
                     
                ></p>
<h3 id="5-1-3-whitespace-分析器"><a href="#5-1-3-whitespace-分析器" class="headerlink" title="5.1.3 whitespace 分析器"></a>5.1.3 whitespace 分析器</h3><p>whitespace分词器的拆分规则是：按照空格拆分，英文不进行大小写转换，中文按空格拆分，<strong>不会过滤特殊字符</strong></p>
<p>与standard区别：<strong>英文不进行大小写转换，中文遇到空格分词，不会过滤特殊字符</strong></p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">POST _analyze</span><br><span class="line">&#123;</span><br><span class="line">  &quot;analyzer&quot;: &quot;whitespace&quot;,</span><br><span class="line">  &quot;text&quot;: &quot;I am Chin ese 中国 人 * &amp; &quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>结果如下：</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;tokens&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot;: &quot;I&quot;,</span><br><span class="line">      &quot;start_offset&quot;: 0,</span><br><span class="line">      &quot;end_offset&quot;: 1,</span><br><span class="line">      &quot;type&quot;: &quot;word&quot;,</span><br><span class="line">      &quot;position&quot;: 0</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot;: &quot;am&quot;,</span><br><span class="line">      &quot;start_offset&quot;: 2,</span><br><span class="line">      &quot;end_offset&quot;: 4,</span><br><span class="line">      &quot;type&quot;: &quot;word&quot;,</span><br><span class="line">      &quot;position&quot;: 1</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot;: &quot;Chin&quot;,</span><br><span class="line">      &quot;start_offset&quot;: 5,</span><br><span class="line">      &quot;end_offset&quot;: 9,</span><br><span class="line">      &quot;type&quot;: &quot;word&quot;,</span><br><span class="line">      &quot;position&quot;: 2</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot;: &quot;ese&quot;,</span><br><span class="line">      &quot;start_offset&quot;: 10,</span><br><span class="line">      &quot;end_offset&quot;: 13,</span><br><span class="line">      &quot;type&quot;: &quot;word&quot;,</span><br><span class="line">      &quot;position&quot;: 3</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot;: &quot;中国&quot;,</span><br><span class="line">      &quot;start_offset&quot;: 14,</span><br><span class="line">      &quot;end_offset&quot;: 16,</span><br><span class="line">      &quot;type&quot;: &quot;word&quot;,</span><br><span class="line">      &quot;position&quot;: 4</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot;: &quot;人&quot;,</span><br><span class="line">      &quot;start_offset&quot;: 17,</span><br><span class="line">      &quot;end_offset&quot;: 18,</span><br><span class="line">      &quot;type&quot;: &quot;word&quot;,</span><br><span class="line">      &quot;position&quot;: 5</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot;: &quot;*&quot;,</span><br><span class="line">      &quot;start_offset&quot;: 19,</span><br><span class="line">      &quot;end_offset&quot;: 20,</span><br><span class="line">      &quot;type&quot;: &quot;word&quot;,</span><br><span class="line">      &quot;position&quot;: 6</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot;: &quot;&amp;&quot;,</span><br><span class="line">      &quot;start_offset&quot;: 21,</span><br><span class="line">      &quot;end_offset&quot;: 22,</span><br><span class="line">      &quot;type&quot;: &quot;word&quot;,</span><br><span class="line">      &quot;position&quot;: 7</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<blockquote>
<p>查看结果发现，whitespace分词器不会进行大小写的转换，按照空格拆分，不会进行特殊字符的过滤</p>
</blockquote>
<h3 id="5-1-4-分析器使用"><a href="#5-1-4-分析器使用" class="headerlink" title="5.1.4 分析器使用"></a>5.1.4 分析器使用</h3><ul>
<li>方式一：指定ES现有的分析器来分析文本</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">GET _analyze</span><br><span class="line">&#123;</span><br><span class="line">  &quot;analyzer&quot;: &quot;standard&quot;,</span><br><span class="line">  &quot;text&quot;: &quot;I am Chinese&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<ul>
<li>方式二：使用索引中某个字段的分析器来分析文本</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">DELETE goodsindex</span><br><span class="line"></span><br><span class="line">POST /goodsindex/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;name&quot;:&quot;huawei shouji&quot;,</span><br><span class="line">  &quot;title&quot;:&quot;huawei 4G quanmianping youxi shouji&quot;,</span><br><span class="line">  &quot;price&quot;:4899,</span><br><span class="line">  &quot;category&quot;:[&quot;youxi&quot;,&quot;4G&quot;,&quot;quanmianping&quot;]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GET goodsindex/_analyze</span><br><span class="line">&#123;</span><br><span class="line">  &quot;field&quot;: &quot;title&quot;,</span><br><span class="line">  &quot;text&quot;: &quot;huawei 5G zhineng shouji&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<ul>
<li>方式三：采用自定义配置来分析文本：</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">GET _analyze</span><br><span class="line">&#123;</span><br><span class="line">  &quot;tokenizer&quot;: &quot;keyword&quot;,</span><br><span class="line">  &quot;char_filter&quot;: [&quot;html_strip&quot;],</span><br><span class="line">  &quot;filter&quot;: [&quot;uppercase&quot;], </span><br><span class="line">  &quot;text&quot;: &quot;&lt;br&gt;hello world&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<blockquote>
<p>tokenizer：采用的分词器</p>
<p>char_filter：采用的字符过滤器</p>
<p>filter：采用的token过滤器</p>
<p>text：分析的文本</p>
</blockquote>
<p>分词结果：</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;tokens&quot; : [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot; : &quot;\nHELLOWORLD&quot;,</span><br><span class="line">      &quot;start_offset&quot; : 0,</span><br><span class="line">      &quot;end_offset&quot; : 14,</span><br><span class="line">      &quot;type&quot; : &quot;word&quot;,</span><br><span class="line">      &quot;position&quot; : 0</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h2 id="5-2-分析器的组成"><a href="#5-2-分析器的组成" class="headerlink" title="5.2 分析器的组成"></a>5.2 分析器的组成</h2><p>我们刚刚使用自定义配置来分析文本时，发现有<code>tokenizer</code>、<code>char_filter</code>、<code>filter</code>参数可供我们配置，搭配不同的参数可以让我们的分析器功能更强大；</p>
<p>分析器（analyzer）由3个组件组成，分别为：<code>character filters(char_filter)</code> ， <code>tokenizers</code> ， <code>token filters(filter)</code>。</p>
<p>其中字符过滤器（<code>char_filter</code>）是针对分词前的文本过滤，token过滤器（token filters）是针对分词后的过滤；</p>
<ul>
<li>一个完整的分析步骤如下：</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/ElasticSearch1/35.png"
                     
                ></p>
<h3 id="5-2-1-char-filter（字符过滤器）"><a href="#5-2-1-char-filter（字符过滤器）" class="headerlink" title="5.2.1 char_filter（字符过滤器）"></a>5.2.1 char_filter（字符过滤器）</h3><p>在一段文本进行分词之前，先进行字符过滤，如HTML过滤、字符串替换过滤、正则表达式过滤等</p>
<p>char_filter主要提供有三个字符过滤器：<code>html_strip</code>、<code>mapping</code>、<code>pattern_replace</code></p>
<ul>
<li>html_strip：</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET /_analyze</span><br><span class="line">&#123;</span><br><span class="line">  &quot;tokenizer&quot;: &quot;keyword&quot;,</span><br><span class="line">  &quot;char_filter&quot;: [</span><br><span class="line">    &quot;html_strip&quot;</span><br><span class="line">  ],</span><br><span class="line">  &quot;text&quot;: &quot;&lt;br&gt; hello&amp;nbsp;hello&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<ul>
<li>结果：</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;tokens&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot;: &quot;\n hello hello&quot;,</span><br><span class="line">      &quot;start_offset&quot;: 0,</span><br><span class="line">      &quot;end_offset&quot;: 21,</span><br><span class="line">      &quot;type&quot;: &quot;word&quot;,</span><br><span class="line">      &quot;position&quot;: 0</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<blockquote>
<p>将<code>&lt;br&gt;</code>解析成<code>\n</code>，将<code>&amp;nbps;</code>解析成空格</p>
</blockquote>
<hr>


<ul>
<li>mapping：进行词语的映射（转换）</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">GET /_analyze</span><br><span class="line">&#123;</span><br><span class="line">  &quot;tokenizer&quot;: &quot;keyword&quot;,</span><br><span class="line">  &quot;char_filter&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;type&quot;:&quot;mapping&quot;,</span><br><span class="line">      &quot;mappings&quot;:[</span><br><span class="line">        &quot;&amp; =&gt; love&quot;,</span><br><span class="line">        &quot;|| =&gt; or&quot;,</span><br><span class="line">        &quot;you =&gt; 你&quot;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  &quot;text&quot;: &quot;I &amp; you || You &amp; me&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<ul>
<li>结果：</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;tokens&quot; : [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot; : &quot;I love 你 or You love me&quot;,</span><br><span class="line">      &quot;start_offset&quot; : 0,</span><br><span class="line">      &quot;end_offset&quot; : 19,</span><br><span class="line">      &quot;type&quot; : &quot;word&quot;,</span><br><span class="line">      &quot;position&quot; : 0</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<blockquote>
<p>将<code>&amp;</code>过滤为了<code>love</code>，将<code>||</code>过滤为了<code>or</code>，将<code>you</code>过滤为了<code>你</code>（区分大小写）</p>
</blockquote>
<hr>


<ul>
<li>pattern_replace：</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">GET /_analyze</span><br><span class="line">&#123;</span><br><span class="line">  &quot;tokenizer&quot;: &quot;keyword&quot;,</span><br><span class="line">  &quot;char_filter&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;type&quot;: &quot;pattern_replace&quot;,</span><br><span class="line">      &quot;pattern&quot;: &quot;(\\d+)-&quot;,</span><br><span class="line">      &quot;replacement&quot;: &quot;$1+&quot;</span><br><span class="line">    &#125;],</span><br><span class="line">    &quot;text&quot;: &quot;0791-8888&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<ul>
<li>结果：</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;tokens&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot;: &quot;0791+8888&quot;,</span><br><span class="line">      &quot;start_offset&quot;: 0,</span><br><span class="line">      &quot;end_offset&quot;: 9,</span><br><span class="line">      &quot;type&quot;: &quot;word&quot;,</span><br><span class="line">      &quot;position&quot;: 0</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="5-2-2-tokenizer（分词器）"><a href="#5-2-2-tokenizer（分词器）" class="headerlink" title="5.2.2 tokenizer（分词器）"></a>5.2.2 tokenizer（分词器）</h3><p>ES内置有非常多的 tokenizer ，不同的tokenizer具备不同的分词功能，下列列举几个：</p>
<ul>
<li>keyword：不分词</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">GET /_analyze</span><br><span class="line">&#123;</span><br><span class="line">  &quot;tokenizer&quot;: &quot;keyword&quot;,</span><br><span class="line">  &quot;text&quot;: &quot;I am Chinese&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>结果：</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;tokens&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot;: &quot;I am Chinese&quot;,</span><br><span class="line">      &quot;start_offset&quot;: 0,</span><br><span class="line">      &quot;end_offset&quot;: 12,</span><br><span class="line">      &quot;type&quot;: &quot;word&quot;,</span><br><span class="line">      &quot;position&quot;: 0</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<hr>


<ul>
<li>standard：采用标准分词</li>
</ul>
<p><strong>大小写不会进行转换</strong>，英文按照空格拆分单词，中文按照单个字拆分，会过滤特殊字符</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">GET /_analyze</span><br><span class="line">&#123;</span><br><span class="line">  &quot;tokenizer&quot;: &quot;standard&quot;,</span><br><span class="line">  &quot;text&quot;: &quot;I am Chinese&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>结果：</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;tokens&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot;: &quot;I&quot;,</span><br><span class="line">      &quot;start_offset&quot;: 0,</span><br><span class="line">      &quot;end_offset&quot;: 1,</span><br><span class="line">      &quot;type&quot;: &quot;&lt;ALPHANUM&gt;&quot;,</span><br><span class="line">      &quot;position&quot;: 0</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot;: &quot;am&quot;,</span><br><span class="line">      &quot;start_offset&quot;: 2,</span><br><span class="line">      &quot;end_offset&quot;: 4,</span><br><span class="line">      &quot;type&quot;: &quot;&lt;ALPHANUM&gt;&quot;,</span><br><span class="line">      &quot;position&quot;: 1</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot;: &quot;Chinese&quot;,</span><br><span class="line">      &quot;start_offset&quot;: 5,</span><br><span class="line">      &quot;end_offset&quot;: 12,</span><br><span class="line">      &quot;type&quot;: &quot;&lt;ALPHANUM&gt;&quot;,</span><br><span class="line">      &quot;position&quot;: 2</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<blockquote>
<p><strong>这里需要注意的一点：standard分词器与standard分析器不同，standard分析器会将大写转换为小写，而standard分词器不会</strong></p>
</blockquote>
<hr>


<ul>
<li>path_hierarchy：路径分词</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">GET /_analyze</span><br><span class="line">&#123;</span><br><span class="line">  &quot;tokenizer&quot;: &quot;path_hierarchy&quot;,</span><br><span class="line">  &quot;text&quot;: &quot;http://localhost:8080/user/sms/sendMsg&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<ul>
<li>结果：</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;tokens&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot;: &quot;http:&quot;,</span><br><span class="line">      &quot;start_offset&quot;: 0,</span><br><span class="line">      &quot;end_offset&quot;: 5,</span><br><span class="line">      &quot;type&quot;: &quot;word&quot;,</span><br><span class="line">      &quot;position&quot;: 0</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot;: &quot;http:/&quot;,</span><br><span class="line">      &quot;start_offset&quot;: 0,</span><br><span class="line">      &quot;end_offset&quot;: 6,</span><br><span class="line">      &quot;type&quot;: &quot;word&quot;,</span><br><span class="line">      &quot;position&quot;: 0</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot;: &quot;http://localhost:8080&quot;,</span><br><span class="line">      &quot;start_offset&quot;: 0,</span><br><span class="line">      &quot;end_offset&quot;: 21,</span><br><span class="line">      &quot;type&quot;: &quot;word&quot;,</span><br><span class="line">      &quot;position&quot;: 0</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot;: &quot;http://localhost:8080/user&quot;,</span><br><span class="line">      &quot;start_offset&quot;: 0,</span><br><span class="line">      &quot;end_offset&quot;: 26,</span><br><span class="line">      &quot;type&quot;: &quot;word&quot;,</span><br><span class="line">      &quot;position&quot;: 0</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot;: &quot;http://localhost:8080/user/sms&quot;,</span><br><span class="line">      &quot;start_offset&quot;: 0,</span><br><span class="line">      &quot;end_offset&quot;: 30,</span><br><span class="line">      &quot;type&quot;: &quot;word&quot;,</span><br><span class="line">      &quot;position&quot;: 0</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot;: &quot;http://localhost:8080/user/sms/sendMsg&quot;,</span><br><span class="line">      &quot;start_offset&quot;: 0,</span><br><span class="line">      &quot;end_offset&quot;: 38,</span><br><span class="line">      &quot;type&quot;: &quot;word&quot;,</span><br><span class="line">      &quot;position&quot;: 0</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>



<blockquote>
<p>更多ES分词器参考官网：<a class="link"   target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/analysis-tokenizers.html" >https://www.elastic.co/guide/en/elasticsearch/reference/current/analysis-tokenizers.html <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
</blockquote>
<h3 id="5-2-3-token-filters（token过滤器）"><a href="#5-2-3-token-filters（token过滤器）" class="headerlink" title="5.2.3 token filters（token过滤器）"></a>5.2.3 token filters（token过滤器）</h3><p>token filters的作用是对tokenizer分词器分词后的词进行处理</p>
<ul>
<li>stop：进行默认的英文词停用</li>
</ul>
<p>ES中，默认的英文停用词为：</p>
<div class="highlight-container" data-rel="Txt"><figure class="iseeu highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a, an, and, are, as, at, be, but, by, for, if, in, into, is, it, no, not, of, on, or, such, that, the, their, then, there, these, they, this, to, was, will, with</span><br></pre></td></tr></table></figure></div>

<ul>
<li>测试：</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">GET /_analyze</span><br><span class="line">&#123;</span><br><span class="line">  &quot;tokenizer&quot;: &quot;standard&quot;,</span><br><span class="line">  &quot;filter&quot;: [&quot;stop&quot;],</span><br><span class="line">  &quot;text&quot;: &quot;It is a dog&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<ul>
<li>结果：</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;tokens&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot;: &quot;It&quot;,</span><br><span class="line">      &quot;start_offset&quot;: 0,</span><br><span class="line">      &quot;end_offset&quot;: 2,</span><br><span class="line">      &quot;type&quot;: &quot;&lt;ALPHANUM&gt;&quot;,</span><br><span class="line">      &quot;position&quot;: 0</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot;: &quot;dog&quot;,</span><br><span class="line">      &quot;start_offset&quot;: 8,</span><br><span class="line">      &quot;end_offset&quot;: 11,</span><br><span class="line">      &quot;type&quot;: &quot;&lt;ALPHANUM&gt;&quot;,</span><br><span class="line">      &quot;position&quot;: 3</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<hr>


<ul>
<li>lowercase：将分词后的大写字母全部转换为小写字母</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">GET /_analyze</span><br><span class="line">&#123;</span><br><span class="line">  &quot;tokenizer&quot;: &quot;standard&quot;,</span><br><span class="line">  &quot;filter&quot;: [&quot;lowercase&quot;],</span><br><span class="line">  &quot;text&quot;: &quot;I am Chinese&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>



<ul>
<li>结果：</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;tokens&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot;: &quot;i&quot;,</span><br><span class="line">      &quot;start_offset&quot;: 0,</span><br><span class="line">      &quot;end_offset&quot;: 1,</span><br><span class="line">      &quot;type&quot;: &quot;&lt;ALPHANUM&gt;&quot;,</span><br><span class="line">      &quot;position&quot;: 0</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot;: &quot;am&quot;,</span><br><span class="line">      &quot;start_offset&quot;: 2,</span><br><span class="line">      &quot;end_offset&quot;: 4,</span><br><span class="line">      &quot;type&quot;: &quot;&lt;ALPHANUM&gt;&quot;,</span><br><span class="line">      &quot;position&quot;: 1</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot;: &quot;chinese&quot;,</span><br><span class="line">      &quot;start_offset&quot;: 5,</span><br><span class="line">      &quot;end_offset&quot;: 12,</span><br><span class="line">      &quot;type&quot;: &quot;&lt;ALPHANUM&gt;&quot;,</span><br><span class="line">      &quot;position&quot;: 2</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>



<blockquote>
<p>更多token filters参考ES官网：<a class="link"   target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/analysis-tokenfilters.html" >https://www.elastic.co/guide/en/elasticsearch/reference/current/analysis-tokenfilters.html <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
</blockquote>
<h2 id="5-3-自定义分析器"><a href="#5-3-自定义分析器" class="headerlink" title="5.3 自定义分析器"></a>5.3 自定义分析器</h2><p>我们了解过了分析器的组成部分后，发现一个完整的分词器由<strong>字符过滤器、分词器、token过滤器</strong>三个组件组成，我们想要自定义一个分析器也无非是定义char_filter，tokenizer，filter（token filter）</p>
<p>自定义分析器：</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">DELETE test</span><br><span class="line"></span><br><span class="line">PUT /test</span><br><span class="line">&#123;</span><br><span class="line">	&quot;settings&quot;: &#123;</span><br><span class="line">		&quot;analysis&quot;: &#123;</span><br><span class="line">			&quot;analyzer&quot;: &#123;</span><br><span class="line">				&quot;my_analyzer&quot;: &#123;									# 自定义分析器</span><br><span class="line">					&quot;type&quot;: &quot;custom&quot;,</span><br><span class="line">					&quot;char_filter&quot;: [</span><br><span class="line">						&quot;my_char_filter&quot;							# 分析器中采用的字符过滤器</span><br><span class="line">					],</span><br><span class="line">					&quot;tokenizer&quot;: &quot;my_tokenizer&quot;,					# 分析器中采用的分词器	</span><br><span class="line">					&quot;filter&quot;: [</span><br><span class="line">						&quot;my_tokenizer_filter&quot;						# 分析器中采用的token过滤器</span><br><span class="line">					]</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;,</span><br><span class="line">			&quot;char_filter&quot;: &#123;			</span><br><span class="line">				&quot;my_char_filter&quot;: &#123;									# 自定义字符过滤器</span><br><span class="line">					&quot;type&quot;: &quot;mapping&quot;,</span><br><span class="line">					&quot;mappings&quot;: [&quot;&amp; =&gt; love&quot;]</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;,</span><br><span class="line">			&quot;tokenizer&quot;: &#123;</span><br><span class="line">				&quot;my_tokenizer&quot;: &#123;									# 自定义分词器</span><br><span class="line">					&quot;type&quot;: &quot;standard&quot;,</span><br><span class="line">					&quot;max_token_length&quot;:120							# 拆分后的词最大只能120字符</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;,</span><br><span class="line">			&quot;filter&quot;: &#123;</span><br><span class="line">				&quot;my_tokenizer_filter&quot;: &#123;							# 自定义token过滤器</span><br><span class="line">					&quot;type&quot;: &quot;stop&quot;,</span><br><span class="line">					&quot;stopwords&quot;:[&quot;i&quot;,&quot;am&quot;,&quot;a&quot;,&quot;my&quot;],				# 停用词库(一旦自定义词库了,那么stop过滤器的默认词库将不再生效)</span><br><span class="line">					&quot;ignore_case&quot;:true								# 停用忽略大小写</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>



<ul>
<li>测试自定义分词器：</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">GET /test/_analyze</span><br><span class="line">&#123;</span><br><span class="line">  &quot;analyzer&quot;: &quot;my_analyzer&quot;,</span><br><span class="line">  &quot;text&quot;: &quot;I am a Chinese . I &amp; my country&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/ElasticSearch1/36.png"
                     
                ></p>
<h2 id="5-4-IK-分析器"><a href="#5-4-IK-分析器" class="headerlink" title="5.4 IK 分析器"></a>5.4 IK 分析器</h2><h3 id="5-4-1-配置IK分析器"><a href="#5-4-1-配置IK分析器" class="headerlink" title="5.4.1 配置IK分析器"></a>5.4.1 配置IK分析器</h3><p>下载地址：<a class="link"   target="_blank" rel="noopener" href="https://github.com/medcl/elasticsearch-analysis-ik/releases" >https://github.com/medcl/elasticsearch-analysis-ik/releases <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a> 下载7.3.2 版本课程配套资源也提供了:elasticsearch\elasticsearch-analysis-ik-7.3.2.zip</p>
<p>（1）先将其解压，将解压后的 elasticsearch 文件夹重命名文件夹为 ik </p>
<p>（2）将 ik文件夹拷贝到 elasticsearch&#x2F;plugins 目录下。</p>
<p>（3）重新启动，即可加载 IK 分词器</p>
<h3 id="5-4-2-IK-分析器测试"><a href="#5-4-2-IK-分析器测试" class="headerlink" title="5.4.2 IK 分析器测试"></a>5.4.2 IK 分析器测试</h3><p>IK 提供了两个分词算法 ik_smart 和 ik_max_word其中 ik_smart 灵活拆分，ik_max_word 为最细粒度划分我们分别来试一下</p>
<p>（1）灵活拆分（粗粒度）：在浏览器地址栏输入地址</p>
<div class="highlight-container" data-rel="Http"><figure class="iseeu highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://127.0.0.1:9200/_analyze?analyzer=ik_smart&amp;pretty=true&amp;text=百度搜索引擎非常好</span><br></pre></td></tr></table></figure></div>

<p>输出的结果为：</p>
<div class="highlight-container" data-rel="Json"><figure class="iseeu highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;tokens&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;百度&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span> <span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;CN_WORD&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span> <span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;搜索引擎&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span> <span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span> <span class="punctuation">:</span> <span class="number">6</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;CN_WORD&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span> <span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;非常好&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span> <span class="punctuation">:</span> <span class="number">6</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span> <span class="punctuation">:</span> <span class="number">9</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;CN_WORD&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span> <span class="punctuation">:</span> <span class="number">2</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></div>

<p>（2）最细切分：在浏览器地址栏输入地址</p>
<div class="highlight-container" data-rel="Http"><figure class="iseeu highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://127.0.0.1:9200/_analyze?analyzer=ik_max_word&amp;pretty=true&amp;text=百度搜索引擎非常好</span><br></pre></td></tr></table></figure></div>

<p>输出的结果为：</p>
<div class="highlight-container" data-rel="Json"><figure class="iseeu highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;tokens&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;百度搜&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span> <span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;CN_WORD&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span> <span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;百度&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span> <span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;CN_WORD&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span> <span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;百&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;TYPE_CNUM&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span> <span class="punctuation">:</span> <span class="number">2</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;度&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span> <span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;COUNT&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span> <span class="punctuation">:</span> <span class="number">3</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;搜索引擎&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span> <span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span> <span class="punctuation">:</span> <span class="number">6</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;CN_WORD&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span> <span class="punctuation">:</span> <span class="number">4</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;搜索&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span> <span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span> <span class="punctuation">:</span> <span class="number">4</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;CN_WORD&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span> <span class="punctuation">:</span> <span class="number">5</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;索引&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span> <span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span> <span class="punctuation">:</span> <span class="number">5</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;CN_WORD&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span> <span class="punctuation">:</span> <span class="number">6</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;索&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span> <span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span> <span class="punctuation">:</span> <span class="number">4</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;CN_WORD&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span> <span class="punctuation">:</span> <span class="number">7</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;引擎&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span> <span class="punctuation">:</span> <span class="number">4</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span> <span class="punctuation">:</span> <span class="number">6</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;CN_WORD&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span> <span class="punctuation">:</span> <span class="number">8</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;擎&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span> <span class="punctuation">:</span> <span class="number">5</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span> <span class="punctuation">:</span> <span class="number">6</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;CN_WORD&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span> <span class="punctuation">:</span> <span class="number">9</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;非常好&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span> <span class="punctuation">:</span> <span class="number">6</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span> <span class="punctuation">:</span> <span class="number">9</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;CN_WORD&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span> <span class="punctuation">:</span> <span class="number">10</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;非常&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span> <span class="punctuation">:</span> <span class="number">6</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span> <span class="punctuation">:</span> <span class="number">8</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;CN_WORD&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span> <span class="punctuation">:</span> <span class="number">11</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;好&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span> <span class="punctuation">:</span> <span class="number">8</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span> <span class="punctuation">:</span> <span class="number">9</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;CN_CHAR&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span> <span class="punctuation">:</span> <span class="number">12</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></div>

<h3 id="5-4-3-自定义词库"><a href="#5-4-3-自定义词库" class="headerlink" title="5.4.3 自定义词库"></a>5.4.3 自定义词库</h3><p>我们现在测试”东标方准”</p>
<div class="highlight-container" data-rel="Http"><figure class="iseeu highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://127.0.0.1:9200/_analyze?analyzer=ik_smart&amp;pretty=true&amp;text=东标方准</span><br></pre></td></tr></table></figure></div>

<p>浏览器的测试效果如下：</p>
<div class="highlight-container" data-rel="Json"><figure class="iseeu highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;tokens&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;东&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;CN_CHAR&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span> <span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;标&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span> <span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;CN_CHAR&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span> <span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;方&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span> <span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span> <span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;CN_CHAR&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span> <span class="punctuation">:</span> <span class="number">2</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;准&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span> <span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span> <span class="punctuation">:</span> <span class="number">4</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;CN_CHAR&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span> <span class="punctuation">:</span> <span class="number">3</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></div>

<p>默认的分词并没有识别“东标方准”是一个词。如果我们想让系统识别“东标方准”是一个词，需要编辑自定义词库。步骤：</p>
<p>（1）进入 elasticsearch&#x2F;plugins&#x2F;ik&#x2F;config 目录</p>
<p>（2）新建一个 ext.dic 文件，编辑内容：</p>
<div class="highlight-container" data-rel="Txt"><figure class="iseeu highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">东标方准</span><br></pre></td></tr></table></figure></div>

<p>修改 IKAnalyzer.cfg.xml（在 ik&#x2F;config 目录下）</p>
<div class="highlight-container" data-rel="Xml"><figure class="iseeu highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">properties</span> <span class="keyword">SYSTEM</span> <span class="string">&quot;http://java.sun.com/dtd/properties.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">comment</span>&gt;</span>IK Analyzer 扩展配置<span class="tag">&lt;/<span class="name">comment</span>&gt;</span></span><br><span class="line">	<span class="comment">&lt;!--用户可以在这里配置自己的扩展字典 --&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">&quot;ext_dict&quot;</span>&gt;</span>ext.dic;<span class="tag">&lt;/<span class="name">entry</span>&gt;</span></span><br><span class="line">	 <span class="comment">&lt;!--用户可以在这里配置自己的扩展停止词字典--&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">&quot;ext_stopwords&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">entry</span>&gt;</span></span><br><span class="line">	<span class="comment">&lt;!--用户可以在这里配置远程扩展字典 --&gt;</span></span><br><span class="line">	<span class="comment">&lt;!-- &lt;entry key=&quot;remote_ext_dict&quot;&gt;words_location&lt;/entry&gt; --&gt;</span></span><br><span class="line">	<span class="comment">&lt;!--用户可以在这里配置远程扩展停止词字典--&gt;</span></span><br><span class="line">	<span class="comment">&lt;!-- &lt;entry key=&quot;remote_ext_stopwords&quot;&gt;words_location&lt;/entry&gt; --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br></pre></td></tr></table></figure></div>

<p>重新启动 elasticsearch,通过浏览器测试分词效果</p>
<div class="highlight-container" data-rel="Http"><figure class="iseeu highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://127.0.0.1:9200/_analyze?analyzer=ik_smart&amp;pretty=true&amp;text=东标方准</span><br></pre></td></tr></table></figure></div>

<p>浏览器的测试效果如下：</p>
<div class="highlight-container" data-rel="Json"><figure class="iseeu highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;tokens&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;东标方准&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span> <span class="punctuation">:</span> <span class="number">4</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;CN_WORD&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;position&quot;</span> <span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></div>

<p>使用kibana语法测试：</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">GET _analyze</span><br><span class="line">&#123;</span><br><span class="line">  &quot;text&quot;:&quot;东标方准&quot;,</span><br><span class="line">  &quot;analyzer&quot;: &quot;ik_smart&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/ElasticSearch1/29.png"
                     
                ></p>
<h3 id="5-4-4-停用词"><a href="#5-4-4-停用词" class="headerlink" title="5.4.4 停用词"></a>5.4.4 停用词</h3><ul>
<li>测试：</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">GET _analyze</span><br><span class="line">&#123;</span><br><span class="line">  &quot;text&quot;:&quot;很贵的手机啊&quot;,</span><br><span class="line">  &quot;analyzer&quot;: &quot;ik_smart&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/ElasticSearch1/37.png"
                     
                ></p>
<p>我们发现”啊”这个词是无意义的，应该不参与分词（降低分词的数量、提高搜索的精准度）</p>
<p>（1）进入 elasticsearch&#x2F;plugins&#x2F;ik&#x2F;config 目录</p>
<p>（2）新建一个 stop.dic 文件，编辑内容：</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">啊</span><br></pre></td></tr></table></figure></div>

<p>修改 IKAnalyzer.cfg.xml（在 ik&#x2F;config 目录下）</p>
<div class="highlight-container" data-rel="Xml"><figure class="iseeu highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">properties</span> <span class="keyword">SYSTEM</span> <span class="string">&quot;http://java.sun.com/dtd/properties.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">comment</span>&gt;</span>IK Analyzer 扩展配置<span class="tag">&lt;/<span class="name">comment</span>&gt;</span></span><br><span class="line">	<span class="comment">&lt;!--用户可以在这里配置自己的扩展字典 --&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">&quot;ext_dict&quot;</span>&gt;</span>ext.dic;<span class="tag">&lt;/<span class="name">entry</span>&gt;</span></span><br><span class="line">	 <span class="comment">&lt;!--用户可以在这里配置自己的扩展停止词字典--&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">&quot;ext_stopwords&quot;</span>&gt;</span>stop.dic<span class="tag">&lt;/<span class="name">entry</span>&gt;</span></span><br><span class="line">	<span class="comment">&lt;!--用户可以在这里配置远程扩展字典 --&gt;</span></span><br><span class="line">	<span class="comment">&lt;!-- &lt;entry key=&quot;remote_ext_dict&quot;&gt;words_location&lt;/entry&gt; --&gt;</span></span><br><span class="line">	<span class="comment">&lt;!--用户可以在这里配置远程扩展停止词字典--&gt;</span></span><br><span class="line">	<span class="comment">&lt;!-- &lt;entry key=&quot;remote_ext_stopwords&quot;&gt;words_location&lt;/entry&gt; --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br></pre></td></tr></table></figure></div>

<p>重新启动 elasticsearch,通过浏览器测试分词效果</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">GET _analyze</span><br><span class="line">&#123;</span><br><span class="line">  &quot;text&quot;:&quot;很贵的手机啊&quot;,</span><br><span class="line">  &quot;analyzer&quot;: &quot;ik_smart&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/ElasticSearch1/38.png"
                     
                ></p>
<h3 id="5-4-5-ik-smart-和-ik-max-word"><a href="#5-4-5-ik-smart-和-ik-max-word" class="headerlink" title="5.4.5 ik_smart 和 ik_max_word"></a>5.4.5 ik_smart 和 ik_max_word</h3><p>我们刚刚配置完了IK分词器，了解到IK分词器提供有ik_smart（灵活拆分）和ik_max_word（最细粒度拆分）等方法</p>
<p>我们尝试两种拆分方法拆词”百度搜索引擎非常好”，得到如下词组：</p>
<ul>
<li>ik_smart：</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">GET _analyze</span><br><span class="line">&#123;</span><br><span class="line">  &quot;text&quot;:&quot;百度搜索引擎非常好&quot;,</span><br><span class="line">  &quot;analyzer&quot;: &quot;ik_smart&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<ul>
<li>结果：</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">百度、搜索引擎、非常好</span><br></pre></td></tr></table></figure></div>

<hr>


<ul>
<li>ik_max_word：</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">GET _analyze</span><br><span class="line">&#123;</span><br><span class="line">  &quot;text&quot;:&quot;百度搜索引擎非常好&quot;,</span><br><span class="line">  &quot;analyzer&quot;: &quot;ik_max_word&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<ul>
<li>结果：</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">百度搜、百度、百、度、搜索引擎、搜索、索引、索、引擎、擎、非常好、非常、好</span><br></pre></td></tr></table></figure></div>

<p>发现ik_max_wor明显比ik_smart拆词要多的多，那实际开发用哪种呢？</p>
<p><strong><font color='#B266FF'>答：建立索引时使用ik_max_word，搜索时使用ik_smart</font></strong></p>
<p>ik_smart体现在”灵活”两字，我们在搜索”百度搜索引擎非常好”，查询的应该是”百度”、”搜索引擎”等关键字，而不是查询”索引”、”引擎”等关键字</p>
<p>但在建立索引时，我们希望能够更细粒度的拆分词语，如”索引”、”引擎”等都属于一个完整的词语</p>
<p>像”索”、”好”这样的词语我们可以针对性的做停用</p>
<h2 id="5-5-Nginx实现词库热更新"><a href="#5-5-Nginx实现词库热更新" class="headerlink" title="5.5 Nginx实现词库热更新"></a>5.5 Nginx实现词库热更新</h2><p>我们的ik分词器词库是在IKAnalyzer.cfg.xml配置文件中配置的，但是每次修改词库的词语时，都必须重启ES，非常麻烦；为此我们可以配置采用Nginx来代理我们的词库文件，让IK分词器通过网络去Nginx中抓取最新的词库，这样就可以实现词库的热更新了；</p>
<p>修改Nginx的HTTP块配置：</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">http &#123;</span><br><span class="line">	...</span><br><span class="line">    include       mime.types;</span><br><span class="line">    # default_type  application/octet-stream;</span><br><span class="line">    default_type  &#x27;text/plain;charset=utf8&#x27;;		# 修改默认的相应格式</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>在Nginx的html目录新增一个词库文件，随便放置些内容：</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">东标方准</span><br></pre></td></tr></table></figure></div>

<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/ElasticSearch1/102.png"
                      style="zoom:50%;" 
                >

<p>启动Nginx，访问：<a class="link"   target="_blank" rel="noopener" href="http://localhost/ext.dic" >http://localhost/ext.dic <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/ElasticSearch1/103.png"
                      style="zoom:50%;" 
                >

<p>修改IKAnalyzer.cfg.xml配置文件，配置远程字典，让其指向Nginx代理的目录：</p>
<div class="highlight-container" data-rel="Xml"><figure class="iseeu highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">properties</span> <span class="keyword">SYSTEM</span> <span class="string">&quot;http://java.sun.com/dtd/properties.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">comment</span>&gt;</span>IK Analyzer 扩展配置<span class="tag">&lt;/<span class="name">comment</span>&gt;</span></span><br><span class="line">	<span class="comment">&lt;!--用户可以在这里配置自己的扩展字典 --&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">&quot;ext_dict&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">entry</span>&gt;</span></span><br><span class="line">	 <span class="comment">&lt;!--用户可以在这里配置自己的扩展停止词字典--&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">&quot;ext_stopwords&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">entry</span>&gt;</span></span><br><span class="line">	<span class="comment">&lt;!--用户可以在这里配置远程扩展字典 --&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">&quot;remote_ext_dict&quot;</span>&gt;</span>http://localhost/ext.dic<span class="tag">&lt;/<span class="name">entry</span>&gt;</span></span><br><span class="line">	<span class="comment">&lt;!--用户可以在这里配置远程扩展停止词字典--&gt;</span></span><br><span class="line">	<span class="comment">&lt;!-- &lt;entry key=&quot;remote_ext_stopwords&quot;&gt;words_location&lt;/entry&gt; --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br></pre></td></tr></table></figure></div>



<p>使用Kibana发送请求：</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">POST _analyze</span><br><span class="line">&#123;</span><br><span class="line">  &quot;analyzer&quot;: &quot;ik_smart&quot;,</span><br><span class="line">  &quot;text&quot;: &quot;东标方准&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>动态在Nginx中的ext.dic文件中添加词语，查看是否有热更新（需要等待1分钟左右的时间）；</p>
<h1 id="六、ElasticSearch-管理"><a href="#六、ElasticSearch-管理" class="headerlink" title="六、ElasticSearch 管理"></a>六、ElasticSearch 管理</h1><h2 id="6-1-ES-数据删除"><a href="#6-1-ES-数据删除" class="headerlink" title="6.1 ES 数据删除"></a>6.1 ES 数据删除</h2><p>在ES中，对一篇文档进行删除并不会立即物理删除，而是将该文档”标记”为删除，当数据量越来越多时，ES会在适当的时机在后台自动删除那些已经被标记删除的文档。</p>
<p>其实我们通过版本号的变更就可以发现，我们delete一篇文档实质上并没有删除。</p>
<ul>
<li>1）新增一篇文档：</li>
</ul>
<div class="highlight-container" data-rel="Json"><figure class="iseeu highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">PUT /test/_doc/<span class="number">100</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;field1&quot;</span><span class="punctuation">:</span><span class="string">&quot;test1&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;field2&quot;</span><span class="punctuation">:</span><span class="string">&quot;test2&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></div>

<ul>
<li>2）查看返回结果：</li>
</ul>
<div class="highlight-container" data-rel="Json"><figure class="iseeu highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;_index&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;test&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;_doc&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;100&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_version&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;result&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;created&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_shards&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;total&quot;</span> <span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;successful&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;failed&quot;</span> <span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_seq_no&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_primary_term&quot;</span> <span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></div>

<ul>
<li>3）删除此文档：</li>
</ul>
<div class="highlight-container" data-rel="Json"><figure class="iseeu highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DELETE /test/_doc/<span class="number">100</span></span><br></pre></td></tr></table></figure></div>

<ul>
<li>4）查看返回结果：</li>
</ul>
<div class="highlight-container" data-rel="Json"><figure class="iseeu highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;_index&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;test&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;_doc&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;100&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_version&quot;</span> <span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;result&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;deleted&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_shards&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;total&quot;</span> <span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;successful&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;failed&quot;</span> <span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_seq_no&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_primary_term&quot;</span> <span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></div>

<blockquote>
<p>发现版本号变为了2</p>
</blockquote>
<ul>
<li>5）再次新增一篇id为100的文档：</li>
</ul>
<div class="highlight-container" data-rel="Json"><figure class="iseeu highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">PUT /test/_doc/<span class="number">100</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;field1&quot;</span><span class="punctuation">:</span><span class="string">&quot;test1&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;field2&quot;</span><span class="punctuation">:</span><span class="string">&quot;test2&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></div>

<ul>
<li>6）查看返回结果：</li>
</ul>
<div class="highlight-container" data-rel="Json"><figure class="iseeu highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;_index&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;test&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;_doc&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;100&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_version&quot;</span> <span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;result&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;created&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_shards&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;total&quot;</span> <span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;successful&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;failed&quot;</span> <span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_seq_no&quot;</span> <span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_primary_term&quot;</span> <span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></div>

<blockquote>
<p>发现版本号变为了3</p>
</blockquote>
<h2 id="6-2-ES-全量替换"><a href="#6-2-ES-全量替换" class="headerlink" title="6.2 ES 全量替换"></a>6.2 ES 全量替换</h2><p><strong>例如：此时有一个document如下</strong></p>
<div class="highlight-container" data-rel="Json"><figure class="iseeu highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">DELETE goodsindex</span><br><span class="line"></span><br><span class="line">PUT /goodsindex/_doc/<span class="number">1</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="string">&quot;huawei shouji&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span><span class="string">&quot;huawei 4G quanmianping youxi shouji&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;price&quot;</span><span class="punctuation">:</span><span class="number">4899</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;category&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span><span class="string">&quot;youxi&quot;</span><span class="punctuation">,</span><span class="string">&quot;4G&quot;</span><span class="punctuation">,</span><span class="string">&quot;quanmianping&quot;</span><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></div>

<p>需要修改price价格为2899</p>
<p>语法为：</p>
<div class="highlight-container" data-rel="Json"><figure class="iseeu highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">PUT /goodsindex/_doc/<span class="number">1</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="string">&quot;huawei shouji&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span><span class="string">&quot;huawei 4G quanmianping youxi shouji&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;price&quot;</span><span class="punctuation">:</span><span class="number">2899</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;category&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span><span class="string">&quot;youxi&quot;</span><span class="punctuation">,</span><span class="string">&quot;4G&quot;</span><span class="punctuation">,</span><span class="string">&quot;quanmianping&quot;</span><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></div>

<blockquote>
<p>如果不传递其他字段，那么其他字段将会被清空</p>
</blockquote>
<p>为了进行一个字段修改，我们必须需要知道其他字段的值，这时我们就需要进行一次查询，查询该document的所有字段值，然后将不需要修改的字段原封不动写入到语句中</p>
<p>也就是说，全量替换的操作步骤总结为：</p>
<p>1）进行一次get查询操作，查找需要进行修改的doucment对应所有详细信息。</p>
<p>2）除了需要修改的字段进行字段修改，其他数值原封不动的写入put请求中</p>
<p>可以很容易的看出，进行一次真正的数据的修改，需要用户先进行查询，然后对查询的数据进行修改之后在写入到es中，耗费的时间相对的也会更长。在写入的数据的时候，可能别人已经对数据进行了修改，<strong>容易产生并发冲突的情况</strong></p>
<p>针对于这种现象我们可以在操作时加锁控制</p>
<h2 id="6-3-partial-update"><a href="#6-3-partial-update" class="headerlink" title="6.3 partial update"></a>6.3 partial update</h2><p>针对某个字段的改变我们可以使用partial update。</p>
<p><code>update</code> 请求是接收文档的一部分作为 <code>doc</code> 的参数， 它只是与现有的文档进行合并。对象被合并到一起，覆盖现有的字段，增加新的字段。</p>
<ul>
<li>语法：</li>
</ul>
<div class="highlight-container" data-rel="Json"><figure class="iseeu highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">POST /index/type/id/_update </span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">   <span class="attr">&quot;doc&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;field&quot;</span><span class="punctuation">:</span><span class="string">&quot;value&quot;</span></span><br><span class="line">   <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></div>

<ul>
<li>示例：</li>
</ul>
<div class="highlight-container" data-rel="Json"><figure class="iseeu highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">POST /goodsindex/_doc/<span class="number">1</span>/_update </span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">   <span class="attr">&quot;doc&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;price&quot;</span><span class="punctuation">:</span><span class="number">2199</span></span><br><span class="line">   <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></div>

<p>再次查询id为1的文档：</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;_index&quot; : &quot;goodsindex&quot;,</span><br><span class="line">  &quot;_type&quot; : &quot;_doc&quot;,</span><br><span class="line">  &quot;_id&quot; : &quot;1&quot;,</span><br><span class="line">  &quot;_version&quot; : 5,</span><br><span class="line">  &quot;_seq_no&quot; : 4,</span><br><span class="line">  &quot;_primary_term&quot; : 1,</span><br><span class="line">  &quot;found&quot; : true,</span><br><span class="line">  &quot;_source&quot; : &#123;</span><br><span class="line">    &quot;price&quot; : &quot;2199&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h2 id="6-4-强制创建"><a href="#6-4-强制创建" class="headerlink" title="6.4 强制创建"></a>6.4 强制创建</h2><p>有时我们只是想新建文档，不想替换文档，可以借助ES的API来实现。</p>
<div class="highlight-container" data-rel="Json"><figure class="iseeu highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">PUT /index/type/id?op_type=create</span><br><span class="line">或</span><br><span class="line">PUT /index/type/id/_create</span><br></pre></td></tr></table></figure></div>

<ul>
<li>示例：</li>
</ul>
<div class="highlight-container" data-rel="Json"><figure class="iseeu highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">PUT /test/_doc/<span class="number">1</span>?op_type=create</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;field1&quot;</span><span class="punctuation">:</span><span class="string">&quot;test1&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;field2&quot;</span><span class="punctuation">:</span><span class="string">&quot;test2&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></div>

<p>报错，因为ES中已经有了id为1的文档：</p>
<div class="highlight-container" data-rel="Json"><figure class="iseeu highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;error&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;root_cause&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;version_conflict_engine_exception&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;reason&quot;</span><span class="punctuation">:</span> <span class="string">&quot;[1]: version conflict, document already exists (current version [1])&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;index_uuid&quot;</span><span class="punctuation">:</span> <span class="string">&quot;cP9dgNlXRZOTN6vIBPFKHw&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;shard&quot;</span><span class="punctuation">:</span> <span class="string">&quot;0&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;index&quot;</span><span class="punctuation">:</span> <span class="string">&quot;test&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;version_conflict_engine_exception&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;reason&quot;</span><span class="punctuation">:</span> <span class="string">&quot;[1]: version conflict, document already exists (current version [1])&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;index_uuid&quot;</span><span class="punctuation">:</span> <span class="string">&quot;cP9dgNlXRZOTN6vIBPFKHw&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;shard&quot;</span><span class="punctuation">:</span> <span class="string">&quot;0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;index&quot;</span><span class="punctuation">:</span> <span class="string">&quot;test&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;status&quot;</span><span class="punctuation">:</span> <span class="number">409</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></div>

<h1 id="七、ElasticSearch-高级应用"><a href="#七、ElasticSearch-高级应用" class="headerlink" title="七、ElasticSearch 高级应用"></a>七、ElasticSearch 高级应用</h1><h2 id="7-1-bulk批量操作"><a href="#7-1-bulk批量操作" class="headerlink" title="7.1 bulk批量操作"></a>7.1 bulk批量操作</h2><p>bulk用于增删改的批量操作，分为delete、create（强制创建）、index（普通创建和全量替换）、update等</p>
<p>（1）<code>delete</code>：删除文档</p>
<ul>
<li>语法：</li>
</ul>
<div class="highlight-container" data-rel="Json"><figure class="iseeu highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">POST /_bulk</span><br><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;delete&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;_index&quot;</span><span class="punctuation">:</span><span class="string">&quot;test&quot;</span><span class="punctuation">,</span><span class="attr">&quot;_type&quot;</span><span class="punctuation">:</span><span class="string">&quot;_doc&quot;</span><span class="punctuation">,</span><span class="attr">&quot;_id&quot;</span><span class="punctuation">:</span><span class="string">&quot;1&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;delete&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;_index&quot;</span><span class="punctuation">:</span><span class="string">&quot;test&quot;</span><span class="punctuation">,</span><span class="attr">&quot;_type&quot;</span><span class="punctuation">:</span><span class="string">&quot;_doc&quot;</span><span class="punctuation">,</span><span class="attr">&quot;_id&quot;</span><span class="punctuation">:</span><span class="string">&quot;100&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></div>



<p>（2）<code>create</code>：强制创建</p>
<ul>
<li>语法：</li>
</ul>
<div class="highlight-container" data-rel="Json"><figure class="iseeu highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">POST /_bulk</span><br><span class="line"><span class="punctuation">&#123;</span> <span class="attr">&quot;create&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;_index&quot;</span><span class="punctuation">:</span> <span class="string">&quot;test&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;_doc&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#123;</span> <span class="attr">&quot;field&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2&quot;</span> <span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></div>



<blockquote>
<p>create属于强制创建，如果有了对应的id那么则会出现<code>version conflict, document already exists (current version [1]</code></p>
</blockquote>
<p>（3）<code>index</code>：普通的put操作，可以是创建文档，也可以是全量替换文档</p>
<ul>
<li>语法：</li>
</ul>
<div class="highlight-container" data-rel="Json"><figure class="iseeu highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">POST /_bulk</span><br><span class="line"><span class="punctuation">&#123;</span> <span class="attr">&quot;index&quot;</span><span class="punctuation">:</span>  <span class="punctuation">&#123;</span> <span class="attr">&quot;_index&quot;</span><span class="punctuation">:</span> <span class="string">&quot;test&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;_doc&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#123;</span> <span class="attr">&quot;field&quot;</span><span class="punctuation">:</span><span class="string">&quot;3&quot;</span> <span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></div>



<p>（4）<code>update</code>：执行的partial update操作</p>
<ul>
<li>语法：</li>
</ul>
<div class="highlight-container" data-rel="Json"><figure class="iseeu highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">POST /_bulk</span><br><span class="line"><span class="punctuation">&#123;</span> <span class="attr">&quot;update&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;_index&quot;</span><span class="punctuation">:</span> <span class="string">&quot;test&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;_doc&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1&quot;</span><span class="punctuation">&#125;</span> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#123;</span> <span class="attr">&quot;doc&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;field&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;2&quot;</span><span class="punctuation">&#125;</span> <span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></div>

<p>（5）可以bulk操作可以集成所有的操作：</p>
<div class="highlight-container" data-rel="Json"><figure class="iseeu highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">POST /_bulk</span><br><span class="line"><span class="punctuation">&#123;</span> <span class="attr">&quot;delete&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;_index&quot;</span><span class="punctuation">:</span> <span class="string">&quot;test&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;_doc&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">&#125;</span> </span><br><span class="line"><span class="punctuation">&#123;</span> <span class="attr">&quot;create&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;_index&quot;</span><span class="punctuation">:</span> <span class="string">&quot;test&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;_doc&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;100&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#123;</span> <span class="attr">&quot;field&quot;</span><span class="punctuation">:</span>    <span class="string">&quot;100&quot;</span> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#123;</span> <span class="attr">&quot;index&quot;</span><span class="punctuation">:</span>  <span class="punctuation">&#123;</span> <span class="attr">&quot;_index&quot;</span><span class="punctuation">:</span> <span class="string">&quot;test&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;_doc&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#123;</span> <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span>    <span class="string">&quot;200&quot;</span> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#123;</span> <span class="attr">&quot;update&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;_index&quot;</span><span class="punctuation">:</span> <span class="string">&quot;test&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;_doc&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2&quot;</span><span class="punctuation">&#125;</span> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#123;</span> <span class="attr">&quot;doc&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;newField&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;I am new field&quot;</span><span class="punctuation">&#125;</span> <span class="punctuation">&#125;</span> </span><br></pre></td></tr></table></figure></div>

<blockquote>
<p>bulk的每个请求是单独处理的，因此一个请求的成功或失败不会影响其他的请求。</p>
</blockquote>
<h2 id="7-2-DSL语法"><a href="#7-2-DSL语法" class="headerlink" title="7.2 DSL语法"></a>7.2 DSL语法</h2><p>DSL除了有<code>match</code>与<code>match_all</code>查询之外，还提供有其他方式的查询；</p>
<p>属于DSL语法查询的：</p>
<ul>
<li>match</li>
<li>match_all</li>
<li>term</li>
</ul>
<p>1）multi_match</p>
<p>multi_match用于从多个字段里面查询结果</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">DELETE goodsindex</span><br><span class="line"></span><br><span class="line">POST /goodsindex/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;name&quot;:&quot;huawei shouji&quot;,</span><br><span class="line">  &quot;title&quot;:&quot;huawei 4G quanmianping youxi shouji&quot;,</span><br><span class="line">  &quot;price&quot;:4899,</span><br><span class="line">  &quot;category&quot;:[&quot;youxi&quot;,&quot;4G&quot;,&quot;quanmianping&quot;]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST /goodsindex/_doc/2</span><br><span class="line">&#123;</span><br><span class="line">  &quot;name&quot;:&quot;vivo shouji&quot;,</span><br><span class="line">  &quot;title&quot;:&quot;vivo 5G paizhao shouji&quot;,</span><br><span class="line">  &quot;price&quot;:2899,</span><br><span class="line">  &quot;category&quot;:[&quot;5G&quot;,&quot;paizhao&quot;]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST /goodsindex/_doc/3</span><br><span class="line">&#123;</span><br><span class="line">  &quot;name&quot;:&quot;oppo zhineng&quot;,</span><br><span class="line">  &quot;title&quot;:&quot;oppo 5G paizhao shouji&quot;,</span><br><span class="line">  &quot;price&quot;:1899,</span><br><span class="line">  &quot;category&quot;:[&quot;5G&quot;,&quot;paizhao&quot;]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GET /goodsindex/_doc/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;multi_match&quot;: &#123;</span><br><span class="line">      &quot;query&quot;: &quot;5G&quot;,</span><br><span class="line">      &quot;fields&quot;: [&quot;name&quot;, &quot;title&quot;]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>2）range query</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">GET /goodsindex/_doc/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;range&quot;: &#123;</span><br><span class="line">      &quot;price&quot;: &#123;</span><br><span class="line">        &quot;gte&quot;: 1000,</span><br><span class="line">		&quot;lte&quot;: 3000</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>3）terms query</p>
<p>我们前面学习过term查询，term查询在查询单个词语时和match一致，但在查询多个词语时，term不会对搜索条件进行分词，而是直接将搜索条件当做一个整体去索引库搜索</p>
<p>terms query 则是多个term查询的简便写法</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET /goodsindex/_doc/_search</span><br><span class="line">&#123;</span><br><span class="line">	&quot;query&quot;: &#123;</span><br><span class="line">		&quot;terms&quot;: &#123;</span><br><span class="line">			&quot;title&quot;: [&quot;huawei 5g shouji&quot;,&quot;4g&quot;]</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<blockquote>
<p><strong>注意：5G、4G等要变为小写</strong></p>
</blockquote>
<p>4）exist query</p>
<p>exist query 只查询有某些字段值的文档</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">DELETE goodsindex</span><br><span class="line"></span><br><span class="line">POST /goodsindex/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;name&quot;:&quot;huawei shouji&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST /goodsindex/_doc/2</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">  &quot;title&quot;:&quot;vivo 5G paizhao shouji&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST /goodsindex/_doc/3</span><br><span class="line">&#123;</span><br><span class="line">  &quot;name&quot;:&quot;huawei shouji&quot;,</span><br><span class="line">  &quot;price&quot;:3899</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST /goodsindex/_doc/4</span><br><span class="line">&#123;</span><br><span class="line">  &quot;title&quot;:&quot;xiaomi 4G youxi shouji&quot;,</span><br><span class="line">  &quot;price&quot;:988,</span><br><span class="line">  &quot;category&quot;:[&quot;youxi&quot;,&quot;4G&quot;]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GET goodsindex/_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot;: &#123;</span><br><span class="line">        &quot;exists&quot;: &#123;</span><br><span class="line">            &quot;field&quot;: &quot;title&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>5）Fuzzy query</p>
<p><code>Fuzzy query</code>：模糊查询，返回包含与搜索词类似的词的文档</p>
<p>包括以下几种情况：</p>
<ul>
<li><p>更改字符（javd-&gt;Java）</p>
</li>
<li><p>删除字符（jva→Java）</p>
</li>
<li><p>插入字符（javaa→Java）</p>
</li>
<li><p>调换两个相邻字符（ajva→Java）</p>
</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">PUT article/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;title&quot;:&quot;Java入门到精通&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT article/_doc/2</span><br><span class="line">&#123;</span><br><span class="line">  &quot;title&quot;:&quot;C语言入门到精通&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT article/_doc/3</span><br><span class="line">&#123;</span><br><span class="line">  &quot;title&quot;:&quot;HTML入门到精通&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GET /article/_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot;: &#123;</span><br><span class="line">        &quot;fuzzy&quot;: &#123;</span><br><span class="line">            &quot;title&quot;: &#123;</span><br><span class="line">                &quot;value&quot;: &quot;javd&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>6）IDs query</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET /article/_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot;: &#123;</span><br><span class="line">        &quot;ids&quot; : &#123;</span><br><span class="line">            &quot;values&quot; : [&quot;1&quot;, &quot;2&quot;, &quot;5&quot;]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>



<p>7）prefix query</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">GET /article/_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot;: &#123;</span><br><span class="line">        &quot;prefix&quot;: &#123;</span><br><span class="line">            &quot;title&quot;: &#123;</span><br><span class="line">                &quot;value&quot;: &quot;java&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>



<p>8）regexp query</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">GET /article/_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot;: &#123;</span><br><span class="line">        &quot;regexp&quot;: &#123;</span><br><span class="line">            &quot;title&quot;: &#123;</span><br><span class="line">                &quot;value&quot;: &quot;j.*a&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>



<h1 id="八、ElasticSearch优势"><a href="#八、ElasticSearch优势" class="headerlink" title="八、ElasticSearch优势"></a>八、ElasticSearch优势</h1><h2 id="8-1-概念"><a href="#8-1-概念" class="headerlink" title="8.1 概念"></a>8.1 概念</h2><p><strong>1）近实时</strong>：ElasticSearch对数据的检索是近实时的，从数据写入到ElasticSearch的索引库到被可以检索到的过程非常少（秒级）</p>
<p><strong>2）集群管理</strong>：ElasticSearch的集群模式非常方便，我们可以修改ES的配置文件，让其自动加入到同一个集群当中，并完成集群的负载均衡、数据自动分片等，这些过程都不需要我们人工干预。</p>
<p><strong>3）shard</strong>：即分片，ES中的每个索引中的数据会分布在不同的shard当中，这些shard分布在ES集群中的各个节点中，当我们发送请求到达ES集群，ES能够自动去对应的shard上取出我们的数据。</p>
<p><strong>4）replica：</strong>即副本，我们知道ES把存储的数据分布在不同的shard上（当然，不同的shard又分布在不同的节点上），如果ES某个节点宕机，那么shard中的数据很可能就会丢失，因此，ES对每个shard都做了一个副本，副本中保存和shard一模一样的数据，在shard出现故障时，replica可以提供备用服务，保证数据不丢失。<strong>shard也称primary shard，replica也称 replica shard，两者都是shard。</strong>默认情况下，创建索引时，默认会分为10个shard，其中5个primary shard，每个primary shard都会分配一个副本，因此replica的数量也为5个。</p>
<blockquote>
<p>&#x3D;&#x3D;<strong>在7.0及以上版本，ES每个索引默认分配1一个primary shard和一个replica shard，也就是每个索引默认分配2个shard</strong>&#x3D;&#x3D;</p>
</blockquote>
<h2 id="8-2-ES-集群健康值"><a href="#8-2-ES-集群健康值" class="headerlink" title="8.2 ES 集群健康值"></a>8.2 ES 集群健康值</h2><p>ES集群状态分为green、yellow、red三种。</p>
<ul>
<li><code>green</code>：<strong>每个索引的primary shard和replica shard都处于激活状态。</strong></li>
<li><code>yellow</code>：<strong>每个索引的primary shard都是激活状态，但部分replica shard不是处于激活状态</strong></li>
<li><code>red</code>：<strong>有部分primary shard不是处于激活状态。</strong></li>
</ul>
<p><strong>为什么刚启动的ES的健康状态为yellow？（7.0之前版本）</strong></p>
<p><strong>原因：</strong>kibana在启动的时候会创建一个索引，该索引默认创建一个primary shard和一个replica shard，ES的shard分片规则是，primary shard和replica shard不能在同一台机器（容错考虑），现在我们启动了一台机器，只有一个primary shard被分配，另一个replica shard没有分配，因此处于yellow状态。</p>
<blockquote>
<p>7.0之后的kibana启动时会默认创建两个索引，一个是<code>.kibana_task_manager</code>，另一个是<code>.kibana_1</code>，两个索引默认都是分配1个primary shard，并且不建立副本，也就是0个replica shard，因此在7.0版本之后的kibana启动时，ES的集群健康值为<code>green</code></p>
</blockquote>
<blockquote>
<p>ES针对7.0版本的大改动：<a class="link"   target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/breaking-changes-7.0.html#breaking_70_indices_changes" >https://www.elastic.co/guide/en/elasticsearch/reference/current/breaking-changes-7.0.html#breaking_70_indices_changes <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
</blockquote>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/%5Cimages%5CElasticSearch2%5C101.png"
                     
                ></p>
<ul>
<li>查看集群信息：</li>
</ul>
<div class="highlight-container" data-rel="Http"><figure class="iseeu highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /_cat/health?v</span><br></pre></td></tr></table></figure></div>

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/%5Cimages%5CElasticSearch2%5C3.png"
                     
                ></p>
<blockquote>
<p>状态为green。</p>
</blockquote>
<h1 id="九、ElasticSearch-架构"><a href="#九、ElasticSearch-架构" class="headerlink" title="九、ElasticSearch 架构"></a>九、ElasticSearch 架构</h1><h2 id="9-1-ES内部架构"><a href="#9-1-ES内部架构" class="headerlink" title="9.1 ES内部架构"></a>9.1 ES内部架构</h2><h3 id="9-1-1-分片机制"><a href="#9-1-1-分片机制" class="headerlink" title="9.1.1 分片机制"></a>9.1.1 分片机制</h3><p>Elasticsearch 是利用分片将数据分发到集群内各处的。分片是数据的容器，文档保存在分片内，分片又被分配到集群内的各个节点里。 当你的集群规模扩大或者缩小时， Elasticsearch 会自动的在各节点中迁移分片，使得数据仍然均匀分布在集群里。</p>
<p>一个分片可以是主分片（primary shard）或者 副本分片（replica shard）。 <strong>索引内任意一个文档都归属于一个主分片</strong>，所以主分片的数目决定着索引能够保存的最大数据量。</p>
<p>当创建一个索引时，会默认分配1个primary shard和1个replica shard（7.0之后版本）用于存储后续的文档数据，ES会将数据平均分配到不同的shard，<strong>中间不需要我们做任何操作</strong>。</p>
<p>我们可以在创建索引的时候就指定分片情况：</p>
<div class="highlight-container" data-rel="Json"><figure class="iseeu highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">PUT /test_index</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">   <span class="attr">&quot;settings&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;number_of_shards&quot;</span> <span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;number_of_replicas&quot;</span> <span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">   <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></div>

<blockquote>
<p>Tips：</p>
<ol>
<li>上面的test_index索引创建了3个主分片，为每个主分配都创建了1个副本分片，共6个分片；</li>
<li>primary shard后期不可修改，replica shard可以随时修改</li>
</ol>
</blockquote>
<h3 id="9-1-2-集群发现机制"><a href="#9-1-2-集群发现机制" class="headerlink" title="9.1.2 集群发现机制"></a>9.1.2 集群发现机制</h3><p>当启动了新的ES节点时，当前ES节点会自动加入ES集群中（集群组是同一个），中间不需要我们做任何操作。</p>
<h3 id="9-1-3-shard-副本"><a href="#9-1-3-shard-副本" class="headerlink" title="9.1.3 shard 副本"></a>9.1.3 shard 副本</h3><p>shard 副本即replica shard，replica shard是primary shard的副本，存储的数据和primary shard一致，主要用于primary shard节点宕机后，数据的备份操作，当然replica shard也能分担读的请求。中间不需要我们做任何操作，我们要做的只是建立副本分片。</p>
<h3 id="9-1-4-shard-负载均衡"><a href="#9-1-4-shard-负载均衡" class="headerlink" title="9.1.4 shard 负载均衡"></a>9.1.4 shard 负载均衡</h3><p>我们知道数据是分布在不同的shard（primary shard）中的，并且内部有副本机制，分出来的replica shard也能帮助我们分担读的请求，当shard（primary &#x2F; replica）处理读写请求时，内部会自动的将压力平均分担到不同的shard，内部自动实现压力的负载均衡</p>
<h3 id="9-1-5-新增节点数据均分"><a href="#9-1-5-新增节点数据均分" class="headerlink" title="9.1.5 新增节点数据均分"></a>9.1.5 新增节点数据均分</h3><p>当ES集群中新增节点后，新的ES节点会来分担现有ES集群的shard数量，达到每个ES节点存储的数据量都一致。中间不需要我们做任何操作。并且ES会采用最优的方案进行数据的分片（集群容错数尽量达到最高）</p>
<h3 id="9-1-6-节点对等"><a href="#9-1-6-节点对等" class="headerlink" title="9.1.6 节点对等"></a>9.1.6 节点对等</h3><p>ES集群中的每个节点都能接收客户端的请求，但是我们知道ES的数据分片是分布在不同的节点中的，这些分片（shard）是真正存储数据的地方，当ES集群处理客户端请求时，处理请求的节点可能没有客户端想要的数据，ES节点会实现自动路由请求功能，自动去访问客户端需要数据的那个节点，然后把数据响应。中间不需要我们做任何操作。</p>
<p><strong>节点对等：</strong>即访问ES集群的任意一个节点效果的对等的（内部有自动路由功能）</p>
<blockquote>
<p> 以上所有功能都是ES集群帮我们提供的，都不需要我们<strong>人工干预</strong>。</p>
</blockquote>
<h2 id="9-2-ES的垂直与水平扩容"><a href="#9-2-ES的垂直与水平扩容" class="headerlink" title="9.2 ES的垂直与水平扩容"></a>9.2 ES的垂直与水平扩容</h2><h3 id="9-2-1-垂直扩容（纵向扩容）"><a href="#9-2-1-垂直扩容（纵向扩容）" class="headerlink" title="9.2.1 垂直扩容（纵向扩容）"></a>9.2.1 垂直扩容（纵向扩容）</h3><p>当后端服务出现性能瓶颈时，我们可以考虑增加服务器数量来达到整体性能的提高，垂直扩容简单理解就是增加少量高配置、高性能的服务器，来大幅提升服务器整体性能。</p>
<h3 id="9-2-2-水平扩容（横向扩容）"><a href="#9-2-2-水平扩容（横向扩容）" class="headerlink" title="9.2.2 水平扩容（横向扩容）"></a>9.2.2 水平扩容（横向扩容）</h3><p>水平扩容则指的是，增加若干台性能一般的服务器，来达到增强服务器服务的整体性能，一般来说，水平扩容比垂直扩容的价格成本低，但由于服务器数量远远比垂直扩容多，因此维护起来比垂直扩容要复杂许多。</p>
<p>对于大多数的数据库而言，通常需要对应用程序进行非常大的改动，才能利用上横向扩容的新增资源。 与之相反的是，ElastiSearch天生就是<strong>分布式</strong>的 ，它知道如何通过管理多节点来提高扩容性和可用性。 这也意味着你的应用无需关注这个问题。</p>
<blockquote>
<p>ES天生就是为了分布式而产生，ES集群中水平扩容显得尤为简单，集群数量的增多并不会给我们带来太多维护上的成本，因为ES集群管理非常方便。</p>
</blockquote>
<h2 id="9-3-ES的水平扩容"><a href="#9-3-ES的水平扩容" class="headerlink" title="9.3 ES的水平扩容"></a>9.3 ES的水平扩容</h2><h3 id="9-3-1-ES如何超出扩容极限"><a href="#9-3-1-ES如何超出扩容极限" class="headerlink" title="9.3.1 ES如何超出扩容极限"></a>9.3.1 ES如何超出扩容极限</h3><p>主分片的数目在索引创建时就已经确定了下来。实际上，这个数目定义了这个索引能够存储的最大数据量。 但是，读操作、搜索和返回数据等可以<strong>同时被主分片或副本分片所处理</strong>，所以当你拥有越多的副本分片时，也将拥有越高的吞吐量，前提是实际部署的机器数量也要很多，另外，副本分片的数量增加，会导致数据会比较冗余。</p>
<p>我们知道ES集群中提供有”<strong>新增节点均分</strong>功能”，即当有新的ES节点加入到ES集群中，ES内部会<strong>自动</strong>将不同的数据（shard）分配到不同的ES节点中，<strong>并且保证primary shard和replica shard不在同一个节点上（容错）。</strong></p>
<p><strong>思考：</strong>假设现有6个shard，3个primary shard，和1个replica shard，现在需要扩容到9台服务器中（每个节点更少的shard，IO&#x2F;CPU&#x2F;Memory等资源给每个shard分配更多，每个shard性能更好）</p>
<p><strong>答：</strong>增加replica shard的数量，因为primary shard的数据是不能改变的，我们只能修改replica shard。</p>
<p><strong>将replica的数量改为2。</strong></p>
<p>replica shard&#x3D;3*2&#x3D;6 replica shard</p>
<p>总的shard&#x3D;3（primary shard）+ 6 （replica shard）&#x3D;9台</p>
<p>如下：</p>
<div class="highlight-container" data-rel="Json"><figure class="iseeu highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">PUT /test_index/_settings</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">   <span class="attr">&quot;number_of_replicas&quot;</span> <span class="punctuation">:</span> <span class="number">2</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></div>

<blockquote>
<p>Tips：如果只是在相同节点数目的集群上增加更多的副本分片并不能提高性能，因为每个分片从节点上获得的资源会变少。 你需要增加更多的硬件资源来提升吞吐量。但是更多的副本分片数提高了数据冗余量，我们在实际开发中应当有所舍取</p>
</blockquote>
<p><font color=B266FF><strong>需要注意的是：ES的单个节点不会存储相同的shard的，这是为了容错的考虑，如果replica的数量设置为2，那么node的数量必须最少是3，才可以完全分配replica，因此<code>node = replica + 1</code>；</strong></font></p>
<h3 id="9-3-2-计算ES集群容错机器数"><a href="#9-3-2-计算ES集群容错机器数" class="headerlink" title="9.3.2 计算ES集群容错机器数"></a>9.3.2 计算ES集群容错机器数</h3><p>ES集群本身就考虑到了容错性（同一个索引的primary shard和replica shard不能在同一台机器），当一个ES集群已经搭建成功时，我们该如何知道ES集群的容错机器数呢？又要如何提升ES集群的容错机器数呢？</p>
<p>3个primar shard 每个primary shard都分配一个replica shard，那么有3个replica shard，总共有6个shard</p>
<ul>
<li>计算ES集群容错性</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/%5Cimages%5CElasticSearch2%5C11.png"
                     
                ></p>
<p>primary shard是3个，副本改为2，那么有6个replica shard，共有9个shard</p>
<ul>
<li>提高ES集群容错性</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/%5Cimages%5CElasticSearch2%5C12.png"
                     
                ></p>
<blockquote>
<p>此时在ES集群中，宕机任意两台服务器，整体的ES集群数据也不会变化。</p>
</blockquote>
<h2 id="9-4-ES集群的容错机制"><a href="#9-4-ES集群的容错机制" class="headerlink" title="9.4 ES集群的容错机制"></a>9.4 ES集群的容错机制</h2><p>当ES集群中某台Node宕机后，内部会发生一系列的操作来提高ES集群的可用性。</p>
<h3 id="9-4-1-Master选举"><a href="#9-4-1-Master选举" class="headerlink" title="9.4.1 Master选举"></a>9.4.1 Master选举</h3><p>当某台ES节点宕机后，内部会选出一台节点当做master节点，来负责master的操作，此时集群健康状态值（cluster status）为<strong>red状态</strong>。</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/%5Cimages%5CElasticSearch2%5C13.png"
                     
                ></p>
<h3 id="9-4-2-Replica-容错"><a href="#9-4-2-Replica-容错" class="headerlink" title="9.4.2 Replica 容错"></a>9.4.2 Replica 容错</h3><p>新的master会将原来宕机的那个节点的primary shard对应的replica shard提升为primary shard；此时该primary shard的副本就会少了一个，但正常的读写操作还是可以正常运行，由于整个集群的primary shard都已经分配，因此<code>cluster status</code>为<strong>yellow状态</strong>。</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/%5Cimages%5CElasticSearch2%5C14.png"
                     
                ></p>
<h3 id="9-4-3-ES集群数据恢复"><a href="#9-4-3-ES集群数据恢复" class="headerlink" title="9.4.3 ES集群数据恢复"></a>9.4.3 ES集群数据恢复</h3><p>如果我们重新启动宕机的node，在node宕机期间，数据很有可能已经发生了修改，新master会将更新了的数据copy一份到宕机的node上，&#x3D;&#x3D;<strong>宕机了的node上的primary shard变为replica shard</strong>&#x3D;&#x3D;。由于所有的primary shard和replica shard都已经分配，此时culster status为<strong>green状态</strong>（前提是可以重启成功）。</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/%5Cimages%5CElasticSearch2%5C15.png"
                     
                ></p>
<ul>
<li>完整的流程：</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/%5Cimages%5CElasticSearch2%5C16.png"
                     
                ></p>
<h1 id="五、ElasitcSearch-并发控制"><a href="#五、ElasitcSearch-并发控制" class="headerlink" title="五、ElasitcSearch 并发控制"></a>五、ElasitcSearch 并发控制</h1><p>Elasticsearch 是分布式的。当创建、更新或删除时， 新版本的文档必须复制到集群中的其他节点。Elasticsearch 也是异步和并发的，这意味着这些复制请求被并行发送，并且到达目的地时也许顺序是乱的。 Elasticsearch 需要一种方法确保文档的旧版本不会覆盖新的版本。</p>
<p>在<strong>多个客户端</strong>同时对ES中的<strong>同一篇</strong>文档的<strong>同一条记录</strong>进行操作时，我们就需要保证数据的安全性了。</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/%5Cimages%5CElasticSearch2%5C18.png"
                     
                ></p>
<blockquote>
<p><strong>上述图中，两个窗口在买票之前分别查询了票，发现票数余额为100，然后都卖了第100张票，出现多卖情况</strong></p>
</blockquote>
<h2 id="5-1-悲观锁控制"><a href="#5-1-悲观锁控制" class="headerlink" title="5.1 悲观锁控制"></a>5.1 悲观锁控制</h2><p>我们知道，在并发修改某一资源时，我们必须保证线程安全的问题。</p>
<ul>
<li>悲观锁概念：</li>
</ul>
<p>悲观锁简单的理解就是程序处于悲观状态，在操作任何资源时都认为其他程序会来修改当前资源，自己不放心，因此在操作资源时加锁。</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/%5Cimages%5CElasticSearch2%5C19.png"
                     
                ></p>
<blockquote>
<p>悲观锁虽然保证了程序的安全性，同时效率也<strong>降低</strong>了很多，在一个客户端操作时，其他客户端均不可操作，降低了系统的并发性能。</p>
</blockquote>
<h2 id="5-2-乐观锁控制"><a href="#5-2-乐观锁控制" class="headerlink" title="5.2 乐观锁控制"></a>5.2 乐观锁控制</h2><ul>
<li>乐观锁概念：</li>
</ul>
<p>乐观锁简单理解就是程序一直处于乐观状态，在操作任何资源时认为其他程序不会来修改当前资源，整个过程不加锁，<strong>不加锁效率是可以保证，但不是又回到了我们最初的那个状态吗？即线程安全问题</strong>。</p>
<h3 id="5-2-1-乐观锁的实现"><a href="#5-2-1-乐观锁的实现" class="headerlink" title="5.2.1 乐观锁的实现"></a>5.2.1 乐观锁的实现</h3><p>我们在ES中创建每一篇文档，ES都会自动帮我们分配一个<code>_version</code>字段，每当我们对文档进行更新时，此版本号都会自增。我们可以借助该字段帮我们完成乐观锁。保证线程安全问题。</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/%5Cimages%5CElasticSearch2%5C20.png"
                     
                ></p>
<ul>
<li>1）新增一篇文档：</li>
</ul>
<div class="highlight-container" data-rel="Json"><figure class="iseeu highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">PUT  /test/_doc/<span class="number">10</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot; ticket&quot;</span><span class="punctuation">:</span><span class="string">&quot;100&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></div>

<ul>
<li>2）查看返回结果：</li>
</ul>
<div class="highlight-container" data-rel="Json"><figure class="iseeu highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;_index&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;test&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;_doc&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;10&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_version&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;result&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;created&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_shards&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;total&quot;</span> <span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;successful&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;failed&quot;</span> <span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_seq_no&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_primary_term&quot;</span> <span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></div>

<blockquote>
<p>此时_version为1</p>
</blockquote>
<h2 id="5-3-partial-update-并发问题"><a href="#5-3-partial-update-并发问题" class="headerlink" title="5.3 partial update 并发问题"></a>5.3 partial update 并发问题</h2><p><strong>partial update在操作的时候会有并发安全隐患</strong>，我们先了解一下partial update的底层原理：</p>
<h3 id="5-3-1-partial-update-操作原理图"><a href="#5-3-1-partial-update-操作原理图" class="headerlink" title="5.3.1 partial update 操作原理图"></a>5.3.1 partial update 操作原理图</h3><p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/%5Cimages%5CElasticSearch2%5C22.png"
                     
                ></p>
<p>partial update将操作划分为了2个步骤（前提是doc发生了变化）：</p>
<p>1）根据id查询出文档的数据，包括version字段</p>
<p>2）将老的document标记为deleted，并根据version字段创建新的document</p>
<h3 id="5-3-2-partial-update-带来的并发问题"><a href="#5-3-2-partial-update-带来的并发问题" class="headerlink" title="5.3.2 partial update 带来的并发问题"></a>5.3.2 partial update 带来的并发问题</h3><p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/%5Cimages%5CElasticSearch2%5C23.png"
                     
                ></p>
<p>1）Client-1去ES中查询document和version（<strong>此时version为1</strong>）</p>
<p>2）Client-2也去ES中查询document和version（<strong>此时version为1</strong>）</p>
<p>3）Client-1将老的document标记为删除，并根据版本号（<strong>①步骤中获取到的</strong>）创建新的document，<strong>此时version为2</strong></p>
<p>4）Client-2也把document标记为删除，并且根据版本号（<strong>②步骤中获取到的</strong>）创建新的document，<strong>失败</strong></p>
<h3 id="5-3-3-retry策略"><a href="#5-3-3-retry策略" class="headerlink" title="5.3.3 retry策略"></a>5.3.3 retry策略</h3><p>partial update自带有乐观锁实现，并提供retry策略（重试）</p>
<div class="highlight-container" data-rel="Json"><figure class="iseeu highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">POST /index/type/id/_update?retry_on_conflict=<span class="number">10</span></span><br></pre></td></tr></table></figure></div>

<ul>
<li><code>retry_on_conflict</code>：重试的次数</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/%5Cimages%5CElasticSearch2%5C24.png"
                     
                ></p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">DELETE goodsindex</span><br><span class="line"></span><br><span class="line">PUT /goodsindex/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;name&quot;:&quot;huawei shouji&quot;,</span><br><span class="line">  &quot;title&quot;:&quot;huawei 4G quanmianping youxi shouji&quot;,</span><br><span class="line">  &quot;price&quot;:4899,</span><br><span class="line">  &quot;category&quot;:[&quot;youxi&quot;,&quot;4G&quot;,&quot;quanmianping&quot;]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST /goodsindex/_doc/1/_update?retry_on_conflict=3</span><br><span class="line">&#123;</span><br><span class="line">   &quot;doc&quot;: &#123;</span><br><span class="line">      &quot;price&quot;:&quot;2399&quot;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h1 id="十、搭建ES集群"><a href="#十、搭建ES集群" class="headerlink" title="十、搭建ES集群"></a>十、搭建ES集群</h1><h2 id="10-1-准备三台elasticsearch服务器"><a href="#10-1-准备三台elasticsearch服务器" class="headerlink" title="10.1 准备三台elasticsearch服务器"></a>10.1 准备三台elasticsearch服务器</h2><p>创建es-cluster文件夹，在内部复制三个elasticsearch服务</p>
<h2 id="10-2-修改ES配置"><a href="#10-2-修改ES配置" class="headerlink" title="10.2 修改ES配置"></a>10.2 修改ES配置</h2><p>修改es-cluster\node*\config\elasticsearch.yml配置文件</p>
<h3 id="10-2-1-node01节点："><a href="#10-2-1-node01节点：" class="headerlink" title="10.2.1 node01节点："></a>10.2.1 node01节点：</h3><div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">节点1的配置信息：</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">集群名称</span></span><br><span class="line">cluster.name: es-cluster</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">节点名称</span></span><br><span class="line">node.name: node-01</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">必须为本机的ip地址</span></span><br><span class="line">network.host: 127.0.0.1</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">服务端口号</span></span><br><span class="line">http.port: 9200</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">集群间通信端口号</span></span><br><span class="line">transport.tcp.port: 9300</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">设置集群自动发现机器ip集合 (7.0版本之后的新配置)</span></span><br><span class="line">discovery.seed_hosts: [&quot;127.0.0.1:9300&quot;,&quot;127.0.0.1:9301&quot;,&quot;127.0.0.1:9302&quot;]</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">(老配置)</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">discovery.zen.ping.unicast.hosts: [<span class="string">&quot;127.0.0.1:9300&quot;</span>,<span class="string">&quot;127.0.0.1:9301&quot;</span>,<span class="string">&quot;127.0.0.1:9302&quot;</span>]</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">指定master节点(7.0版本之后的新配置)</span></span><br><span class="line">cluster.initial_master_nodes: node-01</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">跨域配置</span></span><br><span class="line">http.cors.enabled: true</span><br><span class="line">http.cors.allow-origin: &quot;*&quot;</span><br></pre></td></tr></table></figure></div>

<h3 id="10-2-2-node02节点："><a href="#10-2-2-node02节点：" class="headerlink" title="10.2.2 node02节点："></a>10.2.2 node02节点：</h3><div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">节点2的配置信息：</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">集群名称</span></span><br><span class="line">cluster.name: es-cluster</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">节点名称</span></span><br><span class="line">node.name: node-02</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">必须为本机的ip地址</span></span><br><span class="line">network.host: 127.0.0.1</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">服务端口号</span></span><br><span class="line">http.port: 9201</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">集群间通信端口号</span></span><br><span class="line">transport.tcp.port: 9301</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">设置集群自动发现机器ip集合</span></span><br><span class="line">discovery.seed_hosts: [&quot;127.0.0.1:9300&quot;,&quot;127.0.0.1:9301&quot;,&quot;127.0.0.1:9302&quot;]</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">(老配置)</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">discovery.zen.ping.unicast.hosts: [<span class="string">&quot;127.0.0.1:9300&quot;</span>,<span class="string">&quot;127.0.0.1:9301&quot;</span>,<span class="string">&quot;127.0.0.1:9302&quot;</span>]</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">指定master节点(7.0版本之后的新配置)</span></span><br><span class="line">cluster.initial_master_nodes: node-01</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">跨域配置</span></span><br><span class="line">http.cors.enabled: true</span><br><span class="line">http.cors.allow-origin: &quot;*&quot;</span><br></pre></td></tr></table></figure></div>

<h3 id="10-2-3-node03节点："><a href="#10-2-3-node03节点：" class="headerlink" title="10.2.3 node03节点："></a>10.2.3 node03节点：</h3><div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">节点3的配置信息：</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">集群名称</span></span><br><span class="line">cluster.name: es-cluster</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">节点名称，必须不一样</span></span><br><span class="line">node.name: node-03</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">必须为本机的ip地址</span></span><br><span class="line">network.host: 127.0.0.1</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">服务端口号</span></span><br><span class="line">http.port: 9202</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">集群间通信端口号</span></span><br><span class="line">transport.tcp.port: 9302</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">设置集群自动发现机器ip集合</span></span><br><span class="line">discovery.seed_hosts: [&quot;127.0.0.1:9300&quot;,&quot;127.0.0.1:9301&quot;,&quot;127.0.0.1:9302&quot;]</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">(老配置)</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">discovery.zen.ping.unicast.hosts: [<span class="string">&quot;127.0.0.1:9300&quot;</span>,<span class="string">&quot;127.0.0.1:9301&quot;</span>,<span class="string">&quot;127.0.0.1:9302&quot;</span>]</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">指定master节点(7.0版本之后的新配置)</span></span><br><span class="line">cluster.initial_master_nodes: node-01</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">跨域配置</span></span><br><span class="line">http.cors.enabled: true</span><br><span class="line">http.cors.allow-origin: &quot;*&quot;</span><br></pre></td></tr></table></figure></div>

<h2 id="10-3-启动各个节点服务器"><a href="#10-3-启动各个节点服务器" class="headerlink" title="10.3 启动各个节点服务器"></a>10.3 启动各个节点服务器</h2><p>双击es-cluster\node*\bin\elasticsearch.bat</p>
<h2 id="10-4-使用head插件查看"><a href="#10-4-使用head插件查看" class="headerlink" title="10.4 使用head插件查看"></a>10.4 使用head插件查看</h2><p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/%5Cimages%5CElasticSearch2%5C28.png"
                     
                ></p>
<p>发现集群健康值变为绿色状态（所有的shard和replica都被分配了）</p>
<h2 id="10-5-操作ES集群"><a href="#10-5-操作ES集群" class="headerlink" title="10.5 操作ES集群"></a>10.5 操作ES集群</h2><h3 id="10-5-1-创建mapping映射"><a href="#10-5-1-创建mapping映射" class="headerlink" title="10.5.1 创建mapping映射"></a>10.5.1 创建mapping映射</h3><div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">PUT goodsindex</span><br><span class="line">&#123;</span><br><span class="line">  &quot;settings&quot;: &#123;</span><br><span class="line">    &quot;number_of_shards&quot;: 5,</span><br><span class="line">    &quot;number_of_replicas&quot;: 1</span><br><span class="line">  &#125;, </span><br><span class="line">	&quot;mappings&quot;: &#123;</span><br><span class="line">		&quot;properties&quot;: &#123;</span><br><span class="line">			&quot;id&quot;: &#123;</span><br><span class="line">				&quot;type&quot;: &quot;text&quot;,</span><br><span class="line">				&quot;store&quot;: true,</span><br><span class="line">				&quot;index&quot;: false</span><br><span class="line">			&#125;,</span><br><span class="line">			&quot;name&quot;: &#123;</span><br><span class="line">				&quot;type&quot;: &quot;text&quot;,</span><br><span class="line">				&quot;store&quot;: true,</span><br><span class="line">				&quot;index&quot;: true,</span><br><span class="line">				&quot;analyzer&quot;: &quot;standard&quot;</span><br><span class="line">			&#125;,</span><br><span class="line">			&quot;title&quot;: &#123;</span><br><span class="line">				&quot;type&quot;: &quot;text&quot;,</span><br><span class="line">				&quot;store&quot;: true,</span><br><span class="line">				&quot;index&quot;: true,</span><br><span class="line">				&quot;analyzer&quot;: &quot;standard&quot;</span><br><span class="line">			&#125;,</span><br><span class="line">			&quot;price&quot;: &#123;</span><br><span class="line">				&quot;type&quot;: &quot;long&quot;,</span><br><span class="line">				&quot;store&quot;: true,</span><br><span class="line">				&quot;index&quot;: true</span><br><span class="line">			&#125;,</span><br><span class="line">			&quot;catetory&quot;: &#123;</span><br><span class="line">				&quot;fielddata&quot;: true,</span><br><span class="line">				&quot;type&quot;: &quot;text&quot;,</span><br><span class="line">				&quot;store&quot;: true,</span><br><span class="line">				&quot;index&quot;: true</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="10-5-2-查看分片信息"><a href="#10-5-2-查看分片信息" class="headerlink" title="10.5.2 查看分片信息"></a>10.5.2 查看分片信息</h3><p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/%5Cimages%5CElasticSearch2%5C29.png"
                     
                ></p>
<blockquote>
<p>ES为了容错设计，shard和replica不会分配在同一台机器</p>
</blockquote>
<h3 id="10-5-3-计算ES集群容错机器数"><a href="#10-5-3-计算ES集群容错机器数" class="headerlink" title="10.5.3 计算ES集群容错机器数"></a>10.5.3 计算ES集群容错机器数</h3><p>我们搭建完ES集群之后，我们之前添加的索引中包含5个primary shard和5个replica shard，我们可以通过head插件查看分片的信息，<strong>发现此时集群的最大容错数为1</strong>，宕机三个节点的任意一个节点对ES集群的数据不会造成影响，我们可以手动的设置索引的分片信息，来提高ES集群的容器机器数</p>
<p>将primary shard的数量设置为3个，replica的数量设置为2个，此时shard的数量为9个，每个节点都可以分配3个shard（1个primary，2个replica），此时ES集群的最大容错机器数为2</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/%5Cimages%5CElasticSearch2%5C12.png"
                     
                ></p>
<p>primary shard创建后就不可以更改了，因此我们需要把刚刚创建的索引删除：</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DELETE goodsindex</span><br></pre></td></tr></table></figure></div>

<p>创建goodsindex索引，并设置分片信息：</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">DELETE goodsindex</span><br><span class="line"></span><br><span class="line">PUT goodsindex</span><br><span class="line">&#123;</span><br><span class="line">  &quot;settings&quot;: &#123;</span><br><span class="line">    &quot;number_of_shards&quot;: 3,</span><br><span class="line">    &quot;number_of_replicas&quot;: 2</span><br><span class="line">  &#125;, </span><br><span class="line">	&quot;mappings&quot;: &#123;</span><br><span class="line">		&quot;properties&quot;: &#123;</span><br><span class="line">			&quot;id&quot;: &#123;</span><br><span class="line">				&quot;type&quot;: &quot;text&quot;,</span><br><span class="line">				&quot;store&quot;: true,</span><br><span class="line">				&quot;index&quot;: false</span><br><span class="line">			&#125;,</span><br><span class="line">			&quot;name&quot;: &#123;</span><br><span class="line">				&quot;type&quot;: &quot;text&quot;,</span><br><span class="line">				&quot;store&quot;: true,</span><br><span class="line">				&quot;index&quot;: true,</span><br><span class="line">				&quot;analyzer&quot;: &quot;standard&quot;</span><br><span class="line">			&#125;,</span><br><span class="line">			&quot;title&quot;: &#123;</span><br><span class="line">				&quot;type&quot;: &quot;text&quot;,</span><br><span class="line">				&quot;store&quot;: true,</span><br><span class="line">				&quot;index&quot;: true,</span><br><span class="line">				&quot;analyzer&quot;: &quot;standard&quot;</span><br><span class="line">			&#125;,</span><br><span class="line">			&quot;price&quot;: &#123;</span><br><span class="line">				&quot;type&quot;: &quot;long&quot;,</span><br><span class="line">				&quot;store&quot;: true,</span><br><span class="line">				&quot;index&quot;: true</span><br><span class="line">			&#125;,</span><br><span class="line">			&quot;catetory&quot;: &#123;</span><br><span class="line">				&quot;fielddata&quot;: true,</span><br><span class="line">				&quot;type&quot;: &quot;text&quot;,</span><br><span class="line">				&quot;store&quot;: true,</span><br><span class="line">				&quot;index&quot;: true</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<ul>
<li>使用head查看分片信息：</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/%5Cimages%5CElasticSearch2%5C30.png"
                     
                ></p>
<p>此时，在ES集群中，宕机任意两台服务器，对ES集群的数据都不会造成影响</p>
<h3 id="10-5-4-操作文档"><a href="#10-5-4-操作文档" class="headerlink" title="10.5.4 操作文档"></a>10.5.4 操作文档</h3><h4 id="10-5-4-1-数据准备"><a href="#10-5-4-1-数据准备" class="headerlink" title="10.5.4.1 数据准备"></a>10.5.4.1 数据准备</h4><ul>
<li>准备数据：</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">PUT /goodsindex/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;name&quot;:&quot;huawei shouji&quot;,</span><br><span class="line">  &quot;title&quot;:&quot;huawei 4G quanmianping youxi shouji&quot;,</span><br><span class="line">  &quot;price&quot;:4899,</span><br><span class="line">  &quot;category&quot;:[&quot;youxi&quot;,&quot;4G&quot;,&quot;quanmianping&quot;]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT /goodsindex/_doc/2</span><br><span class="line">&#123;</span><br><span class="line">  &quot;name&quot;:&quot;vivo shouji&quot;,</span><br><span class="line">  &quot;title&quot;:&quot;vivo 5G paizhao shouji&quot;,</span><br><span class="line">  &quot;price&quot;:2899,</span><br><span class="line">  &quot;category&quot;:[&quot;5G&quot;,&quot;paizhao&quot;]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT /goodsindex/_doc/3</span><br><span class="line">&#123;</span><br><span class="line">  &quot;name&quot;:&quot;oppo shouji&quot;,</span><br><span class="line">  &quot;title&quot;:&quot;oppo 5G paizhao shouji&quot;,</span><br><span class="line">  &quot;price&quot;:1899,</span><br><span class="line">  &quot;category&quot;:[&quot;5G&quot;,&quot;paizhao&quot;]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT /goodsindex/_doc/4</span><br><span class="line">&#123;</span><br><span class="line">  &quot;name&quot;:&quot;huawei shouji&quot;,</span><br><span class="line">  &quot;title&quot;:&quot;huawei 5G youxi shouji&quot;,</span><br><span class="line">  &quot;price&quot;:3899,</span><br><span class="line">  &quot;category&quot;:[&quot;5G&quot;,&quot;youxi&quot;]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT /goodsindex/_doc/5</span><br><span class="line">&#123;</span><br><span class="line">  &quot;name&quot;:&quot;xiaomi shouji&quot;,</span><br><span class="line">  &quot;title&quot;:&quot;xiaomi 4G youxi shouji&quot;,</span><br><span class="line">  &quot;price&quot;:988,</span><br><span class="line">  &quot;category&quot;:[&quot;youxi&quot;,&quot;4G&quot;]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT /goodsindex/_doc/6</span><br><span class="line">&#123;</span><br><span class="line">  &quot;name&quot;:&quot;xiaomi shouji&quot;,</span><br><span class="line">  &quot;title&quot;:&quot;xiaomi 5G youxi qumianping shouji&quot;,</span><br><span class="line">  &quot;price&quot;:1899,</span><br><span class="line">  &quot;category&quot;:[&quot;youxi&quot;,&quot;5G&quot;,&quot;qumianping&quot;]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT /goodsindex/_doc/7</span><br><span class="line">&#123;</span><br><span class="line">  &quot;name&quot;:&quot;xiaomi shouji&quot;,</span><br><span class="line">  &quot;title&quot;:&quot;xiaomi 5G youxi shouji&quot;,</span><br><span class="line">  &quot;price&quot;:1299,</span><br><span class="line">  &quot;category&quot;:[&quot;youxi&quot;,&quot;5G&quot;]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT /goodsindex/_doc/8</span><br><span class="line">&#123;</span><br><span class="line">  &quot;name&quot;:&quot;xiaomi shouji&quot;,</span><br><span class="line">  &quot;title&quot;:&quot;xiaomi 4G shouji&quot;,</span><br><span class="line">  &quot;price&quot;:869,</span><br><span class="line">  &quot;category&quot;:[&quot;4G&quot;]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT /goodsindex/_doc/9</span><br><span class="line">&#123;</span><br><span class="line">  &quot;name&quot;:&quot;huawei shouji&quot;,</span><br><span class="line">  &quot;title&quot;:&quot;huawei 5G zhineng qumianping shouji&quot;,</span><br><span class="line">  &quot;price&quot;:2899,</span><br><span class="line">  &quot;category&quot;:[&quot;zhineng&quot;,&quot;5G&quot;,&quot;qumianping&quot;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h4 id="10-5-4-1-ES集群的搜索"><a href="#10-5-4-1-ES集群的搜索" class="headerlink" title="10.5.4.1 ES集群的搜索"></a>10.5.4.1 ES集群的搜索</h4><ul>
<li>使用curl搜索：</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET localhost:9200/goodsindex/_doc/_search?pretty</span><br><span class="line">curl -XGET localhost:9201/goodsindex/_doc/_search?pretty</span><br><span class="line">curl -XGET localhost:9202/goodsindex/_doc/_search?pretty</span><br></pre></td></tr></table></figure></div>

<p>ES集群对外暴露的是一个整体，我们想要搜索只需要发送请求到ES集群中的任意一个节点，中间的内部协调、转发等全部由ES集群内部自动完成；</p>
<ul>
<li>修改：</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">POST goodsindex/_doc/1/_update</span><br><span class="line">&#123;</span><br><span class="line">   &quot;doc&quot;: &#123;</span><br><span class="line">    &quot;title&quot;:&quot;huawei 4G shouji&quot;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GET goodsindex/_doc/1</span><br></pre></td></tr></table></figure></div>

<ul>
<li>删除：</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DELETE goodsindex/_doc/1</span><br></pre></td></tr></table></figure></div>

<h3 id="10-5-5-ES的集群恢复"><a href="#10-5-5-ES的集群恢复" class="headerlink" title="10.5.5 ES的集群恢复"></a>10.5.5 ES的集群恢复</h3><p>我们刚刚说过在ElasticSearch中，如果某个Master节点宕机了，内部会选举出一个新的master，并且会在原master的primary shard对应的replica shard中选出一个作为新的primary shard；</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/%5Cimages%5CElasticSearch2%5C32.png"
                     
                ></p>
<p>我们手动把node-1节点宕机，发现node-3上replica shard提升为primary shard了，并且原来<code>.kibana_task_manager</code>的replica shard从宕机的节点切换到新的节点了；</p>
<p>当node-1节点恢复正常后，node-1上的依旧是replica shard，并不会进行切换</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/%5Cimages%5CElasticSearch2%5C33.png"
                     
                ></p>
<h3 id="10-5-6-路由算法"><a href="#10-5-6-路由算法" class="headerlink" title="10.5.6 路由算法"></a>10.5.6 路由算法</h3><p>我们知道，ES在创建index的时候，会进行分片，index中不同的doc会分到不同的shard中（一个doc只能在一个primary shard），当ES对一个doc进行操作时（增删改），会根据路由算法来决定到底是存放在哪个shard中。</p>
<p>路由算法：<code>shard = hash(routing) % number_of_primary_shards</code></p>
<ul>
<li><code>number_of_primary_shards</code>：当前primary shard的数量</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/%5Cimages%5CElasticSearch2%5C25.png"
                     
                ></p>
<h3 id="10-5-7-为什么primary-shard不可变？"><a href="#10-5-7-为什么primary-shard不可变？" class="headerlink" title="10.5.7 为什么primary shard不可变？"></a>10.5.7 为什么primary shard不可变？</h3><p>看ES路由转发原理我们就知道，路由算法是固定的，一旦新增一篇文档就已经确定了在哪个primary shard上了（replica shard会自动备份），如果一旦新增了primary shard，那么会导致数据错乱。</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/%5Cimages%5CElasticSearch2%5C26.png"
                     
                ></p>
<p><strong>如果在3个primary shard添加了一篇doc，此时存储在P3 shard，假设可以增加了1个primary shard，那么下次查询查询的则是P0 shard</strong></p>
<h3 id="10-5-8-协调节点"><a href="#10-5-8-协调节点" class="headerlink" title="10.5.8 协调节点"></a>10.5.8 协调节点</h3><p>我们在实际生产环境中，ES节点可能有数十个甚至更多，我们可以发送请求到集群中的任一节点。 <strong>每个节点都有能力处理任意请求</strong>；ES中每个节点都保存了一份”注册表”，存储其他集群中其他节点的一些信息，请求最先达到集群会有一个节点来处理请求，再根据路由算法路由到指定的Node和shard上，此时这个节点就叫做<strong>协调节点</strong>（coordinating node）。</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/%5Cimages%5CElasticSearch2%5C27.png"
                     
                ></p>
<h1 id="十一、ES高级搜索功能"><a href="#十一、ES高级搜索功能" class="headerlink" title="十一、ES高级搜索功能"></a>十一、ES高级搜索功能</h1><h2 id="11-1-deep-paging"><a href="#11-1-deep-paging" class="headerlink" title="11.1 deep paging"></a>11.1 deep paging</h2><h3 id="11-1-1-回顾ES分页搜索"><a href="#11-1-1-回顾ES分页搜索" class="headerlink" title="11.1.1 回顾ES分页搜索"></a>11.1.1 回顾ES分页搜索</h3><div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">DELETE goodsindex</span><br><span class="line"></span><br><span class="line">PUT /goodsindex/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;name&quot;:&quot;huawei shouji&quot;,</span><br><span class="line">  &quot;title&quot;:&quot;huawei 4G quanmianping youxi shouji&quot;,</span><br><span class="line">  &quot;price&quot;:4899,</span><br><span class="line">  &quot;category&quot;:[&quot;youxi&quot;,&quot;4G&quot;,&quot;quanmianping&quot;]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT /goodsindex/_doc/2</span><br><span class="line">&#123;</span><br><span class="line">  &quot;name&quot;:&quot;vivo shouji&quot;,</span><br><span class="line">  &quot;title&quot;:&quot;vivo 5G paizhao shouji&quot;,</span><br><span class="line">  &quot;price&quot;:2899,</span><br><span class="line">  &quot;category&quot;:[&quot;5G&quot;,&quot;paizhao&quot;]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT /goodsindex/_doc/3</span><br><span class="line">&#123;</span><br><span class="line">  &quot;name&quot;:&quot;oppo shouji&quot;,</span><br><span class="line">  &quot;title&quot;:&quot;oppo 5G paizhao shouji&quot;,</span><br><span class="line">  &quot;price&quot;:1899,</span><br><span class="line">  &quot;category&quot;:[&quot;5G&quot;,&quot;paizhao&quot;]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT /goodsindex/_doc/4</span><br><span class="line">&#123;</span><br><span class="line">  &quot;name&quot;:&quot;huawei shouji&quot;,</span><br><span class="line">  &quot;title&quot;:&quot;huawei 5G youxi shouji&quot;,</span><br><span class="line">  &quot;price&quot;:3899,</span><br><span class="line">  &quot;category&quot;:[&quot;5G&quot;,&quot;youxi&quot;]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GET /goodsindex/_doc/_search</span><br><span class="line">&#123;</span><br><span class="line">	&quot;query&quot;: &#123;</span><br><span class="line">		&quot;match&quot;: &#123;</span><br><span class="line">			&quot;title&quot;: &quot;huawei&quot;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;,</span><br><span class="line">	&quot;from&quot;: 0,</span><br><span class="line">	&quot;size&quot;: 2</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>从第0条查询到第2条数据</p>
<h3 id="11-1-2-deep-paging-问题"><a href="#11-1-2-deep-paging-问题" class="headerlink" title="11.1.2 deep paging 问题"></a>11.1.2 deep paging 问题</h3><p>deep paging简单来说就是搜索层次过深。</p>
<p>假设共有3个shard，总共有60000条数据，每个shard上存储了20000条数据，每页是10条数据（页大小），这个时候，要搜索第1000页的数据，一般情况下，搜索到的就是10001-10010，但是分片从每个shard上获取数据的话，我们真正获取到的数据是第几条到第几条？</p>
<ul>
<li>如图所示：</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/ElasticSearch3/100.png"
                     
                ></p>
<p>通过画图的分析，我们知道，在做很深层次的查询时（deep paging），各个节点需要返回大量的数据到协调节点（coordinating node），并且在进行一次排序，协调节点此时的数据处理压力非常大<strong>，这个过程消耗网络资源，内存,CPU等，所以应该尽量避免deep paging</strong></p>
<h2 id="11-1-scroll滚动搜索"><a href="#11-1-scroll滚动搜索" class="headerlink" title="11.1 scroll滚动搜索"></a>11.1 scroll滚动搜索</h2><p>场景：下载某一个索引中1亿条数据，到文件或是数据库。</p>
<p>不能一下全查出来，系统内存溢出。所以使用scoll滚动搜索技术，一批一批查询。</p>
<p>scoll搜索会在第一次搜索的时候，保存一个当时的视图快照，之后只会基于旧的视图快照提供数据搜索，如果这个期间数据变更，是不会让用户看到的</p>
<p>每次发送scroll请求，我们还需要指定一个scroll参数，指定一个时间窗口，每次搜索请求只要在这个时间窗口内能完成就可以了。</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">GET /goodsindex/_doc/_search?scroll=1m</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match_all&quot;: &#123;&#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;size&quot;: 1</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>结果：</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">! Deprecation: [types removal] Specifying types <span class="keyword">in</span> search requests is deprecated.</span></span><br><span class="line">&#123;</span><br><span class="line">  &quot;_scroll_id&quot; : &quot;DnF1ZXJ5VGhlbkZldGNoBQAAAAAAAAPhFjB3RXdNbHdlUjlDaFZQdHJrSnRfeVEAAAAAAAAD4hYwd0V3TWx3ZVI5Q2hWUHRya0p0X3lRAAAAAAAAA-MWMHdFd01sd2VSOUNoVlB0cmtKdF95UQAAAAAAAAPkFjB3RXdNbHdlUjlDaFZQdHJrSnRfeVEAAAAAAAAD5RYwd0V3TWx3ZVI5Q2hWUHRya0p0X3lR&quot;,</span><br><span class="line">  &quot;took&quot; : 2,</span><br><span class="line">  &quot;timed_out&quot; : false,</span><br><span class="line">  &quot;_shards&quot; : &#123;</span><br><span class="line">    &quot;total&quot; : 5,</span><br><span class="line">    &quot;successful&quot; : 5,</span><br><span class="line">    &quot;skipped&quot; : 0,</span><br><span class="line">    &quot;failed&quot; : 0</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;hits&quot; : &#123;</span><br><span class="line">    &quot;total&quot; : &#123;</span><br><span class="line">      &quot;value&quot; : 4,</span><br><span class="line">      &quot;relation&quot; : &quot;eq&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;max_score&quot; : 1.0,</span><br><span class="line">    &quot;hits&quot; : [</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;_index&quot; : &quot;goodsindex&quot;,</span><br><span class="line">        &quot;_type&quot; : &quot;_doc&quot;,</span><br><span class="line">        &quot;_id&quot; : &quot;3&quot;,</span><br><span class="line">        &quot;_score&quot; : 1.0,</span><br><span class="line">        &quot;_source&quot; : &#123;</span><br><span class="line">          &quot;name&quot; : &quot;oppo shouji&quot;,</span><br><span class="line">          &quot;title&quot; : &quot;oppo 5G paizhao shouji&quot;,</span><br><span class="line">          &quot;price&quot; : 1899,</span><br><span class="line">          &quot;category&quot; : [</span><br><span class="line">            &quot;5G&quot;,</span><br><span class="line">            &quot;paizhao&quot;</span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>获得的结果会有一个<code>_scroll_id</code>，下一次再发送scroll请求的时候，必须带上这个scroll_id</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">GET /_search/scroll</span><br><span class="line">&#123;</span><br><span class="line">    &quot;scroll&quot;: &quot;1m&quot;, </span><br><span class="line">    &quot;scroll_id&quot; : &quot;DnF1ZXJ5VGhlbkZldGNoBQAAAAAAAAPhFjB3RXdNbHdlUjlDaFZQdHJrSnRfeVEAAAAAAAAD4hYwd0V3TWx3ZVI5Q2hWUHRya0p0X3lRAAAAAAAAA-MWMHdFd01sd2VSOUNoVlB0cmtKdF95UQAAAAAAAAPkFjB3RXdNbHdlUjlDaFZQdHJrSnRfeVEAAAAAAAAD5RYwd0V3TWx3ZVI5Q2hWUHRya0p0X3lR&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>结果：</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;_scroll_id&quot; : &quot;DnF1ZXJ5VGhlbkZldGNoBQAAAAAAAAPhFjB3RXdNbHdlUjlDaFZQdHJrSnRfeVEAAAAAAAAD4hYwd0V3TWx3ZVI5Q2hWUHRya0p0X3lRAAAAAAAAA-MWMHdFd01sd2VSOUNoVlB0cmtKdF95UQAAAAAAAAPkFjB3RXdNbHdlUjlDaFZQdHJrSnRfeVEAAAAAAAAD5RYwd0V3TWx3ZVI5Q2hWUHRya0p0X3lR&quot;,</span><br><span class="line">  &quot;took&quot; : 7,</span><br><span class="line">  &quot;timed_out&quot; : false,</span><br><span class="line">  &quot;terminated_early&quot; : false,</span><br><span class="line">  &quot;_shards&quot; : &#123;</span><br><span class="line">    &quot;total&quot; : 5,</span><br><span class="line">    &quot;successful&quot; : 5,</span><br><span class="line">    &quot;skipped&quot; : 0,</span><br><span class="line">    &quot;failed&quot; : 0</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;hits&quot; : &#123;</span><br><span class="line">    &quot;total&quot; : &#123;</span><br><span class="line">      &quot;value&quot; : 4,</span><br><span class="line">      &quot;relation&quot; : &quot;eq&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;max_score&quot; : 1.0,</span><br><span class="line">    &quot;hits&quot; : [</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;_index&quot; : &quot;goodsindex&quot;,</span><br><span class="line">        &quot;_type&quot; : &quot;_doc&quot;,</span><br><span class="line">        &quot;_id&quot; : &quot;4&quot;,</span><br><span class="line">        &quot;_score&quot; : 1.0,</span><br><span class="line">        &quot;_source&quot; : &#123;</span><br><span class="line">          &quot;name&quot; : &quot;huawei shouji&quot;,</span><br><span class="line">          &quot;title&quot; : &quot;huawei 5G youxi shouji&quot;,</span><br><span class="line">          &quot;price&quot; : 3899,</span><br><span class="line">          &quot;category&quot; : [</span><br><span class="line">            &quot;5G&quot;,</span><br><span class="line">            &quot;youxi&quot;</span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>



<h2 id="11-2-标准化搜索"><a href="#11-2-标准化搜索" class="headerlink" title="11.2 标准化搜索"></a>11.2 标准化搜索</h2><p>一个优秀的搜索引擎往往功能非常强大，我们已经从传统的模糊查询转变为我们现在的分词查询，搜索已经相对智能化，但我们的搜索引擎还有许多不足之处；</p>
<p>一个完整的搜索包含如下功能：</p>
<p>（1）缩写 vs. 全称：cn -&gt; china</p>
<p>（2）格式转化：like liked likes</p>
<p>（3）大小写：Tom vs tom</p>
<p>（4）同义词：like vs love</p>
<p>搜索不是说单纯的只是匹配完整的一个值，而是可以对值进行拆分词语后（分词）进行匹配，也可以通过缩写、时态、大小写、同义词等进行匹配。深入 NPL（自然语义处理）。</p>
<h3 id="11-2-1-同义词搜索"><a href="#11-2-1-同义词搜索" class="headerlink" title="11.2.1 同义词搜索"></a>11.2.1 同义词搜索</h3><p>我们在生活中，有许多同义词，如：</p>
<p>番茄-&gt;西红柿-&gt;tomato；</p>
<p>马铃薯-&gt;土豆-&gt;potato；</p>
<p>apple-&gt;苹果</p>
<p>iphone-&gt;苹果手机</p>
<p>iphone-&gt;手机</p>
<p>lenovo-&gt;联想</p>
<p>….</p>
<p>在上述词语中，意思都相近，我们希望搜索番茄时，西红柿、番茄、tomato的商品都能出来</p>
<p>1）synonym 过滤器</p>
<p>synonym：一种token filters，用于做同义词转换</p>
<p>示例：</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">DELETE test</span><br><span class="line"></span><br><span class="line">PUT /test</span><br><span class="line">&#123;</span><br><span class="line">	&quot;settings&quot;: &#123;</span><br><span class="line">		&quot;analysis&quot;: &#123;</span><br><span class="line">			&quot;analyzer&quot;: &#123;</span><br><span class="line">				&quot;my_analyzer&quot;: &#123;									</span><br><span class="line">					&quot;type&quot;: &quot;custom&quot;,</span><br><span class="line">					&quot;tokenizer&quot;: &quot;my_ik&quot;,				</span><br><span class="line">					&quot;filter&quot;: [</span><br><span class="line">						&quot;my_synonym&quot;					</span><br><span class="line">					]</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;,</span><br><span class="line">			&quot;tokenizer&quot;: &#123;</span><br><span class="line">				&quot;my_ik&quot;: &#123;								</span><br><span class="line">					&quot;type&quot;: &quot;ik_smart&quot;			</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;,</span><br><span class="line">			&quot;filter&quot;: &#123;</span><br><span class="line">				&quot;my_synonym&quot;: &#123;						</span><br><span class="line">					&quot;type&quot;: &quot;synonym&quot;,</span><br><span class="line">					&quot;synonyms&quot;:[&quot;西红柿, 番茄&quot;,&quot;马铃薯, 土豆&quot;]			</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">GET /test/_analyze</span><br><span class="line">&#123;</span><br><span class="line">  &quot;analyzer&quot;: &quot;my_analyzer&quot;,</span><br><span class="line">  &quot;text&quot;: &quot;西红柿&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<ul>
<li>结果：</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;tokens&quot; : [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot; : &quot;西红柿&quot;,</span><br><span class="line">      &quot;start_offset&quot; : 0,</span><br><span class="line">      &quot;end_offset&quot; : 3,</span><br><span class="line">      &quot;type&quot; : &quot;CN_WORD&quot;,</span><br><span class="line">      &quot;position&quot; : 0</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot; : &quot;番茄&quot;,</span><br><span class="line">      &quot;start_offset&quot; : 0,</span><br><span class="line">      &quot;end_offset&quot; : 3,</span><br><span class="line">      &quot;type&quot; : &quot;SYNONYM&quot;,</span><br><span class="line">      &quot;position&quot; : 0</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>



<p>2）实现同义词搜索</p>
<p>在es&#x2F;config下面创建synonyms.txt文件，内容：</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">iphone,苹果</span><br><span class="line">西红柿,番茄</span><br><span class="line">马铃薯,土豆</span><br></pre></td></tr></table></figure></div>

<blockquote>
<p>在同一行的都是同义词</p>
</blockquote>
<ul>
<li>创建索引与映射：</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">DELETE goodsindex</span><br><span class="line"></span><br><span class="line">PUT goodsindex</span><br><span class="line">&#123;</span><br><span class="line">	&quot;settings&quot;: &#123;</span><br><span class="line">		&quot;index&quot;: &#123;</span><br><span class="line">			&quot;analysis&quot;: &#123;</span><br><span class="line">				&quot;analyzer&quot;: &#123;</span><br><span class="line">					&quot;synonym_analyzer&quot;: &#123;</span><br><span class="line">						&quot;type&quot;: &quot;custom&quot;,</span><br><span class="line">						&quot;tokenizer&quot;: &quot;ik_smart&quot;,</span><br><span class="line">						&quot;filter&quot;: [&quot;synonym_filter&quot;]</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;,</span><br><span class="line">				&quot;filter&quot;: &#123;</span><br><span class="line">					&quot;synonym_filter&quot;: &#123;</span><br><span class="line">						&quot;type&quot;: &quot;synonym&quot;,</span><br><span class="line">						&quot;synonyms_path&quot;: &quot;synonyms.txt&quot;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;,</span><br><span class="line">	&quot;mappings&quot;: &#123;</span><br><span class="line">		&quot;properties&quot;: &#123;</span><br><span class="line">			&quot;title&quot;: &#123;</span><br><span class="line">				&quot;analyzer&quot;: &quot;synonym_analyzer&quot;,</span><br><span class="line">				&quot;type&quot;: &quot;text&quot;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT /goodsindex/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">    &quot;title&quot;: &quot;美味的番茄,好吃的番茄&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT /goodsindex/_doc/2</span><br><span class="line">&#123;</span><br><span class="line">    &quot;title&quot;: &quot;有红又大的西红柿,好吃美味,清凉爽口&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT /goodsindex/_doc/3</span><br><span class="line">&#123;</span><br><span class="line">    &quot;title&quot;: &quot;特价西红柿,好吃的番茄&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">PUT /goodsindex/_doc/4</span><br><span class="line">&#123;</span><br><span class="line">    &quot;title&quot;: &quot;特价土豆,家常小菜&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">PUT /goodsindex/_doc/5</span><br><span class="line">&#123;</span><br><span class="line">    &quot;title&quot;: &quot;美味的马铃薯,好吃又营养&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT /goodsindex/_doc/6</span><br><span class="line">&#123;</span><br><span class="line">    &quot;title&quot;: &quot;5G国行iphone,全新无拆封&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT /goodsindex/_doc/7</span><br><span class="line">&#123;</span><br><span class="line">    &quot;title&quot;: &quot;双卡双待移动5G智能苹果手机&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>



<p>高亮搜索：</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">GET goodsindex/_doc/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;:&#123;</span><br><span class="line">    &quot;match&quot;: &#123;</span><br><span class="line">      &quot;title&quot;: &quot;番茄&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;highlight&quot;: &#123;</span><br><span class="line">    &quot;fields&quot;: &#123;</span><br><span class="line">      &quot;title&quot;: &#123;&#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;pre_tags&quot;: &quot;&lt;font&gt;&quot;,</span><br><span class="line">    &quot;post_tags&quot;: &quot;&lt;/font&gt;&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>结果：</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/ElasticSearch3/99.png"
                     
                ></p>
<h3 id="11-3-2-格式转化搜索"><a href="#11-3-2-格式转化搜索" class="headerlink" title="11.3.2 格式转化搜索"></a>11.3.2 格式转化搜索</h3><p>我们都知道，英语的单词有非常多的时态，单数&#x2F;复数、现在进行时、过去分词、过去式..等，但不管是什么时候，表述出来的意思都差不多，例如：</p>
<p>foxes-&gt;fox-&gt;狐狸</p>
<p>junping-&gt;jump-&gt;跳跃</p>
<p>likes-&gt;liked-&gt;like-&gt;liking-&gt;喜欢</p>
<p>run-&gt;running-&gt;跑</p>
<p>例如我们搜索foxes，那么应该包含foxes、fox词语的文档都可以被搜索到</p>
<p>1）porter_stem 过滤器</p>
<p>porter_stem过滤器是token filters的一种，是ES内置的过滤器，用于实现单词的时态转换，将不同时态的单词都转变为原型分词</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">GET /_analyze</span><br><span class="line">&#123;</span><br><span class="line">  &quot;tokenizer&quot;: &quot;standard&quot;,</span><br><span class="line">  &quot;filter&quot;: [ &quot;porter_stem&quot; ],</span><br><span class="line">  &quot;text&quot;: &quot;foxes jumping likes liking liked running&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/ElasticSearch3/98.png"
                     
                ></p>
<p>查看结果我们可以看到，porter_stem过滤器将不同时态的单词全部转变为原型进行分词</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">foxes jumping likes liking liked running</span><br><span class="line">fox,jump,like,like,like,run</span><br></pre></td></tr></table></figure></div>

<p>需要注意的是，porter_stem过滤器的转换规则为：单词结尾为s、es、ing、ed统统去掉，对于不规则的单词porter_stem过滤器都是不会进行单词的时态转换的</p>
<p>例如：</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">GET /_analyze</span><br><span class="line">&#123;</span><br><span class="line">  &quot;tokenizer&quot;: &quot;standard&quot;,</span><br><span class="line">  &quot;filter&quot;: [ &quot;porter_stem&quot; ],</span><br><span class="line">  &quot;text&quot;: &quot;babies cities men women feet teeth&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>结果：</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/ElasticSearch3/97.png"
                     
                ></p>
<p>我们通过观察结果就能够发现，porter_stem过滤器对于不规则的单词是无法进行转换的，对于特殊的单词（babies等），也只是简单的去掉了es：</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">babies cities men women feet teeth</span><br><span class="line">babi citi men women feet teeth</span><br></pre></td></tr></table></figure></div>

<p>2）实现格式化搜索</p>
<ul>
<li>创建索引：</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">DELETE goodsindex</span><br><span class="line"></span><br><span class="line">PUT goodsindex</span><br><span class="line">&#123;</span><br><span class="line">  &quot;settings&quot;: &#123;</span><br><span class="line">    &quot;index&quot;:&#123;</span><br><span class="line">      &quot;analysis&quot;:&#123;</span><br><span class="line">        &quot;analyzer&quot;:&#123;</span><br><span class="line">          &quot;format_analyzer&quot;:&#123;</span><br><span class="line">            &quot;type&quot;:&quot;custom&quot;,</span><br><span class="line">            &quot;tokenizer&quot;:&quot;ik_smart&quot;,</span><br><span class="line">            &quot;filter&quot;:[&quot;porter_stem&quot;]</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;mappings&quot;: &#123;</span><br><span class="line">    &quot;properties&quot;: &#123;</span><br><span class="line">      &quot;title&quot;:&#123;</span><br><span class="line">        &quot;analyzer&quot;: &quot;format_analyzer&quot;,</span><br><span class="line">        &quot;type&quot;: &quot;text&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT /goodsindex/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">    &quot;title&quot;: &quot;The fox is running&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT /goodsindex/_doc/2</span><br><span class="line">&#123;</span><br><span class="line">    &quot;title&quot;: &quot;There are a bunch of foxes&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>



<ul>
<li>高亮搜索：</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">GET goodsindex/_doc/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;:&#123;</span><br><span class="line">    &quot;match&quot;: &#123;</span><br><span class="line">      &quot;title&quot;: &quot;fox&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;highlight&quot;: &#123;</span><br><span class="line">    &quot;fields&quot;: &#123;</span><br><span class="line">      &quot;title&quot;: &#123;&#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;pre_tags&quot;: &quot;&lt;font&gt;&quot;,</span><br><span class="line">    &quot;post_tags&quot;: &quot;&lt;/font&gt;&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/ElasticSearch3/96.png"
                     
                ></p>
<h2 id="11-3-ES拼音搜索"><a href="#11-3-ES拼音搜索" class="headerlink" title="11.3 ES拼音搜索"></a>11.3 ES拼音搜索</h2><p>在实际应用中，用户有时候会采用拼音进行搜索，并且能把对应的中文词进行高亮显示，如：</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/ElasticSearch3/92.png"
                     
                ></p>
<p>在用户搜索”xiaolongxia”时，”小龙虾”、”龙虾”等词语都进行了高亮显示，我们可以采用ES的pinyin插件来完成功能</p>
<p>Github官网：<a class="link"   target="_blank" rel="noopener" href="https://github.com/medcl/elasticsearch-analysis-pinyin/" >https://github.com/medcl/elasticsearch-analysis-pinyin/ <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<blockquote>
<p><strong>将下载好的pinyin插件解压后copy到<code>es/plugins</code>目录，重启ES；</strong></p>
</blockquote>
<p>pinyin插件包含有：</p>
<ul>
<li>分析器（analyzer）：pinyin</li>
<li>分词器（tokenizer）：pinyin</li>
<li>token过滤器（token filter）：pinyin</li>
</ul>
<blockquote>
<p> 三者的名字都叫<code>pinyin</code>，pinyin插件中没有提供字符过滤器；</p>
</blockquote>
<h3 id="11-3-1-pinyin分析器的使用"><a href="#11-3-1-pinyin分析器的使用" class="headerlink" title="11.3.1 pinyin分析器的使用"></a>11.3.1 pinyin分析器的使用</h3><ul>
<li>测试pinyin插件：</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">GET _analyze</span><br><span class="line">&#123;</span><br><span class="line">  &quot;analyzer&quot;: &quot;pinyin&quot;,</span><br><span class="line">  &quot;text&quot;: &quot;刘德华&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GET _analyze</span><br><span class="line">&#123;</span><br><span class="line">  &quot;tokenizer&quot;: &quot;pinyin&quot;,</span><br><span class="line">  &quot;text&quot;: &quot;刘德华&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GET _analyze</span><br><span class="line">&#123;</span><br><span class="line">  &quot;tokenizer&quot;: &quot;whitespace&quot;, </span><br><span class="line">  &quot;filter&quot;: [&quot;pinyin&quot;], </span><br><span class="line">  &quot;text&quot;: &quot;刘德华&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>结果：</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/ElasticSearch3/91.png"
                     
                ></p>
<p>pinyin token过滤器搭配standard分词器：</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">GET _analyze</span><br><span class="line">&#123;</span><br><span class="line">  &quot;tokenizer&quot;: &quot;standard&quot;, </span><br><span class="line">  &quot;filter&quot;: [&quot;pinyin&quot;], </span><br><span class="line">  &quot;text&quot;: &quot;刘德华&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;tokens&quot; : [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot; : &quot;liu&quot;,</span><br><span class="line">      &quot;start_offset&quot; : 0,</span><br><span class="line">      &quot;end_offset&quot; : 1,</span><br><span class="line">      &quot;type&quot; : &quot;&lt;IDEOGRAPHIC&gt;&quot;,</span><br><span class="line">      &quot;position&quot; : 0</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot; : &quot;l&quot;,</span><br><span class="line">      &quot;start_offset&quot; : 0,</span><br><span class="line">      &quot;end_offset&quot; : 1,</span><br><span class="line">      &quot;type&quot; : &quot;&lt;IDEOGRAPHIC&gt;&quot;,</span><br><span class="line">      &quot;position&quot; : 0</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot; : &quot;de&quot;,</span><br><span class="line">      &quot;start_offset&quot; : 1,</span><br><span class="line">      &quot;end_offset&quot; : 2,</span><br><span class="line">      &quot;type&quot; : &quot;&lt;IDEOGRAPHIC&gt;&quot;,</span><br><span class="line">      &quot;position&quot; : 1</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot; : &quot;d&quot;,</span><br><span class="line">      &quot;start_offset&quot; : 1,</span><br><span class="line">      &quot;end_offset&quot; : 2,</span><br><span class="line">      &quot;type&quot; : &quot;&lt;IDEOGRAPHIC&gt;&quot;,</span><br><span class="line">      &quot;position&quot; : 1</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot; : &quot;hua&quot;,</span><br><span class="line">      &quot;start_offset&quot; : 2,</span><br><span class="line">      &quot;end_offset&quot; : 3,</span><br><span class="line">      &quot;type&quot; : &quot;&lt;IDEOGRAPHIC&gt;&quot;,</span><br><span class="line">      &quot;position&quot; : 2</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot; : &quot;h&quot;,</span><br><span class="line">      &quot;start_offset&quot; : 2,</span><br><span class="line">      &quot;end_offset&quot; : 3,</span><br><span class="line">      &quot;type&quot; : &quot;&lt;IDEOGRAPHIC&gt;&quot;,</span><br><span class="line">      &quot;position&quot; : 2</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>搭配ik_max_word使用：</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line">GET _analyze</span><br><span class="line">&#123;</span><br><span class="line">  &quot;tokenizer&quot;: &quot;ik_max_word&quot;, </span><br><span class="line">  &quot;filter&quot;: [&quot;pinyin&quot;], </span><br><span class="line">  &quot;text&quot;: &quot;中华人民&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;tokens&quot; : [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot; : &quot;zhong&quot;,</span><br><span class="line">      &quot;start_offset&quot; : 0,</span><br><span class="line">      &quot;end_offset&quot; : 4,</span><br><span class="line">      &quot;type&quot; : &quot;CN_WORD&quot;,</span><br><span class="line">      &quot;position&quot; : 0</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot; : &quot;zhrm&quot;,</span><br><span class="line">      &quot;start_offset&quot; : 0,</span><br><span class="line">      &quot;end_offset&quot; : 4,</span><br><span class="line">      &quot;type&quot; : &quot;CN_WORD&quot;,</span><br><span class="line">      &quot;position&quot; : 0</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot; : &quot;hua&quot;,</span><br><span class="line">      &quot;start_offset&quot; : 0,</span><br><span class="line">      &quot;end_offset&quot; : 4,</span><br><span class="line">      &quot;type&quot; : &quot;CN_WORD&quot;,</span><br><span class="line">      &quot;position&quot; : 1</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot; : &quot;ren&quot;,</span><br><span class="line">      &quot;start_offset&quot; : 0,</span><br><span class="line">      &quot;end_offset&quot; : 4,</span><br><span class="line">      &quot;type&quot; : &quot;CN_WORD&quot;,</span><br><span class="line">      &quot;position&quot; : 2</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot; : &quot;min&quot;,</span><br><span class="line">      &quot;start_offset&quot; : 0,</span><br><span class="line">      &quot;end_offset&quot; : 4,</span><br><span class="line">      &quot;type&quot; : &quot;CN_WORD&quot;,</span><br><span class="line">      &quot;position&quot; : 3</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot; : &quot;zhong&quot;,</span><br><span class="line">      &quot;start_offset&quot; : 0,</span><br><span class="line">      &quot;end_offset&quot; : 2,</span><br><span class="line">      &quot;type&quot; : &quot;CN_WORD&quot;,</span><br><span class="line">      &quot;position&quot; : 4</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot; : &quot;hua&quot;,</span><br><span class="line">      &quot;start_offset&quot; : 0,</span><br><span class="line">      &quot;end_offset&quot; : 2,</span><br><span class="line">      &quot;type&quot; : &quot;CN_WORD&quot;,</span><br><span class="line">      &quot;position&quot; : 5</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot; : &quot;zh&quot;,</span><br><span class="line">      &quot;start_offset&quot; : 0,</span><br><span class="line">      &quot;end_offset&quot; : 2,</span><br><span class="line">      &quot;type&quot; : &quot;CN_WORD&quot;,</span><br><span class="line">      &quot;position&quot; : 5</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot; : &quot;hua&quot;,</span><br><span class="line">      &quot;start_offset&quot; : 1,</span><br><span class="line">      &quot;end_offset&quot; : 3,</span><br><span class="line">      &quot;type&quot; : &quot;CN_WORD&quot;,</span><br><span class="line">      &quot;position&quot; : 6</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot; : &quot;ren&quot;,</span><br><span class="line">      &quot;start_offset&quot; : 1,</span><br><span class="line">      &quot;end_offset&quot; : 3,</span><br><span class="line">      &quot;type&quot; : &quot;CN_WORD&quot;,</span><br><span class="line">      &quot;position&quot; : 7</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot; : &quot;hr&quot;,</span><br><span class="line">      &quot;start_offset&quot; : 1,</span><br><span class="line">      &quot;end_offset&quot; : 3,</span><br><span class="line">      &quot;type&quot; : &quot;CN_WORD&quot;,</span><br><span class="line">      &quot;position&quot; : 7</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot; : &quot;ren&quot;,</span><br><span class="line">      &quot;start_offset&quot; : 2,</span><br><span class="line">      &quot;end_offset&quot; : 4,</span><br><span class="line">      &quot;type&quot; : &quot;CN_WORD&quot;,</span><br><span class="line">      &quot;position&quot; : 8</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot; : &quot;min&quot;,</span><br><span class="line">      &quot;start_offset&quot; : 2,</span><br><span class="line">      &quot;end_offset&quot; : 4,</span><br><span class="line">      &quot;type&quot; : &quot;CN_WORD&quot;,</span><br><span class="line">      &quot;position&quot; : 9</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot; : &quot;rm&quot;,</span><br><span class="line">      &quot;start_offset&quot; : 2,</span><br><span class="line">      &quot;end_offset&quot; : 4,</span><br><span class="line">      &quot;type&quot; : &quot;CN_WORD&quot;,</span><br><span class="line">      &quot;position&quot; : 9</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>



<h3 id="11-3-2-pinyin插件实现分词搜索"><a href="#11-3-2-pinyin插件实现分词搜索" class="headerlink" title="11.3.2 pinyin插件实现分词搜索"></a>11.3.2 pinyin插件实现分词搜索</h3><p>建立索引：</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">DELETE test</span><br><span class="line"></span><br><span class="line">PUT test</span><br><span class="line">&#123;</span><br><span class="line">  &quot;settings&quot;: &#123;</span><br><span class="line">    &quot;analysis&quot;: &#123;</span><br><span class="line">      &quot;analyzer&quot;: &#123;</span><br><span class="line">        &quot;pinyin_analyzer&quot;:&#123;</span><br><span class="line">          &quot;type&quot;:&quot;custom&quot;,</span><br><span class="line">          &quot;tokenizer&quot;:&quot;ik_max_word&quot;,</span><br><span class="line">          &quot;filter&quot;:[&quot;my_pinyin&quot;]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;filter&quot;: &#123;</span><br><span class="line">        &quot;my_pinyin&quot;:&#123;</span><br><span class="line">          &quot;type&quot;:&quot;pinyin&quot;,</span><br><span class="line">          &quot;keep_joined_full_pinyin&quot;:true</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;mappings&quot;: &#123;</span><br><span class="line">    &quot;properties&quot;: &#123;</span><br><span class="line">      &quot;name&quot;:&#123;</span><br><span class="line">        &quot;type&quot;: &quot;text&quot;,</span><br><span class="line">        &quot;analyzer&quot;: &quot;pinyin_analyzer&quot;,</span><br><span class="line">        &quot;search_analyzer&quot;: &quot;standard&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">分析下列分词情况</span></span><br><span class="line">GET _analyze</span><br><span class="line">&#123;</span><br><span class="line">  &quot;tokenizer&quot;: &quot;ik_max_word&quot;,</span><br><span class="line">  &quot;text&quot;: &quot;中华人民&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GET _analyze</span><br><span class="line">&#123;</span><br><span class="line">  &quot;tokenizer&quot;: &quot;ik_max_word&quot;,</span><br><span class="line">  &quot;filter&quot;: [&quot;pinyin&quot;], </span><br><span class="line">  &quot;text&quot;: &quot;中华人民&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GET test/_analyze</span><br><span class="line">&#123;</span><br><span class="line">  &quot;analyzer&quot;: &quot;pinyin_analyzer&quot;,</span><br><span class="line">  &quot;text&quot;: &quot;中华人民&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT test/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;name&quot;:&quot;中华人民&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT test/_doc/2</span><br><span class="line">&#123;</span><br><span class="line">  &quot;name&quot;:&quot;刘德华&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<ul>
<li><code>keep_joined_full_pinyin</code>：是否保留全拼音，刘德华-&gt;liudehua   默认值：false</li>
</ul>
<p>测试：</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">GET test/_doc/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match&quot;: &#123;</span><br><span class="line">      &quot;name&quot;: &quot;renmin&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;highlight&quot;:&#123;</span><br><span class="line">    &quot;fields&quot;:&#123;</span><br><span class="line">      &quot;name&quot;:&#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&quot;hits&quot;: [&#123;</span><br><span class="line">	&quot;_index&quot;: &quot;test&quot;,</span><br><span class="line">	&quot;_type&quot;: &quot;_doc&quot;,</span><br><span class="line">	&quot;_id&quot;: &quot;1&quot;,</span><br><span class="line">	&quot;_score&quot;: 0.49965835,</span><br><span class="line">	&quot;_source&quot;: &#123;</span><br><span class="line">		&quot;name&quot;: &quot;中华人民&quot;</span><br><span class="line">	&#125;,</span><br><span class="line">	&quot;highlight&quot;: &#123;</span><br><span class="line">		&quot;name&quot;: [</span><br><span class="line">			&quot;&lt;em&gt;中华人民&lt;/em&gt;&quot;</span><br><span class="line">		]</span><br><span class="line">	&#125;</span><br><span class="line">&#125;]</span><br><span class="line"></span><br><span class="line">GET test/_doc/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match&quot;: &#123;</span><br><span class="line">      &quot;name&quot;: &quot;ldh&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;highlight&quot;:&#123;</span><br><span class="line">    &quot;fields&quot;:&#123;</span><br><span class="line">      &quot;name&quot;:&#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&quot;hits&quot;: [&#123;</span><br><span class="line">	&quot;_index&quot;: &quot;test&quot;,</span><br><span class="line">	&quot;_type&quot;: &quot;_doc&quot;,</span><br><span class="line">	&quot;_id&quot;: &quot;2&quot;,</span><br><span class="line">	&quot;_score&quot;: 0.99357635,</span><br><span class="line">	&quot;_source&quot;: &#123;</span><br><span class="line">		&quot;name&quot;: &quot;刘德华&quot;</span><br><span class="line">	&#125;,</span><br><span class="line">	&quot;highlight&quot;: &#123;</span><br><span class="line">		&quot;name&quot;: [</span><br><span class="line">			&quot;&lt;em&gt;刘德华&lt;/em&gt;&quot;</span><br><span class="line">		]</span><br><span class="line">	&#125;</span><br><span class="line">&#125;]</span><br></pre></td></tr></table></figure></div>





<h2 id="11-4-TF-IDF-评分算法"><a href="#11-4-TF-IDF-评分算法" class="headerlink" title="11.4 TF&#x2F;IDF 评分算法"></a>11.4 TF&#x2F;IDF 评分算法</h2><h3 id="11-4-1-简介"><a href="#11-4-1-简介" class="headerlink" title="11.4.1 简介"></a>11.4.1 简介</h3><p>Elasticsearch使用的是 term frequency&#x2F;inverse document frequency算法，简称为TF&#x2F;IDF算法。TF词频(Term Frequency)，IDF逆向文档频率(Inverse Document Frequency)</p>
<h3 id="11-4-2-Term-Frequency"><a href="#11-4-2-Term-Frequency" class="headerlink" title="11.4.2 Term Frequency"></a>11.4.2 Term Frequency</h3><ul>
<li><strong>TF（Term Frequency，缩写为TF）</strong>：即一个词在文中出现的次数，统计出来就是词频TF，显而易见，一个词在文章中出现很多次，那么这个词肯定有着很大的作用。</li>
</ul>
<p>例如文档标题为：”华为5G智能游戏手机，全面屏智能拍照手机，华为新款手机”</p>
<p>在上述文档中，显然”手机”，”智能”，”华为”等词的出现频率较高，这几个词在文档中起着非常重要的作用</p>
<p>计算公式：</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/ElasticSearch3/95.png"
                     
                ></p>
<p>对于词频的计算公式，TF与C成正比，与S成反比。很显然，一个词在文章中出现很多次，那么这个词肯定有着很大的作用，但如果该词语是一些没有意义的词，如”的、得、啊、嗯”等词很很大程度上影响词频（TF）的计算，因此，绝大多数的分词器都具备有停用词的功能，对于该类词语我们可以针对性的进行停用</p>
<ul>
<li><strong>（Inverse Document Frequency，缩写为IDF）</strong>：即搜索的词语在整个索引文档中出现的次数，出现的次数越多，说明该词的意义不大，就越不相关</li>
</ul>
<p>例如文档标题为”赣南脐橙，当季水果新鲜美味，10斤大果包邮”</p>
<p>在上述文档中，出现有”赣南”、”脐橙”、”水果”等词语，并且出现的次数也一样多，但我们并不意味着这三个词语的权重是一样的，因为”赣南”属于较为常见的词语，”脐橙”、”水果”等词语的重要程度上要大于”赣南”，在词语的关键字排序上，”脐橙”和”水果”应该排在”赣南”前面；</p>
<p>计算公式：</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/ElasticSearch3/94.png"
                     
                ></p>
<p>通过计算公司我们可以得出，IDF与S成正比，与N成反比。如果一个词越常见，那么分母就越大，逆文档频率就越小越接近0。分母之所以要加1，是为了避免分母为0（即所有文档都不包含该词）。log表示对得到的值取对数。</p>
<h3 id="11-4-4-计算TF-IDF"><a href="#11-4-4-计算TF-IDF" class="headerlink" title="11.4.4 计算TF&#x2F;IDF"></a>11.4.4 计算TF&#x2F;IDF</h3><p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/ElasticSearch3/93.png"
                     
                ></p>
<p><strong>可以看到，TF&#x2F;IDF与一个词在文档中的出现次数成正比，与该词在整个语言中的出现次数成反比。</strong>所以，自动提取关键词的算法就很清楚了，就是计算出文档的每个词的TF-IDF值，然后按降序排列，取排在最前面的几个词。</p>
<h2 id="11-5-SQL支持"><a href="#11-5-SQL支持" class="headerlink" title="11.5 SQL支持"></a>11.5 SQL支持</h2><p>ElasticSearch在7.0版本后支持SQL语句的翻译执行，让用户可以直接编写SQL语句，ES底层将SQL转换为对应的ES查询语句</p>
<h3 id="11-5-1-快速入门"><a href="#11-5-1-快速入门" class="headerlink" title="11.5.1 快速入门"></a>11.5.1 快速入门</h3><p>准备数据：</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">POST /article/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;title&quot;:&quot;如何学习Spring&quot;,</span><br><span class="line">  &quot;content&quot;:&quot;这样学习Spring&quot;,</span><br><span class="line">  &quot;category&quot;:&quot;Spring&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST /article/_doc/2</span><br><span class="line">&#123;</span><br><span class="line">  &quot;title&quot;:&quot;如何学习ES&quot;,</span><br><span class="line">  &quot;content&quot;:&quot;这样学习ES&quot;,</span><br><span class="line">  &quot;category&quot;:&quot;ES&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST /article/_doc/3</span><br><span class="line">&#123;</span><br><span class="line">  &quot;title&quot;:&quot;如何学习MySQL&quot;,</span><br><span class="line">  &quot;content&quot;:&quot;这样学习MySQL&quot;,</span><br><span class="line">  &quot;category&quot;:&quot;MySQL&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>



<p>执行SQL：</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">POST /_sql?format=txt</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot;: &quot;SELECT * FROM article &quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/ElasticSearch3/83.png"
                     
                ></p>
<p>ES官方提供了多种数据结果集的响应格式：</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/ElasticSearch3/82.png"
                     
                ></p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">POST /_sql?format=csv</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot;: &quot;SELECT * FROM article&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>



<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/ElasticSearch3/81.png"
                     
                ></p>
<h3 id="11-5-2-SQL翻译"><a href="#11-5-2-SQL翻译" class="headerlink" title="11.5.2 SQL翻译"></a>11.5.2 SQL翻译</h3><p>ElasticSearch支持SQL语句的查询并不是底层支持SQL语句，而是在执行SQL语句的过程中，将SQL语句翻译成了对应的ES语言，我们可以手动查看ES是如何翻译的</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">POST /_sql/translate</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot;: &quot;SELECT * FROM article &quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/ElasticSearch3/80.png"
                     
                ></p>
<p>执行翻译后的ES语法：</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">GET article/_doc/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;size&quot; : 1000,</span><br><span class="line">  &quot;_source&quot; : &#123;</span><br><span class="line">    &quot;includes&quot; : [</span><br><span class="line">      &quot;category&quot;,</span><br><span class="line">      &quot;content&quot;,</span><br><span class="line">      &quot;title&quot;</span><br><span class="line">    ],</span><br><span class="line">    &quot;excludes&quot; : [ ]</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;sort&quot; : [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;_doc&quot; : &#123;</span><br><span class="line">        &quot;order&quot; : &quot;asc&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>对比结果，发现是一样的</p>
<p>切换SQL语句：</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">POST /_sql?format=txt</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot;: &quot;SELECT title FROM article where title=&#x27;如何学习Spring&#x27;&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>执行翻译：</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">POST /_sql/translate</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot;: &quot;SELECT title FROM article where title=&#x27;如何学习Spring&#x27;&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>结果：</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;size&quot; : 1000,</span><br><span class="line">  &quot;query&quot; : &#123;</span><br><span class="line">    &quot;term&quot; : &#123;</span><br><span class="line">      &quot;title.keyword&quot; : &#123;</span><br><span class="line">        &quot;value&quot; : &quot;如何学习Spring&quot;,</span><br><span class="line">        &quot;boost&quot; : 1.0</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;_source&quot; : &#123;</span><br><span class="line">    &quot;includes&quot; : [</span><br><span class="line">      &quot;title&quot;</span><br><span class="line">    ],</span><br><span class="line">    &quot;excludes&quot; : [ ]</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;sort&quot; : [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;_doc&quot; : &#123;</span><br><span class="line">        &quot;order&quot; : &quot;asc&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="11-5-3-ES提供的SQL工具"><a href="#11-5-3-ES提供的SQL工具" class="headerlink" title="11.5.3 ES提供的SQL工具"></a>11.5.3 ES提供的SQL工具</h3><p>在ES7版本后推出了<code>elasticsearch-sql.bat</code>批处理应用程序，双击打开，即可运行SQL语句；</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/ElasticSearch3/79.png"
                     
                ></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/ElasticSearch3/78.png"
                     
                ></p>
<h3 id="11-5-4-SQL与其他DSL结合"><a href="#11-5-4-SQL与其他DSL结合" class="headerlink" title="11.5.4 SQL与其他DSL结合"></a>11.5.4 SQL与其他DSL结合</h3><div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">POST /_sql?format=txt</span><br><span class="line">&#123;</span><br><span class="line">	&quot;query&quot;: &quot;SELECT * FROM article&quot;,</span><br><span class="line">	&quot;filter&quot;: &#123;</span><br><span class="line">		&quot;bool&quot;: &#123;</span><br><span class="line">			&quot;must&quot;: [&#123;</span><br><span class="line">				&quot;match&quot;: &#123;</span><br><span class="line">					&quot;category&quot;: &quot;MySQL&quot;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;]</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/ElasticSearch3/77.png"
                     
                ></p>
<h1 id="十二、ElasticSearch-Java-API"><a href="#十二、ElasticSearch-Java-API" class="headerlink" title="十二、ElasticSearch Java API"></a>十二、ElasticSearch Java API</h1><p>在ElasticSearch官网中，提供有Java连接ES并操作的详细案例；</p>
<blockquote>
<p>Java Rest ElasticSearch 7.6官网：<a class="link"   target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/client/java-rest/7.8/index.html" >https://www.elastic.co/guide/en/elasticsearch/client/java-rest/7.8/index.html <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
</blockquote>
<h2 id="12-1-搭建环境"><a href="#12-1-搭建环境" class="headerlink" title="12.1 搭建环境"></a>12.1 搭建环境</h2><h3 id="12-1-1-Maven依赖"><a href="#12-1-1-Maven依赖" class="headerlink" title="12.1.1 Maven依赖"></a>12.1.1 Maven依赖</h3><div class="highlight-container" data-rel="Xml"><figure class="iseeu highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.dfbz<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>ElasticSearch_01<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--es依赖--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.elasticsearch<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>elasticsearch<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>7.6.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!--es依赖--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.elasticsearch.client<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>transport<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>7.6.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!--es高级客户端--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.elasticsearch.client<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>elasticsearch-rest-high-level-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>7.6.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!--es所需日志包--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.logging.log4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>log4j-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.8.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.logging.log4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>log4j-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.8.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!--lombok插件--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.18.10<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!--测试单元--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.12<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!--json转换工具--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-databind<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.8.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure></div>

<h3 id="12-1-2-实体类"><a href="#12-1-2-实体类" class="headerlink" title="12.1.2 实体类"></a>12.1.2 实体类</h3><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.dfbz.entity;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.NoArgsConstructor;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Goods</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> String title;</span><br><span class="line">    <span class="keyword">private</span> Double price;</span><br><span class="line">    <span class="keyword">private</span> String[] category;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h2 id="12-2-索引管理"><a href="#12-2-索引管理" class="headerlink" title="12.2 索引管理"></a>12.2 索引管理</h2><blockquote>
<p>ElasticSearch索引相关API：<a class="link"   target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/client/java-rest/7.3/java-rest-high-document-index.html" >https://www.elastic.co/guide/en/elasticsearch/client/java-rest/7.3/java-rest-high-document-index.html <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
</blockquote>
<ul>
<li>获取连接：</li>
</ul>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.dfbz.demo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.client.transport.TransportClient;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.common.settings.Settings;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.common.transport.TransportAddress;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.transport.client.PreBuiltTransportClient;</span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.net.InetAddress;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> lscl</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@intro</span>:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Demo</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test1</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建Client连接对象(指定集群名称)</span></span><br><span class="line">        <span class="type">Settings</span>  <span class="variable">settings</span> <span class="operator">=</span> Settings.builder().put(<span class="string">&quot;cluster.name&quot;</span>, <span class="string">&quot;my-cluster&quot;</span>).build();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 客户端对象</span></span><br><span class="line">        <span class="type">TransportClient</span> <span class="variable">client</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PreBuiltTransportClient</span>(settings)</span><br><span class="line">                .addTransportAddress(</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">TransportAddress</span>(</span><br><span class="line">                            InetAddress.getByName(<span class="string">&quot;127.0.0.1&quot;</span>), </span><br><span class="line">                            <span class="number">9300</span></span><br><span class="line">                        )</span><br><span class="line">                );</span><br><span class="line"></span><br><span class="line">        System.out.println(client);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 释放资源</span></span><br><span class="line">        client.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<ul>
<li>索引相关操作：</li>
</ul>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.dfbz.demo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.action.admin.indices.mapping.put.PutMappingRequest;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.client.AdminClient;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.client.IndicesAdminClient;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.client.Requests;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.client.transport.TransportClient;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.common.settings.Settings;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.common.transport.TransportAddress;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.common.xcontent.XContentBuilder;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.common.xcontent.XContentFactory;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.transport.client.PreBuiltTransportClient;</span><br><span class="line"><span class="keyword">import</span> org.junit.After;</span><br><span class="line"><span class="keyword">import</span> org.junit.Before;</span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.net.InetAddress;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Demo01_Index</span> &#123;</span><br><span class="line">    <span class="comment">// 创建Client连接对象</span></span><br><span class="line">    <span class="keyword">private</span> Settings settings;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// es客户端对象</span></span><br><span class="line">    <span class="keyword">private</span> TransportClient client;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Before</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">before</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 创建Client连接对象</span></span><br><span class="line">        settings = Settings.builder().put(<span class="string">&quot;cluster.name&quot;</span>, <span class="string">&quot;my-cluster&quot;</span>).build();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 客户端对象</span></span><br><span class="line">        client = <span class="keyword">new</span> <span class="title class_">PreBuiltTransportClient</span>(settings)</span><br><span class="line">                .addTransportAddress(<span class="keyword">new</span> <span class="title class_">TransportAddress</span>(InetAddress.getByName(<span class="string">&quot;127.0.0.1&quot;</span>), <span class="number">9300</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@After</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">after</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        client.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test1</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 创建客户端管理对象</span></span><br><span class="line">        <span class="type">AdminClient</span> <span class="variable">adminClient</span> <span class="operator">=</span> client.admin();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取索引操作对象</span></span><br><span class="line">        <span class="type">IndicesAdminClient</span> <span class="variable">indices</span> <span class="operator">=</span> adminClient.indices();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建索引</span></span><br><span class="line">        indices.prepareCreate(<span class="string">&quot;goodsindex&quot;</span>)</span><br><span class="line">                .setSettings(</span><br><span class="line">                        Settings.builder()</span><br><span class="line">                                <span class="comment">// primary shard</span></span><br><span class="line">                                .put(<span class="string">&quot;index.number_of_shards&quot;</span>, <span class="number">3</span>)</span><br><span class="line">                                <span class="comment">// replica shard</span></span><br><span class="line">                                .put(<span class="string">&quot;index.number_of_replicas&quot;</span>, <span class="number">1</span>)</span><br><span class="line">                ).get();        <span class="comment">// 执行创建</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 快速创建索引</span></span><br><span class="line"><span class="comment">//        client.admin().indices().prepareCreate(&quot;goodsindex&quot;).get();</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建映射</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test2</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">             创建一个Content构建对象</span></span><br><span class="line"><span class="comment">             &#123;</span></span><br><span class="line"><span class="comment">                &quot;_doc&quot;:&#123;</span></span><br><span class="line"><span class="comment">                    &quot;properties&quot;: &#123;</span></span><br><span class="line"><span class="comment">                        &quot;id&quot;:&#123;</span></span><br><span class="line"><span class="comment">                            &quot;type&quot;:&quot;integer&quot;,</span></span><br><span class="line"><span class="comment">                            &quot;store&quot;:&quot;true&quot;</span></span><br><span class="line"><span class="comment">                        &#125;,</span></span><br><span class="line"><span class="comment">                        &quot;name&quot;:&#123;</span></span><br><span class="line"><span class="comment">                            &quot;type&quot;:&quot;text&quot;,</span></span><br><span class="line"><span class="comment">                            &quot;store&quot;:&quot;true&quot;</span></span><br><span class="line"><span class="comment">                        &#125;,</span></span><br><span class="line"><span class="comment">                        &quot;title&quot;:&#123;</span></span><br><span class="line"><span class="comment">                            &quot;type&quot;:&quot;text&quot;,</span></span><br><span class="line"><span class="comment">                            &quot;store&quot;:&quot;true&quot;</span></span><br><span class="line"><span class="comment">                        &#125;,</span></span><br><span class="line"><span class="comment">                        &quot;price&quot;:&#123;</span></span><br><span class="line"><span class="comment">                            &quot;type&quot;:&quot;double&quot;</span></span><br><span class="line"><span class="comment">                        &#125;,</span></span><br><span class="line"><span class="comment">                        &quot;category&quot;:&#123;</span></span><br><span class="line"><span class="comment">                            &quot;fielddata&quot;: true,</span></span><br><span class="line"><span class="comment">                            &quot;type&quot;:&quot;object&quot;</span></span><br><span class="line"><span class="comment">                        &#125;</span></span><br><span class="line"><span class="comment">                    &#125;</span></span><br><span class="line"><span class="comment">                &#125;</span></span><br><span class="line"><span class="comment">             &#125;</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="type">XContentBuilder</span> <span class="variable">builder</span> <span class="operator">=</span> XContentFactory.jsonBuilder()</span><br><span class="line">                .startObject()</span><br><span class="line">                .startObject(<span class="string">&quot;_doc&quot;</span>)</span><br><span class="line">                .startObject(<span class="string">&quot;properties&quot;</span>)</span><br><span class="line">                .startObject(<span class="string">&quot;id&quot;</span>)</span><br><span class="line">                .field(<span class="string">&quot;type&quot;</span>, <span class="string">&quot;integer&quot;</span>)</span><br><span class="line">                .field(<span class="string">&quot;store&quot;</span>, <span class="string">&quot;true&quot;</span>)</span><br><span class="line">                .endObject()</span><br><span class="line">                .startObject(<span class="string">&quot;name&quot;</span>)</span><br><span class="line">                .field(<span class="string">&quot;type&quot;</span>, <span class="string">&quot;text&quot;</span>).field(<span class="string">&quot;store&quot;</span>, <span class="string">&quot;true&quot;</span>).field(<span class="string">&quot;analyzer&quot;</span>, <span class="string">&quot;ik_smart&quot;</span>)</span><br><span class="line">                .endObject()</span><br><span class="line">                .startObject(<span class="string">&quot;title&quot;</span>)</span><br><span class="line">                .field(<span class="string">&quot;type&quot;</span>, <span class="string">&quot;text&quot;</span>).field(<span class="string">&quot;store&quot;</span>, <span class="string">&quot;true&quot;</span>).field(<span class="string">&quot;analyzer&quot;</span>, <span class="string">&quot;ik_smart&quot;</span>)</span><br><span class="line">                .endObject()</span><br><span class="line">                .startObject(<span class="string">&quot;price&quot;</span>)</span><br><span class="line">                .field(<span class="string">&quot;type&quot;</span>, <span class="string">&quot;double&quot;</span>)</span><br><span class="line">                .endObject()</span><br><span class="line">                .startObject(<span class="string">&quot;category&quot;</span>)</span><br><span class="line">                .field(<span class="string">&quot;type&quot;</span>, <span class="string">&quot;text&quot;</span>).field(<span class="string">&quot;fielddata&quot;</span>,<span class="literal">true</span>)</span><br><span class="line">                .endObject()</span><br><span class="line">                .endObject()</span><br><span class="line">                .endObject()</span><br><span class="line">                .endObject();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建映射</span></span><br><span class="line">        <span class="type">PutMappingRequest</span> <span class="variable">mapping</span> <span class="operator">=</span> Requests.putMappingRequest(<span class="string">&quot;goodsindex&quot;</span>)      <span class="comment">// 该索引必须存在</span></span><br><span class="line">                .type(<span class="string">&quot;_doc&quot;</span>).source(builder);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 索引操作对象</span></span><br><span class="line">        <span class="type">IndicesAdminClient</span> <span class="variable">indices</span> <span class="operator">=</span> client.admin().indices();</span><br><span class="line"></span><br><span class="line">        indices.putMapping(mapping).get();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//释放资源</span></span><br><span class="line">        client.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test3</span><span class="params">()</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 删除索引</span></span><br><span class="line">        client.admin().indices().prepareDelete(<span class="string">&quot;goodsindex&quot;</span>).get();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 删除索引</span></span><br><span class="line"><span class="comment">//        client.admin().indices().delete(new DeleteIndexRequest(&quot;goodsindex&quot;)).get();</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h2 id="12-3-文档管理"><a href="#12-3-文档管理" class="headerlink" title="12.3 文档管理"></a>12.3 文档管理</h2><blockquote>
<p>更多详情可以参考官网：<a class="link"   target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/client/java-rest/7.3/index.html" >https://www.elastic.co/guide/en/elasticsearch/client/java-rest/7.3/index.html <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
</blockquote>
<ul>
<li>示例代码：</li>
</ul>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.dfbz.demo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.dfbz.entity.Goods;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.action.delete.DeleteRequest;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.action.get.GetRequest;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.action.get.GetResponse;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.action.index.IndexRequest;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.action.update.UpdateRequest;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.client.transport.TransportClient;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.common.settings.Settings;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.common.transport.TransportAddress;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.common.xcontent.XContentBuilder;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.common.xcontent.XContentFactory;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.common.xcontent.XContentType;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.transport.client.PreBuiltTransportClient;</span><br><span class="line"><span class="keyword">import</span> org.junit.After;</span><br><span class="line"><span class="keyword">import</span> org.junit.Before;</span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.net.InetAddress;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Demo02_CRUD</span> &#123;</span><br><span class="line">    <span class="comment">// 创建Client连接对象</span></span><br><span class="line">    <span class="keyword">private</span> Settings settings;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// es客户端对象</span></span><br><span class="line">    <span class="keyword">private</span> TransportClient client;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Before</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">before</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 创建Client连接对象</span></span><br><span class="line">        settings = Settings.builder().put(<span class="string">&quot;cluster.name&quot;</span>, <span class="string">&quot;my-cluster&quot;</span>).build();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 客户端对象</span></span><br><span class="line">        client = <span class="keyword">new</span> <span class="title class_">PreBuiltTransportClient</span>(settings)</span><br><span class="line">                .addTransportAddress(<span class="keyword">new</span> <span class="title class_">TransportAddress</span>(InetAddress.getByName(<span class="string">&quot;127.0.0.1&quot;</span>), <span class="number">9300</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@After</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">after</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        client.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test1</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;              <span class="comment">// 新增文档</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 准备json数据</span></span><br><span class="line">        <span class="type">Goods</span> <span class="variable">goods</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Goods</span>(<span class="string">&quot;1&quot;</span>,</span><br><span class="line">                <span class="string">&quot;xiaomi shouji&quot;</span>,</span><br><span class="line">                <span class="string">&quot;xiaomi 5G paizhao shouji&quot;</span>,</span><br><span class="line">                <span class="number">2899.0D</span>,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;5G&quot;</span>, <span class="string">&quot;paizhao&quot;</span>&#125;</span><br><span class="line">                );</span><br><span class="line">        <span class="type">ObjectMapper</span> <span class="variable">objectMapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建索引请求对象</span></span><br><span class="line">        <span class="type">IndexRequest</span> <span class="variable">indexRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IndexRequest</span>(<span class="string">&quot;goodsindex&quot;</span>, <span class="string">&quot;_doc&quot;</span>, <span class="string">&quot;1&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 传递json数据</span></span><br><span class="line">        indexRequest.source(objectMapper.writeValueAsString(goods), XContentType.JSON);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 执行请求</span></span><br><span class="line">        client.index(indexRequest).get();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test2</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;          <span class="comment">// XContentBuilder方式构建文档</span></span><br><span class="line">        <span class="comment">//创建文档信息</span></span><br><span class="line">        <span class="type">XContentBuilder</span> <span class="variable">builder</span> <span class="operator">=</span> XContentFactory.jsonBuilder()</span><br><span class="line">                .startObject()</span><br><span class="line">                .field(<span class="string">&quot;id&quot;</span>, <span class="string">&quot;2&quot;</span>)</span><br><span class="line">                .field(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;huawei shouji&quot;</span>)</span><br><span class="line">                .field(<span class="string">&quot;title&quot;</span>, <span class="string">&quot;huawei 4G youxi shouji&quot;</span>)</span><br><span class="line">                .field(<span class="string">&quot;price&quot;</span>, <span class="number">988</span>)</span><br><span class="line">                .field(<span class="string">&quot;category&quot;</span>, <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;4G&quot;</span>, <span class="string">&quot;youxi&quot;</span>&#125;)</span><br><span class="line">                .endObject();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 建立文档对象</span></span><br><span class="line">        client.prepareIndex(<span class="string">&quot;goodsindex&quot;</span>, <span class="string">&quot;_doc&quot;</span>, <span class="string">&quot;1&quot;</span>).setSource(builder).get();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test3</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;              <span class="comment">// 创建文档(通过实体转json)</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 描述json 数据</span></span><br><span class="line">        <span class="type">Goods</span> <span class="variable">goods</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Goods</span>(<span class="string">&quot;3&quot;</span>,</span><br><span class="line">                <span class="string">&quot;meizu shouji&quot;</span>,</span><br><span class="line">                <span class="string">&quot;meizu 4G paizhao shouji&quot;</span>,</span><br><span class="line">                <span class="number">1899.0D</span>,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;4G&quot;</span>, <span class="string">&quot;paizhao&quot;</span>&#125;</span><br><span class="line">                );</span><br><span class="line">        <span class="type">ObjectMapper</span> <span class="variable">objectMapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 建立文档</span></span><br><span class="line">        client.prepareIndex(<span class="string">&quot;goodsindex&quot;</span>, <span class="string">&quot;_doc&quot;</span>)</span><br><span class="line">                .setId(goods.getId())</span><br><span class="line">                .setSource(objectMapper.writeValueAsString(goods),XContentType.JSON).get();</span><br><span class="line"><span class="comment">//                .setSource(objectMapper.writeValueAsString(goods).getBytes(), XContentType.JSON).get();</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//释放资源</span></span><br><span class="line">        client.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test4</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;                  <span class="comment">// 删除文档</span></span><br><span class="line">        client.delete(<span class="keyword">new</span> <span class="title class_">DeleteRequest</span>(<span class="string">&quot;goodsindex&quot;</span>, <span class="string">&quot;_doc&quot;</span>, <span class="string">&quot;4&quot;</span>)).get();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test5</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;                  <span class="comment">// 删除文档</span></span><br><span class="line">        client.prepareDelete(<span class="string">&quot;goodsindex&quot;</span>, <span class="string">&quot;_doc&quot;</span>, <span class="string">&quot;1&quot;</span>).get();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test6</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;                  <span class="comment">// 修改文档</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 准备Update请求</span></span><br><span class="line">        <span class="type">UpdateRequest</span> <span class="variable">updateRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UpdateRequest</span>(<span class="string">&quot;goodsindex&quot;</span>, <span class="string">&quot;_doc&quot;</span>, <span class="string">&quot;1&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Goods</span> <span class="variable">goods</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Goods</span>(<span class="string">&quot;1&quot;</span>,</span><br><span class="line">                <span class="string">&quot;lianxian shouji&quot;</span>,</span><br><span class="line">                <span class="string">&quot;lianxiang 5G youxi shouji&quot;</span>,</span><br><span class="line">                <span class="number">3899.0D</span>,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;5G&quot;</span>, <span class="string">&quot;youxi&quot;</span>&#125;</span><br><span class="line">                );</span><br><span class="line"></span><br><span class="line">        <span class="type">ObjectMapper</span> <span class="variable">om</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 设置新文档</span></span><br><span class="line">        updateRequest.doc(om.writeValueAsString(goods), XContentType.JSON);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 执行update请求</span></span><br><span class="line">        client.update(updateRequest).get();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test7</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;                  <span class="comment">// 修改文档</span></span><br><span class="line"></span><br><span class="line">        <span class="type">Goods</span> <span class="variable">goods</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Goods</span>(<span class="string">&quot;2&quot;</span>,</span><br><span class="line">                <span class="string">&quot;oppo shouji&quot;</span>,</span><br><span class="line">                <span class="string">&quot;oppo 4G paizhao shouji&quot;</span>,</span><br><span class="line">                <span class="number">3899.0D</span>, <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;4G&quot;</span>, <span class="string">&quot;paizhao&quot;</span>&#125;);</span><br><span class="line"></span><br><span class="line">        <span class="type">ObjectMapper</span> <span class="variable">om</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 执行update请求</span></span><br><span class="line">        client.prepareUpdate(<span class="string">&quot;goodsindex&quot;</span>, <span class="string">&quot;_doc&quot;</span>, <span class="string">&quot;3&quot;</span>)</span><br><span class="line">                .setDoc(om.writeValueAsString(goods), XContentType.JSON).</span><br><span class="line">                get();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test8</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;                  <span class="comment">// 查询文档</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 准备一个get请求</span></span><br><span class="line">        <span class="type">GetRequest</span> <span class="variable">getRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GetRequest</span>(<span class="string">&quot;goodsindex&quot;</span>, <span class="string">&quot;_doc&quot;</span>, <span class="string">&quot;1&quot;</span>);</span><br><span class="line">        <span class="comment">// 执行get请求</span></span><br><span class="line">        <span class="type">GetResponse</span> <span class="variable">res</span> <span class="operator">=</span> client.get(getRequest).get();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取map数据</span></span><br><span class="line">        Map&lt;String, Object&gt; goodsMap = res.getSource();</span><br><span class="line">        System.out.println(goodsMap);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取json数据</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">goodsJson</span> <span class="operator">=</span> res.getSourceAsString();</span><br><span class="line">        System.out.println(goodsJson);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test9</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;                  <span class="comment">// 查询文档</span></span><br><span class="line"></span><br><span class="line">        <span class="type">GetResponse</span> <span class="variable">res</span> <span class="operator">=</span> client.prepareGet(<span class="string">&quot;goodsindex&quot;</span>, <span class="string">&quot;_doc&quot;</span>, <span class="string">&quot;1&quot;</span>).get();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取map数据</span></span><br><span class="line">        Map&lt;String, Object&gt; goodsMap = res.getSource();</span><br><span class="line">        System.out.println(goodsMap);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取json数据</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">goodsJson</span> <span class="operator">=</span> res.getSourceAsString();</span><br><span class="line">        System.out.println(goodsJson);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h2 id="12-4-文档搜索"><a href="#12-4-文档搜索" class="headerlink" title="12.4 文档搜索"></a>12.4 文档搜索</h2><h3 id="12-4-1-准备数据"><a href="#12-4-1-准备数据" class="headerlink" title="12.4.1 准备数据"></a>12.4.1 准备数据</h3><div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line">DELETE goodsindex</span><br><span class="line"></span><br><span class="line">POST /goodsindex/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;name&quot;:&quot;huawei shouji&quot;,</span><br><span class="line">  &quot;title&quot;:&quot;huawei 4G quanmianping youxi shouji&quot;,</span><br><span class="line">  &quot;price&quot;:4899,</span><br><span class="line">  &quot;category&quot;:[&quot;youxi&quot;,&quot;4G&quot;,&quot;quanmianping&quot;]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST /goodsindex/_doc/2</span><br><span class="line">&#123;</span><br><span class="line">  &quot;name&quot;:&quot;vivo shouji&quot;,</span><br><span class="line">  &quot;title&quot;:&quot;vivo 5G paizhao shouji&quot;,</span><br><span class="line">  &quot;price&quot;:2899,</span><br><span class="line">  &quot;category&quot;:[&quot;5G&quot;,&quot;paizhao&quot;]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST /goodsindex/_doc/3</span><br><span class="line">&#123;</span><br><span class="line">  &quot;name&quot;:&quot;oppo shouji&quot;,</span><br><span class="line">  &quot;title&quot;:&quot;oppo 5G paizhao shouji&quot;,</span><br><span class="line">  &quot;price&quot;:1899,</span><br><span class="line">  &quot;category&quot;:[&quot;5G&quot;,&quot;paizhao&quot;]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST /goodsindex/_doc/4</span><br><span class="line">&#123;</span><br><span class="line">  &quot;name&quot;:&quot;huawei shouji&quot;,</span><br><span class="line">  &quot;title&quot;:&quot;huawei 5G youxi shouji&quot;,</span><br><span class="line">  &quot;price&quot;:3899,</span><br><span class="line">  &quot;category&quot;:[&quot;5G&quot;,&quot;youxi&quot;]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST /goodsindex/_doc/5</span><br><span class="line">&#123;</span><br><span class="line">  &quot;name&quot;:&quot;xiaomi shouji&quot;,</span><br><span class="line">  &quot;title&quot;:&quot;xiaomi 4G youxi shouji&quot;,</span><br><span class="line">  &quot;price&quot;:988,</span><br><span class="line">  &quot;category&quot;:[&quot;youxi&quot;,&quot;4G&quot;]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST /goodsindex/_doc/6</span><br><span class="line">&#123;</span><br><span class="line">  &quot;name&quot;:&quot;xiaomi shouji&quot;,</span><br><span class="line">  &quot;title&quot;:&quot;xiaomi 5G youxi qumianping shouji&quot;,</span><br><span class="line">  &quot;price&quot;:1899,</span><br><span class="line">  &quot;category&quot;:[&quot;youxi&quot;,&quot;5G&quot;,&quot;qumianping&quot;]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST /goodsindex/_doc/7</span><br><span class="line">&#123;</span><br><span class="line">  &quot;name&quot;:&quot;xiaomi shouji&quot;,</span><br><span class="line">  &quot;title&quot;:&quot;xiaomi 5G youxi shouji&quot;,</span><br><span class="line">  &quot;price&quot;:1299,</span><br><span class="line">  &quot;category&quot;:[&quot;youxi&quot;,&quot;5G&quot;]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST /goodsindex/_doc/8</span><br><span class="line">&#123;</span><br><span class="line">  &quot;name&quot;:&quot;xiaomi shouji&quot;,</span><br><span class="line">  &quot;title&quot;:&quot;xiaomi 4G shouji&quot;,</span><br><span class="line">  &quot;price&quot;:869,</span><br><span class="line">  &quot;category&quot;:[&quot;4G&quot;]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST /goodsindex/_doc/9</span><br><span class="line">&#123;</span><br><span class="line">  &quot;name&quot;:&quot;huawei shouji&quot;,</span><br><span class="line">  &quot;title&quot;:&quot;huawei 5G zhineng qumianping shouji&quot;,</span><br><span class="line">  &quot;price&quot;:2899,</span><br><span class="line">  &quot;category&quot;:[&quot;zhineng&quot;,&quot;5G&quot;,&quot;qumianping&quot;]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST /goodsindex/_doc/10</span><br><span class="line">&#123;</span><br><span class="line">  &quot;name&quot;:&quot;youxi shouji&quot;,</span><br><span class="line">  &quot;title&quot;:&quot;xiaomi 5G shouji&quot;,</span><br><span class="line">  &quot;price&quot;:2899,</span><br><span class="line">  &quot;category&quot;:[&quot;youxi&quot;,&quot;5G&quot;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>



<h3 id="12-4-2-SearchRequest搜索"><a href="#12-4-2-SearchRequest搜索" class="headerlink" title="12.4.2 SearchRequest搜索"></a>12.4.2 SearchRequest搜索</h3><ul>
<li><p><code>SearchRequest</code>：是ES提供的一个专门用于搜索的对象；在创建SearchRequest对象时指定要操作的索引（默认情况下在所有索引中搜索），SearchRequest可以执行封装大部分的搜索；例如<code>string search</code>、<code>queryDSL</code>、<code>query filter</code>、<code>phrase search</code>、<code>term query</code>、<code>query string</code>、<code>highlight search</code>、<code>聚合搜索</code>等；</p>
</li>
<li><p><code>SearchSourceBuilder</code>：搜索源构建对象，在此对象中设置搜索的条件；最终将SearchSourceBuilder类设置到SearchRequest中，代表填充条件完毕；</p>
</li>
<li><p><code>QueryBuilders</code>：查询条件构建对象，用于构建不同类型的查询；</p>
</li>
</ul>
<table>
<thead>
<tr>
<th><code>QueryBuilders</code>中的方法</th>
<th>对应查询</th>
</tr>
</thead>
<tbody><tr>
<td>queryStringQuery</td>
<td>string search</td>
</tr>
<tr>
<td>matchQuery&#x2F;matchAllQuery</td>
<td>queryDSL</td>
</tr>
<tr>
<td>boolQuery&#x2F;must&#x2F;mustNot</td>
<td>query filter</td>
</tr>
<tr>
<td>matchPhraseQuery</td>
<td>phrase search</td>
</tr>
<tr>
<td>termQuery</td>
<td>term query</td>
</tr>
<tr>
<td>queryStringQuery</td>
<td>query string</td>
</tr>
</tbody></table>
<ul>
<li>示例代码：</li>
</ul>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.dfbz.demo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.action.search.SearchRequest;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.action.search.SearchResponse;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.client.transport.TransportClient;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.common.settings.Settings;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.common.transport.TransportAddress;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.index.query.QueryBuilders;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.SearchHit;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.SearchHits;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.builder.SearchSourceBuilder;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.sort.SortOrder;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.transport.client.PreBuiltTransportClient;</span><br><span class="line"><span class="keyword">import</span> org.junit.After;</span><br><span class="line"><span class="keyword">import</span> org.junit.Before;</span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.net.InetAddress;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Demo03_Query_as_SearchRequest</span> &#123;</span><br><span class="line">    <span class="comment">// 创建Client连接对象</span></span><br><span class="line">    <span class="keyword">private</span> Settings settings;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// es客户端对象</span></span><br><span class="line">    <span class="keyword">private</span> TransportClient client;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 抽取打印方法</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">print</span><span class="params">(SearchResponse res)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;查询到: &quot;</span> + res.getHits().getTotalHits().value);</span><br><span class="line"></span><br><span class="line">        <span class="type">SearchHits</span> <span class="variable">hits</span> <span class="operator">=</span> res.getHits();</span><br><span class="line">        <span class="keyword">for</span> (SearchHit hit : hits) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;score: &quot;</span> + hit.getScore());</span><br><span class="line">            <span class="comment">// 文档的json返回形式</span></span><br><span class="line">            System.out.println(hit.getSourceAsString());</span><br><span class="line">            System.out.println(<span class="string">&quot;------------&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Before</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">before</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 创建Client连接对象</span></span><br><span class="line">        settings = Settings.builder().put(<span class="string">&quot;cluster.name&quot;</span>, <span class="string">&quot;my-cluster&quot;</span>).build();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 客户端对象</span></span><br><span class="line">        client = <span class="keyword">new</span> <span class="title class_">PreBuiltTransportClient</span>(settings)</span><br><span class="line">                .addTransportAddress(<span class="keyword">new</span> <span class="title class_">TransportAddress</span>(InetAddress.getByName(<span class="string">&quot;127.0.0.1&quot;</span>), <span class="number">9300</span>));</span><br><span class="line">        System.out.println(client.getClass());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@After</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">after</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        client.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// string search</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">stringSearch</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;               <span class="comment">// 带分词</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建搜索对象</span></span><br><span class="line">        <span class="type">SearchRequest</span> <span class="variable">searchRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchRequest</span>(<span class="string">&quot;goodsindex&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建查询构建对象</span></span><br><span class="line">        <span class="type">SearchSourceBuilder</span> <span class="variable">builder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchSourceBuilder</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 设置查询条件</span></span><br><span class="line">        builder.query(QueryBuilders.queryStringQuery(<span class="string">&quot;title:shou*&quot;</span>));</span><br><span class="line">        builder.query(QueryBuilders.queryStringQuery(<span class="string">&quot;category:youxi&quot;</span>));</span><br><span class="line">        builder.query(QueryBuilders.queryStringQuery(<span class="string">&quot;price:[2000 TO 5000]&quot;</span>));</span><br><span class="line">        builder.sort(<span class="string">&quot;price&quot;</span>,SortOrder.DESC);</span><br><span class="line">        builder.from(<span class="number">0</span>);</span><br><span class="line">        builder.size(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 封装查询</span></span><br><span class="line">        searchRequest.source(builder);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 执行查询获取结果集</span></span><br><span class="line">        <span class="type">SearchResponse</span> <span class="variable">res</span> <span class="operator">=</span> client.search(searchRequest).get();</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;查询到: &quot;</span> + res.getHits().getTotalHits().value);</span><br><span class="line"></span><br><span class="line">        <span class="type">SearchHits</span> <span class="variable">hits</span> <span class="operator">=</span> res.getHits();</span><br><span class="line">        <span class="keyword">for</span> (SearchHit hit : hits) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;score: &quot;</span> + hit.getScore());</span><br><span class="line">            <span class="comment">// 文档的json返回形式</span></span><br><span class="line">            System.out.println(hit.getSourceAsString());</span><br><span class="line">            System.out.println(<span class="string">&quot;------------&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">queryDSL</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建搜索请求对象</span></span><br><span class="line">        <span class="type">SearchRequest</span> <span class="variable">searchRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchRequest</span>(<span class="string">&quot;goodsindex&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建查询构建对象</span></span><br><span class="line">        <span class="type">SearchSourceBuilder</span> <span class="variable">builder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchSourceBuilder</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 设置查询条件</span></span><br><span class="line">        builder.query(QueryBuilders.matchQuery(<span class="string">&quot;title&quot;</span>, <span class="string">&quot;xiaomi&quot;</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 封装查询</span></span><br><span class="line">        searchRequest.source(builder);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 执行查询获取结果集</span></span><br><span class="line">        <span class="type">SearchResponse</span> <span class="variable">res</span> <span class="operator">=</span> client.search(searchRequest).get();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 打印结果集</span></span><br><span class="line">        print(res);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">queryFilter</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">SearchRequest</span> <span class="variable">searchRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchRequest</span>(<span class="string">&quot;goodsindex&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建查询构建对象</span></span><br><span class="line">        <span class="type">SearchSourceBuilder</span> <span class="variable">builder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchSourceBuilder</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 构建查询条件</span></span><br><span class="line">        builder.query(</span><br><span class="line">                QueryBuilders.boolQuery().</span><br><span class="line">                        must(QueryBuilders.matchQuery(<span class="string">&quot;title&quot;</span>, <span class="string">&quot;huawei&quot;</span>)).</span><br><span class="line">                        mustNot(QueryBuilders.matchQuery(<span class="string">&quot;title&quot;</span>, <span class="string">&quot;youxi&quot;</span>))</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 封装查询条件</span></span><br><span class="line">        searchRequest.source(builder);</span><br><span class="line">        <span class="type">SearchResponse</span> <span class="variable">res</span> <span class="operator">=</span> client.search(searchRequest).get();</span><br><span class="line"></span><br><span class="line">        print(res);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">phraseSearch</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建搜索请求对象</span></span><br><span class="line">        <span class="type">SearchRequest</span> <span class="variable">searchRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchRequest</span>(<span class="string">&quot;goodsindex&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建查询构建对象</span></span><br><span class="line">        <span class="type">SearchSourceBuilder</span> <span class="variable">builder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchSourceBuilder</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 设置查询条件</span></span><br><span class="line">        builder.query(QueryBuilders.matchPhraseQuery(<span class="string">&quot;title&quot;</span>, <span class="string">&quot;huawei 5G&quot;</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 封装查询</span></span><br><span class="line">        searchRequest.source(builder);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 执行查询获取结果集</span></span><br><span class="line">        <span class="type">SearchResponse</span> <span class="variable">res</span> <span class="operator">=</span> client.search(searchRequest).get();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 打印结果集</span></span><br><span class="line">        print(res);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">termQuery</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建搜索请求对象</span></span><br><span class="line">        <span class="type">SearchRequest</span> <span class="variable">searchRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchRequest</span>(<span class="string">&quot;goodsindex&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建查询构建对象</span></span><br><span class="line">        <span class="type">SearchSourceBuilder</span> <span class="variable">builder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchSourceBuilder</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 设置查询条件</span></span><br><span class="line">        builder.query(QueryBuilders.termQuery(<span class="string">&quot;title&quot;</span>, <span class="string">&quot;huawei 5G&quot;</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 封装查询</span></span><br><span class="line">        searchRequest.source(builder);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 执行查询获取结果集</span></span><br><span class="line">        <span class="type">SearchResponse</span> <span class="variable">res</span> <span class="operator">=</span> client.search(searchRequest).get();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 打印结果集</span></span><br><span class="line">        print(res);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">queryString</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建搜索请求对象</span></span><br><span class="line">        <span class="type">SearchRequest</span> <span class="variable">searchRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchRequest</span>(<span class="string">&quot;goodsindex&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建查询构建对象</span></span><br><span class="line">        <span class="type">SearchSourceBuilder</span> <span class="variable">builder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchSourceBuilder</span>();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 设置查询条件</span></span><br><span class="line">        builder.query(</span><br><span class="line">                <span class="comment">// AND/OR 运算符查询</span></span><br><span class="line"><span class="comment">//                QueryBuilders.queryStringQuery(&quot;youxi 5G&quot;).field(&quot;name&quot;).field(&quot;title&quot;).defaultOperator(Operator.AND)</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">// 最少匹配词条</span></span><br><span class="line"><span class="comment">//                QueryBuilders.queryStringQuery(&quot;huawei youxi 4G&quot;).field(&quot;title&quot;).minimumShouldMatch(&quot;2&quot;)</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">// 模糊查询</span></span><br><span class="line"><span class="comment">//                QueryBuilders.queryStringQuery(&quot;huawkk~&quot;).field(&quot;title&quot;)</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">// 范围查询</span></span><br><span class="line">                QueryBuilders.queryStringQuery(<span class="string">&quot;[2000 TO 3000]&quot;</span>).field(<span class="string">&quot;price&quot;</span>)</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 封装查询</span></span><br><span class="line">        searchRequest.source(builder);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 执行查询获取结果集</span></span><br><span class="line">        <span class="type">SearchResponse</span> <span class="variable">res</span> <span class="operator">=</span> client.search(searchRequest).get();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 打印结果集</span></span><br><span class="line">        print(res);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="12-4-3-TransportClient搜索"><a href="#12-4-3-TransportClient搜索" class="headerlink" title="12.4.3 TransportClient搜索"></a>12.4.3 TransportClient搜索</h3><p>使用TransportClient类提供的prepareSearch方法进行搜索，同样使用QueryBuilders进行搜索条件的构建，只是写法不同而已；</p>
<ul>
<li>示例代码：</li>
</ul>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.dfbz.demo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.action.search.SearchResponse;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.client.transport.TransportClient;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.common.settings.Settings;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.common.transport.TransportAddress;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.index.query.QueryBuilders;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.SearchHit;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.SearchHits;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.sort.SortOrder;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.transport.client.PreBuiltTransportClient;</span><br><span class="line"><span class="keyword">import</span> org.junit.After;</span><br><span class="line"><span class="keyword">import</span> org.junit.Before;</span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.net.InetAddress;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Demo04_Query_as_TransportClient</span> &#123;</span><br><span class="line">    <span class="comment">// 创建Client连接对象</span></span><br><span class="line">    <span class="keyword">private</span> Settings settings;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// es客户端对象</span></span><br><span class="line">    <span class="keyword">private</span> TransportClient client;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 抽取打印方法</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">print</span><span class="params">(SearchResponse res)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;查询到: &quot;</span> + res.getHits().getTotalHits().value);</span><br><span class="line"></span><br><span class="line">        <span class="type">SearchHits</span> <span class="variable">hits</span> <span class="operator">=</span> res.getHits();</span><br><span class="line">        <span class="keyword">for</span> (SearchHit hit : hits) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;score: &quot;</span> + hit.getScore());</span><br><span class="line">            <span class="comment">// 文档的json返回形式</span></span><br><span class="line">            System.out.println(hit.getSourceAsString());</span><br><span class="line">            System.out.println(<span class="string">&quot;------------&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Before</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">before</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 创建Client连接对象</span></span><br><span class="line">        settings = Settings.builder().put(<span class="string">&quot;cluster.name&quot;</span>, <span class="string">&quot;my-cluster&quot;</span>).build();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 客户端对象</span></span><br><span class="line">        client = <span class="keyword">new</span> <span class="title class_">PreBuiltTransportClient</span>(settings)</span><br><span class="line">                .addTransportAddress(<span class="keyword">new</span> <span class="title class_">TransportAddress</span>(InetAddress.getByName(<span class="string">&quot;127.0.0.1&quot;</span>), <span class="number">9300</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@After</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">after</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        client.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// string search</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">stringSearch</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;               <span class="comment">// 带分词</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建搜索条件对象</span></span><br><span class="line">        <span class="type">SearchResponse</span> <span class="variable">res</span> <span class="operator">=</span> client.prepareSearch(<span class="string">&quot;goodsindex&quot;</span>)</span><br><span class="line">                .setTypes(<span class="string">&quot;_doc&quot;</span>)</span><br><span class="line">                .setQuery(QueryBuilders.queryStringQuery(<span class="string">&quot;title:4G&quot;</span>))</span><br><span class="line">                .setQuery(QueryBuilders.queryStringQuery(<span class="string">&quot;category:youxi&quot;</span>))</span><br><span class="line">                .setQuery(QueryBuilders.queryStringQuery(<span class="string">&quot;price:[2000 TO 5000]&quot;</span>))</span><br><span class="line">                .addSort(<span class="string">&quot;price&quot;</span>, SortOrder.DESC)</span><br><span class="line">                .setFrom(<span class="number">0</span>)</span><br><span class="line">                .setSize(<span class="number">3</span>)</span><br><span class="line">                .get();</span><br><span class="line"></span><br><span class="line">        print(res);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// query DSL</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">queryDSL</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建搜索条件对象</span></span><br><span class="line">        <span class="type">SearchResponse</span> <span class="variable">res</span> <span class="operator">=</span> client.prepareSearch(<span class="string">&quot;goodsindex&quot;</span>)</span><br><span class="line">                .setTypes(<span class="string">&quot;_doc&quot;</span>)</span><br><span class="line">                .setQuery(QueryBuilders.matchQuery(<span class="string">&quot;title&quot;</span>, <span class="string">&quot;xiaomi&quot;</span>))</span><br><span class="line">                .get();</span><br><span class="line"></span><br><span class="line">        print(res);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testIdQuery</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">SearchResponse</span> <span class="variable">res</span> <span class="operator">=</span> client.prepareSearch(<span class="string">&quot;goodsindex&quot;</span>)</span><br><span class="line">                .setTypes(<span class="string">&quot;article&quot;</span>)</span><br><span class="line">                <span class="comment">//设置要查询的id</span></span><br><span class="line">                .setQuery(QueryBuilders.idsQuery().addIds(<span class="string">&quot;1&quot;</span>, <span class="string">&quot;2&quot;</span>))</span><br><span class="line">                <span class="comment">//执行查询</span></span><br><span class="line">                .get();</span><br><span class="line"></span><br><span class="line">        print(res);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// queryFilter</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">queryFilter</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">SearchResponse</span> <span class="variable">res</span> <span class="operator">=</span> client.prepareSearch(<span class="string">&quot;goodsindex&quot;</span>)</span><br><span class="line">                .setQuery(</span><br><span class="line">                        QueryBuilders.boolQuery()</span><br><span class="line">                                .must(QueryBuilders.matchQuery(<span class="string">&quot;title&quot;</span>, <span class="string">&quot;huawei&quot;</span>))</span><br><span class="line">                                .mustNot(QueryBuilders.matchQuery(<span class="string">&quot;title&quot;</span>, <span class="string">&quot;youxi&quot;</span>))</span><br><span class="line">                ).get();</span><br><span class="line"></span><br><span class="line">        print(res);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// phrase search</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">phraseSearch</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">SearchResponse</span> <span class="variable">res</span> <span class="operator">=</span> client.prepareSearch(<span class="string">&quot;goodsindex&quot;</span>)</span><br><span class="line">                .setQuery(QueryBuilders.matchPhraseQuery(<span class="string">&quot;title&quot;</span>, <span class="string">&quot;huawei 5G&quot;</span>))</span><br><span class="line">                .get();</span><br><span class="line"></span><br><span class="line">        print(res);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// term query</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">termQuery</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">SearchResponse</span> <span class="variable">res</span> <span class="operator">=</span> client.prepareSearch(<span class="string">&quot;goodsindex&quot;</span>)</span><br><span class="line">                .setQuery(QueryBuilders.termQuery(<span class="string">&quot;title&quot;</span>, <span class="string">&quot;huawei 5G&quot;</span>))</span><br><span class="line">                .get();</span><br><span class="line"></span><br><span class="line">        print(res);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// term query</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">queryString</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">SearchResponse</span> <span class="variable">res</span> <span class="operator">=</span> client.prepareSearch(<span class="string">&quot;goodsindex&quot;</span>)</span><br><span class="line">                .setQuery(</span><br><span class="line">                        <span class="comment">// AND/OR 运算符查询</span></span><br><span class="line"><span class="comment">//                QueryBuilders.queryStringQuery(&quot;youxi 5G&quot;).field(&quot;name&quot;).field(&quot;title&quot;).defaultOperator(Operator.AND)</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">// 最少匹配词条</span></span><br><span class="line"><span class="comment">//                QueryBuilders.queryStringQuery(&quot;huawei youxi 4G&quot;).field(&quot;title&quot;).minimumShouldMatch(&quot;2&quot;)</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">// 模糊查询</span></span><br><span class="line"><span class="comment">//                QueryBuilders.queryStringQuery(&quot;huawkk~&quot;).field(&quot;title&quot;)</span></span><br><span class="line"></span><br><span class="line">                        <span class="comment">// 范围查询</span></span><br><span class="line">                        QueryBuilders.queryStringQuery(<span class="string">&quot;[2000 TO 3000]&quot;</span>).field(<span class="string">&quot;price&quot;</span>)</span><br><span class="line">                )</span><br><span class="line">                .get();</span><br><span class="line">        print(res);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="12-4-4-高亮搜索"><a href="#12-4-4-高亮搜索" class="headerlink" title="12.4.4 高亮搜索"></a>12.4.4 高亮搜索</h3><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.dfbz.demo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.action.search.SearchRequest;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.action.search.SearchResponse;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.client.transport.TransportClient;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.common.settings.Settings;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.common.transport.TransportAddress;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.index.query.QueryBuilders;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.SearchHit;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.SearchHits;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.builder.SearchSourceBuilder;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.fetch.subphase.highlight.HighlightBuilder;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.fetch.subphase.highlight.HighlightField;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.transport.client.PreBuiltTransportClient;</span><br><span class="line"><span class="keyword">import</span> org.junit.After;</span><br><span class="line"><span class="keyword">import</span> org.junit.Before;</span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.net.InetAddress;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Demo05_Query_as_High</span> &#123;</span><br><span class="line">    <span class="comment">// 创建Client连接对象</span></span><br><span class="line">    <span class="keyword">private</span> Settings settings;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// es客户端对象</span></span><br><span class="line">    <span class="keyword">private</span> TransportClient client;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 抽取打印方法</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">print</span><span class="params">(SearchResponse res)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;查询到: &quot;</span> + res.getHits().getTotalHits().value);</span><br><span class="line"></span><br><span class="line">        <span class="type">SearchHits</span> <span class="variable">hits</span> <span class="operator">=</span> res.getHits();</span><br><span class="line">        <span class="keyword">for</span> (SearchHit hit : hits) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;score: &quot;</span> + hit.getScore());</span><br><span class="line">            <span class="comment">// 文档的json返回形式</span></span><br><span class="line">            System.out.println(hit.getSourceAsString());</span><br><span class="line">            System.out.println(<span class="string">&quot;------------&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Before</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">before</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 创建Client连接对象</span></span><br><span class="line">        settings = Settings.builder().put(<span class="string">&quot;cluster.name&quot;</span>, <span class="string">&quot;my-cluster&quot;</span>).build();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 客户端对象</span></span><br><span class="line">        client = <span class="keyword">new</span> <span class="title class_">PreBuiltTransportClient</span>(settings)</span><br><span class="line">                .addTransportAddress(<span class="keyword">new</span> <span class="title class_">TransportAddress</span>(InetAddress.getByName(<span class="string">&quot;127.0.0.1&quot;</span>), <span class="number">9300</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@After</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">after</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        client.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">searchQueryHighQuery</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;       <span class="comment">// 使用SearchRequest对象进行高亮搜索</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 准备一个SearchRequest对象</span></span><br><span class="line">        <span class="type">SearchRequest</span> <span class="variable">searchRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchRequest</span>(<span class="string">&quot;goodsindex&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 搜索条件构建对象</span></span><br><span class="line">        <span class="type">SearchSourceBuilder</span> <span class="variable">builder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchSourceBuilder</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 设置搜索条件</span></span><br><span class="line">        builder.query(QueryBuilders.queryStringQuery(<span class="string">&quot;title:4G&quot;</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 高亮构建对象</span></span><br><span class="line">        <span class="type">HighlightBuilder</span> <span class="variable">highBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HighlightBuilder</span>().field(<span class="string">&quot;title&quot;</span>).preTags(<span class="string">&quot;&lt;font color=&#x27;red&#x27;&gt;&quot;</span>).postTags(<span class="string">&quot;&lt;/font&gt;&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 设置高亮</span></span><br><span class="line">        builder.highlighter(highBuilder);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 设置查询源</span></span><br><span class="line">        searchRequest.source(builder);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 执行查询</span></span><br><span class="line">        <span class="type">SearchResponse</span> <span class="variable">res</span> <span class="operator">=</span> client.search(searchRequest).get();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取命中的记录</span></span><br><span class="line">        <span class="type">SearchHits</span> <span class="variable">results</span> <span class="operator">=</span> res.getHits();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (SearchHit result : results) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 原始数据</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">sourceAsString</span> <span class="operator">=</span> result.getSourceAsString();</span><br><span class="line">            System.out.println(sourceAsString);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 高亮数据</span></span><br><span class="line">            Map&lt;String, HighlightField&gt; high = result.getHighlightFields();</span><br><span class="line">            System.out.println(high.get(<span class="string">&quot;title&quot;</span>).fragments()[<span class="number">0</span>].string());</span><br><span class="line">            System.out.println(<span class="string">&quot;----------------&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transportClientHighQuery</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;           <span class="comment">// 使用TransportClient原生方法进行高亮搜索</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 高亮条件构造器</span></span><br><span class="line">        <span class="type">HighlightBuilder</span> <span class="variable">highBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HighlightBuilder</span>().field(<span class="string">&quot;title&quot;</span>).preTags(<span class="string">&quot;&lt;/font style=&#x27;red&#x27;&gt;&quot;</span>).postTags(<span class="string">&quot;&lt;/font&gt;&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建搜索条件对象</span></span><br><span class="line">        <span class="type">SearchResponse</span> <span class="variable">res</span> <span class="operator">=</span> client.prepareSearch(<span class="string">&quot;goodsindex&quot;</span>)</span><br><span class="line">                .setTypes(<span class="string">&quot;_doc&quot;</span>)</span><br><span class="line">                .setQuery(QueryBuilders.queryStringQuery(<span class="string">&quot;title:4G&quot;</span>))</span><br><span class="line">                .highlighter(highBuilder)               <span class="comment">// 设置高亮数据</span></span><br><span class="line">                .get();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取命中的记录</span></span><br><span class="line">        <span class="type">SearchHits</span> <span class="variable">results</span> <span class="operator">=</span> res.getHits();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (SearchHit result : results) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 原始数据</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">sourceAsString</span> <span class="operator">=</span> result.getSourceAsString();</span><br><span class="line">            System.out.println(sourceAsString);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 高亮数据</span></span><br><span class="line">            Map&lt;String, HighlightField&gt; high = result.getHighlightFields();</span><br><span class="line">            System.out.println(high.get(<span class="string">&quot;title&quot;</span>).fragments()[<span class="number">0</span>].string());</span><br><span class="line">            System.out.println(<span class="string">&quot;----------------&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="12-4-5-聚合搜索"><a href="#12-4-5-聚合搜索" class="headerlink" title="12.4.5 聚合搜索"></a>12.4.5 聚合搜索</h3><ul>
<li>示例代码：</li>
</ul>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.dfbz.demo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.action.search.SearchRequest;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.action.search.SearchResponse;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.client.transport.TransportClient;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.common.settings.Settings;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.common.transport.TransportAddress;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.index.query.QueryBuilders;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.SearchHit;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.SearchHits;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.aggregations.AggregationBuilders;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.aggregations.Aggregations;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.aggregations.bucket.terms.Terms;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.builder.SearchSourceBuilder;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.transport.client.PreBuiltTransportClient;</span><br><span class="line"><span class="keyword">import</span> org.junit.After;</span><br><span class="line"><span class="keyword">import</span> org.junit.Before;</span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.net.InetAddress;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Demo06_Query_as_Aggs</span> &#123;</span><br><span class="line">    <span class="comment">// 创建Client连接对象</span></span><br><span class="line">    <span class="keyword">private</span> Settings settings;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// es客户端对象</span></span><br><span class="line">    <span class="keyword">private</span> TransportClient client;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 抽取打印方法</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">print</span><span class="params">(SearchResponse res)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;查询到: &quot;</span> + res.getHits().getTotalHits().value);</span><br><span class="line"></span><br><span class="line">        <span class="type">SearchHits</span> <span class="variable">hits</span> <span class="operator">=</span> res.getHits();</span><br><span class="line">        <span class="keyword">for</span> (SearchHit hit : hits) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;score: &quot;</span> + hit.getScore());</span><br><span class="line">            <span class="comment">// 文档的json返回形式</span></span><br><span class="line">            System.out.println(hit.getSourceAsString());</span><br><span class="line">            System.out.println(<span class="string">&quot;------------&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Before</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">before</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 创建Client连接对象</span></span><br><span class="line">        settings = Settings.builder().put(<span class="string">&quot;cluster.name&quot;</span>, <span class="string">&quot;my-cluster&quot;</span>).build();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 客户端对象</span></span><br><span class="line">        client = <span class="keyword">new</span> <span class="title class_">PreBuiltTransportClient</span>(settings)</span><br><span class="line">                .addTransportAddress(<span class="keyword">new</span> <span class="title class_">TransportAddress</span>(InetAddress.getByName(<span class="string">&quot;127.0.0.1&quot;</span>), <span class="number">9300</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@After</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">after</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        client.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 计算每个分类下的商品数量</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">aggs_searchRequest</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 创建搜索对象</span></span><br><span class="line">        <span class="type">SearchRequest</span> <span class="variable">searchRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchRequest</span>(<span class="string">&quot;goodsindex&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 条件构建对象</span></span><br><span class="line">        <span class="type">SearchSourceBuilder</span> <span class="variable">searchBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchSourceBuilder</span>().aggregation(AggregationBuilders.terms(<span class="string">&quot;group_by_category&quot;</span>).field(<span class="string">&quot;category&quot;</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 设置搜索条件</span></span><br><span class="line">        searchRequest.source(searchBuilder);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 执行搜索</span></span><br><span class="line">        <span class="type">SearchResponse</span> <span class="variable">res</span> <span class="operator">=</span> client.search(searchRequest).get();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取聚合数据</span></span><br><span class="line">        <span class="type">Aggregations</span> <span class="variable">aggregations</span> <span class="operator">=</span> res.getAggregations();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 根据分组的名称获取对应的值</span></span><br><span class="line">        <span class="type">Terms</span> <span class="variable">group_by_category</span> <span class="operator">=</span> aggregations.get(<span class="string">&quot;group_by_category&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取</span></span><br><span class="line">        List&lt;? <span class="keyword">extends</span> <span class="title class_">Terms</span>.Bucket&gt; buckets = group_by_category.getBuckets();</span><br><span class="line">        <span class="keyword">for</span> (Terms.Bucket bucket : buckets) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// key</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> bucket.getKeyAsString();</span><br><span class="line">            System.out.println(<span class="string">&quot;key:&quot;</span> + key);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// docCount</span></span><br><span class="line">            <span class="type">long</span> <span class="variable">docCount</span> <span class="operator">=</span> bucket.getDocCount();</span><br><span class="line">            System.out.println(<span class="string">&quot;docCount:&quot;</span> + docCount);</span><br><span class="line"></span><br><span class="line">            System.out.println(<span class="string">&quot;--------------------&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 计算每个分类下的商品数量</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">aggs_transportClientSearch</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        GET goodsindex/_doc/_search</span></span><br><span class="line"><span class="comment">        &#123;</span></span><br><span class="line"><span class="comment">          &quot;size&quot;: 0,</span></span><br><span class="line"><span class="comment">          &quot;aggs&quot;: &#123;</span></span><br><span class="line"><span class="comment">            &quot;group_by_category&quot;: &#123;</span></span><br><span class="line"><span class="comment">              &quot;terms&quot;: &#123;</span></span><br><span class="line"><span class="comment">                &quot;field&quot;: &quot;category&quot;</span></span><br><span class="line"><span class="comment">              &#125;</span></span><br><span class="line"><span class="comment">            &#125;</span></span><br><span class="line"><span class="comment">          &#125;</span></span><br><span class="line"><span class="comment">        &#125;</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="type">SearchResponse</span> <span class="variable">res</span> <span class="operator">=</span> client.prepareSearch(<span class="string">&quot;goodsindex&quot;</span>)</span><br><span class="line">                .setQuery(QueryBuilders.matchAllQuery())</span><br><span class="line">                .addAggregation(AggregationBuilders.terms(<span class="string">&quot;group_by_category&quot;</span>).field(<span class="string">&quot;category&quot;</span>))</span><br><span class="line">                .setSize(<span class="number">0</span>)         <span class="comment">// 不要原始数据(只要聚合数据)</span></span><br><span class="line">                .get();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取聚合数据</span></span><br><span class="line">        <span class="type">Aggregations</span> <span class="variable">aggregations</span> <span class="operator">=</span> res.getAggregations();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 根据分组的名称获取对应的值</span></span><br><span class="line">        <span class="type">Terms</span> <span class="variable">group_by_category</span> <span class="operator">=</span> aggregations.get(<span class="string">&quot;group_by_category&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取</span></span><br><span class="line">        List&lt;? <span class="keyword">extends</span> <span class="title class_">Terms</span>.Bucket&gt; buckets = group_by_category.getBuckets();</span><br><span class="line">        <span class="keyword">for</span> (Terms.Bucket bucket : buckets) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// key</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> bucket.getKeyAsString();</span><br><span class="line">            System.out.println(<span class="string">&quot;key:&quot;</span> + key);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// docCount</span></span><br><span class="line">            <span class="type">long</span> <span class="variable">docCount</span> <span class="operator">=</span> bucket.getDocCount();</span><br><span class="line">            System.out.println(<span class="string">&quot;docCount:&quot;</span> + docCount);</span><br><span class="line"></span><br><span class="line">            System.out.println(<span class="string">&quot;--------------------&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="12-4-6-RestHighLevelClient搜索"><a href="#12-4-6-RestHighLevelClient搜索" class="headerlink" title="12.4.6 RestHighLevelClient搜索"></a>12.4.6 RestHighLevelClient搜索</h3><p>TransportClient在Elasticsearch 7中已被弃用，并将在Elasticsearch 8中被删除。ElasticSearch提供RestHighLevelClient类来替换TransportClient；</p>
<ul>
<li>引入RestHighLevelClient依赖：</li>
</ul>
<div class="highlight-container" data-rel="Xml"><figure class="iseeu highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--es高级客户端--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.elasticsearch.client<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>elasticsearch-rest-high-level-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>7.6.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></div>



<ul>
<li>示例代码：</li>
</ul>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.dfbz.demo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.dfbz.entity.Goods;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;</span><br><span class="line"><span class="keyword">import</span> org.apache.http.HttpHost;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.index.IndexOptions;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.action.delete.DeleteRequest;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.action.get.GetRequest;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.action.get.GetResponse;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.action.index.IndexRequest;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.action.index.IndexResponse;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.action.search.SearchRequest;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.action.search.SearchResponse;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.action.update.UpdateRequest;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.client.RequestOptions;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.client.RestClient;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.client.RestHighLevelClient;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.client.indices.CreateIndexRequest;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.common.xcontent.XContentType;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.index.query.QueryBuilders;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.SearchHit;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.SearchHits;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.aggregations.AggregationBuilders;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.aggregations.Aggregations;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.aggregations.bucket.terms.Terms;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.search.builder.SearchSourceBuilder;</span><br><span class="line"><span class="keyword">import</span> org.junit.After;</span><br><span class="line"><span class="keyword">import</span> org.junit.Before;</span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Demo07_Query_HighLevelQuery</span> &#123;</span><br><span class="line">    <span class="comment">// 高级查询对象</span></span><br><span class="line">    <span class="keyword">private</span> RestHighLevelClient client;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 抽取打印方法</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">print</span><span class="params">(SearchResponse res)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;查询到: &quot;</span> + res.getHits().getTotalHits().value);</span><br><span class="line"></span><br><span class="line">        <span class="type">SearchHits</span> <span class="variable">hits</span> <span class="operator">=</span> res.getHits();</span><br><span class="line">        <span class="keyword">for</span> (SearchHit hit : hits) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;score: &quot;</span> + hit.getScore());</span><br><span class="line">            <span class="comment">// 文档的json返回形式</span></span><br><span class="line">            System.out.println(hit.getSourceAsString());</span><br><span class="line">            System.out.println(<span class="string">&quot;------------&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Before</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">before</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//获取连接客户端</span></span><br><span class="line">        client = <span class="keyword">new</span> <span class="title class_">RestHighLevelClient</span>(</span><br><span class="line">                RestClient.builder(</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">HttpHost</span>(<span class="string">&quot;localhost&quot;</span>, <span class="number">9200</span>, <span class="string">&quot;http&quot;</span>)</span><br><span class="line">                )</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@After</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">after</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        client.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">insert</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;         <span class="comment">// 增</span></span><br><span class="line">        <span class="comment">// 准备数据</span></span><br><span class="line">        <span class="type">Goods</span> <span class="variable">goods</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Goods</span>(<span class="string">&quot;11&quot;</span>,</span><br><span class="line">                <span class="string">&quot;meizu shouji&quot;</span>, <span class="string">&quot;meizu 5G zhineng paizhao shouji&quot;</span>,</span><br><span class="line">                <span class="number">2899.0D</span>, <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;5G&quot;</span>, <span class="string">&quot;zhineng&quot;</span>, <span class="string">&quot;paizhao&quot;</span>&#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 转换为json</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">goodsJson</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>().writeValueAsString(goods);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 准备索引请求对象</span></span><br><span class="line">        <span class="type">IndexRequest</span> <span class="variable">indexRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IndexRequest</span>(<span class="string">&quot;goodsindex&quot;</span>, <span class="string">&quot;_doc&quot;</span>, <span class="string">&quot;11&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 设置数据源</span></span><br><span class="line">        indexRequest.source(goodsJson, XContentType.JSON);</span><br><span class="line"></span><br><span class="line">        client.index(indexRequest, RequestOptions.DEFAULT);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">delete</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;         <span class="comment">// 删</span></span><br><span class="line"></span><br><span class="line">        <span class="type">DeleteRequest</span> <span class="variable">deleteRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DeleteRequest</span>(<span class="string">&quot;goodsindex&quot;</span>, <span class="string">&quot;_doc&quot;</span>, <span class="string">&quot;1&quot;</span>);</span><br><span class="line"></span><br><span class="line">        client.delete(deleteRequest, RequestOptions.DEFAULT);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">update</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;         <span class="comment">// 改</span></span><br><span class="line"></span><br><span class="line">        <span class="type">UpdateRequest</span> <span class="variable">updateRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UpdateRequest</span>(<span class="string">&quot;goodsindex&quot;</span>, <span class="string">&quot;_doc&quot;</span>, <span class="string">&quot;2&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 准备数据</span></span><br><span class="line">        <span class="type">Goods</span> <span class="variable">goods</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Goods</span>(<span class="string">&quot;2&quot;</span>,</span><br><span class="line">                <span class="string">&quot;zhongxing shouji&quot;</span>, <span class="string">&quot;zhongxing 4G youxi shouji&quot;</span>,</span><br><span class="line">                <span class="number">2899.0D</span>, <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;4G&quot;</span>, <span class="string">&quot;youxi&quot;</span>&#125;);</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">goodsJson</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>().writeValueAsString(goods);</span><br><span class="line"></span><br><span class="line">        updateRequest.doc(goodsJson, XContentType.JSON);</span><br><span class="line"></span><br><span class="line">        client.update(updateRequest, RequestOptions.DEFAULT);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">query</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;          <span class="comment">// 查</span></span><br><span class="line"></span><br><span class="line">        <span class="type">GetRequest</span> <span class="variable">getRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GetRequest</span>(<span class="string">&quot;goodsindex&quot;</span>, <span class="string">&quot;_doc&quot;</span>, <span class="string">&quot;2&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">GetResponse</span> <span class="variable">res</span> <span class="operator">=</span> client.get(getRequest, RequestOptions.DEFAULT);</span><br><span class="line"></span><br><span class="line">        System.out.println(res.getSourceAsString());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">searchRequest</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;      <span class="comment">// searchRequest查询</span></span><br><span class="line"></span><br><span class="line">        <span class="type">SearchRequest</span> <span class="variable">searchRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchRequest</span>(<span class="string">&quot;goodsindex&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">SearchSourceBuilder</span> <span class="variable">builder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchSourceBuilder</span>()</span><br><span class="line">                .query(QueryBuilders.queryStringQuery(<span class="string">&quot;title:meizu&quot;</span>));</span><br><span class="line"></span><br><span class="line">        searchRequest.source(builder);</span><br><span class="line"></span><br><span class="line">        <span class="type">SearchResponse</span> <span class="variable">res</span> <span class="operator">=</span> client.search(searchRequest, RequestOptions.DEFAULT);</span><br><span class="line"></span><br><span class="line">        print(res);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>



<h3 id="12-4-7-SQL搜索ElasticSearch"><a href="#12-4-7-SQL搜索ElasticSearch" class="headerlink" title="12.4.7 SQL搜索ElasticSearch"></a>12.4.7 SQL搜索ElasticSearch</h3><p>1）开启ES白金版功能</p>
<ul>
<li>1）</li>
</ul>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/ElasticSearch3/8.png"
                      style="zoom:50%;" 
                >

<ul>
<li>2）</li>
</ul>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/ElasticSearch3/40.png"
                      style="zoom:50%;" 
                >

<ul>
<li>3）：</li>
</ul>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/ElasticSearch3/41.png"
                      style="zoom:50%;" 
                >

<ul>
<li>4）：</li>
</ul>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/ElasticSearch3/42.png"
                      style="zoom:50%;" 
                >

<p>2）示例代码</p>
<ul>
<li>引入相关依赖：</li>
</ul>
<div class="highlight-container" data-rel="Xml"><figure class="iseeu highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--配置ES的SQL支持 maven仓库--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">repositories</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">repository</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>elastic.co<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url</span>&gt;</span>https://artifacts.elastic.co/maven<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">repository</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">repositories</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.elasticsearch.plugin<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>x-pack-sql-jdbc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>7.6.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure></div>

<ul>
<li>示例代码：</li>
</ul>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.dfbz.demo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.sql.Connection;</span><br><span class="line"><span class="keyword">import</span> java.sql.DriverManager;</span><br><span class="line"><span class="keyword">import</span> java.sql.ResultSet;</span><br><span class="line"><span class="keyword">import</span> java.sql.Statement;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Demo08_ES_JDBC</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test1</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 获取与ES服务器的连接</span></span><br><span class="line">        <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> DriverManager.getConnection(<span class="string">&quot;jdbc:es://http://localhost:9200&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建语句对象</span></span><br><span class="line">        <span class="type">Statement</span> <span class="variable">statement</span> <span class="operator">=</span> connection.createStatement();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 执行SQL,获取结果集</span></span><br><span class="line">        <span class="type">ResultSet</span> <span class="variable">rs</span> <span class="operator">=</span> statement.executeQuery(<span class="string">&quot;select * from goodsindex&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (rs.next()) &#123;</span><br><span class="line">            System.out.print(<span class="string">&quot;name: &quot;</span> + rs.getString(<span class="string">&quot;name&quot;</span>)+<span class="string">&quot;\t&quot;</span>);</span><br><span class="line">            System.out.print(<span class="string">&quot;title: &quot;</span> + rs.getString(<span class="string">&quot;title&quot;</span>)+<span class="string">&quot;\t&quot;</span>);</span><br><span class="line">            System.out.print(<span class="string">&quot;price: &quot;</span> + rs.getString(<span class="string">&quot;price&quot;</span>)+<span class="string">&quot;\t&quot;</span>);</span><br><span class="line">            System.out.print(<span class="string">&quot;category: &quot;</span> + rs.getString(<span class="string">&quot;category&quot;</span>)+<span class="string">&quot;\t&quot;</span>);</span><br><span class="line">            System.out.println();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        connection.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h1 id="十三、Spring-Data-ElasticSearch"><a href="#十三、Spring-Data-ElasticSearch" class="headerlink" title="十三、Spring Data ElasticSearch"></a>十三、Spring Data ElasticSearch</h1><p>Spring Data ElasticSearch是SpringData大家族的一员，Spring Data 的使命是给各种数据访问提供统一的编程接口，不管是关系型数据库（如MySQL），还是非关系数据库（如Redis），或者类似Elasticsearch这样的索引数据库。从而简化开发人员的代码，提高开发效率。</p>
<blockquote>
<p>SpringData官网：Spring Data<a class="link"   target="_blank" rel="noopener" href="https://spring.io/projects/spring-data" >https://spring.io/projects/spring-data <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<p>SpringDataElasticSearch官网：<a class="link"   target="_blank" rel="noopener" href="https://docs.spring.io/spring-data/elasticsearch/docs/4.0.3.RELEASE/reference/html/#preface" >https://docs.spring.io/spring-data/elasticsearch/docs/4.0.3.RELEASE/reference/html/#preface <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
</blockquote>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/ElasticSearch3/9.png"
                     
                ></p>
<h2 id="13-1-Template-查询"><a href="#13-1-Template-查询" class="headerlink" title="13.1 Template 查询"></a>13.1 Template 查询</h2><p>SpringData家族为大部分产品都提供了查询模板类，例如JdbcTemplate、RedisTemplate、RabbitTempalte等简化我们的操作；同样，SpringDataElasticSearch提供了ElasticsearchRestTemplate类来简化Java操作ES的代码；</p>
<ul>
<li>示例代码：</li>
</ul>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.dfbz.demo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.dfbz.Application;</span><br><span class="line"><span class="keyword">import</span> com.dfbz.entity.Goods;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.index.query.QueryBuilders;</span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"><span class="keyword">import</span> org.junit.runner.RunWith;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.elasticsearch.core.ElasticsearchRestTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.elasticsearch.core.SearchHit;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.elasticsearch.core.SearchHits;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.elasticsearch.core.document.Document;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.elasticsearch.core.mapping.IndexCoordinates;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.elasticsearch.core.query.NativeSearchQuery;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.elasticsearch.core.query.NativeSearchQueryBuilder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.elasticsearch.core.query.UpdateQuery;</span><br><span class="line"><span class="keyword">import</span> org.springframework.test.context.junit4.SpringRunner;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootTest(classes = Application.class)</span></span><br><span class="line"><span class="meta">@RunWith(SpringRunner.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Demo01</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ElasticsearchRestTemplate restTemplate;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">insert</span><span class="params">()</span> &#123;           <span class="comment">// insert</span></span><br><span class="line">        <span class="type">Goods</span> <span class="variable">goods</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Goods</span>(</span><br><span class="line">                <span class="string">&quot;1&quot;</span>,</span><br><span class="line">                <span class="string">&quot;huawei shouji&quot;</span>,</span><br><span class="line">                <span class="string">&quot;huawei 5G youxi shouji&quot;</span>,</span><br><span class="line">                <span class="number">1889.0D</span>,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;youxi&quot;</span>, <span class="string">&quot;5G&quot;</span>&#125;</span><br><span class="line">        );</span><br><span class="line">        restTemplate.save(goods, IndexCoordinates.of(<span class="string">&quot;goodsindex&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">update</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">Document</span> <span class="variable">goodsDoc</span> <span class="operator">=</span> Document.create();</span><br><span class="line">        goodsDoc.append(<span class="string">&quot;id&quot;</span>, <span class="string">&quot;1&quot;</span>);</span><br><span class="line">        goodsDoc.append(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;meizu shouji&quot;</span>);</span><br><span class="line">        goodsDoc.append(<span class="string">&quot;title&quot;</span>, <span class="string">&quot;meizu 4G paizhao shouji&quot;</span>);</span><br><span class="line">        goodsDoc.append(<span class="string">&quot;double&quot;</span>, <span class="number">1889.0D</span>);</span><br><span class="line">        goodsDoc.append(<span class="string">&quot;category&quot;</span>, <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;paizhao&quot;</span>, <span class="string">&quot;4G&quot;</span>&#125;);</span><br><span class="line"></span><br><span class="line">        <span class="type">UpdateQuery</span> <span class="variable">updateQuery</span> <span class="operator">=</span> UpdateQuery.builder(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">                .withDocument(goodsDoc)</span><br><span class="line">                .build();</span><br><span class="line"></span><br><span class="line">        restTemplate.update(updateQuery, IndexCoordinates.of(<span class="string">&quot;goodsindex&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">delete</span><span class="params">()</span> &#123;           <span class="comment">// delete</span></span><br><span class="line">        restTemplate.delete(<span class="string">&quot;2&quot;</span>, IndexCoordinates.of(<span class="string">&quot;goodsindex&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">query</span><span class="params">()</span> &#123;           <span class="comment">// query</span></span><br><span class="line">        <span class="type">Goods</span> <span class="variable">goods</span> <span class="operator">=</span> restTemplate.get(<span class="string">&quot;1&quot;</span>, Goods.class, IndexCoordinates.of(<span class="string">&quot;goodsindex&quot;</span>));</span><br><span class="line">        System.out.println(goods);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">queryForNative</span><span class="params">()</span> &#123;          <span class="comment">// 使用本地查询</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 使用本地搜索查询(原生ES的API查询)</span></span><br><span class="line">        <span class="type">NativeSearchQuery</span> <span class="variable">query</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NativeSearchQueryBuilder</span>()</span><br><span class="line">                .withQuery(QueryBuilders.matchAllQuery())</span><br><span class="line">                .build();</span><br><span class="line"></span><br><span class="line">        SearchHits&lt;Goods&gt; goodsSearchHits = restTemplate.search(query, Goods.class, IndexCoordinates.of(<span class="string">&quot;goodsindex&quot;</span>));</span><br><span class="line">        <span class="keyword">for</span> (SearchHit&lt;Goods&gt; goodsHit : goodsSearchHits) &#123;</span><br><span class="line">            <span class="type">Goods</span> <span class="variable">goods</span> <span class="operator">=</span> goodsHit.getContent();</span><br><span class="line">            System.out.println(goods);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></div>

<h2 id="13-2-Repositories-查询"><a href="#13-2-Repositories-查询" class="headerlink" title="13.2 Repositories 查询"></a>13.2 Repositories 查询</h2><ul>
<li>实体类（建立映射关系）：</li>
</ul>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.dfbz.entity;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.NoArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.annotation.Id;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.elasticsearch.annotations.Document;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.elasticsearch.annotations.Field;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.elasticsearch.annotations.FieldType;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@Document(indexName = &quot;goodsindex&quot;, type = &quot;_doc&quot;)</span>          <span class="comment">// ES7.0后不支持type功能(一个索引只能有一个type,名为_doc)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Goods</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="keyword">private</span> String id;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Field(index = true, store = false, fielddata = false, type = FieldType.Text, analyzer = &quot;standard&quot;, searchAnalyzer = &quot;standard&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Field</span></span><br><span class="line">    <span class="keyword">private</span> String title;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Field</span></span><br><span class="line">    <span class="keyword">private</span> Double price;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Field</span></span><br><span class="line">    <span class="keyword">private</span> String[] category;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<ul>
<li>Dao接口：</li>
</ul>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.dfbz.dao;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.dfbz.entity.Goods;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.elasticsearch.repository.ElasticsearchRepository;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">GoodsDao</span> <span class="keyword">extends</span> <span class="title class_">ElasticsearchRepository</span>&lt;Goods,String&gt; &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="13-2-1-普通增删改查"><a href="#13-2-1-普通增删改查" class="headerlink" title="13.2.1 普通增删改查"></a>13.2.1 普通增删改查</h3><ul>
<li>查询示例：</li>
</ul>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.dfbz.demo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.dfbz.Application;</span><br><span class="line"><span class="keyword">import</span> com.dfbz.dao.GoodsDao;</span><br><span class="line"><span class="keyword">import</span> com.dfbz.entity.Goods;</span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"><span class="keyword">import</span> org.junit.runner.RunWith;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.domain.PageRequest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.test.context.junit4.SpringRunner;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootTest(classes = Application.class)</span></span><br><span class="line"><span class="meta">@RunWith(SpringRunner.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Demo01_CRUD</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> GoodsDao goodsDao;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">findAll</span><span class="params">()</span> &#123;           <span class="comment">// query</span></span><br><span class="line"><span class="comment">//        Iterable&lt;Goods&gt; goodsList = goodsDao.findAll();</span></span><br><span class="line">        <span class="comment">// 带分页查询</span></span><br><span class="line">        Iterable&lt;Goods&gt; goodsList = goodsDao.findAll(PageRequest.of(<span class="number">2</span>,<span class="number">1</span>));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (Goods goods : goodsList) &#123;</span><br><span class="line">            System.out.println(goods);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">findById</span><span class="params">()</span> &#123;           <span class="comment">// query</span></span><br><span class="line">        <span class="type">Goods</span> <span class="variable">goods</span> <span class="operator">=</span> goodsDao.findById(<span class="string">&quot;1&quot;</span>).get();</span><br><span class="line"></span><br><span class="line">        System.out.println(goods);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">insert</span><span class="params">()</span> &#123;           <span class="comment">// insert</span></span><br><span class="line">        <span class="type">Goods</span> <span class="variable">goods</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Goods</span>(</span><br><span class="line">                <span class="string">&quot;1&quot;</span>,</span><br><span class="line">                <span class="string">&quot;vivo shouji&quot;</span>,</span><br><span class="line">                <span class="string">&quot;vivo 5G paizhao shouji&quot;</span>,</span><br><span class="line">                <span class="number">3889.0D</span>,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;paizhao&quot;</span>, <span class="string">&quot;5G&quot;</span>&#125;</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="type">Goods</span> <span class="variable">goods2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Goods</span>(</span><br><span class="line">                <span class="string">&quot;2&quot;</span>,</span><br><span class="line">                <span class="string">&quot;meizu shouji&quot;</span>,</span><br><span class="line">                <span class="string">&quot;meizu 4G youxi shouji&quot;</span>,</span><br><span class="line">                <span class="number">3889.0D</span>,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;youxi&quot;</span>, <span class="string">&quot;5G&quot;</span>&#125;</span><br><span class="line">        );</span><br><span class="line"><span class="comment">//        goodsDao.save(goods);</span></span><br><span class="line">        goodsDao.saveAll(Arrays.asList(goods,goods2));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">update</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Goods</span> <span class="variable">goods</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Goods</span>(</span><br><span class="line">                <span class="string">&quot;8&quot;</span>,</span><br><span class="line">                <span class="string">&quot;oppo shouji&quot;</span>,</span><br><span class="line">                <span class="string">&quot;oppo 5G paizhao shouji&quot;</span>,</span><br><span class="line">                <span class="number">2889.0D</span>,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;paizhao&quot;</span>, <span class="string">&quot;5G&quot;</span>&#125;</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        goodsDao.save(goods);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">delete</span><span class="params">()</span> &#123;           <span class="comment">// delete</span></span><br><span class="line">        goodsDao.deleteById(<span class="string">&quot;8&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="13-2-2-自定义方法命名查询"><a href="#13-2-2-自定义方法命名查询" class="headerlink" title="13.2.2 自定义方法命名查询"></a>13.2.2 自定义方法命名查询</h3><ul>
<li>dao接口：</li>
</ul>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.dfbz.dao;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.dfbz.entity.Goods;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.elasticsearch.annotations.Highlight;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.elasticsearch.annotations.HighlightField;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.elasticsearch.annotations.HighlightParameters;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.elasticsearch.annotations.Query;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.elasticsearch.core.SearchHit;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.elasticsearch.repository.ElasticsearchRepository;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">GoodsDao</span> <span class="keyword">extends</span> <span class="title class_">ElasticsearchRepository</span>&lt;Goods, String&gt; &#123;</span><br><span class="line"></span><br><span class="line">    List&lt;Goods&gt; <span class="title function_">findByTitle</span><span class="params">(String title)</span>;</span><br><span class="line"></span><br><span class="line">    List&lt;Goods&gt; <span class="title function_">findByPriceBetween</span><span class="params">(Double start, Double end)</span>;</span><br><span class="line"></span><br><span class="line">    List&lt;Goods&gt; <span class="title function_">findByTitleLike</span><span class="params">(String title)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 使用原生的ES查询语句查询</span></span><br><span class="line">    <span class="meta">@Query(&quot;&#123;\n&quot; +</span></span><br><span class="line"><span class="meta">            &quot;\t\t\&quot;bool\&quot;: &#123;\n&quot; +</span></span><br><span class="line"><span class="meta">            &quot;\t\t\t\&quot;must\&quot;: [&#123;\n&quot; +</span></span><br><span class="line"><span class="meta">            &quot;\t\t\t\t\&quot;query_string\&quot;: &#123;\n&quot; +</span></span><br><span class="line"><span class="meta">            &quot;\t\t\t\t\t\&quot;query\&quot;: \&quot;?0\&quot;,\n&quot; +</span></span><br><span class="line"><span class="meta">            &quot;\t\t\t\t\t\&quot;fields\&quot;: [\&quot;title\&quot;]\n&quot; +</span></span><br><span class="line"><span class="meta">            &quot;\t\t\t\t&#125;\n&quot; +</span></span><br><span class="line"><span class="meta">            &quot;\t\t\t&#125;]\n&quot; +</span></span><br><span class="line"><span class="meta">            &quot;\t\t&#125;\n&quot; +</span></span><br><span class="line"><span class="meta">            &quot;\t&#125;&quot;)</span></span><br><span class="line">    List&lt;Goods&gt; <span class="title function_">searchByQueryString</span><span class="params">(String title)</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 高亮查询</span></span><br><span class="line">    <span class="meta">@Highlight(</span></span><br><span class="line"><span class="meta">            fields = &#123;</span></span><br><span class="line"><span class="meta">                    @HighlightField(</span></span><br><span class="line"><span class="meta">                            name = &quot;name&quot;,</span></span><br><span class="line"><span class="meta">                            parameters = @HighlightParameters(preTags = &quot;&lt;font color=&#x27;red&#x27;&gt;&quot;,postTags = &quot;&lt;/font&gt;&quot;)</span></span><br><span class="line"><span class="meta">                    ),</span></span><br><span class="line"><span class="meta">                    @HighlightField(</span></span><br><span class="line"><span class="meta">                            name = &quot;title&quot;,</span></span><br><span class="line"><span class="meta">                            parameters = @HighlightParameters(preTags = &quot;&lt;font color=&#x27;red&#x27;&gt;&quot;,postTags = &quot;&lt;/font&gt;&quot;)</span></span><br><span class="line"><span class="meta">                    )</span></span><br><span class="line"><span class="meta">            &#125;</span></span><br><span class="line"><span class="meta">    )</span></span><br><span class="line">    List&lt;SearchHit&lt;Goods&gt;&gt; <span class="title function_">findByTitleOrName</span><span class="params">(String title, String name)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/ElasticSearch3/43.png"
                     
                > </p>
<blockquote>
<p>官网对照表：<a class="link"   target="_blank" rel="noopener" href="https://docs.spring.io/spring-data/elasticsearch/docs/4.1.13/reference/html/#elasticsearch.query-methods.criterions" >https://docs.spring.io/spring-data/elasticsearch/docs/4.1.13/reference/html/#elasticsearch.query-methods.criterions <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
</blockquote>
<ul>
<li>示例代码：</li>
</ul>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.dfbz.demo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.dfbz.Application;</span><br><span class="line"><span class="keyword">import</span> com.dfbz.dao.GoodsDao;</span><br><span class="line"><span class="keyword">import</span> com.dfbz.entity.Goods;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.index.query.MatchAllQueryBuilder;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.index.query.MatchQueryBuilder;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.index.query.QueryBuilders;</span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"><span class="keyword">import</span> org.junit.runner.RunWith;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.elasticsearch.core.SearchHit;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.elasticsearch.core.query.NativeSearchQuery;</span><br><span class="line"><span class="keyword">import</span> org.springframework.test.context.junit4.SpringRunner;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootTest(classes = Application.class)</span></span><br><span class="line"><span class="meta">@RunWith(SpringRunner.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Demo02_NamedQuery</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> GoodsDao goodsDao;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">findByTitle</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">        List&lt;Goods&gt; goodsList = goodsDao.findByTitle(<span class="string">&quot;shouji&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (Goods goods : goodsList) &#123;</span><br><span class="line">            System.out.println(goods);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">findByPriceBetween</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">        List&lt;Goods&gt; goodsList = goodsDao.findByPriceBetween(<span class="number">2000.0D</span>, <span class="number">4000.0D</span>);</span><br><span class="line">        <span class="keyword">for</span> (Goods goods : goodsList) &#123;</span><br><span class="line">            System.out.println(goods);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">findByTitleLike</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">        List&lt;Goods&gt; goodsList = goodsDao.findByTitleLike(<span class="string">&quot;sh&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (Goods goods : goodsList) &#123;</span><br><span class="line">            System.out.println(goods);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">searchQuery</span><span class="params">()</span> &#123;         <span class="comment">// searchQuery查询</span></span><br><span class="line">        <span class="type">MatchQueryBuilder</span> <span class="variable">searchQuery</span> <span class="operator">=</span> QueryBuilders.matchQuery(<span class="string">&quot;title&quot;</span>, <span class="string">&quot;meizu 5G&quot;</span>);</span><br><span class="line"></span><br><span class="line">        Iterable&lt;Goods&gt; goodsList = goodsDao.search(searchQuery);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (Goods goods : goodsList) &#123;</span><br><span class="line">            System.out.println(goods);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">anno</span><span class="params">()</span> &#123;         <span class="comment">// 通过query注解查询</span></span><br><span class="line">        List&lt;Goods&gt; goodsList = goodsDao.searchByQueryString(<span class="string">&quot;meizu&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (Goods goods : goodsList) &#123;</span><br><span class="line">            System.out.println(goods);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">highQuery</span><span class="params">()</span> &#123;         <span class="comment">// 高亮查询</span></span><br><span class="line">        List&lt;SearchHit&lt;Goods&gt;&gt; goodsList = goodsDao.findByTitleOrName(<span class="string">&quot;shouji&quot;</span>, <span class="string">&quot;shouji&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (SearchHit&lt;Goods&gt; goodsHit : goodsList) &#123;</span><br><span class="line">            <span class="comment">// 获取高亮字段的值</span></span><br><span class="line">            Map&lt;String, List&lt;String&gt;&gt; highlightFields = goodsHit.getHighlightFields();</span><br><span class="line">            System.out.println(highlightFields);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>








        </div>

        
            <div class="post-copyright-info w-full my-8 px-2 sm:px-6 md:px-8">
                <div class="article-copyright-info-container">
    <ul>
        <li><strong>Title:</strong> Elasticsearch</li>
        <li><strong>Author:</strong> MinGe</li>
        <li><strong>Created at
                :</strong> 2023-10-03 20:25:00</li>
        
            <li>
                <strong>Updated at
                    :</strong> 2024-11-12 16:45:19
            </li>
        
        <li>
            <strong>Link:</strong> https://redefine.ohevan.com/2023/10/03/Elasticsearch/
        </li>
        <li>
            <strong>
                License:
            </strong>
            

            
                This work is licensed under <a class="license" target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0">CC BY-NC-SA 4.0</a>.
            
        </li>
    </ul>
</div>

            </div>
        

        
            <ul class="post-tags-box text-lg mt-1.5 flex-wrap justify-center flex md:hidden">
                
                    <li class="tag-item mx-0.5">
                        <a href="/tags/java/">#java</a>&nbsp;
                    </li>
                
            </ul>
        

        

        
            <div class="article-nav my-8 flex justify-between items-center px-2 sm:px-6 md:px-8">
                
                    <div class="article-prev border-border-color shadow-redefine-flat shadow-shadow-color-2 rounded-medium px-4 py-2 hover:shadow-redefine-flat-hover hover:shadow-shadow-color-2">
                        <a class="prev"
                        rel="prev"
                        href="/2023/12/31/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"
                        >
                            <span class="left arrow-icon flex justify-center items-center">
                                <i class="fa-solid fa-chevron-left"></i>
                            </span>
                            <span class="title flex justify-center items-center">
                                <span class="post-nav-title-item">设计模式</span>
                                <span class="post-nav-item">Prev posts</span>
                            </span>
                        </a>
                    </div>
                
                
                    <div class="article-next border-border-color shadow-redefine-flat shadow-shadow-color-2 rounded-medium px-4 py-2 hover:shadow-redefine-flat-hover hover:shadow-shadow-color-2">
                        <a class="next"
                        rel="next"
                        href="/2023/09/17/Mongodb/"
                        >
                            <span class="title flex justify-center items-center">
                                <span class="post-nav-title-item">Mongodb</span>
                                <span class="post-nav-item">Next posts</span>
                            </span>
                            <span class="right arrow-icon flex justify-center items-center">
                                <i class="fa-solid fa-chevron-right"></i>
                            </span>
                        </a>
                    </div>
                
            </div>
        


        
    </div>

    
        <div class="toc-content-container">
            <div class="post-toc-wrap">
    <div class="post-toc">
        <div class="toc-title">On this page</div>
        <div class="page-title">Elasticsearch</div>
        <ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B8%80%E3%80%81ElasticSearch-%E7%AE%80%E4%BB%8B"><span class="nav-text">一、ElasticSearch 简介 </span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-1-%E4%BB%80%E4%B9%88%E6%98%AF-ElasticSearch"><span class="nav-text">1.1. 什么是 ElasticSearch</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-2-ElasticSearch-%E7%89%B9%E7%82%B9"><span class="nav-text">1.2. ElasticSearch 特点</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-3-ElasticSearch-%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84"><span class="nav-text">1.3. ElasticSearch 体系结构</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-4-ElasticSearch-%E4%B8%8E-Solr-%E5%AF%B9%E6%AF%94"><span class="nav-text">1.4 ElasticSearch 与 Solr 对比</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BA%8C%E3%80%81%E9%83%A8%E7%BD%B2ElasticSearch"><span class="nav-text">二、部署ElasticSearch</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#2-1-%E9%83%A8%E7%BD%B2ES"><span class="nav-text">2.1 部署ES</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-2-%E9%83%A8%E7%BD%B2Kibana"><span class="nav-text">2.2 部署Kibana</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-3-%E9%83%A8%E7%BD%B2head%E6%8F%92%E4%BB%B6"><span class="nav-text">2.3 部署head插件</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B8%89%E3%80%81ElasticSearch%E5%9F%BA%E6%9C%AC%E8%AF%AD%E6%B3%95"><span class="nav-text">三、ElasticSearch基本语法</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#3-1-CURL%E8%AF%AD%E6%B3%95"><span class="nav-text">3.1 CURL语法</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-1-%E4%BD%BF%E7%94%A8curl%E8%AE%BF%E9%97%AEES%EF%BC%9A"><span class="nav-text">3.1.1 使用curl访问ES：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-2-%E6%9F%A5%E7%9C%8B%E9%9B%86%E7%BE%A4%E7%9A%84%E5%81%A5%E5%BA%B7%E7%8A%B6%E6%80%81%EF%BC%9A"><span class="nav-text">3.1.2 查看集群的健康状态：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-3-%E6%9F%A5%E7%9C%8B%E9%9B%86%E7%BE%A4%E8%8A%82%E7%82%B9%E5%88%97%E8%A1%A8%EF%BC%9A"><span class="nav-text">3.1.3 查看集群节点列表：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-4-%E6%9F%A5%E7%9C%8B%E6%89%80%E6%9C%89%E7%9A%84%E7%B4%A2%E5%BC%95%EF%BC%9A"><span class="nav-text">3.1.4 查看所有的索引：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-5-%E5%88%9B%E5%BB%BA%E7%B4%A2%E5%BC%95%EF%BC%9A"><span class="nav-text">3.1.5 创建索引：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-6-%E6%B7%BB%E5%8A%A0%E6%96%87%E6%A1%A3%EF%BC%9A"><span class="nav-text">3.1.6 添加文档：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-7-%E6%9F%A5%E8%AF%A2%E6%96%87%E6%A1%A3%EF%BC%9A"><span class="nav-text">3.1.7 查询文档：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-8-%E4%BF%AE%E6%94%B9%E6%96%87%E6%A1%A3%EF%BC%9A"><span class="nav-text">3.1.8 修改文档：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-9-%E5%88%A0%E9%99%A4%E6%96%87%E6%A1%A3%EF%BC%9A"><span class="nav-text">3.1.9 删除文档：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-10-%E5%88%A0%E9%99%A4%E7%B4%A2%E5%BC%95%EF%BC%9A"><span class="nav-text">3.1.10 删除索引：</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-2-%E4%BD%BF%E7%94%A8Kibana%E5%AE%8C%E6%88%90%E5%A2%9E%E5%88%A0%E6%94%B9%E6%9F%A5"><span class="nav-text">3.2 使用Kibana完成增删改查</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%9B%9B%E3%80%81ElasticSearch-%E6%9F%A5%E8%AF%A2API"><span class="nav-text">四、ElasticSearch 查询API</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#4-1-string-search"><span class="nav-text">4.1 string search</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-2-query-DSL"><span class="nav-text">4.2 query DSL</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-3-query-filter"><span class="nav-text">4.3 query filter</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-4-phrase-search"><span class="nav-text">4.4 phrase search</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-5-term-query"><span class="nav-text">4.5 term query</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-6-query-string"><span class="nav-text">4.6 query string</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-7-highlight-search"><span class="nav-text">4.7 highlight search</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-8-%E8%81%9A%E5%90%88%E6%90%9C%E7%B4%A2"><span class="nav-text">4.8 聚合搜索</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-9-%E6%90%9C%E7%B4%A2API"><span class="nav-text">4.9 搜索API</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BA%94%E3%80%81Mapping-%E6%98%A0%E5%B0%84"><span class="nav-text">五、Mapping 映射</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#5-1-Mapping-%E7%AE%80%E4%BB%8B"><span class="nav-text">5.1 Mapping 简介</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#5-1-1-%E5%8A%A8%E6%80%81%E6%98%A0%E5%B0%84"><span class="nav-text">5.1.1 动态映射</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-2-%E6%89%8B%E5%8A%A8%E5%BB%BA%E7%AB%8BMapping%E6%98%A0%E5%B0%84"><span class="nav-text">5.2 手动建立Mapping映射</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#5-2-1-%E6%9F%A5%E7%9C%8B%E7%B4%A2%E5%BC%95%E7%9A%84mapping%E6%98%A0%E5%B0%84"><span class="nav-text">5.2.1 查看索引的mapping映射</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-2-2-%E6%89%8B%E5%8A%A8%E5%BB%BA%E7%AB%8Bmapping%E6%98%A0%E5%B0%84"><span class="nav-text">5.2.2 手动建立mapping映射</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-2-3-Text%E5%AD%97%E6%AE%B5%E6%8E%92%E5%BA%8F%E9%97%AE%E9%A2%98"><span class="nav-text">5.2.3 Text字段排序问题</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-3-type%E5%BA%95%E5%B1%82%E7%BB%93%E6%9E%84"><span class="nav-text">5.3 type底层结构</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#5-3-1-%E7%B4%A2%E5%BC%95%E5%BA%95%E5%B1%82%E5%A6%82%E4%BD%95%E5%AD%98%E5%82%A8type"><span class="nav-text">5.3.1 索引底层如何存储type</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-3-2-%E6%96%B0%E7%89%88%E6%9C%AC%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8type"><span class="nav-text">5.3.2 新版本如何使用type</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-3-%E5%88%AB%E5%90%8D%E9%85%8D%E7%BD%AE"><span class="nav-text">5.3 别名配置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-4-%E5%A4%9A%E5%88%AB%E5%90%8D%E9%85%8D%E7%BD%AE"><span class="nav-text">5.4 多别名配置</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BA%94%E3%80%81%E5%88%86%E6%9E%90%E5%99%A8"><span class="nav-text">五、分析器</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#5-1-%E5%88%86%E6%9E%90%E5%99%A8%E6%A6%82%E5%BF%B5"><span class="nav-text">5.1 分析器概念</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#5-1-1-%E5%88%86%E6%9E%90%E5%99%A8%E7%AE%80%E4%BB%8B"><span class="nav-text">5.1.1 分析器简介</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-1-2-%E5%88%86%E6%9E%90%E5%99%A8%E5%8E%9F%E7%90%86%E5%9B%BE"><span class="nav-text">5.1.2 分析器原理图</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-1-ES%E5%86%85%E7%BD%AE%E5%88%86%E6%9E%90%E5%99%A8"><span class="nav-text">5.1 ES内置分析器</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#5-1-1-standard-%E5%88%86%E6%9E%90%E5%99%A8"><span class="nav-text">5.1.1 standard 分析器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-1-2-simple-%E5%88%86%E6%9E%90%E5%99%A8"><span class="nav-text">5.1.2 simple 分析器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-1-3-whitespace-%E5%88%86%E6%9E%90%E5%99%A8"><span class="nav-text">5.1.3 whitespace 分析器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-1-4-%E5%88%86%E6%9E%90%E5%99%A8%E4%BD%BF%E7%94%A8"><span class="nav-text">5.1.4 分析器使用</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-2-%E5%88%86%E6%9E%90%E5%99%A8%E7%9A%84%E7%BB%84%E6%88%90"><span class="nav-text">5.2 分析器的组成</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#5-2-1-char-filter%EF%BC%88%E5%AD%97%E7%AC%A6%E8%BF%87%E6%BB%A4%E5%99%A8%EF%BC%89"><span class="nav-text">5.2.1 char_filter（字符过滤器）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-2-2-tokenizer%EF%BC%88%E5%88%86%E8%AF%8D%E5%99%A8%EF%BC%89"><span class="nav-text">5.2.2 tokenizer（分词器）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-2-3-token-filters%EF%BC%88token%E8%BF%87%E6%BB%A4%E5%99%A8%EF%BC%89"><span class="nav-text">5.2.3 token filters（token过滤器）</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-3-%E8%87%AA%E5%AE%9A%E4%B9%89%E5%88%86%E6%9E%90%E5%99%A8"><span class="nav-text">5.3 自定义分析器</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-4-IK-%E5%88%86%E6%9E%90%E5%99%A8"><span class="nav-text">5.4 IK 分析器</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#5-4-1-%E9%85%8D%E7%BD%AEIK%E5%88%86%E6%9E%90%E5%99%A8"><span class="nav-text">5.4.1 配置IK分析器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-4-2-IK-%E5%88%86%E6%9E%90%E5%99%A8%E6%B5%8B%E8%AF%95"><span class="nav-text">5.4.2 IK 分析器测试</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-4-3-%E8%87%AA%E5%AE%9A%E4%B9%89%E8%AF%8D%E5%BA%93"><span class="nav-text">5.4.3 自定义词库</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-4-4-%E5%81%9C%E7%94%A8%E8%AF%8D"><span class="nav-text">5.4.4 停用词</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-4-5-ik-smart-%E5%92%8C-ik-max-word"><span class="nav-text">5.4.5 ik_smart 和 ik_max_word</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-5-Nginx%E5%AE%9E%E7%8E%B0%E8%AF%8D%E5%BA%93%E7%83%AD%E6%9B%B4%E6%96%B0"><span class="nav-text">5.5 Nginx实现词库热更新</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%85%AD%E3%80%81ElasticSearch-%E7%AE%A1%E7%90%86"><span class="nav-text">六、ElasticSearch 管理</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#6-1-ES-%E6%95%B0%E6%8D%AE%E5%88%A0%E9%99%A4"><span class="nav-text">6.1 ES 数据删除</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-2-ES-%E5%85%A8%E9%87%8F%E6%9B%BF%E6%8D%A2"><span class="nav-text">6.2 ES 全量替换</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-3-partial-update"><span class="nav-text">6.3 partial update</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-4-%E5%BC%BA%E5%88%B6%E5%88%9B%E5%BB%BA"><span class="nav-text">6.4 强制创建</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B8%83%E3%80%81ElasticSearch-%E9%AB%98%E7%BA%A7%E5%BA%94%E7%94%A8"><span class="nav-text">七、ElasticSearch 高级应用</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#7-1-bulk%E6%89%B9%E9%87%8F%E6%93%8D%E4%BD%9C"><span class="nav-text">7.1 bulk批量操作</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-2-DSL%E8%AF%AD%E6%B3%95"><span class="nav-text">7.2 DSL语法</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%85%AB%E3%80%81ElasticSearch%E4%BC%98%E5%8A%BF"><span class="nav-text">八、ElasticSearch优势</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#8-1-%E6%A6%82%E5%BF%B5"><span class="nav-text">8.1 概念</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#8-2-ES-%E9%9B%86%E7%BE%A4%E5%81%A5%E5%BA%B7%E5%80%BC"><span class="nav-text">8.2 ES 集群健康值</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B9%9D%E3%80%81ElasticSearch-%E6%9E%B6%E6%9E%84"><span class="nav-text">九、ElasticSearch 架构</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#9-1-ES%E5%86%85%E9%83%A8%E6%9E%B6%E6%9E%84"><span class="nav-text">9.1 ES内部架构</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#9-1-1-%E5%88%86%E7%89%87%E6%9C%BA%E5%88%B6"><span class="nav-text">9.1.1 分片机制</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-1-2-%E9%9B%86%E7%BE%A4%E5%8F%91%E7%8E%B0%E6%9C%BA%E5%88%B6"><span class="nav-text">9.1.2 集群发现机制</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-1-3-shard-%E5%89%AF%E6%9C%AC"><span class="nav-text">9.1.3 shard 副本</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-1-4-shard-%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="nav-text">9.1.4 shard 负载均衡</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-1-5-%E6%96%B0%E5%A2%9E%E8%8A%82%E7%82%B9%E6%95%B0%E6%8D%AE%E5%9D%87%E5%88%86"><span class="nav-text">9.1.5 新增节点数据均分</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-1-6-%E8%8A%82%E7%82%B9%E5%AF%B9%E7%AD%89"><span class="nav-text">9.1.6 节点对等</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#9-2-ES%E7%9A%84%E5%9E%82%E7%9B%B4%E4%B8%8E%E6%B0%B4%E5%B9%B3%E6%89%A9%E5%AE%B9"><span class="nav-text">9.2 ES的垂直与水平扩容</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#9-2-1-%E5%9E%82%E7%9B%B4%E6%89%A9%E5%AE%B9%EF%BC%88%E7%BA%B5%E5%90%91%E6%89%A9%E5%AE%B9%EF%BC%89"><span class="nav-text">9.2.1 垂直扩容（纵向扩容）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-2-2-%E6%B0%B4%E5%B9%B3%E6%89%A9%E5%AE%B9%EF%BC%88%E6%A8%AA%E5%90%91%E6%89%A9%E5%AE%B9%EF%BC%89"><span class="nav-text">9.2.2 水平扩容（横向扩容）</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#9-3-ES%E7%9A%84%E6%B0%B4%E5%B9%B3%E6%89%A9%E5%AE%B9"><span class="nav-text">9.3 ES的水平扩容</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#9-3-1-ES%E5%A6%82%E4%BD%95%E8%B6%85%E5%87%BA%E6%89%A9%E5%AE%B9%E6%9E%81%E9%99%90"><span class="nav-text">9.3.1 ES如何超出扩容极限</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-3-2-%E8%AE%A1%E7%AE%97ES%E9%9B%86%E7%BE%A4%E5%AE%B9%E9%94%99%E6%9C%BA%E5%99%A8%E6%95%B0"><span class="nav-text">9.3.2 计算ES集群容错机器数</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#9-4-ES%E9%9B%86%E7%BE%A4%E7%9A%84%E5%AE%B9%E9%94%99%E6%9C%BA%E5%88%B6"><span class="nav-text">9.4 ES集群的容错机制</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#9-4-1-Master%E9%80%89%E4%B8%BE"><span class="nav-text">9.4.1 Master选举</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-4-2-Replica-%E5%AE%B9%E9%94%99"><span class="nav-text">9.4.2 Replica 容错</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-4-3-ES%E9%9B%86%E7%BE%A4%E6%95%B0%E6%8D%AE%E6%81%A2%E5%A4%8D"><span class="nav-text">9.4.3 ES集群数据恢复</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BA%94%E3%80%81ElasitcSearch-%E5%B9%B6%E5%8F%91%E6%8E%A7%E5%88%B6"><span class="nav-text">五、ElasitcSearch 并发控制</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#5-1-%E6%82%B2%E8%A7%82%E9%94%81%E6%8E%A7%E5%88%B6"><span class="nav-text">5.1 悲观锁控制</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-2-%E4%B9%90%E8%A7%82%E9%94%81%E6%8E%A7%E5%88%B6"><span class="nav-text">5.2 乐观锁控制</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#5-2-1-%E4%B9%90%E8%A7%82%E9%94%81%E7%9A%84%E5%AE%9E%E7%8E%B0"><span class="nav-text">5.2.1 乐观锁的实现</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-3-partial-update-%E5%B9%B6%E5%8F%91%E9%97%AE%E9%A2%98"><span class="nav-text">5.3 partial update 并发问题</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#5-3-1-partial-update-%E6%93%8D%E4%BD%9C%E5%8E%9F%E7%90%86%E5%9B%BE"><span class="nav-text">5.3.1 partial update 操作原理图</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-3-2-partial-update-%E5%B8%A6%E6%9D%A5%E7%9A%84%E5%B9%B6%E5%8F%91%E9%97%AE%E9%A2%98"><span class="nav-text">5.3.2 partial update 带来的并发问题</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-3-3-retry%E7%AD%96%E7%95%A5"><span class="nav-text">5.3.3 retry策略</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%8D%81%E3%80%81%E6%90%AD%E5%BB%BAES%E9%9B%86%E7%BE%A4"><span class="nav-text">十、搭建ES集群</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#10-1-%E5%87%86%E5%A4%87%E4%B8%89%E5%8F%B0elasticsearch%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="nav-text">10.1 准备三台elasticsearch服务器</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#10-2-%E4%BF%AE%E6%94%B9ES%E9%85%8D%E7%BD%AE"><span class="nav-text">10.2 修改ES配置</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#10-2-1-node01%E8%8A%82%E7%82%B9%EF%BC%9A"><span class="nav-text">10.2.1 node01节点：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#10-2-2-node02%E8%8A%82%E7%82%B9%EF%BC%9A"><span class="nav-text">10.2.2 node02节点：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#10-2-3-node03%E8%8A%82%E7%82%B9%EF%BC%9A"><span class="nav-text">10.2.3 node03节点：</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#10-3-%E5%90%AF%E5%8A%A8%E5%90%84%E4%B8%AA%E8%8A%82%E7%82%B9%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="nav-text">10.3 启动各个节点服务器</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#10-4-%E4%BD%BF%E7%94%A8head%E6%8F%92%E4%BB%B6%E6%9F%A5%E7%9C%8B"><span class="nav-text">10.4 使用head插件查看</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#10-5-%E6%93%8D%E4%BD%9CES%E9%9B%86%E7%BE%A4"><span class="nav-text">10.5 操作ES集群</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#10-5-1-%E5%88%9B%E5%BB%BAmapping%E6%98%A0%E5%B0%84"><span class="nav-text">10.5.1 创建mapping映射</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#10-5-2-%E6%9F%A5%E7%9C%8B%E5%88%86%E7%89%87%E4%BF%A1%E6%81%AF"><span class="nav-text">10.5.2 查看分片信息</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#10-5-3-%E8%AE%A1%E7%AE%97ES%E9%9B%86%E7%BE%A4%E5%AE%B9%E9%94%99%E6%9C%BA%E5%99%A8%E6%95%B0"><span class="nav-text">10.5.3 计算ES集群容错机器数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#10-5-4-%E6%93%8D%E4%BD%9C%E6%96%87%E6%A1%A3"><span class="nav-text">10.5.4 操作文档</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#10-5-5-ES%E7%9A%84%E9%9B%86%E7%BE%A4%E6%81%A2%E5%A4%8D"><span class="nav-text">10.5.5 ES的集群恢复</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#10-5-6-%E8%B7%AF%E7%94%B1%E7%AE%97%E6%B3%95"><span class="nav-text">10.5.6 路由算法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#10-5-7-%E4%B8%BA%E4%BB%80%E4%B9%88primary-shard%E4%B8%8D%E5%8F%AF%E5%8F%98%EF%BC%9F"><span class="nav-text">10.5.7 为什么primary shard不可变？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#10-5-8-%E5%8D%8F%E8%B0%83%E8%8A%82%E7%82%B9"><span class="nav-text">10.5.8 协调节点</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%8D%81%E4%B8%80%E3%80%81ES%E9%AB%98%E7%BA%A7%E6%90%9C%E7%B4%A2%E5%8A%9F%E8%83%BD"><span class="nav-text">十一、ES高级搜索功能</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#11-1-deep-paging"><span class="nav-text">11.1 deep paging</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#11-1-1-%E5%9B%9E%E9%A1%BEES%E5%88%86%E9%A1%B5%E6%90%9C%E7%B4%A2"><span class="nav-text">11.1.1 回顾ES分页搜索</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#11-1-2-deep-paging-%E9%97%AE%E9%A2%98"><span class="nav-text">11.1.2 deep paging 问题</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#11-1-scroll%E6%BB%9A%E5%8A%A8%E6%90%9C%E7%B4%A2"><span class="nav-text">11.1 scroll滚动搜索</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#11-2-%E6%A0%87%E5%87%86%E5%8C%96%E6%90%9C%E7%B4%A2"><span class="nav-text">11.2 标准化搜索</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#11-2-1-%E5%90%8C%E4%B9%89%E8%AF%8D%E6%90%9C%E7%B4%A2"><span class="nav-text">11.2.1 同义词搜索</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#11-3-2-%E6%A0%BC%E5%BC%8F%E8%BD%AC%E5%8C%96%E6%90%9C%E7%B4%A2"><span class="nav-text">11.3.2 格式转化搜索</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#11-3-ES%E6%8B%BC%E9%9F%B3%E6%90%9C%E7%B4%A2"><span class="nav-text">11.3 ES拼音搜索</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#11-3-1-pinyin%E5%88%86%E6%9E%90%E5%99%A8%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="nav-text">11.3.1 pinyin分析器的使用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#11-3-2-pinyin%E6%8F%92%E4%BB%B6%E5%AE%9E%E7%8E%B0%E5%88%86%E8%AF%8D%E6%90%9C%E7%B4%A2"><span class="nav-text">11.3.2 pinyin插件实现分词搜索</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#11-4-TF-IDF-%E8%AF%84%E5%88%86%E7%AE%97%E6%B3%95"><span class="nav-text">11.4 TF&#x2F;IDF 评分算法</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#11-4-1-%E7%AE%80%E4%BB%8B"><span class="nav-text">11.4.1 简介</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#11-4-2-Term-Frequency"><span class="nav-text">11.4.2 Term Frequency</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#11-4-4-%E8%AE%A1%E7%AE%97TF-IDF"><span class="nav-text">11.4.4 计算TF&#x2F;IDF</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#11-5-SQL%E6%94%AF%E6%8C%81"><span class="nav-text">11.5 SQL支持</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#11-5-1-%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8"><span class="nav-text">11.5.1 快速入门</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#11-5-2-SQL%E7%BF%BB%E8%AF%91"><span class="nav-text">11.5.2 SQL翻译</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#11-5-3-ES%E6%8F%90%E4%BE%9B%E7%9A%84SQL%E5%B7%A5%E5%85%B7"><span class="nav-text">11.5.3 ES提供的SQL工具</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#11-5-4-SQL%E4%B8%8E%E5%85%B6%E4%BB%96DSL%E7%BB%93%E5%90%88"><span class="nav-text">11.5.4 SQL与其他DSL结合</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%8D%81%E4%BA%8C%E3%80%81ElasticSearch-Java-API"><span class="nav-text">十二、ElasticSearch Java API</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#12-1-%E6%90%AD%E5%BB%BA%E7%8E%AF%E5%A2%83"><span class="nav-text">12.1 搭建环境</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#12-1-1-Maven%E4%BE%9D%E8%B5%96"><span class="nav-text">12.1.1 Maven依赖</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#12-1-2-%E5%AE%9E%E4%BD%93%E7%B1%BB"><span class="nav-text">12.1.2 实体类</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#12-2-%E7%B4%A2%E5%BC%95%E7%AE%A1%E7%90%86"><span class="nav-text">12.2 索引管理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#12-3-%E6%96%87%E6%A1%A3%E7%AE%A1%E7%90%86"><span class="nav-text">12.3 文档管理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#12-4-%E6%96%87%E6%A1%A3%E6%90%9C%E7%B4%A2"><span class="nav-text">12.4 文档搜索</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#12-4-1-%E5%87%86%E5%A4%87%E6%95%B0%E6%8D%AE"><span class="nav-text">12.4.1 准备数据</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#12-4-2-SearchRequest%E6%90%9C%E7%B4%A2"><span class="nav-text">12.4.2 SearchRequest搜索</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#12-4-3-TransportClient%E6%90%9C%E7%B4%A2"><span class="nav-text">12.4.3 TransportClient搜索</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#12-4-4-%E9%AB%98%E4%BA%AE%E6%90%9C%E7%B4%A2"><span class="nav-text">12.4.4 高亮搜索</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#12-4-5-%E8%81%9A%E5%90%88%E6%90%9C%E7%B4%A2"><span class="nav-text">12.4.5 聚合搜索</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#12-4-6-RestHighLevelClient%E6%90%9C%E7%B4%A2"><span class="nav-text">12.4.6 RestHighLevelClient搜索</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#12-4-7-SQL%E6%90%9C%E7%B4%A2ElasticSearch"><span class="nav-text">12.4.7 SQL搜索ElasticSearch</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%8D%81%E4%B8%89%E3%80%81Spring-Data-ElasticSearch"><span class="nav-text">十三、Spring Data ElasticSearch</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#13-1-Template-%E6%9F%A5%E8%AF%A2"><span class="nav-text">13.1 Template 查询</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#13-2-Repositories-%E6%9F%A5%E8%AF%A2"><span class="nav-text">13.2 Repositories 查询</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#13-2-1-%E6%99%AE%E9%80%9A%E5%A2%9E%E5%88%A0%E6%94%B9%E6%9F%A5"><span class="nav-text">13.2.1 普通增删改查</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#13-2-2-%E8%87%AA%E5%AE%9A%E4%B9%89%E6%96%B9%E6%B3%95%E5%91%BD%E5%90%8D%E6%9F%A5%E8%AF%A2"><span class="nav-text">13.2.2 自定义方法命名查询</span></a></li></ol></li></ol></li></ol>

    </div>
</div>
        </div>
    
</div>



                

            </div>

            

        </div>

        <div class="main-content-footer">
            <footer class="footer mt-5 py-5 h-auto text-base text-third-text-color relative border-t-2 border-t-border-color">
    <div class="info-container py-3 text-center">
        
        <div class="text-center">
            &copy;
            
              <span>2022</span>
              -
            
            2024&nbsp;&nbsp;<i class="fa-solid fa-heart fa-beat" style="--fa-animation-duration: 0.5s; color: #f54545"></i>&nbsp;&nbsp;<a href="/">MinGe</a>
            
                
                <p class="post-count space-x-0.5">
                    <span>
                        20 posts in total
                    </span>
                    
                </p>
            
        </div>
        
        <div class="relative text-center lg:absolute lg:left-[20px] lg:top-1/2 lg:-translate-y-1/2 lg:text-left">
            <span class="lg:block text-sm">POWERED BY <?xml version="1.0" encoding="utf-8"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"><svg class="relative top-[2px] inline-block align-baseline" version="1.1" id="圖層_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="1rem" height="1rem" viewBox="0 0 512 512" enable-background="new 0 0 512 512" xml:space="preserve"><path fill="#0E83CD" d="M256.4,25.8l-200,115.5L56,371.5l199.6,114.7l200-115.5l0.4-230.2L256.4,25.8z M349,354.6l-18.4,10.7l-18.6-11V275H200v79.6l-18.4,10.7l-18.6-11v-197l18.5-10.6l18.5,10.8V237h112v-79.6l18.5-10.6l18.5,10.8V354.6z"/></svg><a target="_blank" class="text-base" href="https://hexo.io">Hexo</a></span>
            <span class="text-sm lg:block">THEME&nbsp;<a class="text-base" target="_blank" href="https://github.com/EvanNotFound/hexo-theme-redefine">Redefine v2.7.1</a></span>
        </div>
        
        
            <div>
                Blog up for <span class="odometer" id="runtime_days" ></span> days <span class="odometer" id="runtime_hours"></span> hrs <span class="odometer" id="runtime_minutes"></span> Min <span class="odometer" id="runtime_seconds"></span> Sec
            </div>
        
        
            <script data-swup-reload-script>
                try {
                    function odometer_init() {
                    const elements = document.querySelectorAll('.odometer');
                    elements.forEach(el => {
                        new Odometer({
                            el,
                            format: '( ddd).dd',
                            duration: 200
                        });
                    });
                    }
                    odometer_init();
                } catch (error) {}
            </script>
        
        
        
    </div>  
</footer>
        </div>
    </div>

    
        <div class="post-tools">
            <div class="post-tools-container">
    <ul class="article-tools-list">
        <!-- TOC aside toggle -->
        
            <li class="right-bottom-tools page-aside-toggle">
                <i class="fa-regular fa-outdent"></i>
            </li>
        

        <!-- go comment -->
        
    </ul>
</div>

        </div>
    

    <div class="right-side-tools-container">
        <div class="side-tools-container">
    <ul class="hidden-tools-list">
        <li class="right-bottom-tools tool-font-adjust-plus flex justify-center items-center">
            <i class="fa-regular fa-magnifying-glass-plus"></i>
        </li>

        <li class="right-bottom-tools tool-font-adjust-minus flex justify-center items-center">
            <i class="fa-regular fa-magnifying-glass-minus"></i>
        </li>

        <li class="right-bottom-tools tool-dark-light-toggle flex justify-center items-center">
            <i class="fa-regular fa-moon"></i>
        </li>

        <!-- rss -->
        

        

        <li class="right-bottom-tools tool-scroll-to-bottom flex justify-center items-center">
            <i class="fa-regular fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="visible-tools-list">
        <li class="right-bottom-tools toggle-tools-list flex justify-center items-center">
            <i class="fa-regular fa-cog fa-spin"></i>
        </li>
        
            <li class="right-bottom-tools tool-scroll-to-top flex justify-center items-center">
                <i class="arrow-up fas fa-arrow-up"></i>
                <span class="percent"></span>
            </li>
        
        
    </ul>
</div>

    </div>

    <div class="image-viewer-container">
    <img src="">
</div>


    

</main>


    
<script src="/js/libs/Swup.min.js"></script>

<script src="/js/libs/SwupSlideTheme.min.js"></script>

<script src="/js/libs/SwupScriptsPlugin.min.js"></script>

<script src="/js/libs/SwupProgressPlugin.min.js"></script>

<script src="/js/libs/SwupScrollPlugin.min.js"></script>

<script src="/js/libs/SwupPreloadPlugin.min.js"></script>

<script>
    const swup = new Swup({
        plugins: [
            new SwupScriptsPlugin({
                optin: true,
            }),
            new SwupProgressPlugin(),
            new SwupScrollPlugin({
                offset: 80,
            }),
            new SwupSlideTheme({
                mainElement: ".main-content-body",
            }),
            new SwupPreloadPlugin(),
        ],
        containers: ["#swup"],
    });
</script>







<script src="/js/tools/imageViewer.js" type="module"></script>

<script src="/js/utils.js" type="module"></script>

<script src="/js/main.js" type="module"></script>

<script src="/js/layouts/navbarShrink.js" type="module"></script>

<script src="/js/tools/scrollTopBottom.js" type="module"></script>

<script src="/js/tools/lightDarkSwitch.js" type="module"></script>

<script src="/js/layouts/categoryList.js" type="module"></script>





    
<script src="/js/tools/codeBlock.js" type="module"></script>




    
<script src="/js/layouts/lazyload.js" type="module"></script>




    
<script src="/js/tools/runtime.js"></script>

    
<script src="/js/libs/odometer.min.js"></script>

    
<link rel="stylesheet" href="/assets/odometer-theme-minimal.css">




  
<script src="/js/libs/Typed.min.js"></script>

  
<script src="/js/plugins/typed.js" type="module"></script>








    
<script src="/js/libs/anime.min.js"></script>



<div class="post-scripts" data-swup-reload-script>
    
        
<script src="/js/tools/tocToggle.js" type="module"></script>

<script src="/js/layouts/toc.js" type="module"></script>

<script src="/js/plugins/tabs.js" type="module"></script>

    
</div>


</body>
</html>
