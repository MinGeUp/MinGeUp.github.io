<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="keywords" content="Hexo Theme Redefine">
    
    <meta name="author" content="MinGe">
    <!-- preconnect -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    
    <!--- Seo Part-->
    
    <link rel="canonical" href="http://example.com/2023/02/05/redis/"/>
    <meta name="robots" content="index,follow">
    <meta name="googlebot" content="index,follow">
    <meta name="revisit-after" content="1 days">
    
        <meta name="description" content="Redis是一个开源的，基于内存的且支持持久化，高性能的Key-Value的NoSQL数据库。 一、数据类型1.1 string1.2.1 string基本操作 string类型数据结构如下：    set：存数据  12SET key valueset name zhangsan   get：取数据  123GET keyget name   del：删除数据  123DEL key [key">
<meta property="og:type" content="article">
<meta property="og:title" content="Redis">
<meta property="og:url" content="http://example.com/2023/02/05/Redis/index.html">
<meta property="og:site_name" content="MinGe">
<meta property="og:description" content="Redis是一个开源的，基于内存的且支持持久化，高性能的Key-Value的NoSQL数据库。 一、数据类型1.1 string1.2.1 string基本操作 string类型数据结构如下：    set：存数据  12SET key valueset name zhangsan   get：取数据  123GET keyget name   del：删除数据  123DEL key [key">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://example.com/images/redis1/1.png">
<meta property="og:image" content="http://example.com/images/redis1/4.png">
<meta property="og:image" content="http://example.com/images/redis1/6.png">
<meta property="og:image" content="http://example.com/images/redis1/8.png">
<meta property="og:image" content="http://example.com/images/redis1/7.png">
<meta property="og:image" content="http://example.com/images/redis1/9.png">
<meta property="og:image" content="http://example.com/images/redis1/41.png">
<meta property="og:image" content="http://example.com/images/redis1/42.png">
<meta property="og:image" content="http://example.com/images/redis2/11.png">
<meta property="og:image" content="http://example.com/images/redis2/100.png">
<meta property="og:image" content="http://example.com/images/redis2/12.png">
<meta property="og:image" content="http://example.com/images/redis2/14.png">
<meta property="og:image" content="http://example.com/images/redis2/16.png">
<meta property="og:image" content="http://example.com/images/redis2/18.png">
<meta property="og:image" content="http://example.com/images/redis2/19.png">
<meta property="og:image" content="http://example.com/images/redis2/20.png">
<meta property="og:image" content="http://example.com/images/redis2/21.png">
<meta property="og:image" content="http://example.com/images/redis2/22.png">
<meta property="og:image" content="http://example.com/images/redis2/23.png">
<meta property="og:image" content="http://example.com/images/redis2/24.png">
<meta property="og:image" content="http://example.com/images/redis2/25.png">
<meta property="og:image" content="http://example.com/images/redis2/26.png">
<meta property="og:image" content="http://example.com/images/redis2/27.png">
<meta property="og:image" content="http://example.com/images/redis2/101.png">
<meta property="og:image" content="http://example.com/images/redis2/28.png">
<meta property="og:image" content="http://example.com/images/redis2/29.png">
<meta property="og:image" content="http://example.com/images/redis2/31.png">
<meta property="og:image" content="http://example.com/images/redis2/65.png">
<meta property="og:image" content="http://example.com/images/redis3/30.png">
<meta property="og:image" content="http://example.com/images/redis3/32.png">
<meta property="og:image" content="http://example.com/images/redis3/33.png">
<meta property="og:image" content="http://example.com/images/redis3/34.png">
<meta property="og:image" content="http://example.com/images/redis3/35.png">
<meta property="og:image" content="http://example.com/images/redis3/37.png">
<meta property="og:image" content="http://example.com/images/redis3/38.png">
<meta property="og:image" content="http://example.com/images/redis3/43.png">
<meta property="og:image" content="http://example.com/images/redis3/66.png">
<meta property="og:image" content="http://example.com/images/redis3/44.png">
<meta property="og:image" content="http://example.com/images/redis3/45.png">
<meta property="og:image" content="http://example.com/images/redis3/46.png">
<meta property="og:image" content="http://example.com/images/redis3/47.png">
<meta property="og:image" content="http://example.com/images/redis3/48.png">
<meta property="og:image" content="http://example.com/images/redis3/67.png">
<meta property="og:image" content="http://example.com/images/redis3/55.png">
<meta property="og:image" content="http://example.com/images/redis3/56.png">
<meta property="og:image" content="http://example.com/images/redis3/57.png">
<meta property="og:image" content="http://example.com/images/redis3/58.png">
<meta property="og:image" content="http://example.com/images/redis3/59.png">
<meta property="og:image" content="http://example.com/images/redis3/52.png">
<meta property="og:image" content="http://example.com/images/redis3/60.png">
<meta property="og:image" content="http://example.com/images/redis3/53.png">
<meta property="og:image" content="http://example.com/images/redis3/54.png">
<meta property="og:image" content="http://example.com/images/redis3/49.png">
<meta property="og:image" content="http://example.com/images/redis3/50.png">
<meta property="og:image" content="http://example.com/images/redis3/51.png">
<meta property="article:published_time" content="2023-02-05T08:44:00.000Z">
<meta property="article:modified_time" content="2024-11-26T03:12:14.509Z">
<meta property="article:author" content="John Doe">
<meta property="article:tag" content="java">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/images/redis1/1.png">
    
    
    <!--- Icon Part-->
    <link rel="icon" type="image/png" href="/images/redefine-favicon.svg" sizes="192x192">
    <link rel="apple-touch-icon" sizes="180x180" href="/images/redefine-favicon.svg">
    <meta name="theme-color" content="#A31F34">
    <link rel="shortcut icon" href="/images/redefine-favicon.svg">
    <!--- Page Info-->
    
    <title>
        
            Redis -
        
        MinGe 博客
    </title>

    
<link rel="stylesheet" href="/fonts/Chillax/chillax.css">


    <!--- Inject Part-->
    

    
<link rel="stylesheet" href="/css/style.css">


    
        
<link rel="stylesheet" href="/assets/build/styles.css">

    

    
<link rel="stylesheet" href="/fonts/GeistMono/geist-mono.css">

    
<link rel="stylesheet" href="/fonts/Geist/geist.css">

    <!--- Font Part-->
    
    
    
    
    
    

    <script id="hexo-configurations">
    window.config = {"hostname":"example.com","root":"/","language":"en"};
    window.theme = {"articles":{"style":{"font_size":"16px","line_height":1.5,"image_border_radius":"14px","image_alignment":"center","image_caption":false,"link_icon":true,"title_alignment":"left","headings_top_spacing":{"h1":"3.2rem","h2":"2.4rem","h3":"1.9rem","h4":"1.6rem","h5":"1.4rem","h6":"1.3rem"}},"word_count":{"enable":true,"count":true,"min2read":true},"author_label":{"enable":true,"auto":false,"list":[]},"code_block":{"copy":true,"style":"mac","highlight_theme":{"light":"github","dark":"vs2015"},"font":{"enable":false,"family":null,"url":null}},"toc":{"enable":true,"max_depth":1,"number":false,"expand":false,"init_open":true},"copyright":{"enable":true,"default":"cc_by_nc_sa"},"lazyload":true,"recommendation":{"enable":false,"title":"推荐阅读","limit":3,"mobile_limit":2,"placeholder":"/images/wallhaven-wqery6-light.webp","skip_dirs":[]}},"colors":{"primary":"#A31F34","secondary":null,"default_mode":"dark"},"global":{"fonts":{"chinese":{"enable":false,"family":null,"url":null},"english":{"enable":false,"family":null,"url":null},"title":{"enable":false,"family":null,"url":null}},"content_max_width":"1000px","sidebar_width":"210px","hover":{"shadow":true,"scale":false},"scroll_progress":{"bar":false,"percentage":true},"website_counter":{"url":"https://cn.vercount.one/js","enable":false,"site_pv":true,"site_uv":true,"post_pv":true},"single_page":true,"preloader":{"enable":false,"custom_message":null},"open_graph":true,"google_analytics":{"enable":false,"id":null}},"home_banner":{"enable":true,"style":"fixed","image":{"light":"/images/wallhaven-wqery6-light.webp","dark":"/images/wallhaven-wqery6-dark.webp"},"title":"MinGe 博客","subtitle":{"text":[],"hitokoto":{"enable":false,"show_author":false,"api":"https://v1.hitokoto.cn"},"typing_speed":100,"backing_speed":80,"starting_delay":500,"backing_delay":1500,"loop":true,"smart_backspace":true},"text_color":{"light":"#fff","dark":"#d1d1b6"},"text_style":{"title_size":"2.8rem","subtitle_size":"1.5rem","line_height":1.2},"custom_font":{"enable":false,"family":null,"url":null},"social_links":{"enable":false,"style":"default","links":{"github":null,"instagram":null,"zhihu":null,"twitter":null,"email":null},"qrs":{"weixin":null}}},"plugins":{"feed":{"enable":false},"aplayer":{"enable":false,"type":"fixed","audios":[{"name":null,"artist":null,"url":null,"cover":null,"lrc":null}]},"mermaid":{"enable":false,"version":"9.3.0"}},"version":"2.7.1","navbar":{"auto_hide":false,"color":{"left":"#f78736","right":"#367df7","transparency":35},"width":{"home":"1200px","pages":"1000px"},"links":{"Home":{"path":"/","icon":"fa-regular fa-house"},"resume":{"path":"/2024/11/02/简历/","icon":"fa-regular fa-folder"}},"search":{"enable":false,"preload":true}},"page_templates":{"friends_column":2,"tags_style":"blur"},"home":{"sidebar":{"enable":true,"position":"left","first_item":"menu","announcement":null,"show_on_mobile":true,"links":{"Archives":{"path":"/archives","icon":"fa-regular fa-archive"},"Tags":{"path":"/tags","icon":"fa-regular fa-tags"},"Categories":{"path":"/categories","icon":"fa-regular fa-folder"}}},"article_date_format":"auto","excerpt_length":200,"categories":{"enable":true,"limit":3},"tags":{"enable":true,"limit":3}},"footerStart":"2022/09/25 08:00:00"};
    window.lang_ago = {"second":"%s seconds ago","minute":"%s minutes ago","hour":"%s hours ago","day":"%s days ago","week":"%s weeks ago","month":"%s months ago","year":"%s years ago"};
    window.data = {"masonry":false};
  </script>
    
    <!--- Fontawesome Part-->
    
<link rel="stylesheet" href="/fontawesome/fontawesome.min.css">

    
<link rel="stylesheet" href="/fontawesome/brands.min.css">

    
<link rel="stylesheet" href="/fontawesome/solid.min.css">

    
<link rel="stylesheet" href="/fontawesome/regular.min.css">

    
    
    
    
<meta name="generator" content="Hexo 7.3.0"></head>


<body>
<div class="progress-bar-container">
    

    
        <span class="pjax-progress-bar"></span>
<!--        <span class="swup-progress-icon">-->
<!--            <i class="fa-solid fa-circle-notch fa-spin"></i>-->
<!--        </span>-->
    
</div>



<main class="page-container" id="swup">

    

    <div class="main-content-container">


        <div class="main-content-header">
            <header class="navbar-container px-6 md:px-12">

    <div class="navbar-content ">
        <div class="left">
            
            <a class="logo-title" href="/">
                
                MinGe 博客
                
            </a>
        </div>

        <div class="right">
            <!-- PC -->
            <div class="desktop">
                <ul class="navbar-list">
                    
                        
                            

                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class=""
                                   href="/"
                                        >
                                    <i class="fa-regular fa-house fa-fw"></i>
                                    HOME
                                    
                                </a>

                                <!-- Submenu -->
                                
                            </li>
                    
                        
                            

                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class=""
                                   href="/2024/11/02/%E7%AE%80%E5%8E%86/"
                                        >
                                    <i class="fa-regular fa-folder fa-fw"></i>
                                    RESUME
                                    
                                </a>

                                <!-- Submenu -->
                                
                            </li>
                    
                    
                </ul>
            </div>
            <!-- Mobile -->
            <div class="mobile">
                
                <div class="icon-item navbar-bar">
                    <div class="navbar-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile sheet -->
    <div class="navbar-drawer h-screen w-full absolute top-0 left-0 bg-background-color flex flex-col justify-between">
        <ul class="drawer-navbar-list flex flex-col px-4 justify-center items-start">
            
                
                    

                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full "
                           href="/"
                        >
                            <span>
                                HOME
                            </span>
                            
                                <i class="fa-regular fa-house fa-sm fa-fw"></i>
                            
                        </a>
                        

                        
                    </li>
            
                
                    

                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full "
                           href="/2024/11/02/%E7%AE%80%E5%8E%86/"
                        >
                            <span>
                                RESUME
                            </span>
                            
                                <i class="fa-regular fa-folder fa-sm fa-fw"></i>
                            
                        </a>
                        

                        
                    </li>
            

            
            
                
                    
                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full active"
                           href="/archives"
                        >
                            <span>Archives</span>
                            <i class="fa-regular fa-archive fa-sm fa-fw"></i>
                        </a>
                    </li>
                
                    
                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full active"
                           href="/tags"
                        >
                            <span>Tags</span>
                            <i class="fa-regular fa-tags fa-sm fa-fw"></i>
                        </a>
                    </li>
                
                    
                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full active"
                           href="/categories"
                        >
                            <span>Categories</span>
                            <i class="fa-regular fa-folder fa-sm fa-fw"></i>
                        </a>
                    </li>
                
            
        </ul>

        <div class="statistics flex justify-around my-2.5">
    <a class="item tag-count-item flex flex-col justify-center items-center w-20" href="/tags">
        <div class="number text-2xl sm:text-xl text-second-text-color font-semibold">3</div>
        <div class="label text-third-text-color text-sm">Tags</div>
    </a>
    <a class="item tag-count-item flex flex-col justify-center items-center w-20" href="/categories">
        <div class="number text-2xl sm:text-xl text-second-text-color font-semibold">2</div>
        <div class="label text-third-text-color text-sm">Categories</div>
    </a>
    <a class="item tag-count-item flex flex-col justify-center items-center w-20" href="/archives">
        <div class="number text-2xl sm:text-xl text-second-text-color font-semibold">20</div>
        <div class="label text-third-text-color text-sm">Posts</div>
    </a>
</div>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="main-content-body">

            

            <div class="main-content">

                
                    <div class="post-page-container flex relative justify-between box-border w-full h-full">
    <div class="article-content-container">

        <div class="article-title relative w-full">
            
                <div class="w-full flex items-center pt-6 justify-start">
                    <h1 class="article-title-regular text-second-text-color tracking-tight text-4xl md:text-6xl font-semibold px-2 sm:px-6 md:px-8 py-3">Redis</h1>
                </div>
            
            </div>

        
            <div class="article-header flex flex-row gap-2 items-center px-2 sm:px-6 md:px-8">
                <div class="avatar w-[46px] h-[46px] flex-shrink-0 rounded-medium border border-border-color p-[1px]">
                    <img src="/images/redefine-avatar.svg">
                </div>
                <div class="info flex flex-col justify-between">
                    <div class="author flex items-center">
                        <span class="name text-default-text-color text-lg font-semibold">MinGe</span>
                        
                            <span class="author-label ml-1.5 text-xs px-2 py-0.5 rounded-small text-third-text-color border border-shadow-color-1">Lv3</span>
                        
                    </div>
                    <div class="meta-info">
                        <div class="article-meta-info">
    <span class="article-date article-meta-item">
        <i class="fa-regular fa-pen-fancy"></i>&nbsp;
        <span class="desktop">2023-02-05 16:44</span>
        <span class="mobile">2023-02-05 16:44</span>
        <span class="hover-info">Created</span>
    </span>
    
        <span class="article-date article-meta-item">
            <i class="fa-regular fa-wrench"></i>&nbsp;
            <span class="desktop">2024-11-26 11:12:14</span>
            <span class="mobile">2024-11-26 11:12:14</span>
            <span class="hover-info">Updated</span>
        </span>
    

    
        <span class="article-categories article-meta-item">
            <i class="fa-regular fa-folders"></i>&nbsp;
            <ul>
                
                
                    
                        
                        <li>
                            <a href="/categories/%E6%8A%80%E6%9C%AF/">技术</a>&nbsp;
                        </li>
                    
                    
                
            </ul>
        </span>
    
    
        <span class="article-tags article-meta-item">
            <i class="fa-regular fa-tags"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/tags/java/">java</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    

    
    
    
    
</div>

                    </div>
                </div>
            </div>
        

        


        <div class="article-content markdown-body px-2 sm:px-6 md:px-8 pb-8">
            <p>Redis是一个开源的，基于内存的且支持持久化，高性能的Key-Value的<strong>NoSQL</strong>数据库。</p>
<h1 id="一、数据类型"><a href="#一、数据类型" class="headerlink" title="一、数据类型"></a>一、数据类型</h1><h2 id="1-1-string"><a href="#1-1-string" class="headerlink" title="1.1 string"></a>1.1 string</h2><h3 id="1-2-1-string基本操作"><a href="#1-2-1-string基本操作" class="headerlink" title="1.2.1 string基本操作"></a>1.2.1 string基本操作</h3><ul>
<li>string类型数据结构如下：</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/redis1/1.png"
                     
                ></p>
<ul>
<li>set：存数据</li>
</ul>
<div class="highlight-container" data-rel="Sql"><figure class="iseeu highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SET</span> key <span class="keyword">value</span></span><br><span class="line"><span class="keyword">set</span> name zhangsan</span><br></pre></td></tr></table></figure></div>

<ul>
<li>get：取数据</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">GET key</span><br><span class="line"></span><br><span class="line">get name</span><br></pre></td></tr></table></figure></div>

<ul>
<li>del：删除数据</li>
</ul>
<div class="highlight-container" data-rel="Sql"><figure class="iseeu highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">DEL key [key ...]</span><br><span class="line"></span><br><span class="line">del name</span><br></pre></td></tr></table></figure></div>

<ul>
<li>mset：一次性存储多个key</li>
</ul>
<div class="highlight-container" data-rel="Sql"><figure class="iseeu highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">MSET key <span class="keyword">value</span> [key <span class="keyword">value</span> ...]</span><br><span class="line"></span><br><span class="line">mset a zhangsan b lisi c wangwu</span><br></pre></td></tr></table></figure></div>

<ul>
<li>mget：一次性取多个key</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">MGET key [key ...]</span><br><span class="line"></span><br><span class="line">mget a b c</span><br></pre></td></tr></table></figure></div>

<ul>
<li>strlen：获取字符个数</li>
</ul>
<div class="highlight-container" data-rel="Sql"><figure class="iseeu highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">STRLEN key</span><br><span class="line">strlen a</span><br></pre></td></tr></table></figure></div>

<ul>
<li>append：追加字符串（如果没有则新增）</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">APPEND key value</span><br><span class="line">append a 88</span><br></pre></td></tr></table></figure></div>

<h3 id="1-2-2-string扩展操作"><a href="#1-2-2-string扩展操作" class="headerlink" title="1.2.2 string扩展操作"></a>1.2.2 string扩展操作</h3><ul>
<li>自增</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">incr key				# 自增1</span><br><span class="line"></span><br><span class="line">set num 10</span><br><span class="line">incr num</span><br><span class="line"></span><br><span class="line">incrby key increment	# 自增increment</span><br><span class="line"></span><br><span class="line">incrby key 20</span><br><span class="line"></span><br><span class="line">incrbyfloat key increment	# 自增小数</span><br><span class="line"></span><br><span class="line">set num2 0.5</span><br><span class="line">incrbyfloat key 0.5			# 只能对小数自增小数</span><br></pre></td></tr></table></figure></div>

<ul>
<li>自减</li>
</ul>
<div class="highlight-container" data-rel="Sql"><figure class="iseeu highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">decr key</span><br><span class="line">decr num</span><br><span class="line"></span><br><span class="line">decrby key incremnet</span><br><span class="line">decr num <span class="number">10</span></span><br></pre></td></tr></table></figure></div>



<h3 id="1-2-3-控制时效性"><a href="#1-2-3-控制时效性" class="headerlink" title="1.2.3 控制时效性"></a>1.2.3 控制时效性</h3><div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">setex key seconds value		# 秒</span><br><span class="line">setex name 5 zhangsan</span><br><span class="line"></span><br><span class="line">psetex key milliseconds value		# 毫秒</span><br><span class="line">psetex name 5000 zhangsan</span><br></pre></td></tr></table></figure></div>

<h3 id="1-2-4-string类型的注意事项"><a href="#1-2-4-string类型的注意事项" class="headerlink" title="1.2.4 string类型的注意事项"></a>1.2.4 string类型的注意事项</h3><ul>
<li>数据操作不成功的反馈与数据正常操作之间的差异<ul>
<li>1）： 表示运行结果是否成功<ul>
<li>(integer) 0 -&gt; false 失败</li>
<li>(integer) 1-&gt; true 成功</li>
</ul>
</li>
<li>2）：表示运行结果值<ul>
<li>(integer) 3 -&gt; 3 	3个</li>
<li>(integer) 1 -&gt; 1 	1个</li>
</ul>
</li>
</ul>
</li>
<li>数据未获取到<ul>
<li>(nil)等同于null</li>
</ul>
</li>
</ul>
<h2 id="1-2-hash"><a href="#1-2-hash" class="headerlink" title="1.2 hash"></a>1.2 hash</h2><ul>
<li>hash类型的存储结构如下：</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/redis1/4.png"
                     
                ></p>
<p>hash类型的数据结构，底层采用hash表存储。</p>
<h3 id="1-2-1-hash基本操作"><a href="#1-2-1-hash基本操作" class="headerlink" title="1.2.1 hash基本操作"></a>1.2.1 hash基本操作</h3><ul>
<li>hset：添加&#x2F;修改数据</li>
</ul>
<div class="highlight-container" data-rel="Sql"><figure class="iseeu highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">HSET key field <span class="keyword">value</span></span><br><span class="line"></span><br><span class="line">hset <span class="keyword">user</span> username zs</span><br><span class="line">hset <span class="keyword">user</span> password admin</span><br></pre></td></tr></table></figure></div>

<ul>
<li>hget：取数据</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">HGET key field</span><br><span class="line"></span><br><span class="line">hget user username</span><br></pre></td></tr></table></figure></div>

<ul>
<li>hdel：删除数据</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">HDEL key field [field ...]</span><br><span class="line"></span><br><span class="line">hdel user password</span><br></pre></td></tr></table></figure></div>

<ul>
<li>hmset：一次性添加&#x2F;修改多个字段</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">HMSET key field value [field value ...]</span><br><span class="line"></span><br><span class="line">hmset user username zs password admin age 20</span><br></pre></td></tr></table></figure></div>

<ul>
<li>hmget</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">HMGET key field [field ...]</span><br><span class="line"></span><br><span class="line">hmget user username password age</span><br></pre></td></tr></table></figure></div>

<ul>
<li>获取指定key的field的数量</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">HLEN key</span><br><span class="line"></span><br><span class="line">hlen user</span><br></pre></td></tr></table></figure></div>

<ul>
<li>hexists：判断指定的key中是否包含有指定的field（返回1[有]或0[没有]）</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">HEXISTS key field</span><br><span class="line"></span><br><span class="line">hexists user username</span><br><span class="line">hexists user aa</span><br></pre></td></tr></table></figure></div>

<ul>
<li>hgetall：获取指定key中所有的field以及value值</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">HGETALL key</span><br><span class="line"></span><br><span class="line">hgetall user</span><br></pre></td></tr></table></figure></div>



<h3 id="1-2-2-hash扩展操作"><a href="#1-2-2-hash扩展操作" class="headerlink" title="1.2.2 hash扩展操作"></a>1.2.2 hash扩展操作</h3><ul>
<li>hkeys：获取key中所有的field</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">HKEYS key</span><br><span class="line"></span><br><span class="line">hkeys key</span><br></pre></td></tr></table></figure></div>

<ul>
<li>hvals：获取key中所有的value</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">HVALS key</span><br><span class="line"></span><br><span class="line">hvals key</span><br></pre></td></tr></table></figure></div>

<ul>
<li>给指定key中的指定field增加指定范围的值</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">HINCRBY key field increment</span><br><span class="line">HINCRBYFLOAT key field increment</span><br><span class="line"></span><br><span class="line">hincrby user age 2</span><br><span class="line">hincrbyfloat user age 0.5</span><br></pre></td></tr></table></figure></div>

<ul>
<li>hsetnx：如果指定key中有对应的field则返回0（false），如果没有则存对应的值进去</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">HSETNX key field value</span><br><span class="line"></span><br><span class="line">hsetnx user flag 1</span><br></pre></td></tr></table></figure></div>



<h2 id="1-3-list"><a href="#1-3-list" class="headerlink" title="1.3 list"></a>1.3 list</h2><p>在Redis中，List类型是按照插入顺序排序的字符串链表。和数据结构中的普通链表一样，我们可以在其头部(left)和尾部(right)添加新的元素。在插入时，如果该键并不存在，Redis将为该键创建一个新的链表。与此相反，如果链表中所有的元素均被移除，那么该键也将会被从数据库中删除。Redis中的list类型采用的是双向链表。</p>
<p>redis存储结构如下：</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/redis1/6.png"
                     
                ></p>
<h3 id="1-3-1-list基本操作"><a href="#1-3-1-list基本操作" class="headerlink" title="1.3.1 list基本操作"></a>1.3.1 list基本操作</h3><ul>
<li>添加&#x2F;修改数据</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">LPUSH key value [value ...]		# 添加到队列左侧</span><br><span class="line">RPUSH key value [value ...]		# 添加到队列右侧</span><br><span class="line"></span><br><span class="line">lpush fruits apple pear</span><br><span class="line">rpush fruits banana tomato</span><br></pre></td></tr></table></figure></div>

<ul>
<li>获取数据</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">LRANGE key start stop		# 从左边开始读取数据,从start索引查询到stop索引</span><br><span class="line">lrange fruits 0 3			# 从0开始查询到3索引</span><br><span class="line">lrange fruits 0 -2			# 从0开始查询到-2索引</span><br><span class="line">lrange fruits 0 -1			# 从0开始查询到-1索引(倒数第二),通常用此命令来查询全部数据</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">LINDEX key index			# 根据指定的索引查询,从0开始</span><br><span class="line">lindex fruits 3</span><br></pre></td></tr></table></figure></div>

<ul>
<li>获取并移除数据</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">LPOP key		# 从队列左边移除一个元素并返回</span><br><span class="line">lpop fruits</span><br><span class="line"></span><br><span class="line">RPOP key		# 从队列右边移除一个元素并返回</span><br><span class="line">rpop fruits</span><br></pre></td></tr></table></figure></div>

<h3 id="1-3-2-list扩展操作"><a href="#1-3-2-list扩展操作" class="headerlink" title="1.3.2 list扩展操作"></a>1.3.2 list扩展操作</h3><ul>
<li>规定时间内获取并移除数据</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">BLPOP key [key ...] timeout		# 在timeout时间内取出key中的值</span><br><span class="line">BRPOP key [key ...] timeout</span><br><span class="line"></span><br><span class="line">blpop fruits 5				# 5秒内取出fruits中的值并删除,如果没取到则一直处于等待状态</span><br><span class="line"></span><br></pre></td></tr></table></figure></div>

<ul>
<li>规定时间内移除list左边的一个元素到另一个list的左边，并将此元素返回</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">BRPOPLPUSH source destination timeout</span><br><span class="line"></span><br><span class="line">brpoplpush fruits temp 5</span><br></pre></td></tr></table></figure></div>



<ul>
<li>移除指定数据</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">LREM key count value		# 从list左边开始移除元素</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">count:移除多少个  value:移除什么元素</span></span><br><span class="line"></span><br><span class="line">rpush data a b c d e a b c k o</span><br><span class="line">lrem data 2 a		# 移除两个a</span><br></pre></td></tr></table></figure></div>

<h2 id="1-4-set"><a href="#1-4-set" class="headerlink" title="1.4 set"></a>1.4 set</h2><p>在Redis中，我们可以将Set类型看作为没有排序的字符集合，和List类型一样，我们也可以在该类型的数据值上执行添加、删除或判断某一元素是否存在等操作。需要说明的是，这些操作的时间是常量时间。Set可包含的最大元素数是4294967295。</p>
<p>和List类型不同的是，Set集合中不允许出现重复的元素。和List类型相比，Set类 型在功能上还存在着一个非常重要的特性，即在服务器端完成多个Sets之间的聚合计  算操作，如unions、intersections和differences。由于这些操作均在服务端完成，  因此效率极高，而且也节省了大量的网络IO开销</p>
<h3 id="1-4-1-set基本操作"><a href="#1-4-1-set基本操作" class="headerlink" title="1.4.1 set基本操作"></a>1.4.1 set基本操作</h3><ul>
<li>添加数据</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SADD key member [member ...]</span><br><span class="line"></span><br><span class="line">sadd nums 1 2 3 4 5 6 7</span><br></pre></td></tr></table></figure></div>

<ul>
<li>读取全部数据</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SMEMBERS key</span><br><span class="line"></span><br><span class="line">smembers nums</span><br></pre></td></tr></table></figure></div>

<ul>
<li>删除数据</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SREM key member [member ...]</span><br><span class="line"></span><br><span class="line">srem nums 1 3 5 7</span><br></pre></td></tr></table></figure></div>

<ul>
<li>获取集合中元素的个数</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SCARD key</span><br><span class="line"></span><br><span class="line">scard nums</span><br></pre></td></tr></table></figure></div>

<ul>
<li>判断集合中是否包含指定的数据</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SISMEMBER key member</span><br><span class="line"></span><br><span class="line">sismember nums 1</span><br></pre></td></tr></table></figure></div>

<h3 id="1-4-2-set扩展操作"><a href="#1-4-2-set扩展操作" class="headerlink" title="1.4.2 set扩展操作"></a>1.4.2 set扩展操作</h3><ul>
<li>在指定的key中随机获取几个个值</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SRANDMEMBER key [count]</span><br><span class="line"></span><br><span class="line">srandmember nums 3</span><br></pre></td></tr></table></figure></div>

<ul>
<li>在指定的key中随机获取几个值，并将这几个值移除</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SPOP key [count]</span><br><span class="line"></span><br><span class="line">spop nums 3</span><br></pre></td></tr></table></figure></div>



<ul>
<li>获取两个集合的交、并、差集</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sinter key [key ...]			# 交集</span><br><span class="line">sunion key [key ...]			# 并集</span><br><span class="line">sdiff key [key ...]				# 差集</span><br></pre></td></tr></table></figure></div>

<p>案例：</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; sadd num1 1 2 3 4 5</span><br><span class="line">(integer) 5</span><br><span class="line">127.0.0.1:6379&gt; sadd num2 4 5 6 7 8</span><br><span class="line">(integer) 5</span><br><span class="line">127.0.0.1:6379&gt; sinter num1 num2</span><br><span class="line">1) &quot;4&quot;</span><br><span class="line">2) &quot;5&quot;</span><br><span class="line">127.0.0.1:6379&gt; sunion num1 num2</span><br><span class="line">1) &quot;1&quot;</span><br><span class="line">2) &quot;2&quot;</span><br><span class="line">3) &quot;3&quot;</span><br><span class="line">4) &quot;4&quot;</span><br><span class="line">5) &quot;5&quot;</span><br><span class="line">6) &quot;6&quot;</span><br><span class="line">7) &quot;7&quot;</span><br><span class="line">8) &quot;8&quot;</span><br><span class="line">127.0.0.1:6379&gt; sdiff num1 num2</span><br><span class="line">1) &quot;1&quot;</span><br><span class="line">2) &quot;2&quot;</span><br><span class="line">3) &quot;3&quot;</span><br></pre></td></tr></table></figure></div>

<ul>
<li>获取两个集合的交、并、差集存储到指定集合中</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sinterstore destination key1 [key2]		# 交集</span><br><span class="line">sunionstore destination key1 [key2]		# 并集</span><br><span class="line">sdiffstore destination key1 [key2]		# 差集</span><br></pre></td></tr></table></figure></div>



<p>sinterstore-案例：</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; sinterstore temp1 num1 num2</span><br><span class="line">(integer) 2</span><br><span class="line">127.0.0.1:6379&gt; smembers temp1</span><br><span class="line">1) &quot;4&quot;</span><br><span class="line">2) &quot;5&quot;</span><br></pre></td></tr></table></figure></div>

<p>sunionstore-案例：</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; sunionstore temp2 num1 num2</span><br><span class="line">(integer) 8</span><br><span class="line">127.0.0.1:6379&gt; smembers temp2</span><br><span class="line">1) &quot;1&quot;</span><br><span class="line">2) &quot;2&quot;</span><br><span class="line">3) &quot;3&quot;</span><br><span class="line">4) &quot;4&quot;</span><br><span class="line">5) &quot;5&quot;</span><br><span class="line">6) &quot;6&quot;</span><br><span class="line">7) &quot;7&quot;</span><br><span class="line">8) &quot;8&quot;</span><br></pre></td></tr></table></figure></div>

<p>sdiffstore-案例：</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; sdiffstore temp3 num1 num2</span><br><span class="line">(integer) 3</span><br><span class="line">127.0.0.1:6379&gt; smembers temp3</span><br><span class="line">1) &quot;1&quot;</span><br><span class="line">2) &quot;2&quot;</span><br><span class="line">3) &quot;3&quot;</span><br></pre></td></tr></table></figure></div>



<ul>
<li>移动集合中的指定元素到另一个集合</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">smove source destination member</span><br></pre></td></tr></table></figure></div>

<ul>
<li>source：源集合</li>
<li>destination：目标集合</li>
<li>member：移动的元素</li>
</ul>
<p>案例：</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; smembers num1</span><br><span class="line">1) &quot;1&quot;</span><br><span class="line">2) &quot;2&quot;</span><br><span class="line">3) &quot;3&quot;</span><br><span class="line">4) &quot;4&quot;</span><br><span class="line">5) &quot;5&quot;</span><br><span class="line">127.0.0.1:6379&gt; smembers num2</span><br><span class="line">1) &quot;4&quot;</span><br><span class="line">2) &quot;5&quot;</span><br><span class="line">3) &quot;6&quot;</span><br><span class="line">4) &quot;7&quot;</span><br><span class="line">5) &quot;8&quot;</span><br><span class="line">127.0.0.1:6379&gt; smove num1 num2 2</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; smembers num1</span><br><span class="line">1) &quot;1&quot;</span><br><span class="line">2) &quot;3&quot;</span><br><span class="line">3) &quot;4&quot;</span><br><span class="line">4) &quot;5&quot;</span><br><span class="line">127.0.0.1:6379&gt; smembers num2</span><br><span class="line">1) &quot;2&quot;</span><br><span class="line">2) &quot;4&quot;</span><br><span class="line">3) &quot;5&quot;</span><br><span class="line">4) &quot;6&quot;</span><br><span class="line">5) &quot;7&quot;</span><br><span class="line">6) &quot;8&quot;</span><br></pre></td></tr></table></figure></div>

<h2 id="1-5-sorted-set"><a href="#1-5-sorted-set" class="headerlink" title="1.5 sorted_set"></a>1.5 sorted_set</h2><p>Sorted-Sets和Sets类型极为相似，它们都是字符串的集合，都不允许重复的成员出现，在一个Set中。它们之间的主要差别是Sorted-Sets中的每一个成员都会有一个分数(score)与之关联，Redis正是通过分数来为集合中的成员进行从小到大的排序。然    而需要额外指出的是，尽管Sorted-Sets中的成员必须是唯一的，但是分数(score) 却是可以重复的。</p>
<p>在Sorted-Set中添加、删除或更新一个成员都是非常快速的操作，其时间复杂度为 集合中成员数量的对数。由于Sorted-Sets中的成员在集合中的位置是有序的，因此，    即便是访问位于集合中部的成员也仍然是非常高效的。事实上，Redis所具有的这一  特征在很多其它类型的数据库中是很难实现的，换句话说，在该点上要想达到和Redis    同样的高效，在其它数据库中进行建模是非常困难的。</p>
<h3 id="1-5-1-sorted-set基本操作"><a href="#1-5-1-sorted-set基本操作" class="headerlink" title="1.5.1 sorted_set基本操作"></a>1.5.1 sorted_set基本操作</h3><ul>
<li>添加数据</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zadd key score1 member1 [score2 member2]</span><br></pre></td></tr></table></figure></div>

<ul>
<li>实例：</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; zadd students 90 zs</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; zadd students 80 ls 85 ww 60 zl 70 tq</span><br><span class="line">(integer) 4</span><br></pre></td></tr></table></figure></div>



<ul>
<li>读取数据</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">zrange key start stop [WITHSCORES]</span><br><span class="line">zrevrange key start stop [WITHSCORES]		</span><br></pre></td></tr></table></figure></div>

<ul>
<li>withscores：是否显示分值</li>
<li>zrevrange：将查询结果反转</li>
</ul>
<p>示例：</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; zrange students 0 -1</span><br><span class="line">1) &quot;zl&quot;</span><br><span class="line">2) &quot;tq&quot;</span><br><span class="line">3) &quot;ls&quot;</span><br><span class="line">4) &quot;ww&quot;</span><br><span class="line">5) &quot;zs&quot;</span><br><span class="line">127.0.0.1:6379&gt; zrevrange students 0 -1 withscores</span><br><span class="line"> 1) &quot;zs&quot;</span><br><span class="line"> 2) &quot;90&quot;</span><br><span class="line"> 3) &quot;ww&quot;</span><br><span class="line"> 4) &quot;85&quot;</span><br><span class="line"> 5) &quot;ls&quot;</span><br><span class="line"> 6) &quot;80&quot;</span><br><span class="line"> 7) &quot;tq&quot;</span><br><span class="line"> 8) &quot;70&quot;</span><br><span class="line"> 9) &quot;zl&quot;</span><br><span class="line">10) &quot;60&quot;</span><br></pre></td></tr></table></figure></div>



<ul>
<li>删除数据</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zrem key member [member ...]</span><br></pre></td></tr></table></figure></div>

<ul>
<li>实例：</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; zrem students zs zl</span><br><span class="line">(integer) 2</span><br><span class="line">127.0.0.1:6379&gt; zrevrange students 0 -1 withscores</span><br><span class="line">1) &quot;ww&quot;</span><br><span class="line">2) &quot;85&quot;</span><br><span class="line">3) &quot;ls&quot;</span><br><span class="line">4) &quot;80&quot;</span><br><span class="line">5) &quot;tq&quot;</span><br><span class="line">6) &quot;70&quot;</span><br></pre></td></tr></table></figure></div>



<ul>
<li>根据分值筛选</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">zrangebyscore key min max [WITHSCORES] [LIMIT offset count]</span><br><span class="line">zrevrangebyscore key max min [WITHSCORES] [LIMIT offset count]</span><br></pre></td></tr></table></figure></div>

<ul>
<li>min：最小分值（包含）</li>
<li>max：最大分值（包含）</li>
<li>limit：限定查询结果（分页查询）<ul>
<li>offset：起始索引（从0开始）</li>
<li>count：查询几条数据</li>
</ul>
</li>
<li>zrevrangebyscore：根据分值反转查询</li>
</ul>
<p>示例：</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; zadd students 90 zs 80 ls 95 ww 60 zl 75 tq</span><br><span class="line">(integer) 5</span><br><span class="line">127.0.0.1:6379&gt; zrange students 0 -1 withscores</span><br><span class="line"> 1) &quot;zl&quot;</span><br><span class="line"> 2) &quot;60&quot;</span><br><span class="line"> 3) &quot;tq&quot;</span><br><span class="line"> 4) &quot;75&quot;</span><br><span class="line"> 5) &quot;ls&quot;</span><br><span class="line"> 6) &quot;80&quot;</span><br><span class="line"> 7) &quot;zs&quot;</span><br><span class="line"> 8) &quot;90&quot;</span><br><span class="line"> 9) &quot;ww&quot;</span><br><span class="line">10) &quot;95&quot;</span><br><span class="line">127.0.0.1:6379&gt; zrangebyscore students 60 95 withscores</span><br><span class="line"> 1) &quot;zl&quot;</span><br><span class="line"> 2) &quot;60&quot;</span><br><span class="line"> 3) &quot;tq&quot;</span><br><span class="line"> 4) &quot;75&quot;</span><br><span class="line"> 5) &quot;ls&quot;</span><br><span class="line"> 6) &quot;80&quot;</span><br><span class="line"> 7) &quot;zs&quot;</span><br><span class="line"> 8) &quot;90&quot;</span><br><span class="line"> 9) &quot;ww&quot;</span><br><span class="line">10) &quot;95&quot;</span><br></pre></td></tr></table></figure></div>



<ul>
<li>查询集合总数量</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">zcard key</span><br><span class="line"></span><br><span class="line">zcard students</span><br></pre></td></tr></table></figure></div>



<ul>
<li>根据分值范围查询集合总数量</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">zcount key min max</span><br><span class="line"></span><br><span class="line">zcount student 60 80</span><br></pre></td></tr></table></figure></div>



<h3 id="1-5-2-sorted-set扩展操作"><a href="#1-5-2-sorted-set扩展操作" class="headerlink" title="1.5.2 sorted_set扩展操作"></a>1.5.2 sorted_set扩展操作</h3><ul>
<li>取多个集合中的交集、并集</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">zinterstore destination numkeys key [key ...]</span><br><span class="line">zunionstore destination numkeys key [key ...]</span><br></pre></td></tr></table></figure></div>

<p>示例：</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; zadd num1 1 a 4 b 7 c</span><br><span class="line">(integer) 3</span><br><span class="line">127.0.0.1:6379&gt; zadd num2 2 a 5 b 8 c</span><br><span class="line">(integer) 3</span><br><span class="line">127.0.0.1:6379&gt; zadd num3 3 a 6 b 9 c</span><br><span class="line">(integer) 3</span><br><span class="line">127.0.0.1:6379&gt; zinterstore temp1 3 num1 num2 num3</span><br><span class="line">(integer) 3</span><br><span class="line">127.0.0.1:6379&gt; zrange temp1 0 -1 withscores</span><br><span class="line">1) &quot;a&quot;</span><br><span class="line">2) &quot;6&quot;</span><br><span class="line">3) &quot;b&quot;</span><br><span class="line">4) &quot;15&quot;</span><br><span class="line">5) &quot;c&quot;</span><br><span class="line">6) &quot;24&quot;</span><br></pre></td></tr></table></figure></div>

<p>zinterstore首先取并集，然后把分数累加。</p>
<h2 id="1-6-通用指令"><a href="#1-6-通用指令" class="headerlink" title="1.6 通用指令"></a>1.6 通用指令</h2><h3 id="1-6-1-key基本操作"><a href="#1-6-1-key基本操作" class="headerlink" title="1.6.1 key基本操作"></a>1.6.1 key基本操作</h3><ul>
<li>删除key</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">del key</span><br></pre></td></tr></table></figure></div>

<ul>
<li>判断key是否存在</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">exists key</span><br></pre></td></tr></table></figure></div>

<ul>
<li>获取key的类型</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">type key</span><br></pre></td></tr></table></figure></div>

<h3 id="1-6-2-控制key的时效性"><a href="#1-6-2-控制key的时效性" class="headerlink" title="1.6.2 控制key的时效性"></a>1.6.2 控制key的时效性</h3><ul>
<li>为指定key设置有效期</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">expire key seconds</span><br><span class="line">pexpire key milliseconds</span><br><span class="line">expireat key timestamp</span><br><span class="line">pexpireat key milliseconds-timestamp</span><br></pre></td></tr></table></figure></div>

<ul>
<li>获取key的有效时间</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ttl key			# 返回key的有效时间，单位秒</span><br><span class="line">pttl key		# 返回key的有效时间，单位毫秒</span><br></pre></td></tr></table></figure></div>

<p>如果key没有设置有效期(永久存在)，返回-1，如果key不存在返回-2，如果key存在返回key的有效时间</p>
<ul>
<li>切换key从时效性转换为永久性</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">persist key</span><br></pre></td></tr></table></figure></div>

<h3 id="1-6-3-key的查询操作"><a href="#1-6-3-key的查询操作" class="headerlink" title="1.6.3 key的查询操作"></a>1.6.3 key的查询操作</h3><ul>
<li>查询key</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">keys pattern </span><br></pre></td></tr></table></figure></div>

<p>查询匹配规则：</p>
<ul>
<li><code>*</code>：匹配任意数量的任意符号</li>
<li><code>?</code>：匹配任意一个符号</li>
<li><code>[]</code>匹配一个指定符号</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">keys * 查询所有</span><br><span class="line">keys java* 查询所有以java开头</span><br><span class="line">keys *java 查询所有以java结尾</span><br><span class="line">keys ??java 查询所有前面两个字符任意，后面以java结尾</span><br><span class="line">keys user:? 查询所有以user:开头，最后一个字符任意</span><br><span class="line">keys j[av]a:1 查询所有以j开头，以a:1结尾，中间包含一个字母，a或v</span><br></pre></td></tr></table></figure></div>

<h3 id="1-6-4-key的其他操作"><a href="#1-6-4-key的其他操作" class="headerlink" title="1.6.4 key的其他操作"></a>1.6.4 key的其他操作</h3><ul>
<li>key改名</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rename key newkey</span><br><span class="line">renamenx key newkey</span><br></pre></td></tr></table></figure></div>

<p>rename：如果改名的时候newkey已经存在了，则会把key中的值覆盖newkey中的值。</p>
<p>示例：</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; set temp1 111</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; set temp2 222</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; set temp3 333</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; rename temp1 temp4</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; keys *</span><br><span class="line">1) &quot;temp3&quot;</span><br><span class="line">2) &quot;temp4&quot;</span><br><span class="line">3) &quot;temp2&quot;</span><br><span class="line">127.0.0.1:6379&gt; get temp4</span><br><span class="line">&quot;111&quot;</span><br><span class="line">127.0.0.1:6379&gt; rename temp2 temp3</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; keys *</span><br><span class="line">1) &quot;temp3&quot;</span><br><span class="line">2) &quot;temp4&quot;</span><br><span class="line">127.0.0.1:6379&gt; get temp3</span><br><span class="line">&quot;222&quot;</span><br><span class="line">127.0.0.1:6379&gt;</span><br></pre></td></tr></table></figure></div>

<p>renamenx：如果newkey已经存在，则不允许修改名称</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; keys *</span><br><span class="line">1) &quot;temp3&quot;</span><br><span class="line">2) &quot;temp4&quot;</span><br><span class="line">127.0.0.1:6379&gt; get temp3</span><br><span class="line">&quot;222&quot;</span><br><span class="line">127.0.0.1:6379&gt; renamenx temp3 temp4</span><br><span class="line">(integer) 0</span><br></pre></td></tr></table></figure></div>





<ul>
<li>对所有key排序：只能对集合进行排序list、sort、sorted-set</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SORT key [BY pattern] [LIMIT offset count] [ASC|DESC] [ALPHA] [STORE destination]</span><br></pre></td></tr></table></figure></div>

<p>示例：</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; lpush list 22 33 11 44 88 77 55</span><br><span class="line">(integer) 7</span><br><span class="line">127.0.0.1:6379&gt; lrange list 0 -1</span><br><span class="line">1) &quot;55&quot;</span><br><span class="line">2) &quot;77&quot;</span><br><span class="line">3) &quot;88&quot;</span><br><span class="line">4) &quot;44&quot;</span><br><span class="line">5) &quot;11&quot;</span><br><span class="line">6) &quot;33&quot;</span><br><span class="line">7) &quot;22&quot;</span><br><span class="line">127.0.0.1:6379&gt; sort list</span><br><span class="line">1) &quot;11&quot;</span><br><span class="line">2) &quot;22&quot;</span><br><span class="line">3) &quot;33&quot;</span><br><span class="line">4) &quot;44&quot;</span><br><span class="line">5) &quot;55&quot;</span><br><span class="line">6) &quot;77&quot;</span><br><span class="line">7) &quot;88&quot;</span><br><span class="line">127.0.0.1:6379&gt; sort list desc</span><br><span class="line">1) &quot;88&quot;</span><br><span class="line">2) &quot;77&quot;</span><br><span class="line">3) &quot;55&quot;</span><br><span class="line">4) &quot;44&quot;</span><br><span class="line">5) &quot;33&quot;</span><br><span class="line">6) &quot;22&quot;</span><br><span class="line">7) &quot;11&quot;</span><br></pre></td></tr></table></figure></div>



<ul>
<li>关于key的其他操作在帮助文档中的@generic组中可以查询到</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">help @generic</span><br></pre></td></tr></table></figure></div>



<h3 id="1-6-5-数据库通用操作"><a href="#1-6-5-数据库通用操作" class="headerlink" title="1.6.5 数据库通用操作"></a>1.6.5 数据库通用操作</h3><p>在一个redis中会有16个数据库，分别为db0、db1、db2…..</p>
<ul>
<li>切换数据库</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">select num</span><br><span class="line"></span><br><span class="line">select 0 		# 切换到0数据库</span><br><span class="line">select 1		# 切换到1数据库</span><br></pre></td></tr></table></figure></div>

<ul>
<li>数据清除</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">dbsize			# 查看当前数据库共有多少个key</span><br><span class="line">flushdb			# 清除当前数据库的所有数据</span><br><span class="line">flushall		# 清除所有数据库的所有数据</span><br></pre></td></tr></table></figure></div>

<h1 id="二、Redis持久化"><a href="#二、Redis持久化" class="headerlink" title="二、Redis持久化"></a>二、Redis持久化</h1><p>由于 Redis 是一个内存数据库，所谓内存数据库，就是将数据库中的内容保存在内存中，这与传统的MySQL，Oracle等关系型数据库直接将内容保存到硬盘中相比，内存数据库的读写效率比传统数据库要快的多（内存的读写效率远远大于硬盘的读写效率）。但是保存在内存中也随之带来了一个缺点，一旦断电或者宕机，那么内存数据库中的数据将会全部丢失。</p>
<p>为了解决这个缺点，Redis提供了将内存数据持久化到硬盘，以及用持久化文件来恢复数据库数据的功能。Redis 支持两种形式的持久化，一种是RDB快照（snapshotting），另外一种是AOF（append-only-file）。</p>
<h2 id="2-1-RDB持久化"><a href="#2-1-RDB持久化" class="headerlink" title="2.1 RDB持久化"></a>2.1 RDB持久化</h2><p>RDB是Redis用来进行持久化的一种方式，是把当前内存中的<strong>数据集快照</strong>写入磁盘，也就是 Snapshot 快照（数据库中所有键值对数据）。恢复时是将快照文件直接读到内存里。</p>
<p>RDB 有两种触发方式，分别是自动触发和手动触发。</p>
<h3 id="2-1-1-手动持久化"><a href="#2-1-1-手动持久化" class="headerlink" title="2.1.1 手动持久化"></a>2.1.1 手动持久化</h3><p>在客户端操作时，只要执行了save命令，那么就会拍一次快照，将此次的数据全部存储到指定的文件中</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; save</span><br><span class="line">OK</span><br></pre></td></tr></table></figure></div>

<ul>
<li>相关配置（配置文件中配置）<ul>
<li><code>dbfilename</code>：设置本地数据库文件名，默认值为 dump.rdb</li>
<li><code>dir</code>：设置存储.rdb文件的路径</li>
<li><code>rdbcompression</code>：设置存储至本地数据库时是否压缩数据，默认为 yes，采用 LZF 压缩，通常默认为开启状态，如果设置为no，可以节省 CPU 运行时间，但会使存储的文件变大（巨大）</li>
<li><code>rdbchecksum</code>：默认值是yes。在存储快照后，我们还可以让redis使用CRC64算法来进行数据校验，但这样做会消耗大约10%的性能，如果希望获取到最大的性能提升，可以关闭此功能。</li>
</ul>
</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">bind 127.0.0.1</span><br><span class="line">port 6379</span><br><span class="line">logfile &quot;6379.log&quot;</span><br><span class="line">dir /root/redis-4.0.11/data</span><br><span class="line">dbfilename dump-6379.rdb</span><br><span class="line">rdbcompression no</span><br><span class="line">rdbchecksum no</span><br><span class="line">daemonize yes			# 后台启动</span><br></pre></td></tr></table></figure></div>



<h4 id="2-1-2-save方法工作原理"><a href="#2-1-2-save方法工作原理" class="headerlink" title="2.1.2 save方法工作原理"></a>2.1.2 save方法工作原理</h4><p>使用save命令：此命令会使用Redis的主线程进程同步存储，阻塞当前的Redis服务器，造成服务不可用，直到RDB过程完成。无论当前服务器数据量大小，线上不要用。</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/redis1/8.png"
                     
                ></p>
<h4 id="2-1-3-bgsave"><a href="#2-1-3-bgsave" class="headerlink" title="2.1.3 bgsave"></a>2.1.3 bgsave</h4><p>使用bgsave命令：此命令会通过<code>fork()</code>创建子进程，在后台进程存储。只有fork阶段会阻塞当前Redis服务器，不必到整个RDB过程结束，一般时间很短。因此Redis内部涉及到RDB都采用bgsave命令。</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; bgsave</span><br></pre></td></tr></table></figure></div>

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/redis1/7.png"
                     
                ></p>
<h3 id="2-1-2-自动持久化"><a href="#2-1-2-自动持久化" class="headerlink" title="2.1.2 自动持久化"></a>2.1.2 自动持久化</h3><p>一般我们是不会直接用命令生成RDB文件的，Redis支持自动触发RDB持久化机制，配置都在redis.conf文件里面。</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">save seconds count</span><br><span class="line">save 900 1</span><br><span class="line">save 300 10		</span><br><span class="line">save 60 10000</span><br></pre></td></tr></table></figure></div>

<ul>
<li>seconds：持久化的时间</li>
<li>count：持久化的频率</li>
</ul>
<p><code>save 900 1</code>：900秒持久化一次，但900秒内必须至少有1个key发生变化才会持久化。</p>
<p><code>save 300 10</code>：300秒持久化一次，但300秒内必须至少有10个key发生变化才会持久化。</p>
<p><code>save 60 10000</code>：60秒持久化一次，但60内必须至少有10000个key发送变化才会持久化。</p>
<blockquote>
<p><strong>tips：实际开发可能会有偏差，如<code>save 60 5</code>，可能60秒还未到设置了5个key就发生触发一次，或者60秒内设置了4个key就触发了一次。</strong></p>
</blockquote>
<p>自动持久化底层采用的是bgsave指令。</p>
<ul>
<li>小结：</li>
</ul>
<table>
<thead>
<tr>
<th>方式</th>
<th>save指令</th>
<th>bgsave指令</th>
</tr>
</thead>
<tbody><tr>
<td>读写</td>
<td>同步</td>
<td>异步</td>
</tr>
<tr>
<td>阻塞客户端指令</td>
<td>是</td>
<td>否</td>
</tr>
<tr>
<td>额外消耗内存</td>
<td>否</td>
<td>是</td>
</tr>
<tr>
<td>启动新进程</td>
<td>否</td>
<td>是</td>
</tr>
</tbody></table>
<h3 id="2-2-3-特殊情况下保存数据"><a href="#2-2-3-特殊情况下保存数据" class="headerlink" title="2.2.3 特殊情况下保存数据"></a>2.2.3 特殊情况下保存数据</h3><ul>
<li>服务器运行过程中重启</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">debug reload</span><br></pre></td></tr></table></figure></div>

<ul>
<li>关闭服务器时指定保存数据</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shutdown save</span><br></pre></td></tr></table></figure></div>

<h2 id="2-2-AOF持久化"><a href="#2-2-AOF持久化" class="headerlink" title="2.2 AOF持久化"></a>2.2 AOF持久化</h2><p>AOF(append only file)持久化：AOF持久化是通过保存Redis服务器所执行的写命令来记录数据库状态，也就是每当 Redis 执行一个改变数据集的命令时（比如 SET）， 这个命令就会被追加到 AOF 文件的末尾。</p>
<p>AOF的主要作用是解决了数据持久化的实时性，目前已经是Redis持久化的主流方式</p>
<h3 id="2-2-1-AOF持久化的三种策略"><a href="#2-2-1-AOF持久化的三种策略" class="headerlink" title="2.2.1 AOF持久化的三种策略"></a>2.2.1 AOF持久化的三种策略</h3><p>redis的AOF功能默认是关闭的，需要我们手动开启：</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">bind 127.0.0.1</span><br><span class="line">port 6379</span><br><span class="line">logfile &quot;6379.log&quot;</span><br><span class="line">dir /root/redis-4.0.11/data</span><br><span class="line">rdbcompression yes</span><br><span class="line">rdbchecksum yes</span><br><span class="line">daemonize no</span><br><span class="line">appendonly yes</span><br><span class="line">appendfsync everysec</span><br><span class="line">appendfilename appendonly-6379.aof</span><br></pre></td></tr></table></figure></div>



<ul>
<li><p>appendonly</p>
<ul>
<li>yes：开启aof功能</li>
<li>no：关闭aof功能（默认值）</li>
</ul>
</li>
<li><p>appendfsync</p>
<ul>
<li>always（每次）：每次写入操作均同步到AOF文件中，高并发下性能较低。</li>
<li>everysec（每秒）：每秒将&#x3D;&#x3D;<strong>缓冲区</strong>&#x3D;&#x3D;中的指令同步到AOF文件中，默认配置（如果是丢失，那么最多是这一秒）</li>
<li>no（系统控制）：由操作系统控制每次同步到AOF文件的周期，一般为30s每次。</li>
</ul>
</li>
<li><p>appendfilename：aof文件名称</p>
</li>
<li><p>dir：aof文件路径</p>
</li>
</ul>
<p><strong>注意：AOF只会保存服务器所执行的写（set，del，add 等）的命令，对于其他对结果集并没有造成影响的命令是不会写入aof文件的。如（get、hget、lrang等）</strong></p>
<h3 id="2-2-2-AOF重写"><a href="#2-2-2-AOF重写" class="headerlink" title="2.2.2 AOF重写"></a>2.2.2 AOF重写</h3><p>AOF 持久化是通过保存被执行的写命令来记录数据库状态的，所以AOF文件的大小随着时间的流逝一定会越来越大，其中就包含了很多不必要的命令，如set某个key两次，其结果肯定为最后一次，那么前面一次的命令就没有必要再记录下来。</p>
<p>为了解决此问题，<strong>Redis引入了AOF重写机制用于压缩aof文件大小，并且可以提高数据恢复的效率。</strong></p>
<h4 id="2-2-2-1-AOF重写原理"><a href="#2-2-2-1-AOF重写原理" class="headerlink" title="2.2.2.1 AOF重写原理"></a>2.2.2.1 AOF重写原理</h4><p>当执行AOF重写时，这个函数会进行大量的写入操作，所以调用这个函数的线程将被长时间的阻塞，因为<strong>Redis服务器使用单线程来处理命令请求</strong>，那么重写AOF期间，服务器将无法处理客户端发送来的命令请求；因此redis底层采用子进程的方式来将数据同步到aof文件当中。</p>
<p><font color='blue'><strong>思考：子进程在进行AOF重写期间，服务器进程还要继续处理命令请求，而新的命令可能对现有的数据进行修改，这会让当前数据库的数据和重写后的AOF文件中的数据不一致吗？</strong></font></p>
<p><strong>答：不会；</strong></p>
<p>解决方案：</p>
<ul>
<li>当子进程正在同步时，主进程接收到的所有命令将会暂时存放在重写缓冲区中，来保证子进程在工作时，主进程接收到的指令不能被保存到aof文件。</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/redis1/9.png"
                     
                ></p>
<p>重写条件：</p>
<ul>
<li><p>进程内已超时的数据不再写入文件</p>
</li>
<li><p>忽略无效指令，重写时使用进程内数据直接生成，这样新的AOF文件只保留最终数据的写入命令，如：</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">set age 20</span><br><span class="line">set age 30</span><br><span class="line">set age 40</span><br><span class="line"></span><br><span class="line">最终合并为:</span><br><span class="line">set age 40</span><br></pre></td></tr></table></figure></div>


</li>
<li><p>对同一数据的多条写命令合并为一条命令，如：</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">rpush list a</span><br><span class="line">rpush list b</span><br><span class="line">rpush list c</span><br><span class="line">rpush list d</span><br><span class="line"></span><br><span class="line">最终合并为:</span><br><span class="line">rpush list a b c d</span><br></pre></td></tr></table></figure></div></li>
</ul>
<p>AOF重写分为两种，一种为自动重写，另一种为手动重写。</p>
<p>1）手动重写</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bgrewriteaof</span><br></pre></td></tr></table></figure></div>

<p>执行完该命令后，会发现.aof文件变小了（前提是具备重写条件）。</p>
<p>2）自动重写</p>
<p>条件参数：</p>
<ul>
<li><strong>auto-aof-rewrite-min-size：</strong>aof_current_size大于此参数时发生重写（默认为1MB）</li>
<li><strong>auto-aof-rewrite-percentage：</strong>重写百分比参数（默认百分之百）</li>
</ul>
<p>在redis内部会自动维护以下几个参数：</p>
<ul>
<li><strong>aof_current_size：</strong>当前aof文件大小</li>
<li><strong>aof_base_size：</strong>上一次执行完重写操纵时的aof文件大小</li>
</ul>
<p>自动重写触发条件：</p>
<p>1、<code>aof_current_size</code>大于<code>auto-aof-rewrite-min-size</code>时将会触发重写</p>
<p>2、<code>(aof_current_size-aof_base_size)</code>&#x2F;<code>aof_base_size</code>大于等于<code>auto-aof-rewrite-percentage</code>时将会触发重写。</p>
<p>执行<code>info Persistence</code>命令，查看当前参数</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; info Persistence</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Persistence</span></span><br><span class="line">loading:0</span><br><span class="line">rdb_changes_since_last_save:11</span><br><span class="line">rdb_bgsave_in_progress:0</span><br><span class="line">rdb_last_save_time:1585142012</span><br><span class="line">rdb_last_bgsave_status:ok</span><br><span class="line">rdb_last_bgsave_time_sec:-1</span><br><span class="line">rdb_current_bgsave_time_sec:-1</span><br><span class="line">rdb_last_cow_size:0</span><br><span class="line">aof_enabled:1</span><br><span class="line">aof_rewrite_in_progress:0</span><br><span class="line">aof_rewrite_scheduled:0</span><br><span class="line">aof_last_rewrite_time_sec:0</span><br><span class="line">aof_current_rewrite_time_sec:-1</span><br><span class="line">aof_last_bgrewrite_status:ok</span><br><span class="line">aof_last_write_status:ok</span><br><span class="line">aof_last_cow_size:6385664</span><br><span class="line">aof_current_size:138</span><br><span class="line">aof_base_size:138</span><br><span class="line">aof_pending_rewrite:0</span><br><span class="line">aof_buffer_length:0</span><br><span class="line">aof_rewrite_buffer_length:0</span><br><span class="line">aof_pending_bio_fsync:0</span><br><span class="line">aof_delayed_fsync:0</span><br></pre></td></tr></table></figure></div>

<ul>
<li>配置自动重写redis.conf配置如下：</li>
</ul>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">bind 127.0.0.1</span><br><span class="line">port 6379</span><br><span class="line"># logfile &quot;6379.log&quot;</span><br><span class="line">dir /root/redis-4.0.11/data</span><br><span class="line">#dbfilename drum-6379.rdb</span><br><span class="line">#rdbcompression yes</span><br><span class="line">#rdbchecksum yes</span><br><span class="line"># save 1 1</span><br><span class="line">daemonize no</span><br><span class="line">appendonly yes</span><br><span class="line">appendfsync everysec</span><br><span class="line">appendfilename appendonly-6379.aof</span><br><span class="line">auto-aof-rewrite-min-size 100</span><br></pre></td></tr></table></figure></div>

<h2 id="2-3-总结"><a href="#2-3-总结" class="headerlink" title="2.3 总结"></a>2.3 总结</h2><ul>
<li><p>RDB</p>
<ul>
<li>优点<ul>
<li>RDB内部存储的是redis在某个时间点的数据快照，非常适合用于数据的全量备份。</li>
<li>RDB是基于数据快照的理念设计的，每一个rdb文件都是一个已经压缩过的二进制文件，存储效率较高。</li>
<li>由于RDB是将数据全部存储在rdb文件中，即每个rdb文件都是原始数据，在恢复大数据集时的速度比 AOF 的恢复速度要快的多。</li>
</ul>
</li>
<li>缺点：<ul>
<li>如果对数据恢复非常敏感，那么RDB的持久化效率将没有AOF的高，虽然RDB可以设置保存点save，但是因为RDB每次拍摄数据快照需要将此次数据快照的<strong>所有数据</strong>都写入rdb文件，如果频率过高，那么性能势必大大下降。因此RDB无法做到实时持久化（或者换一个方式说，RDB不适合做实时的持久化）。</li>
<li>RDB持久化方式并没有缓冲区的概念，如果rdb的子进程正在将数据写入到rdb文件，会导致数据库的数据和rdb文件中保存的数据不一致。</li>
<li>Redis的众多版本中未进行RDB文件格式的版本统一，有可能出现各版本服务之间数据格式无法兼容现象。</li>
</ul>
</li>
</ul>
</li>
<li><p>AOF</p>
<ul>
<li><p>优点</p>
<ul>
<li>AOF是基于日志形式的理念设计的，AOF将每一个操作指令的步骤以日志的方式记录下来，因此同步的频率相对RDB来说可以非常的频繁。AOF适用于数据实时同步要求较高的场合。</li>
<li>AOF具有重写机制，可以有效的整理不必要的指令来压缩aof文件的大小，提升数据恢复的性能。</li>
<li>AOF 文件有序地保存了对数据库执行的所有写入操作，这些写入命令被redis保存到了aof文件上，这些指令让人可以轻松阅读，并且文件易于解析，当你中途不小心执行了<code>flushall</code>指令，只要aof文件没有被重写，此时可以编辑aof文件删除<code>flushall</code>指令，来恢复数据：</li>
</ul>
</li>
<li><pre><code class="shell">*1
$7
flushdb
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">    &gt; 删除以上数据，进行AOF恢复；</span><br><span class="line"></span><br><span class="line">  - 缺点</span><br><span class="line"></span><br><span class="line">    - 对于同等的数据量，AOF 文件的体积通常要大于 RDB 文件的体积。</span><br><span class="line">    - 由于aof文件保存的是操作的命令，因此恢复起来速度要比RDB慢</span><br><span class="line"></span><br><span class="line"># 三、发布订阅（pub/sub）</span><br><span class="line"></span><br><span class="line">## 3.1 简介</span><br><span class="line"></span><br><span class="line">Redis 发布订阅（pub/sub）是一种消息通信模式：发送者(pub)发送消息，订阅者(sub)接收消息。</span><br><span class="line"></span><br><span class="line">发送者（发布者）并不是直接发送它们的消息给指定的接收者（订阅者），而是将消息发布到特定的消息通道，并且不需要知道订阅者的任何信息。订阅者可以订阅一个或多个感兴趣的消息通道，同时也只会收到他们感兴趣通道的信息，而不用去关心是谁发布的。这种发布者与订阅者的解耦，使其具备更强的扩展性并得到一个更加动态的网络拓扑。</span><br><span class="line"></span><br><span class="line">订阅：客户端订阅喜欢的频道。</span><br><span class="line"></span><br><span class="line">![](/images/redis1/39.png)</span><br><span class="line"></span><br><span class="line">发布：消息发送给指定的频道，由频道发送给订阅它的客户端。</span><br><span class="line"></span><br><span class="line">![](/images/redis1/40.png)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">## 3.2 订阅发布应用</span><br><span class="line"></span><br><span class="line">- 订阅频道</span><br><span class="line"></span><br><span class="line">```shell</span><br><span class="line">subscribe channel [channel ...] </span><br></pre></td></tr></table></figure></div>
</code></pre>
</li>
</ul>
</li>
</ul>
<p>示例：订阅a、b、c频道</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">subscribe a b c</span><br></pre></td></tr></table></figure></div>



<ul>
<li>发布消息</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">publish channel message</span><br></pre></td></tr></table></figure></div>

<p>示例：给a频道发送hello</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">publish a hello</span><br></pre></td></tr></table></figure></div>

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/redis1/41.png"
                     
                ></p>
<ul>
<li>查看现有多少频道</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; pubsub channels</span><br><span class="line">1) &quot;a&quot;</span><br><span class="line">2) &quot;e&quot;</span><br><span class="line">3) &quot;c&quot;</span><br><span class="line">4) &quot;b&quot;</span><br><span class="line">127.0.0.1:6379&gt;</span><br></pre></td></tr></table></figure></div>



<ul>
<li>退订给定的频道</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">unsubscribe channel [channel ...]</span><br></pre></td></tr></table></figure></div>

<p>示例：退订a频道</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">unsubscribe a </span><br></pre></td></tr></table></figure></div>

<blockquote>
<p>tips:<strong>注意：由于redis客户端订阅操作会占用当前客户端窗口，因此执行不了任何redis命令，退订频道命令一般用于程序客户端操作使用（如Java客户端、C客户端、PHP客户端等）</strong></p>
</blockquote>
<ul>
<li>订阅多个符合条件的频道</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">psubscribe parent [parent ...]</span><br></pre></td></tr></table></figure></div>

<p>示例：订阅所有以a结尾的频道</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">psubscribe *a</span><br></pre></td></tr></table></figure></div>



<ul>
<li>退订多个符合条件的频道</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">punsubscribe parent [parent ...]</span><br></pre></td></tr></table></figure></div>

<p>示例：退订以a结尾的所有频道</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">punsubscribe *a *b *c</span><br></pre></td></tr></table></figure></div>



<p>案例：</p>
<p>client1：</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; psubscribe goods.*</span><br></pre></td></tr></table></figure></div>

<p>client2：</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; psubscribe order.*</span><br></pre></td></tr></table></figure></div>

<p>client3：</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; publish goods.save hello~</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; publish ace hi~</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; </span><br></pre></td></tr></table></figure></div>

<p>观测变化：</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/redis1/42.png"
                     
                ></p>
<h2 id="3-3-Java操作发布订阅API"><a href="#3-3-Java操作发布订阅API" class="headerlink" title="3.3 Java操作发布订阅API"></a>3.3 Java操作发布订阅API</h2><h3 id="3-3-1-Jedis操作发布订阅"><a href="#3-3-1-Jedis操作发布订阅" class="headerlink" title="3.3.1 Jedis操作发布订阅"></a>3.3.1 Jedis操作发布订阅</h3><p>在Jedis中提供有JedisPubSub类，该类主要用于监听触发发布订阅指定命令的执行；当有发布订阅相关命令执行时，就会触发JedisPubSub中指定的方法；</p>
<ul>
<li>JedisPubSub提供的方法如下：</li>
</ul>
<table>
<thead>
<tr>
<th>方法</th>
<th>触发时机</th>
</tr>
</thead>
<tbody><tr>
<td>onSubscribe</td>
<td>当有频道订阅时触发（subscribe）</td>
</tr>
<tr>
<td>onMessage</td>
<td>当有频道收到消息时触发（publish）</td>
</tr>
<tr>
<td>onUnsubscribe</td>
<td>当有频道退订时触发（unsubscribe）</td>
</tr>
<tr>
<td>onPSubscribe</td>
<td>当使用psubscribe命令订阅一批频道时触发</td>
</tr>
<tr>
<td>onPUnsubscribe</td>
<td>当使用punsubscribe命令退订一批频道时触发</td>
</tr>
<tr>
<td>onPMessage</td>
<td>当使用pubsub命令时调用</td>
</tr>
</tbody></table>
<ul>
<li>编写监听类：</li>
</ul>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.dfbz.listener;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> redis.clients.jedis.JedisPubSub;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> lscl</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@intro</span>:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PubSubListener</span> <span class="keyword">extends</span> <span class="title class_">JedisPubSub</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 当有频道进行订阅时调用(subscribe)</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> channel:              订阅的频道</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> subscribedChannels:   当前jedis连接订阅了几个频道</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onSubscribe</span><span class="params">(String channel, <span class="type">int</span> subscribedChannels)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;有频道【&quot;</span> + channel + <span class="string">&quot;】订阅了: &quot;</span> + subscribedChannels);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 当频道收到消息时调用(publish)</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> channel</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> message</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onMessage</span><span class="params">(String channel, String message)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;接收到来自【&quot;</span> + channel + <span class="string">&quot;】的信息【&quot;</span> + message + <span class="string">&quot;】&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 如果发送的消息是close时退订这个频道</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="string">&quot;close&quot;</span>.equals(message))&#123;</span><br><span class="line">            <span class="built_in">this</span>.unsubscribe(channel);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 取消订阅频道时调用(unsubscribe)</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> channel</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> subscribedChannels</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onUnsubscribe</span><span class="params">(String channel, <span class="type">int</span> subscribedChannels)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;有频道【&quot;</span> + channel + <span class="string">&quot;】取消订阅了: &quot;</span> + subscribedChannels);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 使用psubscribe命令订阅一批频道时触发</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> pattern</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> subscribedChannels</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onPSubscribe</span><span class="params">(String pattern, <span class="type">int</span> subscribedChannels)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;使用【&quot;</span> + pattern + <span class="string">&quot;】表达式订阅了频道: &quot;</span> + subscribedChannels);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 使用punsubscribe命令退订一批频道时触发</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> pattern</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> subscribedChannels</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onPUnsubscribe</span><span class="params">(String pattern, <span class="type">int</span> subscribedChannels)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;使用【&quot;</span> + pattern + <span class="string">&quot;】表达式退订了频道: &quot;</span> + subscribedChannels);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 使用pubsub命令时触发</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> pattern</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> channel</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> message</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onPMessage</span><span class="params">(String pattern, String channel, String message)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;订阅表达式为【&quot;</span> + pattern + <span class="string">&quot;】，订阅的频道是【&quot;</span> + channel + <span class="string">&quot;】，消息【&quot;</span> + message + <span class="string">&quot;】&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<ul>
<li>测试类：</li>
</ul>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.dfbz.demo01;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.dfbz.listener.PubSubListener;</span><br><span class="line"><span class="keyword">import</span> org.junit.Before;</span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"><span class="keyword">import</span> redis.clients.jedis.Jedis;</span><br><span class="line"><span class="keyword">import</span> redis.clients.jedis.JedisPool;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> lscl</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@intro</span>:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Demo01</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> JedisPool jedisPool;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Before</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">before</span><span class="params">()</span> &#123;</span><br><span class="line">        jedisPool = <span class="keyword">new</span> <span class="title class_">JedisPool</span>(<span class="string">&quot;localhost&quot;</span>, <span class="number">6379</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test1</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">PubSubListener</span> <span class="variable">pubSubListener</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PubSubListener</span>();</span><br><span class="line">        <span class="comment">// 从连接池获取一个连接</span></span><br><span class="line">        <span class="type">Jedis</span> <span class="variable">jedis</span> <span class="operator">=</span> jedisPool.getResource();</span><br><span class="line"></span><br><span class="line">        jedis.subscribe(pubSubListener, <span class="string">&quot;a&quot;</span>, <span class="string">&quot;b&quot;</span>, <span class="string">&quot;c&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test2</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Jedis</span> <span class="variable">jedis</span> <span class="operator">=</span> jedisPool.getResource();</span><br><span class="line"></span><br><span class="line">        jedis.publish(<span class="string">&quot;a&quot;</span>, <span class="string">&quot;a say hello~&quot;</span>);</span><br><span class="line">        jedis.publish(<span class="string">&quot;b&quot;</span>, <span class="string">&quot;b say hello~&quot;</span>);</span><br><span class="line">        jedis.publish(<span class="string">&quot;c&quot;</span>, <span class="string">&quot;c say hello~&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 退订a频道</span></span><br><span class="line">        jedis.publish(<span class="string">&quot;a&quot;</span>, <span class="string">&quot;close&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 退订是比较耗时的操作</span></span><br><span class="line">        Thread.sleep(<span class="number">10</span>);</span><br><span class="line">        jedis.publish(<span class="string">&quot;a&quot;</span>, <span class="string">&quot;a say hello~&quot;</span>);</span><br><span class="line">        jedis.publish(<span class="string">&quot;b&quot;</span>, <span class="string">&quot;b say hello~&quot;</span>);</span><br><span class="line">        jedis.publish(<span class="string">&quot;c&quot;</span>, <span class="string">&quot;c say hello~&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>测试pattern模式：</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.dfbz.demo01;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.dfbz.listener.PubSubListener;</span><br><span class="line"><span class="keyword">import</span> org.junit.Before;</span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"><span class="keyword">import</span> redis.clients.jedis.Jedis;</span><br><span class="line"><span class="keyword">import</span> redis.clients.jedis.JedisPool;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> lscl</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@intro</span>:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Demo02</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> JedisPool jedisPool;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Before</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">before</span><span class="params">()</span> &#123;</span><br><span class="line">        jedisPool = <span class="keyword">new</span> <span class="title class_">JedisPool</span>(<span class="string">&quot;localhost&quot;</span>, <span class="number">6379</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test1</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">PubSubListener</span> <span class="variable">pubSubListener</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PubSubListener</span>();</span><br><span class="line">        <span class="comment">// 从连接池获取一个连接</span></span><br><span class="line">        <span class="type">Jedis</span> <span class="variable">jedis</span> <span class="operator">=</span> jedisPool.getResource();</span><br><span class="line"></span><br><span class="line">        jedis.psubscribe(pubSubListener, <span class="string">&quot;goods.*&quot;</span>, <span class="string">&quot;order.*&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test2</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Jedis</span> <span class="variable">jedis</span> <span class="operator">=</span> jedisPool.getResource();</span><br><span class="line"></span><br><span class="line">        jedis.publish(<span class="string">&quot;goods.save&quot;</span>,<span class="string">&quot;goods.save hello~&quot;</span>);</span><br><span class="line">        jedis.publish(<span class="string">&quot;goods.delete&quot;</span>,<span class="string">&quot;goods.delete hello~&quot;</span>);</span><br><span class="line">        jedis.publish(<span class="string">&quot;order.query&quot;</span>,<span class="string">&quot;order.query hello~&quot;</span>);</span><br><span class="line">        jedis.publish(<span class="string">&quot;order.update&quot;</span>,<span class="string">&quot;order.update hello~&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="3-3-2-SpringBoot操作发布订阅"><a href="#3-3-2-SpringBoot操作发布订阅" class="headerlink" title="3.3.2 SpringBoot操作发布订阅"></a>3.3.2 SpringBoot操作发布订阅</h3><ul>
<li>1）引入依赖：</li>
</ul>
<div class="highlight-container" data-rel="Xml"><figure class="iseeu highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.dfbz<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>02_Redis_SpringBoot<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.0.1.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure></div>

<ul>
<li>2）编写监听器：</li>
</ul>
<p>CRMListener：</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.dfbz.listener;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.connection.Message;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.connection.MessageListener;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.RedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.serializer.RedisSerializer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> lscl</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@intro</span>: 监听CRM业务相关的消息</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CRMListener</span> <span class="keyword">implements</span> <span class="title class_">MessageListener</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onMessage</span><span class="params">(Message message, <span class="type">byte</span>[] bytes)</span> &#123;</span><br><span class="line">        <span class="comment">// redis序列化工具</span></span><br><span class="line">        RedisSerializer&lt;?&gt; serializer = redisTemplate.getValueSerializer();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 频道</span></span><br><span class="line">        <span class="type">byte</span>[] channel = message.getChannel();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 发送的数据</span></span><br><span class="line">        <span class="type">byte</span>[] body = message.getBody();</span><br><span class="line">        System.out.println(<span class="string">&quot;我是CRMListener--来自【&quot;</span> + <span class="keyword">new</span> <span class="title class_">String</span>(channel) + <span class="string">&quot;】频道的消息：【&quot;</span> +serializer.deserialize(body) + <span class="string">&quot;】&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></div>

<p>OAListener：</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.dfbz.listener;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.connection.Message;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.connection.MessageListener;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.RedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.serializer.RedisSerializer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> lscl</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@intro</span>: 监听OA业务相关的消息</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OAListener</span> <span class="keyword">implements</span> <span class="title class_">MessageListener</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onMessage</span><span class="params">(Message message, <span class="type">byte</span>[] pattern)</span> &#123;</span><br><span class="line">        <span class="comment">// redis序列化工具</span></span><br><span class="line">        RedisSerializer&lt;?&gt; serializer = redisTemplate.getValueSerializer();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 频道</span></span><br><span class="line">        <span class="type">byte</span>[] channel = message.getChannel();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 发送的数据</span></span><br><span class="line">        <span class="type">byte</span>[] body = message.getBody();</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;我是OAListener--来自【&quot;</span> + <span class="keyword">new</span> <span class="title class_">String</span>(channel) + <span class="string">&quot;】频道的消息：【&quot;</span> + serializer.deserialize(body).toString() + <span class="string">&quot;】&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></div>

<ul>
<li>启动类（注册监听）：</li>
</ul>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.dfbz;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.dfbz.listener.CRMListener;</span><br><span class="line"><span class="keyword">import</span> com.dfbz.listener.OAListener;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.connection.RedisConnectionFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.listener.ChannelTopic;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.listener.PatternTopic;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.listener.RedisMessageListenerContainer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.listener.Topic;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.listener.adapter.MessageListenerAdapter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> lscl</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@intro</span>:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisApplication</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(RedisApplication.class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 封装成监听适配器</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> MessageListenerAdapter <span class="title function_">CRMListenerAdapter</span><span class="params">(CRMListener crmListener)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">MessageListenerAdapter</span>(crmListener);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 封装成监听适配器</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> MessageListenerAdapter <span class="title function_">OAListenerAdapter</span><span class="params">(OAListener oaListener)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">MessageListenerAdapter</span>(oaListener);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 注册监听适配器</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RedisMessageListenerContainer <span class="title function_">redisMessageListenerContainer</span><span class="params">(</span></span><br><span class="line"><span class="params">            RedisConnectionFactory redisConnectionFactory,</span></span><br><span class="line"><span class="params">            MessageListenerAdapter CRMListenerAdapter,</span></span><br><span class="line"><span class="params">            MessageListenerAdapter OAListenerAdapter</span></span><br><span class="line"><span class="params">    )</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 监听规则集合</span></span><br><span class="line">        List&lt;Topic&gt; oaList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;Topic&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 普通订阅，订阅具体的频道</span></span><br><span class="line">        <span class="type">ChannelTopic</span> <span class="variable">deptTopic</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChannelTopic</span>(<span class="string">&quot;dept&quot;</span>);</span><br><span class="line">        oaList.add(deptTopic);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 模式订阅，支持模式匹配订阅，*为模糊匹配符</span></span><br><span class="line">        <span class="type">PatternTopic</span> <span class="variable">userTopic</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PatternTopic</span>(<span class="string">&quot;user.*&quot;</span>);</span><br><span class="line">        oaList.add(userTopic);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 监听规则集合</span></span><br><span class="line">        List&lt;Topic&gt; crmList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;Topic&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 普通订阅，订阅具体的频道</span></span><br><span class="line">        <span class="type">ChannelTopic</span> <span class="variable">examineTopic</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChannelTopic</span>(<span class="string">&quot;examine&quot;</span>);</span><br><span class="line">        crmList.add(examineTopic);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 模式订阅，支持模式匹配订阅，*为模糊匹配符</span></span><br><span class="line">        <span class="type">PatternTopic</span> <span class="variable">reportTopic</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PatternTopic</span>(<span class="string">&quot;report.*&quot;</span>);</span><br><span class="line">        crmList.add(reportTopic);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 监听容器</span></span><br><span class="line">        <span class="type">RedisMessageListenerContainer</span> <span class="variable">redisMessageListenerContainer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RedisMessageListenerContainer</span>();</span><br><span class="line">        redisMessageListenerContainer.setConnectionFactory(redisConnectionFactory);</span><br><span class="line">        redisMessageListenerContainer.addMessageListener(CRMListenerAdapter, crmList);</span><br><span class="line">        redisMessageListenerContainer.addMessageListener(OAListenerAdapter, oaList);</span><br><span class="line">        <span class="keyword">return</span> redisMessageListenerContainer;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<ul>
<li>测试类：</li>
</ul>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.dfbz.demo01;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"><span class="keyword">import</span> org.junit.runner.RunWith;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.RedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.test.context.junit4.SpringRunner;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> lscl</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@intro</span>:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RunWith(SpringRunner.class)</span></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Demo01</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test1</span><span class="params">()</span>&#123;</span><br><span class="line"></span><br><span class="line">        redisTemplate.convertAndSend(<span class="string">&quot;dept&quot;</span>,<span class="string">&quot;dept hello~&quot;</span>);</span><br><span class="line">        redisTemplate.convertAndSend(<span class="string">&quot;user.save&quot;</span>,<span class="string">&quot;user.save hello~&quot;</span>);</span><br><span class="line">        redisTemplate.convertAndSend(<span class="string">&quot;user.delete&quot;</span>,<span class="string">&quot;user.delete hello~&quot;</span>);</span><br><span class="line">        redisTemplate.convertAndSend(<span class="string">&quot;examine&quot;</span>,<span class="string">&quot;examine hello~&quot;</span>);</span><br><span class="line">        redisTemplate.convertAndSend(<span class="string">&quot;report.query&quot;</span>,<span class="string">&quot;report.query hello~&quot;</span>);</span><br><span class="line">        redisTemplate.convertAndSend(<span class="string">&quot;report.update&quot;</span>,<span class="string">&quot;report.update hello~&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h1 id="四、Redis事务"><a href="#四、Redis事务" class="headerlink" title="四、Redis事务"></a>四、Redis事务</h1><h2 id="4-1-Redis事务操作"><a href="#4-1-Redis事务操作" class="headerlink" title="4.1 Redis事务操作"></a>4.1 Redis事务操作</h2><p><strong>Redis 事务的本质是一组命令的集合</strong>。在Redis中开启事务后，事务中的命令<strong>并不会立即执行</strong>，而是会<strong>推送到一个事务队列</strong>中，该队列积攒此次事务的所有命令，等到事务提交（执行）后，会逐步执行此队列中的命令，执行队列中的命令过程是一个整体，<strong>如果其中有一个命令执行失败，那么此次事务队列中的所有命令取消</strong>。不会被其他客户端所干扰。</p>
<blockquote>
<p><strong>注意：Redis事务中没有隔离级别的概念，因此不存在脏读、不可重复读、幻读等情况。</strong></p>
</blockquote>
<ul>
<li>开启事务，并创建队列</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">multi</span><br></pre></td></tr></table></figure></div>

<ul>
<li>执行事务</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">exec</span><br></pre></td></tr></table></figure></div>

<ul>
<li>取消事务</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">discard</span><br></pre></td></tr></table></figure></div>

<p>redis在开启事务时，之后执行的所有的操作均会保存到任务队列中。如果执行了<code>exec</code>命令，那么redis将会逐步执行队列中的指令，如果执行<code>discard</code>指令，那么将会取消队列中的所有指令。</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/redis2/11.png"
                     
                ></p>
<p>事务队列中某个命令出现错误：</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/redis2/100.png"
                     
                ></p>
<h2 id="4-2-Redis锁"><a href="#4-2-Redis锁" class="headerlink" title="4.2 Redis锁"></a>4.2 Redis锁</h2><p>我们知道redis在开启事务时，其实就是创建了一个事务队列，此次事务所执行的所有命令将不会被立即执行，而是等事务执行之后（<code>exec</code>），才会将队列中的命令<strong>一起</strong>执行。有时候我们希望在执行队列中的指令之前不允许其他客户端对某个值进行修改，那么此时需要就需要加锁。</p>
<ul>
<li>watch：监视某个key</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">watch key1 [key2……]</span><br></pre></td></tr></table></figure></div>

<p>如果被监视的值在<code>exec</code>命令之前被其他客户端修改过了，那么此次事务队列中的命令全部失效。</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/redis2/12.png"
                     
                ></p>
<ul>
<li>unwatch：取消监视的所有key</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">unwatch</span><br></pre></td></tr></table></figure></div>

<p><strong>注意：执行exec会释放所有被监视的key</strong></p>
<h2 id="4-3-Redis-实现分布式锁"><a href="#4-3-Redis-实现分布式锁" class="headerlink" title="4.3 Redis 实现分布式锁"></a>4.3 Redis 实现分布式锁</h2><p>在并发编程中，我们通常通过锁来保证多个多线程操作同一资源的<strong>一致性</strong>，在Java中，提供有<code>synchroized</code>、<code>Lock</code>等来实现锁的功能，但Java中的锁只能保证在单体项目中（单个JVM进程中），无法应用在分布式环境下。</p>
<p>在分布式环境下，想要实现多个服务（多个进程）操作同一资源时，保证数据的一致性。可以使用redis来实现分布式锁。</p>
<h3 id="4-3-1-Redis分布式锁场景"><a href="#4-3-1-Redis分布式锁场景" class="headerlink" title="4.3.1 Redis分布式锁场景"></a>4.3.1 Redis分布式锁场景</h3><p>12306在售票时，是有多个售票窗口的，也就是售票的服务是有多个的，不管是在哪个售票微服卖出去的票都需要减掉库存中的余票，此时库存微服也是分布式的，即也存在多个减库存的微服接口，调用其中任意某个库存微服都可以实现减票操作。我们在单体项目时，只需将关键代码加上同步锁（多个售票窗口保证锁是同一个）。</p>
<p>伪代码如下：</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Ticket</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//票数</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">Integer</span> <span class="variable">ticket</span> <span class="operator">=</span> <span class="number">100</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//锁对象</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//加上同步代码块,把需要同步的代码放入代码块中,同步代码块中的锁对象必须保证一致！</span></span><br><span class="line">            <span class="keyword">synchronized</span> (obj) &#123;</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span> (ticket &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">break</span>;      <span class="comment">//票卖完了</span></span><br><span class="line">                &#125;</span><br><span class="line">                System.out.println(Thread.currentThread().getName() + <span class="string">&quot;正在卖第: &quot;</span> + (<span class="number">101</span> - ticket) + <span class="string">&quot;张票&quot;</span>);</span><br><span class="line"></span><br><span class="line">                ticket--;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></div>

<p>售票窗口：</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Demo1</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">		</span><br><span class="line">        Ticket ticket=<span class="keyword">new</span> <span class="title class_">Ticket</span>();</span><br><span class="line">        <span class="comment">//开启三个窗口,卖票</span></span><br><span class="line">        Thread t1=<span class="keyword">new</span> <span class="title class_">Thread</span>(ticket,<span class="string">&quot;南昌西站&quot;</span>);</span><br><span class="line">        Thread t2=<span class="keyword">new</span> <span class="title class_">Thread</span>(ticket,<span class="string">&quot;南昌东站&quot;</span>);</span><br><span class="line">        Thread t3=<span class="keyword">new</span> <span class="title class_">Thread</span>(ticket,<span class="string">&quot;南昌站&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        t1.start();</span><br><span class="line">        t2.start();</span><br><span class="line">        t3.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>在单体项目中，以上代码是可以保证票数不会被超卖。但是在分布式环境中无法保证，<strong>原因是分布式的每台机器上都有各自的锁。</strong></p>
<p>我们需要将锁抽取出来，所有的微服公用同一把锁，谁拿到了锁，谁就可以操作资源。没有拿到锁的只能等待。</p>
<h3 id="4-3-2-Redis实现分布式锁"><a href="#4-3-2-Redis实现分布式锁" class="headerlink" title="4.3.2 Redis实现分布式锁"></a>4.3.2 Redis实现分布式锁</h3><ul>
<li>设置分布式锁</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">setnx lock-key value</span><br></pre></td></tr></table></figure></div>

<p>示例：</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">setnx ticket_lock 1</span><br></pre></td></tr></table></figure></div>

<p>说明：设置一个key，如果成功返回1，失败返回0</p>
<p>分布式锁案例代码：</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span>(<span class="literal">true</span>)&#123;</span><br><span class="line">    <span class="comment">// 获取到了分布式锁才可以进行卖票操作            </span></span><br><span class="line">    <span class="keyword">if</span>(<span class="string">&quot;1&quot;</span>.equalus(redis.setnx(<span class="string">&quot;ticket_lock&quot;</span>,<span class="string">&quot;1&quot;</span>)))&#123;</span><br><span class="line">        <span class="keyword">if</span> (ticket &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">break</span>;      <span class="comment">//票卖完了</span></span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(Thread.currentThread().getName() + <span class="string">&quot;正在卖第: &quot;</span> + (<span class="number">101</span> - ticket) + <span class="string">&quot;张票&quot;</span>);</span><br><span class="line"></span><br><span class="line">        ticket--;  </span><br><span class="line">        redis.del(<span class="string">&quot;ticket_lock&quot;</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        Thread.sleep(<span class="number">10</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="4-3-3-分布式锁改良"><a href="#4-3-3-分布式锁改良" class="headerlink" title="4.3.3 分布式锁改良"></a>4.3.3 分布式锁改良</h3><p>上面设置的分布式锁，可以保证分布式环境下的资源一致问题，但是有一个非常大的弊端，那就是如果获取到分布式锁的那个微服出现故障（如宕机），那么锁将永远不会释放，造成锁的永远阻塞，其他窗口再也卖不出任何的票，因此为了防止这种现象，我们可以给分布式锁设置一个过期时间，如果时间到了那么锁自动释放。</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">expire lock-key second</span><br><span class="line">expire ticket_lock 5</span><br></pre></td></tr></table></figure></div>

<h1 id="五、Redis的删除策略"><a href="#五、Redis的删除策略" class="headerlink" title="五、Redis的删除策略"></a>五、Redis的删除策略</h1><p>我们知道Redis中的数据都是存储在内存中的，内存空间非常宝贵，当我们对不需使用的数据应该立即删除，我们知道可以使用ttl命令查看数据的过期时间，也可以使用del命令来删除某个key，<strong>但是redis中的数据过期就真的清除了吗？使用del删除的数据就真的删除了吗？</strong></p>
<p>在redis中，针对过期和删除的数据有三种策略来清除。分别为<strong>定时删除、惰性删除、定期删除。</strong></p>
<h2 id="5-1-定时删除策略"><a href="#5-1-定时删除策略" class="headerlink" title="5.1 定时删除策略"></a>5.1 定时删除策略</h2><p>在设置键的过期时间的同时，Redis内部会创建一个定时器，当key设置有过期时间，且过期时间到达时，或者执行了del的key，由定时器任务立即执行对键的删除操作</p>
<ul>
<li>优点：定时器时间到了就执行删除，能够有效快速释放内存空间，节约内存</li>
<li>缺点：定时器时间到了就执行删除，在这一时刻如果CPU正在处理其他命令，那么CPU的负载会一下子变得非常高，会直接影响Redis处理请求的响应速度。</li>
<li>总结：牺牲CPU性能来释放内存（时间换空间），<strong>定时删除策略是对内存清除最有效的方式；</strong></li>
</ul>
<h2 id="5-2-惰性删除策略"><a href="#5-2-惰性删除策略" class="headerlink" title="5.2 惰性删除策略"></a>5.2 惰性删除策略</h2><p>数据到达过期时间不删除，等下次访问该数据时再删除。</p>
<ul>
<li><p>优点：有效节约CPU性能，发现必须要删除时才删除。</p>
</li>
<li><p>缺点：如果数据过期后一直没有访问数据，那么将长期占用内存使用量，内存压力大</p>
<p>总结：牺牲内存使用量来换取CPU的性能（空间换时间）</p>
</li>
</ul>
<h2 id="5-3-定期删除策略"><a href="#5-3-定期删除策略" class="headerlink" title="5.3 定期删除策略"></a>5.3 定期删除策略</h2><p>从定时删除和惰性删除策略来看，惰性删除浪费内存容易造成内存溢出，而定时删除影响CPU性能降低redis的响应速度和吞吐量。两种删除方式在不管是在CPU还是内存上都有些极端。定期删除策略则是一种折中办法。</p>
<ul>
<li>定期删除工作原理图：</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/redis2/14.png"
                     
                ></p>
<p>Redis启动服务器初始化时，读取配置server组下的<code>hz</code>的值，默认为10，每秒钟执行<code>hz</code>次serverCron()开始清除数据库中的键值对，并且执行databasesCron()方法轮询单台redis的所有数据库，最终执行<code>activeExpireCycle()</code>方法，随机在当前数据库中挑选出<code>ACTIVE_EXPIRE_CYCLE_LOOKUPS_PER_LOOP</code>（N）个key来进行检测（默认为20），如果检测到过期那么就将此key删除，最终计算此次删除的key如果大于<code>0.25*N</code>，那么就说明当前数据库过期的key占比较大，则重新执行<code>activeExpireCycle()</code>方法再次抽取N个key，如果这次删除的key的数量小于等于<code>0.25*N</code>那么则轮询下一个数据库</p>
<p>其中调用activeExpireCycle()方法将会有<code>250ms/hz</code>秒机会检测key，如果时间到期则直接轮询下一个数据库，并将数据库编号记录到<code>current_db</code>变量中。</p>
<p>特点：周期性轮询redis中数据的有效性，采取智能算法抽取的策略，对过期数据占比较大的数据库进行有效删除。</p>
<ul>
<li>优点：智能根据数据库有效数据占用率来选择删除的粒度，并且检测频率（server.hz）可以根据CPU占用率适当调整。</li>
</ul>
<p><strong>redis底层采用的是定期删除+惰性删除策略</strong></p>
<blockquote>
<p>hz 通过info命令可以查询到，具体位置在info server组下。</p>
</blockquote>
<h2 id="5-4-三种策略总结"><a href="#5-4-三种策略总结" class="headerlink" title="5.4 三种策略总结"></a>5.4 三种策略总结</h2><ul>
<li><p>定时删除（对内存清除最有效）</p>
<ul>
<li>不管CPU当前使用率是否紧张，时间到了立马删除，内存压力小，CPU压力大，采用时间换空间策略</li>
</ul>
</li>
<li><p>惰性删除（等到二次访问再删除）</p>
<ul>
<li>等到确切删除的时候再删除，造成内存使用量浪费，CPU压力小，采用空间换时间策略</li>
</ul>
</li>
<li><p>定期删除（采取智能抽取检查）</p>
<ul>
<li>周期性删除，随机抽取一部分key删除，如发现占整体key的比例较大，则重新抽取一部分key删除。之后轮询下一个数据、下一台redis……</li>
</ul>
</li>
</ul>
<h1 id="六、内存淘汰机制"><a href="#六、内存淘汰机制" class="headerlink" title="六、内存淘汰机制"></a>六、内存淘汰机制</h1><p>我们知道Redis底层默认采用的是<strong>惰性删除+定期删除</strong>，如果定期删除没有删除的key，再加上也没有访问过这个key，那么redis内存的占用量会越来越高，假设此时来了新的数据，而redis的存储空间已经满了，那么此时redis的内存淘汰机制可以根据淘汰策略帮我删除一部分部分key来释放新的空间。</p>
<h2 id="6-1-淘汰策略"><a href="#6-1-淘汰策略" class="headerlink" title="6.1 淘汰策略"></a>6.1 淘汰策略</h2><ul>
<li><p>allkeys-lru：在16个数据库（前提你没有修改databases）的所有key中，选择使用次数最少的数据进行淘汰</p>
</li>
<li><p>allkeys-lfu：在16个数据库的所有key中，选择最后一次使用离现在最长的数据进行淘汰</p>
</li>
<li><p>allkeys-random：在16个数据库的所有key中，随机选择一部分数据进行淘汰</p>
</li>
<li><p>volatile-lru：在所有有设置过期时间的key中，选择使用次数最少的数据进行淘汰</p>
</li>
<li><p><strong>volatile-lfu</strong>：在所有有设置过期时间的key中，选择最后一次使用离现在最长的数据进行淘汰</p>
</li>
<li><p><strong>volatile-ttl</strong>：在所有有设置过期时间的key中，选择将要过期的数据进行淘汰</p>
</li>
<li><p>volatile-random：在所有有设置过期时间的key中，随机选择一部分数据进行淘汰</p>
</li>
<li><p>no-envication：放弃淘汰数据，redis4.0及以上版本<strong>默认策略</strong></p>
</li>
</ul>
<h2 id="6-2-修改Redis淘汰策略"><a href="#6-2-修改Redis淘汰策略" class="headerlink" title="6.2 修改Redis淘汰策略"></a>6.2 修改Redis淘汰策略</h2><p>修改淘汰策略：</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">maxmemory-policy value</span><br><span class="line">maxmemory-policy volatile-ttl</span><br></pre></td></tr></table></figure></div>

<p>注意：当redis内部已经没有可淘汰的key时，如果添加新的数据，则提示如下错误：</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/redis2/16.png"
                     
                ></p>
<h1 id="七、Redis高级数据类型"><a href="#七、Redis高级数据类型" class="headerlink" title="七、Redis高级数据类型"></a>七、Redis高级数据类型</h1><h2 id="7-1-BitMaps"><a href="#7-1-BitMaps" class="headerlink" title="7.1 BitMaps"></a>7.1 BitMaps</h2><h3 id="7-1-1-BitMaps-简介"><a href="#7-1-1-BitMaps-简介" class="headerlink" title="7.1.1 BitMaps 简介"></a>7.1.1 BitMaps 简介</h3><p>redis在2.2.0 版本之后添加了bitmaps操作，bitmaps事实上并不是一种新的数据类型，而是基于字符串位操作的集合，由于字符串是二进制安全的，并且最长可支持512M，所以它们可以用来存储2的32次方（512 * 1024 * 1024 * 8 ）不同位的数据。</p>
<p>bitmaps的位操作分成两组：</p>
<p>1）固定时间的单个位操作，比如把字符串的某个位设置为1或者0，或者获取某个位上的值 </p>
<p>2）对于一组位的操作，对给定的比特范围内，统计设定值为1的数目。</p>
<p>bitmaps最大的优势是在存储数据时可以极大的节省空间，比如在一个项目中采用自增长的id来标识用户，就可以仅用512M的内存来记录40多亿用户的信息</p>
<p><strong>Bitmaps本身不是一种数据结构，他实际上就是一个可以进行位运算的字符串</strong></p>
<h3 id="7-1-2-BitMaps位图原理"><a href="#7-1-2-BitMaps位图原理" class="headerlink" title="7.1.2 BitMaps位图原理"></a>7.1.2 BitMaps位图原理</h3><p>刚刚我们了解到，bitmaps不是一种新的数据类型，其实是以一种位运算的方式来操作原有的字符串而已。</p>
<p>假设我们存储了<code>asd</code>字符串在redis当中，a的ASCII为97，对应的为115、100，那么对应的二进制数据图如下：</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/redis2/18.png"
                     
                ></p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">getbit key offset</span><br></pre></td></tr></table></figure></div>

<ul>
<li>说明：获取指定key偏移量位置的二进制值。</li>
<li>offset：偏移量</li>
</ul>
<p>getbit命令示例：</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; set test1 asd</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; getbit test1 0</span><br><span class="line">(integer) 0</span><br><span class="line">127.0.0.1:6379&gt; getbit test1 1</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; getbit test1 2</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; getbit test1 3</span><br><span class="line">(integer) 0</span><br><span class="line">127.0.0.1:6379&gt; getbit test1 4</span><br><span class="line">(integer) 0</span><br><span class="line">127.0.0.1:6379&gt; getbit test1 5</span><br><span class="line">(integer) 0</span><br><span class="line">127.0.0.1:6379&gt; getbit test1 6</span><br><span class="line">(integer) 0</span><br><span class="line">127.0.0.1:6379&gt; getbit test1 7</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; getbit test1 8</span><br><span class="line">(integer) 0</span><br><span class="line">127.0.0.1:6379&gt;</span><br></pre></td></tr></table></figure></div>

<p>图解：</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/redis2/19.png"
                     
                ></p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">setbit key offset value</span><br></pre></td></tr></table></figure></div>

<ul>
<li>说明：设置key的指定偏移量上的值</li>
<li>offset：索引偏移量（从0开始计算）</li>
<li>value：具体的值（只能是0或1）</li>
</ul>
<p>示例：</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; setbit test2 0 1</span><br><span class="line">(integer) 0</span><br><span class="line">127.0.0.1:6379&gt; setbit test2 1 1</span><br><span class="line">(integer) 0</span><br><span class="line">127.0.0.1:6379&gt; setbit test2 7 1</span><br><span class="line">(integer) 0</span><br><span class="line">127.0.0.1:6379&gt; setbit test2 9 1</span><br><span class="line">(integer) 0</span><br><span class="line">127.0.0.1:6379&gt; setbit test2 11 1</span><br><span class="line">(integer) 0</span><br><span class="line">127.0.0.1:6379&gt; </span><br></pre></td></tr></table></figure></div>

<p>图解：</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/redis2/20.png"
                     
                ></p>
<p>咱们看上图能分析，如果偏移量间隔过大，那么势必会造成中间补0现象较大</p>
<p>例如：</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">setbit test2 300 1</span><br></pre></td></tr></table></figure></div>

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/redis2/21.png"
                     
                ></p>
<p><strong>注意：在第一次setbit时， 如果偏移量非常大， 那么意味着前面的空出都需要0位来补充， 因此会造成Redis的阻塞。</strong> </p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bitcount key [start end]</span><br></pre></td></tr></table></figure></div>

<ul>
<li>说明：统计指定key的二进制位上的1的个数，不指定start和end就获取全部</li>
<li>start：起始索引</li>
<li>end：终止索引</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; bitcount test2</span><br><span class="line">(integer) 6</span><br><span class="line">127.0.0.1:6379&gt;</span><br></pre></td></tr></table></figure></div>

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/redis2/22.png"
                     
                ></p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bitop operation destkey key [key...]</span><br></pre></td></tr></table></figure></div>

<ul>
<li>说明：用于多个BitMap做交集（and）、并集（or）、非（not）、异或（xor）操作，并将其结果计算保存到新的key中</li>
<li>operation：操作类型<ul>
<li>and：交集</li>
<li>or：并集</li>
<li>not：非</li>
<li>xor：异或</li>
</ul>
</li>
<li>destkey：存储计算的结果</li>
</ul>
<p>1）and </p>
<p>与（&amp;），取交集，有假为假</p>
<p>准备数据：</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; setbit test3 0 1</span><br><span class="line">(integer) 0</span><br><span class="line">127.0.0.1:6379&gt; setbit test3 1 1</span><br><span class="line">(integer) 0</span><br><span class="line">127.0.0.1:6379&gt; setbit test3 2 1</span><br><span class="line">(integer) 0</span><br><span class="line">127.0.0.1:6379&gt; setbit test3 3 0</span><br><span class="line">(integer) 0</span><br><span class="line">127.0.0.1:6379&gt; setbit test4 0 1</span><br><span class="line">(integer) 0</span><br><span class="line">127.0.0.1:6379&gt; setbit test4 1 0</span><br><span class="line">(integer) 0</span><br><span class="line">127.0.0.1:6379&gt; setbit test4 2 1</span><br><span class="line">(integer) 0</span><br><span class="line">127.0.0.1:6379&gt; setbit test4 3 1</span><br><span class="line">(integer) 0</span><br></pre></td></tr></table></figure></div>

<p>取and操作：</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; bitop and and-test test3 test4</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; getbit and-test 0</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; getbit and-test 1</span><br><span class="line">(integer) 0</span><br><span class="line">127.0.0.1:6379&gt; getbit and-test 2</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; getbit and-test 3</span><br><span class="line">(integer) 0</span><br></pre></td></tr></table></figure></div>



<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/redis2/23.png"
                     
                ></p>
<p>2）or</p>
<p>或（|），取并集，按位非操作只能指定一个key，代表对哪个key进行”按位非”操作，有真为真</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; bitop or or-test test3 test4</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; getbit or-test 0</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; getbit or-test 1</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; getbit or-test 2</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; getbit or-test 3</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt;</span><br></pre></td></tr></table></figure></div>

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/redis2/24.png"
                     
                ></p>
<p>3）not</p>
<p>非（~），按位取反，1为0，0为1，<strong>按位取反时如果不够8的整数位后面的均会以0补齐。</strong></p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; bitop not not-test test3</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; bitcount not-test</span><br><span class="line">(integer) 5</span><br><span class="line">127.0.0.1:6379&gt; getbit not-test 0</span><br><span class="line">(integer) 0</span><br><span class="line">127.0.0.1:6379&gt; getbit not-test 1</span><br><span class="line">(integer) 0</span><br><span class="line">127.0.0.1:6379&gt; getbit not-test 2</span><br><span class="line">(integer) 0</span><br><span class="line">127.0.0.1:6379&gt; getbit not-test 3</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; getbit not-test 4</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; getbit not-test 5</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; getbit not-test 6</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; getbit not-test 7</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt;</span><br></pre></td></tr></table></figure></div>

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/redis2/25.png"
                     
                ></p>
<p>4）xor</p>
<p>异或（^），相同为0，不同为1</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; bitop xor xor-test test3 test4</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; getbit xor-test 0</span><br><span class="line">(integer) 0</span><br><span class="line">127.0.0.1:6379&gt; getbit xor-test 1</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; getbit xor-test 2</span><br><span class="line">(integer) 0</span><br><span class="line">127.0.0.1:6379&gt; getbit xor-test 3</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt;</span><br></pre></td></tr></table></figure></div>

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/redis2/26.png"
                     
                ></p>
<h3 id="7-1-3-bitmaps应用场景"><a href="#7-1-3-bitmaps应用场景" class="headerlink" title="7.1.3 bitmaps应用场景"></a>7.1.3 bitmaps应用场景</h3><ul>
<li>统计每天、每月网站的用户登录数量</li>
<li>统计每天、每月网站的用户访问数量</li>
<li>统计每天、每月文件被下载数</li>
<li>统计xxx-xxx时间内网站登录用户</li>
<li>统计本月未打卡人数</li>
<li>用于统计非真既假类的数据，不是0就是1</li>
<li>…….</li>
</ul>
<p>案例：统计周期内用户登录的人数</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">setbit 登录日期 用户id 是否登录</span><br></pre></td></tr></table></figure></div>



<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; setbit pv:2020-0101 0 1</span><br><span class="line">(integer) 0</span><br><span class="line">127.0.0.1:6379&gt; setbit pv:2020-0101 3 1</span><br><span class="line">(integer) 0</span><br><span class="line">127.0.0.1:6379&gt; setbit pv:2020-0101 6 1</span><br><span class="line">(integer) 0</span><br><span class="line">127.0.0.1:6379&gt; setbit pv:2020-0101 9 0</span><br><span class="line">(integer) 0</span><br><span class="line">127.0.0.1:6379&gt; setbit pv:2020-0102 2 1</span><br><span class="line">(integer) 0</span><br><span class="line">127.0.0.1:6379&gt; setbit pv:2020-0102 1 0</span><br><span class="line">(integer) 0</span><br><span class="line">127.0.0.1:6379&gt; setbit pv:2020-0102 8 1</span><br><span class="line">(integer) 0</span><br></pre></td></tr></table></figure></div>

<p>统计2020年1月1日到2020年1月2日有多少用户登录过。</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; bitop or pv:01-02 pv:2020-0101 pv:2020-0102</span><br><span class="line">(integer) 2</span><br><span class="line">127.0.0.1:6379&gt; bitcount pv:01-02</span><br><span class="line">(integer) 5</span><br><span class="line">127.0.0.1:6379&gt; </span><br></pre></td></tr></table></figure></div>

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/redis2/27.png"
                     
                ></p>
<h3 id="7-1-4-BitMap总结"><a href="#7-1-4-BitMap总结" class="headerlink" title="7.1.4 BitMap总结"></a>7.1.4 BitMap总结</h3><p>bitmap操作起来这么复杂，为什么我们还要使用它呢？</p>
<p>因为bitmap存储单位是”位”，咱们计算机最小的存储单位都是byte（字节），而一个字节是8个位，因此存储效率明显是bitmap高多了，而实际开发中id往往是Long类型进行存储（8个字节），8<em>8&#x3D;64。因此存储效率可想而知，但由于bitmap直接操作的是”位”，操作起来不方便，在开发中操作”位”给开发者带来一定的困难，需要花费一定的时间来操作，因此在数据结构的角度上来看，*<em>bitmap实质上是采取时间换空间的操作</em></em></p>
<ul>
<li>优点：存储效率高</li>
<li>缺点<ul>
<li>操作不便，给开发者带来一定的困难</li>
<li>setbit偏移量较高时，需要补零，造成redis阻塞（在此期间，redis主线程将会被阻塞）。</li>
</ul>
</li>
</ul>
<h2 id="7-2-HyperLogLog"><a href="#7-2-HyperLogLog" class="headerlink" title="7.2 HyperLogLog"></a>7.2 HyperLogLog</h2><h3 id="7-2-1-HyperLogLog简介"><a href="#7-2-1-HyperLogLog简介" class="headerlink" title="7.2.1 HyperLogLog简介"></a>7.2.1 HyperLogLog简介</h3><p>Redis 在 2.8.9 版本添加了 HyperLogLog 结构。</p>
<p>Redis HyperLogLog 是用来做基数统计的算法，HyperLogLog 的优点是，在输入元素的数量或者体积非常非常大时，计算基数所需的空间总是固定的、并且是很小的。</p>
<p>在 Redis 里面，每个 HyperLogLog 键只需要花费 12 KB 内存，就可以<strong>计算</strong>接近 2^64 个不同元素的基数。这和计算基数时，元素越多耗费内存就越多的集合形成鲜明对比。</p>
<p>但是，因为 HyperLogLog 只会根据输入元素来计算基数，而不会储存输入元素本身，所以 HyperLogLog 不能像集合那样，返回输入的各个元素。</p>
<p>HyperLogLog算法公式：<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/redis2/101.png"
                     
                ></p>
<h3 id="7-2-2-HyperLogLog命令"><a href="#7-2-2-HyperLogLog命令" class="headerlink" title="7.2.2 HyperLogLog命令"></a>7.2.2 HyperLogLog命令</h3><ul>
<li>添加数据</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pfadd key val [val ...]</span><br></pre></td></tr></table></figure></div>

<p>示例：</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; pfadd a1 0</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; pfadd a1 1</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; pfadd a1 1</span><br><span class="line">(integer) 0</span><br><span class="line">127.0.0.1:6379&gt; pfadd a1 2</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt;</span><br></pre></td></tr></table></figure></div>



<ul>
<li>统计数据：每个key同样的val只会统计一次</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pfcount key [key ...]</span><br></pre></td></tr></table></figure></div>

<p>示例：</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; pfcount a1</span><br><span class="line">(integer) 3</span><br><span class="line">127.0.0.1:6379&gt;</span><br></pre></td></tr></table></figure></div>



<ul>
<li>合并数据：将多个heperloglog合并在一起，同样的key的val只会保留一个</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pfmerge destkey sourcekey [sourcekey ....]</span><br></pre></td></tr></table></figure></div>

<p>示例：</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; pfadd a2 0</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; pfadd a2 1</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; pfadd a2 3</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; pfadd a2 3</span><br><span class="line">(integer) 0</span><br><span class="line">127.0.0.1:6379&gt; pfadd a2 4</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; pfadd a2 4</span><br><span class="line">(integer) 0</span><br><span class="line">127.0.0.1:6379&gt; pfmerge a3 a1 a2</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; pfcount a3</span><br><span class="line">(integer) 5</span><br><span class="line">127.0.0.1:6379&gt;</span><br></pre></td></tr></table></figure></div>



<h3 id="7-2-3-HyperLogLog总结"><a href="#7-2-3-HyperLogLog总结" class="headerlink" title="7.2.3 HyperLogLog总结"></a>7.2.3 HyperLogLog总结</h3><p><strong>应用场景：</strong>和bitmap相比，属于两种特定统计情况，简单来说，HyperLogLog 去重比 bitmap 方便很多</p>
<p>HyperLogLog有局限性，就是只能统计基数数量，而没办法去知道具体的内容是什么</p>
<ul>
<li>HyperLogLog是一种算法，并非redis独有</li>
<li>目的是做基数统计，不是集合，不会保存元数据，只记录数量而不是数值。耗空间极小，支持海量数据统计。</li>
<li>核心是基数<strong>估算算法</strong>，主要表现为计算时内存的使用和数据合并的处理。最终数值存在一定误差</li>
<li>误差说明：基数估计的结果是一个带有 0.81% 标准错误（standard error）的近似值。是可接受的范围</li>
<li>Redis 对 HyperLogLog 的存储进行了优化，pfadd命令并不是一次性分配12K内存使用，会随着基数的增加内存逐渐增大</li>
</ul>
<h2 id="7-3-GEO"><a href="#7-3-GEO" class="headerlink" title="7.3 GEO"></a>7.3 GEO</h2><h3 id="7-3-1-GEO简介"><a href="#7-3-1-GEO简介" class="headerlink" title="7.3.1 GEO简介"></a>7.3.1 GEO简介</h3><p>GEO是redis在3.2版本之后增加的针对于地理位置处理的一种数据类型。主要是用于存储坐标点的经度与维度、通过经度纬度计算两地距离等。</p>
<p><a class="link"   target="_blank" rel="noopener" href="http://api.map.baidu.com/lbsapi/getpoint/index.html" >拾取坐标系统 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/redis2/28.png"
                     
                ></p>
<h3 id="7-3-2-GEO命令"><a href="#7-3-2-GEO命令" class="headerlink" title="7.3.2 GEO命令"></a>7.3.2 GEO命令</h3><ul>
<li>添加坐标</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">geoadd key longitude latitude member [longitude latitude member ...]</span><br></pre></td></tr></table></figure></div>

<ul>
<li>longitude：经度</li>
<li>latitude：纬度</li>
<li>member：地点名称</li>
</ul>
<p>示例：获取”滕王阁”的经度纬度，添加到一个指定集合中。</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">geoadd nanchang 115.887667 28.687311 twg</span><br></pre></td></tr></table></figure></div>

<blockquote>
<p><a class="link"   target="_blank" rel="noopener" href="http://api.map.baidu.com/lbsapi/getpoint/index.html" >获取地点的经度纬度 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
</blockquote>
<ul>
<li>获取坐标点</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">geopos key member [member ...]</span><br></pre></td></tr></table></figure></div>

<p>示例：查看nanchang地理位置集合中twg的经度纬度</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; geopos nanchang twg</span><br><span class="line">1) 1) &quot;115.88766485452651978&quot;</span><br><span class="line">   2) &quot;28.6873112518150819&quot;</span><br><span class="line">127.0.0.1:6379&gt;</span><br></pre></td></tr></table></figure></div>

<ul>
<li>计算两点坐标</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GEODIST key member1 member2 [unit]</span><br></pre></td></tr></table></figure></div>

<ul>
<li>unit：单位<ul>
<li>km：千米</li>
<li>m：米（默认）</li>
<li>ml：英里</li>
<li>ft：尺</li>
</ul>
</li>
</ul>
<p>示例：添加”八一广场”经度纬度，并计算”滕王阁”与”八一广场”之间的距离</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; geoadd nanchang 115.910937 28.68009 bygc</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; geopos nanchang twg bygc</span><br><span class="line">1) 1) &quot;115.88766485452651978&quot;</span><br><span class="line">   2) &quot;28.6873112518150819&quot;</span><br><span class="line">2) 1) &quot;115.91093569993972778&quot;</span><br><span class="line">   2) &quot;28.68008983123212374&quot;</span><br><span class="line">127.0.0.1:6379&gt; geodist nanchang twg bygc</span><br><span class="line">&quot;2408.5712&quot;</span><br><span class="line">127.0.0.1:6379&gt;</span><br></pre></td></tr></table></figure></div>

<p>发现”滕王阁”与”八一广场”之间的距离为2408.5712米</p>
<ul>
<li>在指定位置集合中根据指定的经度纬度计算范围内的所有位置</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">georadius key longitude latitude radius m|km|ft|mi [WITHCOORD] [WITHDIST] [WITHHASH] [COUNT count] [ASC|DESC] </span><br></pre></td></tr></table></figure></div>

<ul>
<li>WITHCOORD：返回当前位置的经度纬度</li>
<li>WITHDIST：返回当前位置与中心位置之间的距离</li>
<li>WITHHASH：返回geohash编码</li>
<li>ASC：按离中心距离的位置排序（升序），DESC（降序）</li>
<li>COUNT：根据排序结构查询前几位</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/redis2/29.png"
                     
                ></p>
<p>如图所示，假设我们要以<strong>八一馆</strong>为中心，计算八一馆附近1000m的地方有那些位置。</p>
<p>1）先将所需要的计算的位置坐标（经度纬度）存储在同一个位置集合中（万寿宫、八一公园）</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; geoadd nanchang 115.892383 28.681013 wsg</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; geoadd nanchang 115.903594 28.684261 bygy</span><br><span class="line">(integer) 1</span><br></pre></td></tr></table></figure></div>

<p>2）选择一个坐标点为中心（八一馆），开始计算</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; georadius nanchang 115.898258 28.681615 500 m</span><br><span class="line">(empty list or set)</span><br><span class="line">127.0.0.1:6379&gt; georadius nanchang 115.898258 28.681615 1000 m</span><br><span class="line">1) &quot;wsg&quot;</span><br><span class="line">2) &quot;bygy&quot;</span><br><span class="line">127.0.0.1:6379&gt; georadius nanchang 115.898258 28.681615 2000 m</span><br><span class="line">1) &quot;wsg&quot;</span><br><span class="line">2) &quot;bygy&quot;</span><br><span class="line">3) &quot;twg&quot;</span><br><span class="line">4) &quot;bygc&quot;</span><br><span class="line">127.0.0.1:6379&gt; georadius nanchang 115.898258 28.681615 1500 m</span><br><span class="line">1) &quot;wsg&quot;</span><br><span class="line">2) &quot;bygy&quot;</span><br><span class="line">3) &quot;twg&quot;</span><br><span class="line">4) &quot;bygc&quot;</span><br><span class="line">127.0.0.1:6379&gt; georadius nanchang 115.898258 28.681615 1300 m</span><br><span class="line">1) &quot;wsg&quot;</span><br><span class="line">2) &quot;bygy&quot;</span><br><span class="line">3) &quot;twg&quot;</span><br><span class="line">4) &quot;bygc&quot;</span><br><span class="line">127.0.0.1:6379&gt;</span><br></pre></td></tr></table></figure></div>

<p>选择额外参数：</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; georadius nanchang 115.898258 28.681615 1000 m withhash</span><br><span class="line">1) 1) &quot;wsg&quot;</span><br><span class="line">   2) (integer) 4051506209236249</span><br><span class="line">2) 1) &quot;bygy&quot;</span><br><span class="line">   2) (integer) 4051506218741151</span><br><span class="line">127.0.0.1:6379&gt; georadius nanchang 115.898258 28.681615 1000 m withcoord</span><br><span class="line">1) 1) &quot;wsg&quot;</span><br><span class="line">   2) 1) &quot;115.89238554239273071&quot;</span><br><span class="line">      2) &quot;28.68101246973412088&quot;</span><br><span class="line">2) 1) &quot;bygy&quot;</span><br><span class="line">   2) 1) &quot;115.9035918116569519&quot;</span><br><span class="line">      2) &quot;28.68426198226040214&quot;</span><br><span class="line">127.0.0.1:6379&gt; georadius nanchang 115.898258 28.681615 1000 m withcoord asc withdist</span><br><span class="line">1) 1) &quot;wsg&quot;</span><br><span class="line">   2) &quot;576.9350&quot;</span><br><span class="line">   3) 1) &quot;115.89238554239273071&quot;</span><br><span class="line">      2) &quot;28.68101246973412088&quot;</span><br><span class="line">2) 1) &quot;bygy&quot;</span><br><span class="line">   2) &quot;597.9623&quot;</span><br><span class="line">   3) 1) &quot;115.9035918116569519&quot;</span><br><span class="line">      2) &quot;28.68426198226040214&quot;</span><br><span class="line">127.0.0.1:6379&gt; georadius nanchang 115.898258 28.681615 1000 m withcoord desc withdist</span><br><span class="line">1) 1) &quot;bygy&quot;</span><br><span class="line">   2) &quot;597.9623&quot;</span><br><span class="line">   3) 1) &quot;115.9035918116569519&quot;</span><br><span class="line">      2) &quot;28.68426198226040214&quot;</span><br><span class="line">2) 1) &quot;wsg&quot;</span><br><span class="line">   2) &quot;576.9350&quot;</span><br><span class="line">   3) 1) &quot;115.89238554239273071&quot;</span><br><span class="line">      2) &quot;28.68101246973412088&quot;</span><br><span class="line">127.0.0.1:6379&gt;</span><br></pre></td></tr></table></figure></div>



<ul>
<li>和georadius类似，georadiusbymember命令是以<strong>位置集合中某个位置为中心</strong>来查询范围内的位置</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">georadiusbymember key longitude latitude radius m|km|ft|mi [WITHCOORD] [WITHDIST] [WITHHASH] [COUNT count] [ASC|DESC] </span><br></pre></td></tr></table></figure></div>

<p>示例：添加八一馆到nanchang位置集合中，然后以八一馆为中心，查询附近1000m有哪些坐标</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; geoadd nanchang 115.898222 28.681679 byg</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; GEORADIUSBYMEMBER nanchang byg 1000 m</span><br><span class="line">1) &quot;wsg&quot;</span><br><span class="line">2) &quot;byg&quot;</span><br><span class="line">3) &quot;bygy&quot;</span><br><span class="line">127.0.0.1:6379&gt; GEORADIUSBYMEMBER nanchang byg 1200 m</span><br><span class="line">1) &quot;wsg&quot;</span><br><span class="line">2) &quot;byg&quot;</span><br><span class="line">3) &quot;bygy&quot;</span><br><span class="line">127.0.0.1:6379&gt; GEORADIUSBYMEMBER nanchang byg 1210 m</span><br><span class="line">1) &quot;wsg&quot;</span><br><span class="line">2) &quot;byg&quot;</span><br><span class="line">3) &quot;bygy&quot;</span><br><span class="line">4) &quot;twg&quot;</span><br><span class="line">127.0.0.1:6379&gt;</span><br></pre></td></tr></table></figure></div>

<p>选择额外参数：</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; GEORADIUSBYMEMBER nanchang byg 1000 m</span><br><span class="line">1) &quot;wsg&quot;</span><br><span class="line">2) &quot;byg&quot;</span><br><span class="line">3) &quot;bygy&quot;</span><br><span class="line">127.0.0.1:6379&gt; GEORADIUSBYMEMBER nanchang byg 1000 m withcoord withdist</span><br><span class="line">1) 1) &quot;wsg&quot;</span><br><span class="line">   2) &quot;574.3256&quot;</span><br><span class="line">   3) 1) &quot;115.89238554239273071&quot;</span><br><span class="line">      2) &quot;28.68101246973412088&quot;</span><br><span class="line">2) 1) &quot;byg&quot;</span><br><span class="line">   2) &quot;0.0000&quot;</span><br><span class="line">   3) 1) &quot;115.89822202920913696&quot;</span><br><span class="line">      2) &quot;28.68167910139903398&quot;</span><br><span class="line">3) 1) &quot;bygy&quot;</span><br><span class="line">   2) &quot;597.5594&quot;</span><br><span class="line">   3) 1) &quot;115.9035918116569519&quot;</span><br><span class="line">      2) &quot;28.68426198226040214&quot;</span><br><span class="line">127.0.0.1:6379&gt; GEORADIUSBYMEMBER nanchang byg 1000 m withcoord withdist desc</span><br><span class="line">1) 1) &quot;bygy&quot;</span><br><span class="line">   2) &quot;597.5594&quot;</span><br><span class="line">   3) 1) &quot;115.9035918116569519&quot;</span><br><span class="line">      2) &quot;28.68426198226040214&quot;</span><br><span class="line">2) 1) &quot;wsg&quot;</span><br><span class="line">   2) &quot;574.3256&quot;</span><br><span class="line">   3) 1) &quot;115.89238554239273071&quot;</span><br><span class="line">      2) &quot;28.68101246973412088&quot;</span><br><span class="line">3) 1) &quot;byg&quot;</span><br><span class="line">   2) &quot;0.0000&quot;</span><br><span class="line">   3) 1) &quot;115.89822202920913696&quot;</span><br><span class="line">      2) &quot;28.68167910139903398&quot;</span><br><span class="line">127.0.0.1:6379&gt;</span><br></pre></td></tr></table></figure></div>



<h1 id="八、Redis的配置"><a href="#八、Redis的配置" class="headerlink" title="八、Redis的配置"></a>八、Redis的配置</h1><h2 id="8-1-redis性能监控"><a href="#8-1-redis性能监控" class="headerlink" title="8.1 redis性能监控"></a>8.1 redis性能监控</h2><ul>
<li>查看服务器的配置信息</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">info [section]</span><br></pre></td></tr></table></figure></div>

<ul>
<li>Server：服务器的一些配置信息</li>
<li>Clients：客户端连接信息</li>
<li>Memory：内存分配信息</li>
<li>Persistence：持久化配置</li>
<li>Stats：redis服务器的状态信息</li>
<li>Replication：主从配置信息</li>
<li>CPU：CPU</li>
<li>Keyspace：redis各个数据库key的统计信息</li>
</ul>
<p>主要配置如下：</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; info</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Server</span></span><br><span class="line">redis_version:4.0.11							# redis版本</span><br><span class="line">redis_git_sha1:00000000</span><br><span class="line">redis_git_dirty:0</span><br><span class="line">redis_build_id:d1094041d1d2201e</span><br><span class="line">redis_mode:standalone</span><br><span class="line">os:Linux 3.10.0-1062.el7.x86_64 x86_64</span><br><span class="line">arch_bits:64</span><br><span class="line">multiplexing_api:epoll</span><br><span class="line">atomicvar_api:atomic-builtin</span><br><span class="line">gcc_version:4.8.5								# 当前GCC的版本</span><br><span class="line">process_id:1745									# 当前redis服务器的进程id</span><br><span class="line">run_id:d3567fd2538829ae27a70999d35799f386321eff</span><br><span class="line">tcp_port:6379									# redis服务器端口 </span><br><span class="line">uptime_in_seconds:2795							# 当前redis服务器运行了多长时间(秒)</span><br><span class="line">uptime_in_days:0								# 当前redis服务器运行了多长时间(天)</span><br><span class="line">hz:10											# 定期删除策略时每秒轮询serverCron()的次数</span><br><span class="line">lru_clock:8760639</span><br><span class="line">executable:/root/redis-4.0.11/src/./redis-server	# redis服务器的可执行文件的目录</span><br><span class="line">config_file:/root/redis-4.0.11/config/redis-6379.conf	# 本次redis服务器启动时配置文件的所在目录</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Clients</span></span><br><span class="line">connected_clients:1						# 客户端连接的数量</span><br><span class="line">client_longest_output_list:0</span><br><span class="line">client_biggest_input_buf:0</span><br><span class="line">blocked_clients:0				# 当前客户端正在排队的阻塞命令的数量(save、blpop、brpop...)					</span><br><span class="line"><span class="meta prompt_">	</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Memory</span></span><br><span class="line">used_memory:849800				# redis分配的内存总量(单位：byte)</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">redis分配的内存总量,单位随着内存总量的大小而变化(我这里显示的是k)</span></span><br><span class="line">used_memory_human:829.88K		</span><br><span class="line">used_memory_rss:8228864			# redis分配的内存总量,包含内存碎片(byte)</span><br><span class="line">used_memory_rss_human:7.85M		# redis分配的内存总量,包含内存碎片(单位随之变化,我这里是m)</span><br><span class="line">used_memory_peak:849800			# redis可使用内存的峰值大小</span><br><span class="line">used_memory_peak_human:829.88K	# redis可使用内存的峰值大小(单位随之变化,我这里是k)</span><br><span class="line">used_memory_peak_perc:100.00%</span><br><span class="line">used_memory_overhead:836294</span><br><span class="line">used_memory_startup:786552</span><br><span class="line">used_memory_dataset:13506</span><br><span class="line">used_memory_dataset_perc:21.35%</span><br><span class="line">total_system_memory:1019645952</span><br><span class="line">total_system_memory_human:972.41M</span><br><span class="line">used_memory_lua:37888</span><br><span class="line">used_memory_lua_human:37.00K</span><br><span class="line">maxmemory_policy:noeviction</span><br><span class="line">mem_fragmentation_ratio:9.68	# 内存碎片比率 (used_memory_rss/used_memory)</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Redis使用的内存分配器,可以是libc、jemalloc、tcmalloc，默认是jemalloc</span></span><br><span class="line">mem_allocator:jemalloc-4.0.3	</span><br><span class="line">active_defrag_running:0</span><br><span class="line">lazyfree_pending_objects:0</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Persistence</span></span><br><span class="line">loading:0</span><br><span class="line">rdb_changes_since_last_save:2		# 上一次数据库进行保存之后,执行命令的次数</span><br><span class="line">rdb_bgsave_in_progress:0			# 后台正在进行bgsave的操作数量</span><br><span class="line">rdb_last_save_time:1585816148		# 距离上一次保存成功的时间(时间戳)</span><br><span class="line">rdb_last_bgsave_status:ok			# 最后一次执行bgsave的状态</span><br><span class="line">rdb_last_bgsave_time_sec:-1			# 最后一次创建rdb花费的秒数</span><br><span class="line">rdb_current_bgsave_time_sec:-1		</span><br><span class="line">rdb_last_cow_size:0</span><br><span class="line">aof_enabled:1						# redis是否开启了aof</span><br><span class="line">aof_rewrite_in_progress:0			# aof后台执行重写的进程数</span><br><span class="line">aof_rewrite_scheduled:0				</span><br><span class="line">aof_last_rewrite_time_sec:-1		# 最后一次重写花费的秒数</span><br><span class="line">aof_current_rewrite_time_sec:-1</span><br><span class="line">aof_last_bgrewrite_status:ok		# 最后一次执行bgrewrite的状态</span><br><span class="line">aof_last_write_status:ok			# 最后一次执行write的状态</span><br><span class="line">aof_last_cow_size:0</span><br><span class="line">aof_current_size:150				# 当前aof文件大小(byte)</span><br><span class="line">aof_base_size:90					# 上一次aof重写完之后文件的大小</span><br><span class="line">aof_pending_rewrite:0</span><br><span class="line">aof_buffer_length:0					# aof缓冲区大小</span><br><span class="line">aof_rewrite_buffer_length:0</span><br><span class="line">aof_pending_bio_fsync:0</span><br><span class="line">aof_delayed_fsync:0</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Stats</span></span><br><span class="line">total_connections_received:2		# 服务器已接受的连接请求次数</span><br><span class="line">total_commands_processed:12			# 服务器已执行命令的数量</span><br><span class="line">instantaneous_ops_per_sec:0</span><br><span class="line">total_net_input_bytes:297</span><br><span class="line">total_net_output_bytes:34096</span><br><span class="line">instantaneous_input_kbps:0.01</span><br><span class="line">instantaneous_output_kbps:6.20</span><br><span class="line">rejected_connections:0</span><br><span class="line">sync_full:0</span><br><span class="line">sync_partial_ok:0</span><br><span class="line">sync_partial_err:0</span><br><span class="line">expired_keys:0						# 过期删除key的数量</span><br><span class="line">expired_stale_perc:0.00				# 因最大内存容量显示而被淘汰的key的数量</span><br><span class="line">expired_time_cap_reached_count:0</span><br><span class="line">evicted_keys:0</span><br><span class="line">keyspace_hits:0</span><br><span class="line">keyspace_misses:0</span><br><span class="line">pubsub_channels:0					# 订阅的频道数量</span><br><span class="line">pubsub_patterns:0					# 订阅的模式数量</span><br><span class="line">latest_fork_usec:0					# 最后一次执行fork函数所花费的时间</span><br><span class="line">migrate_cached_sockets:0</span><br><span class="line">slave_expires_tracked_keys:0</span><br><span class="line">active_defrag_hits:0</span><br><span class="line">active_defrag_misses:0</span><br><span class="line">active_defrag_key_hits:0</span><br><span class="line">active_defrag_key_misses:0</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Replication</span></span><br><span class="line">role:master					# 当前服务器的角色(master/slave)</span><br><span class="line">connected_slaves:0			# 有多少个slave服务器连接</span><br><span class="line">master_replid:e2b32d0c2e45dd2156091608dbd3d48966635439</span><br><span class="line">master_replid2:0000000000000000000000000000000000000000</span><br><span class="line">master_repl_offset:0</span><br><span class="line">second_repl_offset:-1</span><br><span class="line">repl_backlog_active:0</span><br><span class="line">repl_backlog_size:1048576</span><br><span class="line">repl_backlog_first_byte_offset:0</span><br><span class="line">repl_backlog_histlen:0</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">CPU</span></span><br><span class="line">used_cpu_sys:1.44			</span><br><span class="line">used_cpu_user:0.69</span><br><span class="line">used_cpu_sys_children:0.00</span><br><span class="line">used_cpu_user_children:0.00</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Cluster</span></span><br><span class="line">cluster_enabled:0			# 标志是否是集群模式</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Keyspace</span></span><br><span class="line">db0:keys=2,expires=0,avg_ttl=0		# keys:各数据库key的数量 expires:带有过期时间的key的数量 avg_ttl:所有带过期时间的key的平均过期时间(单位：秒)</span><br><span class="line">127.0.0.1:6379&gt; </span><br></pre></td></tr></table></figure></div>

<p>包含有Server、Clients、Memory、Persistence、Stats、Replication、CPU、Keyspace等8个部分</p>
<p>只查看server组的信息：</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">info server</span><br></pre></td></tr></table></figure></div>

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/redis2/31.png"
                     
                ></p>
<h2 id="8-2-模拟并发请求测压"><a href="#8-2-模拟并发请求测压" class="headerlink" title="8.2 模拟并发请求测压"></a>8.2 模拟并发请求测压</h2><p>在redis服务器搭建好了之后，我们可以使用一些测压工具来测试单台redis的压力性能情况如何。市面上有非常多的测压工具，我们使用redis自带的<strong>redis-benchmark</strong>命令来检测redis压力</p>
<p>输入命令：</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-benchmark [option] [option value]</span><br></pre></td></tr></table></figure></div>

<p>直接执行默认开启50个连接，10W个请求。</p>
<p>具体参数如下：</p>
<table>
<thead>
<tr>
<th></th>
<th></th>
<th></th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td><strong>-h</strong></td>
<td>指定服务器主机名</td>
<td>127.0.0.1</td>
</tr>
<tr>
<td>2</td>
<td><strong>-p</strong></td>
<td>指定服务器端口</td>
<td>6379</td>
</tr>
<tr>
<td>3</td>
<td><strong>-s</strong></td>
<td>指定服务器 socket</td>
<td></td>
</tr>
<tr>
<td>4</td>
<td><strong>-c</strong></td>
<td>指定并发连接数</td>
<td>50</td>
</tr>
<tr>
<td>5</td>
<td><strong>-n</strong></td>
<td>指定请求数</td>
<td>100000</td>
</tr>
<tr>
<td>6</td>
<td><strong>-d</strong></td>
<td>以字节的形式指定 SET&#x2F;GET 值的数据大小</td>
<td>2</td>
</tr>
<tr>
<td>7</td>
<td><strong>-k</strong></td>
<td>1&#x3D;keep alive 0&#x3D;reconnect</td>
<td>1</td>
</tr>
<tr>
<td>8</td>
<td><strong>-r</strong></td>
<td>SET&#x2F;GET&#x2F;INCR 使用随机 key, SADD 使用随机值</td>
<td></td>
</tr>
<tr>
<td>9</td>
<td><strong>-P</strong></td>
<td>通过管道传输 <numreq> 请求</td>
<td>1</td>
</tr>
<tr>
<td>10</td>
<td><strong>-q</strong></td>
<td>强制退出 redis。仅显示 query&#x2F;sec 值</td>
<td></td>
</tr>
<tr>
<td>11</td>
<td><strong>–csv</strong></td>
<td>以 CSV 格式输出</td>
<td></td>
</tr>
<tr>
<td>12</td>
<td><strong>-l</strong></td>
<td>生成循环，永久执行测试</td>
<td></td>
</tr>
<tr>
<td>13</td>
<td><strong>-t</strong></td>
<td>仅运行以逗号分隔的测试命令列表。</td>
<td></td>
</tr>
<tr>
<td>14</td>
<td><strong>-I</strong></td>
<td>Idle 模式。仅打开 N 个 idle 连接并等待。</td>
<td></td>
</tr>
</tbody></table>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/redis2/65.png"
                     
                ></p>
<h2 id="8-3-redis配置指令"><a href="#8-3-redis配置指令" class="headerlink" title="8.3 redis配置指令"></a>8.3 redis配置指令</h2><h3 id="8-2-1-config指令"><a href="#8-2-1-config指令" class="headerlink" title="8.2.1 config指令"></a>8.2.1 config指令</h3><ul>
<li>查看redis服务器当前配置信息</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">config get parameter</span><br></pre></td></tr></table></figure></div>

<ul>
<li>parameter：查看具体的某个配置，*代表查看当前redis服务器的所有配置信息（包括默认配置）</li>
</ul>
<p>示例：</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; config get *</span><br><span class="line">  1) &quot;dbfilename&quot;</span><br><span class="line">  2) &quot;drum-6379.rdb&quot;</span><br><span class="line">  3) &quot;requirepass&quot;</span><br><span class="line">  4) &quot;&quot;</span><br><span class="line">  5) &quot;masterauth&quot;</span><br><span class="line">  6) &quot;&quot;</span><br><span class="line">  7) &quot;cluster-announce-ip&quot;</span><br><span class="line">  8) &quot;&quot;</span><br><span class="line">  9) &quot;unixsocket&quot;</span><br><span class="line"> 10) &quot;&quot;</span><br><span class="line"> 11) &quot;logfile&quot;</span><br><span class="line"> 12) &quot;&quot;</span><br><span class="line"> 13) &quot;pidfile&quot;</span><br><span class="line"> 14) &quot;&quot;</span><br><span class="line"> 15) &quot;slave-announce-ip&quot;</span><br><span class="line"> 16) &quot;&quot;</span><br><span class="line"> 17) &quot;maxmemory&quot;</span><br><span class="line"> 18) &quot;0&quot;</span><br><span class="line"> 19) &quot;proto-max-bulk-len&quot;</span><br><span class="line"> 20) &quot;536870912&quot;</span><br><span class="line"> 21) &quot;client-query-buffer-limit&quot;</span><br><span class="line"> 22) &quot;1073741824&quot;</span><br><span class="line"> 23) &quot;maxmemory-samples&quot;</span><br><span class="line"> 24) &quot;5&quot;</span><br><span class="line"> 25) &quot;lfu-log-factor&quot;</span><br><span class="line"> 26) &quot;10&quot;</span><br><span class="line"> 27) &quot;lfu-decay-time&quot;</span><br><span class="line"> 28) &quot;1&quot;</span><br><span class="line"> 29) &quot;timeout&quot;</span><br><span class="line"> 30) &quot;0&quot;</span><br><span class="line"> 31) &quot;active-defrag-threshold-lower&quot;</span><br><span class="line"> 32) &quot;10&quot;</span><br><span class="line"> 33) &quot;active-defrag-threshold-upper&quot;</span><br><span class="line"> 34) &quot;100&quot;</span><br><span class="line"> 35) &quot;active-defrag-ignore-bytes&quot;</span><br><span class="line"> 36) &quot;104857600&quot;</span><br><span class="line"> 37) &quot;active-defrag-cycle-min&quot;</span><br><span class="line"> 38) &quot;25&quot;</span><br><span class="line"> 39) &quot;active-defrag-cycle-max&quot;</span><br><span class="line"> 40) &quot;75&quot;</span><br><span class="line"> 41) &quot;auto-aof-rewrite-percentage&quot;</span><br><span class="line"> 42) &quot;100&quot;</span><br><span class="line"> 43) &quot;auto-aof-rewrite-min-size&quot;</span><br><span class="line"> 44) &quot;200&quot;</span><br><span class="line"> 45) &quot;hash-max-ziplist-entries&quot;</span><br><span class="line"> 46) &quot;512&quot;</span><br><span class="line"> 47) &quot;hash-max-ziplist-value&quot;</span><br><span class="line"> 48) &quot;64&quot;</span><br><span class="line"> 49) &quot;list-max-ziplist-size&quot;</span><br><span class="line"> 50) &quot;-2&quot;</span><br><span class="line"> 51) &quot;list-compress-depth&quot;</span><br><span class="line"> 52) &quot;0&quot;</span><br><span class="line"> 53) &quot;set-max-intset-entries&quot;</span><br><span class="line"> 54) &quot;512&quot;</span><br><span class="line"> 55) &quot;zset-max-ziplist-entries&quot;</span><br><span class="line"> 56) &quot;128&quot;</span><br><span class="line"> 57) &quot;zset-max-ziplist-value&quot;</span><br><span class="line"> 58) &quot;64&quot;</span><br><span class="line"> 59) &quot;hll-sparse-max-bytes&quot;</span><br><span class="line"> 60) &quot;3000&quot;</span><br><span class="line"> 61) &quot;lua-time-limit&quot;</span><br><span class="line"> 62) &quot;5000&quot;</span><br><span class="line"> 63) &quot;slowlog-log-slower-than&quot;</span><br><span class="line"> 64) &quot;10000&quot;</span><br><span class="line"> 65) &quot;latency-monitor-threshold&quot;</span><br><span class="line"> 66) &quot;0&quot;</span><br><span class="line"> 67) &quot;slowlog-max-len&quot;</span><br><span class="line"> 68) &quot;128&quot;</span><br><span class="line"> 69) &quot;port&quot;</span><br><span class="line"> 70) &quot;6379&quot;</span><br><span class="line"> 71) &quot;cluster-announce-port&quot;</span><br><span class="line"> 72) &quot;0&quot;</span><br><span class="line"> 73) &quot;cluster-announce-bus-port&quot;</span><br><span class="line"> 74) &quot;0&quot;</span><br><span class="line"> 75) &quot;tcp-backlog&quot;</span><br><span class="line"> 76) &quot;511&quot;</span><br><span class="line"> 77) &quot;databases&quot;</span><br><span class="line"> 78) &quot;16&quot;</span><br><span class="line"> 79) &quot;repl-ping-slave-period&quot;</span><br><span class="line"> 80) &quot;10&quot;</span><br><span class="line"> 81) &quot;repl-timeout&quot;</span><br><span class="line"> 82) &quot;60&quot;</span><br><span class="line"> 83) &quot;repl-backlog-size&quot;</span><br><span class="line"> 84) &quot;1048576&quot;</span><br><span class="line"> 85) &quot;repl-backlog-ttl&quot;</span><br><span class="line"> 86) &quot;3600&quot;</span><br><span class="line"> 87) &quot;maxclients&quot;</span><br><span class="line"> 88) &quot;10000&quot;</span><br><span class="line"> 89) &quot;watchdog-period&quot;</span><br><span class="line"> 90) &quot;0&quot;</span><br><span class="line"> 91) &quot;slave-priority&quot;</span><br><span class="line"> 92) &quot;100&quot;</span><br><span class="line"> 93) &quot;slave-announce-port&quot;</span><br><span class="line"> 94) &quot;0&quot;</span><br><span class="line"> 95) &quot;min-slaves-to-write&quot;</span><br><span class="line"> 96) &quot;0&quot;</span><br><span class="line"> 97) &quot;min-slaves-max-lag&quot;</span><br><span class="line"> 98) &quot;10&quot;</span><br><span class="line"> 99) &quot;hz&quot;</span><br><span class="line">100) &quot;10&quot;</span><br><span class="line">101) &quot;cluster-node-timeout&quot;</span><br><span class="line">102) &quot;15000&quot;</span><br><span class="line">103) &quot;cluster-migration-barrier&quot;</span><br><span class="line">104) &quot;1&quot;</span><br><span class="line">105) &quot;cluster-slave-validity-factor&quot;</span><br><span class="line">106) &quot;10&quot;</span><br><span class="line">107) &quot;repl-diskless-sync-delay&quot;</span><br><span class="line">108) &quot;5&quot;</span><br><span class="line">109) &quot;tcp-keepalive&quot;</span><br><span class="line">110) &quot;300&quot;</span><br><span class="line">111) &quot;cluster-require-full-coverage&quot;</span><br><span class="line">112) &quot;yes&quot;</span><br><span class="line">113) &quot;cluster-slave-no-failover&quot;</span><br><span class="line">114) &quot;no&quot;</span><br><span class="line">115) &quot;no-appendfsync-on-rewrite&quot;</span><br><span class="line">116) &quot;no&quot;</span><br><span class="line">117) &quot;slave-serve-stale-data&quot;</span><br><span class="line">118) &quot;yes&quot;</span><br><span class="line">119) &quot;slave-read-only&quot;</span><br><span class="line">120) &quot;yes&quot;</span><br><span class="line">121) &quot;stop-writes-on-bgsave-error&quot;</span><br><span class="line">122) &quot;yes&quot;</span><br><span class="line">123) &quot;daemonize&quot;</span><br><span class="line">124) &quot;no&quot;</span><br><span class="line">125) &quot;rdbcompression&quot;</span><br><span class="line">126) &quot;yes&quot;</span><br><span class="line">127) &quot;rdbchecksum&quot;</span><br><span class="line">128) &quot;yes&quot;</span><br><span class="line">129) &quot;activerehashing&quot;</span><br><span class="line">130) &quot;yes&quot;</span><br><span class="line">131) &quot;activedefrag&quot;</span><br><span class="line">132) &quot;no&quot;</span><br><span class="line">133) &quot;protected-mode&quot;</span><br><span class="line">134) &quot;yes&quot;</span><br><span class="line">135) &quot;repl-disable-tcp-nodelay&quot;</span><br><span class="line">136) &quot;no&quot;</span><br><span class="line">137) &quot;repl-diskless-sync&quot;</span><br><span class="line">138) &quot;no&quot;</span><br><span class="line">139) &quot;aof-rewrite-incremental-fsync&quot;</span><br><span class="line">140) &quot;yes&quot;</span><br><span class="line">141) &quot;aof-load-truncated&quot;</span><br><span class="line">142) &quot;yes&quot;</span><br><span class="line">143) &quot;aof-use-rdb-preamble&quot;</span><br><span class="line">144) &quot;no&quot;</span><br><span class="line">145) &quot;lazyfree-lazy-eviction&quot;</span><br><span class="line">146) &quot;no&quot;</span><br><span class="line">147) &quot;lazyfree-lazy-expire&quot;</span><br><span class="line">148) &quot;no&quot;</span><br><span class="line">149) &quot;lazyfree-lazy-server-del&quot;</span><br><span class="line">150) &quot;no&quot;</span><br><span class="line">151) &quot;slave-lazy-flush&quot;</span><br><span class="line">152) &quot;no&quot;</span><br><span class="line">153) &quot;maxmemory-policy&quot;</span><br><span class="line">154) &quot;noeviction&quot;</span><br><span class="line">155) &quot;loglevel&quot;</span><br><span class="line">156) &quot;notice&quot;</span><br><span class="line">157) &quot;supervised&quot;</span><br><span class="line">158) &quot;no&quot;</span><br><span class="line">159) &quot;appendfsync&quot;</span><br><span class="line">160) &quot;everysec&quot;</span><br><span class="line">161) &quot;syslog-facility&quot;</span><br><span class="line">162) &quot;local0&quot;</span><br><span class="line">163) &quot;appendonly&quot;</span><br><span class="line">164) &quot;yes&quot;</span><br><span class="line">165) &quot;dir&quot;</span><br><span class="line">166) &quot;/root/redis-4.0.11/data&quot;</span><br><span class="line">167) &quot;save&quot;</span><br><span class="line">168) &quot;&quot;</span><br><span class="line">169) &quot;client-output-buffer-limit&quot;</span><br><span class="line">170) &quot;normal 0 0 0 slave 268435456 67108864 60 pubsub 33554432 8388608 60&quot;</span><br><span class="line">171) &quot;unixsocketperm&quot;</span><br><span class="line">172) &quot;0&quot;</span><br><span class="line">173) &quot;slaveof&quot;</span><br><span class="line">174) &quot;&quot;</span><br><span class="line">175) &quot;notify-keyspace-events&quot;</span><br><span class="line">176) &quot;&quot;</span><br><span class="line">177) &quot;bind&quot;</span><br><span class="line">178) &quot;127.0.0.1&quot;</span><br><span class="line">127.0.0.1:6379&gt;</span><br></pre></td></tr></table></figure></div>

<p>查看具体某个配置：</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; config get hz</span><br><span class="line">1) &quot;hz&quot;</span><br><span class="line">2) &quot;10&quot;</span><br><span class="line">127.0.0.1:6379&gt; </span><br></pre></td></tr></table></figure></div>



<ul>
<li>修改配置文件命令</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">config set parameter value</span><br></pre></td></tr></table></figure></div>

<p>示例：</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; config set hz 2</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; config get hz</span><br><span class="line">1) &quot;hz&quot;</span><br><span class="line">2) &quot;2&quot;</span><br><span class="line">127.0.0.1:6379&gt;</span><br></pre></td></tr></table></figure></div>

<p>注意：<code>config set</code> 命令只在当前redis服务器中有用，如果redis服务器重启之后配置将会清除</p>
<p>如果需要写入到配置文件里面去，使用如下命令：</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">config rewrite</span><br></pre></td></tr></table></figure></div>

<h3 id="8-2-2-常用配置说明"><a href="#8-2-2-常用配置说明" class="headerlink" title="8.2.2 常用配置说明"></a>8.2.2 常用配置说明</h3><div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">bind 127.0.0.1		# 只允许127.0.0.1 redis客户端来连接此服务器(0.0.0.0代表允许所有redis客户端)</span><br><span class="line">port 6379			# redis服务器的端口</span><br><span class="line">loglevel debug		# 日志等级 debug|verbose|notice|warning</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">logfile <span class="string">&quot;6379.log&quot;</span>	<span class="comment"># redis日志文件名称</span></span></span><br><span class="line">dir &quot;/root/redis-4.0.11/data&quot;	# redis数据存储位置(aof、rdb、日志文件等)</span><br><span class="line">dbfilename &quot;drum-6379.rdb&quot;		# rdb文件名称</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">save 10 2						<span class="comment"># rdb持久化策略(10秒内有2个key发生变化就持久化一次)</span></span></span><br><span class="line">daemonize no					# redis服务器是否在后台启动(yes:是,no:不是)</span><br><span class="line">appendonly yes					# 是否开aof持久化</span><br><span class="line">appendfsync everysec			# aof 持久化策略(always:每次,everysec:每秒,no:系统控制)</span><br><span class="line">appendfilename &quot;appendonly-6379.aof&quot;	# aof文件名称</span><br><span class="line">maxmemory 1024					# redis最大内存(单位字节)</span><br><span class="line">hz 2							# 执行serverCron()轮询函数频率</span><br><span class="line">include /root/test.conf			# 加载其他目录下的配置文件</span><br></pre></td></tr></table></figure></div>



<h3 id="8-2-3-config-指令注意事项"><a href="#8-2-3-config-指令注意事项" class="headerlink" title="8.2.3 config 指令注意事项"></a>8.2.3 config 指令注意事项</h3><p><code>config set</code>命令并不是所有的命令都可以设置的，例如：</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; config set bind 192.168.170.145</span><br><span class="line">(error) ERR Unsupported CONFIG parameter: bind</span><br><span class="line">127.0.0.1:6379&gt;</span><br></pre></td></tr></table></figure></div>

<p>我们修改bind发现redis报错：<code>ERR Unsupported CONFIG parameter: bind</code>，说不支持此参数。在redis的参数配置中有些参数config set命令是不能设置的，必须要在配置文件中设置。</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>能否使用config set设置</th>
</tr>
</thead>
<tbody><tr>
<td>appendonly</td>
<td>yes</td>
</tr>
<tr>
<td>maxmemory</td>
<td>yes</td>
</tr>
<tr>
<td>maxmemory-policy</td>
<td>yes</td>
</tr>
<tr>
<td>dbfilename</td>
<td>yes</td>
</tr>
<tr>
<td>loglevel</td>
<td>yes</td>
</tr>
<tr>
<td>requirepass</td>
<td>yes</td>
</tr>
<tr>
<td>appendfilename</td>
<td>no</td>
</tr>
<tr>
<td>databases</td>
<td>no</td>
</tr>
<tr>
<td>save</td>
<td>no</td>
</tr>
<tr>
<td>bind</td>
<td>no</td>
</tr>
<tr>
<td>dir</td>
<td>no</td>
</tr>
<tr>
<td>logfile</td>
<td>no</td>
</tr>
<tr>
<td>daemonize</td>
<td>no</td>
</tr>
<tr>
<td>port</td>
<td>no</td>
</tr>
<tr>
<td>appendonly</td>
<td>yes</td>
</tr>
<tr>
<td>appendfsync</td>
<td>yes</td>
</tr>
<tr>
<td>maxmemory</td>
<td>yes</td>
</tr>
<tr>
<td>hz</td>
<td>yes</td>
</tr>
<tr>
<td>include</td>
<td>no</td>
</tr>
<tr>
<td>slaveof</td>
<td>no</td>
</tr>
</tbody></table>
<h3 id="8-2-4-redis启动命令携带"><a href="#8-2-4-redis启动命令携带" class="headerlink" title="8.2.4 redis启动命令携带"></a>8.2.4 redis启动命令携带</h3><p>redis服务器在启动时可以携带一系列参数命令，此次携带的参数只在本次redis服务器启动生效，不会记录到配置文件中，并且<strong>权重比配置文件要高</strong></p>
<p>示例：</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./redis-server ../config/redis-6379.conf --requirepass admin --port 6378 </span><br></pre></td></tr></table></figure></div>

<p>redis客户端启动也是可以携带一些参数的</p>
<p>示例：</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./redis-cli -h 127.0.0.1 -p 6378</span><br></pre></td></tr></table></figure></div>

<h1 id="九、Redis主从复制"><a href="#九、Redis主从复制" class="headerlink" title="九、Redis主从复制"></a>九、Redis主从复制</h1><h2 id="9-1-搭建主从复制架构"><a href="#9-1-搭建主从复制架构" class="headerlink" title="9.1 搭建主从复制架构"></a>9.1 搭建主从复制架构</h2><h3 id="9-1-1-主从复制架构简介"><a href="#9-1-1-主从复制架构简介" class="headerlink" title="9.1.1 主从复制架构简介"></a>9.1.1 主从复制架构简介</h3><p>在实际开发中，redis通常会搭建集群，来提高redis的整体的性能。但在客户端访问时有可能多次访问到不同的redis，因此造成多台redis数据不一致问题，为了解决这种多台redis中数据不同步问题，我们提出了主、从的概念；</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/redis3/30.png"
                     
                ></p>
<p>Master负责写的操作，Slave负责读的操作，Master与Slave直接保证数据的同步。</p>
<p><strong>注：一个master可以对应有多个slave，一个slave只能有一个master</strong></p>
<h3 id="9-1-2-搭建主从复制架构"><a href="#9-1-2-搭建主从复制架构" class="headerlink" title="9.1.2 搭建主从复制架构"></a>9.1.2 搭建主从复制架构</h3><p>准备好两个Redis配置文件（一主一从）：</p>
<p>6379（Master）：</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">port 6379</span><br><span class="line">dir &quot;/root/redis-4.0.11/data&quot;</span><br><span class="line">daemonize no</span><br><span class="line">appendonly yes</span><br><span class="line">appendfsync everysec</span><br><span class="line">appendfilename &quot;appendonly-6379.aof&quot;</span><br><span class="line">auto-aof-rewrite-min-size 180</span><br></pre></td></tr></table></figure></div>

<p>6380（Slave）：</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">port 6380</span><br><span class="line">dir &quot;/root/redis-4.0.11/data&quot;</span><br><span class="line">daemonize no</span><br><span class="line">appendonly yes</span><br><span class="line">appendfsync everysec</span><br><span class="line">appendfilename &quot;appendonly-6380.aof&quot;</span><br><span class="line">auto-aof-rewrite-min-size 180</span><br></pre></td></tr></table></figure></div>



<p>启动两台Redis服务器</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">redis-4.0.11/src/redis-server redis-4.0.11/conf/redis-6379.conf</span><br><span class="line">redis-4.0.11/src/redis-server redis-4.0.11/conf/redis-6380.conf</span><br></pre></td></tr></table></figure></div>

<p>使用客户端连接：</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">redis-4.0.11/src/redis-cli -p 6379</span><br><span class="line">redis-4.0.11/src/redis-cli -p 6380</span><br></pre></td></tr></table></figure></div>

<ul>
<li>主从复制命令：</li>
</ul>
<p>slave连接master，在slave的客户端输入如下命令：</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">slaveof &lt;masterip&gt; &lt;masterport&gt;</span><br></pre></td></tr></table></figure></div>

<p>示例：</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; slaveof 192.168.170.142 6379</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; </span><br></pre></td></tr></table></figure></div>

<p>如果master设置了密码，那么在slave服务器启动的时候就要指定master的密码：</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-server ../config/redis-6380.conf --masterauth admin</span><br></pre></td></tr></table></figure></div>

<p>分别查看slave与master启动日志：</p>
<ul>
<li>master日志：</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">23305:M 11 Apr 10:24:20.225 * Slave 127.0.0.1:6479 asks for synchronization</span><br><span class="line">23305:M 11 Apr 10:24:20.225 * Partial resynchronization not accepted: Replication ID mismatch (Slave asked for &#x27;18b61ced5990337dd8377e8bf81fcd2b20e7d399&#x27;, my replication IDs are &#x27;fa4d40f8562c10acbbd7a9955a88f7cd6dc33182&#x27; and &#x27;0000000000000000000000000000000000000000&#x27;)</span><br><span class="line">23305:M 11 Apr 10:24:20.225 * Starting BGSAVE for SYNC with target: disk</span><br><span class="line">23305:M 11 Apr 10:24:20.225 * Background saving started by pid 23339</span><br><span class="line">23339:C 11 Apr 10:24:20.227 * DB saved on disk</span><br><span class="line">23339:C 11 Apr 10:24:20.227 * RDB: 2 MB of memory used by copy-on-write</span><br><span class="line">23305:M 11 Apr 10:24:20.315 * Background saving terminated with success</span><br><span class="line">23305:M 11 Apr 10:24:20.315 * Synchronization with slave 127.0.0.1:6479 succeeded</span><br></pre></td></tr></table></figure></div>

<ul>
<li>slave日志：</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">23279:S 11 Apr 10:24:20.224 * Connecting to MASTER 127.0.0.1:6379</span><br><span class="line">23279:S 11 Apr 10:24:20.224 * MASTER &lt;-&gt; SLAVE sync started</span><br><span class="line">23279:S 11 Apr 10:24:20.224 * Non blocking connect for SYNC fired the event.</span><br><span class="line">23279:S 11 Apr 10:24:20.224 * Master replied to PING, replication can continue...</span><br><span class="line">23279:S 11 Apr 10:24:20.224 * Trying a partial resynchronization (request 18b61ced5990337dd8377e8bf81fcd2b20e7d399:1).</span><br><span class="line">23279:S 11 Apr 10:24:20.226 * Full resync from master: f1d39130cfadf4b3e0eb192e4143ae6bcb01677b:0</span><br><span class="line">23279:S 11 Apr 10:24:20.226 * Discarding previously cached master state.</span><br><span class="line">23279:S 11 Apr 10:24:20.315 * MASTER &lt;-&gt; SLAVE sync: receiving 176 bytes from master</span><br><span class="line">23279:S 11 Apr 10:24:20.315 * MASTER &lt;-&gt; SLAVE sync: Flushing old data</span><br><span class="line">23279:S 11 Apr 10:24:20.315 * MASTER &lt;-&gt; SLAVE sync: Loading DB in memory</span><br><span class="line">23279:S 11 Apr 10:24:20.316 * MASTER &lt;-&gt; SLAVE sync: Finished with success</span><br><span class="line">23279:S 11 Apr 10:24:20.316 * Background append only file rewriting started by pid 23340</span><br><span class="line">23279:S 11 Apr 10:24:20.356 * AOF rewrite child asks to stop sending diffs.</span><br><span class="line">23340:C 11 Apr 10:24:20.356 * Parent agreed to stop sending diffs. Finalizing AOF...</span><br><span class="line">23340:C 11 Apr 10:24:20.356 * Concatenating 0.00 MB of AOF diff received from parent.</span><br><span class="line">23340:C 11 Apr 10:24:20.356 * SYNC append only file rewrite performed</span><br><span class="line">23340:C 11 Apr 10:24:20.357 * AOF rewrite: 6 MB of memory used by copy-on-write</span><br><span class="line">23279:S 11 Apr 10:24:20.426 * Background AOF rewrite terminated with success</span><br><span class="line">23279:S 11 Apr 10:24:20.426 * Residual parent diff successfully flushed to the rewritten AOF (0.00 MB)</span><br><span class="line">23279:S 11 Apr 10:24:20.426 * Background AOF rewrite finished successfully</span><br></pre></td></tr></table></figure></div>

<ul>
<li>当master宕机后slave会一直尝试连接Master，日志信息如下：</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">29511:S 11 Apr 10:37:37.567 # Error condition on socket for SYNC: Connection refused</span><br><span class="line">29511:S 11 Apr 10:37:38.577 * Connecting to MASTER 127.0.0.1:6379</span><br><span class="line">29511:S 11 Apr 10:37:38.577 * MASTER &lt;-&gt; SLAVE sync started</span><br><span class="line">29511:S 11 Apr 10:37:38.577 # Error condition on socket for SYNC: Connection refused</span><br><span class="line">29511:S 11 Apr 10:37:39.587 * Connecting to MASTER 127.0.0.1:6379</span><br><span class="line">29511:S 11 Apr 10:37:39.587 * MASTER &lt;-&gt; SLAVE sync started</span><br><span class="line">29511:S 11 Apr 10:37:39.587 # Error condition on socket for SYNC: Connection refused</span><br><span class="line">29511:S 11 Apr 10:37:40.597 * Connecting to MASTER 127.0.0.1:6379</span><br><span class="line">29511:S 11 Apr 10:37:40.597 * MASTER &lt;-&gt; SLAVE sync started</span><br><span class="line">29511:S 11 Apr 10:37:40.597 # Error condition on socket for SYNC: Connection refused</span><br><span class="line">29511:S 11 Apr 10:37:41.606 * Connecting to MASTER 127.0.0.1:6379</span><br></pre></td></tr></table></figure></div>



<p>slave端口与master的连接（断开与master连接后，slave不再接收master的同步数据）：</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">slaveof no one</span><br></pre></td></tr></table></figure></div>



<h2 id="9-2-主从复制工作流程"><a href="#9-2-主从复制工作流程" class="headerlink" title="9.2 主从复制工作流程"></a>9.2 主从复制工作流程</h2><p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/redis3/32.png"
                     
                ></p>
<p>redis的主从复制分为三个阶段：</p>
<p>1）slave连接master<strong>（建立连接阶段）</strong></p>
<p>2）master同步数据到slave<strong>（数据同步阶段）</strong></p>
<p>3）期间master接到来自客户端”写”的命令之后需要将数据同步到slave<strong>（命令传播阶段）</strong></p>
<h3 id="9-2-1-建立连接阶段"><a href="#9-2-1-建立连接阶段" class="headerlink" title="9.2.1 建立连接阶段"></a>9.2.1 建立连接阶段</h3><p>在主从配置的建立连接阶段master与slave之间会做如下操作：</p>
<p>1）slave发送<code>slaveof masterhost masterport</code>命令连接master</p>
<p>2）master接到来自slave的连接，并开始响应对方。</p>
<p>3）slave得到响应之后将masterhost与masterport及一些其他的master信息保存到slave端。</p>
<p>4）<strong>slave确保连接无误后开始创建socket通道，用于后续的数据复制工作。</strong></p>
<p>5）<strong>slave与master之间周期性的发送ping心跳，检查slave与master之间是否通信正常。</strong></p>
<p>6）master接收到slave的ping心跳后会给对应的slave响应pong。ping&#x2F;pong机制</p>
<p>7）slave发送本机设置的master密码<code>masterauth</code>来到master进行验证（master有设置密码的情况下）。</p>
<p>8）master进行身份识别，如果认证错误，尝试重新连接。slave服务器端报如下错误：</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MASTER aborted replication with an error: NOAUTH Authentication required.</span><br></pre></td></tr></table></figure></div>

<p>9）master身份识别成功后，slave会将自己的ip、端口等信息发送到master，master将保存此slave的ip、端口以及一些其他状态信息，记录在info Replication。</p>
<h3 id="9-2-2-数据同步阶段"><a href="#9-2-2-数据同步阶段" class="headerlink" title="9.2.2 数据同步阶段"></a>9.2.2 数据同步阶段</h3><h4 id="9-2-2-1-工作流程"><a href="#9-2-2-1-工作流程" class="headerlink" title="9.2.2.1 工作流程"></a>9.2.2.1 工作流程</h4><p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/redis3/33.png"
                     
                ></p>
<p>在master与slave建立连接成功后，开始数据同步。</p>
<p>1）slave发送psync2（psync1、sync）指令给master，需要同步数据</p>
<p>2）master接到指令后<strong>开始执行bgsave指令</strong>，并创建复制积压缓冲区，在此期间，master接收到任何来自客户端的”写”操作都会<strong>记录在复制积压缓冲区一份</strong>。</p>
<p>3）master将rdb文件通过前面创建的socket通道发送给slave</p>
<p>4）slave接收到rdb文件后，<strong>清空当前机器的所有数据</strong>，开始同步rdb中的数据</p>
<p>5）告知master文件以及恢复完毕</p>
<p>6）master将复制积压缓冲区中的指令发送给slave</p>
<p>7）slave将接收到的指令<strong>执行bgrewriteaof重写</strong>，之后进行数据恢复</p>
<p><strong>步骤1-4属于全量同步</strong></p>
<p><strong>步骤5-7属于增量同步</strong></p>
<h4 id="9-2-2-2-增量同步原理"><a href="#9-2-2-2-增量同步原理" class="headerlink" title="9.2.2.2 增量同步原理"></a>9.2.2.2 增量同步原理</h4><p>从上图可以看出，在master执行bgsave期间接收到的所有命令都会存放在复制积压缓冲区一份，而复制积压缓冲区的大小是有限度的，默认是1MB，如果缓冲区已经满了，则会把最前面的数据挤出去（删除），后期进行增量同步时发现数据不一致，则会进行全量同步，从而造成同步死循环，因此复制积压缓冲区不易设置为太小。</p>
<ul>
<li>查看复制积压缓冲区：</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; config get repl-backlog-size</span><br><span class="line">1) &quot;repl-backlog-size&quot;</span><br><span class="line">2) &quot;1048576&quot;</span><br><span class="line">127.0.0.1:6379&gt;</span><br></pre></td></tr></table></figure></div>

<ul>
<li>调整复制积压缓冲区大小：</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">repl-backlog-size 2096576</span><br></pre></td></tr></table></figure></div>



<h3 id="9-2-3-命令传播阶段"><a href="#9-2-3-命令传播阶段" class="headerlink" title="9.2.3 命令传播阶段"></a>9.2.3 命令传播阶段</h3><p>master与slave保持连接后，此后master接到来自客户端”写”的命令之后，需要将数据同步各个slave端，此阶段叫<strong>命令传播阶段。</strong></p>
<h4 id="9-2-3-1-偏移量（offset）"><a href="#9-2-3-1-偏移量（offset）" class="headerlink" title="9.2.3.1 偏移量（offset）"></a>9.2.3.1 偏移量（offset）</h4><p>在数据同步中，master与slave之间分别维护着一个offset偏移量，用于存储<strong>增量同步</strong>时主节点发送给从节点数据的位置，这样利于在网络抖动情况下，主从节点之间还可以继续接着上一次同步的位置进行同步，而不必要进行全量同步。</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/redis3/34.png"
                     
                ></p>
<p>假设在命令传播时，master在传输到”4”这个字节时出现网络抖动，那么master与slave都会将此offset的值（7）保存起来，下次同步数据时，slave带着此offset来到master继续增量同步数据，而不需要重新全量同步数据。</p>
<h4 id="9-2-3-2-运行id（runid）"><a href="#9-2-3-2-运行id（runid）" class="headerlink" title="9.2.3.2 运行id（runid）"></a>9.2.3.2 运行id（runid）</h4><p>在上一小结说了master与slave之间都维护着一个offset偏移量，让我们可以根据offset的偏移量进行增量同步，&#x3D;&#x3D;<strong>避免网络抖动情况下进行全量同步。</strong>&#x3D;&#x3D;</p>
<p>但是如果在同步的过程中切换了master节点则会出现问题（哨兵切换等问题），因为新的master节点并没有维护着offset偏移量，并且slave中的数据应该与新master节点数据保持一致。那么redis是如何做到这一点的呢？</p>
<p>其实在master与slave服务器启动时都保存有一个由40位随机的16进制字符串组成的运行id（runid），用于标识一台唯一的redis，每次启动都不一样。在info的server组下可以查看到：</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">info server</span><br></pre></td></tr></table></figure></div>

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/redis3/35.png"
                     
                ></p>
<p>在slave首次连接master时，master会将自己的runid发送给slave，slave会将此runid保存下来（我们查询不到），当出现网络抖动时，slave会将此runid发送给master，master根据此runid判断进行全量同步还是增量同步。</p>
<ul>
<li>runid与现在master的runid一致：说明网络是同一个master节点，增量同步条件满足（<strong>具体是否执行还需要看复制积压缓冲区是否有溢出</strong>）。</li>
<li><strong>runid与现在master的runid不一致</strong>：说明是新的master节点，进行全量同步。</li>
</ul>
<h4 id="9-2-3-3-复制积压缓冲区"><a href="#9-2-3-3-复制积压缓冲区" class="headerlink" title="9.2.3.3 复制积压缓冲区"></a>9.2.3.3 复制积压缓冲区</h4><p>复制积压缓冲区（replication backlog buffer）：复制积压缓冲区是master节点创建的一个<strong>先进先出的队列</strong>，默认大小为1MB，用于备份主节点的传播命令，<strong>所有的slave共享一个复制积压缓冲区。</strong></p>
<p>slave将offset发送给master之后，master会根据当前的offset值来决定是全量同步还是增量同步。</p>
<ul>
<li>如果offset偏移量之后的数据仍在缓冲区中（意味着在执行bgsave时，缓冲区还未满，未溢出），则执行增量同步（<strong>runid要是同一个</strong>）。</li>
<li>如果offset偏移量之后的数据不在缓冲区中（意味着在执行bgsave时间过长，缓冲区的数据已经被挤出，<strong>数据溢出</strong>），此时执行全量同步</li>
</ul>
<p>完整同步过程如下：</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/redis3/37.png"
                     
                ></p>
<p><strong>总结：在网络抖动情况下，增量同步的条件：</strong></p>
<p><strong>1）offset之后的数据仍在复制积压缓冲区中（在Master执行bgsave期间，复制积压缓冲区未发现溢出）</strong></p>
<p><strong>2）runid要是同一个</strong></p>
<h4 id="9-2-3-4-心跳机制"><a href="#9-2-3-4-心跳机制" class="headerlink" title="9.2.3.4 心跳机制"></a>9.2.3.4 心跳机制</h4><p>在命令传播阶段，master与slave之间通过心跳机制来保证master与slave双方正常连接在线。</p>
<ul>
<li>master定时向slave发送ping，查看对方是否在线，通过<code>repl-ping-slave-period</code>参数维护，默认10s</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; config get repl-ping-slave-period</span><br><span class="line">1) &quot;repl-ping-slave-period&quot;</span><br><span class="line">2) &quot;10&quot;</span><br><span class="line">127.0.0.1:6379&gt;</span><br></pre></td></tr></table></figure></div>

<ul>
<li>slave定时向master发送 <code>replcconf ack&lt;偏移量&gt;</code>命令，<strong>频率为每秒发送一次。</strong></li>
</ul>
<p><strong>作用1）</strong>：用于检测slave与master的连接状态，可以在master端使用info命令查看replication组的lag值，代表上一次接收到此slave的<code>replcconf ack</code>命令间隔。</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/redis3/38.png"
                     
                ></p>
<p><strong>作用2）</strong>：slave发送当前的offset来到master与之对比，如果出现网络丢包情况下那么slave与master之间的offset不一致，通常是master发了多个字节，而slave由于网络原因没有接到那么多，可通过offset判断出上一条指令是否丢失；如果丢失，主服务器可从复制积压缓冲区找出丢失的指令，重新命令传播。</p>
<blockquote>
<p>2.8版本以前无法检测命令是否丢失，因此存在主从数据不一致的风险。</p>
</blockquote>
<p><strong>作用3）</strong>：slave每次发送<code>replcconf ack</code>命令给master，master用于确认有多少个slave与之连接，并且还可以确定多个slave与master上一次发送心跳的时间（lag），如果slave长时间未发送心跳来到master，可以先将master暂停写的操作。</p>
<ul>
<li><code>min-slaves-to-write</code>：当前master的slave数量小于此值则暂停写操作</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">min-slaves-to-write 3</span><br></pre></td></tr></table></figure></div>

<ul>
<li><code>min-slaves-max-lag</code>：当前master的slave的lag都等于此值则暂停写的操作</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">min-slaves-max-lag 5</span><br></pre></td></tr></table></figure></div>

<h1 id="十、Redis-哨兵机制"><a href="#十、Redis-哨兵机制" class="headerlink" title="十、Redis 哨兵机制"></a>十、Redis 哨兵机制</h1><p>咱们在上一节搭建了主从复制来提高redis整体的性能，基于主从复制的架构我们可以分析，如果是slave服务器出现宕机那么当前slave则不提供服务，对整个redis服务影响不大，但是当master节点宕机后，整个redis服务就会随之而然崩溃，我们希望在redis主从复制环境下如果master宕机后，有slave可以站出来顶替master的位置，不会对整个服务造成影响，从而提升我们redis服务的<strong>高可用</strong>。我们可以搭建redis哨兵来帮我们监控整个redis服务。</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/redis3/43.png"
                     
                ></p>
<h2 id="10-1-Redis哨兵简介"><a href="#10-1-Redis哨兵简介" class="headerlink" title="10.1 Redis哨兵简介"></a>10.1 Redis哨兵简介</h2><p>redis哨兵（Redis Sentinel）是独立一个分布式系统，用于提高redis主从复制环境下的<strong>高可用</strong>。哨兵可以监控master与slave的一些状态信息，并根据状态信息判断此服务器是否存活，如发现master不可用后，内部使用投票机制会在slave之间选举出一个较为适合的slave节点作为master节点，其他slave连接新的master节点继续提供服务，来保证整个redis的高可用。</p>
<h2 id="10-2-搭建哨兵"><a href="#10-2-搭建哨兵" class="headerlink" title="10.2 搭建哨兵"></a>10.2 搭建哨兵</h2><h3 id="10-2-1-哨兵配置详解"><a href="#10-2-1-哨兵配置详解" class="headerlink" title="10.2.1 哨兵配置详解"></a>10.2.1 哨兵配置详解</h3><ul>
<li><strong>配置master信息</strong></li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sentinel monitor &lt;master-name&gt; &lt;ip&gt; &lt;port&gt; &lt;quorum&gt;</span><br></pre></td></tr></table></figure></div>

<ul>
<li>master-name 为此master取个名字</li>
<li>ip：master节点的ip</li>
<li>port：master节点的端口</li>
<li>quorum：票数，当哨兵监控的服务器出现故障后，只要有quorum个哨兵（sentinel）认为此master出现故障那么就认为此服务器真的出现故障了（客观下线），重新推选新的master，一般设置为：<code>floor(哨兵数量/2)</code>+1。</li>
</ul>
<p>示例：</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sentinel monitor mymaster 127.0.0.1 6379 2</span><br></pre></td></tr></table></figure></div>

<ul>
<li><strong>设置哨兵等待心跳的响应时间</strong></li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sentinel down-after-milliseconds &lt;master-name&gt; &lt;times&gt;</span><br></pre></td></tr></table></figure></div>

<ul>
<li>master-name：指定master名称</li>
<li>times：每台哨兵会定期发送心跳检查redis节点以及其他哨兵节点，如果times毫秒没有接收到回应，那么就<strong>主观</strong>认为这台redis机器出现故障（默认30s），单位毫秒</li>
</ul>
<p>示例：</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sentinel down-after-milliseconds mymaster 30000</span><br></pre></td></tr></table></figure></div>



<ul>
<li><strong>设置新master最多能同时处理几个slave的同步</strong></li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sentinel parallel-syncs &lt;master-name&gt; &lt;nums&gt;</span><br></pre></td></tr></table></figure></div>

<ul>
<li>master-name：指定master名称</li>
<li>nums：当master宕机后，哨兵会发布投票来选举新的master，当新的master选举出来后，其他的slave需要连接新的master进行数据同步，nums代表最多有几台slave来同时同步数据，一般设置为1个，让slave一台一台慢慢同步，如果设置过大则会造成新master压力很大。默认是1台</li>
</ul>
<p>示例：</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sentinel parallel-syncs mymaster 1</span><br></pre></td></tr></table></figure></div>



<ul>
<li><strong>设置哨兵切换master节点时的超时时间</strong></li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sentinel failover-timeout &lt;master-name&gt;  &lt;times&gt;</span><br></pre></td></tr></table></figure></div>

<ul>
<li>master-name：master的名称</li>
<li>times：同一个sentinel对同一个master两次failover之间的间隔时间，默认为3分钟，单位为毫秒。当一个slave从一个错误的master那里同步数据开始计算时间。直到slave被纠正为向正确的master那里同步数据时。即使过了这个超时，slave依然会被正确配置为指向master，但是就不按parallel-syncs所配置的规则来了；</li>
</ul>
<p>示例：</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sentinel failover-timeout mymaster 180000</span><br></pre></td></tr></table></figure></div>

<ul>
<li><strong>设置master连接密码</strong></li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sentinel auth-pass &lt;master-name&gt; &lt;password&gt;</span><br></pre></td></tr></table></figure></div>

<ul>
<li><p>master-name：master服务器名称</p>
</li>
<li><p>password：master服务器的密码</p>
</li>
</ul>
<p>示例：</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sentinel auth-pass mymaster admin</span><br></pre></td></tr></table></figure></div>



<h3 id="10-2-1-搭建哨兵环境"><a href="#10-2-1-搭建哨兵环境" class="headerlink" title="10.2.1 搭建哨兵环境"></a>10.2.1 搭建哨兵环境</h3><p>准备好3台redis（一主二从）、3台哨兵</p>
<p>哨兵完整配置文件（26379）：</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">port 26379			</span><br><span class="line"></span><br><span class="line">dir &quot;/root/redis-4.0.11/data&quot;				</span><br><span class="line"></span><br><span class="line">sentinel monitor mymaster 127.0.0.1 6379 2		 </span><br><span class="line"></span><br><span class="line">sentinel down-after-milliseconds mymaster 30000</span><br><span class="line"></span><br><span class="line">sentinel parallel-syncs mymaster 1</span><br><span class="line"></span><br><span class="line">sentinel failover-timeout mymaster 180000</span><br></pre></td></tr></table></figure></div>

<p>26380：</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">port 26380			</span><br><span class="line"></span><br><span class="line">dir &quot;/root/redis-4.0.11/data&quot;				</span><br><span class="line"></span><br><span class="line">sentinel monitor mymaster 127.0.0.1 6379 2		 </span><br><span class="line"></span><br><span class="line">sentinel down-after-milliseconds mymaster 30000</span><br><span class="line"></span><br><span class="line">sentinel parallel-syncs mymaster 1</span><br><span class="line"></span><br><span class="line">sentinel failover-timeout mymaster 180000</span><br></pre></td></tr></table></figure></div>

<p>26381：</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">port 26381			</span><br><span class="line"></span><br><span class="line">dir &quot;/root/redis-4.0.11/data&quot;				</span><br><span class="line"></span><br><span class="line">sentinel monitor mymaster 127.0.0.1 6379 2		 </span><br><span class="line"></span><br><span class="line">sentinel down-after-milliseconds mymaster 30000</span><br><span class="line"></span><br><span class="line">sentinel parallel-syncs mymaster 1</span><br><span class="line"></span><br><span class="line">sentinel failover-timeout mymaster 180000</span><br></pre></td></tr></table></figure></div>



<p><strong>其他哨兵配置文件全部保持一致，只是端口换了。</strong></p>
<p>6379.conf（主）：</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">bind 0.0.0.0</span><br><span class="line">port 6379</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">logfile <span class="string">&quot;6379.log&quot;</span></span></span><br><span class="line">dir &quot;/root/redis-4.0.11/data&quot;</span><br><span class="line"></span><br><span class="line">daemonize no</span><br><span class="line">appendonly yes</span><br><span class="line">appendfsync everysec</span><br><span class="line">appendfilename &quot;appendonly-6379.aof&quot;</span><br></pre></td></tr></table></figure></div>

<p>6380.conf（从）：</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">bind 0.0.0.0</span><br><span class="line">port 6380</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">logfile <span class="string">&quot;6380.log&quot;</span></span>		</span><br><span class="line">dir &quot;/root/redis-4.0.11/data&quot;</span><br><span class="line"></span><br><span class="line">daemonize no</span><br><span class="line">appendonly yes</span><br><span class="line">appendfsync everysec</span><br><span class="line">appendfilename &quot;appendonly-6380.aof&quot;</span><br><span class="line">slaveof 127.0.0.1 6379		</span><br></pre></td></tr></table></figure></div>

<p>6381.conf（从）：</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">bind 0.0.0.0</span><br><span class="line">port 6381</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">logfile <span class="string">&quot;6381.log&quot;</span></span></span><br><span class="line">dir &quot;/root/redis-4.0.11/data&quot;</span><br><span class="line"></span><br><span class="line">daemonize no</span><br><span class="line">appendonly yes</span><br><span class="line">appendfsync everysec</span><br><span class="line">appendfilename &quot;appendonly-6381.aof&quot;</span><br><span class="line">slaveof 127.0.0.1 6379		</span><br></pre></td></tr></table></figure></div>

<p>完整配置：</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/redis3/66.png"
                     
                ></p>
<p>启动顺序：master—&gt;slave—&gt;哨兵</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">/root/redis-4.0.11/src/redis-server redis-4.0.11/conf/redis-6379.conf</span><br><span class="line">/root/redis-4.0.11/src/redis-server redis-4.0.11/conf/redis-6380.conf</span><br><span class="line">/root/redis-4.0.11/src/redis-server redis-4.0.11/conf/redis-6381.conf</span><br><span class="line"></span><br><span class="line">/root/redis-4.0.11/src/redis-sentinel redis-4.0.11/conf/sentinel-26379.conf</span><br><span class="line">/root/redis-4.0.11/src/redis-sentinel redis-4.0.11/conf/sentinel-26380.conf</span><br><span class="line">/root/redis-4.0.11/src/redis-sentinel redis-4.0.11/conf/sentinel-26381.conf</span><br></pre></td></tr></table></figure></div>



<p>26379哨兵启动日志：</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">4745:X 29 Apr 00:16:26.858 # WARNING: The TCP backlog setting of 511 cannot be enforced because /proc/sys/net/core/somaxconn is set to the lower value of 128.</span><br><span class="line">4745:X 29 Apr 00:16:26.866 # Sentinel ID is 15899b462cef4d73ed82177131643b3627c5e9e1</span><br><span class="line">4745:X 29 Apr 00:16:26.866 # +monitor master mymaster 127.0.0.1 6379 quorum 2</span><br><span class="line">4745:X 29 Apr 00:16:26.876 * +slave slave 127.0.0.1:6380 127.0.0.1 6380 @ mymaster 127.0.0.1 6379</span><br><span class="line">4745:X 29 Apr 00:16:26.877 * +slave slave 127.0.0.1:6381 127.0.0.1 6381 @ mymaster 127.0.0.1 6379</span><br><span class="line">4745:X 29 Apr 00:16:30.615 * +sentinel sentinel 69016bc04366a35e0db9f2b8acfa6eb2dcdd962e 127.0.0.1 26380 @ mymaster 127.0.0.1 6379</span><br><span class="line">4745:X 29 Apr 00:16:32.986 * +sentinel sentinel 3e5c6465514f92279d30aef79abffc7ec4bcac2b 127.0.0.1 26381 @ mymaster 127.0.0.1 6379</span><br></pre></td></tr></table></figure></div>



<p>26380哨兵启动日志：</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">4749:X 29 Apr 00:16:28.589 # WARNING: The TCP backlog setting of 511 cannot be enforced because /proc/sys/net/core/somaxconn is set to the lower value of 128.</span><br><span class="line">4749:X 29 Apr 00:16:28.591 # Sentinel ID is 69016bc04366a35e0db9f2b8acfa6eb2dcdd962e</span><br><span class="line">4749:X 29 Apr 00:16:28.591 # +monitor master mymaster 127.0.0.1 6379 quorum 2</span><br><span class="line">4749:X 29 Apr 00:16:28.592 * +slave slave 127.0.0.1:6380 127.0.0.1 6380 @ mymaster 127.0.0.1 6379</span><br><span class="line">4749:X 29 Apr 00:16:28.593 * +slave slave 127.0.0.1:6381 127.0.0.1 6381 @ mymaster 127.0.0.1 6379</span><br><span class="line">4749:X 29 Apr 00:16:28.947 * +sentinel sentinel 15899b462cef4d73ed82177131643b3627c5e9e1 127.0.0.1 26379 @ mymaster 127.0.0.1 6379</span><br><span class="line">4749:X 29 Apr 00:16:32.986 * +sentinel sentinel 3e5c6465514f92279d30aef79abffc7ec4bcac2b 127.0.0.1 26381 @ mymaster 127.0.0.1 6379</span><br></pre></td></tr></table></figure></div>



<p>26381哨兵启动日志：</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">4753:X 29 Apr 00:16:30.925 # WARNING: The TCP backlog setting of 511 cannot be enforced because /proc/sys/net/core/somaxconn is set to the lower value of 128.</span><br><span class="line">4753:X 29 Apr 00:16:30.927 # Sentinel ID is 3e5c6465514f92279d30aef79abffc7ec4bcac2b</span><br><span class="line">4753:X 29 Apr 00:16:30.927 # +monitor master mymaster 127.0.0.1 6379 quorum 2</span><br><span class="line">4753:X 29 Apr 00:16:30.928 * +slave slave 127.0.0.1:6380 127.0.0.1 6380 @ mymaster 127.0.0.1 6379</span><br><span class="line">4753:X 29 Apr 00:16:30.929 * +slave slave 127.0.0.1:6381 127.0.0.1 6381 @ mymaster 127.0.0.1 6379</span><br><span class="line">4753:X 29 Apr 00:16:30.972 * +sentinel sentinel 15899b462cef4d73ed82177131643b3627c5e9e1 127.0.0.1 26379 @ mymaster 127.0.0.1 6379</span><br><span class="line">4753:X 29 Apr 00:16:32.618 * +sentinel sentinel 69016bc04366a35e0db9f2b8acfa6eb2dcdd962e 127.0.0.1 26380 @ mymaster 127.0.0.1 6379</span><br></pre></td></tr></table></figure></div>

<p>监控slave的哨兵只会获取当前slave的一些信息。</p>
<h2 id="10-3-哨兵工作原理"><a href="#10-3-哨兵工作原理" class="headerlink" title="10.3 哨兵工作原理"></a>10.3 哨兵工作原理</h2><p>哨兵工作原理分为三个步骤：</p>
<p>1）当哨兵启动时需要监控master与slave的状态，并且保证哨兵集群能够正常通信。我们把这个阶段称为<strong>哨兵监控阶段</strong></p>
<p>2）当哨兵发现master或者slave出现故障时，当前哨兵会通知其他哨兵，其他哨兵挨个发送ping命令来到出故障的redis节点，如果redis节点没有响应则哨兵集群认为此节点出现故障，我们把这个阶段称为<strong>哨兵通知阶段</strong></p>
<p>3）当<strong>哨兵集群</strong>已经发现某个节点出现故障时，如果是slave节点则直接剔除，如果是master节点出现故障，那么需要在多个slave中推选出一个新的master节点，我们把这个阶段称为<strong>故障转移阶段</strong></p>
<h3 id="10-3-1-哨兵监控"><a href="#10-3-1-哨兵监控" class="headerlink" title="10.3.1 哨兵监控"></a>10.3.1 哨兵监控</h3><p>在哨兵监控阶段，主要完成三件事情：</p>
<p>1）监控master与slave的状态。</p>
<p>2）哨兵集群中保持正常的通信。</p>
<p>3）不同的哨兵节点之间通过数据的<strong>发布&#x2F;订阅</strong>进行数据同步。</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/redis3/44.png"
                     
                ></p>
<p>哨兵启动后会做如下事情：</p>
<p>1）<code>info</code>：哨兵启动每间隔10秒钟会向所有的master与slave节点发送info指令来获取信息，当有新的slave加入哨兵可以立马察觉到，获取到信息之后将信息保存到当前的哨兵节点中，同时也可以检测master与slave的状态信息（如有新的机器加入到集群中）。</p>
<p>2）<code>ping</code>：哨兵节点启动之后每隔1秒钟会向其他哨兵节点发送ping心跳，来检测其他哨兵节点是否正常。</p>
<p>3）<code>pub/sub</code>：每个哨兵节点每隔2秒钟会在一个指定的频道发布当前节点保存的master信息，其他哨兵节点都会订阅该频道获取消息。</p>
<h3 id="10-3-2-哨兵通知"><a href="#10-3-2-哨兵通知" class="headerlink" title="10.3.2 哨兵通知"></a>10.3.2 哨兵通知</h3><p>哨兵通知阶段会每隔一秒ping一下master与slave，如果得不到响应则会认为当前redis节点出现故障（根据超时时间），哨兵通知主要是监控到master或slave出现问题之后进行的处理。</p>
<p>哨兵监控slave：</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/redis3/45.png"
                     
                ></p>
<p>在哨兵集群中，如果有某一台哨兵节点发现某台slave节点出现故障后，那么则会在哨兵集群中发布消息，其他哨兵接收到消息之后，将此slave剔除。并将此节点标记为<code>+sdown</code>，等到下次slave重新回复哨兵时，哨兵则会把此slave添加进主从复制集群，并将此节点标记为<code>-sdown </code></p>
<p>哨兵监控master：</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/redis3/46.png"
                     
                ></p>
<p>在哨兵集群中，如果有某一台哨兵节点发现某台Master节点出现故障后，当前哨兵节点会认为此master节点出现故障，此时当前哨兵标记此master节点为<code>+sdown</code>，当前哨兵标记master状态为<strong>主观下线</strong>（即：单个哨兵认为此master节点有问题，有可能是网络抖动问题。）如果后续其他哨兵节点也发现master出现故障（ping没有回应）各自的哨兵节点都标记<code>+sdown</code>，直至数量大于等于哨兵配置文件中的quorum（票数）时，那么哨兵集群认为此master出现故障，其他所有哨兵标记为<code>odown状态</code>，此时master标记为<strong>客观下线</strong>。</p>
<h3 id="10-3-3-故障转移"><a href="#10-3-3-故障转移" class="headerlink" title="10.3.3 故障转移"></a>10.3.3 故障转移</h3><h4 id="10-3-3-1-leader选举"><a href="#10-3-3-1-leader选举" class="headerlink" title="10.3.3.1 leader选举"></a>10.3.3.1 leader选举</h4><p>如果主节点被标记为客观下线之后，就要在哨兵集群中选出一个哨兵节点来完成后面的故障转移工作，每个哨兵节点都能成为这个领导者（leader），选举流程如下：</p>
<p>1）在master节点被标记为客观下线时，哨兵节点会向其他哨兵节点发送<code>is-master-down-by-addr</code>命令，表明自己想成为leader来处理master的故障转移。</p>
<p>2）当其它哨兵节点收到此命令时，可以同意或者拒绝它成为领导者；</p>
<p>3）当如果票数大于哨兵集群总数量的一半时将成为领导，如果没有大于，则继续开始下一轮选举（票数累加）。</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/redis3/47.png"
                     
                ></p>
<h4 id="10-3-3-2-故障转移"><a href="#10-3-3-2-故障转移" class="headerlink" title="10.3.3.2 故障转移"></a>10.3.3.2 故障转移</h4><p>哨兵在哨兵监控时就已经保存了master与slave的信息，选举出leader哨兵之后，哨兵要开始进行master与slave的故障转移了。在众多的slave直接推选出一个slave充当master节点。</p>
<p>选举master流程如下：</p>
<p><strong>1）首先过滤已经下线的slave节点</strong></p>
<p><strong>2）优先级高的推选为master节点，默认都为100（在 info Replication组，可查看优先级：slave_priority参数）</strong></p>
<p><strong>3）推选出复制偏移量（offset）最大的节点（offset大，意味着和原master节点的数据最相近）</strong></p>
<p><strong>4）推选出run_id最小的节点（相当于随机）。</strong></p>
<p>当故障转移后，需要更新当前的主从状态。</p>
<p>更新状态如下：</p>
<p><strong>1）被选举出来的新master将执行<code>slaveof no one</code>，断开与原master的连接，并在其他slave的配置文件上加上<code>slaveof</code>命令。</strong></p>
<p><strong>2）将已经剔除的主节点设置为新主节点的从节点，后续恢复正常时，将其变为从节点，并在其配置文件中加上<code>slaveof</code>命令。</strong></p>
<p>查看新的master主机的日志信息：</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">4999:M 30 Apr 00:06:16.929 # Setting secondary replication ID to 438929a4259e2c6e94d28288bc6f5ea1769b004b, valid up to offset: 33535. New replication ID is c185fad8c8c70785579573552b7a3024c91ffe73</span><br><span class="line">4999:M 30 Apr 00:06:16.929 * Discarding previously cached master state.</span><br><span class="line">4999:M 30 Apr 00:06:16.929 * MASTER MODE enabled (user request from &#x27;id=7 addr=127.0.0.1:39654 fd=12 name=sentinel-a4c78bb6-cmd age=42 idle=0 flags=x db=0 sub=0 psub=0 multi=3 qbuf=14 qbuf-free=32754 obl=36 oll=0 omem=0 events=r cmd=exec&#x27;)</span><br><span class="line">4999:M 30 Apr 00:06:16.930 # CONFIG REWRITE executed with success.</span><br><span class="line">4999:M 30 Apr 00:06:17.848 * Slave 127.0.0.1:6380 asks for synchronization</span><br><span class="line">4999:M 30 Apr 00:06:17.848 * Partial resynchronization request from 127.0.0.1:6380 accepted. Sending 422 bytes of backlog starting from offset 33535.</span><br></pre></td></tr></table></figure></div>

<p>查看slave主机信息：</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">4974:S 30 Apr 00:06:16.982 * SLAVE OF 127.0.0.1:6381 enabled (user request from &#x27;id=7 addr=127.0.0.1:59272 fd=12 name=sentinel-a4c78bb6-cmd age=202 idle=0 flags=x db=0 sub=0 psub=0 multi=3 qbuf=133 qbuf-free=32635 obl=36 oll=0 omem=0 events=r cmd=exec&#x27;)</span><br><span class="line">4974:S 30 Apr 00:06:16.982 # CONFIG REWRITE executed with success.</span><br><span class="line">4974:S 30 Apr 00:06:17.848 * Connecting to MASTER 127.0.0.1:6381</span><br><span class="line">4974:S 30 Apr 00:06:17.848 * MASTER &lt;-&gt; SLAVE sync started</span><br><span class="line">4974:S 30 Apr 00:06:17.848 * Non blocking connect for SYNC fired the event.</span><br><span class="line">4974:S 30 Apr 00:06:17.848 * Master replied to PING, replication can continue...</span><br><span class="line">4974:S 30 Apr 00:06:17.848 * Trying a partial resynchronization (request 438929a4259e2c6e94d28288bc6f5ea1769b004b:33535).</span><br><span class="line">4974:S 30 Apr 00:06:17.848 * Successful partial resynchronization with master.</span><br><span class="line">4974:S 30 Apr 00:06:17.848 # Master replication ID changed to c185fad8c8c70785579573552b7a3024c91ffe73</span><br><span class="line">4974:S 30 Apr 00:06:17.848 * MASTER &lt;-&gt; SLAVE sync: Master accepted a Partial Resynchronization.</span><br></pre></td></tr></table></figure></div>





<p>查看slave的配置文件：</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">bind 0.0.0.0</span><br><span class="line">port 6380</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">logfile <span class="string">&quot;6380.log&quot;</span></span></span><br><span class="line">dir &quot;/root/redis-4.0.0/data&quot;</span><br><span class="line"></span><br><span class="line">daemonize no</span><br><span class="line">appendonly yes</span><br><span class="line">appendfsync everysec</span><br><span class="line">appendfilename &quot;appendonly-6380.aof&quot;</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">slaveof 127.0.0.1 6379</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Generated by CONFIG REWRITE</span></span><br><span class="line">slaveof 127.0.0.1 6381			# 切换到了新的master</span><br></pre></td></tr></table></figure></div>



<p>在redis哨兵环境中，需要注意的是，当原master恢复正常时，不会重新”抢回”master的位置，原来的master将变为slave节点，这与nginx的非抢占模式是一样的道理。</p>
<p>master恢复正常后，其他的哨兵标记master状态为<code>-sdown</code>。</p>
<h1 id="十一、Redis-Cluster集群"><a href="#十一、Redis-Cluster集群" class="headerlink" title="十一、Redis Cluster集群"></a>十一、Redis Cluster集群</h1><p>随着业务量的不断增大，QPS随之而然也不断扩大，单台master与多台slave的主从复制架构在性能上已经出现瓶颈了，因此我们考虑到让多个master（一个master配置多个slave）同时工作，来提高整体redis的性能，因此我们需要搭建redis集群。</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/redis3/48.png"
                     
                ></p>
<h2 id="11-1-Redis-Cluster配置"><a href="#11-1-Redis-Cluster配置" class="headerlink" title="11.1 Redis Cluster配置"></a>11.1 Redis Cluster配置</h2><ul>
<li>是否开启集群配置</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cluster-enabled yes|no</span><br></pre></td></tr></table></figure></div>

<ul>
<li>集群产生的配置文件名称</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cluster-config-file &lt;filename&gt;</span><br></pre></td></tr></table></figure></div>

<ul>
<li>redis节点之间的连接超时时间，每个master会每隔此时间监测一下其他slave节点。</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cluster-node-timeout &lt;milliseconds&gt;</span><br></pre></td></tr></table></figure></div>

<ul>
<li>一个master节点最多可以配置几个slave节点</li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cluster-migration-barrier &lt;count&gt;</span><br></pre></td></tr></table></figure></div>



<p>完整的配置如下：</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">bind 0.0.0.0</span><br><span class="line">port 6379</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">logfile <span class="string">&quot;6379.log&quot;</span></span></span><br><span class="line">dir &quot;/root/redis-4.0.11/data&quot;</span><br><span class="line"></span><br><span class="line">daemonize no</span><br><span class="line">appendonly yes</span><br><span class="line">appendfsync everysec</span><br><span class="line">appendfilename &quot;appendonly-6379.aof&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">redis集群配置</span></span><br><span class="line">cluster-enabled yes</span><br><span class="line">cluster-config-file nodes-6379.conf</span><br><span class="line">cluster-node-timeout 10000</span><br><span class="line">cluster-migration-barrier 1</span><br></pre></td></tr></table></figure></div>

<h2 id="11-2-搭建Redis-Cluster"><a href="#11-2-搭建Redis-Cluster" class="headerlink" title="11.2 搭建Redis Cluster"></a>11.2 搭建Redis Cluster</h2><h3 id="11-2-1-安装ruby"><a href="#11-2-1-安装ruby" class="headerlink" title="11.2.1 安装ruby"></a>11.2.1 安装ruby</h3><p>Redis Cluster环境依赖于ruby，因此我们需要先安装ruby的环境</p>
<p>1）在线安装ruby</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install ruby</span><br></pre></td></tr></table></figure></div>

<p>查看ruby版本：Centos库中默认支持2.0.0版本的ruby</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# ruby -v</span><br><span class="line">ruby 2.0.0p648 (2015-12-16) [x86_64-linux]</span><br><span class="line">[root@localhost ~]#</span><br></pre></td></tr></table></figure></div>

<p>2）安装redis接口</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gem install redis</span><br></pre></td></tr></table></figure></div>

<p>发现出现如下错误：</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost src]# gem install redis</span><br><span class="line">Fetching: redis-4.1.3.gem (100%)</span><br><span class="line">ERROR:  Error installing redis:</span><br><span class="line">	redis requires Ruby version &gt;= 2.3.0.</span><br><span class="line">[root@localhost src]#</span><br></pre></td></tr></table></figure></div>

<p>这是因为安装redis接口最低版本的ruby要为2.3.0，我们的是2.0.0，因此我们需要更新ruby的版本</p>
<p>3）进入rvm官网：</p>
<div class="highlight-container" data-rel="Http"><figure class="iseeu highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://rvm.io/</span><br></pre></td></tr></table></figure></div>

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/redis3/67.png"
                     
                ></p>
<p>4）获取秘钥：</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gpg2 --recv-keys 409B6B1796C275462A1703113804BB82D39DC0E3 7D2BAF1CF37B13E2069D6956105BD0E739499BDB</span><br></pre></td></tr></table></figure></div>

<p>5）安装curl命令</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo yum -y install curl</span><br></pre></td></tr></table></figure></div>

<p>6）修改<code>/etc/hosts</code>文件，添加如下：</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">199.232.68.133 raw.githubusercontent.com</span><br></pre></td></tr></table></figure></div>

<p>7）安装rvm（这一步比较慢，需要等一会）：</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -sSL https://get.rvm.io | bash -s stable</span><br></pre></td></tr></table></figure></div>

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/redis3/55.png"
                     
                ></p>
<p>安装成功如下：</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/redis3/56.png"
                     
                ></p>
<p>5）加载源：</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">source /usr/local/rvm/scripts/rvm</span><br></pre></td></tr></table></figure></div>

<p>6）查看ruby的版本列表：</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rvm list known</span><br></pre></td></tr></table></figure></div>

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/redis3/57.png"
                     
                ></p>
<p>7）安装ruby（这个过程比较久，需要等一会）：</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rvm install 2.3.0</span><br></pre></td></tr></table></figure></div>

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/redis3/58.png"
                     
                ></p>
<p>安装成功：</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/redis3/59.png"
                     
                ></p>
<p>8）再次查看ruby版本：</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost src]# ruby -v</span><br><span class="line">ruby 2.3.0p0 (2015-12-25 revision 53290) [x86_64-linux]</span><br><span class="line">[root@localhost src]#</span><br></pre></td></tr></table></figure></div>

<p>9）重新安装redis接口：</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost src]# gem install redis</span><br><span class="line">Fetching redis-4.1.3.gem</span><br><span class="line">Successfully installed redis-4.1.3</span><br><span class="line">Parsing documentation for redis-4.1.3</span><br><span class="line">Installing ri documentation for redis-4.1.3</span><br><span class="line">Done installing documentation for redis after 1 seconds</span><br><span class="line">1 gem installed</span><br><span class="line">[root@localhost src]#</span><br></pre></td></tr></table></figure></div>

<h3 id="3-2-2-编写配置"><a href="#3-2-2-编写配置" class="headerlink" title="3.2.2 编写配置"></a>3.2.2 编写配置</h3><p>搭建4主4从的项目环境</p>
<p>准备8个配置文件，配置文件内容如下：</p>
<p>redis-6379.conf（主）：</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">bind 0.0.0.0</span><br><span class="line">port 6379</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">logfile <span class="string">&quot;6379.log&quot;</span></span></span><br><span class="line">dir &quot;/root/redis-4.0.11/data&quot;</span><br><span class="line"></span><br><span class="line">daemonize no</span><br><span class="line">appendonly yes</span><br><span class="line">appendfsync everysec</span><br><span class="line">appendfilename &quot;appendonly-6379.aof&quot;</span><br><span class="line"></span><br><span class="line">cluster-enabled yes</span><br><span class="line">cluster-config-file nodes-6379.conf</span><br><span class="line">cluster-node-timeout 10000</span><br><span class="line">cluster-migration-barrier 1</span><br></pre></td></tr></table></figure></div>

<p>redis-6380.conf（主）（修改一下端口、生成的aof、nodes文件的名称即可）：</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">bind 0.0.0.0</span><br><span class="line">port 6380</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">logfile <span class="string">&quot;6380.log&quot;</span></span></span><br><span class="line">dir &quot;/root/redis-4.0.11/data&quot;</span><br><span class="line"></span><br><span class="line">daemonize no</span><br><span class="line">appendonly yes</span><br><span class="line">appendfsync everysec</span><br><span class="line">appendfilename &quot;appendonly-6380.aof&quot;</span><br><span class="line"></span><br><span class="line">cluster-enabled yes</span><br><span class="line">cluster-config-file nodes-6380.conf</span><br><span class="line">cluster-node-timeout 10000</span><br><span class="line">cluster-migration-barrier 1</span><br></pre></td></tr></table></figure></div>

<p>redis-6381.conf（主）、redis-6382.conf（主）、</p>
<p>redis-6479.conf（从）、redis-6480.conf（从）、redis-6481.conf（从）、redis-6482.conf（从）</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/redis3/52.png"
                     
                ></p>
<p>把所有的服务器都启动</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">/root/redis-4.0.11/src/redis-server /root/redis-4.0.11/config/redis-6379.conf</span><br><span class="line">/root/redis-4.0.11/src/redis-server /root/redis-4.0.11/config/redis-6380.conf</span><br><span class="line">/root/redis-4.0.11/src/redis-server /root/redis-4.0.11/config/redis-6381.conf</span><br><span class="line">/root/redis-4.0.11/src/redis-server /root/redis-4.0.11/config/redis-6382.conf</span><br><span class="line"></span><br><span class="line">/root/redis-4.0.11/src/redis-server /root/redis-4.0.11/config/redis-6479.conf</span><br><span class="line">/root/redis-4.0.11/src/redis-server /root/redis-4.0.11/config/redis-6480.conf</span><br><span class="line">/root/redis-4.0.11/src/redis-server /root/redis-4.0.11/config/redis-6481.conf</span><br><span class="line">/root/redis-4.0.11/src/redis-server /root/redis-4.0.11/config/redis-6482.conf</span><br></pre></td></tr></table></figure></div>

<p>启动集群命令（命令在<code>/root/redis-4.0.11/src</code>）：</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost src]# ./redis-trib.rb create --replicas 1 127.0.0.1:6379 127.0.0.1:6380 127.0.0.1:6381 127.0.0.1:6382 127.0.0.1:6479 127.0.0.1:6480 127.0.0.1:6481 127.0.0.1:6482</span><br></pre></td></tr></table></figure></div>

<p>命令图解：</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/redis3/60.png"
                     
                ></p>
<p>日志如下：</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; Creating cluster</span></span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; Performing <span class="built_in">hash</span> slots allocation on 8 nodes...</span></span><br><span class="line">Using 4 masters:</span><br><span class="line">127.0.0.1:6379</span><br><span class="line">127.0.0.1:6380</span><br><span class="line">127.0.0.1:6381</span><br><span class="line">127.0.0.1:6382</span><br><span class="line">Adding replica 127.0.0.1:6480 to 127.0.0.1:6379</span><br><span class="line">Adding replica 127.0.0.1:6481 to 127.0.0.1:6380</span><br><span class="line">Adding replica 127.0.0.1:6482 to 127.0.0.1:6381</span><br><span class="line">Adding replica 127.0.0.1:6479 to 127.0.0.1:6382</span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; Trying to optimize slaves allocation <span class="keyword">for</span> anti-affinity</span></span><br><span class="line">[WARNING] Some slaves are in the same host as their master</span><br><span class="line">M: 87d16eeaf9fa13defbe1d88636e366c0ab92f9a0 127.0.0.1:6379</span><br><span class="line">   slots:0-4095 (4096 slots) master</span><br><span class="line">M: 622a17c3e9274364be68c48f749560b40f647805 127.0.0.1:6380</span><br><span class="line">   slots:4096-8191 (4096 slots) master</span><br><span class="line">M: 35b0566b4b3f7021513215b44a18615e682e91ad 127.0.0.1:6381</span><br><span class="line">   slots:8192-12287 (4096 slots) master</span><br><span class="line">M: 19e827d6fb6699d84203d2bf0f2cff105a7f7497 127.0.0.1:6382</span><br><span class="line">   slots:12288-16383 (4096 slots) master</span><br><span class="line">S: e8690128ebc818aa1aadcd5973180d17b83f314d 127.0.0.1:6479</span><br><span class="line">   replicates 35b0566b4b3f7021513215b44a18615e682e91ad</span><br><span class="line">S: ea3eab3ef0af136c536a9521fe0a1f1dafb780f7 127.0.0.1:6480</span><br><span class="line">   replicates 622a17c3e9274364be68c48f749560b40f647805</span><br><span class="line">S: 38d361f91febab028f62f7580bf9898b387a2a65 127.0.0.1:6481</span><br><span class="line">   replicates 87d16eeaf9fa13defbe1d88636e366c0ab92f9a0</span><br><span class="line">S: f91c6c6a37857a85162b655fae1bf87de7b4b83c 127.0.0.1:6482</span><br><span class="line">   replicates 19e827d6fb6699d84203d2bf0f2cff105a7f7497</span><br><span class="line">Can I set the above configuration? (type &#x27;yes&#x27; to accept): yes  # 这里输入yes</span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; Nodes configuration updated</span></span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; Assign a different config epoch to each node</span></span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; Sending CLUSTER MEET messages to <span class="built_in">join</span> the cluster</span></span><br><span class="line">Waiting for the cluster to join.....</span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; Performing Cluster Check (using node 127.0.0.1:6379)</span></span><br><span class="line">M: 87d16eeaf9fa13defbe1d88636e366c0ab92f9a0 127.0.0.1:6379</span><br><span class="line">   slots:0-4095 (4096 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">M: 35b0566b4b3f7021513215b44a18615e682e91ad 127.0.0.1:6381</span><br><span class="line">   slots:8192-12287 (4096 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">S: 38d361f91febab028f62f7580bf9898b387a2a65 127.0.0.1:6481</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates 87d16eeaf9fa13defbe1d88636e366c0ab92f9a0</span><br><span class="line">S: e8690128ebc818aa1aadcd5973180d17b83f314d 127.0.0.1:6479</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates 35b0566b4b3f7021513215b44a18615e682e91ad</span><br><span class="line">S: ea3eab3ef0af136c536a9521fe0a1f1dafb780f7 127.0.0.1:6480</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates 622a17c3e9274364be68c48f749560b40f647805</span><br><span class="line">M: 622a17c3e9274364be68c48f749560b40f647805 127.0.0.1:6380</span><br><span class="line">   slots:4096-8191 (4096 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">S: f91c6c6a37857a85162b655fae1bf87de7b4b83c 127.0.0.1:6482</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates 19e827d6fb6699d84203d2bf0f2cff105a7f7497</span><br><span class="line">M: 19e827d6fb6699d84203d2bf0f2cff105a7f7497 127.0.0.1:6382</span><br><span class="line">   slots:12288-16383 (4096 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">[OK] All nodes agree about slots configuration.</span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; Check <span class="keyword">for</span> open slots...</span></span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; Check slots coverage...</span></span><br><span class="line">[OK] All 16384 slots covered.</span><br><span class="line">[root@localhost src]#</span><br></pre></td></tr></table></figure></div>



<h2 id="11-3-Redis-Cluster工作原理"><a href="#11-3-Redis-Cluster工作原理" class="headerlink" title="11.3 Redis Cluster工作原理"></a>11.3 Redis Cluster工作原理</h2><h3 id="11-3-1-Redis-Cluster内部存储原理"><a href="#11-3-1-Redis-Cluster内部存储原理" class="headerlink" title="11.3.1 Redis Cluster内部存储原理"></a>11.3.1 Redis Cluster内部存储原理</h3><p>在集群环境中，每个master的数据应该是共享的，但是用户发送一个set命令来到redis服务不可能多台master同时执行set来保证数据的同步，这样效率未免太过低下。多台master之间也不可能做”主从复制”操作，那么redis是如何实现这一点的呢？</p>
<p>在集群环境中，redis的存储结构由16384个虚拟槽（slot）组成，这16384个槽被若干个master均分，当有新的key需要存储到redis服务器中，redis底层会调用CRC方法将key计算成一个值，然后%16384的到一个具体的槽位，根据此槽位选择要存储的redis服务器。</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/redis3/53.png"
                     
                ></p>
<p><strong>注意：槽只是入口，代表新的key要存储的位置，一个槽可以存放N多个Key</strong></p>
<p>当有新的master加入时，redis内部会重新分配槽。</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/redis3/54.png"
                     
                ></p>
<p>在redis cluster中，每个master都会保存一份”注册表”，此注册表包含了所有的master节点的槽信息，当用户发送set&#x2F;get命令来到对应的slave或master，slave&#x2F;master发现自己这里没有用户需要的数据，则会查看注册表查到对应的key在哪个槽位，并且重定向到此槽位来获取&#x2F;存储数据。</p>
<ul>
<li>连接客户端：<strong>cluster环境中，连接客户端加上参数（<code>-c</code>）</strong></li>
</ul>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost src] redis-cli 				# 普通连接</span><br><span class="line">127.0.0.1:6379&gt; set name zs</span><br><span class="line">(error) MOVED 5798 127.0.0.1:6380			# 报错:提示name key计算出来的槽在6380服务器上</span><br><span class="line">127.0.0.1:6379&gt; </span><br><span class="line">[root@localhost src] redis-cli -c 			# 代表是cluster环境连接服务器</span><br><span class="line">127.0.0.1:6379&gt; set name zs</span><br><span class="line"><span class="meta prompt_">-&gt; </span><span class="language-bash">Redirected to slot [5798] located at 127.0.0.1:6380	<span class="comment"># 重定向到6380进行存储</span></span></span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6380&gt;</span><br></pre></td></tr></table></figure></div>

<p>获取数据：</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost src]redis-cli -c -p 6381		# 连接6381服务器</span><br><span class="line">127.0.0.1:6381&gt; get name</span><br><span class="line"><span class="meta prompt_">-&gt; </span><span class="language-bash">Redirected to slot [5798] located at 127.0.0.1:6380</span></span><br><span class="line">&quot;zs&quot;</span><br><span class="line">127.0.0.1:6380&gt;</span><br></pre></td></tr></table></figure></div>



<h3 id="11-3-2-Cluster切换原理"><a href="#11-3-2-Cluster切换原理" class="headerlink" title="11.3.2 Cluster切换原理"></a>11.3.2 Cluster切换原理</h3><h4 id="11-3-2-1-slave切换"><a href="#11-3-2-1-slave切换" class="headerlink" title="11.3.2.1 slave切换"></a>11.3.2.1 slave切换</h4><p>在Redis Cluster环境中，如果中途有slave节点宕机，那么流程如下：</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/redis3/49.png"
                     
                ></p>
<p>在redis集群环境下，每个master节点会每隔<code>cluster-node-timeout</code>时间检测所有的slave节点，当某台master节点检测到slave宕机后，会通知其他节点，其他节点接收到master发送过来的信息则将此slave节点（6481）标注为如下信息：</p>
<p><strong>表示接收到来自6382的6481节点宕机信息</strong></p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">FAIL message received from master-node-id(6382) about slave-node-id(6481)</span><br></pre></td></tr></table></figure></div>

<ul>
<li>master-node-id：通知信息的master节点的node-id</li>
<li>slave-node-id：宕机的slave节点的node-id</li>
</ul>
<p>其他节点收到slave节点宕机的信息后，有的节点（包括master与slave）会”相信”该master节点的判断。有的则会去宕机的slave节点再次检测一下，此时该节点与发现slave宕机的那台master节点标注信息为：</p>
<p><strong>表示标记6481节点宕机</strong></p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Marking node slave-node-id(6481) as failing (quorum reached).</span><br></pre></td></tr></table></figure></div>

<ul>
<li>slave-node-id：表示宕机的那台slave节点的node-id</li>
</ul>
<p>当slave节点恢复正常后，其他所有节点都标注为：</p>
<p><strong>代表清除此slave节点的宕机信息，slave可以重新访问了</strong></p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Clear FAIL state for node slave-node-id: slave is reachable again.</span><br></pre></td></tr></table></figure></div>

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/redis3/50.png"
                     
                ></p>
<h4 id="11-3-2-2-master切换"><a href="#11-3-2-2-master切换" class="headerlink" title="11.3.2.2 master切换"></a>11.3.2.2 master切换</h4><p>在Redis Cluster环境中，如果中途有master节点宕机，流程如下：</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/redis3/51.png"
                     
                ></p>
<p>在Redis Cluster环境中，每个master节点会每隔<code>cluster-node-timeout</code>时间检测一下所有的slave节点，另外每个master与master直接每隔<code>cluster-node-timeout</code>时间ping一下，用于检测对方是否存活，当6379宕机后，首先6379的slave节点每秒会尝试连接一次master，直到其他master节点（假设6382）检测到6379宕机后告知自己，那么自己则会充当master节点，<strong>后续如果6379节点恢复正常则充当6479的slave节点</strong>。6382检测到6379宕机后，除了会通知6479，还会通知其他的slave节点，与其他master节点，这些节点接收到来自6382的通知后，有的表示”相信”6382的消息，则标注6379为如下：</p>
<p><strong>表示已经接收到来自6382关于6379宕机的消息</strong></p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">FAIL message received from master-node-id about(6382) master-node-id(6379)</span><br></pre></td></tr></table></figure></div>

<p><strong>有的节点则会自己去访问一下，代表二次确认master节点是否真的宕机，标注信息如下：</strong></p>
<div class="highlight-container" data-rel="Txt"><figure class="iseeu highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Marking node slave-node-id(6379) as failing (quorum reached).</span><br></pre></td></tr></table></figure></div>

<p>当6439完成slave–&gt;master的切换之后告其他所有节点，表示自己已经切换成功，其他节点标注信息如下：</p>
<p><strong>表示故障迁移到6479上，并且已经迁移完毕</strong></p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Failover auth granted to slave-node-id(6479) for epoch 9</span><br><span class="line">Cluster state changed: ok</span><br></pre></td></tr></table></figure></div>

<p>当6379恢复正常后，充当原slave（6479）的从节点，其他节点标注6379如下：</p>
<p><strong>表示已经清除6379宕机的信息，6379可以重新访问，但已经没有了槽信息（也就是不再是master了）</strong></p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Clear FAIL state for node slave-node-id(6379): master without slots is reachable again.</span><br></pre></td></tr></table></figure></div>

        </div>

        
            <div class="post-copyright-info w-full my-8 px-2 sm:px-6 md:px-8">
                <div class="article-copyright-info-container">
    <ul>
        <li><strong>Title:</strong> Redis</li>
        <li><strong>Author:</strong> MinGe</li>
        <li><strong>Created at
                :</strong> 2023-02-05 16:44:00</li>
        
            <li>
                <strong>Updated at
                    :</strong> 2024-11-26 11:12:14
            </li>
        
        <li>
            <strong>Link:</strong> https://redefine.ohevan.com/2023/02/05/Redis/
        </li>
        <li>
            <strong>
                License:
            </strong>
            

            
                This work is licensed under <a class="license" target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0">CC BY-NC-SA 4.0</a>.
            
        </li>
    </ul>
</div>

            </div>
        

        
            <ul class="post-tags-box text-lg mt-1.5 flex-wrap justify-center flex md:hidden">
                
                    <li class="tag-item mx-0.5">
                        <a href="/tags/java/">#java</a>&nbsp;
                    </li>
                
            </ul>
        

        

        
            <div class="article-nav my-8 flex justify-between items-center px-2 sm:px-6 md:px-8">
                
                    <div class="article-prev border-border-color shadow-redefine-flat shadow-shadow-color-2 rounded-medium px-4 py-2 hover:shadow-redefine-flat-hover hover:shadow-shadow-color-2">
                        <a class="prev"
                        rel="prev"
                        href="/2023/04/04/RabbitMQ/"
                        >
                            <span class="left arrow-icon flex justify-center items-center">
                                <i class="fa-solid fa-chevron-left"></i>
                            </span>
                            <span class="title flex justify-center items-center">
                                <span class="post-nav-title-item">RabbitMQ</span>
                                <span class="post-nav-item">Prev posts</span>
                            </span>
                        </a>
                    </div>
                
                
                    <div class="article-next border-border-color shadow-redefine-flat shadow-shadow-color-2 rounded-medium px-4 py-2 hover:shadow-redefine-flat-hover hover:shadow-shadow-color-2">
                        <a class="next"
                        rel="next"
                        href="/2023/01/01/Mybatis/"
                        >
                            <span class="title flex justify-center items-center">
                                <span class="post-nav-title-item">Mybatis</span>
                                <span class="post-nav-item">Next posts</span>
                            </span>
                            <span class="right arrow-icon flex justify-center items-center">
                                <i class="fa-solid fa-chevron-right"></i>
                            </span>
                        </a>
                    </div>
                
            </div>
        


        
    </div>

    
        <div class="toc-content-container">
            <div class="post-toc-wrap">
    <div class="post-toc">
        <div class="toc-title">On this page</div>
        <div class="page-title">Redis</div>
        <ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B8%80%E3%80%81%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B"><span class="nav-text">一、数据类型</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BA%8C%E3%80%81Redis%E6%8C%81%E4%B9%85%E5%8C%96"><span class="nav-text">二、Redis持久化</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%9B%9B%E3%80%81Redis%E4%BA%8B%E5%8A%A1"><span class="nav-text">四、Redis事务</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BA%94%E3%80%81Redis%E7%9A%84%E5%88%A0%E9%99%A4%E7%AD%96%E7%95%A5"><span class="nav-text">五、Redis的删除策略</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%85%AD%E3%80%81%E5%86%85%E5%AD%98%E6%B7%98%E6%B1%B0%E6%9C%BA%E5%88%B6"><span class="nav-text">六、内存淘汰机制</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B8%83%E3%80%81Redis%E9%AB%98%E7%BA%A7%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B"><span class="nav-text">七、Redis高级数据类型</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%85%AB%E3%80%81Redis%E7%9A%84%E9%85%8D%E7%BD%AE"><span class="nav-text">八、Redis的配置</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B9%9D%E3%80%81Redis%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6"><span class="nav-text">九、Redis主从复制</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%8D%81%E3%80%81Redis-%E5%93%A8%E5%85%B5%E6%9C%BA%E5%88%B6"><span class="nav-text">十、Redis 哨兵机制</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%8D%81%E4%B8%80%E3%80%81Redis-Cluster%E9%9B%86%E7%BE%A4"><span class="nav-text">十一、Redis Cluster集群</span></a></li></ol>

    </div>
</div>
        </div>
    
</div>



                

            </div>

            

        </div>

        <div class="main-content-footer">
            <footer class="footer mt-5 py-5 h-auto text-base text-third-text-color relative border-t-2 border-t-border-color">
    <div class="info-container py-3 text-center">
        
        <div class="text-center">
            &copy;
            
              <span>2022</span>
              -
            
            2024&nbsp;&nbsp;<i class="fa-solid fa-heart fa-beat" style="--fa-animation-duration: 0.5s; color: #f54545"></i>&nbsp;&nbsp;<a href="/">MinGe</a>
            
                
                <p class="post-count space-x-0.5">
                    <span>
                        20 posts in total
                    </span>
                    
                </p>
            
        </div>
        
        <div class="relative text-center lg:absolute lg:left-[20px] lg:top-1/2 lg:-translate-y-1/2 lg:text-left">
            <span class="lg:block text-sm">POWERED BY <?xml version="1.0" encoding="utf-8"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"><svg class="relative top-[2px] inline-block align-baseline" version="1.1" id="圖層_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="1rem" height="1rem" viewBox="0 0 512 512" enable-background="new 0 0 512 512" xml:space="preserve"><path fill="#0E83CD" d="M256.4,25.8l-200,115.5L56,371.5l199.6,114.7l200-115.5l0.4-230.2L256.4,25.8z M349,354.6l-18.4,10.7l-18.6-11V275H200v79.6l-18.4,10.7l-18.6-11v-197l18.5-10.6l18.5,10.8V237h112v-79.6l18.5-10.6l18.5,10.8V354.6z"/></svg><a target="_blank" class="text-base" href="https://hexo.io">Hexo</a></span>
            <span class="text-sm lg:block">THEME&nbsp;<a class="text-base" target="_blank" href="https://github.com/EvanNotFound/hexo-theme-redefine">Redefine v2.7.1</a></span>
        </div>
        
        
            <div>
                Blog up for <span class="odometer" id="runtime_days" ></span> days <span class="odometer" id="runtime_hours"></span> hrs <span class="odometer" id="runtime_minutes"></span> Min <span class="odometer" id="runtime_seconds"></span> Sec
            </div>
        
        
            <script data-swup-reload-script>
                try {
                    function odometer_init() {
                    const elements = document.querySelectorAll('.odometer');
                    elements.forEach(el => {
                        new Odometer({
                            el,
                            format: '( ddd).dd',
                            duration: 200
                        });
                    });
                    }
                    odometer_init();
                } catch (error) {}
            </script>
        
        
        
    </div>  
</footer>
        </div>
    </div>

    
        <div class="post-tools">
            <div class="post-tools-container">
    <ul class="article-tools-list">
        <!-- TOC aside toggle -->
        
            <li class="right-bottom-tools page-aside-toggle">
                <i class="fa-regular fa-outdent"></i>
            </li>
        

        <!-- go comment -->
        
    </ul>
</div>

        </div>
    

    <div class="right-side-tools-container">
        <div class="side-tools-container">
    <ul class="hidden-tools-list">
        <li class="right-bottom-tools tool-font-adjust-plus flex justify-center items-center">
            <i class="fa-regular fa-magnifying-glass-plus"></i>
        </li>

        <li class="right-bottom-tools tool-font-adjust-minus flex justify-center items-center">
            <i class="fa-regular fa-magnifying-glass-minus"></i>
        </li>

        <li class="right-bottom-tools tool-dark-light-toggle flex justify-center items-center">
            <i class="fa-regular fa-moon"></i>
        </li>

        <!-- rss -->
        

        

        <li class="right-bottom-tools tool-scroll-to-bottom flex justify-center items-center">
            <i class="fa-regular fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="visible-tools-list">
        <li class="right-bottom-tools toggle-tools-list flex justify-center items-center">
            <i class="fa-regular fa-cog fa-spin"></i>
        </li>
        
            <li class="right-bottom-tools tool-scroll-to-top flex justify-center items-center">
                <i class="arrow-up fas fa-arrow-up"></i>
                <span class="percent"></span>
            </li>
        
        
    </ul>
</div>

    </div>

    <div class="image-viewer-container">
    <img src="">
</div>


    

</main>


    
<script src="/js/libs/Swup.min.js"></script>

<script src="/js/libs/SwupSlideTheme.min.js"></script>

<script src="/js/libs/SwupScriptsPlugin.min.js"></script>

<script src="/js/libs/SwupProgressPlugin.min.js"></script>

<script src="/js/libs/SwupScrollPlugin.min.js"></script>

<script src="/js/libs/SwupPreloadPlugin.min.js"></script>

<script>
    const swup = new Swup({
        plugins: [
            new SwupScriptsPlugin({
                optin: true,
            }),
            new SwupProgressPlugin(),
            new SwupScrollPlugin({
                offset: 80,
            }),
            new SwupSlideTheme({
                mainElement: ".main-content-body",
            }),
            new SwupPreloadPlugin(),
        ],
        containers: ["#swup"],
    });
</script>







<script src="/js/tools/imageViewer.js" type="module"></script>

<script src="/js/utils.js" type="module"></script>

<script src="/js/main.js" type="module"></script>

<script src="/js/layouts/navbarShrink.js" type="module"></script>

<script src="/js/tools/scrollTopBottom.js" type="module"></script>

<script src="/js/tools/lightDarkSwitch.js" type="module"></script>

<script src="/js/layouts/categoryList.js" type="module"></script>





    
<script src="/js/tools/codeBlock.js" type="module"></script>




    
<script src="/js/layouts/lazyload.js" type="module"></script>




    
<script src="/js/tools/runtime.js"></script>

    
<script src="/js/libs/odometer.min.js"></script>

    
<link rel="stylesheet" href="/assets/odometer-theme-minimal.css">




  
<script src="/js/libs/Typed.min.js"></script>

  
<script src="/js/plugins/typed.js" type="module"></script>








    
<script src="/js/libs/anime.min.js"></script>



<div class="post-scripts" data-swup-reload-script>
    
        
<script src="/js/tools/tocToggle.js" type="module"></script>

<script src="/js/layouts/toc.js" type="module"></script>

<script src="/js/plugins/tabs.js" type="module"></script>

    
</div>


</body>
</html>
